define ("mod_minilesson/freewriting",["jquery","core/log","core/str","core/notification","mod_minilesson/definitions","mod_minilesson/correctionsmarkup","core/templates"],function(a,b,c,d,e,f,g){"use strict";b.debug("MiniLesson FreeWriting: initialising");return{transcript_evaluation:null,rawscore:0,percentscore:0,strings:{},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){this.itemdata=c;b.debug("itemdata",c);this.quizhelper=d;this.init_strings();this.init_components(d,c);this.register_events(a,c,d)},init_strings:function init_strings(){var a=this;c.get_strings([{key:"notsubmitted",component:"mod_minilesson"},{key:"notsubmit",component:"mod_minilesson"},{key:"submitnow",component:"mod_minilesson"},{key:"cancel",component:"core"}]).done(function(b){var c=0;a.strings.notsubmitted=b[c++];a.strings.notsubmit=b[c++];a.strings.submitnow=b[c++];a.strings.cancel=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.itemdata.totalmarks;b.correctitems=0<a.rawscore?a.rawscore:0;b.grade=a.percentscore;b.resultsdata=a.transcript_evaluation;a.quizhelper.do_next(b)},calculate_score:function calculate_score(a){var b=this;if(null===a){return 0}var c=1;if(b.itemdata.countwords){c=a.stats.words/b.itemdata.targetwordcount;if(1<c){c=1}}var d=1;if(0<b.itemdata.relevance){d=(a.stats.relevance+10)/100;if(1<d){d=1}}var e=Math.round(a.marks*d*c);return e},register_events:function register_events(b,c,e){var f=this;f.index=b;f.quizhelper=e;f.nextbutton.on("click",function(a){a.preventDefault();var b=f.quizhelper.count_words(f.thetextarea.val()),c=null!==f.transcript_evaluation;if(c||0===b){f.next_question()}else{d.confirm(f.strings.notsubmit,f.strings.notsubmitted,f.strings.submitnow,"",function(){f.submitbutton.click()})}});f.thetextarea.on("input",function(a){a.preventDefault();var b=f.quizhelper.count_words(f.thetextarea.val());f.wordcount.text(b)});if(0<f.itemdata.nopasting){f.thetextarea.bind("cut copy paste",function(a){a.preventDefault()});f.thetextarea.bind("contextmenu",function(a){a.preventDefault()})}f.submitbutton.on("click",function(a){a.preventDefault();var b=f.thetextarea.val(),c=f.quizhelper.count_words(b);f.wordcount.text(c);f.do_evaluation(b)});a("#"+c.uniqueid+"_container").on("showElement",function(){if(0<c.timelimit){a("#"+c.uniqueid+"_container .progress-container").show();a("#"+c.uniqueid+"_container .progress-container i").show();a("#"+c.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:c.timelimit,onFinish:function onFinish(){f.nextbutton.trigger("click")}})}})},init_components:function init_components(b,c){var d=this;d.allwords=a("#"+d.itemdata.uniqueid+"_container.mod_minilesson_mu_passage_word");d.submitbutton=a("#"+c.uniqueid+"_container .ml_freewriting_submitbutton");d.nextbutton=a("#"+c.uniqueid+"_container .minilesson_nextbutton");d.thetextarea=a("#"+d.itemdata.uniqueid+"_container .ml_freewriting_textarea");d.wordcount=a("#"+d.itemdata.uniqueid+"_container span.ml_wordcount");d.actionbox=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_actionbox");d.pendingbox=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_pendingbox");d.resultsbox=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_resultsbox");d.timerdisplay=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_timerdisplay")},do_corrections_markup:function do_corrections_markup(a,b,c){var d=this,e=d.resultsbox.find(".mlfsr_correctedtext");f.init({correctionscontainer:e,grammarerrors:a,grammarmatches:b,insertioncount:c})},do_evaluation:function do_evaluation(a){var c=this;c.resultsbox.hide();c.actionbox.hide();c.pendingbox.show();this.quizhelper.evaluateTranscript(a,this.itemdata.itemid).then(function(d){var e=JSON.parse(d);if(e){e.rawscore=c.calculate_score(e);c.rawscore=c.calculate_score(e);if(0<c.itemdata.totalmarks){c.percentscore=Math.round(100*(c.rawscore/c.itemdata.totalmarks))}e.rawscore=c.rawscore;e.percentscore=c.percentscore;e.rawspeech=a;e.maxscore=c.itemdata.totalmarks;c.transcript_evaluation=e;b.debug(e);if(!c.quizhelper.showitemreview){c.next_question()}else{g.render("mod_minilesson/freewritingresults",e).then(function(a,b){c.resultsbox.html(a);if(e.hasOwnProperty("grammarerrors")){c.do_corrections_markup(e.grammarerrors,e.grammarmatches,e.insertioncount)}c.resultsbox.show();c.pendingbox.hide();c.actionbox.hide();g.runTemplateJS(b);c.wordcount.text("0");c.ttrec.timer.reset();var d=c.ttrec.timer.fetch_display_time();c.timerdisplay.html(d)})}}else{b.debug("transcript_evaluation: oh no it failed");c.resultsbox.hide();c.pendingbox.hide();c.actionbox.show()}})}}});
//# sourceMappingURL=freewriting.min.js.map
