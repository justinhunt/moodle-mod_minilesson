define ("mod_minilesson/freewriting",["jquery","core/log","core/str","core/notification","mod_minilesson/definitions","mod_minilesson/correctionsmarkup","core/templates","mod_minilesson/external/simplekeyboard","mod_minilesson/external/keyboardlayouts"],function(a,b,c,d,e,f,g,h,i){"use strict";b.debug("MiniLesson FreeWriting: initialising");return{transcript_evaluation:null,rawscore:0,percentscore:0,strings:{},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){this.itemdata=c;b.debug("itemdata",c);this.quizhelper=d;this.init_strings();this.init_components(d,c);this.register_events(a,c,d)},init_strings:function init_strings(){var a=this;c.get_strings([{key:"notsubmitted",component:"mod_minilesson"},{key:"notsubmit",component:"mod_minilesson"},{key:"submitnow",component:"mod_minilesson"},{key:"cancel",component:"core"}]).done(function(b){var c=0;a.strings.notsubmitted=b[c++];a.strings.notsubmit=b[c++];a.strings.submitnow=b[c++];a.strings.cancel=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.itemdata.totalmarks;b.lessonitemid=a.itemdata.id;b.correctitems=0<a.rawscore?a.rawscore:0;b.grade=a.percentscore;b.resultsdata=a.transcript_evaluation;a.quizhelper.do_next(b)},calculate_score:function calculate_score(a){var b=this;if(null===a){return 0}var c=1;if(b.itemdata.countwords){c=a.stats.words/b.itemdata.targetwordcount;if(1<c){c=1}}var d=1;if(0<b.itemdata.relevance){d=(a.stats.relevance+10)/100;if(1<d){d=1}}var e=Math.round(a.marks*d*c);return e},register_events:function register_events(b,c,e){var f=this;f.index=b;f.quizhelper=e;f.nextbutton.on("click",function(a){a.preventDefault();var b=f.quizhelper.count_words(f.thetextarea.val()),c=null!==f.transcript_evaluation;if(c||0===b){f.next_question()}else{d.confirm(f.strings.notsubmit,f.strings.notsubmitted,f.strings.submitnow,"",function(){f.submitbutton.click()})}});if(f.itemdata.enablevkeyboard&&"0"!=f.itemdata.enablevkeyboard){var g=h.default||h,j={onChange:function onChange(a){return f.onChange(a)},onKeyPress:function onKeyPress(a){return f.onKeyPress(a)}};if("2"==f.itemdata.enablevkeyboard){var k=f.itemdata.customkeys||"",l=k.split(" ").filter(function(a){return""!==a.trim()});if(0===l.length&&0<k.trim().length){l=k.trim().split("")}var m=l.map(function(a){return a.toUpperCase()}),n=l.join(" ")+" {shift}",o=m.join(" ")+" {shift}";j.layout={default:[n],shift:[o]};j.display={"{shift}":"\u21E7"};j.useStandardCaps=!1;j.mergeDisplay=!0}else{var p=i.default||i,q=new p,r=f.get_keyboard_layout(f.itemdata.language),s=q.get(r);a.extend(j,s)}f.keyboard=new g(".simple-keyboard-"+f.itemdata.uniqueid,j);f.keyboardtoggle.on("click",function(){var a=f.container.find(".simple-keyboard-"+f.itemdata.uniqueid);if(a.is(":visible")){a.hide()}else{a.show()}});f.thetextarea.on("input",function(a){f.keyboard.setInput(a.target.value)})}f.thetextarea.on("input",function(a){a.preventDefault();var b=f.quizhelper.count_words(f.thetextarea.val());f.wordcount.text(b)});if(0<f.itemdata.nopasting){f.thetextarea.bind("cut copy paste",function(a){a.preventDefault()});f.thetextarea.bind("contextmenu",function(a){a.preventDefault()})}f.submitbutton.on("click",function(a){a.preventDefault();var b=f.thetextarea.val(),c=f.quizhelper.count_words(b);f.wordcount.text(c);f.do_evaluation(b)});a("#"+c.uniqueid+"_container").on("showElement",function(){if(0<c.timelimit){a("#"+c.uniqueid+"_container .progress-container").show();a("#"+c.uniqueid+"_container .progress-container i").show();a("#"+c.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:c.timelimit,onFinish:function onFinish(){f.ontimelimitreached()}})}})},ontimelimitreached:function ontimelimitreached(){var a=this,b=null!==a.transcript_evaluation,c=a.quizhelper.count_words(a.thetextarea.val());if(0==c){a.next_question()}else if(!b){a.submitbutton.click()}},init_components:function init_components(b,c){var d=this;d.container=a("#"+d.itemdata.uniqueid+"_container");d.allwords=a("#"+d.itemdata.uniqueid+"_container.mod_minilesson_mu_passage_word");d.submitbutton=a("#"+c.uniqueid+"_container .ml_freewriting_submitbutton");d.nextbutton=a("#"+c.uniqueid+"_container .minilesson_nextbutton");d.thetextarea=a("#"+d.itemdata.uniqueid+"_container .ml_freewriting_textarea");d.wordcount=a("#"+d.itemdata.uniqueid+"_container span.ml_wordcount");d.actionbox=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_actionbox");d.keyboardtoggle=a("#"+d.itemdata.uniqueid+"_container .ml_simple_keyboard_toggle");d.pendingbox=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_pendingbox");d.resultsbox=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_resultsbox");d.timerdisplay=a("#"+d.itemdata.uniqueid+"_container div.ml_freewriting_timerdisplay")},do_corrections_markup:function do_corrections_markup(a,b,c){var d=this,e=d.resultsbox.find(".mlfsr_correctedtext");f.init({correctionscontainer:e,grammarerrors:a,grammarmatches:b,insertioncount:c})},do_evaluation:function do_evaluation(c){var d=this;d.resultsbox.hide();d.actionbox.hide();d.pendingbox.show();this.quizhelper.evaluateTranscript(c,this.itemdata.itemid).then(function(e){var f=JSON.parse(e);if(f){f.reviewsettings=d.itemdata.reviewsettings;f.rawscore=d.calculate_score(f);d.rawscore=d.calculate_score(f);d.percentscore=0;if(0<d.itemdata.totalmarks){d.percentscore=Math.round(100*(d.rawscore/d.itemdata.totalmarks))}if(isNaN(d.percentscore)){d.percentscore=0}f.rawscore=d.rawscore;f.percentscore=d.percentscore;f.rawspeech=c;f.maxscore=d.itemdata.totalmarks;d.transcript_evaluation=f;var h=0,i,j=Object.assign({},f);if(f.reviewsettings.showscorestarrating){if(0==d.percentscore){h=0}else if(19>d.percentscore){h=1}else if(39>d.percentscore){h=2}else if(59>d.percentscore){h=3}else if(79>d.percentscore){h=4}else{h=5}i=5-h;j.yellowstars=Array(h).fill(M.cfg,0,h);j.graystars=Array(i).fill(M.cfg,0,i)}b.debug(j);if(!d.quizhelper.showitemreview){d.next_question()}else{g.render("mod_minilesson/freewritingresults",Object.assign({},j)).then(function(a,b){d.resultsbox.html(a);if(f.hasOwnProperty("grammarerrors")){d.do_corrections_markup(f.grammarerrors,f.grammarmatches,f.insertioncount)}d.resultsbox.show();d.pendingbox.hide();d.actionbox.hide();g.runTemplateJS(b);d.wordcount.text("0")});if(0<d.itemdata.timelimit){var k=a("#"+d.itemdata.uniqueid+"_container .progress-container #progresstimer"),l=k.attr("timer");if(l){clearInterval(l)}}}}else{b.debug("transcript_evaluation: oh no it failed");d.resultsbox.hide();d.pendingbox.hide();d.actionbox.show()}})},onChange:function onChange(a){this.thetextarea.val(a);this.thetextarea.trigger("input")},onKeyPress:function onKeyPress(a){var b=this;if("{shift}"===a||"{lock}"===a){var c=b.keyboard.options.layoutName,d="default"===c?"shift":"default";b.keyboard.setOptions({layoutName:d});var e=b.container.find(".simple-keyboard-"+b.itemdata.uniqueid);if("shift"===d){e.addClass("vkeyboard-shifted")}else{e.removeClass("vkeyboard-shifted")}}},get_keyboard_layout:function get_keyboard_layout(a){var b=a.substring(0,2).toLowerCase();switch(b){case"en":return"english";case"de":return"german";case"es":return"spanish";case"fr":return"french";case"it":return"italian";case"ja":return"japanese";case"ko":return"korean";case"pt":return"portuguese";case"ru":return"russian";case"tr":return"turkish";case"uk":return"ukrainian";case"zh":return"chinese";case"ar":return"arabic";case"el":return"greek";case"he":return"hebrew";case"hi":return"hindi";case"th":return"thai";case"ur":return"urdu";default:return"english";}}}});
//# sourceMappingURL=freewriting.min.js.map
