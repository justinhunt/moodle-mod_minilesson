define("mod_minilesson/freewriting",["jquery","core/log","core/str","core/notification","mod_minilesson/definitions","mod_minilesson/correctionsmarkup","core/templates","mod_minilesson/external/simplekeyboard","mod_minilesson/external/keyboardlayouts"],(function($,log,str,notification,def,correctionsmarkup,templates,SimpleKeyboard,KeyboardLayouts){return log.debug("MiniLesson FreeWriting: initialising"),{transcript_evaluation:null,rawscore:0,percentscore:0,strings:{},clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.itemdata=itemdata,log.debug("itemdata",itemdata),this.quizhelper=quizhelper,this.init_strings(),this.init_components(quizhelper,itemdata),this.register_events(index,itemdata,quizhelper)},init_strings:function(){var self=this;str.get_strings([{key:"notsubmitted",component:"mod_minilesson"},{key:"notsubmit",component:"mod_minilesson"},{key:"submitnow",component:"mod_minilesson"},{key:"cancel",component:"core"}]).done((function(s){var i=0;self.strings.notsubmitted=s[i++],self.strings.notsubmit=s[i++],self.strings.submitnow=s[i++],self.strings.cancel=s[i++]}))},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.itemdata.totalmarks,stepdata.lessonitemid=this.itemdata.id,stepdata.correctitems=this.rawscore>0?this.rawscore:0,stepdata.grade=this.percentscore,stepdata.resultsdata=this.transcript_evaluation,this.quizhelper.do_next(stepdata)},calculate_score:function(transcript_evaluation){if(null===transcript_evaluation)return 0;var wordsratio=1;this.itemdata.countwords&&(wordsratio=transcript_evaluation.stats.words/this.itemdata.targetwordcount)>1&&(wordsratio=1);var relevanceratio=1;return this.itemdata.relevance>0&&(relevanceratio=(transcript_evaluation.stats.relevance+10)/100)>1&&(relevanceratio=1),Math.round(transcript_evaluation.marks*relevanceratio*wordsratio)},register_events:function(index,itemdata,quizhelper){var self=this;if(self.index=index,self.quizhelper=quizhelper,self.nextbutton.on("click",(function(e){e.preventDefault();var wordcount=self.quizhelper.count_words(self.thetextarea.val());null!==self.transcript_evaluation||0===wordcount?self.next_question():notification.confirm(self.strings.notsubmit,self.strings.notsubmitted,self.strings.submitnow,"",(function(){self.submitbutton.click()}))})),self.itemdata.enablevkeyboard&&"0"!=self.itemdata.enablevkeyboard){var KeyboardClass=SimpleKeyboard.default||SimpleKeyboard,keyboardConfig={onChange:input=>self.onChange(input),onKeyPress:button=>self.onKeyPress(button)};if("2"==self.itemdata.enablevkeyboard){var customKeys=self.itemdata.customkeys||"";-1===customKeys.indexOf(" ")&&customKeys.length>0&&(customKeys=customKeys.split("").join(" ")),keyboardConfig.layout={default:[customKeys]},keyboardConfig.useStandardCaps=!1,keyboardConfig.mergeDisplay=!0}else{var keyboardLayouts=new(KeyboardLayouts.default||KeyboardLayouts),layoutName=self.get_keyboard_layout(self.itemdata.language),layout=keyboardLayouts.get(layoutName);$.extend(keyboardConfig,layout)}var keyboard=new KeyboardClass(keyboardConfig);self.keyboardtoggle.on("click",(function(e){var kb=$(".simple-keyboard");kb.is(":visible")?kb.hide():kb.show()})),self.thetextarea.on("input",(function(e){keyboard.setInput(e.target.value)}))}self.thetextarea.on("input",(function(e){e.preventDefault();var wordcount=self.quizhelper.count_words(self.thetextarea.val());self.wordcount.text(wordcount)})),self.itemdata.nopasting>0&&(self.thetextarea.bind("cut copy paste",(function(e){e.preventDefault()})),self.thetextarea.bind("contextmenu",(function(e){e.preventDefault()}))),self.submitbutton.on("click",(function(e){e.preventDefault();var transcript=self.thetextarea.val(),wordcount=self.quizhelper.count_words(transcript);self.wordcount.text(wordcount),self.do_evaluation(transcript)})),$("#"+itemdata.uniqueid+"_container").on("showElement",(()=>{itemdata.timelimit>0&&($("#"+itemdata.uniqueid+"_container .progress-container").show(),$("#"+itemdata.uniqueid+"_container .progress-container i").show(),$("#"+itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:itemdata.timelimit,onFinish:function(){self.ontimelimitreached()}}))}))},ontimelimitreached:function(){var submitted=null!==this.transcript_evaluation;0==this.quizhelper.count_words(this.thetextarea.val())?this.next_question():submitted||this.submitbutton.click()},init_components:function(quizhelper,itemdata){this.allwords=$("#"+this.itemdata.uniqueid+"_container.mod_minilesson_mu_passage_word"),this.submitbutton=$("#"+itemdata.uniqueid+"_container .ml_freewriting_submitbutton"),this.nextbutton=$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton"),this.thetextarea=$("#"+this.itemdata.uniqueid+"_container .ml_freewriting_textarea"),this.wordcount=$("#"+this.itemdata.uniqueid+"_container span.ml_wordcount"),this.actionbox=$("#"+this.itemdata.uniqueid+"_container div.ml_freewriting_actionbox"),this.keyboardtoggle=$("#"+this.itemdata.uniqueid+"_container .ml_freewriting_keyboard_toggle"),this.pendingbox=$("#"+this.itemdata.uniqueid+"_container div.ml_freewriting_pendingbox"),this.resultsbox=$("#"+this.itemdata.uniqueid+"_container div.ml_freewriting_resultsbox"),this.timerdisplay=$("#"+this.itemdata.uniqueid+"_container div.ml_freewriting_timerdisplay")},do_corrections_markup:function(grammarerrors,grammarmatches,insertioncount){var correctionscontainer=this.resultsbox.find(".mlfsr_correctedtext");correctionsmarkup.init({correctionscontainer:correctionscontainer,grammarerrors:grammarerrors,grammarmatches:grammarmatches,insertioncount:insertioncount})},do_evaluation:function(speechtext){var self=this;self.resultsbox.hide(),self.actionbox.hide(),self.pendingbox.show(),this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then((function(ajaxresult){var transcript_evaluation=JSON.parse(ajaxresult);if(transcript_evaluation){transcript_evaluation.reviewsettings=self.itemdata.reviewsettings,transcript_evaluation.rawscore=self.calculate_score(transcript_evaluation),self.rawscore=self.calculate_score(transcript_evaluation),self.percentscore=0,self.itemdata.totalmarks>0&&(self.percentscore=Math.round(self.rawscore/self.itemdata.totalmarks*100)),isNaN(self.percentscore)&&(self.percentscore=0),transcript_evaluation.rawscore=self.rawscore,transcript_evaluation.percentscore=self.percentscore,transcript_evaluation.rawspeech=speechtext,transcript_evaluation.maxscore=self.itemdata.totalmarks,self.transcript_evaluation=transcript_evaluation;var gstarcnt,ystarcnt=0;if(transcript_evaluation.reviewsettings.showscorestarrating&&(gstarcnt=5-(ystarcnt=0==self.percentscore?0:self.percentscore<19?1:self.percentscore<39?2:self.percentscore<59?3:self.percentscore<79?4:5),self.transcript_evaluation.yellowstars=new Array(ystarcnt).fill(M.cfg,0,ystarcnt),self.transcript_evaluation.graystars=new Array(gstarcnt).fill(M.cfg,0,gstarcnt)),log.debug(transcript_evaluation),self.quizhelper.showitemreview){if(templates.render("mod_minilesson/freewritingresults",transcript_evaluation).then((function(html,js){self.resultsbox.html(html),transcript_evaluation.hasOwnProperty("grammarerrors")&&self.do_corrections_markup(transcript_evaluation.grammarerrors,transcript_evaluation.grammarmatches,transcript_evaluation.insertioncount),self.resultsbox.show(),self.pendingbox.hide(),self.actionbox.hide(),templates.runTemplateJS(js),self.wordcount.text("0")})),self.itemdata.timelimit>0){var timerinterval=$("#"+self.itemdata.uniqueid+"_container .progress-container #progresstimer").attr("timer");timerinterval&&clearInterval(timerinterval)}}else self.next_question()}else log.debug("transcript_evaluation: oh no it failed"),self.resultsbox.hide(),self.pendingbox.hide(),self.actionbox.show()}))},onChange:function(input){this.thetextarea.val(input),this.thetextarea.trigger("input")},onKeyPress:function(button){},get_keyboard_layout:function(lang){switch(lang.substring(0,2).toLowerCase()){case"en":default:return"english";case"de":return"german";case"es":return"spanish";case"fr":return"french";case"it":return"italian";case"ja":return"japanese";case"ko":return"korean";case"pt":return"portuguese";case"ru":return"russian";case"tr":return"turkish";case"uk":return"ukrainian";case"zh":return"chinese";case"ar":return"arabic";case"el":return"greek";case"he":return"hebrew";case"hi":return"hindi";case"th":return"thai";case"ur":return"urdu"}}}}));

//# sourceMappingURL=freewriting.min.js.map