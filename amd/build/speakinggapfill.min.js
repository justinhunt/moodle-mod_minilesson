define ("mod_minilesson/speakinggapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates","core/str","core/notification"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";b.debug("MiniLesson speaking gap fill: initialising");return{ttrec:null,controls:{},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){var e=this;e.strings={};var h={};h.uniqueid=c.uniqueid;h.callback=function theCallback(a){switch(a.type){case"recording":break;case"speech":b.debug("Speech at speaking gap fill -");var c=e.items[e.game.pointer].words,d=[];Object.keys(c).forEach(function(a){d.push(c[a])});e.getComparison(d.join(" "),a.capturedspeech,e.items[e.game.pointer].phonetic,function(b){e.gotComparison(b,a)});break;case"mediasaved":e.mediaurl=a.mediaurl;b.debug("Media saved at speaking gap fill: "+e.mediaurl);break;}};h.stt_guided=d.is_stt_guided();h.wwwroot=d.is_stt_guided();e.ttrec=f.clone();e.ttrec.init(h);e.itemdata=c;b.debug("itemdata");b.debug(c);e.quizhelper=d;e.index=a;var i={useanimatecss:d.useanimatecss};g.init(i);e.init_controls();e.init_strings();e.register_events();e.setvoice();e.getItems()},init_controls:function init_controls(){var b=this;b.controls={container:a("#"+b.itemdata.uniqueid+"_container"),listen_cont:a("#"+b.itemdata.uniqueid+"_container .sgapfill_listen_cont"),nextbutton:a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:a("#"+b.itemdata.uniqueid+"_container .sgapfill_start_btn"),skip_btn:a("#"+b.itemdata.uniqueid+"_container .sgapfill_skip_btn"),ctrl_btn:a("#"+b.itemdata.uniqueid+"_container .sgapfill_ctrl-btn"),speakbtncontainer:a("#"+b.itemdata.uniqueid+"_container .sgapfill_speakbtncontainer"),game:a("#"+b.itemdata.uniqueid+"_container .sgapfill_game"),controlsbox:a("#"+b.itemdata.uniqueid+"_container .sgapfill_controls"),resultscontainer:a("#"+b.itemdata.uniqueid+"_container .sgapfill_resultscontainer"),mainmenu:a("#"+b.itemdata.uniqueid+"_container .sgapfill_mainmenu"),title:a("#"+b.itemdata.uniqueid+"_container .sgapfill_title"),progress_container:a("#"+b.itemdata.uniqueid+"_container .progress-container"),progress_bar:a("#"+b.itemdata.uniqueid+"_container .progress-container .progress-bar"),question:a("#"+b.itemdata.uniqueid+"_container .question"),listen_btn:a("#"+b.itemdata.uniqueid+"_container .sgapfill_listen_btn"),description:a("#"+b.itemdata.uniqueid+"_container .sgapfill_description"),image:a("#"+b.itemdata.uniqueid+"_container .sgapfill_image_container"),maintitle:a("#"+b.itemdata.uniqueid+"_container .sgapfill_maintitle"),itemquestion:a("#"+b.itemdata.uniqueid+"_container .sgapfill_itemtext")}},init_strings:function init_strings(){var a=this;j.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(b){var c=0;a.strings.nextlessonitem=b[c++];a.strings.confirm_desc=b[c++];a.strings.yes=b[c++];a.strings.no=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.stop_audio();a.quizhelper.do_next(b)},show_item_review:function show_item_review(){var a=this,b={};a.items.forEach(function(a){var b=[];a.parsedstring.forEach(function(a){if("input"===a.type||"mtext"===a.type){b.push(a.character)}});var c=b.join(""),d=new RegExp(c,"gi"),e=a.correct?"correctitem":"wrongitem",f=a.target.replace(d,"<span class=\"".concat(e,"\">").concat(c,"</span>"));a.target=f});b.items=a.items;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;var c=a.controls.listen_cont,d=a.controls.question,e=a.controls.speakbtncontainer,f=a.controls.game,g=a.controls.controlsbox,h=a.controls.resultscontainer;i.render("mod_minilesson/listitemresults",b).then(function(a,b){h.html(a);h.show();f.hide();g.hide();c.hide();d.hide();e.hide();i.runTemplateJS(b)})},register_events:function register_events(){var b=this;b.controls.container.find(".minilesson_nextbutton").on("click",function(){if(b.items.some(function(a){return!a.answered})){k.confirm(b.strings.nextlessonitem,b.strings.confirm_desc,b.strings.yes,b.strings.no,function(){b.next_question()})}else{b.next_question()}});b.controls.start_btn.on("click",function(){b.start()});var c=b.controls.listen_btn;if(b.itemdata.readsentence){c.on("click",function(){var d=b.items[b.game.pointer].audio;if(!d.paused){d.pause();d.currentTime=0;a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up");return}d.addEventListener("ended",function(){a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up")});d.addEventListener("play",function(){a(c).children(".fa").removeClass("fa-volume-up");a(c).children(".fa").addClass("fa-stop")});d.load();d.play()})}b.controls.skip_btn.on("click",function(){b.controls.ctrl_btn.prop("disabled",!0);b.controls.container.find(".sgapfill_speech.sgapfill_teacher_left").text(b.items[b.game.pointer].prompt+"");b.controls.container.find(".sgapfill_targetWord").each(function(){var c=a(this).data("realidx"),d=b.items[b.game.pointer].sgapfill_targetWords[c];a(this).val(d)});b.stopTimer(b.items[b.game.pointer].timer);b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;if(b.game.pointer<b.items.length-1){b.controls.skip_btn.prop("disabled",!0);b.controls.skip_btn.children(".fa").removeClass("fa-arrow-right");b.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin");setTimeout(function(){b.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin");b.controls.skip_btn.children(".fa").addClass("fa-arrow-right");b.controls.skip_btn.prop("disabled",!1);b.controls.container.find(".sgapfill_reply_"+b.game.pointer).hide();b.game.pointer++;b.nextPrompt()},2e3)}else{b.end()}})},game:{pointer:0},usevoice:"",setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{target:a.sentence,segmentedsentence:a.segmentedsentence,prompt:a.prompt,parsedstring:a.parsedstring,displayprompt:a.displayprompt,definition:a.definition,phonetic:a.phonetic,words:a.words,typed:"",timer:[],answered:!1,correct:!1,audio:null,audiourl:a.audiourl?a.audiourl:"",imageurl:a.imageurl}}).filter(function(a){return""!==a.target});if(b.itemdata.readsentence){a.each(b.items,function(a,b){b.audio=new Audio;b.audio.src=b.audiourl});b.appReady()}else{b.appReady()}},appReady:function appReady(){var a=this;a.controls.container.find(".sgapfill_not_loaded").hide();a.controls.container.find(".sgapfill_loaded").show();if(a.itemdata.hidestartpage){a.start()}else{a.controls.start_btn.prop("disabled",!1)}},gotComparison:function gotComparison(c,d){b.debug("sgapfill comparison");var e=this,f=!1,h=e.controls.container.find(".sgapfill_reply_"+e.game.pointer+" .dictate_feedback[data-idx='"+e.game.pointer+"']");e.controls.container.find(".sgapfill_targetWord").removeClass("sgapfill_correct sgapfill_incorrect");e.controls.container.find(".sgapfill_feedback").removeClass("fa fa-check fa-times");var i=0==c.filter(function(a){return!a.matched}).length;b.debug("allcorrect="+i);if(i&&c&&0<c.length){e.items[e.game.pointer].parsedstring.forEach(function(a,b){var c=e.controls.container.find(".sgapfill_reply_"+e.game.pointer+" .sgapfill_missing_input[data-index=\""+b+"\"]");if(c&&"input"===a.type){c.text(a.character)}});h.removeClass("fa fa-times");h.addClass("fa fa-check");b.debug("applying correct class to input boxes");e.controls.container.find(".sgapfill_reply_"+e.game.pointer+" .sgapfill_missing_input").addClass("ml_gapfill_char_correct");e.items[e.game.pointer].answered=!0;e.items[e.game.pointer].correct=!0;e.items[e.game.pointer].typed=d;e.controls.ctrl_btn.prop("disabled",!0);e.stopTimer(e.items[e.game.pointer].timer);if(e.game.pointer<e.items.length-1&&!f){f=!0;b.debug("moving to next prompt B");setTimeout(function(){e.controls.container.find(".sgapfill_reply_"+e.game.pointer).hide();e.game.pointer++;e.nextPrompt()},2e3)}else{e.updateProgressDots();e.end()}}else{h.removeClass("fa fa-check");h.addClass("fa fa-times");c.forEach(function(a){var b=e.items[e.game.pointer].words;Object.keys(b).forEach(function(c){if(b[c]==a.word){if(!a.matched){e.items[e.game.pointer].parsedstring.forEach(function(a,b){var d=e.controls.container.find(".sgapfill_reply_"+e.game.pointer+" input.single-character[data-index=\""+b+"\"]");if(a.index==c&&"input"===a.type){d.val("")}})}else{e.items[e.game.pointer].parsedstring.forEach(function(a,b){var d=e.controls.container.find(".sgapfill_reply_"+e.game.pointer+" input.single-character[data-index=\""+b+"\"]");if(a.index==c&&"input"===a.type){d.val(a.character);d.addClass("ml_gapfill_char_correct")}})}}})});var j=e.controls.container.find(".sgapfill_reply_"+e.game.pointer);g.do_animate(j,"shakeX animate__faster").then(function(){e.controls.ctrl_btn.prop("disabled",!1)});e.controls.container.find(".sgapfill_targetWord.sgapfill_correct").each(function(){var b=a(this).data("realidx"),c=e.items[e.game.pointer].sgapfill_targetWords[b];a(this).val(c)});var k=e.controls.progress_bar;if(!e.itemdata.allowretry||k.hasClass("progress-bar-complete")){e.items[e.game.pointer].answered=!0;e.items[e.game.pointer].correct=!1;e.items[e.game.pointer].typed=d;e.controls.ctrl_btn.prop("disabled",!0);e.stopTimer(e.items[e.game.pointer].timer);if(!f){if(e.game.pointer<e.items.length-1){f=!0;setTimeout(function(){e.controls.container.find(".sgapfill_reply_"+e.game.pointer).hide();e.game.pointer++;e.nextPrompt()},2e3)}else{e.updateProgressDots();e.end()}}}}},getComparison:function getComparison(a,b,c,d){var e=this;e.controls.ctrl_btn.prop("disabled",!0);e.quizhelper.comparePassageToTranscript(a,b,c,e.itemdata.language,e.itemdata.alternates).then(function(a){var b=JSON.parse(a);if(b){d(b)}else{d(!1)}})},end:function end(){var b=this;a(".minilesson_nextbutton").prop("disabled",!0);b.updateProgressDots();setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);if(b.quizhelper.showitemreview){b.controls.progress_container.removeClass("d-flex");b.controls.progress_container.hide();b.controls.title.hide();b.show_item_review()}else{b.next_question()}},2e3)},start:function start(){var a=this;a.controls.ctrl_btn.prop("disabled",!0);a.controls.speakbtncontainer.show();a.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});a.game.pointer=0;a.controls.question.show();if(a.itemdata.readsentence){a.controls.listen_cont.show()}a.controls.start_btn.hide();a.controls.mainmenu.hide();a.controls.controlsbox.show();a.controls.maintitle.show();a.controls.itemquestion.show();a.controls.description.hide();a.controls.image.hide();a.nextPrompt()},updateProgressDots:function updateProgressDots(){var a=this,b,c,d=a.items.map(function(d,e){b="#E6E9FD";c="fa fa-square";if(a.items[e].answered&&a.items[e].correct){b="#74DC72";c="fa fa-check-square"}else if(a.items[e].answered&&!a.items[e].correct){b="#FB6363";c="fa fa-window-close"}return"<i style='color:"+b+"' class='"+c+" pl-1'></i>"}).join(" ");a.controls.title.html(d)},nextPrompt:function nextPrompt(){var a=this;a.controls.ctrl_btn.prop("disabled",!1);a.updateProgressDots();var b=a.controls.container.find(".sgapfill_prompt_"+a.game.pointer);g.do_animate(b,"zoomIn animate__faster","in").then(function(){});a.nextReply()},nextReply:function nextReply(){var a=this,b="<div class='sgapfill_reply sgapfill_reply_"+a.game.pointer+" text-center' style='display:none;'>",c={started:!1,ended:!1,index:null};b+="<div class='form-container'>";a.items[a.game.pointer].parsedstring.forEach(function(a,d){if(c.started&&!c.ended&&c.index!==a.index){c.started=c.ended=!1;b+="</span>"}if(("input"===a.type||"mtext"===a.type)&&!c.started){b+="<span class=\"form-input-phrase-online\" data-mindex=\""+a.index+"\">";c.started=!0}c.index=a.index;if("input"===a.type){b+="<span class='sgapfill_missing_input' data-index='"+d+"'></span>"}else if("mtext"===a.type){b+="<span class='sgapfill_missing_inputmtext'>"+a.character+"</span>"}else{b+=a.character}});if(c.started&&!c.ended){b+="</span>"}b+=" <i data-idx='"+a.game.pointer+"' class='dictate_feedback'></i></div>";var d=a.items[a.game.pointer].definition&&""!==a.items[a.game.pointer].definition,e=d?"margin-bottom: 5px":"margin-bottom: 50px";if(a.items[a.game.pointer].imageurl){b+="<div class='minilesson_sentence_image' style='"+e+"'><div class='minilesson_padded_image'><img src='"+a.items[a.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"}if(d){b+="<div class='definition-container'><div class='definition'><div class='hinticon-container'><i class='fa fa-lightbulb-o hinticon'></i></div><h4 class='hint-title'>Hint</h4>"+a.items[a.game.pointer].definition+"</div>"}a.controls.question.append(b);var f=a.controls.container.find(".sgapfill_reply_"+a.game.pointer);g.do_animate(f,"zoomIn animate__faster","in").then(function(){});a.controls.ctrl_btn.prop("disabled",!1);a.startTimer();if(!a.quizhelper.mobile_user()){if(a.itemdata.hidestartpage&&0===a.game.pointer){a.controls.container.on("showElement",function(){setTimeout(function(){a.controls.listen_btn.trigger("click")},1e3)})}else{setTimeout(function(){a.controls.listen_btn.trigger("click")},1e3)}}var h=a.items[a.game.pointer].target;if(a.quizhelper.use_ttrecorder()){a.ttrec.currentPrompt=h}},stop_audio:function stop_audio(){var a=this,b=a.items[a.game.pointer].audio;if(b&&!b.paused){b.pause()}},startTimer:function startTimer(){var b=this;if(0<b.itemdata.timelimit){var c=function(){b.controls.progress_container.show();b.controls.progress_container.addClass("d-flex align-items-center");b.controls.progress_container.find("i").show();var c=b.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){b.controls.skip_btn.trigger("click")}});c.each(function(){b.items[b.game.pointer].timer.push(a(this).attr("timer"))})};if(b.itemdata.hidestartpage&&0===b.game.pointer){b.controls.container.on("showElement",function(){c()})}else{c()}}},stopTimer:function stopTimer(a){if(a.length){a.forEach(function(a){clearInterval(a)})}}}});
//# sourceMappingURL=speakinggapfill.min.js.map
