define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates"],(function($,log,ajax,def,polly,ttrecorder,anim,progresstimer,templates){return log.debug("MiniLesson speaking gap fill: initialising"),{ttrec:null,controls:{},clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){var self=this,opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("Speech at speaking gap fill -");var words=self.items[self.game.pointer].words,maskedwords=[];Object.keys(words).forEach((function(key){maskedwords.push(words[key])})),self.getComparison(maskedwords.join(" "),message.capturedspeech,self.items[self.game.pointer].phonetic,(function(comparison){self.gotComparison(comparison,message)}))}},opts.stt_guided=quizhelper.is_stt_guided(),opts.wwwroot=quizhelper.is_stt_guided(),self.ttrec=ttrecorder.clone(),self.ttrec.init(opts),self.itemdata=itemdata,log.debug("itemdata"),log.debug(itemdata),self.quizhelper=quizhelper,self.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),self.init_controls(),self.register_events(),self.setvoice(),self.getItems()},init_controls:function(){this.controls={container:$("#"+this.itemdata.uniqueid+"_container"),listen_cont:$("#"+this.itemdata.uniqueid+"_container .sgapfill_listen_cont"),nextbutton:$("#"+this.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:$("#"+this.itemdata.uniqueid+"_container .sgapfill_start_btn"),skip_btn:$("#"+this.itemdata.uniqueid+"_container .sgapfill_skip_btn"),ctrl_btn:$("#"+this.itemdata.uniqueid+"_container .sgapfill_ctrl-btn"),speakbtncontainer:$("#"+this.itemdata.uniqueid+"_container .sgapfill_speakbtncontainer"),game:$("#"+this.itemdata.uniqueid+"_container .sgapfill_game"),controlsbox:$("#"+this.itemdata.uniqueid+"_container .sgapfill_controls"),resultscontainer:$("#"+this.itemdata.uniqueid+"_container .sgapfill_resultscontainer"),mainmenu:$("#"+this.itemdata.uniqueid+"_container .sgapfill_mainmenu"),title:$("#"+this.itemdata.uniqueid+"_container .sgapfill_title"),progress_container:$("#"+this.itemdata.uniqueid+"_container .progress-container"),progress_bar:$("#"+this.itemdata.uniqueid+"_container .progress-container .progress-bar"),question:$("#"+this.itemdata.uniqueid+"_container .question"),listen_btn:$("#"+this.itemdata.uniqueid+"_container .sgapfill_listen_btn")}},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.stop_audio(),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var listencont=this.controls.listen_cont,qbox=this.controls.question,recorderbox=this.controls.speakbtncontainer,gamebox=this.controls.game,controlsbox=this.controls.controlsbox,resultsbox=this.controls.resultscontainer;templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),listencont.hide(),qbox.hide(),recorderbox.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;self.controls.container.find(".minilesson_nextbutton").on("click",(function(e){self.next_question()})),self.controls.start_btn.on("click",(function(){self.start()}));var audioplayerbtn=self.controls.listen_btn;self.itemdata.readsentence&&audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-stop"),$(audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),self.controls.skip_btn.on("click",(function(){self.controls.ctrl_btn.prop("disabled",!0),self.controls.container.find(".sgapfill_speech.sgapfill_teacher_left").text(self.items[self.game.pointer].prompt+""),self.controls.container.find(".sgapfill_targetWord").each((function(){var realidx=$(this).data("realidx"),sgapfill_targetWord=self.items[self.game.pointer].sgapfill_targetWords[realidx];$(this).val(sgapfill_targetWord)})),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?setTimeout((function(){self.controls.container.find(".sgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()}))},game:{pointer:0},usevoice:"",setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var text_items=this.itemdata.sentences;this.items=text_items.map((function(target){return{target:target.sentence,segmentedsentence:target.segmentedsentence,prompt:target.prompt,parsedstring:target.parsedstring,displayprompt:target.displayprompt,definition:target.definition,phonetic:target.phonetic,words:target.words,typed:"",timer:[],answered:!1,correct:!1,audio:null,audiourl:target.audiourl?target.audiourl:"",imageurl:target.imageurl}})).filter((function(e){return""!==e.target})),this.itemdata.readsentence?($.each(this.items,(function(index,item){item.audio=new Audio,item.audio.src=item.audiourl})),this.appReady()):this.appReady()},appReady:function(){this.controls.container.find(".sgapfill_not_loaded").hide(),this.controls.container.find(".sgapfill_loaded").show(),this.itemdata.hidestartpage?this.start():this.controls.start_btn.prop("disabled",!1)},gotComparison:function(comparison,typed){log.debug("sgapfill comparison");var self=this,countdownStarted=!1,feedback=self.controls.container.find(".sgapfill_reply_"+self.game.pointer+" .dictate_feedback[data-idx='"+self.game.pointer+"']");self.controls.container.find(".sgapfill_targetWord").removeClass("sgapfill_correct sgapfill_incorrect"),self.controls.container.find(".sgapfill_feedback").removeClass("fa fa-check fa-times");var allCorrect=0==comparison.filter((function(e){return!e.matched})).length;if(log.debug("allcorrect="+allCorrect),allCorrect&&comparison&&comparison.length>0)self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=self.controls.container.find(".sgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');"input"===data.type&&characterinput.val(data.character)})),feedback.removeClass("fa fa-times"),feedback.addClass("fa fa-check"),log.debug("applying correct class to input boxes"),self.controls.container.find(".sgapfill_reply_"+self.game.pointer+" input").addClass("ml_gapfill_char_correct"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=typed,self.controls.ctrl_btn.prop("disabled",!0),self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1&&!countdownStarted?(countdownStarted=!0,log.debug("moving to next prompt B"),setTimeout((function(){self.controls.container.find(".sgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3)):(self.updateProgressDots(),self.end());else{feedback.removeClass("fa fa-check"),feedback.addClass("fa fa-times"),comparison.forEach((function(obj){var words=self.items[self.game.pointer].words;Object.keys(words).forEach((function(key){words[key]==obj.word&&(obj.matched?self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=self.controls.container.find(".sgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');data.index==key&&"input"===data.type&&characterinput.val(data.character)})):self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=self.controls.container.find(".sgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');data.index==key&&"input"===data.type&&characterinput.val("")})))}))}));var thereply=self.controls.container.find(".sgapfill_reply_"+self.game.pointer);anim.do_animate(thereply,"shakeX animate__faster").then((function(){self.controls.ctrl_btn.prop("disabled",!1)})),self.controls.container.find(".sgapfill_targetWord.sgapfill_correct").each((function(){var realidx=$(this).data("realidx"),targetWord=self.items[self.game.pointer].sgapfill_targetWords[realidx];$(this).val(targetWord)}));var timelimit_progressbar=self.controls.progress_bar;self.itemdata.allowretry&&!timelimit_progressbar.hasClass("progress-bar-complete")||(self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.items[self.game.pointer].typed=typed,self.controls.ctrl_btn.prop("disabled",!0),self.stopTimer(self.items[self.game.pointer].timer),countdownStarted||(self.game.pointer<self.items.length-1?(countdownStarted=!0,setTimeout((function(){self.controls.container.find(".sgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3)):(self.updateProgressDots(),self.end())))}},getComparison:function(passage,transcript,phonetic,callback){this.controls.ctrl_btn.prop("disabled",!0),this.quizhelper.comparePassageToTranscript(passage,transcript,phonetic,this.itemdata.language,this.itemdata.alternates).then((function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)}))},end:function(){var self=this;$(".minilesson_nextbutton").prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2e3)},start:function(){this.controls.ctrl_btn.prop("disabled",!0),this.controls.speakbtncontainer.show(),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,this.controls.question.show(),this.itemdata.readsentence&&this.controls.listen_cont.show(),this.controls.start_btn.hide(),this.controls.mainmenu.hide(),this.controls.controlsbox.show(),this.nextPrompt()},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");self.controls.title.html(progress)},nextPrompt:function(){this.controls.ctrl_btn.prop("disabled",!1),this.updateProgressDots();var newprompt=this.controls.container.find(".sgapfill_prompt_"+this.game.pointer);anim.do_animate(newprompt,"zoomIn animate__faster","in").then((function(){})),this.nextReply()},nextReply:function(){var self=this,code="<div class='sgapfill_reply sgapfill_reply_"+self.game.pointer+" text-center' style='display:none;'>",brackets={started:!1,ended:!1,index:null};code+="<div class='form-container'>",self.items[self.game.pointer].parsedstring.forEach((function(data,index){brackets.started&&!brackets.ended&&brackets.index!==data.index&&(brackets.started=brackets.ended=!1,code+="</span>"),"input"!==data.type&&"mtext"!==data.type||brackets.started||(code+='<span class="form-input-phrase-online" data-mindex="'+data.index+'">',brackets.started=!0),brackets.index=data.index,"input"===data.type?code+="<input class='single-character' autocomplete='off' type='text' name='filltext"+index+"' maxlength='1' data-index='"+index+"' readonly>":"mtext"===data.type?code+="<input class='single-character-mtext' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),brackets.started&&!brackets.ended&&(code+="</span>"),code+=" <i data-idx='"+self.game.pointer+"' class='dictate_feedback'></i></div>";var hasdefinition=self.items[self.game.pointer].definition&&""!==self.items[self.game.pointer].definition,imagebottommargin=hasdefinition?"margin-bottom: 5px":"margin-bottom: 50px";self.items[self.game.pointer].imageurl&&(code+="<div class='minilesson_sentence_image' style='"+imagebottommargin+"'><div class='minilesson_padded_image'><img src='"+self.items[self.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"),hasdefinition&&(code+="<div class='definition-container'><div class='definition'>"+self.items[self.game.pointer].definition+"</div>"),self.controls.question.append(code);var newreply=self.controls.container.find(".sgapfill_reply_"+self.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),self.controls.ctrl_btn.prop("disabled",!1),self.startTimer(),self.quizhelper.mobile_user()||(self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{setTimeout((function(){self.controls.listen_btn.trigger("click")}),1e3)})):setTimeout((function(){self.controls.listen_btn.trigger("click")}),1e3));var target=self.items[self.game.pointer].target;self.quizhelper.use_ttrecorder()&&(self.ttrec.currentPrompt=target)},stop_audio:function(){var theaudio=this.items[this.game.pointer].audio;theaudio&&!theaudio.paused&&theaudio.pause()},startTimer:function(){var self=this;if(self.itemdata.timelimit>0){var doStartTimer=function(){self.controls.progress_container.show(),self.controls.progress_container.find("i").show(),self.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){self.controls.skip_btn.trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))}))};self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{doStartTimer()})):doStartTimer()}},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))}}}));

//# sourceMappingURL=speakinggapfill.min.js.map