{"version":3,"file":"spacegame.min.js","sources":["../src/spacegame.js"],"sourcesContent":["\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Spacegame app javascript for Poodll minilesson\n *\n * @package    mod_minilesson\n * @copyright  2024 Justin Hunt (poodllsupport@gmail.com)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(\n    ['jquery', 'core/notification', 'mod_minilesson/definitions', 'core/log', 'core/templates', 'core/ajax', 'core/str'],\n    function ($, notification, def, log, templates, Ajax, str) {\n\n        \"use strict\"; // jshint ;_;\n\n    /*\n    This file is to manage the Space Game item type.\n    */\n\n        log.debug('MiniLesson Space Game: initialising');\n\n        class Rectangle {\n            /**\n             * Constructor for storing information about a rectangle shape.\n             * @param {int} left\n             * @param {int} top\n             * @param {int} width\n             * @param {int} height\n             */\n            constructor(left, top, width, height)\n            {\n                this.left = left || 0;\n                this.top = top || 0;\n                this.width = width || 0;\n                this.height = height || 0;\n            }\n\n            right()\n            {\n                return this.left + this.width;\n            };\n\n            bottom()\n            {\n                return this.top + this.height;\n            };\n\n            Contains(point)\n            {\n                return point.x > this.left &&\n                point.x < this.right() &&\n                point.y > this.top &&\n                point.y < this.bottom();\n            };\n\n            Intersect(rectangle)\n            {\n                var retval = !(rectangle.left > this.right() ||\n                rectangle.right() < this.left ||\n                rectangle.top > this.bottom() ||\n                rectangle.bottom() < this.top);\n                return retval;\n            };\n        }\n        class GameObject {\n            /**\n             * Generate game object.\n             * @param {text} src\n             * @param {int} x\n             * @param {int} y\n             */\n            constructor(src, x, y)\n            {\n                if (src !== null) {\n                    this.image = this.loadImage(src);\n                }\n                this.x = x;\n                this.y = y;\n                this.velocity = {x: 0, y: 0};\n                this.direction = {x: 0, y: 0};\n                this.movespeed = {x: 5, y: 3};\n                this.alive = true;\n                this.decay = 0.7;\n            }\n\n            loadImage(src)\n            {\n                if (!this.image) {\n                    this.image = new Image();\n                }\n                // we dont use the pre-loaded images here, we should, but we need diff images in matching\n                this.image.src = M.cfg.wwwroot + '/mod/minilesson/' + src;\n                return this.image;\n            }\n\n            update()\n            {\n                this.velocity.x += this.direction.x * this.movespeed.x;\n                this.velocity.y += this.direction.y * this.movespeed.y;\n                this.x += this.velocity.x;\n                this.y += this.velocity.y;\n                this.velocity.y *= this.decay;\n                this.velocity.x *= this.decay;\n            };\n\n            draw(context)\n            {\n                context.drawImage(this.image, this.x, this.y, this.image.width, this.image.height);\n            };\n\n            getRect()\n            {\n                return new Rectangle(this.x, this.y, this.image.width, this.image.height);\n            };\n\n            die()\n            {\n                this.alive = false;\n            };\n        }\n\n    /**\n     * Represents a player in the game, handling movement, shooting, and collision detection.\n     */\n        class Player extends GameObject {\n            /**\n             * Constructor for Player class, all the information about the player\n             * @param {string} src\n             * @param {int} x\n             * @param {int} y\n             */\n            constructor(src, x, y)\n            {\n                super(src, x, y);\n                this.mouse = {x: 0, y: 0};\n                this.movespeed = {x: 6, y: 4};\n                this.lives = 3;\n                this.lastScore = 0;\n            }\n\n            update(bounds)\n            {\n                if (app.mouseDown || app.touchDown) {\n                    if (this.x < this.mouse.x - (this.image.width)) {\n                        app.player.direction.x = 1;\n                    } else if (this.x > this.mouse.x) {\n                        app.player.direction.x = -1;\n                    } else {\n                        app.player.direction.x = 0;\n                    }\n                    if (this.y < this.mouse.y - (this.image.height)) {\n                        app.player.direction.y = 1;\n                    } else if (this.y > this.mouse.y) {\n                        app.player.direction.y = -1;\n                    } else {\n                        app.player.direction.y = 0;\n                    }\n                }\n                super.update(bounds);\n\n                if (this.x < bounds.x - this.image.width) {\n                    this.x = bounds.width;\n                } else if (this.x > bounds.width) {\n                    this.x = bounds.x - this.image.width;\n                }\n                if (this.y < bounds.y) {\n                    this.y = bounds.y;\n                } else if (this.y > bounds.height - this.image.height) {\n                    this.y = bounds.height - this.image.height;\n                }\n            };\n\n            Shoot()\n            {\n                app.playSound(\"laser\");\n                var shooter = this;\n                app.gameObjects.unshift(new Laser(app.player.x, app.player.y,shooter, true, 24));\n                app.canShoot = false;\n            }\n\n            die()\n            {\n                super.die();\n                app.playSound(\"explosion\");\n                app.spray(this.x + this.image.width / 2, this.y + this.image.height / 2, 200, \"#FFCC00\");\n                this.lastScore = app.score;\n                app.endGame();\n            }\n\n            gotShot(shot)\n            {\n                if (shot.alive) {\n                    if (this.lives <= 1) {\n                        this.die();\n                    } else {\n                        this.lives--;\n                        app.spray(this.x + this.image.width / 2, this.y + this.image.height / 2, 100, \"#FFCC00\");\n                    }\n                }\n            }\n        }\n\n    // Represents a planet in the game, serving as a background object.\n        class Planet extends GameObject{\n            /**\n             * Constructor for Planet (background objects) extends GameObject\n             * @param {string} src\n             * @param {int} x\n             * @param {int} y\n             */\n            constructor(src, x, y )\n            {\n                super(src,x,y);\n            }\n\n            update(bounds)\n            {\n                this.image.width = app.displayRect.width;\n                this.image.height = app.displayRect.height;\n                super.update();\n            }\n\n        }\n\n    // Represents an enemy in the game. Adds enemy-specific behavior like shooting and movement patterns.\n        class Enemy extends GameObject {\n            constructor(src, x, y, text, itempoints, termid)\n            {\n                super(src,x,y);\n                this.xspeed = app.enemySpeed;\n                this.yspeed = app.enemySpeed * (2 + Math.random()) / 4;\n                this.movespeed.x = 0;\n                this.movespeed.y = 0;\n                this.direction.y = 1;\n                this.text = text;\n                this.itempoints = itempoints;\n                this.movementClock = 0;\n                this.shotFrequency = 80;\n                this.shotClock = (1 + Math.random()) * this.shotFrequency;\n                this.level = app.level;\n                this.termid = termid;\n\n            }\n\n            update(bounds)\n            {\n                if (this.y < bounds.height / 10 || this.y > bounds.height * 9 / 10) {\n                    this.movespeed.x = this.xspeed * 1;\n                    this.movespeed.y = this.yspeed * 5;\n                } else {\n                    this.movespeed.x = this.xspeed;\n                    this.movespeed.y = this.yspeed;\n                }\n\n                super.update(bounds);\n\n                this.movementClock--;\n                this.movementClock--;\n\n                if (this.movementClock <= 0) {\n                    this.direction.x = Math.floor(Math.random() * 3) - 1;\n                    this.movementClock = (2 + Math.random()) * 30;\n                }\n\n                this.shotClock -= app.enemySpeed;\n\n                if (this.shotClock <= 0) {\n                    if (this.y < bounds.height * 0.6) {\n                        app.playSound(\"enemylaser\");\n                        var shooter = this;\n                        var laser = new Laser(this.x, this.y, shooter);\n                        laser.direction.y = 1;\n                        laser.friendly = false;\n                        app.gameObjects.unshift(laser);\n                        this.shotClock = (1 + Math.random()) * this.shotFrequency;\n                    }\n                }\n\n                if (this.x < bounds.x - this.image.width) {\n                    this.x = bounds.width;\n                } else if (this.x > bounds.width) {\n                    this.x = bounds.x - this.image.width;\n                }\n                if (this.y > bounds.height + this.image.height && this.alive) {\n                    this.alive = false;\n                    if (this.itempoints > 0) {\n                        app.currentPointsLeft -= this.itempoints;\n                        app.score -= 1000 * this.itempoints;\n                    }\n\n                    app.shipReachedEnd.call(this);\n                }\n            }\n\n            draw(context)\n            {\n\n                super.draw(context);\n                context.fillStyle = '#FFFFFF';\n                context.font = \"20px Audiowide\";\n                context.textAlign = 'center';\n\n                app.wrapText(context, this.text, true, 17, app.displayRect.width * 0.2, this.x + this.image.width / 2, this.y - 5);\n            }\n\n            die()\n            {\n                super.die();\n                app.spray(this.x + this.image.width, this.y + this.image.height, 50 + (this.itempoints * 150), \"#FF0000\");\n\n                // Adjust Score.\n                app.score += this.itempoints * 1000;\n\n                //report the positive association\n                app.reportSuccess(this.termid);\n\n                // Kill off the ship.\n                app.playSound(\"explosion\");\n            }\n\n            gotShot(shot)\n            {\n                // Default behaviour, to be overridden.\n                shot.die();\n                this.die();\n\n            }\n        }\n\n    // Represents a laser in the game, capable of moving across the screen and interacting with other game objects.\n        class Laser extends GameObject {\n            constructor(x, y, shooter, friendly, laserSpeed)\n            {\n\n                super(friendly ? \"pix/spacegame/laser.png\" : \"pix/spacegame/enemylaser.png\", x, y);\n                this.x = this.x + ((shooter.image.width - this.image.width) / 2);\n                this.direction.y = -1;\n                this.friendly = friendly ? 1 : 0;\n                this.laserSpeed = laserSpeed || 12;\n            }\n\n            update(bounds)\n            {\n                super.update(bounds);\n                if (this.x < bounds.x - this.image.width ||\n                this.x > bounds.width ||\n                this.y < bounds.y - this.image.height ||\n                this.y > bounds.height) {\n                    this.alive = false;\n                }\n                this.velocity.y = this.laserSpeed * this.direction.y;\n            };\n\n            deflect()\n            {\n                this.image = this.loadImage(\"pix/spacegame/enemylaser.png\");\n                this.direction.y *= -1;\n                this.friendly = !this.friendly;\n                app.playSound(\"deflect\");\n            };\n        }\n\n        class Particle extends GameObject {\n            constructor(x, y, velocity, colour)\n            {\n                super(null, x, y);\n                this.width = 2;\n                this.height = 2;\n                this.velocity.x = velocity.x;\n                this.velocity.y = velocity.y;\n                this.aliveTime = 0;\n                this.colour = colour;\n                this.decay = 1;\n            }\n\n            update(bounds)\n            {\n                super.update(bounds);\n                if (this.x < bounds.x - this.width ||\n                this.x > bounds.width ||\n                this.y < bounds.y - this.height ||\n                this.y > bounds.height) {\n                    this.alive = false;\n                }\n                this.aliveTime++;\n                if (this.aliveTime > (Math.random() * 15) + 5) {\n                    this.alive = false;\n                }\n            }\n\n            getRect()\n            {\n                return new Rectangle(this.x, this.y, this.width, this.height);\n            }\n\n            draw(context)\n            {\n                context.fillStyle = this.colour;\n                context.fillRect(this.x, this.y, this.width, this.height);\n                context.stroke();\n            }\n        }\n\n    // Represents a star in the background of the game, moving downwards to create a parallax effect.\n        class Star extends GameObject {\n            constructor(bounds)\n            {\n                super(null, Math.random() * bounds.width, 0);\n                this.width = 2;\n                this.height = 2;\n                this.direction.y = 1;\n                this.movespeed.y = 0.2 + (Math.random() / 2);\n                this.aliveTime = 0;\n            }\n\n            update(bounds)\n            {\n                super.update(bounds);\n                if (this.y > bounds.height) {\n                    this.alive = false;\n                }\n            }\n\n            draw(context)\n            {\n                context.fillStyle = '#9999AA';\n                context.fillRect(this.x, this.y, this.width, this.height);\n                context.stroke();\n            }\n        }\n\n    /**\n     * MultiEnemy extends the Enemy class to represent a more complex enemy type in the game.\n     *\n     * @param {int} x\n     * @param {int} y\n     * @param {string} text\n     * @param {float} itempoints\n     * @param {boolean} single\n     */\n        class MultiEnemy extends Enemy {\n            constructor(x, y, text, itempoints, single,termid)\n            {\n                super(\"pix/spacegame/ship-enemy-yellow-\" + app.shipsize + \".png\", x, y, text, itempoints, termid);\n                this.single = single;\n            }\n\n            die()\n            {\n                super.die();\n                if (this.itempoints > 0) {\n                    app.currentPointsLeft -= this.itempoints;\n                }\n                // Store the result for later processing.\n                app.storeResult(this.termid, this.itempoints);\n                if ((this.single && this.itempoints === 1) && this.itempoints >= 1 || (this.itempoints > 0 && app.currentPointsLeft <= 0)) {\n                    app.killAllAlive();\n                    app.nextLevel();\n                }\n            }\n\n            gotShot(shot)\n            {\n                if (this.itempoints > 0) {\n                    shot.die();\n                    this.die();\n\n                    // Report the positive association.\n                    app.reportSuccess(this.termid);\n                } else {\n                    app.score += (this.itempoints - 0.5) * 600;\n\n                    // Record negative association for later processing.\n                    app.storeResult(this.termid, 0);\n\n                    shot.deflect();\n                }\n            }\n        }\n\n    // MatchEnemy extends the Enemy class to represent enemies that can be matched/paired in the game.\n        class MatchEnemy extends Enemy {\n            constructor(x, y, text, itempoints, pairid, stem, termid  )\n            {\n\n                if (stem) {\n                    super(\"pix/spacegame/ship-enemy-green-\" + app.shipsize + \".png\", x, y, text, itempoints, termid);\n                } else {\n                   // super(\"pix/spacegame/ship-enemy-purple-64.png\", x, y, text, itempoints, termid);\n                    super(\"pix/spacegame/ship-enemy-green-\" + app.shipsize + \".png\", x, y, text, itempoints, termid);\n                }\n                this.stem = stem ? true : false;\n                this.pairid = pairid;\n                this.shotFrequency = 160;\n                this.hightlighted = false;\n            }\n\n            die()\n            {\n                app.currentPointsLeft -= this.itempoints;\n                // Sets the itempoints as 0 to stop it adding to the score in #die()\n                this.itempoints = 0;\n                super.die();\n\n            }\n\n            gotShot(shot)\n            {\n                if (shot.alive && this.alive) {\n                    if (app.lastShot == -this.pairid) {\n                        // Increasing the score here instead of in #die(), due to rounding issues being a few numbers off.\n                        // This must be done before because when #die is invoked, as it sets the itempoints as 0.\n                        app.score += this.itempoints * 1000 * 2;\n\n                        //store the result for later processing\n                        app.storeResult(this.termid, this.itempoints);\n\n                        //report the positive association\n                        app.reportSuccess(this.termid);\n\n\n                        shot.die();\n                        this.die();\n                        var alives = 0;\n                        app.currentTeam.forEach(function (match) {\n                            if (match.pairid == app.lastShot) {\n                                match.die();\n                            }\n                            if (match.alive) {\n                                alives++;\n                            }\n                        });\n\n                        if (alives <= 0) {\n                            app.nextLevel();\n                        }\n                    } else {\n                        if (app.lastShot == this.pairid) {\n                            shot.deflect();\n                        } else {\n                            shot.die();\n                            this.hightlight();\n                            app.lastShot = this.pairid;\n                        }\n                    }\n                }\n            }\n\n            hightlight()\n            {\n                app.currentTeam.forEach(function (match) {\n                    match.unhightlight();\n                });\n                if (this.stem) {\n                    this.loadImage(\"pix/spacegame/ship-enemy-blue-\" + app.shipsize + \".png\");\n                } else {\n                    this.loadImage(\"pix/spacegame/ship-enemy-blue-\" + app.shipsize + \".png\");\n                }\n                this.hightlighted = true;\n            };\n\n            unhightlight()\n            {\n                if (this.hightlighted) {\n                    if (this.stem) {\n                        this.loadImage(\"pix/spacegame/ship-enemy-green-\" + app.shipsize + \".png\");\n                    } else {\n                        this.loadImage(\"pix/spacegame/ship-enemy-green-\" + app.shipsize + \".png\");\n                    }\n                }\n                this.hightlighted = false;\n            }\n        }\n\n    // Start of app declaration.\n        var app = {\n            isFreeMode:  false,\n            strings: {\"shootthepairs\": \"Shoot the Pairs\"},\n            termAsAlien: \"0\",\n            questions: [],\n            quizgame: null,\n            stage: null,\n            score: 0,\n            particles: [],\n            gameObjects: [],\n            shipsize: \"48\", //TO DO: make this a setting and refactor image loading to be not clunky\n            images: [\n                'pix/spacegame/icon.gif',\n                'pix/spacegame/planet.png',\n                'pix/spacegame/ship.png',\n                'pix/spacegame/ship-poodll-64.png',\n                'pix/spacegame/ship-enemy-green-64.png',\n                'pix/spacegame/ship-enemy-yellow-64.png',\n                'pix/spacegame/ship-enemy-blue-64.png',\n                'pix/spacegame/ship-poodll-48.png',\n                'pix/spacegame/ship-enemy-green-48.png',\n                'pix/spacegame/ship-enemy-yellow-48.png',\n                'pix/spacegame/ship-enemy-blue-48.png',\n                'pix/spacegame/space-bckg.png',\n                'pix/spacegame/enemy.png',\n                'pix/spacegame/enemystem.png',\n                'pix/spacegame/enemychoice.png',\n                'pix/spacegame/enemystemselected.png',\n                'pix/spacegame/enemychoiceselected.png',\n                'pix/spacegame/laser.png',\n                'pix/spacegame/enemylaser.png'\n            ],\n            imagesLoaded:  0,\n            loadedImages:[],\n            loaded: false,\n            player: null,\n            planet: null,\n            level: -1,\n            displayRect: {x: 0, y: 0, width: 0, height: 0},\n            question: \"\",\n            interval: null,\n            enemySpeed: null,\n            touchDown: false,\n            mouseDown: false,\n            currentTeam: [],\n            lastShot: 0,\n            currentPointsLeft:  0,\n            context: null,\n            inFullscreen: false,\n            canShoot: true,\n            dryRun: false,\n            ttslanguage: 'en-US',\n            distractors: [],\n            controls: {},\n            results: [],\n            timer: null,\n\n\n\n            registerSpaceGameEvents: function () {\n\n                document.onkeyup = this.keyup;\n                document.onkeydown = this.keydown;\n                document.onmouseup = this.mouseup;\n                document.onmousedown = this.mousedown;\n                document.onmousemove = this.mousemove;\n                document.ontouchstart = this.touchstart;\n                document.ontouchend = this.touchend;\n                document.addEventListener('touchmove',this.touchmove, {passive: false});\n                window.onresize = this.orientationChange;\n\n                document.addEventListener(\"gesturestart\", this.cancelled, false);\n                document.addEventListener(\"gesturechange\", this.cancelled, false);\n                document.addEventListener(\"gestureend\", this.cancelled, false);\n            }  ,\n\n    /**\n     * Play sound effect.\n     * @param {string} soundName\n     */\n            playSound: function (soundName) {\n                if (document.getElementById(\"mod_minilesson_spacegame_sound_on\").checked) {\n                    var soundElement = document.getElementById(\"mod_minilesson_sound_\" + soundName);\n                    soundElement.currentTime = 0;\n                    soundElement.play();\n                }\n            },\n\n    /**\n     * Adjust for small screens.\n     */\n            smallscreen: function () {\n                app.inFullscreen = false;\n\n                if (document.fullscreenElement) {\n                    if (document.exitFullscreen) {\n                        let exitPromise = document.exitFullscreen();\n                        if (exitPromise instanceof Promise) {\n                            exitPromise.then(() => console.log(\"Document Exited from Full screen mode\"))\n                               .catch((err) => console.error(err));\n                        } else {\n                            console.log(\"Document Exited from Full screen mode\");\n                        }\n                    } else if (document.webkitExitFullscreen) { /* Safari */\n                        document.webkitExitFullscreen();\n                        console.log(\"Document Exited from Full screen mode (webkit)\");\n                    } else if (document.msExitFullscreen) { /* IE11 */\n                        document.msExitFullscreen();\n                        console.log(\"Document Exited from Full screen mode (ms)\");\n                    } else {\n                        console.error(\"Fullscreen exit is not supported by this browser\");\n                    }\n                } else {\n                    console.log(\"Document is not in fullscreen mode\");\n                }\n\n                app.stage.removeAttribute(\"width\");\n                app.stage.removeAttribute(\"height\");\n                app.stage.removeAttribute(\"style\");\n\n                app.stage.classList.remove(\"floating-game-canvas\");\n                $(\"#button_container\").removeClass(\"floating-button-container fixed-bottom\");\n\n                app.displayRect.width = app.stage.clientWidth;\n                app.displayRect.height = app.stage.clientHeight;\n                app.stage.style.width = app.displayRect.width;\n                app.stage.style.height = app.displayRect.height;\n                app.sizeScreen(app.stage);\n            },\n\n    /**\n     * Adjust screen size (switch between modes).\n     */\n            fschange: function () {\n                if (this.inFullscreen) {\n                    app.smallscreen();\n                }\n            },\n\n    /**\n     * Expand to full screen.\n     */\n            fullscreen: function () {\n                var landscape = window.matchMedia(\"(orientation: landscape)\").matches;\n                try {\n                    if (app.stage.requestFullscreen) {\n                        app.stage.requestFullscreen();\n                    } else if (app.stage.msRequestFullscreen) {\n                        app.stage.msRequestFullscreen();\n                    } else if (app.stage.mozRequestFullScreen) {\n                        app.stage.mozRequestFullScreen();\n                    } else {\n                        console.error(\"Fullscreen API is not supported by this browser\");\n                    }\n                } catch (e) {\n                    log.debug(e, \"Fullscreen error: \");\n                }\n                // The stage.webkitRequestFullscreen() method was removed, due to very easily exiting of full screen in iOS,\n                // along with browser messages asking if you are typing in fullscreen.\n\n                app.inFullscreen = true;\n                var buttonContainer = $(\"#button_container\");\n\n                var width = window.innerWidth;\n\n                // The window.innerHeight returns an offset value on iOS devices in safari only\n                // while in portrait mode for some reason.\n                var height = $(window).height();\n\n                // Switch width and height\n                if (landscape && width < height) {\n                    height = [width, width = height][0];\n                }\n\n                // Gets the actual button container height, then adds 16px; 8px on the\n                // top and 8px on the bottom for the page margin.\n                height -= buttonContainer.height() + 16;\n\n                app.displayRect.width = width;\n                app.displayRect.height = height;\n\n                app.stage.style.width = width + \"px\";\n                app.stage.style.height = height + \"px\";\n\n                // Makes the canvas float.\n                app.stage.classList.add(\"floating-game-canvas\");\n\n                // This makes the button container float below the game canvas.\n                buttonContainer.addClass(\"floating-button-container fixed-bottom\");\n\n                $(\"#mod_minilesson_spacegame_fullscreen_button\").blur(); // The button pressed was still focused, so a blur is necessary.\n\n                app.sizeScreen(app.stage);\n            },\n\n    /**\n     * Adjust screen size based on browser window.\n     * @param {object} stage\n     */\n            sizeScreen: function (stage) {\n\n                stage.width = app.displayRect.width;\n                stage.height = app.displayRect.height;\n                app.context.imageSmoothingEnabled = false;\n            },\n\n    /**\n     * Helper function for when the screen size chages due to rotating on mobile.\n     */\n            orientationChange: function () {\n                if (app.inFullscreen) {\n                    app.fullscreen();\n                } else {\n                    app.smallscreen();\n                }\n            },\n\n    /**\n     * Helper function to clear all events.\n     */\n            clearEvents: function () {\n                document.onkeydown = null;\n                document.onkeyup = null;\n                document.onmousedown = null;\n                document.onmouseup = null;\n                document.onmousemove = null;\n                document.ontouchstart = null;\n                document.ontouchend = null;\n                document.ontouchmove = null;\n                window.onresize = null;\n            },\n\n            storeResult: function (termid, points) {\n                var theterm = false;\n                app.terms.forEach(function (aterm) {\n                    if (aterm.id == termid) {\n                        theterm = aterm\n                    }\n                });\n                //if we found the term, store the result\n                if (theterm) {\n                    var result = {\n                        question: app.strip_html(theterm['definition']),\n                        selected: '',\n                        correct: theterm['term'],\n                        points: points,\n                        id: theterm.id\n                    };\n                    for (var i = 0; i < app.results.length; i++) {\n                        if (app.results[i].id == theterm.id) {\n                            //if we have a duplicate and the earlier one is a fail, but this is a pass, replace it\n                            if (points > 0 && app.results[i].points == 0) {\n                                app.results.splice(i, 1);\n                            //otherwise we just keep the previous result\n                            } else {\n                                return;\n                            }\n                        }\n                    }\n                    //storing result\n                    app.results.push(result);\n                }\n            },\n\n            reportSuccess: function (termid) {\n                if (app.dryRun) {\n                    return;\n                }\n                //In wordcards we report the success of the association, but not here\n                /*\n                Ajax.call([{\n                    methodname: 'mod_minilesson_report_successful_association',\n                    args: {\n                termid: termid,\n                isfreemode: app.isFreeMode\n                    }\n                }]);\n                */\n            },\n\n            reportFailure: function (term1id, term2id) {\n                if (app.dryRun) {\n                    return;\n                }\n                //In wordcards we report the success of the association, but not here\n                /*\n                Ajax.call([{\n                    methodname: 'mod_minilesson_report_failed_association',\n                    args: {\n                term1id: term1id,\n                term2id: term2id,\n                isfreemode: app.isFreeMode\n                    }\n                }]);\n                */\n            },\n\n    /**\n     * Helper function to handle JS Events.\n     */\n            menuEvents: function () {\n                app.clearEvents();\n                document.onkeydown = app.menukeydown;\n                document.onmouseup = app.menumousedown;\n                document.ontouchend = app.menutouchend;\n                window.onresize = app.orientationChange;\n            },\n\n    /**\n     * Helper function to load game objects\n     */\n            loadGame: function () {\n                // We already do this elsewhere.\n                app.shuffle(app.questions);\n\n                if (!app.loaded) {\n                    app.images.forEach(function (src) {\n                        var absolute_src = M.cfg.wwwroot + '/mod/minilesson/' + src;\n\n                        var image = new Image();\n                        image.src = absolute_src;\n                        image.onload = function () {\n                            app.loadedImages[src] = image;\n                            app.imagesLoaded++;\n                            console.log(app.imagesLoaded);\n                            if (app.imagesLoaded >= app.images.length) {\n                                app.gameLoaded();\n                            }\n                        };\n                    });\n                    app.loaded = true;\n                } else {\n                    app.startGame();\n                }\n            },\n\n    /**\n     * Helper function process game-over.\n     */\n            endGame: function () {\n\n                // Clear full screen.\n                if (app.inFullscreen) {\n                    log.debug(\"quitting full screen\");\n                    app.inFullscreen = false;\n                    app.smallscreen();\n                }\n\n                clearInterval(app.timer.interval);\n                $(\"#minilesson-gameboard, #minilesson-start-button\").hide();\n                $(\"#minilesson-results\").show();\n\n                // Template data.\n                var tdata = [];\n                tdata['allowretry'] = app.allowretry;\n                tdata['nexturl'] = app.nexturl;\n                tdata['results'] = app.results;\n                tdata['total'] = app.questions.length;\n                var totalcorrect = app.calc_total_points(app.results);\n                //remove any decimal (leave one decimal place)\n                tdata['totalcorrect'] = Math.round(totalcorrect * 10) / 10;\n                tdata['gamescore'] = Math.round(app.score);\n                var total_time = app.timer.count;\n                if (total_time == 0) {\n                    tdata['prettytime'] = '00:00';\n                } else {\n                    tdata['prettytime'] = app.pretty_print_secs(total_time);\n                }\n\n                templates.render('mod_minilesson/feedback', tdata).then(\n                    function (html, js) {\n                        $(\"#results-inner\").html(html);\n                    }\n                );\n\n                var data = {\n                    results: app.results,\n                    activity: \"spacegame\"\n                };\n            /*\n                if (!app.isFreeMode) {\n                    Ajax.call([{\n                methodname: 'mod_minilesson_report_step_grade',\n                args: {\n                    modid: app.modid,\n                    correct: tdata['totalcorrect']\n                }\n                    }]);\n                }\n                    */\n\n                // ajax.call([{\n                //     methodname: 'mod_wordcards_update_score',\n                //     args: {quizgameid: quizgame, score: Math.trunc(score)},\n                //     fail: notification.exception\n                // }]);\n\n                // We use wordcards end screen so we dont do menuevents.\n                // We just clear events so that the game doesnt restart and kill any ships left on stage\n                //this.menuEvents();\n                this.killAllAlive();\n                this.clearEvents();\n            },\n\n    /**\n     * Helper function process game ready.\n     */\n            gameLoaded: function () {\n\n                clearInterval(app.interval);\n\n                app.interval = setInterval(function () {\n                    app.draw(app.context, app.displayRect, app.gameObjects, app.particles, app.question);\n                    app.update(app.displayRect, app.gameObjects, app.particles);\n                }, 40);\n\n                app.startGame();\n            },\n\n    /**\n     * Helper function process game start.\n     */\n            startGame: function () {\n                app.score = 0;\n                app.gameObjects = [];\n                app.particles = [];\n                app.level = -1;\n                app.enemySpeed = 0.5;\n                app.touchDown = false;\n                app.mouseDown = false;\n                app.results = [];\n\n                // Queue & trigger the game_started event.\n                /*\n                ajax.call([{\n                    methodname: 'mod_wordcards_start_game',\n                    args: {quizgameid: quizgame},\n                    fail: notification.exception\n                }]);\n                */\n                app.player = new Player(\"pix/spacegame/ship-poodll-\" + app.shipsize + \".png\", 0, 0);\n                app.player.x = app.displayRect.width / 2;\n                app.player.y = app.displayRect.height / 2;\n                app.gameObjects.push(app.player);\n\n                app.planet = new Planet(\"pix/spacegame/planet.png\", 0, 0);\n                app.planet.image.width = app.displayRect.width;\n                app.planet.image.height = app.displayRect.height;\n                app.planet.direction.y = 1;\n                app.planet.movespeed.y = 0.7;\n                app.particles.push(app.planet);\n                // Set up the timer.\n                app.timer = {\n                    interval: setInterval(function () {\n                        app.timer.update();\n                    }, 1000),\n                count: 0,\n                update: function () {\n                    app.timer.count++;\n                    $(\"#minilesson-time-counter\").text(app.timer.count);\n                }\n                }\n\n                app.nextLevel();\n\n                app.registerSpaceGameEvents();\n            },\n\n    /**\n     * Helper function process next level (question).\n     */\n            nextLevel: function () {\n                app.level++;\n\n                // If we've run out of questions\n                if (app.level >= app.questions.length) {\n                    //kill the player and end the game\n                    app.player.die();\n\n                    //previously we raised the speed, but we don't want to do that anymore\n                    //we might go back on it though.. so its still here\n                    /*\n                    app.level = 0;\n                    app.enemySpeed *= 1.3;\n                    app.question = app.runLevel(app.questions, app.level, app.displayRect);\n                    */\n                } else {\n                    app.question = app.runLevel(app.questions, app.level, app.displayRect);\n                }\n            },\n\n    /**\n     * Helper function process current level.\n     * @param {array} questions\n     * @param {object} level\n     * @param {object} bounds\n     * @returns {string}\n     */\n            runLevel: function (questions, level, bounds) {\n                app.currentTeam = [];\n                app.lastShot = 0;\n                app.currentPointsLeft = 0;\n\n                switch (questions[level].type) {\n                    case 'matching':\n                        var i = 0;\n                        //so in the case of 3 pairs, we have 6 items, so each item is worth 1/6, one pair will require two shots = 2/6\n                        var itempoints = 1 / (questions[level].stems.length * 2);\n                        app.currentPointsLeft += 1;\n                        questions[level].stems.forEach(function (stem) {\n                            i++;\n                            var question = new MatchEnemy(\n                                Math.random() * bounds.width,\n                                -Math.random() * bounds.height / 2,\n                                stem.question,\n                                itempoints,\n                                -i,\n                                true,\n                                stem.termid\n                            );\n                            var answer = new MatchEnemy(\n                                Math.random() * bounds.width,\n                                -Math.random() * bounds.height / 2,\n                                stem.answer,\n                                itempoints,\n                                i,\n                                false,\n                                stem.termid\n                            );\n                            app.currentTeam.push(question);\n                            app.currentTeam.push(answer);\n                            app.gameObjects.push(question);\n                            app.gameObjects.push(answer);\n                        });\n                        break;\n\n                    case 'multichoice':\n                        questions[level].answers.forEach(function (answer) {\n                            var enemy = new MultiEnemy(\n                                Math.random() * bounds.width,\n                                -Math.random() * bounds.height / 2,\n                                answer.text,\n                                answer.itempoints,\n                                questions[level].single,\n                                questions[level].termid\n                            );\n\n                            if (answer.itempoints < 1) {\n                                app.currentTeam.push(enemy);\n                                if (answer.itempoints > 0) {\n                                    app.currentPointsLeft += answer.itempoints;\n                                }\n                            }\n                            app.gameObjects.push(enemy);\n                        });\n                }\n                return questions[level].question;\n            },\n\n    /**\n     * Helper function to place text on screen\n     * @param {object} context\n     * @param {object} displayRect\n     * @param {objectc} objects\n     * @param {object} particles\n     * @param {string} question\n     */\n            draw: function (context, displayRect, objects, particles, question) {\n                context.clearRect(0, 0, displayRect.width, displayRect.height);\n                //draw the background\n                app.drawSpaceBackground(context,displayRect);\n\n                //draw particles\n                var i = 0;\n                for (i = 0; i < particles.length; i++) {\n                    particles[i].draw(context);\n                }\n\n                //draw objects\n                for (i = 0; i < objects.length; i++) {\n                    objects[i].draw(context);\n                }\n\n                if (app.player.alive) {\n                    context.fillStyle = '#FFFFFF';\n                    context.font = \"18px Audiowide\";\n                    context.textAlign = 'left';\n                    context.fillText(\n                        app.strings.score + ' ' + Math.round(app.score) +  '  ' + app.strings.lives + ' ' +  app.player.lives,\n                        5,\n                        displayRect.height - 20\n                    );\n                    context.textAlign = 'center';\n\n                    app.wrapText(context, question, false, 20, displayRect.width * 0.9, displayRect.width / 2, 20);\n                } else {\n                    context.fillStyle = '#FFFFFF';\n                    context.font = \"18px Audiowide\";\n                    context.textAlign = 'center';\n                    context.fillText(\n                        app.strings.endofgame + ' ' + Math.round(app.player.lastScore),\n                        displayRect.width / 2,\n                        displayRect.height / 2\n                    );\n                }\n            },\n\n    /**\n     * Helper function main game logic: process movements and behaviours of game objects\n     * @param {object} bounds\n     * @param {object} objects\n     * @param {object} particles\n     */\n            update: function (bounds, objects, particles) {\n                var i = 0;\n                for (i = 0; i < 3; i++) {\n                    particles.push(new Star(bounds));\n                }\n                for (i = 0; i < particles.length; i++) {\n                    particles[i].update(bounds);\n                    if (!particles[i].alive) {\n                        particles.splice(i, 1);\n                        i--;\n                    }\n                }\n                for (i = 0; i < objects.length; i++) {\n                    objects[i].update(bounds);\n                    for (var j = i + 1; j < objects.length; j++) {\n                        app.collide(objects[i], objects[j]);\n                    }\n                    if (!objects[i].alive) {\n                        objects.splice(i, 1);\n                        i--;\n                    }\n                }\n            },\n\n    /**\n     * Helper function to remove any stray ships on level advance\n     */\n            killAllAlive: function () {\n                app.currentTeam.forEach(function (enemy) {\n                    if (enemy.alive) {\n                        // Make the itempoints 0 so it won't count as anything and make a new level.\n                        enemy.itempoints = 0;\n                        enemy.die();\n                    }\n                });\n                app.currentTeam = [];\n            },\n\n    /**\n     * Helper function to handle collisions between gameobjects.\n     * @param {object} object1\n     * @param {object} object2\n     * @return {boolean}\n     */\n            collide: function (object1, object2) {\n                return object1.alive && object2.alive && (this.collideOrdered(object1, object2) || this.collideOrdered(object2, object1));\n            },\n\n    /**\n     * Helper funcction to handle collisions.\n     * @param {object} object1\n     * @param {object} object2\n     * @returns {boolean}\n     */\n            collideOrdered: function (object1, object2) {\n                if (object1 instanceof Laser && object2 instanceof Player) {\n                    if (!object1.friendly && app.objectsIntersect(object1, object2)) {\n                        object2.gotShot(object1);\n                        object1.die();\n                        return true;\n                    }\n                }\n                if (object1 instanceof Laser && object2 instanceof Enemy) {\n                    if (object1.friendly && app.objectsIntersect(object1, object2)) {\n                        object2.gotShot(object1);\n                        return true;\n                    }\n                }\n                if (object1 instanceof Player && object2 instanceof Enemy) {\n                    if (app.objectsIntersect(object1, object2)) {\n                        object1.die();\n                        return true;\n                    }\n                }\n                return false;\n            },\n\n    /**\n     * Helper function to handle intersections between GameObjects.\n     * @param {object} object1\n     * @param {object} object2\n     * @return {boolean}\n     */\n            objectsIntersect: function (object1, object2) {\n                var rect1 = object1.getRect();\n                var rect2 = object2.getRect();\n                return rect1.Intersect(rect2);\n            },\n\n    /**\n     * Helper function for spraying particle (explosion) effects\n     * @param {int} x\n     * @param {int} y\n     * @param {int} num\n     * @param {string} colour\n     */\n            spray: function (x, y, num, colour) {\n                for (var i = 0; i < num; i++) {\n                    app.particles.push(new Particle(x, y, {\n                        x: (Math.random() - 0.5) * 16,\n                        y: ((Math.random() - 0.5) * 16) + 3\n                    }, colour));\n                }\n            },\n\n    /**\n     * Helper function to display answers.\n     * @param {object} context\n     * @param {string} input\n     * @param {bool} wrapUpwards\n     * @param {int} textHeight\n     * @param {int} maxLineWidth\n     * @param {int} x\n     * @param {int} y\n     */\n            wrapText: function (context, input, wrapUpwards, textHeight, maxLineWidth, x, y) {\n                var drawLines = [];\n                var originalY = y;\n                var words = input.split(' ');\n                var line = '';\n                var maxTextWidth = 0;\n                // Loops through the words, and preprocesses each line with the correct string value and y location.\n                words.forEach(function (word) {\n                    var tempLine = '';\n                    if (line === '') {\n                        tempLine = line + ' ' + word;\n                    } else {\n                        tempLine = line + ' ' + word;\n                    }\n\n                    var metrics = context.measureText(tempLine);\n                    var textWidth = metrics.width;\n                    maxTextWidth = Math.max(maxTextWidth, textWidth);\n\n                    // If the line with the new word is too long, then push the current line without the new word to drawLines.\n                    if (textWidth > maxLineWidth) {\n                        drawLines.push({\n                            text: line,\n                            y: y += textHeight\n                        });\n\n                        line = word;\n                    } else {\n                        // If it's shorter than the limit, just add the word to the line and move on.\n                        line = tempLine;\n                    }\n                });\n\n                // Push the last line, if it exists.\n                drawLines.push({\n                    text: line,\n                    y: y += textHeight\n                });\n\n                // The offset the text was created.\n                var yOffset = y - originalY;\n\n                //box mods\n                var boxPadding = 20;\n                var boxmodifier = wrapUpwards ? -(yOffset + textHeight + boxPadding / 2) : -(textHeight + boxPadding / 2);\n\n                var borderColor = wrapUpwards ? 'transparent' : 'white';\n                app.drawRoundRect(context, borderColor,maxTextWidth + boxPadding, textHeight * drawLines.length + boxPadding, x - (maxTextWidth + boxPadding) / 2, y + boxmodifier);\n\n                context.fillStyle = \"white\";\n                drawLines.forEach(function (drawLine) {\n                    // If it is suppose to wrap upwards (i.e. for enemy ships) it shifts all questions upwards the amount the\n                    // questions go down.\n                    var modifier = wrapUpwards ? -yOffset : 0;\n\n                    context.fillText(drawLine.text, x, drawLine.y + modifier);\n                });\n            },\n\n            drawRoundRect: function (context, borderColor, width, height , x , y) {\n                var cornerRadius = 4;\n                var borderWidth = 4;\n\n                var fillColor = 'rgba(75, 71, 77, 0.5)';\n                //var borderColor = 'red';\n                if (borderColor !== 'white') {\n                        borderColor = fillColor;\n                }\n\n                // Draw the box with border\n                context.fillStyle = fillColor; // Box background color\n                context.fillRect(x,y, width, height); // Draw the box\n                context.strokeStyle = borderColor; // Border color\n                context.lineWidth = borderWidth; // Border width\n                context.strokeRect(x - borderWidth / 2, y - borderWidth  / 2, width + borderWidth, height + borderWidth); // Draw the border\n            },\n\n            drawSpaceBackground: function (context,displayRect) {\n\n                // Set the source of the image (URL of the background image)\n                var img = app.loadedImages['pix/spacegame/space-bckg.png'];\n\n                // Calculate the number of tiles needed to cover the canvas\n                var tilesX = Math.ceil(displayRect.width / img.width);\n                var tilesY = Math.ceil(displayRect.height / img.height);\n\n                // Loop through and draw the image tiles to cover the canvas\n                for (var i = 0; i < tilesX; i++) {\n                    for (var j = 0; j < tilesY; j++) {\n                        context.drawImage(img, i * img.width, j * img.height, img.width, img.height);\n                    }\n                }\n            },\n\n    /**\n     * Helper function for end of level.\n     */\n            shipReachedEnd: function () {\n\n                var amountLeft = app.currentTeam.filter(function (enemy) {\n                    return enemy.alive;\n                }).length;\n\n                if (amountLeft === 0\n                    // && (app.currentPointsLeft < app.itempoints || app.currentPointsLeft <= 0)\n                    && app.player.alive) {\n                    app.nextLevel();\n                }\n            },\n\n    /**\n     * Helper function for game menu from keyboard.\n     * @param {object} e\n     */\n            menukeydown: function (e) {\n                if ([32, 37, 38, 39, 40].indexOf(e.keyCode) !== -1) {\n                    e.preventDefault();\n                    if (e.keyCode === 32) {\n                        app.loadGame();\n                    }\n                }\n            },\n\n    /**\n     * Helper function for game menu on mobile.\n     * @param {object} e\n     */\n            menumousedown: function (e) {\n                if (e.target === app.stage) {\n                    app.loadGame();\n                }\n            },\n\n    /**\n     * Helper function for game menu on mobile.\n     * @param {object} e\n     */\n            menutouchend: function (e) {\n                if (e.target === app.stage) {\n                    app.loadGame();\n                }\n            },\n\n    /**\n     * Helper function for keyboard movement.\n     * @param {object} e\n     */\n            keydown: function (e) {\n                if ([32, 37, 38, 39, 40].indexOf(e.keyCode) !== -1) {\n                    e.preventDefault();\n                    if (e.keyCode === 32 && app.player.alive && app.canShoot) {\n                        app.player.Shoot();\n                    } else if (e.keyCode === 37) {\n                        app.player.direction.x = -1;\n                    } else if (e.keyCode === 38) {\n                        app.player.direction.y = -1;\n                    } else if (e.keyCode === 39) {\n                        app.player.direction.x = 1;\n                    } else if (e.keyCode === 40) {\n                        app.player.direction.y = 1;\n                    }\n                }\n            },\n\n    /**\n     * Helper function for keyboard movement.\n     * @param {object} e\n     */\n            keyup: function (e) {\n                if (e.keyCode === 32) {\n                    app.canShoot = true;\n                } else if ([37, 39].indexOf(e.keyCode) !== -1) {\n                    app.player.direction.x = 0;\n                } else if ([38, 40].indexOf(e.keyCode) !== -1) {\n                    app.player.direction.y = 0;\n                }\n            },\n\n    /**\n     * Helper function for mouse click (starts the player shooting if you clicked on them, moving if you didn't).\n     * @param {object} e\n     */\n            mousedown: function (e) {\n                if (e.target === app.stage) {\n                    var playerWasClicked = app.player.getRect().Contains({x: e.offsetX, y: e.offsetY});\n                    if (playerWasClicked && app.player.alive) {\n                        app.player.Shoot();\n                    }\n                    if (!app.mouseDown) {\n                        app.player.mouse.x = e.offsetX;\n                        app.player.mouse.y = e.offsetY;\n                        app.mouseDown = true;\n                    }\n                }\n            },\n\n    /**\n     * Helper function for mouse release. (stops the Player) for mouse mode\n     */\n            mouseup: function () {\n                app.player.direction.x = 0;\n                app.player.direction.y = 0;\n                app.mouseDown = false;\n            },\n\n    /**\n     * Helper function for mouse movement.\n     * @param {object} e\n     */\n            mousemove: function (e) {\n                app.player.mouse.x = e.offsetX;\n                app.player.mouse.y = e.offsetY;\n            },\n\n    /**\n     * Helper function for cancelled event.\n     * @param {object} event\n     */\n            cancelled: function (event) {\n                if (event.target === app.stage) {\n                    event.preventDefault();\n                }\n            },\n\n    /**\n     * Helper function for movement on mobile touch devices.\n     * @param {object} e\n     */\n            touchstart: function (e) {\n                if (e.target === app.stage) {\n                    if (app.player.alive && e.touches.length > 1) {\n                        app.player.Shoot();\n                    } else {\n                        app.touchDown = true;\n                        app.touchmove(e);\n                    }\n\n                    e.preventDefault();\n                }\n            },\n\n    /**\n     * Helper function for movement on mobile touch devices.\n     * @param {object} e\n     */\n            touchend: function (e) {\n                if (e.touches.length === 0) {\n                    app.touchDown = false;\n                }\n                app.player.direction.x = 0;\n                app.player.direction.y = 0;\n\n                if (e.target === app.stage) {\n                    e.preventDefault();\n                }\n            },\n\n    /**\n     * Helper function for movement on mobile touch devices.\n     * @param {object} e\n     */\n            touchmove: function (e) {\n                var rect = e.target.getBoundingClientRect();\n                // Required for getting the stage's relative touch position, due to a previous significant offset.\n                var x = e.touches[0].pageX - rect.left;\n                var y = e.touches[0].clientY - rect.top;\n\n                window.stage = app.stage;\n                app.player.mouse.x = x;\n                app.player.mouse.y = y - (2 * app.player.image.height);\n\n                if (e.target === app.stage) {\n                    e.preventDefault();\n                }\n            },\n\n    /**\n     * Helper function to shuffle levels.\n     * @param {array} array\n     * @return {array}\n     */\n            shuffle: function (array) {\n                var currentIndex = array.length;\n                var temporaryValue;\n                var randomIndex;\n\n                while (0 !== currentIndex) {\n                    randomIndex = Math.floor(Math.random() * currentIndex);\n                    currentIndex -= 1;\n\n                    temporaryValue = array[currentIndex];\n                    array[currentIndex] = array[randomIndex];\n                    array[randomIndex] = temporaryValue;\n                }\n\n                return array;\n            },\n\n            strip_html: function (htmlstring) {\n                return htmlstring.replace(/<\\/?[^>]+(>|$)/g, \"\");\n            },\n\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            split_array: function (array, chunkSize) {\n                if (chunkSize == null) {\n                    chunkSize = 4};\n                var result = [];\n                var currentIndex = 0;\n\n                while (currentIndex < array.length) {\n                    const chunk = array.slice(currentIndex, currentIndex + chunkSize);\n                    if (chunk.length < chunkSize) {\n                        const remaining = chunkSize - chunk.length;\n                        // Reuse elements from previous chunks\n                        for (var i = 0; i < remaining; i++) {\n                            chunk.push(array[i]);\n                        }\n                    }\n                    result.push(chunk);\n                    currentIndex += chunkSize;\n                }\n\n                return result;\n            },\n\n            shuffle_array: function (array) {\n                for (let i = array.length - 1; i > 0; i--) {\n                    const j = Math.floor(Math.random() * (i + 1));\n                    [array[i], array[j]] = [array[j], array[i]];\n                }\n            },\n\n            calc_total_points: function (results) {\n                var total = 0;\n                $.each(results, function (i, o) {\n                    if (o.points != undefined) {\n                        total += o.points;\n                    }\n                });\n                return total;\n            },\n\n            pretty_print_secs: function (time) {\n                var minutes = Math.floor(time / 60);\n                var seconds = time - minutes * 60;\n                return app.str_pad_left(minutes, '0', 2) + ':' + app.str_pad_left(seconds, '0', 2);\n            },\n\n            str_pad_left: function (string, pad, length) {\n                return (new Array(length + 1).join(pad) + string).slice(-length);\n            },\n\n            init_strings: function () {\n\n                str.get_strings([\n                  { \"key\": \"shootthepairs\", \"component\": 'mod_minilesson'},\n                  { \"key\": \"emptyquiz\", \"component\": 'mod_minilesson'},\n                  { \"key\": \"score\", \"component\": 'mod_minilesson'},\n                  { \"key\": \"lives\", \"component\": 'mod_minilesson'},\n                  { \"key\": \"spacetostart\", \"component\": 'mod_minilesson'},\n\n                ]).done(function (s) {\n                    var i = 0;\n                    app.strings.shootthepairs = s[i++];\n                    app.strings.emptyquiz = s[i++];\n                    app.strings.score = s[i++];\n                    app.strings.lives = s[i++];\n                    app.strings.spacetostart = s[i++];\n                });\n            },\n\n            reset: function () {\n                clearInterval(app.interval);\n                clearInterval(app.timer.interval);\n                //clear event handlers (they will be added again in start)\n                // The full screen toggle listeners\n                if (document.removeEventListener) {\n                    document.removeEventListener('fullscreenchange', app.fschange, false);\n                    document.removeEventListener('MSFullscreenChange', app.fschange, false);\n                    document.removeEventListener('mozfullscreenchange', app.fschange, false);\n                    document.removeEventListener('webkitfullscreenchange', app.fschange, false);\n                }\n                // Full screen toggle button handler.\n                $('#mod_minilesson_spacegame_fullscreen_button').off('click');\n\n\n                $(\"#results-inner\").html('');\n                app.questions = [];\n                app.terms = [];\n                app.results = [];\n                app.score = 0;\n                app.gameObjects = [];\n                app.particles = [];\n                app.player = null;\n                app.planet = null;\n                app.loaded = false;\n                app.process();\n            },\n\n            process: function () {\n                var terms = app.itemdata.spacegameitems.map(function (item,index) {\n                    var theitem = JSON.parse(item);\n                    theitem.id = index;\n                    return theitem;\n                });\n                var multichoice_alien_chunksize = app.itemdata.aliencountmultichoice;\n                var matching_alien_chunksize = app.itemdata.aliencountmatching;\n                var include_matching_questions = app.itemdata.includematching;\n                app.terms = terms;\n                app.allowretry = app.itemdata.allowretry;\n                app.shuffle_array(terms);\n\n                // Multichoice questions.\n                // Split into groups(ie \"levels\") of 5 terms (a single of mc of more than 5 terms is too much).\n                var chunkSize = multichoice_alien_chunksize;\n                if (terms.length < chunkSize) {\n                    chunkSize = terms.length;}\n                var mc_levels = app.split_array(terms, chunkSize);\n                // For each level build a set of chunksize questions with 1 correct and chunksize -1  distractors.\n                for (var thelevel = 0; thelevel < mc_levels.length; thelevel++) {\n                    var level = mc_levels[thelevel];\n                    // Multiple choice questions.\n                    for (var i = 0; i < level.length; i++) {\n                        var answers = [];\n                        for (var j = 0; j < level.length; j++) {\n                            var answertext = app.strip_html(level[j].definition);\n\n                            if (app.sgoptions === app.termAsAlien) {\n                                answertext = level[j].term;\n                            }\n                            answers.push({\"text\": answertext,\"itempoints\": (i === j ? 1 : 0)});\n                        }\n                        var questiontext = level[i].term;\n                        if (app.sgoptions === app.termAsAlien) {\n                            questiontext = app.strip_html(level[i].definition);\n                        }\n                        app.questions.push({\n                            \"question\": questiontext,\n                            \"termid\": level[i].id,\n                            \"answers\": answers,\n                            \"type\": \"multichoice\",\n                            \"single\": true\n                        });\n                    }\n                }\n\n                // Matching questions.\n                if (include_matching_questions == 1) {\n                    // Split into groups(ie \"levels\") of 3 terms (even 4 terms = 8 items to shoot, its quite hard).\n                    chunkSize = matching_alien_chunksize;\n                    if (terms.length < chunkSize) {\n                        chunkSize = terms.length;}\n                    var matching_levels = app.split_array(terms, chunkSize);\n                    for (var thelevel = 0; thelevel < matching_levels.length; thelevel++) {\n                        var level = matching_levels[thelevel];\n                        var subquestions = [];\n                        for (var i = 0; i < level.length; i++) {\n                            subquestions.push({question: level[i].term, answer: app.strip_html(level[i].definition),\"termid\": level[i].id});\n                        }\n                        // Show a --- in place of a real question, so the user knows its a matching question.\n                        app.questions.push({\"question\": app.strings.shootthepairs, \"stems\": subquestions, \"type\": \"matching\"});\n                    }\n                }\n                console.log(\"After process:\", app.questions);\n            },\n\n            init_controls: function () {\n                app.controls.gameboard = $(\"#minilesson-gameboard\");\n                app.controls.time_counter = $(\"#minilesson-time-counter\");\n            },\n\n    /**\n     * Helper function to display game start screen\n     */\n            showMenu: function () {\n\n                app.context.clearRect(0, 0, app.displayRect.width, app.displayRect.height);\n\n                app.context.fillStyle = '#FFFFFF';\n                app.context.font = \"18px Audiowide\";\n                app.context.textAlign = 'center';\n\n                if (app.questions !== null && app.questions.length > 0) {\n                    app.context.fillText(app.strings.spacetostart, app.displayRect.width / 2, app.displayRect.height / 2);\n                    app.menuEvents();\n                } else {\n                    app.context.fillText(app.strings.emptyquiz, app.displayRect.width / 2, app.displayRect.height / 2);\n                }\n                // If we are height 0 then we are in a collapsed state\n                // We call our orientation change function to fix this\n                if (app.stage.height == 0) {\n                    app.orientationChange();\n                }\n            },\n\n            start: function () {\n                // Hide the intro screen with word cards.\n                app.results = [];\n                app.controls.gameboard.show();\n                app.controls.time_counter.text(\"00:00\");\n\n                app.timer = {\n                    interval: setInterval(function () {\n                        app.timer.update();\n                    }, 1000),\n                count: 0,\n                update: function () {\n                    app.timer.count++;\n                   // app.controls.time_counter.text('zerozero');\n                }\n                }\n\n                // Begin the game screen.\n                if (document.addEventListener) {\n                    document.addEventListener('fullscreenchange', app.fschange, false);\n                    document.addEventListener('MSFullscreenChange', app.fschange, false);\n                    document.addEventListener('mozfullscreenchange', app.fschange, false);\n                    document.addEventListener('webkitfullscreenchange', app.fschange, false);\n                }\n                app.stage = document.getElementById(\"mod_minilesson_spacegame\");\n                app.context = app.stage.getContext(\"2d\");\n                app.smallscreen();\n                app.interval = setInterval(function () {\n                    if (app.questions && app.questions.length > 0) {\n                        app.showMenu();\n                    } else {\n                        console.log(\"Questions are not ready or empty.\");\n                    }\n                }, 500);\n\n                // Full screen toggle button handler.\n                $('#mod_minilesson_spacegame_fullscreen_button').on('click', function () {\n                    if (app.inFullscreen) {\n                        app.inFullscreen = false;\n                        app.smallscreen();\n                    } else {\n                        app.fullscreen();\n                    }\n                });\n            },\n\n            next_question: function () {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.totalitems = app.questions.length;\n                var totalcorrect = app.calc_total_points(app.results);\n                //remove any decimal (leave one decimal place)\n                stepdata.correctitems = Math.round(totalcorrect * 10) / 10;\n                stepdata.grade = Math.round(100 * (stepdata.correctitems / stepdata.totalitems));\n                self.quizhelper.do_next(stepdata);\n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n                app.index = index;\n                app.quizhelper = quizhelper;\n                var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n                var clickbutton = $(\"#\" + itemdata.uniqueid + \"_container .ml_sg_clickclick\");\n\n                nextbutton.on('click', function (e) {\n                    app.next_question(0);\n                });\n\n                clickbutton.on('click', function (e) {\n                    app.start();\n                });\n\n                $('body').on('click', \"#minilesson-try-again\", function () {\n                    //location.reload();\n                    app.reset();\n                    app.start();\n                });\n\n                $('body').on('click', \"#minilesson-close-results\", function () {\n                    var total_time = app.timer.count;\n                    var url = app.nexturl.replace(/&amp;/g, '&') + \"&localscattertime=\" + total_time\n                    window.location.replace(url);\n                });\n            },\n\n    /**\n     * Initialization of the game.\n     * @param {array} props\n     */\n            init: function (index, itemdata, quizhelper) {\n                log.debug('MiniLesson Space Game: init function');\n                app.itemdata = itemdata;\n                app.init_strings();\n                app.register_events(index, itemdata, quizhelper);\n                app.init_controls();\n                app.process();\n                app.start();\n            },\n        }; // End of app declaration.\n\n        return app;\n    }\n);"],"names":["define","$","notification","def","log","templates","Ajax","str","debug","Rectangle","constructor","left","top","width","height","right","this","bottom","Contains","point","x","y","Intersect","rectangle","GameObject","src","image","loadImage","velocity","direction","movespeed","alive","decay","Image","M","cfg","wwwroot","update","draw","context","drawImage","getRect","die","Player","mouse","lives","lastScore","bounds","app","mouseDown","touchDown","player","Shoot","playSound","gameObjects","unshift","Laser","canShoot","spray","score","endGame","gotShot","shot","Planet","displayRect","Enemy","text","itempoints","termid","xspeed","enemySpeed","yspeed","Math","random","movementClock","shotFrequency","shotClock","level","floor","laser","friendly","currentPointsLeft","shipReachedEnd","call","fillStyle","font","textAlign","wrapText","reportSuccess","shooter","laserSpeed","deflect","Particle","colour","aliveTime","fillRect","stroke","Star","MultiEnemy","single","shipsize","storeResult","killAllAlive","nextLevel","MatchEnemy","pairid","stem","hightlighted","lastShot","alives","currentTeam","forEach","match","hightlight","unhightlight","isFreeMode","strings","termAsAlien","questions","quizgame","stage","particles","images","imagesLoaded","loadedImages","loaded","planet","question","interval","inFullscreen","dryRun","ttslanguage","distractors","controls","results","timer","registerSpaceGameEvents","document","onkeyup","keyup","onkeydown","keydown","onmouseup","mouseup","onmousedown","mousedown","onmousemove","mousemove","ontouchstart","touchstart","ontouchend","touchend","addEventListener","touchmove","passive","window","onresize","orientationChange","cancelled","soundName","getElementById","checked","soundElement","currentTime","play","smallscreen","fullscreenElement","exitFullscreen","exitPromise","Promise","then","console","catch","err","error","webkitExitFullscreen","msExitFullscreen","removeAttribute","classList","remove","removeClass","clientWidth","clientHeight","style","sizeScreen","fschange","fullscreen","landscape","matchMedia","matches","requestFullscreen","msRequestFullscreen","mozRequestFullScreen","e","buttonContainer","innerWidth","add","addClass","blur","imageSmoothingEnabled","clearEvents","ontouchmove","points","theterm","terms","aterm","id","result","strip_html","selected","correct","i","length","splice","push","reportFailure","term1id","term2id","menuEvents","menukeydown","menumousedown","menutouchend","loadGame","shuffle","startGame","absolute_src","onload","gameLoaded","clearInterval","hide","show","tdata","allowretry","nexturl","totalcorrect","calc_total_points","round","total_time","count","pretty_print_secs","render","html","js","setInterval","runLevel","type","stems","answer","answers","enemy","objects","clearRect","drawSpaceBackground","fillText","endofgame","j","collide","object1","object2","collideOrdered","objectsIntersect","rect1","rect2","num","input","wrapUpwards","textHeight","maxLineWidth","drawLines","originalY","words","split","line","maxTextWidth","word","tempLine","textWidth","measureText","max","yOffset","boxmodifier","boxPadding","borderColor","drawRoundRect","drawLine","modifier","strokeStyle","lineWidth","strokeRect","borderWidth","img","tilesX","ceil","tilesY","filter","indexOf","keyCode","preventDefault","target","offsetX","offsetY","event","touches","rect","getBoundingClientRect","pageX","clientY","array","temporaryValue","randomIndex","currentIndex","htmlstring","replace","clone","extend","split_array","chunkSize","chunk","slice","remaining","shuffle_array","total","each","o","undefined","time","minutes","seconds","str_pad_left","string","pad","Array","join","init_strings","get_strings","done","s","shootthepairs","emptyquiz","spacetostart","reset","removeEventListener","off","process","itemdata","spacegameitems","map","item","index","theitem","JSON","parse","multichoice_alien_chunksize","aliencountmultichoice","matching_alien_chunksize","aliencountmatching","include_matching_questions","includematching","mc_levels","thelevel","answertext","definition","sgoptions","term","questiontext","matching_levels","subquestions","init_controls","gameboard","time_counter","showMenu","start","getContext","on","next_question","stepdata","hasgrade","totalitems","correctitems","grade","quizhelper","do_next","register_events","nextbutton","uniqueid","clickbutton","url","location","init"],"mappings":";;;;;;;AAwBAA,kCACI,CAAC,SAAU,oBAAqB,6BAA8B,WAAY,iBAAkB,YAAa,aACzG,SAAUC,EAAGC,aAAcC,IAAKC,IAAKC,UAAWC,KAAMC,KAQlDH,IAAII,MAAM,6CAEJC,UAQFC,YAAYC,KAAMC,IAAKC,MAAOC,aAErBH,KAAOA,MAAQ,OACfC,IAAMA,KAAO,OACbC,MAAQA,OAAS,OACjBC,OAASA,QAAU,EAG5BC,eAEWC,KAAKL,KAAOK,KAAKH,MAG5BI,gBAEWD,KAAKJ,IAAMI,KAAKF,OAG3BI,SAASC,cAEEA,MAAMC,EAAIJ,KAAKL,MACtBQ,MAAMC,EAAIJ,KAAKD,SACfI,MAAME,EAAIL,KAAKJ,KACfO,MAAME,EAAIL,KAAKC,SAGnBK,UAAUC,mBAESA,UAAUZ,KAAOK,KAAKD,SACrCQ,UAAUR,QAAUC,KAAKL,MACzBY,UAAUX,IAAMI,KAAKC,UACrBM,UAAUN,SAAWD,KAAKJ,YAI5BY,WAOFd,YAAYe,IAAKL,EAAGC,GAEJ,OAARI,WACKC,MAAQV,KAAKW,UAAUF,WAE3BL,EAAIA,OACJC,EAAIA,OACJO,SAAW,CAACR,EAAG,EAAGC,EAAG,QACrBQ,UAAY,CAACT,EAAG,EAAGC,EAAG,QACtBS,UAAY,CAACV,EAAG,EAAGC,EAAG,QACtBU,OAAQ,OACRC,MAAQ,GAGjBL,UAAUF,YAEDT,KAAKU,aACDA,MAAQ,IAAIO,YAGhBP,MAAMD,IAAMS,EAAEC,IAAIC,QAAU,mBAAqBX,IAC/CT,KAAKU,MAGhBW,cAEST,SAASR,GAAKJ,KAAKa,UAAUT,EAAIJ,KAAKc,UAAUV,OAChDQ,SAASP,GAAKL,KAAKa,UAAUR,EAAIL,KAAKc,UAAUT,OAChDD,GAAKJ,KAAKY,SAASR,OACnBC,GAAKL,KAAKY,SAASP,OACnBO,SAASP,GAAKL,KAAKgB,WACnBJ,SAASR,GAAKJ,KAAKgB,MAG5BM,KAAKC,SAEDA,QAAQC,UAAUxB,KAAKU,MAAOV,KAAKI,EAAGJ,KAAKK,EAAGL,KAAKU,MAAMb,MAAOG,KAAKU,MAAMZ,QAG/E2B,iBAEW,IAAIhC,UAAUO,KAAKI,EAAGJ,KAAKK,EAAGL,KAAKU,MAAMb,MAAOG,KAAKU,MAAMZ,QAGtE4B,WAESX,OAAQ,SAOfY,eAAenB,WAOjBd,YAAYe,IAAKL,EAAGC,SAEVI,IAAKL,EAAGC,QACTuB,MAAQ,CAACxB,EAAG,EAAGC,EAAG,QAClBS,UAAY,CAACV,EAAG,EAAGC,EAAG,QACtBwB,MAAQ,OACRC,UAAY,EAGrBT,OAAOU,SAECC,IAAIC,WAAaD,IAAIE,aACjBlC,KAAKI,EAAIJ,KAAK4B,MAAMxB,EAAKJ,KAAKU,MAAMb,MACpCmC,IAAIG,OAAOtB,UAAUT,EAAI,EAClBJ,KAAKI,EAAIJ,KAAK4B,MAAMxB,EAC3B4B,IAAIG,OAAOtB,UAAUT,GAAK,EAE1B4B,IAAIG,OAAOtB,UAAUT,EAAI,EAEzBJ,KAAKK,EAAIL,KAAK4B,MAAMvB,EAAKL,KAAKU,MAAMZ,OACpCkC,IAAIG,OAAOtB,UAAUR,EAAI,EAClBL,KAAKK,EAAIL,KAAK4B,MAAMvB,EAC3B2B,IAAIG,OAAOtB,UAAUR,GAAK,EAE1B2B,IAAIG,OAAOtB,UAAUR,EAAI,SAG3BgB,OAAOU,QAET/B,KAAKI,EAAI2B,OAAO3B,EAAIJ,KAAKU,MAAMb,WAC1BO,EAAI2B,OAAOlC,MACTG,KAAKI,EAAI2B,OAAOlC,aAClBO,EAAI2B,OAAO3B,EAAIJ,KAAKU,MAAMb,OAE/BG,KAAKK,EAAI0B,OAAO1B,OACXA,EAAI0B,OAAO1B,EACTL,KAAKK,EAAI0B,OAAOjC,OAASE,KAAKU,MAAMZ,cACtCO,EAAI0B,OAAOjC,OAASE,KAAKU,MAAMZ,QAI5CsC,QAEIJ,IAAIK,UAAU,SAEdL,IAAIM,YAAYC,QAAQ,IAAIC,MAAMR,IAAIG,OAAO/B,EAAG4B,IAAIG,OAAO9B,EAD7CL,MACwD,EAAM,KAC5EgC,IAAIS,UAAW,EAGnBf,YAEUA,MACNM,IAAIK,UAAU,aACdL,IAAIU,MAAM1C,KAAKI,EAAIJ,KAAKU,MAAMb,MAAQ,EAAGG,KAAKK,EAAIL,KAAKU,MAAMZ,OAAS,EAAG,IAAK,gBACzEgC,UAAYE,IAAIW,MACrBX,IAAIY,UAGRC,QAAQC,MAEAA,KAAK/B,QACDf,KAAK6B,OAAS,OACTH,YAEAG,QACLG,IAAIU,MAAM1C,KAAKI,EAAIJ,KAAKU,MAAMb,MAAQ,EAAGG,KAAKK,EAAIL,KAAKU,MAAMZ,OAAS,EAAG,IAAK,oBAOxFiD,eAAevC,WAOjBd,YAAYe,IAAKL,EAAGC,SAEVI,IAAIL,EAAEC,GAGhBgB,OAAOU,aAEErB,MAAMb,MAAQmC,IAAIgB,YAAYnD,WAC9Ba,MAAMZ,OAASkC,IAAIgB,YAAYlD,aAC9BuB,gBAMR4B,cAAczC,WAChBd,YAAYe,IAAKL,EAAGC,EAAG6C,KAAMC,WAAYC,cAE/B3C,IAAIL,EAAEC,QACPgD,OAASrB,IAAIsB,gBACbC,OAASvB,IAAIsB,YAAc,EAAIE,KAAKC,UAAY,OAChD3C,UAAUV,EAAI,OACdU,UAAUT,EAAI,OACdQ,UAAUR,EAAI,OACd6C,KAAOA,UACPC,WAAaA,gBACbO,cAAgB,OAChBC,cAAgB,QAChBC,WAAa,EAAIJ,KAAKC,UAAYzD,KAAK2D,mBACvCE,MAAQ7B,IAAI6B,WACZT,OAASA,OAIlB/B,OAAOU,WAEC/B,KAAKK,EAAI0B,OAAOjC,OAAS,IAAME,KAAKK,EAAoB,EAAhB0B,OAAOjC,OAAa,SACvDgB,UAAUV,EAAkB,EAAdJ,KAAKqD,YACnBvC,UAAUT,EAAkB,EAAdL,KAAKuD,cAEnBzC,UAAUV,EAAIJ,KAAKqD,YACnBvC,UAAUT,EAAIL,KAAKuD,cAGtBlC,OAAOU,aAER2B,qBACAA,gBAED1D,KAAK0D,eAAiB,SACjB7C,UAAUT,EAAIoD,KAAKM,MAAsB,EAAhBN,KAAKC,UAAgB,OAC9CC,cAAsC,IAArB,EAAIF,KAAKC,gBAG9BG,WAAa5B,IAAIsB,WAElBtD,KAAK4D,WAAa,GACd5D,KAAKK,EAAoB,GAAhB0B,OAAOjC,OAAc,CAC9BkC,IAAIK,UAAU,kBAEV0B,MAAQ,IAAIvB,MAAMxC,KAAKI,EAAGJ,KAAKK,EADrBL,MAEd+D,MAAMlD,UAAUR,EAAI,EACpB0D,MAAMC,UAAW,EACjBhC,IAAIM,YAAYC,QAAQwB,YACnBH,WAAa,EAAIJ,KAAKC,UAAYzD,KAAK2D,cAIhD3D,KAAKI,EAAI2B,OAAO3B,EAAIJ,KAAKU,MAAMb,WAC1BO,EAAI2B,OAAOlC,MACTG,KAAKI,EAAI2B,OAAOlC,aAClBO,EAAI2B,OAAO3B,EAAIJ,KAAKU,MAAMb,OAE/BG,KAAKK,EAAI0B,OAAOjC,OAASE,KAAKU,MAAMZ,QAAUE,KAAKe,aAC9CA,OAAQ,EACTf,KAAKmD,WAAa,IAClBnB,IAAIiC,mBAAqBjE,KAAKmD,WAC9BnB,IAAIW,OAAS,IAAO3C,KAAKmD,YAG7BnB,IAAIkC,eAAeC,KAAKnE,OAIhCsB,KAAKC,eAGKD,KAAKC,SACXA,QAAQ6C,UAAY,UACpB7C,QAAQ8C,KAAO,iBACf9C,QAAQ+C,UAAY,SAEpBtC,IAAIuC,SAAShD,QAASvB,KAAKkD,MAAM,EAAM,GAA4B,GAAxBlB,IAAIgB,YAAYnD,MAAaG,KAAKI,EAAIJ,KAAKU,MAAMb,MAAQ,EAAGG,KAAKK,EAAI,GAGpHqB,YAEUA,MACNM,IAAIU,MAAM1C,KAAKI,EAAIJ,KAAKU,MAAMb,MAAOG,KAAKK,EAAIL,KAAKU,MAAMZ,OAAQ,GAAwB,IAAlBE,KAAKmD,WAAmB,WAG/FnB,IAAIW,OAA2B,IAAlB3C,KAAKmD,WAGlBnB,IAAIwC,cAAcxE,KAAKoD,QAGvBpB,IAAIK,UAAU,aAGlBQ,QAAQC,MAGJA,KAAKpB,WACAA,aAMPc,cAAchC,WAChBd,YAAYU,EAAGC,EAAGoE,QAAST,SAAUU,kBAG3BV,SAAW,0BAA4B,+BAAgC5D,EAAGC,QAC3ED,EAAIJ,KAAKI,GAAMqE,QAAQ/D,MAAMb,MAAQG,KAAKU,MAAMb,OAAS,OACzDgB,UAAUR,GAAK,OACf2D,SAAWA,SAAW,EAAI,OAC1BU,WAAaA,YAAc,GAGpCrD,OAAOU,cAEGV,OAAOU,SACT/B,KAAKI,EAAI2B,OAAO3B,EAAIJ,KAAKU,MAAMb,OACnCG,KAAKI,EAAI2B,OAAOlC,OAChBG,KAAKK,EAAI0B,OAAO1B,EAAIL,KAAKU,MAAMZ,QAC/BE,KAAKK,EAAI0B,OAAOjC,eACPiB,OAAQ,QAEZH,SAASP,EAAIL,KAAK0E,WAAa1E,KAAKa,UAAUR,EAGvDsE,eAESjE,MAAQV,KAAKW,UAAU,qCACvBE,UAAUR,IAAM,OAChB2D,UAAYhE,KAAKgE,SACtBhC,IAAIK,UAAU,kBAIhBuC,iBAAiBpE,WACnBd,YAAYU,EAAGC,EAAGO,SAAUiE,cAElB,KAAMzE,EAAGC,QACVR,MAAQ,OACRC,OAAS,OACTc,SAASR,EAAIQ,SAASR,OACtBQ,SAASP,EAAIO,SAASP,OACtByE,UAAY,OACZD,OAASA,YACT7D,MAAQ,EAGjBK,OAAOU,cAEGV,OAAOU,SACT/B,KAAKI,EAAI2B,OAAO3B,EAAIJ,KAAKH,OAC7BG,KAAKI,EAAI2B,OAAOlC,OAChBG,KAAKK,EAAI0B,OAAO1B,EAAIL,KAAKF,QACzBE,KAAKK,EAAI0B,OAAOjC,eACPiB,OAAQ,QAEZ+D,YACD9E,KAAK8E,UAA6B,GAAhBtB,KAAKC,SAAiB,SACnC1C,OAAQ,GAIrBU,iBAEW,IAAIhC,UAAUO,KAAKI,EAAGJ,KAAKK,EAAGL,KAAKH,MAAOG,KAAKF,QAG1DwB,KAAKC,SAEDA,QAAQ6C,UAAYpE,KAAK6E,OACzBtD,QAAQwD,SAAS/E,KAAKI,EAAGJ,KAAKK,EAAGL,KAAKH,MAAOG,KAAKF,QAClDyB,QAAQyD,gBAKVC,aAAazE,WACfd,YAAYqC,cAEF,KAAMyB,KAAKC,SAAW1B,OAAOlC,MAAO,QACrCA,MAAQ,OACRC,OAAS,OACTe,UAAUR,EAAI,OACdS,UAAUT,EAAI,GAAOmD,KAAKC,SAAW,OACrCqB,UAAY,EAGrBzD,OAAOU,cAEGV,OAAOU,QACT/B,KAAKK,EAAI0B,OAAOjC,cACXiB,OAAQ,GAIrBO,KAAKC,SAEDA,QAAQ6C,UAAY,UACpB7C,QAAQwD,SAAS/E,KAAKI,EAAGJ,KAAKK,EAAGL,KAAKH,MAAOG,KAAKF,QAClDyB,QAAQyD,gBAaVE,mBAAmBjC,MACrBvD,YAAYU,EAAGC,EAAG6C,KAAMC,WAAYgC,OAAO/B,cAEjC,mCAAqCpB,IAAIoD,SAAW,OAAQhF,EAAGC,EAAG6C,KAAMC,WAAYC,aACrF+B,OAASA,OAGlBzD,YAEUA,MACF1B,KAAKmD,WAAa,IAClBnB,IAAIiC,mBAAqBjE,KAAKmD,YAGlCnB,IAAIqD,YAAYrF,KAAKoD,OAAQpD,KAAKmD,aAC7BnD,KAAKmF,QAA8B,IAApBnF,KAAKmD,YAAqBnD,KAAKmD,YAAc,GAAMnD,KAAKmD,WAAa,GAAKnB,IAAIiC,mBAAqB,KACnHjC,IAAIsD,eACJtD,IAAIuD,aAIZ1C,QAAQC,MAEA9C,KAAKmD,WAAa,GAClBL,KAAKpB,WACAA,MAGLM,IAAIwC,cAAcxE,KAAKoD,UAEvBpB,IAAIW,OAAmC,KAAzB3C,KAAKmD,WAAa,IAGhCnB,IAAIqD,YAAYrF,KAAKoD,OAAQ,GAE7BN,KAAK6B,kBAMXa,mBAAmBvC,MACrBvD,YAAYU,EAAGC,EAAG6C,KAAMC,WAAYsC,OAAQC,KAAMtC,cAIpC,kCAAoCpB,IAAIoD,SAAW,OAAQhF,EAAGC,EAAG6C,KAAMC,WAAYC,aAKxFsC,OAAOA,UACPD,OAASA,YACT9B,cAAgB,SAChBgC,cAAe,EAGxBjE,MAEIM,IAAIiC,mBAAqBjE,KAAKmD,gBAEzBA,WAAa,QACZzB,MAIVmB,QAAQC,SAEAA,KAAK/B,OAASf,KAAKe,SACfiB,IAAI4D,WAAa5F,KAAKyF,OAAQ,CAG9BzD,IAAIW,OAA2B,IAAlB3C,KAAKmD,WAAoB,EAGtCnB,IAAIqD,YAAYrF,KAAKoD,OAAQpD,KAAKmD,YAGlCnB,IAAIwC,cAAcxE,KAAKoD,QAGvBN,KAAKpB,WACAA,UACDmE,OAAS,EACb7D,IAAI8D,YAAYC,SAAQ,SAAUC,OAC1BA,MAAMP,QAAUzD,IAAI4D,UACpBI,MAAMtE,MAENsE,MAAMjF,OACN8E,YAIJA,QAAU,GACV7D,IAAIuD,iBAGJvD,IAAI4D,UAAY5F,KAAKyF,OACrB3C,KAAK6B,WAEL7B,KAAKpB,WACAuE,aACLjE,IAAI4D,SAAW5F,KAAKyF,QAMpCQ,aAEIjE,IAAI8D,YAAYC,SAAQ,SAAUC,OAC9BA,MAAME,kBAENlG,KAAK0F,UACA/E,UAAU,iCAAmCqB,IAAIoD,SAAW,aAIhEO,cAAe,EAGxBO,eAEQlG,KAAK2F,eACD3F,KAAK0F,UACA/E,UAAU,kCAAoCqB,IAAIoD,SAAW,cAKrEO,cAAe,OAKxB3D,IAAM,CACNmE,YAAa,EACbC,QAAS,eAAkB,mBAC3BC,YAAa,IACbC,UAAW,GACXC,SAAU,KACVC,MAAO,KACP7D,MAAO,EACP8D,UAAW,GACXnE,YAAa,GACb8C,SAAU,KACVsB,OAAQ,CACJ,yBACA,2BACA,yBACA,mCACA,wCACA,yCACA,uCACA,mCACA,wCACA,yCACA,uCACA,+BACA,0BACA,8BACA,gCACA,sCACA,wCACA,0BACA,gCAEJC,aAAe,EACfC,aAAa,GACbC,QAAQ,EACR1E,OAAQ,KACR2E,OAAQ,KACRjD,OAAQ,EACRb,YAAa,CAAC5C,EAAG,EAAGC,EAAG,EAAGR,MAAO,EAAGC,OAAQ,GAC5CiH,SAAU,GACVC,SAAU,KACV1D,WAAY,KACZpB,WAAW,EACXD,WAAW,EACX6D,YAAa,GACbF,SAAU,EACV3B,kBAAoB,EACpB1C,QAAS,KACT0F,cAAc,EACdxE,UAAU,EACVyE,QAAQ,EACRC,YAAa,QACbC,YAAa,GACbC,SAAU,GACVC,QAAS,GACTC,MAAO,KAIPC,wBAAyB,WAErBC,SAASC,QAAU1H,KAAK2H,MACxBF,SAASG,UAAY5H,KAAK6H,QAC1BJ,SAASK,UAAY9H,KAAK+H,QAC1BN,SAASO,YAAchI,KAAKiI,UAC5BR,SAASS,YAAclI,KAAKmI,UAC5BV,SAASW,aAAepI,KAAKqI,WAC7BZ,SAASa,WAAatI,KAAKuI,SAC3Bd,SAASe,iBAAiB,YAAYxI,KAAKyI,UAAW,CAACC,SAAS,IAChEC,OAAOC,SAAW5I,KAAK6I,kBAEvBpB,SAASe,iBAAiB,eAAgBxI,KAAK8I,WAAW,GAC1DrB,SAASe,iBAAiB,gBAAiBxI,KAAK8I,WAAW,GAC3DrB,SAASe,iBAAiB,aAAcxI,KAAK8I,WAAW,IAO5DzG,UAAW,SAAU0G,cACbtB,SAASuB,eAAe,qCAAqCC,QAAS,KAClEC,aAAezB,SAASuB,eAAe,wBAA0BD,WACrEG,aAAaC,YAAc,EAC3BD,aAAaE,SAOrBC,YAAa,cACTrH,IAAIiF,cAAe,EAEfQ,SAAS6B,qBACL7B,SAAS8B,eAAgB,KACrBC,YAAc/B,SAAS8B,iBACvBC,uBAAuBC,QACvBD,YAAYE,MAAK,IAAMC,QAAQvK,IAAI,2CAC/BwK,OAAOC,KAAQF,QAAQG,MAAMD,OAEjCF,QAAQvK,IAAI,8CAETqI,SAASsC,sBAChBtC,SAASsC,uBACTJ,QAAQvK,IAAI,mDACLqI,SAASuC,kBAChBvC,SAASuC,mBACTL,QAAQvK,IAAI,+CAEZuK,QAAQG,MAAM,yDAGlBH,QAAQvK,IAAI,sCAGhB4C,IAAIwE,MAAMyD,gBAAgB,SAC1BjI,IAAIwE,MAAMyD,gBAAgB,UAC1BjI,IAAIwE,MAAMyD,gBAAgB,SAE1BjI,IAAIwE,MAAM0D,UAAUC,OAAO,wBAC3BlL,EAAE,qBAAqBmL,YAAY,0CAEnCpI,IAAIgB,YAAYnD,MAAQmC,IAAIwE,MAAM6D,YAClCrI,IAAIgB,YAAYlD,OAASkC,IAAIwE,MAAM8D,aACnCtI,IAAIwE,MAAM+D,MAAM1K,MAAQmC,IAAIgB,YAAYnD,MACxCmC,IAAIwE,MAAM+D,MAAMzK,OAASkC,IAAIgB,YAAYlD,OACzCkC,IAAIwI,WAAWxI,IAAIwE,QAMvBiE,SAAU,WACFzK,KAAKiH,cACLjF,IAAIqH,eAOZqB,WAAY,eACJC,UAAYhC,OAAOiC,WAAW,4BAA4BC,YAEtD7I,IAAIwE,MAAMsE,kBACV9I,IAAIwE,MAAMsE,oBACH9I,IAAIwE,MAAMuE,oBACjB/I,IAAIwE,MAAMuE,sBACH/I,IAAIwE,MAAMwE,qBACjBhJ,IAAIwE,MAAMwE,uBAEVrB,QAAQG,MAAM,mDAEpB,MAAOmB,GACL7L,IAAII,MAAMyL,EAAG,sBAKjBjJ,IAAIiF,cAAe,MACfiE,gBAAkBjM,EAAE,qBAEpBY,MAAQ8I,OAAOwC,WAIfrL,OAASb,EAAE0J,QAAQ7I,SAGnB6K,WAAa9K,MAAQC,SACrBA,OAAS,CAACD,MAAOA,MAAQC,QAAQ,IAKrCA,QAAUoL,gBAAgBpL,SAAW,GAErCkC,IAAIgB,YAAYnD,MAAQA,MACxBmC,IAAIgB,YAAYlD,OAASA,OAEzBkC,IAAIwE,MAAM+D,MAAM1K,MAAQA,MAAQ,KAChCmC,IAAIwE,MAAM+D,MAAMzK,OAASA,OAAS,KAGlCkC,IAAIwE,MAAM0D,UAAUkB,IAAI,wBAGxBF,gBAAgBG,SAAS,0CAEzBpM,EAAE,+CAA+CqM,OAEjDtJ,IAAIwI,WAAWxI,IAAIwE,QAOvBgE,WAAY,SAAUhE,OAElBA,MAAM3G,MAAQmC,IAAIgB,YAAYnD,MAC9B2G,MAAM1G,OAASkC,IAAIgB,YAAYlD,OAC/BkC,IAAIT,QAAQgK,uBAAwB,GAMxC1C,kBAAmB,WACX7G,IAAIiF,aACJjF,IAAI0I,aAEJ1I,IAAIqH,eAOZmC,YAAa,WACT/D,SAASG,UAAY,KACrBH,SAASC,QAAU,KACnBD,SAASO,YAAc,KACvBP,SAASK,UAAY,KACrBL,SAASS,YAAc,KACvBT,SAASW,aAAe,KACxBX,SAASa,WAAa,KACtBb,SAASgE,YAAc,KACvB9C,OAAOC,SAAW,MAGtBvD,YAAa,SAAUjC,OAAQsI,YACvBC,SAAU,KACd3J,IAAI4J,MAAM7F,SAAQ,SAAU8F,OACpBA,MAAMC,IAAM1I,SACZuI,QAAUE,UAIdF,QAAS,SACLI,OAAS,CACThF,SAAU/E,IAAIgK,WAAWL,QAAO,YAChCM,SAAU,GACVC,QAASP,QAAO,KAChBD,OAAQA,OACRI,GAAIH,QAAQG,IAEPK,EAAI,EAAGA,EAAInK,IAAIsF,QAAQ8E,OAAQD,OAChCnK,IAAIsF,QAAQ6E,GAAGL,IAAMH,QAAQG,GAAI,MAE7BJ,OAAS,GAA8B,GAAzB1J,IAAIsF,QAAQ6E,GAAGT,eAC7B1J,IAAIsF,QAAQ+E,OAAOF,EAAG,GAQlCnK,IAAIsF,QAAQgF,KAAKP,UAIzBvH,cAAe,SAAUpB,QACjBpB,IAAIkF,QAeZqF,cAAe,SAAUC,QAASC,SAC1BzK,IAAIkF,QAmBZwF,WAAY,WACR1K,IAAIwJ,cACJ/D,SAASG,UAAY5F,IAAI2K,YACzBlF,SAASK,UAAY9F,IAAI4K,cACzBnF,SAASa,WAAatG,IAAI6K,aAC1BlE,OAAOC,SAAW5G,IAAI6G,mBAM1BiE,SAAU,WAEN9K,IAAI+K,QAAQ/K,IAAIsE,WAEXtE,IAAI6E,OAiBL7E,IAAIgL,aAhBJhL,IAAI0E,OAAOX,SAAQ,SAAUtF,SACrBwM,aAAe/L,EAAEC,IAAIC,QAAU,mBAAqBX,IAEpDC,MAAQ,IAAIO,MAChBP,MAAMD,IAAMwM,aACZvM,MAAMwM,OAAS,WACXlL,IAAI4E,aAAanG,KAAOC,MACxBsB,IAAI2E,eACJgD,QAAQvK,IAAI4C,IAAI2E,cACZ3E,IAAI2E,cAAgB3E,IAAI0E,OAAO0F,QAC/BpK,IAAImL,iBAIhBnL,IAAI6E,QAAS,IASrBjE,QAAS,WAGDZ,IAAIiF,eACJ7H,IAAII,MAAM,wBACVwC,IAAIiF,cAAe,EACnBjF,IAAIqH,eAGR+D,cAAcpL,IAAIuF,MAAMP,UACxB/H,EAAE,mDAAmDoO,OACrDpO,EAAE,uBAAuBqO,WAGrBC,MAAQ,GACZA,MAAK,WAAiBvL,IAAIwL,WAC1BD,MAAK,QAAcvL,IAAIyL,QACvBF,MAAK,QAAcvL,IAAIsF,QACvBiG,MAAK,MAAYvL,IAAIsE,UAAU8F,WAC3BsB,aAAe1L,IAAI2L,kBAAkB3L,IAAIsF,SAE7CiG,MAAK,aAAmB/J,KAAKoK,MAAqB,GAAfF,cAAqB,GACxDH,MAAK,UAAgB/J,KAAKoK,MAAM5L,IAAIW,WAChCkL,WAAa7L,IAAIuF,MAAMuG,MAEvBP,MAAK,WADS,GAAdM,WACsB,QAEA7L,IAAI+L,kBAAkBF,YAGhDxO,UAAU2O,OAAO,0BAA2BT,OAAO7D,MAC/C,SAAUuE,KAAMC,IACZjP,EAAE,kBAAkBgP,KAAKA,SAKpBjM,IAAIsF,aAwBZhC,oBACAkG,eAMT2B,WAAY,WAERC,cAAcpL,IAAIgF,UAElBhF,IAAIgF,SAAWmH,aAAY,WACvBnM,IAAIV,KAAKU,IAAIT,QAASS,IAAIgB,YAAahB,IAAIM,YAAaN,IAAIyE,UAAWzE,IAAI+E,UAC3E/E,IAAIX,OAAOW,IAAIgB,YAAahB,IAAIM,YAAaN,IAAIyE,aAClD,IAEHzE,IAAIgL,aAMRA,UAAW,WACPhL,IAAIW,MAAQ,EACZX,IAAIM,YAAc,GAClBN,IAAIyE,UAAY,GAChBzE,IAAI6B,OAAS,EACb7B,IAAIsB,WAAa,GACjBtB,IAAIE,WAAY,EAChBF,IAAIC,WAAY,EAChBD,IAAIsF,QAAU,GAUdtF,IAAIG,OAAS,IAAIR,OAAO,6BAA+BK,IAAIoD,SAAW,OAAQ,EAAG,GACjFpD,IAAIG,OAAO/B,EAAI4B,IAAIgB,YAAYnD,MAAQ,EACvCmC,IAAIG,OAAO9B,EAAI2B,IAAIgB,YAAYlD,OAAS,EACxCkC,IAAIM,YAAYgK,KAAKtK,IAAIG,QAEzBH,IAAI8E,OAAS,IAAI/D,OAAO,2BAA4B,EAAG,GACvDf,IAAI8E,OAAOpG,MAAMb,MAAQmC,IAAIgB,YAAYnD,MACzCmC,IAAI8E,OAAOpG,MAAMZ,OAASkC,IAAIgB,YAAYlD,OAC1CkC,IAAI8E,OAAOjG,UAAUR,EAAI,EACzB2B,IAAI8E,OAAOhG,UAAUT,EAAI,GACzB2B,IAAIyE,UAAU6F,KAAKtK,IAAI8E,QAEvB9E,IAAIuF,MAAQ,CACRP,SAAUmH,aAAY,WAClBnM,IAAIuF,MAAMlG,WACX,KACPyM,MAAO,EACPzM,OAAQ,WACJW,IAAIuF,MAAMuG,QACV7O,EAAE,4BAA4BiE,KAAKlB,IAAIuF,MAAMuG,SAIjD9L,IAAIuD,YAEJvD,IAAIwF,2BAMRjC,UAAW,WACPvD,IAAI6B,QAGA7B,IAAI6B,OAAS7B,IAAIsE,UAAU8F,OAE3BpK,IAAIG,OAAOT,MAUXM,IAAI+E,SAAW/E,IAAIoM,SAASpM,IAAIsE,UAAWtE,IAAI6B,MAAO7B,IAAIgB,cAWlEoL,SAAU,SAAU9H,UAAWzC,MAAO9B,eAClCC,IAAI8D,YAAc,GAClB9D,IAAI4D,SAAW,EACf5D,IAAIiC,kBAAoB,EAEhBqC,UAAUzC,OAAOwK,UAChB,eACGlC,EAAI,EAEJhJ,WAAa,GAAqC,EAAhCmD,UAAUzC,OAAOyK,MAAMlC,QAC7CpK,IAAIiC,mBAAqB,EACzBqC,UAAUzC,OAAOyK,MAAMvI,SAAQ,SAAUL,MACrCyG,QACIpF,SAAW,IAAIvB,WACfhC,KAAKC,SAAW1B,OAAOlC,OACtB2D,KAAKC,SAAW1B,OAAOjC,OAAS,EACjC4F,KAAKqB,SACL5D,YACCgJ,GACD,EACAzG,KAAKtC,QAELmL,OAAS,IAAI/I,WACbhC,KAAKC,SAAW1B,OAAOlC,OACtB2D,KAAKC,SAAW1B,OAAOjC,OAAS,EACjC4F,KAAK6I,OACLpL,WACAgJ,GACA,EACAzG,KAAKtC,QAETpB,IAAI8D,YAAYwG,KAAKvF,UACrB/E,IAAI8D,YAAYwG,KAAKiC,QACrBvM,IAAIM,YAAYgK,KAAKvF,UACrB/E,IAAIM,YAAYgK,KAAKiC,qBAIxB,cACDjI,UAAUzC,OAAO2K,QAAQzI,SAAQ,SAAUwI,YACnCE,MAAQ,IAAIvJ,WACZ1B,KAAKC,SAAW1B,OAAOlC,OACtB2D,KAAKC,SAAW1B,OAAOjC,OAAS,EACjCyO,OAAOrL,KACPqL,OAAOpL,WACPmD,UAAUzC,OAAOsB,OACjBmB,UAAUzC,OAAOT,QAGjBmL,OAAOpL,WAAa,IACpBnB,IAAI8D,YAAYwG,KAAKmC,OACjBF,OAAOpL,WAAa,IACpBnB,IAAIiC,mBAAqBsK,OAAOpL,aAGxCnB,IAAIM,YAAYgK,KAAKmC,iBAG1BnI,UAAUzC,OAAOkD,UAW5BzF,KAAM,SAAUC,QAASyB,YAAa0L,QAASjI,UAAWM,UACtDxF,QAAQoN,UAAU,EAAG,EAAG3L,YAAYnD,MAAOmD,YAAYlD,QAEvDkC,IAAI4M,oBAAoBrN,QAAQyB,iBAG5BmJ,EAAI,MACHA,EAAI,EAAGA,EAAI1F,UAAU2F,OAAQD,IAC9B1F,UAAU0F,GAAG7K,KAAKC,aAIjB4K,EAAI,EAAGA,EAAIuC,QAAQtC,OAAQD,IAC5BuC,QAAQvC,GAAG7K,KAAKC,SAGhBS,IAAIG,OAAOpB,OACXQ,QAAQ6C,UAAY,UACpB7C,QAAQ8C,KAAO,iBACf9C,QAAQ+C,UAAY,OACpB/C,QAAQsN,SACJ7M,IAAIoE,QAAQzD,MAAQ,IAAMa,KAAKoK,MAAM5L,IAAIW,OAAU,KAAOX,IAAIoE,QAAQvE,MAAQ,IAAOG,IAAIG,OAAON,MAChG,EACAmB,YAAYlD,OAAS,IAEzByB,QAAQ+C,UAAY,SAEpBtC,IAAIuC,SAAShD,QAASwF,UAAU,EAAO,GAAwB,GAApB/D,YAAYnD,MAAamD,YAAYnD,MAAQ,EAAG,MAE3F0B,QAAQ6C,UAAY,UACpB7C,QAAQ8C,KAAO,iBACf9C,QAAQ+C,UAAY,SACpB/C,QAAQsN,SACJ7M,IAAIoE,QAAQ0I,UAAY,IAAMtL,KAAKoK,MAAM5L,IAAIG,OAAOL,WACpDkB,YAAYnD,MAAQ,EACpBmD,YAAYlD,OAAS,KAWjCuB,OAAQ,SAAUU,OAAQ2M,QAASjI,eAC3B0F,EAAI,MACHA,EAAI,EAAGA,EAAI,EAAGA,IACf1F,UAAU6F,KAAK,IAAIrH,KAAKlD,aAEvBoK,EAAI,EAAGA,EAAI1F,UAAU2F,OAAQD,IAC9B1F,UAAU0F,GAAG9K,OAAOU,QACf0E,UAAU0F,GAAGpL,QACd0F,UAAU4F,OAAOF,EAAG,GACpBA,SAGHA,EAAI,EAAGA,EAAIuC,QAAQtC,OAAQD,IAAK,CACjCuC,QAAQvC,GAAG9K,OAAOU,YACb,IAAIgN,EAAI5C,EAAI,EAAG4C,EAAIL,QAAQtC,OAAQ2C,IACpC/M,IAAIgN,QAAQN,QAAQvC,GAAIuC,QAAQK,IAE/BL,QAAQvC,GAAGpL,QACZ2N,QAAQrC,OAAOF,EAAG,GAClBA,OAQZ7G,aAAc,WACVtD,IAAI8D,YAAYC,SAAQ,SAAU0I,OAC1BA,MAAM1N,QAEN0N,MAAMtL,WAAa,EACnBsL,MAAM/M,UAGdM,IAAI8D,YAAc,IAStBkJ,QAAS,SAAUC,QAASC,gBACjBD,QAAQlO,OAASmO,QAAQnO,QAAUf,KAAKmP,eAAeF,QAASC,UAAYlP,KAAKmP,eAAeD,QAASD,WASpHE,eAAgB,SAAUF,QAASC,gBAC3BD,mBAAmBzM,OAAS0M,mBAAmBvN,SAC1CsN,QAAQjL,UAAYhC,IAAIoN,iBAAiBH,QAASC,UACnDA,QAAQrM,QAAQoM,SAChBA,QAAQvN,OACD,GAGXuN,mBAAmBzM,OAAS0M,mBAAmBjM,OAC3CgM,QAAQjL,UAAYhC,IAAIoN,iBAAiBH,QAASC,UAClDA,QAAQrM,QAAQoM,UACT,MAGXA,mBAAmBtN,QAAUuN,mBAAmBjM,OAC5CjB,IAAIoN,iBAAiBH,QAASC,YAC9BD,QAAQvN,OACD,IAYnB0N,iBAAkB,SAAUH,QAASC,aAC7BG,MAAQJ,QAAQxN,UAChB6N,MAAQJ,QAAQzN,iBACb4N,MAAM/O,UAAUgP,QAU3B5M,MAAO,SAAUtC,EAAGC,EAAGkP,IAAK1K,YACnB,IAAIsH,EAAI,EAAGA,EAAIoD,IAAKpD,IACrBnK,IAAIyE,UAAU6F,KAAK,IAAI1H,SAASxE,EAAGC,EAAG,CAClCD,EAA2B,IAAvBoD,KAAKC,SAAW,IACpBpD,EAA4B,IAAvBmD,KAAKC,SAAW,IAAa,GACnCoB,UAcXN,SAAU,SAAUhD,QAASiO,MAAOC,YAAaC,WAAYC,aAAcvP,EAAGC,OACtEuP,UAAY,GACZC,UAAYxP,EACZyP,MAAQN,MAAMO,MAAM,KACpBC,KAAO,GACPC,aAAe,EAEnBH,MAAM/J,SAAQ,SAAUmK,UAChBC,SAAW,GAEXA,SAAWH,KAAO,IAAME,SAMxBE,UADU7O,QAAQ8O,YAAYF,UACVtQ,MACxBoQ,aAAezM,KAAK8M,IAAIL,aAAcG,WAGlCA,UAAYT,cACZC,UAAUtD,KAAK,CACXpJ,KAAM8M,KACN3P,EAAGA,GAAKqP,aAGZM,KAAOE,MAGPF,KAAOG,YAKfP,UAAUtD,KAAK,CACXpJ,KAAM8M,KACN3P,EAAGA,GAAKqP,iBAIRa,QAAUlQ,EAAIwP,UAIdW,YAAcf,cAAgBc,QAAUb,WAAae,MAAoBf,WAAae,IAEtFC,YAAcjB,YAAc,cAAgB,QAChDzN,IAAI2O,cAAcpP,QAASmP,YAAYT,aAJtB,GAIiDP,WAAaE,UAAUxD,OAJxE,GAI6FhM,GAAK6P,aAJlG,IAI+H,EAAG5P,EAAImQ,aAEvJjP,QAAQ6C,UAAY,QACpBwL,UAAU7J,SAAQ,SAAU6K,cAGpBC,SAAWpB,aAAec,QAAU,EAExChP,QAAQsN,SAAS+B,SAAS1N,KAAM9C,EAAGwQ,SAASvQ,EAAIwQ,cAIxDF,cAAe,SAAUpP,QAASmP,YAAa7Q,MAAOC,OAASM,EAAIC,GAM3C,UAAhBqQ,cACIA,YAHQ,yBAOhBnP,QAAQ6C,UAPQ,wBAQhB7C,QAAQwD,SAAS3E,EAAEC,EAAGR,MAAOC,QAC7ByB,QAAQuP,YAAcJ,YACtBnP,QAAQwP,UAZU,EAalBxP,QAAQyP,WAAW5Q,EAAI6Q,EAAiB5Q,EAAI4Q,EAAkBpR,MAb5C,EAaiEC,OAbjE,IAgBtB8O,oBAAqB,SAAUrN,QAAQyB,qBAG/BkO,IAAMlP,IAAI4E,aAAa,gCAGvBuK,OAAS3N,KAAK4N,KAAKpO,YAAYnD,MAAQqR,IAAIrR,OAC3CwR,OAAS7N,KAAK4N,KAAKpO,YAAYlD,OAASoR,IAAIpR,QAGvCqM,EAAI,EAAGA,EAAIgF,OAAQhF,QACnB,IAAI4C,EAAI,EAAGA,EAAIsC,OAAQtC,IACxBxN,QAAQC,UAAU0P,IAAK/E,EAAI+E,IAAIrR,MAAOkP,EAAImC,IAAIpR,OAAQoR,IAAIrR,MAAOqR,IAAIpR,SAQjFoE,eAAgB,WAMO,IAJFlC,IAAI8D,YAAYwL,QAAO,SAAU7C,cACvCA,MAAM1N,SACdqL,QAIIpK,IAAIG,OAAOpB,OACdiB,IAAIuD,aAQZoH,YAAa,SAAU1B,IAC8B,IAA7C,CAAC,GAAI,GAAI,GAAI,GAAI,IAAIsG,QAAQtG,EAAEuG,WAC/BvG,EAAEwG,iBACgB,KAAdxG,EAAEuG,SACFxP,IAAI8K,aAShBF,cAAe,SAAU3B,GACjBA,EAAEyG,SAAW1P,IAAIwE,OACjBxE,IAAI8K,YAQZD,aAAc,SAAU5B,GAChBA,EAAEyG,SAAW1P,IAAIwE,OACjBxE,IAAI8K,YAQZjF,QAAS,SAAUoD,IACkC,IAA7C,CAAC,GAAI,GAAI,GAAI,GAAI,IAAIsG,QAAQtG,EAAEuG,WAC/BvG,EAAEwG,iBACgB,KAAdxG,EAAEuG,SAAkBxP,IAAIG,OAAOpB,OAASiB,IAAIS,SAC5CT,IAAIG,OAAOC,QACU,KAAd6I,EAAEuG,QACTxP,IAAIG,OAAOtB,UAAUT,GAAK,EACL,KAAd6K,EAAEuG,QACTxP,IAAIG,OAAOtB,UAAUR,GAAK,EACL,KAAd4K,EAAEuG,QACTxP,IAAIG,OAAOtB,UAAUT,EAAI,EACJ,KAAd6K,EAAEuG,UACTxP,IAAIG,OAAOtB,UAAUR,EAAI,KASrCsH,MAAO,SAAUsD,GACK,KAAdA,EAAEuG,QACFxP,IAAIS,UAAW,GACyB,IAAjC,CAAC,GAAI,IAAI8O,QAAQtG,EAAEuG,SAC1BxP,IAAIG,OAAOtB,UAAUT,EAAI,GACe,IAAjC,CAAC,GAAI,IAAImR,QAAQtG,EAAEuG,WAC1BxP,IAAIG,OAAOtB,UAAUR,EAAI,IAQjC4H,UAAW,SAAUgD,GACbA,EAAEyG,SAAW1P,IAAIwE,QACMxE,IAAIG,OAAOV,UAAUvB,SAAS,CAACE,EAAG6K,EAAE0G,QAAStR,EAAG4K,EAAE2G,WACjD5P,IAAIG,OAAOpB,OAC/BiB,IAAIG,OAAOC,QAEVJ,IAAIC,YACLD,IAAIG,OAAOP,MAAMxB,EAAI6K,EAAE0G,QACvB3P,IAAIG,OAAOP,MAAMvB,EAAI4K,EAAE2G,QACvB5P,IAAIC,WAAY,KAQ5B8F,QAAS,WACL/F,IAAIG,OAAOtB,UAAUT,EAAI,EACzB4B,IAAIG,OAAOtB,UAAUR,EAAI,EACzB2B,IAAIC,WAAY,GAOpBkG,UAAW,SAAU8C,GACjBjJ,IAAIG,OAAOP,MAAMxB,EAAI6K,EAAE0G,QACvB3P,IAAIG,OAAOP,MAAMvB,EAAI4K,EAAE2G,SAO3B9I,UAAW,SAAU+I,OACbA,MAAMH,SAAW1P,IAAIwE,OACrBqL,MAAMJ,kBAQdpJ,WAAY,SAAU4C,GACdA,EAAEyG,SAAW1P,IAAIwE,QACbxE,IAAIG,OAAOpB,OAASkK,EAAE6G,QAAQ1F,OAAS,EACvCpK,IAAIG,OAAOC,SAEXJ,IAAIE,WAAY,EAChBF,IAAIyG,UAAUwC,IAGlBA,EAAEwG,mBAQVlJ,SAAU,SAAU0C,GACS,IAArBA,EAAE6G,QAAQ1F,SACVpK,IAAIE,WAAY,GAEpBF,IAAIG,OAAOtB,UAAUT,EAAI,EACzB4B,IAAIG,OAAOtB,UAAUR,EAAI,EAErB4K,EAAEyG,SAAW1P,IAAIwE,OACjByE,EAAEwG,kBAQVhJ,UAAW,SAAUwC,OACb8G,KAAO9G,EAAEyG,OAAOM,wBAEhB5R,EAAI6K,EAAE6G,QAAQ,GAAGG,MAAQF,KAAKpS,KAC9BU,EAAI4K,EAAE6G,QAAQ,GAAGI,QAAUH,KAAKnS,IAEpC+I,OAAOnC,MAAQxE,IAAIwE,MACnBxE,IAAIG,OAAOP,MAAMxB,EAAIA,EACrB4B,IAAIG,OAAOP,MAAMvB,EAAIA,EAAK,EAAI2B,IAAIG,OAAOzB,MAAMZ,OAE3CmL,EAAEyG,SAAW1P,IAAIwE,OACjByE,EAAEwG,kBASV1E,QAAS,SAAUoF,eAEXC,eACAC,YAFAC,aAAeH,MAAM/F,OAIlB,IAAMkG,cACTD,YAAc7O,KAAKM,MAAMN,KAAKC,SAAW6O,cAGzCF,eAAiBD,MAFjBG,cAAgB,GAGhBH,MAAMG,cAAgBH,MAAME,aAC5BF,MAAME,aAAeD,sBAGlBD,OAGXnG,WAAY,SAAUuG,mBACXA,WAAWC,QAAQ,kBAAmB,KAGjDC,MAAO,kBACIxT,EAAEyT,QAAO,EAAM,GAAI1S,OAG9B2S,YAAa,SAAUR,MAAOS,WACT,MAAbA,YACAA,UAAY,WACZ7G,OAAS,GACTuG,aAAe,EAEZA,aAAeH,MAAM/F,QAAQ,OAC1ByG,MAAQV,MAAMW,MAAMR,aAAcA,aAAeM,cACnDC,MAAMzG,OAASwG,UAAW,OACpBG,UAAYH,UAAYC,MAAMzG,WAE/B,IAAID,EAAI,EAAGA,EAAI4G,UAAW5G,IAC3B0G,MAAMvG,KAAK6F,MAAMhG,IAGzBJ,OAAOO,KAAKuG,OACZP,cAAgBM,iBAGb7G,QAGXiH,cAAe,SAAUb,WAChB,IAAIhG,EAAIgG,MAAM/F,OAAS,EAAGD,EAAI,EAAGA,IAAK,OACjC4C,EAAIvL,KAAKM,MAAMN,KAAKC,UAAY0I,EAAI,KACzCgG,MAAMhG,GAAIgG,MAAMpD,IAAM,CAACoD,MAAMpD,GAAIoD,MAAMhG,MAIhDwB,kBAAmB,SAAUrG,aACrB2L,MAAQ,SACZhU,EAAEiU,KAAK5L,SAAS,SAAU6E,EAAGgH,GACTC,MAAZD,EAAEzH,SACFuH,OAASE,EAAEzH,WAGZuH,OAGXlF,kBAAmB,SAAUsF,UACrBC,QAAU9P,KAAKM,MAAMuP,KAAO,IAC5BE,QAAUF,KAAiB,GAAVC,eACdtR,IAAIwR,aAAaF,QAAS,IAAK,GAAK,IAAMtR,IAAIwR,aAAaD,QAAS,IAAK,IAGpFC,aAAc,SAAUC,OAAQC,IAAKtH,eACzB,IAAIuH,MAAMvH,OAAS,GAAGwH,KAAKF,KAAOD,QAAQX,OAAO1G,SAG7DyH,aAAc,WAEVtU,IAAIuU,YAAY,CACd,KAAS,0BAA8B,kBACvC,KAAS,sBAA0B,kBACnC,KAAS,kBAAsB,kBAC/B,KAAS,kBAAsB,kBAC/B,KAAS,yBAA6B,oBAErCC,MAAK,SAAUC,OACV7H,EAAI,EACRnK,IAAIoE,QAAQ6N,cAAgBD,EAAE7H,KAC9BnK,IAAIoE,QAAQ8N,UAAYF,EAAE7H,KAC1BnK,IAAIoE,QAAQzD,MAAQqR,EAAE7H,KACtBnK,IAAIoE,QAAQvE,MAAQmS,EAAE7H,KACtBnK,IAAIoE,QAAQ+N,aAAeH,EAAE7H,SAIrCiI,MAAO,WACHhH,cAAcpL,IAAIgF,UAClBoG,cAAcpL,IAAIuF,MAAMP,UAGpBS,SAAS4M,sBACT5M,SAAS4M,oBAAoB,mBAAoBrS,IAAIyI,UAAU,GAC/DhD,SAAS4M,oBAAoB,qBAAsBrS,IAAIyI,UAAU,GACjEhD,SAAS4M,oBAAoB,sBAAuBrS,IAAIyI,UAAU,GAClEhD,SAAS4M,oBAAoB,yBAA0BrS,IAAIyI,UAAU,IAGzExL,EAAE,+CAA+CqV,IAAI,SAGrDrV,EAAE,kBAAkBgP,KAAK,IACzBjM,IAAIsE,UAAY,GAChBtE,IAAI4J,MAAQ,GACZ5J,IAAIsF,QAAU,GACdtF,IAAIW,MAAQ,EACZX,IAAIM,YAAc,GAClBN,IAAIyE,UAAY,GAChBzE,IAAIG,OAAS,KACbH,IAAI8E,OAAS,KACb9E,IAAI6E,QAAS,EACb7E,IAAIuS,WAGRA,QAAS,eACD3I,MAAQ5J,IAAIwS,SAASC,eAAeC,KAAI,SAAUC,KAAKC,WACnDC,QAAUC,KAAKC,MAAMJ,aACzBE,QAAQ/I,GAAK8I,MACNC,WAEPG,4BAA8BhT,IAAIwS,SAASS,sBAC3CC,yBAA2BlT,IAAIwS,SAASW,mBACxCC,2BAA6BpT,IAAIwS,SAASa,gBAC9CrT,IAAI4J,MAAQA,MACZ5J,IAAIwL,WAAaxL,IAAIwS,SAAShH,WAC9BxL,IAAIgR,cAAcpH,WAIdgH,UAAYoC,4BACZpJ,MAAMQ,OAASwG,YACfA,UAAYhH,MAAMQ,gBAClBkJ,UAAYtT,IAAI2Q,YAAY/G,MAAOgH,WAE9B2C,SAAW,EAAGA,SAAWD,UAAUlJ,OAAQmJ,mBAC5C1R,MAAQyR,UAAUC,UAEbpJ,EAAI,EAAGA,EAAItI,MAAMuI,OAAQD,IAAK,SAC/BqC,QAAU,GACLO,EAAI,EAAGA,EAAIlL,MAAMuI,OAAQ2C,IAAK,KAC/ByG,WAAaxT,IAAIgK,WAAWnI,MAAMkL,GAAG0G,YAErCzT,IAAI0T,YAAc1T,IAAIqE,cACtBmP,WAAa3R,MAAMkL,GAAG4G,MAE1BnH,QAAQlC,KAAK,MAASkJ,sBAA0BrJ,IAAM4C,EAAI,EAAI,QAE9D6G,aAAe/R,MAAMsI,GAAGwJ,KACxB3T,IAAI0T,YAAc1T,IAAIqE,cACtBuP,aAAe5T,IAAIgK,WAAWnI,MAAMsI,GAAGsJ,aAE3CzT,IAAIsE,UAAUgG,KAAK,UACHsJ,oBACF/R,MAAMsI,GAAGL,WACR0C,aACH,sBACE,OAMY,GAA9B4G,2BAAiC,CAEjCxC,UAAYsC,yBACRtJ,MAAMQ,OAASwG,YACfA,UAAYhH,MAAMQ,YAClByJ,gBAAkB7T,IAAI2Q,YAAY/G,MAAOgH,eACpC2C,SAAW,EAAGA,SAAWM,gBAAgBzJ,OAAQmJ,WAAY,CAC9D1R,MAAQgS,gBAAgBN,cACxBO,aAAe,OACV3J,EAAI,EAAGA,EAAItI,MAAMuI,OAAQD,IAC9B2J,aAAaxJ,KAAK,CAACvF,SAAUlD,MAAMsI,GAAGwJ,KAAMpH,OAAQvM,IAAIgK,WAAWnI,MAAMsI,GAAGsJ,mBAAsB5R,MAAMsI,GAAGL,KAG/G9J,IAAIsE,UAAUgG,KAAK,UAAatK,IAAIoE,QAAQ6N,oBAAwB6B,kBAAsB,cAGlGnM,QAAQvK,IAAI,iBAAkB4C,IAAIsE,YAGtCyP,cAAe,WACX/T,IAAIqF,SAAS2O,UAAY/W,EAAE,yBAC3B+C,IAAIqF,SAAS4O,aAAehX,EAAE,6BAMlCiX,SAAU,WAENlU,IAAIT,QAAQoN,UAAU,EAAG,EAAG3M,IAAIgB,YAAYnD,MAAOmC,IAAIgB,YAAYlD,QAEnEkC,IAAIT,QAAQ6C,UAAY,UACxBpC,IAAIT,QAAQ8C,KAAO,iBACnBrC,IAAIT,QAAQ+C,UAAY,SAEF,OAAlBtC,IAAIsE,WAAsBtE,IAAIsE,UAAU8F,OAAS,GACjDpK,IAAIT,QAAQsN,SAAS7M,IAAIoE,QAAQ+N,aAAcnS,IAAIgB,YAAYnD,MAAQ,EAAGmC,IAAIgB,YAAYlD,OAAS,GACnGkC,IAAI0K,cAEJ1K,IAAIT,QAAQsN,SAAS7M,IAAIoE,QAAQ8N,UAAWlS,IAAIgB,YAAYnD,MAAQ,EAAGmC,IAAIgB,YAAYlD,OAAS,GAI5E,GAApBkC,IAAIwE,MAAM1G,QACVkC,IAAI6G,qBAIZsN,MAAO,WAEHnU,IAAIsF,QAAU,GACdtF,IAAIqF,SAAS2O,UAAU1I,OACvBtL,IAAIqF,SAAS4O,aAAa/S,KAAK,SAE/BlB,IAAIuF,MAAQ,CACRP,SAAUmH,aAAY,WAClBnM,IAAIuF,MAAMlG,WACX,KACPyM,MAAO,EACPzM,OAAQ,WACJW,IAAIuF,MAAMuG,UAMVrG,SAASe,mBACTf,SAASe,iBAAiB,mBAAoBxG,IAAIyI,UAAU,GAC5DhD,SAASe,iBAAiB,qBAAsBxG,IAAIyI,UAAU,GAC9DhD,SAASe,iBAAiB,sBAAuBxG,IAAIyI,UAAU,GAC/DhD,SAASe,iBAAiB,yBAA0BxG,IAAIyI,UAAU,IAEtEzI,IAAIwE,MAAQiB,SAASuB,eAAe,4BACpChH,IAAIT,QAAUS,IAAIwE,MAAM4P,WAAW,MACnCpU,IAAIqH,cACJrH,IAAIgF,SAAWmH,aAAY,WACnBnM,IAAIsE,WAAatE,IAAIsE,UAAU8F,OAAS,EACxCpK,IAAIkU,WAEJvM,QAAQvK,IAAI,uCAEjB,KAGHH,EAAE,+CAA+CoX,GAAG,SAAS,WACrDrU,IAAIiF,cACJjF,IAAIiF,cAAe,EACnBjF,IAAIqH,eAEJrH,IAAI0I,iBAKhB4L,cAAe,eAEPC,SAAW,GACfA,SAAS3B,MAFE5U,KAEW4U,MACtB2B,SAASC,UAAW,EACpBD,SAASE,WAAazU,IAAIsE,UAAU8F,WAChCsB,aAAe1L,IAAI2L,kBAAkB3L,IAAIsF,SAE7CiP,SAASG,aAAelT,KAAKoK,MAAqB,GAAfF,cAAqB,GACxD6I,SAASI,MAAQnT,KAAKoK,MAAa2I,SAASG,aAAeH,SAASE,WAAxC,KARjBzW,KASN4W,WAAWC,QAAQN,WAG5BO,gBAAiB,SAAUlC,MAAOJ,SAAUoC,YACxC5U,IAAI4S,MAAQA,MACZ5S,IAAI4U,WAAaA,eACbG,WAAa9X,EAAE,IAAMuV,SAASwC,SAAW,qCACzCC,YAAchY,EAAE,IAAMuV,SAASwC,SAAW,gCAE9CD,WAAWV,GAAG,SAAS,SAAUpL,GAC7BjJ,IAAIsU,cAAc,MAGtBW,YAAYZ,GAAG,SAAS,SAAUpL,GAC9BjJ,IAAImU,WAGRlX,EAAE,QAAQoX,GAAG,QAAS,yBAAyB,WAE3CrU,IAAIoS,QACJpS,IAAImU,WAGRlX,EAAE,QAAQoX,GAAG,QAAS,6BAA6B,eAC3CxI,WAAa7L,IAAIuF,MAAMuG,MACvBoJ,IAAMlV,IAAIyL,QAAQ+E,QAAQ,SAAU,KAAO,qBAAuB3E,WACtElF,OAAOwO,SAAS3E,QAAQ0E,SAQhCE,KAAM,SAAUxC,MAAOJ,SAAUoC,YAC7BxX,IAAII,MAAM,wCACVwC,IAAIwS,SAAWA,SACfxS,IAAI6R,eACJ7R,IAAI8U,gBAAgBlC,MAAOJ,SAAUoC,YACrC5U,IAAI+T,gBACJ/T,IAAIuS,UACJvS,IAAImU,iBAILnU"}