{"version":3,"file":"fiction.min.js","sources":["../src/fiction.js"],"sourcesContent":["define([\n    'jquery', 'core/log', 'mod_minilesson/definitions','mod_minilesson/yarn-bound',\n    'core/str', 'core/modal_factory', 'core/fragment','core/templates'\n],\n    function ($, log, def, YarnBound, Str, ModalFactory, Fragment, Templates) {\n        \"use strict\"; // jshint ;_;\n\n        /*\n       This file is to manage the fiction item type\n        */\n\n        log.debug('MiniLesson Fiction: initialising');\n\n        return {\n\n            runner: null,\n            controls: {},\n            itemdata: {},\n\n            //for making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                this.prepare_html(itemdata);\n                this.register_events(index, itemdata, quizhelper);\n                var yarnopts = {\n                    \"dialogue\": itemdata.fictionyarn,\n                    \"combineTextAndOptionsResults\": true,\n                    \"startAt\": \"Start\"\n                };\n                log.debug('MiniLesson Fiction: initializing yarnbound with options');\n                log.debug(yarnopts);\n                try{\n                    this.runner = new YarnBound(yarnopts);\n                    this.do_render();\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \" + e.message;\n                    this.controls.yarncontainer.html(\n                        `<div class=\"alert alert-danger\">${userFriendlyError}</div>`\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n                \n            },\n\n            prepare_html: function (itemdata) {\n                this.controls.yarncontainer = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_yarncontainer\");\n                this.controls.yarntext = this.controls.yarncontainer.find('.minilesson_fiction_yarntext');\n                this.controls.yarnmedia = this.controls.yarncontainer.find('.minilesson_fiction_yarnmedia');\n                this.controls.yarnoptions = this.controls.yarncontainer.find('.minilesson_fiction_yarnoptions');\n                this.controls.yarncontinuebutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_continuebutton\");\n\n            },\n\n            do_render: function () {\n                var that = this;\n                var yarncontent = {\n                    'yarntext': false,\n                    'yarnoptions': false\n                };\n\n                var currentResult = this.runner.currentResult;\n                currentResult = this.add_metadata(currentResult);\n                log.debug('MiniLesson Fiction: doing render of currentResult');\n                log.debug(currentResult);\n\n                if(currentResult instanceof YarnBound.TextResult) {\n\n                    // Render the text\n                    yarncontent.yarntext = currentResult;\n                    Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarntext).then(\n                    function (html, js) {\n                        that.controls.yarntext.html(html);\n                        that.controls.yarnoptions.html('');\n                    });\n                    // Enable the continue button\n                    this.can_continuebutton(true);\n\n                } else if(currentResult instanceof YarnBound.OptionsResult) {\n                    // Render the options\n                    yarncontent.yarnoptions = currentResult;\n                    Templates.render('mod_minilesson/fictionyarnoptions', yarncontent.yarnoptions).then(\n                    function (html, js) {\n                        that.controls.yarnoptions.html(html);\n                    });\n\n                    //If there is some text as well render that, or clear the existing text otherwise\n                    if('text' in yarncontent.yarnoptions){\n                         Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarnoptions).then(\n                        function (html, js) {\n                            that.controls.yarntext.html(html);\n                        });\n                    } else {\n                        that.controls.yarntext.html('');\n                    }\n\n\n                    // Disable the continue button, because they need to select an option\n                    that.can_continuebutton(false);\n\n                } else if (currentResult instanceof YarnBound.CommandResult) {\n                    // Process the command string a little. so we have command name and args\n                    //eg \"picture 1.png\"\n                    var rawCommand = currentResult.command; \n                    var parts = rawCommand.split(' ');\n                    var commandName = parts[0]; // \"picture\" \"audio etc\"\n                    var args = parts.slice(1); // [\"1.png\"]\n\n\n                    switch(commandName) {\n                        case 'picture':\n                            log.debug('got picture command')\n                            const imageURL = args[0]; // \"picture https://blahblah\"\n                            Templates.render('mod_minilesson/fictionyarnimage', {\"imageurl\": imageURL}).then(\n                            function (html, js) {\n                                that.controls.yarnmedia.html(html);\n                            });\n                            break;\n\n                        case 'audio':\n                            log.debug('got audio command')\n                            const audioURL = args[0]; // \"audio https://blahblah\"\n                            Templates.render('mod_minilesson/fictionyarnaudio', {\"audiourl\": audioURL}).then(\n                            function (html, js) {\n                                that.controls.yarnmedia.html(html);\n                            });\n                            break;\n                            \n                        case 'video':\n                            log.debug('got video command')\n                            const videoURL = args[0]; // \"video https://blahblah\"\n                            Templates.render('mod_minilesson/fictionyarnvideo', {\"videourl\": videoURL}).then(\n                            function (html, js) {\n                                that.controls.yarnmedia.html(html);\n                            });\n                            break;    \n\n                        case 'clearpicture': \n                            that.controls.yarnmedia.html('');\n                            break;\n\n                        case 'blahblah':\n                        default:\n                            \n                    }\n                    // In all cases just do command and then jump to next line\n                    if(!currentResult.isDialogueEnd) {\n                        // Just skip through for now\n                        that.do_runner_advance();\n                        that.do_render();\n                        return;\n                    }\n                } else {\n                    log.debug('MiniLesson Fiction: unknown yarn result type');\n                }\n\n                 // In all cases on dialog end there is no continue\n                if(currentResult.isDialogueEnd) {\n                    that.can_continuebutton(false);\n                    return;\n                }\n            },\n\n            do_runner_advance: function (steps) {\n                try {\n                    if(steps !== null){\n                        this.runner.advance(steps);\n                    } else {\n                        this.runner.advance();\n                    }\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \" + e.message;\n                    this.controls.yarncontainer.html(\n                        `<div class=\"alert alert-danger\">${userFriendlyError}</div>`\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n            },\n\n            can_continuebutton: function (cancontinue) {\n                this.controls.yarncontinuebutton.prop(\"disabled\", !cancontinue);\n                if (cancontinue){\n                    this.controls.yarncontinuebutton.show();\n                } else {\n                    this.controls.yarncontinuebutton.hide();\n                }\n               \n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n                var self = this;\n                //When click next button , report and leave it up to parent to eal with it.\n                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function (e) {\n                    var stepdata = {};\n                    stepdata.index = index;\n                    stepdata.hasgrade = false;\n                    stepdata.totalitems = 0;\n                    stepdata.correctitems = 0;\n                    stepdata.grade = 0;\n                    quizhelper.do_next(stepdata);\n                });\n                $(\"#\" + itemdata.uniqueid + \"_container\").on(\"showElement\", async (e) => {\n                    if (!self.instance) {\n                        // Maybe init yarn-bound here\n                        //this.do_render();\n                    }\n\n                    if (itemdata.timelimit > 0) {\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").trigger('click');\n                            }\n                        });\n                    }\n                });\n\n\n                this.controls.yarncontinuebutton.on('click', function (e) {\n                    log.debug('MiniLesson Fiction: yarn continue button clicked');\n                    e.preventDefault();\n                    self.do_runner_advance();\n                    self.do_render();\n                });\n\n                // add an event listener for option buttons that handles option buttons added at runtim\n                this.controls.yarncontainer.on('click', '.minilesson_fiction_optionbutton', function (e) {\n                    log.debug('MiniLesson Fiction: yarn option button clicked');\n                    e.preventDefault();\n\n                    var buttons = self.controls.yarncontainer.find('.minilesson_fiction_optionbutton');\n                    var optionindex = buttons.index(this); // 0-based position in the rendered list\n                    self.do_runner_advance(optionindex);\n                    self.do_render();\n                });\n            },\n\n            add_metadata: function (currentthing) {\n                if (currentthing && 'markup' in currentthing && Array.isArray(currentthing.markup)) {\n                    currentthing.md = {};\n                    //for each markup entry, add the property name and values object to currentthing\n                    currentthing.markup.forEach(function (entry) {\n                        if ('properties' in entry && 'name' in entry) {\n                            currentthing.md[entry.name] = entry.properties;\n                        }\n                    });\n                }\n                return currentthing;\n            },\n\n            register_previewbutton: function (buttonid, region = 'default') {\n                var previewbtn = document.getElementById(buttonid);\n                if (!previewbtn) {\n                    return;\n                }\n                previewbtn.addEventListener('click', function (e) {\n                    e.preventDefault();\n                    var form = previewbtn.form;\n                    if (!form) {\n                        return;\n                    }\n                    ModalFactory.create({\n                        type: ModalFactory.types.CANCEL,\n                        large: true,\n                        removeOnClose: true,\n                        templateContext: {\n                            classes: 'minilesson-fiction-preview-modal'\n                        },\n                        title: Str.get_string('fiction:previewmodaltitle', 'mod_minilesson'),\n                        body: Fragment.loadFragment('mod_minilesson', 'preview_fiction', M.cfg.contextid, {\n                            formdata: new URLSearchParams([...new FormData(form).entries()]).toString()\n                        })\n                    }).then(function (modal) {\n                        modal.getFooter().addClass('d-none');\n                        modal.show();\n                    });\n                    return;\n                });\n                \n            }\n        }; //end of return value\n    });"],"names":["define","$","log","def","YarnBound","Str","ModalFactory","Fragment","Templates","debug","runner","controls","itemdata","clone","extend","this","init","index","quizhelper","prepare_html","register_events","yarnopts","fictionyarn","do_render","e","userFriendlyError","message","yarncontainer","html","error","uniqueid","yarntext","find","yarnmedia","yarnoptions","yarncontinuebutton","that","yarncontent","currentResult","add_metadata","TextResult","render","then","js","can_continuebutton","OptionsResult","CommandResult","parts","command","split","commandName","args","slice","imageURL","audioURL","videoURL","isDialogueEnd","do_runner_advance","steps","advance","cancontinue","prop","show","hide","self","on","stepdata","hasgrade","totalitems","correctitems","grade","do_next","async","instance","timelimit","progressTimer","height","timeLimit","onFinish","trigger","preventDefault","optionindex","currentthing","Array","isArray","markup","md","forEach","entry","name","properties","register_previewbutton","buttonid","previewbtn","document","getElementById","addEventListener","form","create","type","types","CANCEL","large","removeOnClose","templateContext","classes","title","get_string","body","loadFragment","M","cfg","contextid","formdata","URLSearchParams","FormData","entries","toString","modal","getFooter","addClass"],"mappings":"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"}