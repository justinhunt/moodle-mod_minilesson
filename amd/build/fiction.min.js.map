{"version":3,"file":"fiction.min.js","sources":["../src/fiction.js"],"sourcesContent":["define([\n    'jquery',\n    'core/log',\n    'core/str',\n    'core/notification',\n    'mod_minilesson/definitions',\n    'mod_minilesson/translate',\n    'mod_minilesson/external/yarn-bound',\n    'core/modal_factory',\n    'core/fragment',\n    'core/templates',\n], function ($, log, str, notification, def, translate, YarnBound, ModalFactory, Fragment, Templates) {\n    \"use strict\"; // jshint ;_;\n\n    /**\n     * This file is to manage the fiction item type\n     */\n\n    log.debug('MiniLesson Fiction: initialising');\n\n    return {\n        runner: null,\n        controls: {},\n        itemdata: {},\n        chatdata: {},\n        storycomplete: false,\n        storyscore: false,\n        strings: {},\n        presentationmode: 'plain',\n        index: 0,\n        quizhelper: null,\n        storydata: null,\n        visitednodes: [],\n\n        // For making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        /**\n         * Initialize the module\n         *\n         * @param {int} index\n         * @param {object} itemdata\n         * @param {object} quizhelper\n         */\n        init: function (index, itemdata, quizhelper) {\n            var that = this;\n            this.index = index;\n            this.itemdata = itemdata;\n            this.quizhelper = quizhelper;\n            this.init_strings();\n            this.prepare_html(itemdata);\n            this.register_events(this.index, itemdata, quizhelper);\n            this.presentationmode = itemdata.presention_mobilechat ? 'mobilechat' : (itemdata.presention_storymode ? 'storymode' : 'plain');\n            this.flowthroughmode = itemdata.flowthroughmode;\n            this.filenamesmap = itemdata.filenamesmap;\n            this.preload_images();\n            // Initial user and other data\n            this.storydata = new Map();\n            this.storydata.set('userfirstname', itemdata.userfirstname);\n            this.storydata.set('userlastname', itemdata.userlastname);\n            this.storydata.set('userfullname', itemdata.userfullname);\n            this.storydata.set('cantranslate', false);\n\n            // Set a flag to indicate that translation is possible\n            // set lang code to 2 char equivalent, eg en for en-us  \n            this.sourceLang = this.itemdata.language.substring(0, 2);\n            this.destLang = this.itemdata.nativelanguage.substring(0, 2);\n            // We need to wait for the availability check before we start the story,\n            // otherwise $cantranslate will be false in the first render's conditions.\n            translate.check_availability(this.sourceLang, this.destLang).then(function (availability) {\n                that.storydata.set('cantranslate', availability !== 'unavailable');\n\n                // Auto-declare variables from Yarn script\n                // This makes sure indialogue variables are initialized as well as out of dialogue ones\n                that.autodeclareVariables(itemdata.fictionyarn, that.storydata);\n\n                // Set all the data for Yarn\n                var yarnopts = {\n                    \"dialogue\": itemdata.fictionyarn,\n                    \"combineTextAndOptionsResults\": true,\n                    \"startAt\": \"Start\",\n                    \"variableStorage\": that.storydata,\n                    \"functions\": {\n                        dice: (sides) => {\n                            return Math.floor(Math.random() * sides) + 1;\n                        },\n                        visited: (nodeName) => {\n                            return that.visitednodes.includes(nodeName);\n                        },\n                        translate: (text) => {\n                            var randomId = Math.random().toString(36).substring(2, 9);\n                            var updateStory = function (themessage) {\n                                var el = $(\"#ml-f-\" + randomId);\n                                if (el.length) {\n                                    el.html(themessage);\n                                } else {\n                                    setTimeout(updateStory, 100, themessage);\n                                }\n                            };\n                            that.call_translate(that.sourceLang, that.destLang, text, updateStory);\n                            return \"<span id='ml-f-\" + randomId + \"' class='ml-f-inline-translated-text'></span>\";\n                        }\n                    }\n                };\n\n                log.debug('MiniLesson Fiction: initializing yarnbound with options');\n                log.debug(yarnopts);\n                try {\n                    that.runner = new YarnBound(yarnopts);\n                    that.do_render();\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \";\n                    // Format the error nicely\n                    let errorMessage = e.message;\n                    if (typeof errorMessage === 'undefined') {\n                        // If err is not an Error object (e.g. a string), use err directly\n                        errorMessage = e ? String(e) : 'syntax or other error';\n                    }\n                    userFriendlyError += errorMessage;\n                    that.controls.yarncontainer.html(\n                        '<div class=\"alert alert-danger\">' + userFriendlyError + '</div>'\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n            });\n        },\n\n        /**\n         * Initialize strings\n         */\n        init_strings: function () {\n            var self = this;\n            str.get_strings([\n                {\n                    \"key\": \"nextlessonitem\",\n                    \"component\": 'mod_minilesson'\n                },\n                {\n                    \"key\": \"confirm_desc\",\n                    \"component\": 'mod_minilesson'\n                },\n                {\n                    \"key\": \"yes\",\n                    \"component\": 'moodle'\n                },\n                {\n                    \"key\": \"no\",\n                    \"component\": 'moodle'\n                },\n                {\n                    \"key\": \"downloadtranslationmodel\",\n                    \"component\": 'mod_minilesson'\n                },\n                {\n                    \"key\": \"downloadtranslationmodel_desc\",\n                    \"component\": 'mod_minilesson'\n                },\n                {\n                    \"key\": \"download\",\n                    \"component\": 'mod_minilesson'\n                },\n                {\n                    \"key\": \"skip\",\n                    \"component\": 'mod_minilesson'\n                },\n                {\n                    \"key\": \"downloadingtranslator\",\n                    \"component\": 'mod_minilesson'\n                },\n            ]).done(function (s) {\n                var i = 0;\n                self.strings.nextlessonitem = s[i++];\n                self.strings.confirm_desc = s[i++];\n                self.strings.yes = s[i++];\n                self.strings.no = s[i++];\n                self.strings.downloadtranslationmodel = s[i++];\n                self.strings.downloadtranslationmodel_desc = s[i++];\n                self.strings.download = s[i++];\n                self.strings.skip = s[i++];\n                self.strings.downloadingtranslator = s[i++];\n            });\n        },\n\n        /**\n         * Prepare HTML elements\n         *\n         * @param {object} itemdata\n         */\n        prepare_html: function (itemdata) {\n            this.controls.yarncontainer = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_yarncontainer\");\n            this.controls.yarntext = this.controls.yarncontainer.find('.minilesson_fiction_yarntext');\n            this.controls.yarnmedia = this.controls.yarncontainer.find('.minilesson_fiction_yarnmedia');\n            this.controls.yarnoptions = this.controls.yarncontainer.find('.minilesson_fiction_yarnoptions');\n            this.controls.yarncontinuebutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_continuebutton\");\n            if (this.presentationmode === 'storymode') {\n                this.controls.chatwrapper = $(\"#\" + itemdata.uniqueid + \"_container .story-wrapper\");\n            } else {\n                this.controls.chatwrapper = $(\"#\" + itemdata.uniqueid + \"_container .chat-wrapper\");\n            }\n            // To speed up rendering later prefetch some templates\n            Templates.prefetchTemplates(['mod_minilesson/fiction_playermessage']);\n        },\n\n        /**\n         * Render the current content\n         *\n         * @param {object} currentResult\n         */\n        do_render: function (currentResult) {\n            currentResult = this.runner.currentResult;\n            currentResult = this.add_metadata(currentResult);\n            log.debug('MiniLesson Fiction: doing render of currentResult');\n            log.debug(currentResult);\n\n            if (currentResult && currentResult.metadata && currentResult.metadata.title) {\n                const title = currentResult.metadata.title;\n                if (!this.visitednodes.includes(title)) {\n                    this.visitednodes.push(title);\n                }\n            }\n\n            var that = this;\n            this.can_continuebutton(false);\n            this.controls.yarnoptions.html('');\n\n            var yarncontent = {\n                'yarntext': false,\n                'yarnoptions': false\n            };\n\n            if (currentResult instanceof YarnBound.TextResult) {\n                yarncontent.yarntext = currentResult;\n                this.chatdata.picturesrc = yarncontent.yarntext.md?.character?.picturesrc;\n                this.chatdata.charactername = yarncontent.yarntext.md?.character?.name;\n                this.chatdata.charactertext = yarncontent.yarntext.text;\n\n                this.post_message_to_story(this.chatdata, currentResult);\n\n            } else if (currentResult instanceof YarnBound.OptionsResult) {\n                yarncontent.yarnoptions = currentResult;\n                var chatdata = {\n                    'yarnoptions': currentResult,\n                    'presention_mobilechat': that.itemdata.presention_mobilechat,\n                    'presention_storymode': that.itemdata.presention_storymode,\n                    'presention_plain': that.itemdata.presention_plain,\n                    'shownonoptions': that.itemdata.shownonoptions,\n                };\n                var waittime = 1000;\n                if (that.itemdata.presention_mobilechat) {\n                    waittime = 1500;\n                } else if (that.itemdata.presention_storymode) {\n                    waittime = 50;\n                }\n                Templates.render('mod_minilesson/fictionyarnoptions', chatdata).then(\n                    function (html, js) {\n                        setTimeout(() => {\n                            that.controls.yarnoptions.html(html);\n                            Templates.runTemplateJS(js);\n                        }, waittime);\n                    }\n                );\n\n\n                if ('text' in yarncontent.yarnoptions) {\n                    that.chatdata.picturesrc = yarncontent.yarnoptions.md?.character?.picturesrc;\n                    that.chatdata.charactername = yarncontent.yarnoptions.md?.character?.name;\n                    that.chatdata.charactertext = yarncontent.yarnoptions.text;\n                    this.post_message_to_story(this.chatdata, currentResult, false);\n                } else {\n                    that.controls.yarntext.html('');\n                }\n            } else if (currentResult instanceof YarnBound.CommandResult) {\n                // Process the command string a little. so we have command name and args\n                // eg \"picture 1.png\"\n                var rawCommand = currentResult.command;\n                var parts = rawCommand.split(' ');\n                var commandName = parts[0]; // \"picture\" \"audio etc\"\n                var args = parts.slice(1); // [\"1.png\"]\n                let promise = null;\n                var cancel_runner_advance = false;\n\n                switch (commandName) {\n                    case 'picture': {\n                        log.debug('got picture command');\n                        const imageURL = args[0];\n                        //check imageURL is in filenamesmap\n                        var theimage = that.filenamesmap.find(function (file) {\n                            return file.fileurl === imageURL;\n                        });\n                        if (theimage) {\n                            promise = Templates.render('mod_minilesson/fictionyarnimage', {\n                                \"imageurl\": imageURL\n                            }).then(\n                                function (html, js) {\n                                    that.controls.yarnmedia.html(html);\n                                    that.chatdata.charactermedia = html;\n                                    that.chatdata.classname = 'hasmedia';\n                                    Templates.runTemplateJS(js);\n                                }\n                            );\n                        }\n                        break;\n                    }\n                    case 'audio': {\n                        log.debug('got audio command');\n                        const audioURL = args[0];\n                        // Check audio file exists\n                        var theaudio = that.filenamesmap.find(function (file) {\n                            return file.fileurl === audioURL;\n                        });\n                        if (theaudio) {\n                            promise = Templates.render('mod_minilesson/fictionyarnaudio', {\n                                \"audiourl\": audioURL\n                            }).then(\n                                function (html, js) {\n                                    that.chatdata.charactermedia = html;\n                                    that.chatdata.classname = 'hasmedia';\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                }\n                            );\n                        }\n                        break;\n                    }\n                    case 'video': {\n                        log.debug('got video command');\n                        const videoURL = args[0];\n                        // Check video file exists\n                        var thevideo = that.filenamesmap.find(function (file) {\n                            return file.fileurl === videoURL;\n                        });\n                        if (thevideo) {\n                            promise = Templates.render('mod_minilesson/fictionyarnvideo', {\n                                \"videourl\": videoURL\n                            }).then(\n                                function (html, js) {\n                                    that.chatdata.charactermedia = html;\n                                    that.chatdata.classname = 'hasmedia';\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                }\n                            );\n                        }\n                        break;\n                    }\n                    case 'clearpicture': {\n                        that.controls.yarnmedia.html('');\n                        break;\n                    }\n                    case 'translate': {\n                        log.debug('got translate command');\n                        const text = args.join(' ');\n                        cancel_runner_advance = true;\n\n                        const sourceLang = that.sourceLang;\n                        const destLang = that.destLang;\n\n                        let progressPromise = null;\n                        const messageCallback = function (message) {\n                            // If this is a progress update we try to find the existing div\n                            // This is because we will get 100s of messages and do not want hundreds\n                            // of divs in the story area\n                            if (message.indexOf('translation-download-progress') !== -1) {\n                                if (progressPromise) {\n                                    progressPromise.then(() => {\n                                        var progressDiv = that.controls.chatwrapper.find('.translation-download-progress').last();\n                                        if (progressDiv.length > 0) {\n                                            progressDiv.html(message);\n                                        }\n                                    });\n                                    return;\n                                }\n                                progressPromise = that.post_message_to_story({\n                                    charactermedia: message\n                                }, currentResult, false);\n                                return;\n                            }\n\n                            // For regular messages (translations), ensure they are posted after any progress\n                            let p = progressPromise || Promise.resolve();\n                            p.then(() => {\n                                that.post_message_to_story({\n                                    charactermedia: message\n                                }, currentResult, true);\n                                progressPromise = null;\n                            });\n                        };\n\n                        this.call_translate(sourceLang, destLang, text, messageCallback);\n                        break;\n                    }\n                    case 'blahblah':\n                    default:\n                }\n                // In all cases just do command and then jump to next line\n                if (!currentResult.isDialogueEnd && !cancel_runner_advance) {\n                    // Just skip through for now\n                    if (promise) {\n                        promise.then(() => {\n                            that.do_runner_advance();\n                            that.do_render();\n                        });\n                    } else {\n                        that.do_runner_advance();\n                        that.do_render();\n                    }\n                }\n            } else {\n                log.debug('MiniLesson Fiction: unknown yarn result type');\n            }\n\n            // In all cases on dialog end there is no continue\n            if (currentResult.isDialogueEnd) {\n                this.can_continuebutton(false);\n                this.storycomplete = true;\n                // If there is a score we retrieve it\n                if (this.storydata.has('score')) {\n                    this.storyscore = this.storydata.get('score');\n                    // If it is numeric, round it\n                    if (!isNaN(this.storyscore)) {\n                        this.storyscore = Math.round(this.storyscore);\n                        if (this.storyscore < 0) {\n                            this.storyscore = 0;\n                        } else if (this.storyscore > 100) {\n                            this.storyscore = 100;\n                        }\n                    } else {\n                        this.storyscore = false;\n                    }\n                }\n            }\n        },\n\n        post_message_to_story: function (messagedata, currentResult, showContinue = true) {\n            var that = this;\n            if (that.presentationmode === 'storymode') {\n                return Templates.render('mod_minilesson/fiction_storymessage', {\n                    charactermedia: '<div class=\"chat-loader\"></div>'\n                }).then(function (html, js) {\n                    Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                    that.scrolltobottom();\n                    return Templates.render('mod_minilesson/fiction_storymessage', messagedata).then(\n                        function (html, js) {\n                            // In storymode we replace the loader with the real content\n                            // finding the last story-paragraph\n                            Templates.replaceNode(\n                                that.controls.chatwrapper.find('.story-paragraph').last(),\n                                html,\n                                js\n                            );\n                            that.scrolltobottom();\n                            that.reset_chat_data();\n                            if (showContinue && currentResult && !currentResult.isDialogueEnd) {\n                                if (that.flowthroughmode) {\n                                    that.do_runner_advance();\n                                    that.do_render();\n                                } else {\n                                    that.can_continuebutton(true);\n                                }\n\n                            }\n                        }\n                    );\n                });\n            } else {\n                return Templates.render('mod_minilesson/fiction_charactermessage', {\n                    charactermedia: '<div class=\"chat-loader\"></div>'\n                }).then(function (html, js) {\n                    Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                    that.scrolltobottom();\n                    var waittime = 1000;\n                    if (that.itemdata.presention_mobilechat) {\n                        waittime = 1500;\n                    } else if (that.itemdata.presention_storymode) {\n                        waittime = 50;\n                    }\n                    return new Promise((resolve) => {\n                        setTimeout(() => {\n                            Templates.render('mod_minilesson/fiction_charactermessage', messagedata).then(\n                                function (html, js) {\n                                    Templates.replaceNode(\n                                        that.controls.chatwrapper.find('> .chat-window').last(),\n                                        html,\n                                        js\n                                    );\n                                    that.scrolltobottom();\n                                    that.reset_chat_data();\n                                    if (showContinue && currentResult && !currentResult.isDialogueEnd) {\n                                        if (that.flowthroughmode) {\n                                            that.do_runner_advance();\n                                            that.do_render();\n                                        } else {\n                                            that.can_continuebutton(true);\n                                        }\n\n                                    }\n                                    resolve();\n                                }\n                            );\n                        }, waittime);\n                    });\n                });\n            }\n        },\n\n        call_translate: function (sourceLang, destLang, text, messageCallback) {\n            var that = this;\n            // Check if we already have a session\n            if (translate.session && translate.sourceLang === sourceLang && translate.destLang === destLang) {\n                log.debug('Using existing translation session');\n\n                translate.translate(text).then((translation) => {\n                    if (translation) {\n                        messageCallback(translation);\n                    } else {\n                        log.debug('translation failed');\n                    }\n                }).catch((e) => {\n                    log.error(\"Translation error: \" + e);\n                });\n                return;\n            }\n\n            // Check availability first\n            translate.check_availability(sourceLang, destLang).then((status) => {\n                log.debug('Translation availability: ' + status);\n\n                if (status === 'unavailable') {\n                    messageCallback(\"translation not available for this language pair: \" + sourceLang + \" -> \" + destLang);\n                    log.debug('Translation not available for this language pair');\n                    return;\n                }\n\n                if (status === 'download_needed') {\n                    // Show popup to ask user to download model\n                    notification.confirm(\n                        that.strings.downloadtranslationmodel,\n                        that.strings.downloadtranslationmodel_desc,\n                        that.strings.download,\n                        that.strings.skip,\n                        function () {\n                            log.debug('User clicked \"Download\" creating session');\n                            // User clicked \"Download\" - this provides the required gesture\n\n                            // Show initial progress\n                            var progressMessage = that.strings.downloadingtranslator.replace('{$a}', '0');\n                            messageCallback('<div class=\"translation-download-progress\">' + progressMessage + '</div>');\n\n                            translate.create_session(sourceLang, destLang, function (percent) {\n                                var updatedMessage = that.strings.downloadingtranslator.replace('{$a}', percent);\n                                messageCallback('<div class=\"translation-download-progress\">' + updatedMessage + '</div>');\n                            }).then((success) => {\n                                if (success) {\n                                    return translate.translate(text);\n                                } else {\n                                    log.error('Failed to create translation session');\n                                    return null;\n                                }\n                            }).then((translation) => {\n                                if (translation) {\n                                    messageCallback(translation);\n                                }\n                            }).catch((e) => {\n                                log.error(\"Translation error: \" + e);\n                            });\n                        },\n                        function () {\n                            // User clicked \"Skip\"\n                            log.debug('User skipped translation model download');\n                            messageCallback(\"translation model not downloaded\");\n                        }\n                    );\n                } else if (status === 'ready') {\n                    // Model already available, create session and translate\n                    translate.create_session(sourceLang, destLang).then(() => {\n                        return translate.translate(text);\n                    }).then((translation) => {\n                        if (translation) {\n                            messageCallback(translation);\n                        } else {\n                            log.debug('translation failed');\n                        }\n                    }).catch((e) => {\n                        log.error(\"Translation error: \" + e);\n                    });\n                }\n            });\n        },\n\n        /**\n         * Advance the yarn runner\n         *\n         * @param {int} steps\n         */\n        do_runner_advance: function (steps) {\n            try {\n                if (steps !== null) {\n                    this.runner.advance(steps);\n                } else {\n                    this.runner.advance();\n                }\n            } catch (e) {\n                var userFriendlyError = \"Yarn Parse Error: \";\n                if (this.runner && this.runner.currentResult && this.runner.currentResult.metadata && this.runner.currentResult.metadata.title) {\n                    userFriendlyError += \"(Node: \" + this.runner.currentResult.metadata.title + \" or maybe the node you are jumping to) \";\n                }\n                // Format the error nicely\n                let errorMessage = e.message;\n                if (typeof errorMessage === 'undefined') {\n                    // If err is not an Error object (e.g. a string), use err directly\n                    errorMessage = e ? String(e) : 'syntax or other error';\n                }\n                userFriendlyError += errorMessage;\n                this.controls.yarncontainer.html(\n                    '<div class=\"alert alert-danger\">' + userFriendlyError + '</div>'\n                );\n                log.error(\"Full Yarn Error:\");\n                log.error(e);\n            }\n        },\n\n        /**\n         * Enable/disable continue button\n         *\n         * @param {bool} cancontinue\n         */\n        can_continuebutton: function (cancontinue) {\n            this.controls.yarncontinuebutton.prop(\"disabled\", !cancontinue);\n            if (cancontinue) {\n                this.controls.yarncontinuebutton.show();\n            } else {\n                this.controls.yarncontinuebutton.hide();\n            }\n        },\n\n        /**\n         * Move to next question\n         */\n        next_question: function () {\n            var self = this;\n            var stepdata = {};\n            stepdata.index = self.index;\n            stepdata.hasgrade = true;\n\n            // If the story has a score, use it\n            if (self.storyscore !== false) {\n                stepdata.grade = self.storyscore;\n                stepdata.totalitems = 100;\n                stepdata.correctitems = self.storyscore;\n            } else {\n                stepdata.correctitems = 1;\n                stepdata.totalitems = 1;\n                stepdata.grade = 100;\n            }\n            self.quizhelper.do_next(stepdata);\n        },\n\n        /**\n         * Preload images\n         */\n        preload_images: function () {\n            if (this.filenamesmap && this.filenamesmap.length > 0) {\n                log.debug('MiniLesson Fiction: Preloading ' + this.filenamesmap.length + ' images');\n                this.filenamesmap.forEach(function (file) {\n                    if (file.fileurl) {\n                        var img = new Image();\n                        img.src = file.fileurl;\n                    }\n                });\n            }\n        },\n\n        /**\n         * Register events\n         *\n         * @param {int} index\n         * @param {object} itemdata\n         * @param {object} quizhelper\n         */\n        register_events: function (index, itemdata, quizhelper) {\n            var self = this;\n            // When click next button, report and leave it up to parent to deal with it.\n            $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function () {\n                if (!self.storycomplete) {\n                    notification.confirm(\n                        self.strings.nextlessonitem,\n                        self.strings.confirm_desc,\n                        self.strings.yes,\n                        self.strings.no,\n                        function () {\n                            self.next_question();\n                        }\n                    );\n                } else {\n                    self.next_question();\n                }\n            });\n            $(\"#\" + itemdata.uniqueid + \"_container\").on(\"showElement\", async () => {\n                if (!self.instance) {\n                    // Maybe init yarn-bound here\n                    // this.do_render();\n                }\n\n                if (itemdata.timelimit > 0) {\n                    $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                    $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                    $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                        height: '5px',\n                        timeLimit: itemdata.timelimit,\n                        onFinish: function () {\n                            $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").trigger('click');\n                        }\n                    });\n                }\n            });\n\n            this.controls.yarncontinuebutton.on('click', function (e) {\n                log.debug('MiniLesson Fiction: yarn continue button clicked');\n                e.preventDefault();\n                // No need to show the \"continue\" text\n                self.do_runner_advance();\n                self.do_render();\n            });\n\n            // Add an event listener for option buttons that handles option buttons added at runtime\n            this.controls.yarncontainer.on('click', '.minilesson_fiction_optionbutton', function (e) {\n                log.debug('MiniLesson Fiction: yarn option button clicked');\n                e.preventDefault();\n\n                var buttons = self.controls.yarncontainer.find('.minilesson_fiction_optionbutton');\n                var optionindex = $(this).data('optionindex');\n                const playertext = $(this).text().trim();\n                if (self.presentationmode === 'storymode') {\n                    Templates.render('mod_minilesson/fiction_storyplayermessage', {\n                        playertext: playertext\n                    }).then(\n                        function (html, js) {\n                            Templates.appendNodeContents(self.controls.chatwrapper, html, js);\n                            self.do_runner_advance(optionindex);\n                            self.do_render();\n                        }\n                    );\n                } else {\n                    Templates.render('mod_minilesson/fiction_playermessage', {\n                        playertext: playertext\n                    }).then(\n                        function (html, js) {\n                            Templates.appendNodeContents(self.controls.chatwrapper, html, js);\n                            self.do_runner_advance(optionindex);\n                            self.do_render();\n                        }\n                    );\n                }\n            });\n\n            let scrollbtn = $(\"#\" + itemdata.uniqueid + \"_container #scroll-bottom-btn\");\n\n            this.controls.chatwrapper.on(\"scroll\", function () {\n                const chatwrapper = self.controls.chatwrapper[0];\n                const isatbottom = chatwrapper.scrollHeight - chatwrapper.scrollTop <= chatwrapper.clientHeight + 5;\n                if (isatbottom) {\n                    scrollbtn.hide();\n                } else {\n                    scrollbtn.show();\n                }\n            });\n\n            scrollbtn.on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                self.controls.chatwrapper.animate({\n                    scrollTop: self.controls.chatwrapper[0].scrollHeight\n                }, 'smooth');\n            });\n        },\n\n        /**\n         * Scans a Yarn string for <<declare>> statements and populates a Map.\n         * @param {string} yarnText - The raw Yarn story string.\n         * @param {Map} storageMap - Your yarn-bound variableStorage Map.\n         */\n        autodeclareVariables: function (yarnText, storageMap) {\n            // Regex matches: <<declare $variableName = value>>\n            // Captures group 1: variableName, group 2: value\n            const declareRegex = /<<declare\\s+\\$([\\w\\d_]+)\\s*=\\s*(.*?)>>/g;\n            let match;\n\n            while ((match = declareRegex.exec(yarnText)) !== null) {\n                let varName = match[1];\n                let rawValue = match[2].trim();\n                let finalValue;\n\n                // Type conversion: numbers, booleans, or strings\n                if (!isNaN(rawValue)) {\n                    finalValue = Number(rawValue);\n                } else if (rawValue === \"true\") {\n                    finalValue = true;\n                } else if (rawValue === \"false\") {\n                    finalValue = false;\n                } else {\n                    // Remove quotes if it's a string literal\n                    finalValue = rawValue.replace(/^[\"']|[\"']$/g, '');\n                }\n\n                storageMap.set(varName, finalValue);\n            }\n        },\n\n        /**\n         * Add metadata to results\n         *\n         * @param {object} currentthing\n         */\n        add_metadata: function (currentthing) {\n            if (currentthing && 'markup' in currentthing && Array.isArray(currentthing.markup)) {\n                currentthing.md = {};\n                // For each markup entry, add the property name and values object to currentthing\n                currentthing.markup.forEach(function (entry) {\n                    if ('properties' in entry && 'name' in entry) {\n                        currentthing.md[entry.name] = entry.properties;\n                    }\n                });\n                if (currentthing.md.character?.name) {\n                    const charname = currentthing.md.character.name.toLowerCase();\n                    currentthing.md.character.picturesrc = this.itemdata.filenamesmap\n                        .find(fileinfo => fileinfo.filekey === charname)?.fileurl || null;\n                }\n            }\n            return currentthing;\n        },\n\n        /**\n         * Register preview button\n         *\n         * @param {string} buttonid\n         */\n        register_previewbutton: function (buttonid) {\n            var previewbtn = document.getElementById(buttonid);\n            if (!previewbtn) {\n                return;\n            }\n            previewbtn.addEventListener('click', function (e) {\n                e.preventDefault();\n                var form = previewbtn.form;\n                if (!form) {\n                    return;\n                }\n                ModalFactory.create({\n                    type: ModalFactory.types.CANCEL,\n                    large: true,\n                    removeOnClose: true,\n                    templateContext: {\n                        classes: 'minilesson-fiction-preview-modal'\n                    },\n                    title: str.get_string('fiction:previewmodaltitle', 'mod_minilesson'),\n                    body: Fragment.loadFragment('mod_minilesson', 'preview_fiction', M.cfg.contextid, {\n                        formdata: new URLSearchParams([...new FormData(form).entries()]).toString()\n                    })\n                }).then(function (modal) {\n                    modal.getFooter().addClass('d-none');\n                    modal.show();\n                });\n                return;\n            });\n\n        },\n\n        reset_chat_data: function () {\n            this.chatdata = {\n                charactername: null,\n                charactermedia: null,\n                charactertext: null,\n                picturesrc: null,\n                playertext: null,\n            };\n        },\n\n        scrolltobottom: function () {\n            if (!this.controls.chatwrapper.length) {\n                return;\n            }\n            this.controls.chatwrapper.scrollTop(this.controls.chatwrapper[0].scrollHeight);\n            this.controls.chatwrapper.animate({\n                scrollTop: this.controls.chatwrapper[0].scrollHeight + 5,\n                behavior: 'smooth'\n            });\n        },\n\n\n        /* Check yarn script for syntax errors\n         * @param {string} yarnContent - The raw Yarn story string.\n         * @param {string} resultscontainer - The id of thecontainer element to display results in. \n         */\n        syntaxcheck: function (yarnContent, resultscontainerid) {\n            const results = {\n                valid: true,\n                errors: []\n            };\n            var runner = null;\n            var storydata = new Map();\n            storydata.set('userfirstname', 'bob');\n            storydata.set('userlastname', 'smith');\n            storydata.set('userfullname', 'bob smith');\n            storydata.set('cantranslate', false);\n            // Auto-declare variables from Yarn script\n            // This makes sure indialogue variables are initialized as well as out of dialogue ones\n            this.autodeclareVariables(yarnContent, storydata);\n\n            // Set all the data for Yarn\n            var yarnopts = {\n                \"dialogue\": yarnContent,\n                \"combineTextAndOptionsResults\": true,\n                \"startAt\": \"Start\",\n                \"variableStorage\": storydata,\n            };\n            // Step 1: Initialize YarnBound\n            // This catches top-level errors (bad headers, duplicate titles, invalid declarations)\n            try {\n                var yarnBound = new YarnBound(yarnopts);\n            } catch (err) {\n                log.debug('Yarn initialization error: ' + err.message);\n                results.valid = false;\n                results.errors.push(`Initialization Error: ${err.message}`);\n            }\n            // Step 2 & 3: Iterate through nodes and check syntax\n            // We access the internal 'runner' to get the nodes list\n            if (results.valid) {\n                var runner = yarnBound.runner;\n                const nodeNames = Object.keys(runner.yarnNodes);\n                nodeNames.forEach(nodeName => {\n                    try {\n                        // getParserNodes parses the body text of the node.\n                        // It will throw if it encounters invalid Yarn syntax (e.g. invalid <<command>> or <<if>>)\n                        runner.getParserNodes(nodeName);\n                        // jump will also check variable state , but that is not syntax but we could do it\n                        // yarnBound.jump(nodeName);\n                    } catch (err) {\n                        results.valid = false;\n                        // Format the error nicely\n                        let errorMessage = err.message;\n                        if (typeof errorMessage === 'undefined') {\n                            // If err is not an Error object (e.g. a string), use err directly\n                            errorMessage = err ? String(err) : 'syntax or other error';\n                        }\n                        results.errors.push(`Node '${nodeName}': ${errorMessage}`);\n                    }\n                });\n            }\n\n            // Step 4: Display results\n            Templates.render('mod_minilesson/fiction_syntaxcheckresults', results)\n                .then(function (html, js) {\n                    $('#' + resultscontainerid).html(html);\n                });\n        }, // End syntaxcheck\n\n        register_syntaxcheckbutton: function (buttonid, yarneditorid, resultscontainerid) {\n            var syntaxcheckbtn = document.getElementById(buttonid);\n            var that = this;\n            if (!syntaxcheckbtn) {\n                return;\n            }\n            syntaxcheckbtn.addEventListener('click', function (e) {\n                e.preventDefault();\n                var yarntext = $('#' + yarneditorid).val();\n                that.syntaxcheck(yarntext, resultscontainerid);\n            });\n        },\n    } // End module\n});"],"names":["define","$","log","str","notification","def","translate","YarnBound","ModalFactory","Fragment","Templates","debug","runner","controls","itemdata","chatdata","storycomplete","storyscore","strings","presentationmode","index","quizhelper","storydata","visitednodes","clone","extend","this","init","that","init_strings","prepare_html","register_events","presention_mobilechat","presention_storymode","flowthroughmode","filenamesmap","preload_images","Map","set","userfirstname","userlastname","userfullname","sourceLang","language","substring","destLang","nativelanguage","check_availability","then","availability","autodeclareVariables","fictionyarn","yarnopts","dice","sides","Math","floor","random","visited","nodeName","includes","text","randomId","toString","updateStory","themessage","el","length","html","setTimeout","call_translate","do_render","e","userFriendlyError","errorMessage","message","String","yarncontainer","error","self","get_strings","done","s","i","nextlessonitem","confirm_desc","yes","no","downloadtranslationmodel","downloadtranslationmodel_desc","download","skip","downloadingtranslator","uniqueid","yarntext","find","yarnmedia","yarnoptions","yarncontinuebutton","chatwrapper","prefetchTemplates","currentResult","add_metadata","metadata","title","push","can_continuebutton","yarncontent","TextResult","picturesrc","md","_yarncontent$yarntext","character","_yarncontent$yarntext2","charactername","_yarncontent$yarntext3","_yarncontent$yarntext4","name","charactertext","post_message_to_story","OptionsResult","presention_plain","shownonoptions","waittime","render","js","runTemplateJS","_yarncontent$yarnopti","_yarncontent$yarnopti2","_yarncontent$yarnopti3","_yarncontent$yarnopti4","CommandResult","parts","command","split","commandName","args","slice","promise","cancel_runner_advance","imageURL","file","fileurl","charactermedia","classname","audioURL","videoURL","join","progressPromise","messageCallback","indexOf","progressDiv","last","Promise","resolve","isDialogueEnd","do_runner_advance","has","get","isNaN","round","messagedata","showContinue","appendNodeContents","scrolltobottom","replaceNode","reset_chat_data","session","translation","catch","status","confirm","progressMessage","replace","create_session","percent","updatedMessage","success","steps","advance","cancontinue","prop","show","hide","next_question","stepdata","hasgrade","grade","totalitems","correctitems","do_next","forEach","Image","src","on","async","instance","timelimit","progressTimer","height","timeLimit","onFinish","trigger","preventDefault","optionindex","data","playertext","trim","scrollbtn","scrollHeight","scrollTop","clientHeight","stopPropagation","animate","yarnText","storageMap","declareRegex","match","exec","finalValue","varName","rawValue","Number","currentthing","Array","isArray","markup","entry","properties","_currentthing$md$char","charname","toLowerCase","fileinfo","filekey","register_previewbutton","buttonid","previewbtn","document","getElementById","addEventListener","form","create","type","types","CANCEL","large","removeOnClose","templateContext","classes","get_string","body","loadFragment","M","cfg","contextid","formdata","URLSearchParams","FormData","entries","modal","getFooter","addClass","behavior","syntaxcheck","yarnContent","resultscontainerid","results","valid","errors","yarnBound","err","Object","keys","yarnNodes","getParserNodes","register_syntaxcheckbutton","yarneditorid","syntaxcheckbtn","val"],"mappings":"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"}