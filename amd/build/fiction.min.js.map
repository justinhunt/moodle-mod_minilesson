{"version":3,"file":"fiction.min.js","sources":["../src/fiction.js"],"sourcesContent":["define([\n    'jquery', 'core/log', 'mod_minilesson/definitions','mod_minilesson/yarn-bound',\n    'core/str', 'core/modal_factory', 'core/fragment','core/templates'\n],\n    function ($, log, def, YarnBound, Str, ModalFactory, Fragment, Templates) {\n        \"use strict\"; // jshint ;_;\n\n        /*\n       This file is to manage the fiction item type\n        */\n\n        log.debug('MiniLesson Fiction: initialising');\n\n        return {\n\n            runner: null,\n            controls: {},\n            itemdata: {},\n            mobilechatdata: {},\n\n            //for making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                this.prepare_html(itemdata);\n                this.register_events(index, itemdata, quizhelper);\n                var yarnopts = {\n                    \"dialogue\": itemdata.fictionyarn,\n                    \"combineTextAndOptionsResults\": true,\n                    \"startAt\": \"Start\"\n                };\n                log.debug('MiniLesson Fiction: initializing yarnbound with options');\n                log.debug(yarnopts);\n                try{\n                    this.runner = new YarnBound(yarnopts);\n                    this.do_render();\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \" + e.message;\n                    this.controls.yarncontainer.html(\n                        `<div class=\"alert alert-danger\">${userFriendlyError}</div>`\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n            },\n\n            prepare_html: function (itemdata) {\n                this.controls.yarncontainer = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_yarncontainer\");\n                this.controls.yarntext = this.controls.yarncontainer.find('.minilesson_fiction_yarntext');\n                this.controls.yarnmedia = this.controls.yarncontainer.find('.minilesson_fiction_yarnmedia');\n                this.controls.yarnoptions = this.controls.yarncontainer.find('.minilesson_fiction_yarnoptions');\n                this.controls.yarncontinuebutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_continuebutton\");\n                this.controls.chatwrapper = $(\"#\" + itemdata.uniqueid + \"_container .mobilechat .chat-wrapper\");\n                // To speed up rendering later prefetch some templates\n                Templates.prefetchTemplates(['mod_minilesson/fiction_playermessage']);\n            },\n/*\n            do_render: function () {\n                var that = this;\n                var yarncontent = {\n                    'yarntext': false,\n                    'yarnoptions': false\n                };\n\n                var currentResult = this.runner.currentResult;\n                currentResult = this.add_metadata(currentResult);\n                log.debug('MiniLesson Fiction: doing render of currentResult');\n                log.debug(currentResult);\n\n                if(currentResult instanceof YarnBound.TextResult) {\n                    // Render the text\n                    yarncontent.yarntext = currentResult;\n\n                    if (that.itemdata.presention_mobilechat) {\n                        that.can_continuebutton(false);\n                        that.mobilechatdata.picturesrc = yarncontent.yarntext.md?.character?.picturesrc;\n                        that.mobilechatdata.charactername = yarncontent.yarntext.md?.character?.name;\n                        that.mobilechatdata.charactertext = yarncontent.yarntext.text;\n                        Templates.render('mod_minilesson/fiction_charactermessage', {\n                            charactermedia: '<div class=\"chat-loader\"></div>'\n                        }).then(function(html,js) {\n                            Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                            that.scrolltobottom();\n                            setTimeout(() => {\n                                Templates.render('mod_minilesson/fiction_charactermessage', that.mobilechatdata).then(\n                                    function(html,js) {\n                                        Templates.replaceNode(\n                                            that.controls.chatwrapper.find('> .chat-window').last(),\n                                            html,\n                                            js\n                                        );\n                                        that.scrolltobottom();\n                                        const oldcharactermedia = that.mobilechatdata.charactermedia;\n                                        that.reset_mobilechat_data();\n                                        that.mobilechatdata.charactermedia = oldcharactermedia;\n                                        // Enable the continue button\n                                        if (!currentResult.isDialogueEnd) {\n                                            that.can_continuebutton(true);\n                                        }\n                                    }\n                                );\n                            }, 2000);\n                        });\n                        that.controls.yarnoptions.html('');\n                    }else {\n                        Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarntext).then(\n                        function (html, js) {\n                            that.controls.yarntext.html(html);\n                            that.controls.yarnoptions.html('');\n                            Templates.runTemplateJS(js);\n                        });\n                        // Enable the continue button\n                        this.can_continuebutton(true);\n                    }\n                } else if(currentResult instanceof YarnBound.OptionsResult) {\n                    // Render the options\n                    yarncontent.yarnoptions = currentResult;\n                    if (that.itemdata.presention_mobilechat) {\n                        var mobilechatdata = {\n                            'yarnoptions': currentResult,\n                            'presention_mobilechat': true,\n                        };\n                        that.controls.yarnoptions.html('');\n                    } else {\n                        var mobilechatdata = currentResult;\n                    }\n                    Templates.render('mod_minilesson/fictionyarnoptions', mobilechatdata).then(\n                    function (html, js) {\n                        setTimeout(() => {\n                            that.controls.yarnoptions.html(html);\n                            Templates.runTemplateJS(js);\n                        }, that.itemdata.presention_mobilechat ? 2000 : 1);\n                    });\n\n                    //If there is some text as well render that, or clear the existing text otherwise\n                    if ('text' in yarncontent.yarnoptions) {\n\n                        if (that.itemdata.presention_mobilechat) {\n                            that.mobilechatdata.picturesrc = yarncontent.yarnoptions.md?.character?.picturesrc;\n                            that.mobilechatdata.charactername = yarncontent.yarnoptions.md?.character?.name;\n                            that.mobilechatdata.charactertext = yarncontent.yarnoptions.text;\n\n                            Templates.render('mod_minilesson/fiction_charactermessage', {\n                                charactermedia: '<div class=\"chat-loader\"></div>'\n                            }).then(function(html,js) {\n                                Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                                that.scrolltobottom();\n                                setTimeout(() => {\n                                    Templates.render('mod_minilesson/fiction_charactermessage', that.mobilechatdata).then(\n                                        function(html,js) {\n                                            Templates.replaceNode(\n                                                that.controls.chatwrapper.find('> .chat-window').last(),\n                                                html,\n                                                js\n                                            );\n                                            that.scrolltobottom();\n                                            const oldcharactermedia = that.mobilechatdata.charactermedia;\n                                            that.reset_mobilechat_data();\n                                            that.mobilechatdata.charactermedia = oldcharactermedia;\n                                        }\n                                    );\n                                }, 2000);\n                            });\n                        } else {\n                            Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarnoptions).then(\n                            function (html, js) {\n                                that.controls.yarntext.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                        }\n                    } else {\n                        that.controls.yarntext.html('');\n                    }\n\n                    // Disable the continue button, because they need to select an option\n                    that.can_continuebutton(false);\n\n                } else if (currentResult instanceof YarnBound.CommandResult) {\n                    // Process the command string a little. so we have command name and args\n                    //eg \"picture 1.png\"\n                    var rawCommand = currentResult.command;\n                    var parts = rawCommand.split(' ');\n                    var commandName = parts[0]; // \"picture\" \"audio etc\"\n                    var args = parts.slice(1); // [\"1.png\"]\n                    let promise = null;\n\n\n                    switch(commandName) {\n                        case 'picture': {\n                            log.debug('got picture command');\n                            const imageURL = args[0]; // \"picture https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnimage', {\"imageurl\": imageURL}).then(\n                            function (html, js) {\n                                that.controls.yarnmedia.html(html);\n                                if (that.itemdata.presention_mobilechat) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                }\n                                Templates.runTemplateJS(js);\n                            });\n                            break;\n                        }\n                        case 'audio': {\n                            log.debug('got audio command');\n                            const audioURL = args[0]; // \"audio https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnaudio', {\"audiourl\": audioURL}).then(\n                            function (html, js) {\n                                if (that.itemdata.presention_mobilechat) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                }\n                                that.controls.yarnmedia.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                            break;\n                        }\n                        case 'video': {\n                            log.debug('got video command');\n                            const videoURL = args[0]; // \"video https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnvideo', {\"videourl\": videoURL}).then(\n                            function (html, js) {\n                                if (that.itemdata.presention_mobilechat) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                }\n                                that.controls.yarnmedia.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                            break;\n                        }\n                        case 'clearpicture': {\n                            that.controls.yarnmedia.html('');\n                            break;\n                        }\n                        case 'blahblah':\n                        default:\n                    }\n                    // In all cases just do command and then jump to next line\n                    if(!currentResult.isDialogueEnd) {\n                        // Just skip through for now\n                        if (promise) {\n                            promise.then(() => {\n                                that.do_runner_advance();\n                                that.do_render();\n                            });\n                        } else {\n                            that.do_runner_advance();\n                            that.do_render();\n                        }\n                        return;\n                    }\n                } else {\n                    log.debug('MiniLesson Fiction: unknown yarn result type');\n                }\n\n                 // In all cases on dialog end there is no continue\n                if(currentResult.isDialogueEnd) {\n                    that.can_continuebutton(false);\n                    return;\n                }\n            },\n            */\n\n            do_render: function () {\n                var currentResult = this.runner.currentResult;\n                currentResult = this.add_metadata(currentResult);\n                log.debug('MiniLesson Fiction: doing render of currentResult');\n                log.debug(currentResult);\n\n                if (this.itemdata.presention_mobilechat) {\n                    this.do_render_mobilechat(currentResult);\n                } else {\n                    this.do_render_plain(currentResult);\n                }\n\n                // In all cases on dialog end there is no continue\n                if (currentResult.isDialogueEnd) {\n                    this.can_continuebutton(false);\n                }\n            },\n\n            do_render_mobilechat: function (currentResult) {\n                var that = this;\n                var yarncontent = {\n                    'yarntext': false,\n                    'yarnoptions': false\n                };\n\n                if (currentResult instanceof YarnBound.TextResult) {\n                    yarncontent.yarntext = currentResult;\n                    this.can_continuebutton(false);\n                    this.mobilechatdata.picturesrc = yarncontent.yarntext.md?.character?.picturesrc;\n                    this.mobilechatdata.charactername = yarncontent.yarntext.md?.character?.name;\n                    this.mobilechatdata.charactertext = yarncontent.yarntext.text;\n\n                    Templates.render('mod_minilesson/fiction_charactermessage', {\n                        charactermedia: '<div class=\"chat-loader\"></div>'\n                    }).then(function (html, js) {\n                        Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                        that.scrolltobottom();\n                        setTimeout(() => {\n                            Templates.render('mod_minilesson/fiction_charactermessage', that.mobilechatdata).then(\n                                function (html, js) {\n                                    Templates.replaceNode(\n                                        that.controls.chatwrapper.find('> .chat-window').last(),\n                                        html,\n                                        js\n                                    );\n                                    that.scrolltobottom();\n                                    const oldcharactermedia = that.mobilechatdata.charactermedia;\n                                    that.reset_mobilechat_data();\n //                                   that.mobilechatdata.charactermedia = oldcharactermedia;\n                                    if (!currentResult.isDialogueEnd) {\n                                        that.can_continuebutton(true);\n                                    }\n                                }\n                            );\n                        }, 2000);\n                    });\n                    that.controls.yarnoptions.html('');\n                } else if (currentResult instanceof YarnBound.OptionsResult) {\n                    yarncontent.yarnoptions = currentResult;\n                    var mobilechatdata = {\n                        'yarnoptions': currentResult,\n                        'presention_mobilechat': true,\n                    };\n                    that.controls.yarnoptions.html('');\n                    Templates.render('mod_minilesson/fictionyarnoptions', mobilechatdata).then(\n                        function (html, js) {\n                            setTimeout(() => {\n                                that.controls.yarnoptions.html(html);\n                                Templates.runTemplateJS(js);\n                            }, 2000);\n                        });\n\n                    if ('text' in yarncontent.yarnoptions) {\n                        that.mobilechatdata.picturesrc = yarncontent.yarnoptions.md?.character?.picturesrc;\n                        that.mobilechatdata.charactername = yarncontent.yarnoptions.md?.character?.name;\n                        that.mobilechatdata.charactertext = yarncontent.yarnoptions.text;\n\n                        Templates.render('mod_minilesson/fiction_charactermessage', {\n                            charactermedia: '<div class=\"chat-loader\"></div>'\n                        }).then(function (html, js) {\n                            Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                            that.scrolltobottom();\n                            setTimeout(() => {\n                                Templates.render('mod_minilesson/fiction_charactermessage', that.mobilechatdata).then(\n                                    function (html, js) {\n                                        Templates.replaceNode(\n                                            that.controls.chatwrapper.find('> .chat-window').last(),\n                                            html,\n                                            js\n                                        );\n                                        that.scrolltobottom();\n                                        const oldcharactermedia = that.mobilechatdata.charactermedia;\n                                        that.reset_mobilechat_data();\n //                                       that.mobilechatdata.charactermedia = oldcharactermedia;\n                                    }\n                                );\n                            }, 2000);\n                        });\n                    } else {\n                        that.controls.yarntext.html('');\n                    }\n                    that.can_continuebutton(false);\n\n                } else if (currentResult instanceof YarnBound.CommandResult) {\n                    // Process the command string a little. so we have command name and args\n                    //eg \"picture 1.png\"\n                    var rawCommand = currentResult.command;\n                    var parts = rawCommand.split(' ');\n                    var commandName = parts[0]; // \"picture\" \"audio etc\"\n                    var args = parts.slice(1); // [\"1.png\"]\n                    let promise = null;\n\n\n                    switch(commandName) {\n                        case 'picture': {\n                            log.debug('got picture command');\n                            const imageURL = args[0]; // \"picture https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnimage', {\"imageurl\": imageURL}).then(\n                                function (html, js) {\n                                    that.controls.yarnmedia.html(html);\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                    Templates.runTemplateJS(js);\n                                });\n                            break;\n                        }\n                        case 'audio': {\n                            log.debug('got audio command');\n                            const audioURL = args[0]; // \"audio https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnaudio', {\"audiourl\": audioURL}).then(\n                                function (html, js) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                });\n                            break;\n                        }\n                        case 'video': {\n                            log.debug('got video command');\n                            const videoURL = args[0]; // \"video https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnvideo', {\"videourl\": videoURL}).then(\n                                function (html, js) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                });\n                            break;\n                        }\n                        case 'clearpicture': {\n                            that.controls.yarnmedia.html('');\n                            break;\n                        }\n                        case 'blahblah':\n                        default:\n                    }\n                    // In all cases just do command and then jump to next line\n                    if(!currentResult.isDialogueEnd) {\n                        // Just skip through for now\n                        if (promise) {\n                            promise.then(() => {\n                                that.do_runner_advance();\n                                that.do_render();\n                            });\n                        } else {\n                            that.do_runner_advance();\n                            that.do_render();\n                        }\n                    }\n                } else {\n                    log.debug('MiniLesson Fiction: unknown yarn result type');\n                }\n            },\n\n            do_render_plain: function (currentResult) {\n                var that = this;\n                var yarncontent = {\n                    'yarntext': false,\n                    'yarnoptions': false\n                };\n\n                if (currentResult instanceof YarnBound.TextResult) {\n                    yarncontent.yarntext = currentResult;\n                    Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarntext).then(\n                        function (html, js) {\n                            that.controls.yarntext.html(html);\n                            that.controls.yarnoptions.html('');\n                            Templates.runTemplateJS(js);\n                        });\n                    this.can_continuebutton(true);\n                } else if (currentResult instanceof YarnBound.OptionsResult) {\n                    yarncontent.yarnoptions = currentResult;\n                    Templates.render('mod_minilesson/fictionyarnoptions', yarncontent.yarnoptions).then(\n                        function (html, js) {\n                            that.controls.yarnoptions.html(html);\n                            Templates.runTemplateJS(js);\n                        });\n\n                    if ('text' in yarncontent.yarnoptions) {\n                        Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarnoptions).then(\n                            function (html, js) {\n                                that.controls.yarntext.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                    } else {\n                        that.controls.yarntext.html('');\n                    }\n                    that.can_continuebutton(false);\n                } else if (currentResult instanceof YarnBound.CommandResult) {\n                    // Process the command string a little. so we have command name and args\n                    //eg \"picture 1.png\"\n                    var rawCommand = currentResult.command;\n                    var parts = rawCommand.split(' ');\n                    var commandName = parts[0]; // \"picture\" \"audio etc\"\n                    var args = parts.slice(1); // [\"1.png\"]\n                    let promise = null;\n\n\n                    switch(commandName) {\n                        case 'picture': {\n                            log.debug('got picture command');\n                            const imageURL = args[0]; // \"picture https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnimage', {\"imageurl\": imageURL}).then(\n                                function (html, js) {\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                });\n                            break;\n                        }\n                        case 'audio': {\n                            log.debug('got audio command');\n                            const audioURL = args[0]; // \"audio https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnaudio', {\"audiourl\": audioURL}).then(\n                                function (html, js) {\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                });\n                            break;\n                        }\n                        case 'video': {\n                            log.debug('got video command');\n                            const videoURL = args[0]; // \"video https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnvideo', {\"videourl\": videoURL}).then(\n                                function (html, js) {\n                                    that.controls.yarnmedia.html(html);\n                                    Templates.runTemplateJS(js);\n                                });\n                            break;\n                        }\n                        case 'clearpicture': {\n                            that.controls.yarnmedia.html('');\n                            break;\n                        }\n                        case 'blahblah':\n                        default:\n                    }\n                    // In all cases just do command and then jump to next line\n                    if(!currentResult.isDialogueEnd) {\n                        // Just skip through for now\n                        if (promise) {\n                            promise.then(() => {\n                                that.do_runner_advance();\n                                that.do_render();\n                            });\n                        } else {\n                            that.do_runner_advance();\n                            that.do_render();\n                        }\n                    }\n                } else {\n                    log.debug('MiniLesson Fiction: unknown yarn result type');\n                }\n            },\n\n            do_runner_advance: function (steps) {\n                try {\n                    if(steps !== null){\n                        this.runner.advance(steps);\n                    } else {\n                        this.runner.advance();\n                    }\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \" + e.message;\n                    this.controls.yarncontainer.html(\n                        `<div class=\"alert alert-danger\">${userFriendlyError}</div>`\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n            },\n\n            can_continuebutton: function (cancontinue) {\n                this.controls.yarncontinuebutton.prop(\"disabled\", !cancontinue);\n                if (cancontinue){\n                    this.controls.yarncontinuebutton.show();\n                } else {\n                    this.controls.yarncontinuebutton.hide();\n                }\n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n                var self = this;\n                //When click next button , report and leave it up to parent to eal with it.\n                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function () {\n                    var stepdata = {};\n                    stepdata.index = index;\n                    stepdata.hasgrade = false;\n                    stepdata.totalitems = 0;\n                    stepdata.correctitems = 0;\n                    stepdata.grade = 0;\n                    quizhelper.do_next(stepdata);\n                });\n                $(\"#\" + itemdata.uniqueid + \"_container\").on(\"showElement\", async () => {\n                    if (!self.instance) {\n                        // Maybe init yarn-bound here\n                        //this.do_render();\n                    }\n\n                    if (itemdata.timelimit > 0) {\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").trigger('click');\n                            }\n                        });\n                    }\n                });\n\n\n                this.controls.yarncontinuebutton.on('click', function (e) {\n                    log.debug('MiniLesson Fiction: yarn continue button clicked');\n                    e.preventDefault();\n                    if (self.itemdata.presention_mobilechat) {\n                        const playertext = $(this).text().trim();\n                        Templates.render('mod_minilesson/fiction_playermessage', {playertext: playertext}).then(\n                            function (html, js) {\n                                Templates.appendNodeContents(self.controls.chatwrapper, html, js);\n                            }\n                        );\n                    }\n                    self.do_runner_advance();\n                    self.do_render();\n                });\n\n                // add an event listener for option buttons that handles option buttons added at runtime\n                this.controls.yarncontainer.on('click', '.minilesson_fiction_optionbutton', function (e) {\n                    log.debug('MiniLesson Fiction: yarn option button clicked');\n                    e.preventDefault();\n\n                    var buttons = self.controls.yarncontainer.find('.minilesson_fiction_optionbutton');\n                    var optionindex = buttons.index(this); // 0-based position in the rendered list\n\n                    if (self.itemdata.presention_mobilechat) {\n                        //const playertext = $(this).siblings('.optiontext').text().trim();\n                        const playertext = $(this).text().trim();\n                        Templates.render('mod_minilesson/fiction_playermessage', {playertext: playertext}).then(\n                            function (html, js) {\n                                Templates.appendNodeContents(self.controls.chatwrapper, html, js);\n                            }\n                        );\n                    }\n                    self.do_runner_advance(optionindex);\n                    self.do_render();\n                });\n\n                if (this.itemdata.presention_mobilechat) {\n                    let scrollbtn = $(\"#\" + itemdata.uniqueid + \"_container .mobilechat #scroll-bottom-btn\");\n\n                    this.controls.chatwrapper.on(\"scroll\", function() {\n                        const chatwrapper = self.controls.chatwrapper[0];\n                        const isatbottom = chatwrapper.scrollHeight - chatwrapper.scrollTop <= chatwrapper.clientHeight + 5;\n                        if (isatbottom) {\n                            scrollbtn.hide();\n                        } else {\n                            scrollbtn.show();\n                        }\n                    });\n\n                    scrollbtn.on('click', function(e) {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        self.controls.chatwrapper.animate({\n                            scrollTop: self.controls.chatwrapper[0].scrollHeight\n                        }, 'smooth');\n                    });\n                }\n            },\n\n            add_metadata: function (currentthing) {\n                if (currentthing && 'markup' in currentthing && Array.isArray(currentthing.markup)) {\n                    currentthing.md = {};\n                    //for each markup entry, add the property name and values object to currentthing\n                    currentthing.markup.forEach(function (entry) {\n                        if ('properties' in entry && 'name' in entry) {\n                            currentthing.md[entry.name] = entry.properties;\n                        }\n                    });\n                    if (currentthing.md.character?.name) {\n                        const charname = currentthing.md.character.name.toLowerCase();\n                        currentthing.md.character.picturesrc = this.itemdata.filenamesmap\n                            .find(fileinfo => fileinfo.filekey === charname)?.fileurl || null;\n                    }\n                }\n                return currentthing;\n            },\n\n            register_previewbutton: function (buttonid) {\n                var previewbtn = document.getElementById(buttonid);\n                if (!previewbtn) {\n                    return;\n                }\n                previewbtn.addEventListener('click', function (e) {\n                    e.preventDefault();\n                    var form = previewbtn.form;\n                    if (!form) {\n                        return;\n                    }\n                    ModalFactory.create({\n                        type: ModalFactory.types.CANCEL,\n                        large: true,\n                        removeOnClose: true,\n                        templateContext: {\n                            classes: 'minilesson-fiction-preview-modal'\n                        },\n                        title: Str.get_string('fiction:previewmodaltitle', 'mod_minilesson'),\n                        body: Fragment.loadFragment('mod_minilesson', 'preview_fiction', M.cfg.contextid, {\n                            formdata: new URLSearchParams([...new FormData(form).entries()]).toString()\n                        })\n                    }).then(function (modal) {\n                        modal.getFooter().addClass('d-none');\n                        modal.show();\n                    });\n                    return;\n                });\n\n            },\n\n            reset_mobilechat_data: function() {\n                this.mobilechatdata = {\n                    charactername: null,\n                    charactermedia: null,\n                    charactertext: null,\n                    picturesrc: null,\n                    playertext: null,\n                };\n            },\n            scrolltobottom: function() {\n                if (!this.controls.chatwrapper.length) {\n                    return;\n                }\n                this.controls.chatwrapper.scrollTop(this.controls.chatwrapper[0].scrollHeight);\n                this.controls.chatwrapper.animate({\n                    scrollTop: this.controls.chatwrapper[0].scrollHeight + 5,\n                    behavior: 'smooth'\n                });\n            }\n        };\n    });"],"names":["define","$","log","def","YarnBound","Str","ModalFactory","Fragment","Templates","debug","runner","controls","itemdata","mobilechatdata","clone","extend","this","init","index","quizhelper","prepare_html","register_events","yarnopts","fictionyarn","do_render","e","userFriendlyError","message","yarncontainer","html","error","uniqueid","yarntext","find","yarnmedia","yarnoptions","yarncontinuebutton","chatwrapper","prefetchTemplates","currentResult","add_metadata","presention_mobilechat","do_render_mobilechat","do_render_plain","isDialogueEnd","can_continuebutton","that","yarncontent","TextResult","picturesrc","md","_yarncontent$yarntext","character","_yarncontent$yarntext2","charactername","_yarncontent$yarntext3","_yarncontent$yarntext4","name","charactertext","text","render","charactermedia","then","js","appendNodeContents","scrolltobottom","setTimeout","replaceNode","last","reset_mobilechat_data","OptionsResult","runTemplateJS","_yarncontent$yarnopti","_yarncontent$yarnopti2","_yarncontent$yarnopti3","_yarncontent$yarnopti4","CommandResult","parts","command","split","commandName","args","slice","promise","imageURL","classname","audioURL","videoURL","do_runner_advance","steps","advance","cancontinue","prop","show","hide","self","on","stepdata","hasgrade","totalitems","correctitems","grade","do_next","async","instance","timelimit","progressTimer","height","timeLimit","onFinish","trigger","preventDefault","playertext","trim","optionindex","scrollbtn","scrollHeight","scrollTop","clientHeight","stopPropagation","animate","currentthing","Array","isArray","markup","forEach","entry","properties","_currentthing$md$char","charname","toLowerCase","filenamesmap","fileinfo","filekey","fileurl","register_previewbutton","buttonid","previewbtn","document","getElementById","addEventListener","form","create","type","types","CANCEL","large","removeOnClose","templateContext","classes","title","get_string","body","loadFragment","M","cfg","contextid","formdata","URLSearchParams","FormData","entries","toString","modal","getFooter","addClass","length","behavior"],"mappings":"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"}