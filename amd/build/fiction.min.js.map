{"version":3,"sources":["../src/fiction.js"],"names":["define","$","log","def","YarnBound","Str","ModalFactory","Fragment","Templates","debug","runner","controls","itemdata","mobilechatdata","clone","extend","init","index","quizhelper","prepare_html","register_events","yarnopts","fictionyarn","do_render","e","userFriendlyError","message","yarncontainer","html","error","uniqueid","yarntext","find","yarnmedia","yarnoptions","yarncontinuebutton","chatwrapper","that","yarncontent","currentResult","add_metadata","TextResult","presention_mobilechat","can_continuebutton","picturesrc","md","character","charactername","name","charactertext","text","render","charactermedia","then","js","appendNodeContents","scrolltobottom","setTimeout","replaceNode","last","oldcharactermedia","reset_mobilechat_data","isDialogueEnd","runTemplateJS","OptionsResult","CommandResult","rawCommand","command","parts","split","commandName","args","slice","promise","imageURL","classname","audioURL","videoURL","do_runner_advance","steps","advance","cancontinue","prop","show","hide","self","on","do_next","hasgrade","totalitems","correctitems","grade","instance","timelimit","progressTimer","height","timeLimit","onFinish","trigger","preventDefault","playertext","siblings","trim","buttons","optionindex","scrollbtn","isatbottom","scrollHeight","scrollTop","clientHeight","stopPropagation","animate","currentthing","Array","isArray","markup","forEach","entry","properties","charname","toLowerCase","filenamesmap","fileinfo","filekey","fileurl","register_previewbutton","buttonid","previewbtn","document","getElementById","addEventListener","form","create","type","types","CANCEL","large","removeOnClose","templateContext","classes","title","get_string","body","loadFragment","M","cfg","contextid","formdata","URLSearchParams","FormData","entries","toString","modal","getFooter","addClass","length","behavior"],"mappings":"01CAAAA,OAAM,0BAAC,CACH,QADG,CACO,UADP,CACmB,4BADnB,CACgD,2BADhD,CAEH,UAFG,CAES,oBAFT,CAE+B,eAF/B,CAE+C,gBAF/C,CAAD,CAIF,SAAUC,CAAV,CAAaC,CAAb,CAAkBC,CAAlB,CAAuBC,CAAvB,CAAkCC,CAAlC,CAAuCC,CAAvC,CAAqDC,CAArD,CAA+DC,CAA/D,CAA0E,CACtE,aAMAN,CAAG,CAACO,KAAJ,CAAU,kCAAV,EAEA,MAAO,CAEHC,MAAM,CAAE,IAFL,CAGHC,QAAQ,CAAE,EAHP,CAIHC,QAAQ,CAAE,EAJP,CAKHC,cAAc,CAAE,EALb,CAQHC,KAAK,CAAE,gBAAY,CACf,MAAOb,CAAAA,CAAC,CAACc,MAAF,IAAe,EAAf,CAAmB,IAAnB,CACV,CAVE,CAYHC,IAAI,CAAE,cAAUC,CAAV,CAAiBL,CAAjB,CAA2BM,CAA3B,CAAuC,CACzC,KAAKN,QAAL,CAAgBA,CAAhB,CACA,KAAKO,YAAL,CAAkBP,CAAlB,EACA,KAAKQ,eAAL,CAAqBH,CAArB,CAA4BL,CAA5B,CAAsCM,CAAtC,EACA,GAAIG,CAAAA,CAAQ,CAAG,CACX,SAAYT,CAAQ,CAACU,WADV,CAEX,+BAFW,CAGX,QAAW,OAHA,CAAf,CAKApB,CAAG,CAACO,KAAJ,CAAU,yDAAV,EACAP,CAAG,CAACO,KAAJ,CAAUY,CAAV,EACA,GAAG,CACC,KAAKX,MAAL,CAAc,GAAIN,CAAAA,CAAJ,CAAciB,CAAd,CAAd,CACA,KAAKE,SAAL,EACH,CAAC,MAAOC,CAAP,CAAU,CACR,GAAIC,CAAAA,CAAiB,CAAG,qBAAuBD,CAAC,CAACE,OAAjD,CACA,KAAKf,QAAL,CAAcgB,aAAd,CAA4BC,IAA5B,6CACuCH,CADvC,YAGAvB,CAAG,CAAC2B,KAAJ,CAAU,kBAAV,EACA3B,CAAG,CAAC2B,KAAJ,CAAUL,CAAV,CACH,CACJ,CAlCE,CAoCHL,YAAY,CAAE,sBAAUP,CAAV,CAAoB,CAC9B,KAAKD,QAAL,CAAcgB,aAAd,CAA8B1B,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,8CAA3B,CAA/B,CACA,KAAKnB,QAAL,CAAcoB,QAAd,CAAyB,KAAKpB,QAAL,CAAcgB,aAAd,CAA4BK,IAA5B,CAAiC,8BAAjC,CAAzB,CACA,KAAKrB,QAAL,CAAcsB,SAAd,CAA0B,KAAKtB,QAAL,CAAcgB,aAAd,CAA4BK,IAA5B,CAAiC,+BAAjC,CAA1B,CACA,KAAKrB,QAAL,CAAcuB,WAAd,CAA4B,KAAKvB,QAAL,CAAcgB,aAAd,CAA4BK,IAA5B,CAAiC,iCAAjC,CAA5B,CACA,KAAKrB,QAAL,CAAcwB,kBAAd,CAAmClC,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,+CAA3B,CAApC,CACA,KAAKnB,QAAL,CAAcyB,WAAd,CAA4BnC,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,sCAA3B,CAChC,CA3CE,CA6CHP,SAAS,CAAE,oBAAY,IACfc,CAAAA,CAAI,CAAG,IADQ,CAEfC,CAAW,CAAG,CACd,WADc,CAEd,cAFc,CAFC,CAOfC,CAAa,CAAG,KAAK7B,MAAL,CAAY6B,aAPb,CAQnBA,CAAa,CAAG,KAAKC,YAAL,CAAkBD,CAAlB,CAAhB,CACArC,CAAG,CAACO,KAAJ,CAAU,mDAAV,EACAP,CAAG,CAACO,KAAJ,CAAU8B,CAAV,EAEA,GAAGA,CAAa,WAAYnC,CAAAA,CAAS,CAACqC,UAAtC,CAAkD,CAE9CH,CAAW,CAACP,QAAZ,CAAuBQ,CAAvB,CAEA,GAAIF,CAAI,CAACzB,QAAL,CAAc8B,qBAAlB,CAAyC,aACrCL,CAAI,CAACM,kBAAL,KACAN,CAAI,CAACxB,cAAL,CAAoB+B,UAApB,WAAiCN,CAAW,CAACP,QAAZ,CAAqBc,EAAtD,+BAAiC,EAAyBC,SAA1D,qBAAiC,EAAoCF,UAArE,CACAP,CAAI,CAACxB,cAAL,CAAoBkC,aAApB,WAAoCT,CAAW,CAACP,QAAZ,CAAqBc,EAAzD,+BAAoC,EAAyBC,SAA7D,qBAAoC,EAAoCE,IAAxE,CACAX,CAAI,CAACxB,cAAL,CAAoBoC,aAApB,CAAoCX,CAAW,CAACP,QAAZ,CAAqBmB,IAAzD,CACA1C,CAAS,CAAC2C,MAAV,CAAiB,yCAAjB,CAA4D,CACxDC,cAAc,CAAE,mCADwC,CAA5D,EAEGC,IAFH,CAEQ,SAASzB,CAAT,CAAc0B,CAAd,CAAkB,CACtB9C,CAAS,CAAC+C,kBAAV,CAA6BlB,CAAI,CAAC1B,QAAL,CAAcyB,WAA3C,CAAwDR,CAAxD,CAA8D0B,CAA9D,EACAjB,CAAI,CAACmB,cAAL,GACAC,UAAU,CAAC,UAAM,CACbjD,CAAS,CAAC2C,MAAV,CAAiB,yCAAjB,CAA4Dd,CAAI,CAACxB,cAAjE,EAAiFwC,IAAjF,CACI,SAASzB,CAAT,CAAc0B,CAAd,CAAkB,CACd9C,CAAS,CAACkD,WAAV,CACIrB,CAAI,CAAC1B,QAAL,CAAcyB,WAAd,CAA0BJ,IAA1B,CAA+B,gBAA/B,EAAiD2B,IAAjD,EADJ,CAEI/B,CAFJ,CAGI0B,CAHJ,EAKAjB,CAAI,CAACmB,cAAL,GACA,GAAMI,CAAAA,CAAiB,CAAGvB,CAAI,CAACxB,cAAL,CAAoBuC,cAA9C,CACAf,CAAI,CAACwB,qBAAL,GACAxB,CAAI,CAACxB,cAAL,CAAoBuC,cAApB,CAAqCQ,CAArC,CAEA,GAAI,CAACrB,CAAa,CAACuB,aAAnB,CAAkC,CAC9BzB,CAAI,CAACM,kBAAL,IACH,CACJ,CAfL,CAiBH,CAlBS,CAkBP,GAlBO,CAmBb,CAxBD,EAyBAN,CAAI,CAAC1B,QAAL,CAAcuB,WAAd,CAA0BN,IAA1B,CAA+B,EAA/B,CACH,CA/BD,IA+BM,CACFpB,CAAS,CAAC2C,MAAV,CAAiB,gCAAjB,CAAmDb,CAAW,CAACP,QAA/D,EAAyEsB,IAAzE,CACA,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChBjB,CAAI,CAAC1B,QAAL,CAAcoB,QAAd,CAAuBH,IAAvB,CAA4BA,CAA5B,EACAS,CAAI,CAAC1B,QAAL,CAAcuB,WAAd,CAA0BN,IAA1B,CAA+B,EAA/B,EACApB,CAAS,CAACuD,aAAV,CAAwBT,CAAxB,CACH,CALD,EAOA,KAAKX,kBAAL,IACH,CACJ,CA7CD,IA6CO,IAAGJ,CAAa,WAAYnC,CAAAA,CAAS,CAAC4D,aAAtC,CAAqD,CAExD1B,CAAW,CAACJ,WAAZ,CAA0BK,CAA1B,CACA,GAAIF,CAAI,CAACzB,QAAL,CAAc8B,qBAAlB,CAAyC,CACrC,GAAI7B,CAAAA,CAAc,CAAG,CACjB,YAAe0B,CADE,CAEjB,wBAFiB,CAArB,CAIAF,CAAI,CAAC1B,QAAL,CAAcuB,WAAd,CAA0BN,IAA1B,CAA+B,EAA/B,CACH,CAND,IAMO,CACH,GAAIf,CAAAA,CAAc,CAAG0B,CACxB,CACD/B,CAAS,CAAC2C,MAAV,CAAiB,mCAAjB,CAAsDtC,CAAtD,EAAsEwC,IAAtE,CACA,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChBG,UAAU,CAAC,UAAM,CACbpB,CAAI,CAAC1B,QAAL,CAAcuB,WAAd,CAA0BN,IAA1B,CAA+BA,CAA/B,EACApB,CAAS,CAACuD,aAAV,CAAwBT,CAAxB,CACH,CAHS,CAGPjB,CAAI,CAACzB,QAAL,CAAc8B,qBAAd,CAAsC,GAAtC,CAA6C,CAHtC,CAIb,CAND,EASA,GAAI,QAAUJ,CAAAA,CAAW,CAACJ,WAA1B,CAAuC,CAEnC,GAAIG,CAAI,CAACzB,QAAL,CAAc8B,qBAAlB,CAAyC,aACrCL,CAAI,CAACxB,cAAL,CAAoB+B,UAApB,WAAiCN,CAAW,CAACJ,WAAZ,CAAwBW,EAAzD,+BAAiC,EAA4BC,SAA7D,qBAAiC,EAAuCF,UAAxE,CACAP,CAAI,CAACxB,cAAL,CAAoBkC,aAApB,WAAoCT,CAAW,CAACJ,WAAZ,CAAwBW,EAA5D,+BAAoC,EAA4BC,SAAhE,qBAAoC,EAAuCE,IAA3E,CACAX,CAAI,CAACxB,cAAL,CAAoBoC,aAApB,CAAoCX,CAAW,CAACJ,WAAZ,CAAwBgB,IAA5D,CAEA1C,CAAS,CAAC2C,MAAV,CAAiB,yCAAjB,CAA4D,CACxDC,cAAc,CAAE,mCADwC,CAA5D,EAEGC,IAFH,CAEQ,SAASzB,CAAT,CAAc0B,CAAd,CAAkB,CACtB9C,CAAS,CAAC+C,kBAAV,CAA6BlB,CAAI,CAAC1B,QAAL,CAAcyB,WAA3C,CAAwDR,CAAxD,CAA8D0B,CAA9D,EACAjB,CAAI,CAACmB,cAAL,GACAC,UAAU,CAAC,UAAM,CACbjD,CAAS,CAAC2C,MAAV,CAAiB,yCAAjB,CAA4Dd,CAAI,CAACxB,cAAjE,EAAiFwC,IAAjF,CACI,SAASzB,CAAT,CAAc0B,CAAd,CAAkB,CACd9C,CAAS,CAACkD,WAAV,CACIrB,CAAI,CAAC1B,QAAL,CAAcyB,WAAd,CAA0BJ,IAA1B,CAA+B,gBAA/B,EAAiD2B,IAAjD,EADJ,CAEI/B,CAFJ,CAGI0B,CAHJ,EAKAjB,CAAI,CAACmB,cAAL,GACA,GAAMI,CAAAA,CAAiB,CAAGvB,CAAI,CAACxB,cAAL,CAAoBuC,cAA9C,CACAf,CAAI,CAACwB,qBAAL,GACAxB,CAAI,CAACxB,cAAL,CAAoBuC,cAApB,CAAqCQ,CACxC,CAXL,CAaH,CAdS,CAcP,GAdO,CAeb,CApBD,CAqBH,CA1BD,IA0BO,CACHpD,CAAS,CAAC2C,MAAV,CAAiB,gCAAjB,CAAmDb,CAAW,CAACJ,WAA/D,EAA4EmB,IAA5E,CACA,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChBjB,CAAI,CAAC1B,QAAL,CAAcoB,QAAd,CAAuBH,IAAvB,CAA4BA,CAA5B,EACApB,CAAS,CAACuD,aAAV,CAAwBT,CAAxB,CACH,CAJD,CAKH,CACJ,CAnCD,IAmCO,CACHjB,CAAI,CAAC1B,QAAL,CAAcoB,QAAd,CAAuBH,IAAvB,CAA4B,EAA5B,CACH,CAGDS,CAAI,CAACM,kBAAL,IAEH,CA/DM,IA+DA,IAAIJ,CAAa,WAAYnC,CAAAA,CAAS,CAAC6D,aAAvC,CAAsD,IAGrDC,CAAAA,CAAU,CAAG3B,CAAa,CAAC4B,OAH0B,CAIrDC,CAAK,CAAGF,CAAU,CAACG,KAAX,CAAiB,GAAjB,CAJ6C,CAKrDC,CAAW,CAAGF,CAAK,CAAC,CAAD,CALkC,CAMrDG,CAAI,CAAGH,CAAK,CAACI,KAAN,CAAY,CAAZ,CAN8C,CAOrDC,CAAO,CAAG,IAP2C,CAUzD,OAAOH,CAAP,EACI,IAAK,SAAL,CAAgB,CACZpE,CAAG,CAACO,KAAJ,CAAU,qBAAV,EACA,GAAMiE,CAAAA,CAAQ,CAAGH,CAAI,CAAC,CAAD,CAArB,CACAE,CAAO,CAAGjE,CAAS,CAAC2C,MAAV,CAAiB,iCAAjB,CAAoD,CAAC,SAAYuB,CAAb,CAApD,EAA4ErB,IAA5E,CACV,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChBjB,CAAI,CAAC1B,QAAL,CAAcsB,SAAd,CAAwBL,IAAxB,CAA6BA,CAA7B,EACA,GAAIS,CAAI,CAACzB,QAAL,CAAc8B,qBAAlB,CAAyC,CACrCL,CAAI,CAACxB,cAAL,CAAoBuC,cAApB,CAAqCxB,CAArC,CACAS,CAAI,CAACxB,cAAL,CAAoB8D,SAApB,CAAgC,UACnC,CACDnE,CAAS,CAACuD,aAAV,CAAwBT,CAAxB,CACH,CARS,CAAV,CASA,KACH,CACD,IAAK,OAAL,CAAc,CACVpD,CAAG,CAACO,KAAJ,CAAU,mBAAV,EACA,GAAMmE,CAAAA,CAAQ,CAAGL,CAAI,CAAC,CAAD,CAArB,CACAE,CAAO,CAAGjE,CAAS,CAAC2C,MAAV,CAAiB,iCAAjB,CAAoD,CAAC,SAAYyB,CAAb,CAApD,EAA4EvB,IAA5E,CACV,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChB,GAAIjB,CAAI,CAACzB,QAAL,CAAc8B,qBAAlB,CAAyC,CACrCL,CAAI,CAACxB,cAAL,CAAoBuC,cAApB,CAAqCxB,CAArC,CACAS,CAAI,CAACxB,cAAL,CAAoB8D,SAApB,CAAgC,UACnC,CACDtC,CAAI,CAAC1B,QAAL,CAAcsB,SAAd,CAAwBL,IAAxB,CAA6BA,CAA7B,EACApB,CAAS,CAACuD,aAAV,CAAwBT,CAAxB,CACH,CARS,CAAV,CASA,KACH,CACD,IAAK,OAAL,CAAc,CACVpD,CAAG,CAACO,KAAJ,CAAU,mBAAV,EACA,GAAMoE,CAAAA,CAAQ,CAAGN,CAAI,CAAC,CAAD,CAArB,CACAE,CAAO,CAAGjE,CAAS,CAAC2C,MAAV,CAAiB,iCAAjB,CAAoD,CAAC,SAAY0B,CAAb,CAApD,EAA4ExB,IAA5E,CACV,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChB,GAAIjB,CAAI,CAACzB,QAAL,CAAc8B,qBAAlB,CAAyC,CACrCL,CAAI,CAACxB,cAAL,CAAoBuC,cAApB,CAAqCxB,CAArC,CACAS,CAAI,CAACxB,cAAL,CAAoB8D,SAApB,CAAgC,UACnC,CACDtC,CAAI,CAAC1B,QAAL,CAAcsB,SAAd,CAAwBL,IAAxB,CAA6BA,CAA7B,EACApB,CAAS,CAACuD,aAAV,CAAwBT,CAAxB,CACH,CARS,CAAV,CASA,KACH,CACD,IAAK,cAAL,CAAqB,CACjBjB,CAAI,CAAC1B,QAAL,CAAcsB,SAAd,CAAwBL,IAAxB,CAA6B,EAA7B,EACA,KACH,CACD,IAAK,UAAL,CACA,QAhDJ,CAmDA,GAAG,CAACW,CAAa,CAACuB,aAAlB,CAAiC,CAE7B,GAAIW,CAAJ,CAAa,CACTA,CAAO,CAACpB,IAAR,CAAa,UAAM,CACfhB,CAAI,CAACyC,iBAAL,GACAzC,CAAI,CAACd,SAAL,EACH,CAHD,CAIH,CALD,IAKO,CACHc,CAAI,CAACyC,iBAAL,GACAzC,CAAI,CAACd,SAAL,EACH,CACD,MACH,CACJ,CA1EM,IA0EA,CACHrB,CAAG,CAACO,KAAJ,CAAU,8CAAV,CACH,CAGD,GAAG8B,CAAa,CAACuB,aAAjB,CAAgC,CAC5BzB,CAAI,CAACM,kBAAL,IAEH,CACJ,CAxPE,CA0PHmC,iBAAiB,CAAE,2BAAUC,CAAV,CAAiB,CAChC,GAAI,CACA,GAAa,IAAV,GAAAA,CAAH,CAAkB,CACd,KAAKrE,MAAL,CAAYsE,OAAZ,CAAoBD,CAApB,CACH,CAFD,IAEO,CACH,KAAKrE,MAAL,CAAYsE,OAAZ,EACH,CACJ,CAAC,MAAOxD,CAAP,CAAU,CACR,GAAIC,CAAAA,CAAiB,CAAG,qBAAuBD,CAAC,CAACE,OAAjD,CACA,KAAKf,QAAL,CAAcgB,aAAd,CAA4BC,IAA5B,6CACuCH,CADvC,YAGAvB,CAAG,CAAC2B,KAAJ,CAAU,kBAAV,EACA3B,CAAG,CAAC2B,KAAJ,CAAUL,CAAV,CACH,CACJ,CAzQE,CA2QHmB,kBAAkB,CAAE,4BAAUsC,CAAV,CAAuB,CACvC,KAAKtE,QAAL,CAAcwB,kBAAd,CAAiC+C,IAAjC,CAAsC,UAAtC,CAAkD,CAACD,CAAnD,EACA,GAAIA,CAAJ,CAAgB,CACZ,KAAKtE,QAAL,CAAcwB,kBAAd,CAAiCgD,IAAjC,EACH,CAFD,IAEO,CACH,KAAKxE,QAAL,CAAcwB,kBAAd,CAAiCiD,IAAjC,EACH,CACJ,CAlRE,CAoRHhE,eAAe,CAAE,yBAAUH,CAAV,CAAiBL,CAAjB,CAA2BM,CAA3B,CAAuC,CACpD,GAAImE,CAAAA,CAAI,CAAG,IAAX,CAEApF,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,mCAA3B,CAAD,CAAiEwD,EAAjE,CAAoE,OAApE,CAA6E,UAAY,CAOrFpE,CAAU,CAACqE,OAAX,CANe,CACNtE,KADM,CACEA,CADF,CAENuE,QAFM,IAGNC,UAHM,CAGO,CAHP,CAINC,YAJM,CAIS,CAJT,CAKNC,KALM,CAKE,CALF,CAMf,CACH,CARD,EASA1F,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,YAA3B,CAAD,CAA0CwD,EAA1C,CAA6C,aAA7C,2CAA4D,8FACxD,GAAI,CAACD,CAAI,CAACO,QAAV,CAAoB,CAGnB,CAED,GAAyB,CAArB,CAAAhF,CAAQ,CAACiF,SAAb,CAA4B,CACxB5F,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,gCAA3B,CAAD,CAA8DqD,IAA9D,GACAlF,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,kCAA3B,CAAD,CAAgEqD,IAAhE,GACAlF,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,+CAA3B,CAAD,CAA6EgE,aAA7E,CAA2F,CACvFC,MAAM,CAAE,KAD+E,CAEvFC,SAAS,CAAEpF,CAAQ,CAACiF,SAFmE,CAGvFI,QAAQ,CAAE,mBAAY,CAClBhG,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,mCAA3B,CAAD,CAAiEoE,OAAjE,CAAyE,OAAzE,CACH,CALsF,CAA3F,CAOH,CAhBuD,wCAA5D,IAoBA,KAAKvF,QAAL,CAAcwB,kBAAd,CAAiCmD,EAAjC,CAAoC,OAApC,CAA6C,SAAU9D,CAAV,CAAa,CACtDtB,CAAG,CAACO,KAAJ,CAAU,kDAAV,EACAe,CAAC,CAAC2E,cAAF,GACA,GAAId,CAAI,CAACzE,QAAL,CAAc8B,qBAAlB,CAAyC,CACrC,GAAM0D,CAAAA,CAAU,CAAGnG,CAAC,CAAC,IAAD,CAAD,CAAQoG,QAAR,CAAiB,aAAjB,EAAgCnD,IAAhC,GAAuCoD,IAAvC,EAAnB,CACA9F,CAAS,CAAC2C,MAAV,CAAiB,sCAAjB,CAAyD,CAACiD,UAAU,CAAEA,CAAb,CAAzD,EAAmF/C,IAAnF,CACI,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChB9C,CAAS,CAAC+C,kBAAV,CAA6B8B,CAAI,CAAC1E,QAAL,CAAcyB,WAA3C,CAAwDR,CAAxD,CAA8D0B,CAA9D,CACH,CAHL,CAKH,CACD+B,CAAI,CAACP,iBAAL,GACAO,CAAI,CAAC9D,SAAL,EACH,CAbD,EAgBA,KAAKZ,QAAL,CAAcgB,aAAd,CAA4B2D,EAA5B,CAA+B,OAA/B,CAAwC,kCAAxC,CAA4E,SAAU9D,CAAV,CAAa,CACrFtB,CAAG,CAACO,KAAJ,CAAU,gDAAV,EACAe,CAAC,CAAC2E,cAAF,GAFqF,GAIjFI,CAAAA,CAAO,CAAGlB,CAAI,CAAC1E,QAAL,CAAcgB,aAAd,CAA4BK,IAA5B,CAAiC,kCAAjC,CAJuE,CAKjFwE,CAAW,CAAGD,CAAO,CAACtF,KAAR,CAAc,IAAd,CALmE,CAOrF,GAAIoE,CAAI,CAACzE,QAAL,CAAc8B,qBAAlB,CAAyC,CACrC,GAAM0D,CAAAA,CAAU,CAAGnG,CAAC,CAAC,IAAD,CAAD,CAAQoG,QAAR,CAAiB,aAAjB,EAAgCnD,IAAhC,GAAuCoD,IAAvC,EAAnB,CACA9F,CAAS,CAAC2C,MAAV,CAAiB,sCAAjB,CAAyD,CAACiD,UAAU,CAAEA,CAAb,CAAzD,EAAmF/C,IAAnF,CACI,SAAUzB,CAAV,CAAgB0B,CAAhB,CAAoB,CAChB9C,CAAS,CAAC+C,kBAAV,CAA6B8B,CAAI,CAAC1E,QAAL,CAAcyB,WAA3C,CAAwDR,CAAxD,CAA8D0B,CAA9D,CACH,CAHL,CAKH,CACD+B,CAAI,CAACP,iBAAL,CAAuB0B,CAAvB,EACAnB,CAAI,CAAC9D,SAAL,EACH,CAjBD,EAmBA,GAAI,KAAKX,QAAL,CAAc8B,qBAAlB,CAAyC,CACrC,GAAI+D,CAAAA,CAAS,CAAGxG,CAAC,CAAC,IAAMW,CAAQ,CAACkB,QAAf,CAA0B,2CAA3B,CAAjB,CAEA,KAAKnB,QAAL,CAAcyB,WAAd,CAA0BkD,EAA1B,CAA6B,QAA7B,CAAuC,UAAW,IACxClD,CAAAA,CAAW,CAAGiD,CAAI,CAAC1E,QAAL,CAAcyB,WAAd,CAA0B,CAA1B,CAD0B,CAExCsE,CAAU,CAAGtE,CAAW,CAACuE,YAAZ,CAA2BvE,CAAW,CAACwE,SAAvC,EAAoDxE,CAAW,CAACyE,YAAZ,CAA2B,CAFpD,CAG9C,GAAIH,CAAJ,CAAgB,CACZD,CAAS,CAACrB,IAAV,EACH,CAFD,IAEO,CACHqB,CAAS,CAACtB,IAAV,EACH,CACJ,CARD,EAUAsB,CAAS,CAACnB,EAAV,CAAa,OAAb,CAAsB,SAAS9D,CAAT,CAAY,CAC9BA,CAAC,CAAC2E,cAAF,GACA3E,CAAC,CAACsF,eAAF,GACAzB,CAAI,CAAC1E,QAAL,CAAcyB,WAAd,CAA0B2E,OAA1B,CAAkC,CAC9BH,SAAS,CAAEvB,CAAI,CAAC1E,QAAL,CAAcyB,WAAd,CAA0B,CAA1B,EAA6BuE,YADV,CAAlC,CAEG,QAFH,CAGH,CAND,CAOH,CACJ,CA5WE,CA8WHnE,YAAY,CAAE,sBAAUwE,CAAV,CAAwB,CAClC,GAAIA,CAAY,EAAI,UAAYA,CAAAA,CAA5B,EAA4CC,KAAK,CAACC,OAAN,CAAcF,CAAY,CAACG,MAA3B,CAAhD,CAAoF,OAChFH,CAAY,CAACnE,EAAb,CAAkB,EAAlB,CAEAmE,CAAY,CAACG,MAAb,CAAoBC,OAApB,CAA4B,SAAUC,CAAV,CAAiB,CACzC,GAAI,cAAgBA,CAAAA,CAAhB,EAAyB,QAAUA,CAAAA,CAAvC,CAA8C,CAC1CL,CAAY,CAACnE,EAAb,CAAgBwE,CAAK,CAACrE,IAAtB,EAA8BqE,CAAK,CAACC,UACvC,CACJ,CAJD,EAKA,aAAIN,CAAY,CAACnE,EAAb,CAAgBC,SAApB,qBAAI,EAA2BE,IAA/B,CAAqC,OAC3BuE,CAAQ,CAAGP,CAAY,CAACnE,EAAb,CAAgBC,SAAhB,CAA0BE,IAA1B,CAA+BwE,WAA/B,EADgB,CAEjCR,CAAY,CAACnE,EAAb,CAAgBC,SAAhB,CAA0BF,UAA1B,CAAuC,gBAAKhC,QAAL,CAAc6G,YAAd,CAClCzF,IADkC,CAC7B,SAAA0F,CAAQ,QAAIA,CAAAA,CAAQ,CAACC,OAAT,GAAqBJ,CAAzB,CADqB,wBACeK,OADf,GAC0B,IACpE,CACJ,CACD,MAAOZ,CAAAA,CACV,CA9XE,CAgYHa,sBAAsB,CAAE,gCAAUC,CAAV,CAAoB,CACxC,GAAIC,CAAAA,CAAU,CAAGC,QAAQ,CAACC,cAAT,CAAwBH,CAAxB,CAAjB,CACA,GAAI,CAACC,CAAL,CAAiB,CACb,MACH,CACDA,CAAU,CAACG,gBAAX,CAA4B,OAA5B,CAAqC,SAAU1G,CAAV,CAAa,CAC9CA,CAAC,CAAC2E,cAAF,GACA,GAAIgC,CAAAA,CAAI,CAAGJ,CAAU,CAACI,IAAtB,CACA,GAAI,CAACA,CAAL,CAAW,CACP,MACH,CACD7H,CAAY,CAAC8H,MAAb,CAAoB,CAChBC,IAAI,CAAE/H,CAAY,CAACgI,KAAb,CAAmBC,MADT,CAEhBC,KAAK,GAFW,CAGhBC,aAAa,GAHG,CAIhBC,eAAe,CAAE,CACbC,OAAO,CAAE,kCADI,CAJD,CAOhBC,KAAK,CAAEvI,CAAG,CAACwI,UAAJ,CAAe,2BAAf,CAA4C,gBAA5C,CAPS,CAQhBC,IAAI,CAAEvI,CAAQ,CAACwI,YAAT,CAAsB,gBAAtB,CAAwC,iBAAxC,CAA2DC,CAAC,CAACC,GAAF,CAAMC,SAAjE,CAA4E,CAC9EC,QAAQ,CAAE,GAAIC,CAAAA,eAAJ,oBAAwB,GAAIC,CAAAA,QAAJ,CAAalB,CAAb,EAAmBmB,OAAnB,EAAxB,GAAuDC,QAAvD,EADoE,CAA5E,CARU,CAApB,EAWGlG,IAXH,CAWQ,SAAUmG,CAAV,CAAiB,CACrBA,CAAK,CAACC,SAAN,GAAkBC,QAAlB,CAA2B,QAA3B,EACAF,CAAK,CAACrE,IAAN,EACH,CAdD,CAgBH,CAtBD,CAwBH,CA7ZE,CA+ZHtB,qBAAqB,CAAE,gCAAW,CAC9B,KAAKhD,cAAL,CAAsB,CAClBkC,aAAa,CAAE,IADG,CAElBK,cAAc,CAAE,IAFE,CAGlBH,aAAa,CAAE,IAHG,CAIlBL,UAAU,CAAE,IAJM,CAKlBwD,UAAU,CAAE,IALM,CAOzB,CAvaE,CAwaH5C,cAAc,CAAE,yBAAW,CACvB,GAAI,CAAC,KAAK7C,QAAL,CAAcyB,WAAd,CAA0BuH,MAA/B,CAAuC,CACnC,MACH,CACD,KAAKhJ,QAAL,CAAcyB,WAAd,CAA0BwE,SAA1B,CAAoC,KAAKjG,QAAL,CAAcyB,WAAd,CAA0B,CAA1B,EAA6BuE,YAAjE,EACA,KAAKhG,QAAL,CAAcyB,WAAd,CAA0B2E,OAA1B,CAAkC,CAC9BH,SAAS,CAAE,KAAKjG,QAAL,CAAcyB,WAAd,CAA0B,CAA1B,EAA6BuE,YAA7B,CAA4C,CADzB,CAE9BiD,QAAQ,CAAE,QAFoB,CAAlC,CAIH,CAjbE,CAmbV,CAhcC,CAAN","sourcesContent":["define([\n    'jquery', 'core/log', 'mod_minilesson/definitions','mod_minilesson/yarn-bound',\n    'core/str', 'core/modal_factory', 'core/fragment','core/templates'\n],\n    function ($, log, def, YarnBound, Str, ModalFactory, Fragment, Templates) {\n        \"use strict\"; // jshint ;_;\n\n        /*\n       This file is to manage the fiction item type\n        */\n\n        log.debug('MiniLesson Fiction: initialising');\n\n        return {\n\n            runner: null,\n            controls: {},\n            itemdata: {},\n            mobilechatdata: {},\n\n            //for making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                this.prepare_html(itemdata);\n                this.register_events(index, itemdata, quizhelper);\n                var yarnopts = {\n                    \"dialogue\": itemdata.fictionyarn,\n                    \"combineTextAndOptionsResults\": true,\n                    \"startAt\": \"Start\"\n                };\n                log.debug('MiniLesson Fiction: initializing yarnbound with options');\n                log.debug(yarnopts);\n                try{\n                    this.runner = new YarnBound(yarnopts);\n                    this.do_render();\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \" + e.message;\n                    this.controls.yarncontainer.html(\n                        `<div class=\"alert alert-danger\">${userFriendlyError}</div>`\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n            },\n\n            prepare_html: function (itemdata) {\n                this.controls.yarncontainer = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_yarncontainer\");\n                this.controls.yarntext = this.controls.yarncontainer.find('.minilesson_fiction_yarntext');\n                this.controls.yarnmedia = this.controls.yarncontainer.find('.minilesson_fiction_yarnmedia');\n                this.controls.yarnoptions = this.controls.yarncontainer.find('.minilesson_fiction_yarnoptions');\n                this.controls.yarncontinuebutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_fiction_continuebutton\");\n                this.controls.chatwrapper = $(\"#\" + itemdata.uniqueid + \"_container .mobilechat .chat-wrapper\");\n            },\n\n            do_render: function () {\n                var that = this;\n                var yarncontent = {\n                    'yarntext': false,\n                    'yarnoptions': false\n                };\n\n                var currentResult = this.runner.currentResult;\n                currentResult = this.add_metadata(currentResult);\n                log.debug('MiniLesson Fiction: doing render of currentResult');\n                log.debug(currentResult);\n\n                if(currentResult instanceof YarnBound.TextResult) {\n                    // Render the text\n                    yarncontent.yarntext = currentResult;\n\n                    if (that.itemdata.presention_mobilechat) {\n                        that.can_continuebutton(false);\n                        that.mobilechatdata.picturesrc = yarncontent.yarntext.md?.character?.picturesrc;\n                        that.mobilechatdata.charactername = yarncontent.yarntext.md?.character?.name;\n                        that.mobilechatdata.charactertext = yarncontent.yarntext.text;\n                        Templates.render('mod_minilesson/fiction_charactermessage', {\n                            charactermedia: '<div class=\"chat-loader\"></div>'\n                        }).then(function(html,js) {\n                            Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                            that.scrolltobottom();\n                            setTimeout(() => {\n                                Templates.render('mod_minilesson/fiction_charactermessage', that.mobilechatdata).then(\n                                    function(html,js) {\n                                        Templates.replaceNode(\n                                            that.controls.chatwrapper.find('> .chat-window').last(),\n                                            html,\n                                            js\n                                        );\n                                        that.scrolltobottom();\n                                        const oldcharactermedia = that.mobilechatdata.charactermedia;\n                                        that.reset_mobilechat_data();\n                                        that.mobilechatdata.charactermedia = oldcharactermedia;\n                                        // Enable the continue button\n                                        if (!currentResult.isDialogueEnd) {\n                                            that.can_continuebutton(true);\n                                        }\n                                    }\n                                );\n                            }, 2000);\n                        });\n                        that.controls.yarnoptions.html('');\n                    }else {\n                        Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarntext).then(\n                        function (html, js) {\n                            that.controls.yarntext.html(html);\n                            that.controls.yarnoptions.html('');\n                            Templates.runTemplateJS(js);\n                        });\n                        // Enable the continue button\n                        this.can_continuebutton(true);\n                    }\n                } else if(currentResult instanceof YarnBound.OptionsResult) {\n                    // Render the options\n                    yarncontent.yarnoptions = currentResult;\n                    if (that.itemdata.presention_mobilechat) {\n                        var mobilechatdata = {\n                            'yarnoptions': currentResult,\n                            'presention_mobilechat': true,\n                        };\n                        that.controls.yarnoptions.html('');\n                    } else {\n                        var mobilechatdata = currentResult;\n                    }\n                    Templates.render('mod_minilesson/fictionyarnoptions', mobilechatdata).then(\n                    function (html, js) {\n                        setTimeout(() => {\n                            that.controls.yarnoptions.html(html);\n                            Templates.runTemplateJS(js);\n                        }, that.itemdata.presention_mobilechat ? 2000 : 1);\n                    });\n\n                    //If there is some text as well render that, or clear the existing text otherwise\n                    if ('text' in yarncontent.yarnoptions) {\n\n                        if (that.itemdata.presention_mobilechat) {\n                            that.mobilechatdata.picturesrc = yarncontent.yarnoptions.md?.character?.picturesrc;\n                            that.mobilechatdata.charactername = yarncontent.yarnoptions.md?.character?.name;\n                            that.mobilechatdata.charactertext = yarncontent.yarnoptions.text;\n\n                            Templates.render('mod_minilesson/fiction_charactermessage', {\n                                charactermedia: '<div class=\"chat-loader\"></div>'\n                            }).then(function(html,js) {\n                                Templates.appendNodeContents(that.controls.chatwrapper, html, js);\n                                that.scrolltobottom();\n                                setTimeout(() => {\n                                    Templates.render('mod_minilesson/fiction_charactermessage', that.mobilechatdata).then(\n                                        function(html,js) {\n                                            Templates.replaceNode(\n                                                that.controls.chatwrapper.find('> .chat-window').last(),\n                                                html,\n                                                js\n                                            );\n                                            that.scrolltobottom();\n                                            const oldcharactermedia = that.mobilechatdata.charactermedia;\n                                            that.reset_mobilechat_data();\n                                            that.mobilechatdata.charactermedia = oldcharactermedia;\n                                        }\n                                    );\n                                }, 2000);\n                            });\n                        } else {\n                            Templates.render('mod_minilesson/fictionyarntext', yarncontent.yarnoptions).then(\n                            function (html, js) {\n                                that.controls.yarntext.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                        }\n                    } else {\n                        that.controls.yarntext.html('');\n                    }\n\n                    // Disable the continue button, because they need to select an option\n                    that.can_continuebutton(false);\n\n                } else if (currentResult instanceof YarnBound.CommandResult) {\n                    // Process the command string a little. so we have command name and args\n                    //eg \"picture 1.png\"\n                    var rawCommand = currentResult.command;\n                    var parts = rawCommand.split(' ');\n                    var commandName = parts[0]; // \"picture\" \"audio etc\"\n                    var args = parts.slice(1); // [\"1.png\"]\n                    let promise = null;\n\n\n                    switch(commandName) {\n                        case 'picture': {\n                            log.debug('got picture command');\n                            const imageURL = args[0]; // \"picture https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnimage', {\"imageurl\": imageURL}).then(\n                            function (html, js) {\n                                that.controls.yarnmedia.html(html);\n                                if (that.itemdata.presention_mobilechat) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                }\n                                Templates.runTemplateJS(js);\n                            });\n                            break;\n                        }\n                        case 'audio': {\n                            log.debug('got audio command');\n                            const audioURL = args[0]; // \"audio https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnaudio', {\"audiourl\": audioURL}).then(\n                            function (html, js) {\n                                if (that.itemdata.presention_mobilechat) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                }\n                                that.controls.yarnmedia.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                            break;\n                        }\n                        case 'video': {\n                            log.debug('got video command');\n                            const videoURL = args[0]; // \"video https://blahblah\"\n                            promise = Templates.render('mod_minilesson/fictionyarnvideo', {\"videourl\": videoURL}).then(\n                            function (html, js) {\n                                if (that.itemdata.presention_mobilechat) {\n                                    that.mobilechatdata.charactermedia = html;\n                                    that.mobilechatdata.classname = 'hasmedia';\n                                }\n                                that.controls.yarnmedia.html(html);\n                                Templates.runTemplateJS(js);\n                            });\n                            break;\n                        }\n                        case 'clearpicture': {\n                            that.controls.yarnmedia.html('');\n                            break;\n                        }\n                        case 'blahblah':\n                        default:\n                    }\n                    // In all cases just do command and then jump to next line\n                    if(!currentResult.isDialogueEnd) {\n                        // Just skip through for now\n                        if (promise) {\n                            promise.then(() => {\n                                that.do_runner_advance();\n                                that.do_render();\n                            });\n                        } else {\n                            that.do_runner_advance();\n                            that.do_render();\n                        }\n                        return;\n                    }\n                } else {\n                    log.debug('MiniLesson Fiction: unknown yarn result type');\n                }\n\n                 // In all cases on dialog end there is no continue\n                if(currentResult.isDialogueEnd) {\n                    that.can_continuebutton(false);\n                    return;\n                }\n            },\n\n            do_runner_advance: function (steps) {\n                try {\n                    if(steps !== null){\n                        this.runner.advance(steps);\n                    } else {\n                        this.runner.advance();\n                    }\n                } catch (e) {\n                    var userFriendlyError = \"Yarn Parse Error: \" + e.message;\n                    this.controls.yarncontainer.html(\n                        `<div class=\"alert alert-danger\">${userFriendlyError}</div>`\n                    );\n                    log.error(\"Full Yarn Error:\");\n                    log.error(e);\n                }\n            },\n\n            can_continuebutton: function (cancontinue) {\n                this.controls.yarncontinuebutton.prop(\"disabled\", !cancontinue);\n                if (cancontinue){\n                    this.controls.yarncontinuebutton.show();\n                } else {\n                    this.controls.yarncontinuebutton.hide();\n                }\n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n                var self = this;\n                //When click next button , report and leave it up to parent to eal with it.\n                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function () {\n                    var stepdata = {};\n                    stepdata.index = index;\n                    stepdata.hasgrade = false;\n                    stepdata.totalitems = 0;\n                    stepdata.correctitems = 0;\n                    stepdata.grade = 0;\n                    quizhelper.do_next(stepdata);\n                });\n                $(\"#\" + itemdata.uniqueid + \"_container\").on(\"showElement\", async () => {\n                    if (!self.instance) {\n                        // Maybe init yarn-bound here\n                        //this.do_render();\n                    }\n\n                    if (itemdata.timelimit > 0) {\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").trigger('click');\n                            }\n                        });\n                    }\n                });\n\n\n                this.controls.yarncontinuebutton.on('click', function (e) {\n                    log.debug('MiniLesson Fiction: yarn continue button clicked');\n                    e.preventDefault();\n                    if (self.itemdata.presention_mobilechat) {\n                        const playertext = $(this).siblings('.optiontext').text().trim();\n                        Templates.render('mod_minilesson/fiction_playermessage', {playertext: playertext}).then(\n                            function (html, js) {\n                                Templates.appendNodeContents(self.controls.chatwrapper, html, js);\n                            }\n                        );\n                    }\n                    self.do_runner_advance();\n                    self.do_render();\n                });\n\n                // add an event listener for option buttons that handles option buttons added at runtim\n                this.controls.yarncontainer.on('click', '.minilesson_fiction_optionbutton', function (e) {\n                    log.debug('MiniLesson Fiction: yarn option button clicked');\n                    e.preventDefault();\n\n                    var buttons = self.controls.yarncontainer.find('.minilesson_fiction_optionbutton');\n                    var optionindex = buttons.index(this); // 0-based position in the rendered list\n\n                    if (self.itemdata.presention_mobilechat) {\n                        const playertext = $(this).siblings('.optiontext').text().trim();\n                        Templates.render('mod_minilesson/fiction_playermessage', {playertext: playertext}).then(\n                            function (html, js) {\n                                Templates.appendNodeContents(self.controls.chatwrapper, html, js);\n                            }\n                        );\n                    }\n                    self.do_runner_advance(optionindex);\n                    self.do_render();\n                });\n\n                if (this.itemdata.presention_mobilechat) {\n                    let scrollbtn = $(\"#\" + itemdata.uniqueid + \"_container .mobilechat #scroll-bottom-btn\");\n\n                    this.controls.chatwrapper.on(\"scroll\", function() {\n                        const chatwrapper = self.controls.chatwrapper[0];\n                        const isatbottom = chatwrapper.scrollHeight - chatwrapper.scrollTop <= chatwrapper.clientHeight + 5;\n                        if (isatbottom) {\n                            scrollbtn.hide();\n                        } else {\n                            scrollbtn.show();\n                        }\n                    });\n\n                    scrollbtn.on('click', function(e) {\n                        e.preventDefault();\n                        e.stopPropagation();\n                        self.controls.chatwrapper.animate({\n                            scrollTop: self.controls.chatwrapper[0].scrollHeight\n                        }, 'smooth');\n                    });\n                }\n            },\n\n            add_metadata: function (currentthing) {\n                if (currentthing && 'markup' in currentthing && Array.isArray(currentthing.markup)) {\n                    currentthing.md = {};\n                    //for each markup entry, add the property name and values object to currentthing\n                    currentthing.markup.forEach(function (entry) {\n                        if ('properties' in entry && 'name' in entry) {\n                            currentthing.md[entry.name] = entry.properties;\n                        }\n                    });\n                    if (currentthing.md.character?.name) {\n                        const charname = currentthing.md.character.name.toLowerCase();\n                        currentthing.md.character.picturesrc = this.itemdata.filenamesmap\n                            .find(fileinfo => fileinfo.filekey === charname)?.fileurl || null;\n                    }\n                }\n                return currentthing;\n            },\n\n            register_previewbutton: function (buttonid) {\n                var previewbtn = document.getElementById(buttonid);\n                if (!previewbtn) {\n                    return;\n                }\n                previewbtn.addEventListener('click', function (e) {\n                    e.preventDefault();\n                    var form = previewbtn.form;\n                    if (!form) {\n                        return;\n                    }\n                    ModalFactory.create({\n                        type: ModalFactory.types.CANCEL,\n                        large: true,\n                        removeOnClose: true,\n                        templateContext: {\n                            classes: 'minilesson-fiction-preview-modal'\n                        },\n                        title: Str.get_string('fiction:previewmodaltitle', 'mod_minilesson'),\n                        body: Fragment.loadFragment('mod_minilesson', 'preview_fiction', M.cfg.contextid, {\n                            formdata: new URLSearchParams([...new FormData(form).entries()]).toString()\n                        })\n                    }).then(function (modal) {\n                        modal.getFooter().addClass('d-none');\n                        modal.show();\n                    });\n                    return;\n                });\n\n            },\n\n            reset_mobilechat_data: function() {\n                this.mobilechatdata = {\n                    charactername: null,\n                    charactermedia: null,\n                    charactertext: null,\n                    picturesrc: null,\n                    playertext: null,\n                };\n            },\n            scrolltobottom: function() {\n                if (!this.controls.chatwrapper.length) {\n                    return;\n                }\n                this.controls.chatwrapper.scrollTop(this.controls.chatwrapper[0].scrollHeight);\n                this.controls.chatwrapper.animate({\n                    scrollTop: this.controls.chatwrapper[0].scrollHeight + 5,\n                    behavior: 'smooth'\n                });\n            }\n        };\n    });"],"file":"fiction.min.js"}