function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("mod_minilesson/shortanswer",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],function(a,b,c,d,e,f){"use strict";b.debug("MiniLesson ShortAnswer: initialising");return{ttrec:null,passmark:100,fullycorrect:!1,partiallycorrect:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){var d={useanimatecss:c.useanimatecss};f.init(d);this.itemdata=b;this.register_events(a,b,c);this.init_components(a,b,c)},next_question:function next_question(){var a=this,c={};c.index=a.index;c.hasgrade=!0;c.totalitems=a.itemdata.correctmarks;c.correctitems=0;if(a.fullycorrect){c.correctitems=a.itemdata.correctmarks}else if(a.partiallycorrect){c.correctitems=a.itemdata.partialmarks}if(0<c.correctitems){c.grade=100*c.correctitems/c.totalitems}b.debug("stepdata");b.debug(c);a.quizhelper.do_next(c)},prepare_audio:function prepare_audio(b){a.each(b.sentences,function(c,e){d.fetch_polly_url(e.sentence,b.voiceoption,b.usevoice).then(function(d){a("#"+b.uniqueid+"_option"+(c+1)).attr("data-src",d)})})},register_events:function register_events(b,c,d){var e=this;e.index=b;e.quizhelper=d;a("#"+c.uniqueid+"_container .minilesson_nextbutton").on("click",function(){e.next_question()});a("#"+c.uniqueid+"_container ."+c.uniqueid+"_option").on("click",function(){a("."+c.uniqueid+"_option").prop("disabled",!0);a("."+c.uniqueid+"_fb").html("<i style='color:red;' class='fa fa-times'></i>");a("."+c.uniqueid+"_option"+c.correctanswer+"_fb").html("<i style='color:green;' class='fa fa-check'></i>");a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);e.next_question()},2e3)})},init_components:function init_components(c,d,g){var h=this,j=d.sentences,k=d.partialresponses;b.debug("initcomponents_shortanswer");b.debug(j);for(var l=0;l<j.length;l++){j[l].originalsentence=j[l].sentence;j[l].sentence=g.cleanText(j[l].sentence)}for(var l=0;l<k.length;l++){k[l].originalsentence=k[l].sentence;k[l].sentence=g.cleanText(k[l].sentence)}var m=function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function c(e){var l,m,n,o,p,q,r,s,t,u,v;return regeneratorRuntime.wrap(function(c){while(1){switch(c.prev=c.next){case 0:l=g.cleanText(e);m=l;b.debug("speechtext:",e);b.debug("cleanspeechtext:",m);n=!1;o=0;case 7:if(!(o<j.length)){c.next=19;break}if(!(""===j[o].sentence)){c.next=10;break}return c.abrupt("continue",16);case 10:p=g.similarity(m,j[o].sentence);b.debug("JS similarity: "+m+":"+j[o].sentence+":"+p);if(!(p>=h.passmark||h.spokenIsCorrect(g,l,j[o].sentence))){c.next=16;break}h.process_accepted_response(d,o);n=!0;return c.abrupt("break",19);case 16:o++;c.next=7;break;case 19:if(n){c.next=36;break}o=0;case 21:if(!(o<j.length)){c.next=36;break}c.next=24;return g.checkByPhonetic(j[o].sentence,m,j[o].phonetic,d.language);case 24:q=c.sent;b.debug(q,"PHP similarity");if(!(!q||q<h.passmark)){c.next=29;break}c.next=33;break;case 29:n=!0;b.debug("PHP similarity: "+m+q);h.process_accepted_response(d,o);return c.abrupt("break",36);case 33:o++;c.next=21;break;case 36:if(n){c.next=59;break}o=0;case 38:if(!(o<j.length)){c.next=59;break}c.next=41;return g.comparePassageToTranscript(j[o].sentence,m,j[o].phonetic,d.language,d.alternates);case 41:r=c.sent;s=JSON.parse(r);t=!1;u=0;case 45:if(!(u<s.length)){c.next=52;break}if(!(!1===s[u].matched)){c.next=49;break}t=!0;return c.abrupt("break",52);case 49:u++;c.next=45;break;case 52:if(t){c.next=56;break}h.process_accepted_response(d,o);n=!0;return c.abrupt("break",59);case 56:o++;c.next=38;break;case 59:h.fullycorrect=n;if(n){c.next=74;break}o=0;case 62:if(!(o<k.length)){c.next=74;break}if(!(""===k[o].sentence)){c.next=65;break}return c.abrupt("continue",71);case 65:p=g.similarity(m,k[o].sentence);b.debug("JS similarity: "+m+":"+k[o].sentence+":"+p);if(!(p>=h.passmark||h.spokenIsCorrect(g,l,k[o].sentence))){c.next=71;break}h.process_accepted_response(d,o);n=!0;return c.abrupt("break",74);case 71:o++;c.next=62;break;case 74:if(n){c.next=91;break}o=0;case 76:if(!(o<k.length)){c.next=91;break}c.next=79;return g.checkByPhonetic(k[o].sentence,m,k[o].phonetic,d.language);case 79:q=c.sent;b.debug(q,"PHP similarity");if(!(!q||q<h.passmark)){c.next=84;break}c.next=88;break;case 84:n=!0;b.debug("PHP similarity: "+m+q);h.process_accepted_response(d,o);return c.abrupt("break",91);case 88:o++;c.next=76;break;case 91:if(n){c.next=114;break}o=0;case 93:if(!(o<k.length)){c.next=114;break}c.next=96;return g.comparePassageToTranscript(k[o].sentence,m,k[o].phonetic,d.language,d.alternates);case 96:r=c.sent;s=JSON.parse(r);t=!1;u=0;case 100:if(!(u<s.length)){c.next=107;break}if(!(!1===s[u].matched)){c.next=104;break}t=!0;return c.abrupt("break",107);case 104:u++;c.next=100;break;case 107:if(t){c.next=111;break}h.process_accepted_response(d,o);n=!0;return c.abrupt("break",114);case 111:o++;c.next=93;break;case 114:h.partiallycorrect=n;if(!n){c.next=121;break}a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question()},2e3);return c.abrupt("return");case 121:v=a("#"+d.uniqueid+"_correctanswer");if(!d.audiorecorder){v=a("#"+d.uniqueid+"_container .textinput_responsetype")}f.do_animate(v,"rubberBand animate__faster").then(function(){});case 124:case"end":return c.stop();}}},c)}));return function(){return c.apply(this,arguments)}}(),n=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(c){return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.t0=c.type;a.next="recording"===a.t0?3:"speech"===a.t0?4:9;break;case 3:return a.abrupt("break",9);case 4:b.debug("speech at shortanswer");b.debug(c.capturedspeech);h.itemdata.audiotextanswer=c.capturedspeech;a.next=9;return m(c.capturedspeech);case 9:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}();if(d.audiorecorder){var o={uniqueid:d.uniqueid};b.debug("sa uniqueid:"+d.uniqueid);o.callback=n;o.stt_guided=g.is_stt_guided();h.ttrec=e.clone();h.ttrec.init(o);for(var p="",l=0;l<j.length;l++){p+=j[l].sentence+" ";j[l].originalsentence=j[l].sentence;j[l].sentence=g.cleanText(j[l].sentence)}h.ttrec.currentPrompt=p}else{a("#"+d.uniqueid+"_container .shortanswer_check_btn").on("click",function(){var b=a("#"+d.uniqueid+"_container .textinput_responsetype"),c=b.val();if(!c){return}m(c)})}},spokenIsCorrect:function spokenIsCorrect(a,b,c){b=a.cleanText(b);c=a.cleanText(c);if(b===c){return!0}return!1},process_accepted_response:function process_accepted_response(b,c){var d=0<=c?b.correctmarks:0;if(0<d){if(0===parseInt(b.show_text)){for(var e=0;e<b.sentences.length;e++){if(b.audiorecorder){a("#"+b.uniqueid+"_option"+(e+1)+" .minilesson_sentence").text(b.sentences[e].sentence)}}}if(b.audiorecorder){var f=a("#"+b.uniqueid+"_correctanswer");f.text(b.audiotextanswer);f.addClass("minilesson_success")}else{var g=a("#"+b.uniqueid+"_container .textinput_responsetype");g.addClass("textinput_success")}}return d}}});
//# sourceMappingURL=shortanswer.min.js.map
