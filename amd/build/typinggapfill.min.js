function _toArray(a){return _arrayWithHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("mod_minilesson/typinggapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates","core/str","core/notification"],function(a,b,c,d,e,f,g,h,i){"use strict";b.debug("MiniLesson typing gap fill: initialising");return{clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){var d=this;d.itemdata=b;d.quizhelper=c;d.index=a;d.strings={};var f={useanimatecss:c.useanimatecss};e.init(f);d.init_controls();d.init_strings();d.register_events();d.getItems();d.appReady()},init_controls:function init_controls(){var b=this;b.controls={container:a("#"+b.itemdata.uniqueid+"_container"),listen_cont:a("#"+b.itemdata.uniqueid+"_container .tgapfill_listen_cont"),nextbutton:a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:a("#"+b.itemdata.uniqueid+"_container .tgapfill_start_btn"),skip_btn:a("#"+b.itemdata.uniqueid+"_container .tgapfill_skip_btn"),ctrl_btn:a("#"+b.itemdata.uniqueid+"_container .tgapfill_ctrl-btn"),check_btn:a("#"+b.itemdata.uniqueid+"_container .tgapfill_check_btn"),game:a("#"+b.itemdata.uniqueid+"_container .tgapfill_game"),controlsbox:a("#"+b.itemdata.uniqueid+"_container .tgapfill_controls"),resultscontainer:a("#"+b.itemdata.uniqueid+"_container .tgapfill_resultscontainer"),mainmenu:a("#"+b.itemdata.uniqueid+"_container .tgapfill_mainmenu"),title:a("#"+b.itemdata.uniqueid+"_container .tgapfill_title"),progress_container:a("#"+b.itemdata.uniqueid+"_container .progress-container"),progress_bar:a("#"+b.itemdata.uniqueid+"_container .progress-container .progress-bar"),question:a("#"+b.itemdata.uniqueid+"_container .question")}},init_strings:function init_strings(){var a=this;h.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(b){var c=0;a.strings.nextlessonitem=b[c++];a.strings.confirm_desc=b[c++];a.strings.yes=b[c++];a.strings.no=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.quizhelper.do_next(b)},show_item_review:function show_item_review(){var a=this,b={};b.items=a.items;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;var c=a.controls.listen_cont,d=a.controls.question,e=a.controls.game,f=a.controls.controlsbox,h=a.controls.resultscontainer;g.render("mod_minilesson/listitemresults",b).then(function(a,b){h.html(a);h.show();e.hide();f.hide();c.hide();d.hide();g.runTemplateJS(b)})},register_events:function register_events(){var b=this;b.controls.nextbutton.on("click",function(){if(b.items.some(function(a){return!a.answered})){i.confirm(b.strings.nextlessonitem,b.strings.confirm_desc,b.strings.yes,b.strings.no,function(){b.next_question()})}else{b.next_question()}});b.controls.start_btn.on("click",function(){b.start()});b.controls.skip_btn.on("click",function(){a(this).prop("disabled",!0);b.controls.check_btn.prop("disabled",!0);b.stopTimer(b.items[b.game.pointer].timer);b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;if(b.game.pointer<b.items.length-1){b.controls.skip_btn.prop("disabled",!0);b.controls.skip_btn.children(".fa").removeClass("fa-arrow-right");b.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin");setTimeout(function(){b.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin");b.controls.skip_btn.children(".fa").addClass("fa-arrow-right");b.controls.skip_btn.prop("disabled",!1);b.controls.container.find(".tgapfill_reply_"+b.game.pointer).hide();b.game.pointer++;b.nextPrompt()},2e3)}else{b.end()}});b.controls.check_btn.on("click",function(){b.check_answer()});b.controls.container.on("keydown",".single-character",function(a){if(13==a.which){b.check_answer()}})},game:{pointer:0},check_answer:function check_answer(){var b=this,c=b.items[b.game.pointer].parsedstring,d=b.controls.container.find(".tgapfill_reply_"+b.game.pointer+" input.single-character"),e=[];d.each(function(){var b=a(this).data("index"),c=a(this).val();e.push={index:b,value:c}});b.getComparison(c,e,function(a){b.gotComparison(a)})},getItems:function getItems(){var a=this,b=a.itemdata.sentences;a.items=b.map(function(a){return{target:a.sentence,prompt:a.prompt,parsedstring:a.parsedstring,definition:a.definition,timer:[],typed:"",answered:!1,correct:!1,audio:null,imageurl:a.imageurl}}).filter(function(a){return""!==a.target})},appReady:function appReady(){var a=this;a.controls.container.find(".tgapfill_not_loaded").hide();a.controls.container.find(".tgapfill_loaded").show();if(a.itemdata.hidestartpage){a.start()}else{a.controls.start_btn.prop("disabled",!1)}},gotComparison:function gotComparison(a){var b=this,c=b.controls.progress_bar;if(a){b.controls.container.find(".tgapfill_reply_"+b.game.pointer+" .tgapfill_feedback[data-idx=\""+b.game.pointer+"\"]").addClass("fa fa-check");b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!0;b.items[b.game.pointer].typed=!1;b.controls.container.find(".tgapfill_reply_"+b.game.pointer+" input").addClass("ml_gapfill_char_correct")}else if(!b.itemdata.allowretry||c.hasClass("progress-bar-complete")){b.controls.container.find(".tgapfill_reply_"+b.game.pointer+" .tgapfill_feedback[data-idx=\""+b.game.pointer+"\"]").addClass("fa fa-times");b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;b.items[b.game.pointer].typed=!1}else{var d=b.controls.container.find(".tgapfill_reply_"+b.game.pointer);e.do_animate(d,"shakeX animate__faster").then(function(){b.controls.ctrl_btn.prop("disabled",!1)});return}b.stopTimer(b.items[b.game.pointer].timer);if(b.game.pointer<b.items.length-1){setTimeout(function(){b.controls.container.find(".tgapfill_reply_"+b.game.pointer).hide();b.game.pointer++;b.nextPrompt()},2e3)}else{b.end()}},getComparison:function getComparison(a,b,c){var d=this;d.controls.ctrl_btn.prop("disabled",!0);var e=!0;a.forEach(function(a,b){var c="";if("input"===a.type){if(!0===e){c=d.controls.container.find(".tgapfill_reply_"+d.game.pointer+" input.single-character[data-index=\""+b+"\"]").val();if(""==c){e=!1}else if(c!=a.character){e=!1}}}});c(e)},end:function end(){var a=this;a.controls.nextbutton.prop("disabled",!0);a.updateProgressDots();setTimeout(function(){a.controls.nextbutton.prop("disabled",!1);if(a.quizhelper.showitemreview){a.show_item_review()}else{a.next_question()}},2e3)},start:function start(){var a=this;a.controls.ctrl_btn.prop("disabled",!0);a.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});a.game.pointer=0;a.controls.question.show();a.controls.start_btn.hide();a.controls.mainmenu.hide();a.controls.controlsbox.show();a.nextPrompt()},nextPrompt:function nextPrompt(){var a=this;a.controls.ctrl_btn.prop("disabled",!1);a.updateProgressDots();a.nextReply()},updateProgressDots:function updateProgressDots(){var a=this,b,c=a.items.map(function(c,d){b="gray";if(a.items[d].answered&&a.items[d].correct){b="green"}else if(a.items[d].answered&&!a.items[d].correct){b="red"}return"<i style='color:"+b+"' class='fa fa-circle'></i>"}).join(" ");a.controls.title.html(c)},nextReply:function nextReply(){var a=this,b="<div class='tgapfill_reply tgapfill_reply_"+a.game.pointer+" text-center' style='display:none;'>",c={started:!1,ended:!1,index:null};b+="<div class='form-container'>";a.items[a.game.pointer].parsedstring.forEach(function(a,d){if(c.started&&!c.ended&&c.index!==a.index){c.started=c.ended=!1;b+="</span>"}if(("input"===a.type||"mtext"===a.type)&&!c.started){b+="<span class=\"form-input-phrase-online\" data-mindex=\""+a.index+"\">";c.started=!0}c.index=a.index;if("input"===a.type){b+="<input class='single-character' autocomplete='off' autocapitalize='off' type='text' name='filltext"+d+"' maxlength='1' data-index='"+d+"'>"}else if("mtext"===a.type){b+="<input class='single-character-mtext' type='text' name='readonly"+d+"' maxlength='1' value='"+a.character+"' readonly>"}else{b+=a.character}});if(c.started&&!c.ended){b+="</span>"}b+=" <i data-idx='"+a.game.pointer+"' class='tgapfill_feedback'></i></div>";if(a.items[a.game.pointer].imageurl){b+="<div class='minilesson_sentence_image'><div class='minilesson_padded_image'><img src='"+a.items[a.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"}if(a.items[a.game.pointer].definition){b+="<div class='definition-container'><div class='definition'>"+a.items[a.game.pointer].definition+"</div>"}b+="</div>";a.controls.question.append(b);var d=a.controls.container.find(".tgapfill_reply_"+a.game.pointer);e.do_animate(d,"zoomIn animate__faster","in").then(function(){});a.controls.ctrl_btn.prop("disabled",!1);var f=Array.from(a.controls.container.find(".tgapfill_reply_"+a.game.pointer+" input.single-character"));a.formReady(f);a.controls.container.find(".tgapfill_reply_"+a.game.pointer+" input.single-character:first").focus();a.startTimer()},startTimer:function startTimer(){var b=this;if(0<b.itemdata.timelimit){var c=function(){b.controls.progress_container.show();b.controls.progress_container.find("i").show();var c=b.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){b.controls.skip_btn.trigger("click")}});c.each(function(){b.items[b.game.pointer].timer.push(a(this).attr("timer"))})};if(b.itemdata.hidestartpage&&0===b.game.pointer){b.controls.container.on("showElement",function(){c()})}else{c()}}},stopTimer:function stopTimer(a){if(a.length){a.forEach(function(a){clearInterval(a)})}},formReady:function formReady(a){a.forEach(function(b,c){b.addEventListener("keydown",function(b){if(8===b.keyCode&&""===b.target.value){a[Math.max(0,c-1)].focus()}});b.addEventListener("input",function(b){var d=_toArray(b.target.value),e=d[0],f=d.slice(1);b.target.value=null!==e&&void 0!==e?e:"";var g=c===a.length-1;if(e!==void 0&&!g){a[c+1].focus();a[c+1].value=f.join("");a[c+1].dispatchEvent(new Event("input"))}})})}}});
//# sourceMappingURL=typinggapfill.min.js.map
