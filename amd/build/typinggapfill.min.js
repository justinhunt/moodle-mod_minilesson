define("mod_minilesson/typinggapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates","core/str","core/notification","mod_minilesson/external/simplekeyboard","mod_minilesson/external/keyboardlayouts"],(function($,log,ajax,def,anim,progresstimer,templates,str,notification,SimpleKeyboard,KeyboardLayouts){return log.debug("MiniLesson typing gap fill: initialising"),{clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index,this.strings={},this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index,this.activeInputElement=null;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.init_controls(),this.init_strings(),this.register_events(),this.getItems(),this.appReady()},init_controls:function(){this.controls={container:$("#"+this.itemdata.uniqueid+"_container"),listen_cont:$("#"+this.itemdata.uniqueid+"_container .tgapfill_listen_cont"),nextbutton:$("#"+this.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:$("#"+this.itemdata.uniqueid+"_container .tgapfill_start_btn"),skip_btn:$("#"+this.itemdata.uniqueid+"_container .tgapfill_skip_btn"),ctrl_btn:$("#"+this.itemdata.uniqueid+"_container .tgapfill_ctrl-btn"),check_btn:$("#"+this.itemdata.uniqueid+"_container .tgapfill_check_btn"),game:$("#"+this.itemdata.uniqueid+"_container .tgapfill_game"),controlsbox:$("#"+this.itemdata.uniqueid+"_container .tgapfill_controls"),resultscontainer:$("#"+this.itemdata.uniqueid+"_container .tgapfill_resultscontainer"),mainmenu:$("#"+this.itemdata.uniqueid+"_container .tgapfill_mainmenu"),title:$("#"+this.itemdata.uniqueid+"_container .tgapfill_title"),progress_container:$("#"+this.itemdata.uniqueid+"_container .progress-container"),progress_bar:$("#"+this.itemdata.uniqueid+"_container .progress-container .progress-bar"),question:$("#"+this.itemdata.uniqueid+"_container .question"),description:$("#"+this.itemdata.uniqueid+"_container .tgapfill_description"),image:$("#"+this.itemdata.uniqueid+"_container .tgapfill_image_container"),maintitle:$("#"+this.itemdata.uniqueid+"_container .tgapfill_maintitle"),itemquestion:$("#"+this.itemdata.uniqueid+"_container .tgapfill_itemtext")}},init_strings:function(){var self=this;str.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(s){var i=0;self.strings.nextlessonitem=s[i++],self.strings.confirm_desc=s[i++],self.strings.yes=s[i++],self.strings.no=s[i++]}))},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};this.items.forEach((function(item){var itemwordlist=[];item.parsedstring.forEach((function(data){"input"!==data.type&&"mtext"!==data.type||itemwordlist.push(data.character)}));var wordmatch=itemwordlist.join(""),regex=new RegExp(wordmatch,"gi"),answerclass=item.correct?"correctitem":"wrongitem",result=item.target.replace(regex,'<span class="'.concat(answerclass,'">').concat(wordmatch,"</span>"));item.target=result})),review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var listencont=this.controls.listen_cont,qbox=this.controls.question,gamebox=this.controls.game,controlsbox=this.controls.controlsbox,resultsbox=this.controls.resultscontainer;templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),listencont.hide(),qbox.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;self.controls.nextbutton.on("click",(function(e){self.items.some((item=>!item.answered))?notification.confirm(self.strings.nextlessonitem,self.strings.confirm_desc,self.strings.yes,self.strings.no,(function(){self.next_question()})):self.next_question()})),self.controls.start_btn.on("click",(function(){self.start()})),self.controls.skip_btn.on("click",(function(){$(this).prop("disabled",!0),self.controls.check_btn.prop("disabled",!0),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?(self.controls.skip_btn.prop("disabled",!0),self.controls.skip_btn.children(".fa").removeClass("fa-arrow-right"),self.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin"),setTimeout((function(){self.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin"),self.controls.skip_btn.children(".fa").addClass("fa-arrow-right"),self.controls.skip_btn.prop("disabled",!1),self.controls.container.find(".tgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3)):self.end()})),self.controls.check_btn.on("click",(function(){self.check_answer()})),self.controls.container.on("keydown",".single-character",(function(e){13==e.which&&self.check_answer()}))},game:{pointer:0},check_answer:function(){var self=this,passage=self.items[self.game.pointer].parsedstring,characterunputs=self.controls.container.find(".tgapfill_reply_"+self.game.pointer+" input.single-character"),transcript=[];characterunputs.each((function(){var index=$(this).data("index"),value=$(this).val();transcript.push={index:index,value:value}})),self.getComparison(passage,transcript,(function(comparison){self.gotComparison(comparison)}))},getItems:function(){var text_items=this.itemdata.sentences;this.items=text_items.map((function(target){return{target:target.sentence,prompt:target.prompt,parsedstring:target.parsedstring,definition:target.definition,timer:[],typed:"",answered:!1,correct:!1,audio:null,imageurl:target.imageurl}})).filter((function(e){return""!==e.target}))},appReady:function(){this.controls.container.find(".tgapfill_not_loaded").hide(),this.controls.container.find(".tgapfill_loaded").show(),this.itemdata.hidestartpage?this.start():this.controls.start_btn.prop("disabled",!1)},gotComparison:function(comparison){var self=this,timelimit_progressbar=self.controls.progress_bar;if(comparison.allcorrect)self.controls.container.find(".tgapfill_reply_"+self.game.pointer+' .tgapfill_feedback[data-idx="'+self.game.pointer+'"]').addClass("fa fa-check"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=!1,self.controls.container.find(".tgapfill_reply_"+self.game.pointer+" input").addClass("ml_gapfill_char_correct");else{if(self.itemdata.allowretry&&!timelimit_progressbar.hasClass("progress-bar-complete")){comparison.charscorrect.forEach((function(iscorrect,index){iscorrect&&self.controls.container.find(".tgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]').addClass("ml_gapfill_char_correct")}));var thereply=self.controls.container.find(".tgapfill_reply_"+self.game.pointer);return void anim.do_animate(thereply,"shakeX animate__faster").then((function(){self.controls.ctrl_btn.prop("disabled",!1)}))}self.controls.container.find(".tgapfill_reply_"+self.game.pointer+' .tgapfill_feedback[data-idx="'+self.game.pointer+'"]').addClass("fa fa-times"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.items[self.game.pointer].typed=!1}self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1?setTimeout((function(){self.controls.container.find(".tgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()},getComparison:function(passage,transcript,callback){var self=this;self.controls.ctrl_btn.prop("disabled",!0);var correctanswer=!0,charscorrect=[];passage.forEach((function(data,index){var char="";"input"===data.type&&(""==(char=self.controls.container.find(".tgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]').val())||char!=data.character?(correctanswer=!1,charscorrect[index]=!1):charscorrect[index]=!0)})),callback({allcorrect:correctanswer,charscorrect:charscorrect})},end:function(){var self=this;self.controls.nextbutton.prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){self.controls.nextbutton.prop("disabled",!1),self.quizhelper.showitemreview?(self.controls.progress_container.removeClass("d-flex"),self.controls.progress_container.hide(),self.controls.title.hide(),self.show_item_review()):self.next_question()}),2e3)},start:function(){this.controls.ctrl_btn.prop("disabled",!0),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,this.controls.question.show(),this.controls.start_btn.hide(),this.controls.mainmenu.hide(),this.controls.maintitle.show(),this.controls.itemquestion.show(),this.controls.description.hide(),this.controls.image.hide(),this.controls.controlsbox.show(),this.nextPrompt()},nextPrompt:function(){this.controls.ctrl_btn.prop("disabled",!1),this.updateProgressDots(),this.nextReply()},updateProgressDots:function(){var color,icon,self=this,progress=self.items.map((function(item,idx){return color="#E6E9FD",icon="fa fa-square",self.items[idx].answered&&self.items[idx].correct?(color="#74DC72",icon="fa fa-check-square"):self.items[idx].answered&&!self.items[idx].correct&&(color="#FB6363",icon="fa fa-window-close"),"<i style='color:"+color+"' class='"+icon+" pl-1'></i>"})).join(" ");self.controls.title.html(progress)},nextReply:function(){var self=this,code="<div class='tgapfill_reply tgapfill_reply_"+self.game.pointer+" text-center' style='display:none;'>",brackets={started:!1,ended:!1,index:null};code+="<div class='form-container'>",self.items[self.game.pointer].parsedstring.forEach((function(data,index){brackets.started&&!brackets.ended&&brackets.index!==data.index&&(brackets.started=brackets.ended=!1,code+="</span>"),"input"!==data.type&&"mtext"!==data.type||brackets.started||(code+='<span class="form-input-phrase-online" data-mindex="'+data.index+'">',brackets.started=!0),brackets.index=data.index,"input"===data.type?code+="<input class='single-character' autocomplete='off' autocapitalize='off' type='text' name='filltext"+index+"' maxlength='1' data-index='"+index+"'>":"mtext"===data.type?code+="<input class='single-character-mtext' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),brackets.started&&!brackets.ended&&(code+="</span>"),code+=" <i data-idx='"+self.game.pointer+"' class='tgapfill_feedback'></i></div>",self.items[self.game.pointer].imageurl&&(code+="<div class='minilesson_sentence_image'><div class='minilesson_padded_image'><img src='"+self.items[self.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"),self.items[self.game.pointer].definition&&(code+="<div class='definition-container'><div class='definition'><div class='hinticon-container'><i class='fa fa-lightbulb-o hinticon'></i></div>"+self.items[self.game.pointer].definition+"</div>"),code+="</div>",self.controls.question.append(code);var newreply=self.controls.container.find(".tgapfill_reply_"+self.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),self.controls.ctrl_btn.prop("disabled",!1);var inputElements=Array.from(self.controls.container.find(".tgapfill_reply_"+self.game.pointer+" input.single-character"));if(self.itemdata.enablevkeyboard&&"0"!=self.itemdata.enablevkeyboard){var KeyboardClass=SimpleKeyboard.default||SimpleKeyboard,keyboardConfig={onKeyPress:button=>self.onKeyPress(button)};if("2"==self.itemdata.enablevkeyboard){var customKeys=self.itemdata.customkeys||"",charArray=customKeys.split(" ").filter((c=>""!==c.trim()));0===charArray.length&&customKeys.trim().length>0&&(charArray=customKeys.trim().split(""));var upperArray=charArray.map((c=>c.toUpperCase())),lowerRow=charArray.join(" ")+" {shift}",upperRow=upperArray.join(" ")+" {shift}";keyboardConfig.layout={default:[lowerRow],shift:[upperRow]},keyboardConfig.display={"{shift}":"â‡§"},keyboardConfig.useStandardCaps=!1,keyboardConfig.mergeDisplay=!0}else{var keyboardLayouts=new(KeyboardLayouts.default||KeyboardLayouts),layoutName=self.get_keyboard_layout(self.itemdata.language),layout=keyboardLayouts.get(layoutName);$.extend(keyboardConfig,layout)}self.keyboard=new KeyboardClass(".simple-keyboard-"+self.itemdata.uniqueid,keyboardConfig),self.controls.container.find(".ml_simple_keyboard_toggle").on("click",(function(e){var kb=self.controls.container.find(".simple-keyboard-"+self.itemdata.uniqueid);kb.is(":visible")?kb.hide():kb.show()}))}self.formReady(inputElements),self.controls.container.find(".tgapfill_reply_"+self.game.pointer+" input.single-character:first").focus(),self.startTimer()},onKeyPress:function(button){if("{shift}"!==button&&"{lock}"!==button){if(this.activeInputElement){var nativeElement=this.activeInputElement[0];if("{bksp}"===button)if(""===nativeElement.value){var event=new KeyboardEvent("keydown",{bubbles:!0,cancelable:!0,key:"Backspace",code:"Backspace",keyCode:8,which:8});nativeElement.dispatchEvent(event)}else{nativeElement.value="",nativeElement.classList.remove("ml_gapfill_char_correct");event=new Event("input",{bubbles:!0});nativeElement.dispatchEvent(event)}else if(1===button.length){nativeElement.value=button,nativeElement.classList.remove("ml_gapfill_char_correct");event=new Event("input",{bubbles:!0});nativeElement.dispatchEvent(event)}}}else{var shiftToggle="default"===this.keyboard.options.layoutName?"shift":"default";this.keyboard.setOptions({layoutName:shiftToggle});var kbContainers=this.controls.container.find(".simple-keyboard-"+this.itemdata.uniqueid);"shift"===shiftToggle?kbContainers.addClass("vkeyboard-shifted"):kbContainers.removeClass("vkeyboard-shifted")}},get_keyboard_layout:function(lang){switch(lang.substring(0,2).toLowerCase()){case"en":default:return"english";case"de":return"german";case"es":return"spanish";case"fr":return"french";case"it":return"italian";case"ja":return"japanese";case"ko":return"korean";case"pt":return"portuguese";case"ru":return"russian";case"tr":return"turkish";case"uk":return"ukrainian";case"zh":return"chinese";case"ar":return"arabic";case"el":return"greek";case"he":return"hebrew";case"hi":return"hindi";case"th":return"thai";case"ur":return"urdu"}},startTimer:function(){var self=this;if(self.itemdata.timelimit>0){var doStartTimer=function(){self.controls.progress_container.show(),self.controls.progress_container.addClass("d-flex align-items-center"),self.controls.progress_container.find("i").show(),self.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){self.controls.skip_btn.trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))}))};self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{doStartTimer()})):doStartTimer()}},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))},formReady:function(inputElements){var self=this;inputElements.forEach((function(ele,index){ele.addEventListener("focus",(function(e){self.activeInputElement=$(e.target)})),ele.addEventListener("keydown",(function(e){switch(e.keyCode){case 8:""===e.target.value?inputElements[Math.max(0,index-1)].focus():e.target.classList.remove("ml_gapfill_char_correct");break;case 39:e.preventDefault(),inputElements[Math.min(inputElements.length-1,index+1)].focus();break;case 37:e.preventDefault(),inputElements[Math.max(0,index-1)].focus();break;default:""!==e.target.value&&1===e.key.length&&(e.target.value=e.target.value.replace(e.target.value,e.key),e.target.classList.remove("ml_gapfill_char_correct"),e.target.dispatchEvent(new Event("input")))}})),ele.addEventListener("input",(function(e){const[first,...rest]=e.target.value;e.target.value=null!=first?first:"";const lastInputBox=index===inputElements.length-1;void 0!==first&&!lastInputBox&&(inputElements[index+1].focus(),rest.length>0&&(inputElements[index+1].value=rest.join(""),inputElements[index+1].dispatchEvent(new Event("input"))))}))}))}}}));

//# sourceMappingURL=typinggapfill.min.js.map