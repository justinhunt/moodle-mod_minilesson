{"version":3,"sources":["../src/freewriting.js"],"names":["define","$","log","str","notification","def","correctionsmarkup","templates","debug","transcript_evaluation","rawscore","percentscore","strings","clone","extend","init","index","itemdata","quizhelper","init_strings","init_components","register_events","self","get_strings","done","s","i","notsubmitted","notsubmit","submitnow","cancel","next_question","stepdata","hasgrade","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","score","Math","round","marks","nextbutton","on","e","preventDefault","wordcount","count_words","thetextarea","val","submitted","confirm","submitbutton","click","text","nopasting","bind","transcript","do_evaluation","uniqueid","timelimit","show","progressTimer","height","timeLimit","onFinish","trigger","allwords","actionbox","pendingbox","resultsbox","timerdisplay","do_corrections_markup","grammarerrors","grammarmatches","insertioncount","correctionscontainer","find","speechtext","hide","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","rawspeech","maxscore","showitemreview","render","html","js","hasOwnProperty","runTemplateJS","ttrec","timer","reset","displaytime","fetch_display_time"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log','core/str', 'core/notification','mod_minilesson/definitions', 'mod_minilesson/correctionsmarkup', 'core/templates'],\n    function($, log,  str, notification, def,  correctionsmarkup, templates) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the free writing item type\n   */\n\n  log.debug('MiniLesson FreeWriting: initialising');\n\n      return {\n\n        transcript_evaluation: null,\n        rawscore: 0,\n        percentscore: 0,\n        strings: {},\n\n        //for making multiple instances\n        clone: function () {\n          return $.extend(true, {}, this);\n        },\n\n        init: function(index, itemdata, quizhelper) {\n          this.itemdata = itemdata;\n          log.debug('itemdata',itemdata);\n          this.quizhelper = quizhelper;\n          this.init_strings();\n          this.init_components(quizhelper,itemdata);\n          this.register_events(index, itemdata, quizhelper);\n        },\n\n        init_strings: function(){\n          var self = this;\n          str.get_strings([\n            { \"key\": \"notsubmitted\", \"component\": 'mod_minilesson'},\n            { \"key\": \"notsubmit\", \"component\": 'mod_minilesson'},\n            { \"key\": \"submitnow\", \"component\": 'mod_minilesson'},\n            { \"key\": \"cancel\", \"component\": 'core'},\n          ]).done(function (s) {\n            var i = 0;\n            self.strings.notsubmitted = s[i++];\n            self.strings.notsubmit = s[i++];\n            self.strings.submitnow = s[i++];\n            self.strings.cancel = s[i++];\n          });\n        },\n\n        next_question: function() {\n          var self = this;\n          var stepdata = {};\n          stepdata.index = self.index;\n          stepdata.hasgrade = true;\n          stepdata.totalitems = self.itemdata.totalmarks;\n          stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\n          stepdata.grade = self.percentscore;\n          stepdata.resultsdata = self.transcript_evaluation;\n          self.quizhelper.do_next(stepdata);\n        },\n\n        calculate_score: function(transcript_evaluation) {\n          var self = this;\n\n          if(transcript_evaluation === null){\n            return 0;\n          }\n\n          //words ratio\n          var wordsratio = 1;\n          if(self.itemdata.countwords) {\n            wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\n            if(wordsratio > 1){wordsratio = 1;}\n          }\n\n          //relevance\n          var relevanceratio = 1;\n          if(self.itemdata.relevance > 0){\n            relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\n            if(relevanceratio > 1){relevanceratio = 1;}\n          }\n          //calculate score based on AI grade * relevance * wordcount\n          var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\n          return score;\n        },\n\n        register_events: function(index, itemdata, quizhelper) {\n\n          var self = this;\n          self.index = index;\n          self.quizhelper = quizhelper;\n\n          self.nextbutton.on('click', function(e) {\n            e.preventDefault();\n            var wordcount = self.quizhelper.count_words(self.thetextarea.val());\n            var submitted = self.transcript_evaluation !== null;\n            if(submitted || wordcount === 0 ) {\n              self.next_question();\n            }else{\n              notification.confirm(self.strings.notsubmit,\n                  self.strings.notsubmitted,\n                  self.strings.submitnow,'',\n                  function(){\n                    self.submitbutton.click();\n                  });\n            }\n          });\n\n          self.thetextarea.on('input', function(e) {\n            e.preventDefault();\n            var wordcount = self.quizhelper.count_words(self.thetextarea.val());\n            self.wordcount.text(wordcount);\n          });\n\n          if(self.itemdata.nopasting > 0){\n             self.thetextarea.bind(\"cut copy paste\", function(e) {\n              e.preventDefault();\n              });\n              self.thetextarea.bind(\"contextmenu\", function(e) {\n                e.preventDefault();\n              });\n          }\n\n          self.submitbutton.on('click', function(e) {\n            e.preventDefault();\n            var transcript = self.thetextarea.val();\n            //update the wordcount\n            var wordcount = self.quizhelper.count_words(transcript);\n            self.wordcount.text(wordcount);\n\n            self.do_evaluation(transcript);\n          });\n\n          $(\"#\" + itemdata.uniqueid + \"_container\").on(\"showElement\", () => {\n              if (itemdata.timelimit > 0) {\n                $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                    height: '5px',\n                    timeLimit: itemdata.timelimit,\n                    onFinish: function() {\n                        self.nextbutton.trigger('click');\n                    }\n                });\n              }\n          });\n\n        },\n\n        init_components: function(quizhelper,itemdata){\n          var self=this;\n          self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n          self.submitbutton = $(\"#\" + itemdata.uniqueid + \"_container .ml_freewriting_submitbutton\");\n          self.nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n          self.thetextarea = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_freewriting_textarea\");\n          self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n          self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_actionbox\");\n          self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_pendingbox\");\n          self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_resultsbox\");\n          self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freewriting_timerdisplay\");\n        }, //end of init components\n\n        do_corrections_markup: function(grammarerrors,grammarmatches,insertioncount) {\n          var self = this;\n          //corrected text container is created at runtime, so it wont exist at init_components time\n          //that's why we find it here\n          var correctionscontainer = self.resultsbox.find('.mlfsr_correctedtext');\n\n          correctionsmarkup.init({ \"correctionscontainer\": correctionscontainer,\n            \"grammarerrors\": grammarerrors,\n            \"grammarmatches\": grammarmatches,\n            \"insertioncount\": insertioncount});\n        },\n\n        do_evaluation: function(speechtext) {\n          var self = this;\n\n          //show a spinner while we do the AI stuff\n          self.resultsbox.hide();\n          self.actionbox.hide();\n          self.pendingbox.show();\n\n          //do evaluation\n          this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then(function(ajaxresult) {\n            var transcript_evaluation = JSON.parse(ajaxresult);\n            if (transcript_evaluation) {\n              //calculate raw score and percent score\n              transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\n              self.rawscore = self.calculate_score(transcript_evaluation);\n              if(self.itemdata.totalmarks > 0){\n                self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\n              }\n              //add raw and percent score to trancript_evaluation for mustache\n              transcript_evaluation.rawscore = self.rawscore;\n              transcript_evaluation.percentscore = self.percentscore;\n              transcript_evaluation.rawspeech = speechtext;\n              transcript_evaluation.maxscore = self.itemdata.totalmarks;\n              self.transcript_evaluation = transcript_evaluation;\n\n              log.debug(transcript_evaluation);\n\n              //display results or move next if not show item review\n              if(!self.quizhelper.showitemreview){\n                self.next_question();\n              }else{\n                templates.render('mod_minilesson/freewritingresults',transcript_evaluation).then(\n                    function(html,js){\n                      self.resultsbox.html(html);\n                      //do corrections markup\n                      if(transcript_evaluation.hasOwnProperty('grammarerrors')){\n                        self.do_corrections_markup(transcript_evaluation.grammarerrors,\n                            transcript_evaluation.grammarmatches,\n                            transcript_evaluation.insertioncount\n                        );\n                      }\n                      //show and hide\n                      self.resultsbox.show();\n                      self.pendingbox.hide();\n                      self.actionbox.hide();\n                      templates.runTemplateJS(js);\n                      //reset timer and wordcount on this page, in case reattempt\n                      self.wordcount.text('0');\n                      self.ttrec.timer.reset();\n                      var displaytime = self.ttrec.timer.fetch_display_time();\n                      self.timerdisplay.html(displaytime);\n                    }\n                );// End of templates\n              }//end of show item review or not\n            } else {\n              log.debug('transcript_evaluation: oh no it failed');\n              self.resultsbox.hide();\n              self.pendingbox.hide();\n              self.actionbox.show();\n            }\n          });\n        },\n      };\n});"],"file":"freewriting.min.js"}