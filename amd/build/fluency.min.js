define("mod_minilesson/fluency",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates"],(function($,log,def,polly,cloudpoodll,ttrecorder,anim,progresstimer,templates){return log.debug("MiniLesson Fluency: initialising"),{speechConfig:null,referencetext:"I met my love by the gas works wall",game:{pointer:0},usevoice:"",items:null,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.quizhelper=quizhelper,this.init_components(quizhelper,itemdata);var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.register_events(index,itemdata,quizhelper),this.setvoice(),this.getItems()},init_components:function(quizhelper,itemdata){var self=this;self.thebutton="thettrbutton",self.wordcount=$("#"+self.itemdata.uniqueid+"_container span.ml_wordcount"),self.actionbox=$("#"+self.itemdata.uniqueid+"_container div.ml_fluency_actionbox"),self.pendingbox=$("#"+self.itemdata.uniqueid+"_container div.ml_fluency_pendingbox"),self.resultsbox=$("#"+self.itemdata.uniqueid+"_container div.ml_fluency_resultsbox"),self.timerdisplay=$("#"+self.itemdata.uniqueid+"_container div.ml_fluency_timerdisplay"),self.audioplayerbtn=$("#"+self.itemdata.uniqueid+"_container .fluency_listen_btn"),self.skipbtn=$("#"+self.itemdata.uniqueid+"_container .fluency_skip_btn"),self.startbtn=$("#"+self.itemdata.uniqueid+"_container .fluency_start_btn"),self.smallnextbtn=$("#"+self.itemdata.uniqueid+"_container .minilesson_nextbutton"),self.bignextbtn=$(".minilesson_nextbutton"),self.ctrlbtns=$("#"+self.itemdata.uniqueid+"_container .fluency_ctrl-btn"),self.speakbtncont=$("#"+self.itemdata.uniqueid+"_container .fluency_speakbtncontainer"),self.questioncont=$("#"+self.itemdata.uniqueid+"_container .question"),self.listencont=$("#"+self.itemdata.uniqueid+"_container .fluency_listen_cont"),self.mainmenu=$("#"+self.itemdata.uniqueid+"_container .fluency_mainmenu"),self.controls=$("#"+self.itemdata.uniqueid+"_container .fluency_controls"),self.progresscont=$("#"+self.itemdata.uniqueid+"_container .progress-container"),self.itemresultscont=$("#"+self.itemdata.uniqueid+"_container .item-results-container");var recorderCallback=function(message){switch(message.type){case"recording":break;case"pronunciation_results":var speechresults=message.results;self.do_evaluation(speechresults)}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=recorderCallback,opts.stt_guided=!1,opts.referencetext=this.referencetext,self.ttrec=ttrecorder.clone(),self.ttrec.init(opts)}else cloudpoodll.init("minilesson-recorder-fluency-"+itemdata.id,recorderCallback)},setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{target:target.sentence,prompt:target.prompt,parsedstring:target.parsedstring,displayprompt:target.displayprompt,definition:target.definition,phonetic:target.phonetic,words:target.words,typed:"",timer:[],answered:!1,correct:!1,audio:null}})).filter((function(e){return""!==e.target})),$.each(self.items,(function(index,item){polly.fetch_polly_url(item.prompt,self.voiceoption,self.usevoice).then((function(audiourl){item.audio=new Audio,item.audio.src=audiourl,0===self.items.filter((function(e){return null===e.audio})).length&&self.appReady()}))}))},appReady:function(){$("#"+this.itemdata.uniqueid+"_container .fluency_not_loaded").hide(),$("#"+this.itemdata.uniqueid+"_container .fluency_loaded").show(),this.itemdata.hidestartpage?this.start():$("#"+this.itemdata.uniqueid+"_container .fluency_start_btn").prop("disabled",!1)},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=1,stepdata.correctitems=percent>0?1:0,stepdata.grade=percent,this.quizhelper.do_next(stepdata)},register_events:function(index,itemdata,quizhelper){var self=this;self.bignextbtn.on("click",(function(e){self.next_question(0)})),self.startbtn.on("click",(function(){self.start()})),self.itemdata.readsentence&&self.audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(self.audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(self.audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(self.audioplayerbtn).children(".fa").removeClass("fa-stop"),$(self.audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(self.audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(self.audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),self.skipbtn.on("click",(function(){self.ctrlbtns.prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .fluency_speech.fluency_teacher_left").text(self.items[self.game.pointer].prompt+""),$("#"+self.itemdata.uniqueid+"_container .fluency_targetWord").each((function(){var realidx=$(this).data("realidx"),fluency_targetWord=self.items[self.game.pointer].fluency_targetWords[realidx];$(this).val(fluency_targetWord)})),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?setTimeout((function(){$(".fluency_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()}))},end:function(){var self=this;self.bignextbtn.prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){self.bignextbtn.prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2e3)},start:function(){this.ctrlbtns.prop("disabled",!0),this.speakbtncont.show(),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,this.questioncont.show(),this.itemdata.readsentence&&this.listencont.show(),this.startbtn.hide(),this.mainmenu.hide(),this.controls.show(),this.nextPrompt()},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");$("#"+self.itemdata.uniqueid+"_container .fluency_title").html(progress)},nextPrompt:function(){this.ctrlbtns.prop("disabled",!1),this.updateProgressDots();var newprompt=$(".fluency_prompt_"+this.game.pointer);anim.do_animate(newprompt,"zoomIn animate__faster","in").then((function(){})),this.nextReply()},nextReply:function(){var self=this,code="<div class='fluency_reply fluency_reply_"+self.game.pointer+" text-center' style='display:none;'>";code+="<div class='form-container'>",self.items[self.game.pointer].parsedstring.forEach((function(data,index){"input"===data.type?code+="<input class='single-character' autocomplete='off' type='text' name='filltext"+index+"' maxlength='1' data-index='"+index+"' readonly>":"mtext"===data.type?code+="<input class='single-character-mtext' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),code+=" <i data-idx='"+self.game.pointer+"' class='fluency_feedback'></i></div>",code+="<div class='item-results-container'>",code+="</div>",$("#"+self.itemdata.uniqueid+"_container .question").append(code);var newreply=$(".fluency_reply_"+self.game.pointer);(anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),self.ctrlbtns.prop("disabled",!1),self.itemdata.timelimit>0)&&(self.progresscont.show(),self.progresscont.find("i").show(),self.progresscont.find("#progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){self.skipbtn.trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))})));self.quizhelper.mobile_user()||setTimeout((function(){self.audioplayerbtn.trigger("click")}),1e3);var target=self.items[self.game.pointer].target;self.quizhelper.use_ttrecorder()&&self.ttrec.update_currentprompt(target)},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))},do_evaluation:function(pronunciation_result){itemresultscont=$("#"+this.itemdata.uniqueid+"_container .item-results-container"),itemresultscont.html("");var itemresults=[];itemresults.push("Accuracy score: "+pronunciation_result.accuracyScore),itemresults.push("Pronunciation score: "+pronunciation_result.pronunciationScore),itemresults.push("Completeness score: "+pronunciation_result.completenessScore),itemresults.push("Fluency score: "+pronunciation_result.fluencyScore),itemresults.push("Prosody score: "+pronunciation_result.prosodyScore),itemresultscont.append(itemresults.join("<br>")),log.debug("Accuracy score: ",pronunciation_result.accuracyScore),log.debug("Pronunciation score: ",pronunciation_result.pronunciationScore),log.debug("Completeness score : ",pronunciation_result.completenessScore),log.debug("Fluency score: ",pronunciation_result.fluencyScore),log.debug("Prosody score: ",pronunciation_result.prosodyScore),log.debug("  Word-level details:"),pronunciation_result.detailResult.Words.forEach((function(word,idx){console.log("    ",idx+1,": word: ",word.Word,"\taccuracy score: ",word.PronunciationAssessment.AccuracyScore,"\terror type: ",word.PronunciationAssessment.ErrorType,";")}))}}}));

//# sourceMappingURL=fluency.min.js.map