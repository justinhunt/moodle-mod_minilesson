function _createForOfIteratorHelper(a){if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(a=_unsupportedIterableToArray(a))){var b=0,c=function(){};return{s:c,n:function n(){if(b>=a.length)return{done:!0};return{done:!1,value:a[b++]}},e:function e(a){throw a},f:c}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d,e=!0,f=!1,g;return{s:function s(){d=a[Symbol.iterator]()},n:function n(){var a=d.next();e=a.done;return a},e:function e(a){f=!0;g=a},f:function f(){try{if(!e&&null!=d.return)d.return()}finally{if(f)throw g}}}}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}define ("mod_minilesson/fluency",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates","core/chartjs"],function(a,b,c,d,e,f,g,h,i){"use strict";b.debug("MiniLesson Fluency: initialising");var j={phonemeWarningThreshold:90,phonemeErrorThreshold:70,speechConfig:null,referencetext:"I met my love by the gas works wall",game:{pointer:0},usevoice:"",items:null,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.itemdata=b;this.quizhelper=c;this.index=a;this.init_components(c,b);this.phonemeWarningThreshold=b.correctthreshold||this.phonemeWarningThreshold;if(this.phonemeErrorThreshold>=this.phonemeWarningThreshold){this.phonemeErrorThreshold=Math.max(this.phonemeWarningThreshold-25,1)}var d={useanimatecss:c.useanimatecss};f.init(d);this.register_events(a,b,c);this.setvoice();this.getItems()},init_components:function init_components(c,d){var f=this;f.thebutton="thettrbutton";f.container=a("#"+f.itemdata.uniqueid+"_container");f.wordcount=a("#"+f.itemdata.uniqueid+"_container span.ml_wordcount");f.actionbox=a("#"+f.itemdata.uniqueid+"_container div.ml_fluency_actionbox");f.pendingbox=a("#"+f.itemdata.uniqueid+"_container div.ml_fluency_pendingbox");f.resultsbox=a("#"+f.itemdata.uniqueid+"_container div.fluency_resultscontainer");f.timerdisplay=a("#"+f.itemdata.uniqueid+"_container div.ml_fluency_timerdisplay");f.audioplayerbtn=a("#"+f.itemdata.uniqueid+"_container .fluency_listen_btn");f.audioplayerbtn_audiomodel=a("#"+f.itemdata.uniqueid+"_container .fluency_listen_btn.audiomodel");f.audioplayerbtn_audioself=a("#"+f.itemdata.uniqueid+"_container .fluency_listen_btn.audioself");f.skipbtn=a("#"+f.itemdata.uniqueid+"_container .fluency_skip_btn");f.startbtn=a("#"+f.itemdata.uniqueid+"_container .fluency_start_btn");f.smallnextbtn=a("#"+f.itemdata.uniqueid+"_container .minilesson_nextbutton");f.ctrlbtns=a("#"+f.itemdata.uniqueid+"_container .fluency_ctrl_btn");f.speakbtncont=a("#"+f.itemdata.uniqueid+"_container .fluency_speakbtncontainer");f.questioncont=a("#"+f.itemdata.uniqueid+"_container .question");f.listencont=a("#"+f.itemdata.uniqueid+"_container .fluency_listen_cont");f.mainmenu=a("#"+f.itemdata.uniqueid+"_container .fluency_mainmenu");f.mainstage=a("#"+f.itemdata.uniqueid+"_container .fluency_mainstage");f.controls=a("#"+f.itemdata.uniqueid+"_container .fluency_controls");f.progresscont=a("#"+f.itemdata.uniqueid+"_container .progress-container");var g={};g.uniqueid=d.uniqueid;g.callback=function recorderCallback(a){switch(a.type){case"recording":break;case"pronunciation_results":var c=a.results;b.debug(c);f.do_evaluation_feedback(c);f.do_evaluation_stars(c);f.do_recolor_continue_button(c);}};g.stt_guided=!1;g.referencetext=this.referencetext;f.ttrec=e.clone();f.ttrec.init(g)},setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{target:a.sentence,prompt:a.prompt,parsedstring:a.parsedstring,displayprompt:a.displayprompt,definition:a.definition,phonetic:a.phonetic,words:a.words,typed:"",timer:[],answered:!1,correct:!1,audio:null,audiourl:a.audiourl?a.audiourl:"",imageurl:a.imageurl,hintdisplay:a.hintdisplay}}).filter(function(a){return""!==a.target});a.each(b.items,function(a,c){c.audio=new Audio;c.audio.src=c.audiourl;if(0===b.items.filter(function(a){return null===a.audio}).length){b.appReady()}})},appReady:function appReady(){var b=this;a("#"+b.itemdata.uniqueid+"_container .fluency_not_loaded").hide();a("#"+b.itemdata.uniqueid+"_container .fluency_loaded").show();if(b.itemdata.hidestartpage){b.start()}else{a("#"+b.itemdata.uniqueid+"_container .fluency_start_btn").prop("disabled",!1)}},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.stop_audio();var c={correctitems:a.items.filter(function(a){return a.correct}).length,totalitems:a.items.length};c.items=a.items_for_results_display(!1);b.resultsdata=c;a.quizhelper.do_next(b)},register_events:function register_events(){var b=this;b.smallnextbtn.on("click",function(){b.next_question()});b.startbtn.on("click",function(){b.start()});b.audioplayerbtn.on("click",function(){var c=a(this);if(c.hasClass("audioself")){var d=b.items[b.game.pointer].audioself}else{var d=b.items[b.game.pointer].audio}if(!d.paused){d.pause();d.currentTime=0;c.children(".fa").removeClass("fa-stop");c.children(".fa").addClass("fa-play");return}d.addEventListener("ended",function(){c.children(".fa").removeClass("fa-stop");c.children(".fa").addClass("fa-play")});d.addEventListener("play",function(){c.children(".fa").removeClass("fa-play");c.children(".fa").addClass("fa-stop")});d.load();d.play()});b.skipbtn.on("click",function(){b.stopTimer(b.items[b.game.pointer].timer);if(b.game.pointer<b.items.length-1){setTimeout(function(){b.container.find(".fluency_reply_"+b.game.pointer).hide();b.game.pointer++;b.nextPrompt()},2e3)}else{b.end()}})},end:function end(){var a=this;a.smallnextbtn.prop("disabled",!0);a.updateProgressDots();setTimeout(function(){a.smallnextbtn.prop("disabled",!1);if(a.quizhelper.showitemreview){a.show_item_review()}else{a.next_question()}},2e3)},start:function start(){var a=this;a.ctrlbtns.prop("disabled",!0);a.speakbtncont.show();a.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});a.game.pointer=0;a.questioncont.show();a.listencont.show();a.startbtn.hide();a.mainmenu.hide();a.controls.show();a.nextPrompt()},show_item_review:function show_item_review(){var a=this,b={};b.correctitems=a.items.filter(function(a){return a.correct}).length;b.totalitems=a.items.length;b.items=a.items_for_results_display(!0);h.render("mod_minilesson/listitemresults",b).then(function(b,c){a.resultsbox.html(b);a.resultsbox.show();a.mainstage.hide();h.runTemplateJS(c)})},updateProgressDots:function updateProgressDots(){var b=this,c,d=b.items.map(function(a,d){c="gray";if(b.items[d].answered&&b.items[d].correct){c="green"}else if(b.items[d].answered&&!b.items[d].correct){c="red"}return"<i style='color:"+c+"' class='fa fa-circle'></i>"}).join(" ");a("#"+b.itemdata.uniqueid+"_container .fluency_title").html(d)},nextPrompt:function nextPrompt(){var a=this;a.ctrlbtns.prop("disabled",!1);a.updateProgressDots();var b=a.container.find(".fluency_prompt_"+a.game.pointer);f.do_animate(b,"zoomIn animate__faster","in").then(function(){});a.nextReply()},nextReply:function nextReply(){var b=this,c="<div class='fluency_reply fluency_reply_"+b.game.pointer+" text-center' style='display:none;'>";c+="<div class='form-container'>";c+="<div class='fluency_prompt fluency_prompt_"+b.game.pointer+"'>";c+=b.items[b.game.pointer].displayprompt||b.items[b.game.pointer].prompt;c+="</div>";if(b.items[b.game.pointer].hintdisplay){c+="<div class='fluency_prompt_hint'>"+b.items[b.game.pointer].target+"</div>"}c+=" <i data-idx='"+b.game.pointer+"' class='fluency_feedback'></i></div>";if(b.items[b.game.pointer].imageurl){c+="<div class='minilesson_sentence_image'><div class='minilesson_padded_image'><img src='"+b.items[b.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"}c+="<div class='item-results-container'></div>";c+="<div class='item-feedback-container'></div>";a("#"+b.itemdata.uniqueid+"_container .question").append(c);var d=b.container.find(".fluency_reply_"+b.game.pointer);f.do_animate(d,"zoomIn animate__faster","in").then(function(){});b.ctrlbtns.prop("disabled",!1);b.skipbtn.removeClass("btn-success");b.skipbtn.addClass("btn-danger");b.startTimer();b.audioplayerbtn_audioself.hide();if(!b.quizhelper.mobile_user()){if(b.itemdata.hidestartpage&&0===b.game.pointer){b.container.on("showElement",function(){setTimeout(function(){b.audioplayerbtn_audiomodel.trigger("click")},1e3)})}else{setTimeout(function(){b.audioplayerbtn_audiomodel.trigger("click")},1e3)}}var e=b.items[b.game.pointer].prompt;if(b.quizhelper.use_ttrecorder()){b.ttrec.update_currentprompt(e)}},startTimer:function startTimer(){var b=this;if(0<b.itemdata.timelimit){var c=function(){b.progresscont.show();b.progresscont.find("i").show();var c=b.progresscont.find("#progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){b.skip_btn.trigger("click")}});c.each(function(){b.items[b.game.pointer].timer.push(a(this).attr("timer"))})};if(b.itemdata.hidestartpage&&0===b.game.pointer){b.container.on("showElement",function(){c()})}else{c()}}},stopTimer:function stopTimer(a){if(a.length){a.forEach(function(a){clearInterval(a)})}},stop_audio:function stop_audio(){var a=this,b=a.items[a.game.pointer].audio;if(b&&!b.paused){b.pause()}},do_evaluation_feedback:function do_evaluation_feedback(a){var b=this,c=b.container.find(".item-feedback-container");c.html("");var d=b.itemdata.language.substr(0,2);if(b.itemdata.rtl){var e=a.privPronJson.Words.reverse()}else{var e=a.privPronJson.Words}var f="";e.forEach(function(a){var c=a.Syllables&&0<a.Syllables.length&&a.Syllables[0].Grapheme;if(c){var e=[];a.Syllables.forEach(function(a){e.push({letter:a.Grapheme,phoneme:a.Syllable,score:a.PronunciationAssessment.AccuracyScore})})}else{var e=b.markuphelper.alignPhonemesToLetters(a.Word,a.Phonemes,d)}f+=b.markuphelper.renderPronunciationFeedback(e)});c.html(f);b.items[b.game.pointer].pronunciation_result=a;b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=a.privPronJson.PronunciationAssessment.AccuracyScore>=b.phonemeWarningThreshold;b.items[b.game.pointer].audioself=new Audio;b.items[b.game.pointer].audioself.src=URL.createObjectURL(b.ttrec.audio.blob);b.items[b.game.pointer].lineresulthtml=f;b.audioplayerbtn_audioself.show();b.updateProgressDots()},do_recolor_continue_button:function do_recolor_continue_button(a){var b=this,c=a.accuracyScore,d=b.phonemeWarningThreshold;if(c>=d){b.skipbtn.removeClass("btn-danger");b.skipbtn.addClass("btn-success")}else{b.skipbtn.removeClass("btn-success");b.skipbtn.addClass("btn-danger")}},do_evaluation_stars:function do_evaluation_stars(c){var d=this;b.debug("Accuracy score: ",c.accuracyScore);var e=a("#"+d.itemdata.uniqueid+"_container .item-results-container");e.html("");for(var f=a("<div class='fluency_star_rating'>"),g=c.accuracyScore,h=100-d.phonemeWarningThreshold,j=0,k;j<5;j++){k=a("<i class='fa'>");if(j<=g/((100-h)/4)){k.addClass("fa-star")}else{k.addClass("fa-star-o")}f.append(k)}e.append(f)},do_evaluation_results:function do_evaluation_results(a){var c=this,d=c.container.find(".item-results-container");d.html("");var e=["Accuracy score: "+a.accuracyScore,"Pronunciation score: "+a.pronunciationScore,"Completeness score: "+a.completenessScore,"Fluency score: "+a.fluencyScore,"Prosody score: "+a.prosodyScore];d.append(e.join("<br>"));var f=[a.accuracyScore,a.pronunciationScore,a.completenessScore,a.fluencyScore,a.prosodyScore];["Accuracy","Pronunciation","Completeness","Fluency","Prosody"].forEach(function(a,b){var e=c.itemdata.uniqueid+"_chart_"+b;d.append("<canvas id=\""+e+"\"></canvas>");c.createRadialChart(e,[a],[f[b]])});b.debug("Accuracy score: ",a.accuracyScore);b.debug("Pronunciation score: ",a.pronunciationScore);b.debug("Completeness score : ",a.completenessScore);b.debug("Fluency score: ",a.fluencyScore);b.debug("Prosody score: ",a.prosodyScore);b.debug("  Word-level details:");a.detailResult.Words.forEach(function(a,b){console.log("    ",b+1,": word: ",a.Word,"\taccuracy score: ",a.PronunciationAssessment.AccuracyScore,"\terror type: ",a.PronunciationAssessment.ErrorType,";")})},createRadialChart:function createRadialChart(a,b,c){var d=document.getElementById(a).getContext("2d");new i(d,{type:"doughnut",data:{labels:b,datasets:[{label:"Scores",data:c,backgroundColor:"rgba(54, 162, 235, 0.2)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}]},options:{scale:{ticks:{beginAtZero:!0,max:100}}}})},items_for_results_display:function items_for_results_display(a){var b=this;return b.items.map(function(b){return{target:b.answered?b.lineresulthtml:b.target,pronunciation_result:b.pronunciation_result,answered:b.answered,correct:b.correct,audio:b.audio?{src:b.audio.src}:null,audioself:a&&b.audioself?{src:b.audioself.src}:null}})},markuphelper:{languageMappings:{en:{graphemeGroups:["sh","th","ch","ph","wh","ck","ng"],phonemeGroups:{ʃ:["sh"],tʃ:["ch"],θ:["th"],ŋ:["ng"]}},es:{graphemeGroups:["ll","ch","rr"],phonemeGroups:{ʎ:["ll"],tʃ:["ch"],r:["rr"]}},fr:{graphemeGroups:["ch","gn","ou","eau","oi"],phonemeGroups:{ʃ:["ch"],ɲ:["gn"],u:["ou"],o:["eau"],wa:["oi"]}},ar:{graphemeGroups:["\u062B","\u0630","\u0634","\u062E","\u063A","\u0642","\u0639","\u0635","\u0636","\u0637","\u0638","\u0621"],phonemeGroups:{θ:["\u062B"],ð:["\u0630"],ʃ:["\u0634"],x:["\u062E"],ɣ:["\u063A"],ħ:["\u062D"],ʕ:["\u0639"],h:["\u0647"],sˤ:["\u0635"],dˤ:["\u0636"],tˤ:["\u0637"],ðˤ:["\u0638"],q:["\u0642"],ʔ:["\u0621"],aː:["\u0627"],uː:["\u0648"],iː:["\u064A"]}},ru:{graphemeGroups:["\u0449","\u0447","\u0448","\u0436","\u044E","\u044F"],phonemeGroups:{ɕː:["\u0449"],tɕ:["\u0447"],ʂ:["\u0448"],ʒ:["\u0436"],ju:["\u044E"],ja:["\u044F"]}},no:{graphemeGroups:["kj","sj","ng"],phonemeGroups:{ç:["kj"],ʃ:["sj"],ŋ:["ng"]}},so:{graphemeGroups:["kh","dh","sh"],phonemeGroups:{x:["kh"],ð:["dh"],ʃ:["sh"]}},de:{graphemeGroups:["sch","ch","ng","sp","st","z"],phonemeGroups:{ʃ:["sch"],ç:["ch"],ŋ:["ng"],ʃp:["sp"],ʃt:["st"],ts:["z"]}},it:{graphemeGroups:["gl","gn","sc","ch","ci","ce"],phonemeGroups:{ʎ:["gl"],ɲ:["gn"],ʃ:["sc"],k:["ch"],tʃ:["ci","ce"]}}},alignPhonemesToLetters:function alignPhonemesToLetters(a,b){var f=2<arguments.length&&arguments[2]!==void 0?arguments[2]:"en",g=this.languageMappings[f]||{},h=g.graphemeGroups,k=void 0===h?[]:h,l=g.phonemeGroups,o=void 0===l?{}:l;function c(a,b){switch(b){case"ar":return a.normalize("NFKD").replace(/[\u064B-\u065F\u0670]/g,"");default:return a.normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase();}}function d(a,b){var c=[],d=0;while(d<a.length){var e=!1,f=_createForOfIteratorHelper(b.sort(function(c,a){return a.length-c.length})),h;try{for(f.s();!(h=f.n()).done;){var j=h.value;if(a.slice(d,d+j.length)===j){c.push(j);d+=j.length;e=!0;break}}}catch(a){f.e(a)}finally{f.f()}if(!e){c.push(a[d]);d+=1}}return c}function e(a){for(var b in o){if(o[b].includes(a))return b}return a}for(var p=c(a,f),q=d(p,k),r=b.map(function(a){return e(a.Phoneme)}),s=q.length,m=r.length,n=Array(s+1).fill().map(function(){return Array(m+1).fill(0)}),t=Array(s+1).fill().map(function(){return Array(m+1).fill(null)}),u=0,v=1,w=1,x=0;x<=s;x++){n[x][0]=x*w;t[x][0]="up"}for(var H=0;H<=m;H++){n[0][H]=H*w;t[0][H]="left"}for(var I=1;I<=s;I++){for(var J=1;J<=m;J++){var y=q[I-1],z=r[J-1],A=y===z?u:v,B=n[I-1][J-1]+A,C=n[I-1][J]+w,D=n[I][J-1]+w;n[I][J]=Math.min(B,C,D);t[I][J]=n[I][J]===B?"diag":n[I][J]===C?"up":"left"}}var E=s,F=m,G=[];while(0<E||0<F){var K=t[E][F];if("diag"===K){G.unshift({letter:q[E-1],phoneme:b[F-1].Phoneme,score:b[F-1].PronunciationAssessment.AccuracyScore});E--;F--}else if("up"===K){G.unshift({letter:q[E-1],phoneme:null,score:null});E--}else{F--}}return G},scoreToColorClass:function scoreToColorClass(a){if(null===a)return"letter_missing";if(a>=j.phonemeWarningThreshold)return"letter_good";if(a>=j.phonemeErrorThreshold)return"letter_fair";return"letter_wrong"},renderPronunciationFeedback:function renderPronunciationFeedback(b){var c=this,d=a("<div class='fluencywordresult'>");b.forEach(function(b){var e=b.letter,f=b.phoneme,g=b.score,h=c.scoreToColorClass(g),i=a("<span class='fluencyletterresult "+h+"'>").text(e),j=null===g?"No phoneme matched":"Phoneme: ".concat(f,", Score: ").concat(g);i.attr("title",j);d.append(i)});return d.prop("outerHTML")}}};return j});
//# sourceMappingURL=fluency.min.js.map
