{"version":3,"sources":["../src/fluency.js"],"names":["define","$","log","def","polly","ttrecorder","anim","progresstimer","templates","chartjs","str","notification","debug","phonemeWarningThreshold","phonemeErrorThreshold","hidewarning","speechConfig","referencetext","game","pointer","usevoice","items","strings","clone","extend","init","index","itemdata","quizhelper","init_components","init_strings","correctthreshold","Math","max","animopts","useanimatecss","register_events","setvoice","getItems","self","thebutton","container","uniqueid","wordcount","actionbox","pendingbox","resultsbox","timerdisplay","audioplayerbtn","audioplayerbtn_audiomodel","audioplayerbtn_audioself","skipbtn","startbtn","smallnextbtn","ctrlbtns","speakbtncont","questioncont","listencont","mainmenu","mainstage","controls","progresscont","description","image","maintitle","title","opts","callback","recorderCallback","message","type","speechresults","results","do_evaluation_feedback","do_evaluation_stars","do_recolor_continue_button","stt_guided","ttrec","voiceoption","text_items","sentences","map","target","sentence","prompt","parsedstring","displayprompt","definition","phonetic","words","typed","timer","answered","correct","audio","audiourl","imageurl","hintdisplay","filter","e","each","item","Audio","src","length","appReady","hide","show","hidestartpage","start","prop","get_strings","done","s","i","nextlessonitem","confirm_desc","yes","no","next_question","stepdata","hasgrade","totalitems","correctitems","grade","round","stop_audio","results_data","items_for_results_display","resultsdata","do_next","on","some","confirm","$button","theaudioaudioself","theaudio","hasClass","audioself","paused","pause","currentTime","children","removeClass","addClass","addEventListener","load","play","stopTimer","setTimeout","find","nextPrompt","end","updateProgressDots","showitemreview","show_item_review","forEach","spoken","review_data","render","then","html","js","runTemplateJS","color","icon","progress","idx","join","newprompt","do_animate","nextReply","code","append","newreply","startTimer","mobile_user","trigger","use_ttrecorder","update_currentprompt","timelimit","doStartTimer","progresbar","progressTimer","height","timeLimit","onFinish","skip_btn","push","attr","timers","clearInterval","pronunciation_result","isReview","itemfeedbackcontainer","twoletterlang","language","substr","rtl","privPronJson","Words","reverse","wordresults","wordobject","PronunciationAssessment","ErrorType","Word","word_phoneme_score_classes","have_graphemes","Syllables","Grapheme","syllable","thescore","AccuracyScore","scoreToColorClass","adata","letter","phoneme","Syllable","score","Phonemes","have_phoneme_names","Phoneme","markuphelper","alignPhonemesToLetters","a","scoreclass","alignmentdata","wordphonemes","URL","createObjectURL","blob","lineresulthtml","wordresults_review","wr","reviewhtml","lineresulthtml_review","accuracyScore","warningthreshold","itemstarscontainer","starRating","correctBandwidth","star","do_evaluation_results","itemresultscontainer","itemresults","pronunciationScore","completenessScore","fluencyScore","prosodyScore","data","label","chartContainerId","createRadialChart","detailResult","word","console","containerId","labels","ctx","document","getElementById","getContext","datasets","backgroundColor","borderColor","borderWidth","options","scale","ticks","beginAtZero","includeaudioself","resulthtml","languageMappings","en","graphemeGroups","phonemeGroups","es","fr","ar","ru","so","de","it","phonemesWithScores","normalizeWord","normalize","replace","toLowerCase","tokenizeGraphemes","groups","tokens","matched","sort","b","g","slice","normalizePhoneme","p","group","includes","normWord","graphemes","phonemes","m","n","dp","Array","fill","traceback","matchCost","mismatchCost","gap","j","cost","diag","up","left","min","result","move","unshift"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions','mod_minilesson/pollyhelper',\n    'mod_minilesson/ttrecorder', 'mod_minilesson/animatecss',\n    'mod_minilesson/progresstimer', 'core/templates', 'core/chartjs', 'core/str', 'core/notification'],\n    function($, log, def,polly, ttrecorder,anim, progresstimer, templates, chartjs, str, notification) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the fluency item type\n   */\n\n  log.debug('MiniLesson Fluency: initialising');\n\n  var thefluencyitem = {\n    phonemeWarningThreshold: 90, // Upper threshold for phoneme warning rate\n    phonemeErrorThreshold: 70, // Upper threshold for phoneme error rate\n    hidewarning: false, // Whether to hide the orange and just show red\n    speechConfig: null,\n    //this is just a placeholder for the actual text which is from the sentences in items\n    referencetext: 'I met my love by the gas works wall',\n    game: {pointer: 0},\n    usevoice: '',\n    items: null,\n    strings: {},\n\n    //for making multiple instances\n    clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n      this.itemdata = itemdata;\n      this.quizhelper = quizhelper;\n      this.index = index;\n      this.init_components(quizhelper, itemdata);\n      this.init_strings();\n\n      //correct threshold\n      this.phonemeWarningThreshold = itemdata.correctthreshold || this.phonemeWarningThreshold;\n      if(this.phonemeErrorThreshold >= this.phonemeWarningThreshold) {\n          this.phonemeErrorThreshold = Math.max(this.phonemeWarningThreshold - 25, 1);\n      }\n\n      //Hide warning\n      this.hidewarning = itemdata.hidewarning === 1;\n\n      // Anim\n      var animopts = {};\n      animopts.useanimatecss = quizhelper.useanimatecss;\n      anim.init(animopts);\n\n      //Events and voice and items parse\n      this.register_events(index, itemdata, quizhelper);\n      this.setvoice();\n      this.getItems();\n    },\n\n    init_components: function(quizhelper,itemdata){\n      var self=this;\n\n      self.thebutton = \"thettrbutton\"; // To Do impl. this\n      self.container = $(\"#\" + self.itemdata.uniqueid + \"_container\");\n      self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n      self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_fluency_actionbox\");\n      self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_fluency_pendingbox\");\n      self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.fluency_resultscontainer\");\n      self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_fluency_timerdisplay\");\n      self.audioplayerbtn =$(\"#\" + self.itemdata.uniqueid + \"_container .fluency_listen_btn\");\n      self.audioplayerbtn_audiomodel =$(\"#\" + self.itemdata.uniqueid + \"_container .fluency_listen_btn.audiomodel\");\n      self.audioplayerbtn_audioself =$(\"#\" + self.itemdata.uniqueid + \"_container .fluency_listen_btn.audioself\");\n      self.skipbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_skip_btn\");\n      self.startbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_start_btn\");\n      self.smallnextbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n      self.ctrlbtns =  $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_ctrl_btn\");\n      self.speakbtncont = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_speakbtncontainer\");\n      self.questioncont = $(\"#\" + self.itemdata.uniqueid + \"_container .question\");\n      self.listencont = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_listen_cont\");\n      self.mainmenu = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_mainmenu\");\n      self.mainstage = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_mainstage\");\n      self.controls = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_controls\");\n      self.progresscont = $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container\");\n      self.description = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_description\");\n      self.image = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_image_container\");\n      self.maintitle = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_maintitle\");\n      self.title = $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_title\");\n\n      // Callback: Recorder updates.\n      var recorderCallback = function(message) {\n\n        switch (message.type) {\n          case 'recording':\n            break;\n\n          case 'pronunciation_results':\n            var speechresults= message.results;\n            log.debug(speechresults);\n            self.do_evaluation_feedback(speechresults);\n            self.do_evaluation_stars(speechresults);\n            self.do_recolor_continue_button(speechresults);\n            // self.do_evaluation_results(speechresults);\n        } //end of switch message type\n      };\n\n        //init tt recorder\n        var opts = {};\n        opts.uniqueid = itemdata.uniqueid;\n        opts.callback = recorderCallback;\n        opts.stt_guided=false;\n        opts.referencetext=this.referencetext;\n        self.ttrec = ttrecorder.clone();\n        self.ttrec.init(opts);\n\n    }, //end of init components\n\n    setvoice: function() {\n            var self = this;\n            self.usevoice = self.itemdata.usevoice;\n            self.voiceoption=self.itemdata.voiceoption;\n            return;\n    },\n\n    getItems: function() {\n      var self = this;\n      var text_items = self.itemdata.sentences;\n\n      self.items = text_items.map(function(target) {\n          return {\n              target: target.sentence,\n              prompt: target.prompt,\n              parsedstring: target.parsedstring,\n              displayprompt: target.displayprompt,\n              definition: target.definition,\n              phonetic: target.phonetic,\n              words: target.words,\n              typed: \"\",\n              timer: [],\n              answered: false,\n              correct: false,\n              audio: null,\n              audiourl: target.audiourl ? target.audiourl : \"\",\n              imageurl: target.imageurl,\n              hintdisplay: target.hintdisplay,\n          };\n      }).filter(function(e) {\n          return e.target !== \"\";\n      });\n\n      $.each(self.items, function(index, item) {\n          item.audio = new Audio();\n          item.audio.src = item.audiourl;\n          if (self.items.filter(function(e) {\n              return e.audio === null;\n            }).length === 0) {\n            self.appReady();\n          }\n      });\n    },\n\n    appReady: function() {\n      var self = this;\n      $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_not_loaded\").hide();\n      $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_loaded\").show();\n      if(self.itemdata.hidestartpage){\n          self.start();\n      }else{\n          $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_start_btn\").prop(\"disabled\", false);\n      }\n  },\n\n  init_strings: function() {\n        var self = this;\n        str.get_strings([\n            { \"key\": \"nextlessonitem\", \"component\": 'mod_minilesson'},\n            { \"key\": \"confirm_desc\", \"component\": 'mod_minilesson'},\n            { \"key\": \"yes\", \"component\": 'moodle'},\n            { \"key\": \"no\", \"component\": 'moodle'},\n        ]).done(function (s) {\n            var i = 0;\n            self.strings.nextlessonitem = s[i++];\n            self.strings.confirm_desc = s[i++];\n            self.strings.yes = s[i++];\n            self.strings.no = s[i++];\n        });\n    },\n\n    next_question: function() {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = self.items.length;\n      stepdata.correctitems = self.items.filter(function(e) {\n                return e.correct;\n            }).length;\n      stepdata.grade = Math.round((stepdata.correctitems / stepdata.totalitems) * 100);\n\n        //stop audio\n        self.stop_audio();\n\n      //prepare results data for detailed review on finished page or by teacher\n      var results_data = {};\n      results_data.correctitems = self.items.filter(function(e) {return e.correct;}).length;\n      results_data.totalitems = self.items.length;\n      var includeaudioself = false;\n      results_data.items = self.items_for_results_display(includeaudioself);\n      stepdata.resultsdata = results_data;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    register_events: function(index, itemdata, quizhelper) {\n\n      var self = this;\n      // On next button click\n      self.smallnextbtn.on('click', function(e) {\n            if (self.items.some(item => !item.answered)) {\n                notification.confirm(self.strings.nextlessonitem,\n                    self.strings.confirm_desc,\n                    self.strings.yes,\n                    self.strings.no,\n                    function() {\n                        self.next_question();\n                    }\n                );\n            } else {\n                self.next_question();\n            }\n      });\n\n      // On start button click\n      self.startbtn.on(\"click\", function() {\n          self.start();\n      });\n\n      //AUDIO PLAYER Button events\n      // On listen button click\n      self.audioplayerbtn.on(\"click\", function () {\n        const $button = $(this);  // capture the button\n        var theaudioaudioself, theaudio;\n        if($button.hasClass('audioself')) {\n          theaudioaudioself = self.items[self.game.pointer].audioself;\n        }else{\n          theaudio = self.items[self.game.pointer].audio;\n        }\n\n        if (theaudioaudioself) {\n            if(!theaudioaudioself.paused){\n                theaudioaudioself.pause();\n                theaudioaudioself.currentTime=0;\n                $button.children('.fa').removeClass('fa-stop');\n                $button.children('.fa').addClass('fa-play');\n                return;\n            }\n\n            theaudioaudioself.addEventListener('ended', function () {\n                $button.children('.fa').removeClass('fa-stop');\n                $button.children('.fa').addClass('fa-play');\n            });\n\n            theaudioaudioself.addEventListener('play', function () {\n                $button.children('.fa').removeClass('fa-play');\n                $button.children('.fa').addClass('fa-stop');\n            });\n            theaudioaudioself.load();\n            theaudioaudioself.play();\n        }\n\n        if(!theaudio.paused){\n            theaudio.pause();\n            theaudio.currentTime=0;\n            $button.children('.fa').removeClass('fa-stop');\n            $button.children('.fa').addClass('fa-volume-up');\n            return;\n        }\n\n        //change icon to indicate playing state\n        theaudio.addEventListener('ended', function () {\n            $button.children('.fa').removeClass('fa-stop');\n            $button.children('.fa').addClass('fa-volume-up');\n        });\n\n        theaudio.addEventListener('play', function () {\n            $button.children('.fa').removeClass('fa-volume-up');\n            $button.children('.fa').addClass('fa-stop');\n        });\n        theaudio.load();\n        theaudio.play();\n      });\n\n\n      // On skip button click\n      self.skipbtn.on(\"click\", function() {\n\n          self.stopTimer(self.items[self.game.pointer].timer);\n\n          if (self.game.pointer < self.items.length - 1) {\n              // Disable button and show spinner in place of text or arrow\n              self.skipbtn.prop(\"disabled\", true);\n              self.skipbtn.children('.fa').removeClass('fa-arrow-right');\n              self.skipbtn.children('.fa').addClass('fa-spinner fa-spin');\n\n\n              // Move on after short time to next prompt\n              setTimeout(function() {\n                // Re enable button and reset icons and text.\n                  self.skipbtn.children('.fa').removeClass('fa-spinner fa-spin');\n                  self.skipbtn.children('.fa').addClass('fa-arrow-right');\n                  self.skipbtn.prop(\"disabled\", false);\n\n                  // Move to next item.\n                  self.container.find(\".fluency_reply_\" + self.game.pointer).hide();\n                  self.game.pointer++;\n                  self.nextPrompt();\n              }, 1500);\n              // End question\n          } else {\n              self.end();\n          }\n      });\n    },\n\n    end: function() {\n      var self = this;\n      self.smallnextbtn.prop(\"disabled\", true);\n\n      //progress dots are updated on next_item. The last item has no next item, so we update from here\n      self.updateProgressDots();\n\n      setTimeout(function() {\n          self.smallnextbtn.prop(\"disabled\",false);\n          if(self.quizhelper.showitemreview){\n               self.title.hide();\n              self.show_item_review();\n          }else{\n              self.next_question();\n          }\n      }, 2000);\n\n  },\n\n  start: function() {\n      var self = this;\n\n      self.ctrlbtns.prop(\"disabled\", true);\n      self.speakbtncont.show();\n\n      self.items.forEach(function(item) {\n          item.spoken = \"\";\n          item.answered = false;\n          item.correct = false;\n      });\n\n      self.game.pointer = 0;\n\n      self.questioncont.show();\n      self.listencont.show();\n      self.startbtn.hide();\n      self.mainmenu.hide();\n      self.description.hide();\n      self.image.hide();\n      self.maintitle.show();\n      self.controls.show();\n\n      self.nextPrompt();\n  },\n\n  show_item_review:function(){\n      var self=this;\n      //build review data\n      var review_data = {};\n      review_data.correctitems = self.items.filter(function(e) {return e.correct;}).length;\n      review_data.totalitems = self.items.length;\n      var includeaudioself = true;\n      review_data.items = self.items_for_results_display(includeaudioself, true);\n\n      //display results\n      templates.render('mod_minilesson/listitemresults',review_data).then(\n        function(html,js){\n            self.resultsbox.html(html);\n            //show and hide\n            self.resultsbox.show();\n            self.mainstage.hide();\n            // Run js for audio player events\n            templates.runTemplateJS(js);\n        }\n      );// End of templates\n    },\n\n  updateProgressDots: function(){\n      var self = this;\n      var color,icon;\n      var progress = self.items.map(function(item, idx) {\n          color = \"#E6E9FD\";\n          icon = \"fa fa-square\";\n          if (self.items[idx].answered && self.items[idx].correct) {\n              color = \"#74DC72\";\n              icon = 'fa fa-check-square';\n          } else if (self.items[idx].answered && !self.items[idx].correct) {\n              color = \"#FB6363\";\n              icon = \"fa fa-window-close\";\n          }\n          return \"<i style='color:\" + color + \"' class='\"+ icon +\" pl-1'></i>\";\n      }).join(\" \");\n      $(\"#\" + self.itemdata.uniqueid + \"_container .fluency_title\").html(progress);\n  },\n\n  nextPrompt: function() {\n      var self = this;\n      self.ctrlbtns.prop(\"disabled\", false);\n      self.updateProgressDots();\n      var newprompt = self.container.find(\".fluency_prompt_\" + self.game.pointer);\n      anim.do_animate(newprompt, 'zoomIn animate__faster', 'in').then(\n          function() {\n          }\n      );\n      self.nextReply();\n  },\n\n\n  nextReply: function() {\n      var self = this;\n\n      var code = \"<div class='fluency_reply fluency_reply_\" + self.game.pointer + \" text-center' style='display:none;'>\";\n\n      code += \"<div class='form-container'>\";\n      code += \"<div class='fluency_prompt fluency_prompt_\" + self.game.pointer + \"'>\";\n      code += self.items[self.game.pointer].displayprompt || self.items[self.game.pointer].prompt;\n      code += \"</div>\";\n      if (self.items[self.game.pointer].hintdisplay) {\n        code += \"<div class='fluency_prompt_hint'>\" + self.items[self.game.pointer].target + \"</div>\";\n      }\n\n      //correct or not\n      code += \" <i data-idx='\" + self.game.pointer + \"' class='fluency_feedback'></i></div>\";\n\n      //hint - image\n    if( self.items[self.game.pointer].imageurl) {\n        code += \"<div class='minilesson_sentence_image'><div class='minilesson_padded_image'><img src='\"\n            + self.items[self.game.pointer].imageurl + \"' alt='Image for gap fill' /></div></div>\";\n    }\n\n      //feedback and results containers\n      code += \"<div class='item-results-container'></div>\";\n      code += \"<div class='item-feedback-container my-4'></div>\";\n\n      $(\"#\" + self.itemdata.uniqueid + \"_container .question\").append(code);\n      var newreply = self.container.find(\".fluency_reply_\" + self.game.pointer);\n      anim.do_animate(newreply, 'zoomIn animate__faster', 'in').then(\n          function() {\n          }\n      );\n      self.ctrlbtns.prop(\"disabled\", false);\n\n      //Start timer if we have one\n      self.startTimer();\n\n      //Hide the response audio because its not ready yet\n       self.audioplayerbtn_audioself.hide();\n\n      // We autoplay the audio on item entry, if its not a mobile user.\n      // If we do not have a start page and its the first item, we play on the item show event\n      if (!self.quizhelper.mobile_user()){\n        if(self.itemdata.hidestartpage && self.game.pointer === 0){\n            self.container.on(\"showElement\", () => {\n                setTimeout(function() {\n                    self.audioplayerbtn_audiomodel.trigger('click');\n                }, 1000);\n            });\n        }else{\n            setTimeout(function() {\n                self.audioplayerbtn_audiomodel.trigger('click');\n            }, 1000);\n        }\n      }\n\n      //target is the speech we expect\n      var prompt = self.items[self.game.pointer].prompt;\n      //in some cases ttrecorder wants to know the target\n      if(self.quizhelper.use_ttrecorder()) {\n        self.ttrec.update_currentprompt(prompt);\n      }\n    },\n\n    startTimer: function(){\n        var self = this;\n        // If we have a time limit, set up the timer, otherwise return\n        if (self.itemdata.timelimit > 0) {\n            // This is a function to start the timer (we call it conditionally below)\n            var doStartTimer = function() {\n                    // This shows progress bar\n                self.progresscont.show();\n                self.progresscont.addClass('d-flex align-items-center');\n                self.progresscont.find('i').show();\n                var progresbar = self.progresscont.find('#progresstimer').progressTimer({\n                    height: '5px',\n                    timeLimit: self.itemdata.timelimit,\n                    onFinish: function() {\n                        self.skip_btn.trigger('click');\n                    }\n                });\n                progresbar.each(function() {\n                    self.items[self.game.pointer].timer.push($(this).attr('timer'));\n                });\n            };\n\n            // This adds the timer and starts it. But if we dont have a start page and its the first item\n            // we need to defer the timer start until the item is shown\n            if(self.itemdata.hidestartpage && self.game.pointer === 0){\n                self.container.on(\"showElement\", () => {\n                    doStartTimer();\n                });\n            }else{\n                doStartTimer();\n            }\n        }\n    },\n\n    stopTimer: function(timers) {\n      if (timers.length) {\n          timers.forEach(function(timer) {\n              clearInterval(timer);\n          });\n      }\n    },\n\n      // Stop audio .. usually when leaving the item or sentence\n      stop_audio: function(){\n          var self =this;\n          //pause audio if its playing\n          var theaudio = self.items[self.game.pointer].audio;\n          if(theaudio && !theaudio.paused) {\n              theaudio.pause();\n          }\n      },\n\n    do_evaluation_feedback: function (pronunciation_result, isReview) {\n        var self = this;\n        //this is part of the generated html for each sentence in the item, so we need to create a handle each time\n        var itemfeedbackcontainer = self.container.find(\".item-feedback-container\");\n\n        // Clear previous results\n        itemfeedbackcontainer.html(\"\");\n\n        var twoletterlang = self.itemdata.language.substr(0, 2);\n        if(self.itemdata.rtl){\n            var words = pronunciation_result.privPronJson.Words.reverse();\n        }else{\n            var words = pronunciation_result.privPronJson.Words;\n        }\n\n\n        // Render pronunciation feedback for each word\n        var wordresults= [];\n        words.forEach(function (wordobject) {\n\n            // We are going to skip insertions, because MS Speech in Japanese especially seems to hallucinate them\n            if(wordobject.PronunciationAssessment?.ErrorType === \"Insertion\"){\n                log.debug(\"Skipping insertion word: \", wordobject.Word);\n                return; // Skip this word\n            }\n\n            //For the bar beneath the word we need an array of phoneme scores\n            // If we have syllables we use those, oddly syllables and phoneme scores are often different\n            // so if we always used phonemes, the text markup and bar markup would be visibly different\n            var word_phoneme_score_classes = [];\n\n\n            // For the word/character markup we need to map phonemes or syllables to characters\n            // we call this adata (alignment data)\n            //MS Returns syllables, at least for English, and these have a grapheme so its the best data\n            //for some words e.g \"didn't\" sometimes the grapheme is missing. duh\n            //so we send it down the no grapheme path\n            var have_graphemes = wordobject.Syllables && wordobject.Syllables.length > 0 && wordobject.Syllables[0].Grapheme;\n            if(have_graphemes){\n                //build our phonemes bar data\n                wordobject.Syllables.forEach(function(syllable){\n                    //If errortype =omission there will be no score, we use null to flag that\n                    var thescore = syllable.PronunciationAssessment?.AccuracyScore || null;\n                    word_phoneme_score_classes.push(\n                        self.scoreToColorClass(thescore)\n                    );\n                });\n\n                //Build alignment data\n                var adata =[];\n                //If errortype =omission there will be no score, we use null to flag that\n                var thescore = wordobject.PronunciationAssessment?.AccuracyScore || null;\n                wordobject.Syllables.forEach(function(syllable){\n                    adata.push({\n                        letter: syllable.Grapheme,\n                        phoneme: syllable.Syllable,\n                        score: thescore,\n                    });\n                });\n            //If no syllable data we do our best to simulate it\n            }else{\n\n                //build our phonemes bar data\n                //No syllables so use phonemes for our phonemes bar\n                if(wordobject.Phonemes && wordobject.Phonemes.length > 0){\n                    wordobject.Phonemes.forEach(function(phoneme){\n                        //If errortype =omission there will be no score, we use null to flag that\n                        var thescore = phoneme.PronunciationAssessment?.AccuracyScore || null;\n                        word_phoneme_score_classes.push(\n                            self.scoreToColorClass(thescore)\n                        );\n                    });\n                }\n\n                //Build alignment data\n                // It turns out most msspeech langs will not have phoneme names which makes mapping hard(impossible)\n                // but if we have them we can try to map them to letters.\n                var have_phoneme_names = wordobject.Phonemes && wordobject.Phonemes.length > 0 && wordobject.Phonemes[0].Phoneme !== \"\";\n                if(have_phoneme_names) {\n                    var adata = self.markuphelper.alignPhonemesToLetters(wordobject.Word,\n                        wordobject.Phonemes,\n                        twoletterlang);\n                // if we have no phoneme names or graphemes we just show the word as is with its score. This is awful\n                // we just call the text 'phoneme' here but it means the word chunk and its score.\n                // And the word chunk is the whole word\n                }else{\n                    var adata = [];\n                    //If errortype =omission there will be no score, we use null to flag that\n                    var thescore = wordobject.PronunciationAssessment?.AccuracyScore || null;\n                    adata.push({\n                        letter: wordobject.Word,\n                        phoneme: wordobject.Word,\n                        score: thescore,\n                    });\n                }\n            }\n\n            //assign css color classes to each item in alignment data based on its score and the item's warning threshold\n            adata.forEach(function(a){\n                a.scoreclass = self.scoreToColorClass(a.score);\n            });\n\n            // Store the results for this word, excluding phoneme bars if in review mode\n            if (isReview) {\n                wordresults.push({alignmentdata: adata});\n            } else {\n                wordresults.push({alignmentdata: adata, wordphonemes: word_phoneme_score_classes});\n            }\n\n        });\n\n        //Display result of all words, with phoneme bars per word if we have them\n        templates.render('mod_minilesson/fluencylineresult', {wordresults: wordresults}).then(\n            function(html, js) {\n                // Add result html to feedback container\n                itemfeedbackcontainer.html(html);\n                //store results for later use\n                self.items[self.game.pointer].pronunciation_result = pronunciation_result;\n                self.items[self.game.pointer].answered = true;\n                self.items[self.game.pointer].correct = pronunciation_result.privPronJson.PronunciationAssessment.AccuracyScore >= self.phonemeWarningThreshold;\n                self.items[self.game.pointer].audioself = new Audio();\n                self.items[self.game.pointer].audioself.src = URL.createObjectURL(self.ttrec.audio.blob);\n                self.items[self.game.pointer].lineresulthtml = html;\n\n                // Also store a review version without phoneme bars if not already in review mode\n                if (!isReview) {\n                    // Generate review version without phoneme bars\n                    var wordresults_review = [];\n                    wordresults.forEach(function(wr) {\n                        wordresults_review.push({alignmentdata: wr.alignmentdata});\n                    });\n                    templates.render('mod_minilesson/fluencylineresult', {wordresults: wordresults_review}).then(\n                        function(reviewhtml, reviewjs) {\n                            self.items[self.game.pointer].lineresulthtml_review = reviewhtml;\n                        }\n                    );\n                }\n\n                //since we now have audio, show the self audio player button\n                self.audioplayerbtn_audioself.show();\n\n                //update progress dots\n                self.updateProgressDots();\n            }\n        );\n    },\n\n    do_recolor_continue_button: function(pronunciation_result) {\n        var self = this;\n\n        var accuracyScore = pronunciation_result.accuracyScore;\n        var warningthreshold = self.phonemeWarningThreshold;\n    },\n\n    do_evaluation_stars: function(pronunciation_result) {\n        var self = this;\n        log.debug(\"Accuracy score: \", pronunciation_result.accuracyScore);\n\n        //this is part of the generated html for each sentence in the item, so we need to create a handle each time\n        var itemstarscontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .item-results-container\");\n        // Clear previous results\n        itemstarscontainer.html(\"\");\n        // Create star ratings\n        var starRating = $(\"<div class='fluency_star_rating'>\");\n        var accuracyScore = pronunciation_result.accuracyScore;\n        var maxStars = 5;\n        // calculate starBandWidth // band 1 = 0-19 / band 2 = 20-39 etc.\n        var correctBandwidth = 100 - self.phonemeWarningThreshold;\n        var starBandWidth = (100 - correctBandwidth) / 4;\n\n        for (var i = 0; i < maxStars; i++) {\n            var star = $(\"<i class='fa'>\");\n            if (i <= accuracyScore / starBandWidth ) {\n                star.addClass(\"fa-star\");\n            } else {\n                star.addClass(\"fa-star-o\");\n            }\n            starRating.append(star);\n        }\n        // Append star rating to the feedback container\n        itemstarscontainer.append(starRating);\n        // Add a message based on the accuracy score\n        /*\n        var message = $(\"<div class='fluency_feedback_message'>\");\n        if (accuracyScore >= 80) {\n            message.text(\"Great job! Your pronunciation is excellent.\");\n        } else if (accuracyScore >= 50) {\n            message.text(\"Good effort! Keep practicing to improve your pronunciation.\");\n        } else {\n            message.text(\"Keep trying! Focus on the pronunciation of individual words.\");\n        }\n\n        itemstarscontainer.append(message);\n         */\n    },\n\n      //The old evaluation display with some radial charts etc. We might want to use it later\n      do_evaluation_results: function(pronunciation_result) {\n        var self = this;\n        //this is part of the generated html for each sentence in the item, so we need to create a handle each time\n        var itemresultscontainer = self.container.find(\".item-results-container\");\n\n        // Clear previous results\n        itemresultscontainer.html(\"\");\n        var itemresults = [];\n\n        itemresults.push(\"Accuracy score: \" + pronunciation_result.accuracyScore);\n        itemresults.push(\"Pronunciation score: \" + pronunciation_result.pronunciationScore);\n        itemresults.push(\"Completeness score: \" + pronunciation_result.completenessScore);\n        itemresults.push(\"Fluency score: \" + pronunciation_result.fluencyScore);\n        itemresults.push(\"Prosody score: \" +  pronunciation_result.prosodyScore);\n        itemresultscontainer.append(itemresults.join(\"<br>\"));\n\n        //make a chart for each score\n        var labels = [\"Accuracy\", \"Pronunciation\", \"Completeness\", \"Fluency\", \"Prosody\"];\n        var data = [\n            pronunciation_result.accuracyScore,\n            pronunciation_result.pronunciationScore,\n            pronunciation_result.completenessScore,\n            pronunciation_result.fluencyScore,\n            pronunciation_result.prosodyScore\n        ];\n        labels.forEach(function(label, index) {\n            var chartContainerId = self.itemdata.uniqueid + \"_chart_\" + index;\n            itemresultscontainer.append('<canvas id=\"' + chartContainerId + '\"></canvas>');\n            self.createRadialChart(chartContainerId, [label], [data[index]]);\n        });\n\n        log.debug(\"Accuracy score: \", pronunciation_result.accuracyScore);\n        log.debug(\"Pronunciation score: \", pronunciation_result.pronunciationScore);\n        log.debug(\"Completeness score : \", pronunciation_result.completenessScore);\n        log.debug(\"Fluency score: \", pronunciation_result.fluencyScore);\n        log.debug(\"Prosody score: \", pronunciation_result.prosodyScore);\n\n        log.debug(\"  Word-level details:\");\n        pronunciation_result.detailResult.Words.forEach(function (word, idx) {\n            console.log(\"    \", idx + 1, \": word: \", word.Word, \"\\taccuracy score: \", word.PronunciationAssessment.AccuracyScore, \"\\terror type: \", word.PronunciationAssessment.ErrorType, \";\");\n        });\n    },\n\n    createRadialChart: function(containerId, labels, data) {\n        var ctx = document.getElementById(containerId).getContext('2d');\n        new chartjs(ctx, {\n            type: 'doughnut',\n            data: {\n                labels: labels,\n                datasets: [{\n                    label: 'Scores',\n                    data: data,\n                    backgroundColor: 'rgba(54, 162, 235, 0.2)',\n                    borderColor: 'rgba(54, 162, 235, 1)',\n                    borderWidth: 1\n                }]\n            },\n            options: {\n                scale: {\n                    ticks: {\n                        beginAtZero: true,\n                        max: 100\n                    }\n                }\n            }\n        });\n    },\n\n    //Prepare items for display in the listitemresults template (here and letter in finished review)\n    items_for_results_display: function(includeaudioself, isReview) {\n          var self = this;\n          return self.items.map(function(target) {\n              var resulthtml = target.answered ? (isReview && target.lineresulthtml_review ? target.lineresulthtml_review : target.lineresulthtml) : target.target;\n              return {\n                  target: resulthtml,\n                  pronunciation_result: target.pronunciation_result,\n                  answered: target.answered,\n                  correct: target.correct,\n                  audio: target.audio ? {src: target.audio.src} : null,\n                  audioself: (includeaudioself && target.audioself) ? {src: target.audioself.src} : null,\n              };\n          });\n    },\n\n    scoreToColorClass: function(score)\n      {\n          if (score === null) return \"letter_missing\"; //grey\n          if (score >= this.phonemeWarningThreshold) return \"letter_good\"; //green\n          if (score >= this.phonemeErrorThreshold){\n              if(this.hidewarning) {\n                  return \"letter_wrong\"; // red\n              }else{\n                  return \"letter_fair\"; // orange\n              }\n          }\n          return \"letter_wrong\"; //red\n     },\n\n    //Marking up graphemes letters and phonemes is a dark art, we do that in this object\n    markuphelper: {\n        // Language mappings for phoneme to grapheme groups\n        languageMappings: {\n            en: {\n                graphemeGroups: [\"sh\", \"th\", \"ch\", \"ph\", \"wh\", \"ck\", \"ng\"],\n                phonemeGroups: {\n                    \"\": [\"sh\"],\n                    \"t\": [\"ch\"],\n                    \"\": [\"th\"],\n                    \"\": [\"ng\"],\n                }\n            },\n            es: {\n                graphemeGroups: [\"ll\", \"ch\", \"rr\"],\n                phonemeGroups: {\n                    \"\": [\"ll\"],\n                    \"t\": [\"ch\"],\n                    \"r\": [\"rr\"],\n                }\n            },\n            fr: {\n                graphemeGroups: [\"ch\", \"gn\", \"ou\", \"eau\", \"oi\"],\n                phonemeGroups: {\n                    \"\": [\"ch\"],\n                    \"\": [\"gn\"],\n                    \"u\": [\"ou\"],\n                    \"o\": [\"eau\"],\n                    \"wa\": [\"oi\"]\n                }\n            },\n            // This assumes no diacritics or accents in the Arabic letters\n            ar: {\n                    graphemeGroups: [\"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\", \"\"],\n                    phonemeGroups: {\n                    // Fricatives\n                    \"\": [\"\"],     // voiceless dental fricative\n                    \"\": [\"\"],     // voiced dental fricative\n                    \"\": [\"\"],     // voiceless postalveolar fricative (sh)\n                    \"x\": [\"\"],     // voiceless uvular fricative\n                    \"\": [\"\"],     // voiced uvular fricative\n                    \"\": [\"\"],     // voiceless pharyngeal fricative\n                    \"\": [\"\"],     // voiced pharyngeal fricative\n                    \"h\": [\"\"],     // glottal fricative\n\n                    // Emphatics\n                    \"s\": [\"\"],\n                    \"d\": [\"\"],\n                    \"t\": [\"\"],\n                    \"\": [\"\"],\n\n                    // Stops and other consonants\n                    \"q\": [\"\"],\n                    \"\": [\"\"],     // glottal stop (hamza)\n\n                    // Long vowels (represented as letters)\n                    \"a\": [\"\"],    // alif\n                    \"u\": [\"\"],    // waw\n                    \"i\": [\"\"]     // yaa\n                    }\n                }\n                ,\n            ru: {\n                graphemeGroups: [\"\", \"\", \"\", \"\", \"\", \"\"],\n                phonemeGroups: {\n                \"\": [\"\"],\n                \"t\": [\"\"],\n                \"\": [\"\"],\n                \"\": [\"\"],\n                \"ju\": [\"\"],\n                \"ja\": [\"\"]\n                }\n            },\n            no: {\n                graphemeGroups: [\"kj\", \"sj\", \"ng\"],\n                phonemeGroups: {\n                \"\": [\"kj\"],\n                \"\": [\"sj\"],\n                \"\": [\"ng\"]\n                }\n            },\n            so: {\n                graphemeGroups: [\"kh\", \"dh\", \"sh\"],\n                phonemeGroups: {\n                \"x\": [\"kh\"],\n                \"\": [\"dh\"],\n                \"\": [\"sh\"]\n                }\n            },\n            de: {\n                graphemeGroups: [\"sch\", \"ch\", \"ng\", \"sp\", \"st\", \"z\"],\n                phonemeGroups: {\n                \"\": [\"sch\"],\n                \"\": [\"ch\"],\n                \"\": [\"ng\"],\n                \"p\": [\"sp\"],\n                \"t\": [\"st\"],\n                \"ts\": [\"z\"]\n                }\n            },\n            it: {\n                graphemeGroups: [\"gl\", \"gn\", \"sc\", \"ch\", \"ci\", \"ce\"],\n                phonemeGroups: {\n                \"\": [\"gl\"],\n                \"\": [\"gn\"],\n                \"\": [\"sc\"],\n                \"k\": [\"ch\"],\n                \"t\": [\"ci\", \"ce\"]\n                }\n            }\n        },\n\n\n        alignPhonemesToLetters: function(word, phonemesWithScores, language = \"en\") {\n            const { graphemeGroups = [], phonemeGroups = {} } = this.languageMappings[language] || {};\n\n            // Normalize letters (strip accents, diacritics)\n            function normalizeWord(word, language) {\n                switch (language) {\n                    case \"ar\": return word.normalize(\"NFKD\").replace(/[\\u064B-\\u065F\\u0670]/g, \"\");\n                    default: return word.normalize(\"NFKD\").replace(/[\\u0300-\\u036f]/g, \"\").toLowerCase();\n                }\n            }\n\n            // Chunk graphemes into known groups\n            function tokenizeGraphemes(word, groups) {\n                const tokens = [];\n                let i = 0;\n                while (i < word.length) {\n                    let matched = false;\n                    for (const g of groups.sort((a, b) => b.length - a.length)) {\n                        if (word.slice(i, i + g.length) === g) {\n                            tokens.push(g);\n                            i += g.length;\n                            matched = true;\n                            break;\n                        }\n                    }\n                    if (!matched) {\n                        tokens.push(word[i]);\n                        i += 1;\n                    }\n                }\n                return tokens;\n            }\n\n            // Tokenize phonemes based on mappings\n            function normalizePhoneme(p) {\n                for (const group in phonemeGroups) {\n                    if (phonemeGroups[group].includes(p)) return group;\n                }\n                return p;\n            }\n\n            const normWord = normalizeWord(word, language);\n            const graphemes = tokenizeGraphemes(normWord, graphemeGroups);\n            const phonemes = phonemesWithScores.map(p => normalizePhoneme(p.Phoneme));\n\n            // Dynamic programming\n            const m = graphemes.length, n = phonemes.length;\n            const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));\n            const traceback = Array(m + 1).fill().map(() => Array(n + 1).fill(null));\n\n            const matchCost = 0, mismatchCost = 1, gap = 1;\n\n            for (let i = 0; i <= m; i++) { dp[i][0] = i * gap; traceback[i][0] = \"up\"; }\n            for (let j = 0; j <= n; j++) { dp[0][j] = j * gap; traceback[0][j] = \"left\"; }\n\n            for (let i = 1; i <= m; i++) {\n                for (let j = 1; j <= n; j++) {\n                    const letter = graphemes[i - 1];\n                    const phoneme = phonemes[j - 1];\n                    const cost = letter === phoneme ? matchCost : mismatchCost;\n\n                    const diag = dp[i - 1][j - 1] + cost;\n                    const up = dp[i - 1][j] + gap;\n                    const left = dp[i][j - 1] + gap;\n\n                    dp[i][j] = Math.min(diag, up, left);\n                    traceback[i][j] = (dp[i][j] === diag) ? \"diag\" : (dp[i][j] === up ? \"up\" : \"left\");\n                }\n            }\n\n            let i = m, j = n;\n            const result = [];\n\n            while (i > 0 || j > 0) {\n                const move = traceback[i][j];\n                if (move === \"diag\") {\n                    result.unshift({\n                        letter: graphemes[i - 1],\n                        phoneme: phonemesWithScores[j - 1].Phoneme,\n                        score: phonemesWithScores[j - 1].PronunciationAssessment.AccuracyScore,\n                    });\n                    i--; j--;\n                } else if (move === \"up\") {\n                    result.unshift({ letter: graphemes[i - 1], phoneme: null, score: null });\n                    i--;\n                } else {\n                    j--;\n                }\n            }\n\n            return result;\n        },\n\n    }//end of markup helper\n\n\n    };//end of thefluencyitem\n    return thefluencyitem;\n});"],"file":"fluency.min.js"}