{"version":3,"file":"audiochat.min.js","sources":["../src/audiochat.js"],"sourcesContent":["define(\n    ['jquery', 'core/log', 'mod_minilesson/definitions',\n        'mod_minilesson/ttrecorder', 'core/templates', 'core/str', 'core/fragment', 'core/url'],\n    function ($, log, def, ttrecorder, templates, str, Fragment, Url) {\n        \"use strict\"; // jshint ;_;\n\n        /*\n    This file is to manage the free speaking item type\n            */\n\n          log.debug('MiniLesson AudioChat: initialising');\n\n        return {\n            autocreateresponse : false, // If true, the response will be created automatically\n            gradingrequesttag: \"gradingrequest\", // Tag for the grading request\n            gradingData: false, // Data returne by the grading request\n            strings: {},\n            controls: {}, // Controls for the item\n            itemdata: {}, // Item data for the item\n            index: 0, // Index of the item in the quiz\n            quizhelper: {}, // Quiz helper for the item\n            pc: null,\n            dc: null,\n            cantChat: false,\n            audiochat_voice: \"alloy\", // Default voice for the AI\n            isSessionStarted: false,\n            isSessionStopped: false,\n            isSessionActive: false,\n            isLoading: false,\n            isMicActive: false,\n            isMicInitialized: false, // True when getUserMedia has successfully run once\n            loadingMessages: new Set(), // To track messages that are currently loading,\n            audioContext: null,\n            analyser: null,\n            dataArray: null,\n            sourceNode: null,\n            mediaStream: null,\n            animationFrameId: null,\n            canvasCtx: null,\n            eventlogs: [],\n            items: {},\n            responses: {},\n            abortcontroller: new AbortController(),\n            datainputbuffer: false,\n            inputBufferInterval: null,\n            //Turn detection - semantic is good for native speakers, but awful for language learners\n            // time based we give 3.5s of silence detection before posting\n            semantic_vad: {\n                type: \"semantic_vad\",\n                eagerness: \"low\",\n            },\n\n            timebased_vad: {\n                type: \"server_vad\",\n                silence_duration_ms: 3500,\n                create_response: true, // true = it will turn on and off the mic and respond\n                interrupt_response: true, // only in conversation mode\n                threshold: 0.3,\n                //  \"prefix_padding_ms\": 300,\n            },\n\n            // For making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                this.autocreateresponse = itemdata.audiochat_autoresponse || false;\n                log.debug('itemdata', itemdata);\n                this.quizhelper = quizhelper;\n                this.index = index;\n                this.cantChat = !itemdata.canchat;\n                this.init_strings();\n                this.init_controls(quizhelper, itemdata);\n                this.init_voice(itemdata.audiochat_voice);\n                this.register_events(index, itemdata, quizhelper);\n                this.renderUI();\n            },\n\n            init_strings: function () {\n                var self = this;\n                // Set up strings\n                str.get_strings([\n                    { \"key\": \"gradebywordcount\", \"component\": \"mod_minilesson\" },\n                ]).done(function (s) {\n                    var i = 0;\n                    self.strings.gradebywordcount = s[i++];\n                });\n            },\n\n            next_question: function () {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.lessonitemid = self.itemdata.id;\n                stepdata.totalitems = self.itemdata.totalmarks;\n                stepdata.resultsdata = {'items': Object.values(self.items)};\n                // Add grade and other results data\n                stepdata = self.grade_activity(stepdata);\n                stepdata.correctitems = Math.round((self.itemdata.totalmarks * stepdata.grade) / 100);\n                self.quizhelper.do_next(stepdata);\n            },\n\n            count_words: function () {\n                var self = this;\n                var userTranscript = [];\n                Object.values(self.items).forEach(item => {\n                    if (item.content) {\n                        userTranscript.push(item.content);\n                    }\n                });\n                var wordCount = userTranscript.join(' ').split(/\\s+/).length;\n                return wordCount;\n            },\n\n            toggle_autocreate_response: function () {\n                var self = this;\n                self.autocreateresponse = !self.autocreateresponse;\n                self.timebased_vad.create_response = self.autocreateresponse;\n                log.debug(\"Autocreate response toggled:\", self.autocreateresponse);\n                self.dc.send(JSON.stringify({\n                    type: \"session.update\",\n                    session: {\n                        turn_detection: self.timebased_vad,\n                    }\n                }));\n            },\n\n            grade_activity: function (stepdata) {\n                //loop through items and form a complete user transcript\n                var self = this;\n\n                //count words in the transcript\n                var wordcount = self.count_words();\n\n                if (self.gradingData && self.gradingData.score !== undefined) {\n                    log.debug(\"Using grading data from AI:\", self.gradingData);\n                    // If grading data is available, use it\n                    stepdata.grade = self.gradingData.score;\n\n                    //If target word count is greater then 0, we lower the grade if it is lower then that target word count\n                    if (typeof stepdata.grade === 'number' &&\n                        typeof wordcount === 'number' &&\n                        self.itemdata.targetwordcount > 0 &&\n                         wordcount < self.itemdata.targetwordcount) {\n                        stepdata.grade = Math.round(stepdata.grade * (wordcount / self.itemdata.targetwordcount));\n                    }\n\n\n                    stepdata.resultsdata.aifeedback = self.gradingData.feedback || \"\";\n                    stepdata.resultsdata.gradeexplanation = self.gradingData.gradeexplanation || \"\";\n                } else {\n                    //Otherwise we default to counting words\n                    log.debug(\"No grading data from AI: counting words\", self.gradingData);\n                    stepdata.resultsdata.gradeexplanation = self.strings.gradebywordcount;\n                    if (self.itemdata.countwords === false || self.itemdata.targetwordcount === 0) {\n                        stepdata.grade =  100;\n                    }\n\n\n\n                    // Calculate grade based on word count\n                    stepdata.grade = Math.min(wordcount / self.itemdata.targetwordcount, 1) * 100;\n                }\n\n                // return stepdata\n                return stepdata;\n\n            },\n\n            register_events: function (index, itemdata) {\n\n                var self = this;\n\n                // Event Listeners\n                self.controls.startSessionBtn.addEventListener(\"click\", self.startSession.bind(this));\n                self.controls.stopSessionBtn.addEventListener(\"click\", self.stopSession.bind(this));\n                self.controls.retrySessionBtn.addEventListener(\"click\", self.resetSession.bind(this));\n                self.controls.autocreateresponseCheckbox.addEventListener(\"change\", self.toggle_autocreate_response.bind(self));\n                self.controls.cancelStartSessionBtn.addEventListener(\"click\", () => {\n                    log.debug(\"Cancelling session start\");\n                    self.abortcontroller.abort();\n                    self.abortcontroller = new AbortController();\n                });\n\n                $(self.controls.nextbutton).on('click', function () {\n                    self.next_question();\n                });\n\n                var container = $(self.controls.container);\n                container.on('showElement', () => {\n                    if (itemdata.timelimit > 0) {\n                        container.find(\".progress-container\").show();\n                        container.find(\".progress-container i\").show();\n                        container.find(\".progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                self.controls.nextbutton.trigger('click');\n                            }\n                        });\n                    }\n                });\n\n\n                if (self.controls.toggleMicBtn) {\n                    self.controls.toggleMicBtn.addEventListener(\"click\", self.toggleMute.bind(self));\n                }\n            },\n\n            init_voice: function (voice) {\n                var self = this;\n                var voices = ['alloy', 'ash', 'ballad', 'coral', 'echo', 'sage', 'shimmer', 'verse', 'marin', 'cedar'];\n                if (voice && voices.includes(voice)) {\n                    self.audiochat_voice = voice;\n                } else {\n                    self.audiochat_voice = 'alloy'; // Default voice\n                }\n                log.debug(\"AudioChat voice set to:\", this.audiochat_voice);\n            },\n\n            init_controls: async function () {\n                var self = this;\n                var container = document.getElementById(self.itemdata.uniqueid + \"_container\");\n                self.controls = {\n                    hiddenaudio: container.querySelector('.ml_ac_hiddenaudio'),\n                    nextbutton: container.querySelector('.minilesson_nextbutton'),\n                    cantChatWarning: container.querySelector(\".ml_ac_cantchat\"),\n                    startSessionBtn: container.querySelector(\".ml_ac_start-session-btn\"),\n                    stopSessionBtn: container.querySelector(\".ml_ac_stop-session-btn\"),\n                    loadingIndicator: container.querySelector(\".ml_ac_loading-indicator\"),\n                    aiAvatarSection: container.querySelector(\".ml_ac_ai-avatar-section\"),\n                    chatActiveMessage: container.querySelector(\".ml_ac_chat-active-message\"),\n                    conversationSection: container.querySelector(\".ml_ac_conversation-section\"),\n                    messagesContainer: container.querySelector(\".ml_ac_messages-container\"),\n                    micButtonContainer: container.querySelector(\".mic-button-container\"),\n                    toggleMicBtn: container.querySelector(\".toggle-mic-btn\"),\n                    micWaveformCanvas: container.querySelector(\".mic-waveform-canvas\"),\n                    micSelect: container.querySelector('.ml_ac_micselect'),\n                    finishMessage: container.querySelector('.ml_ac_finished-message'),\n                    retrySessionBtn: container.querySelector('.ml_ac_retrybtn'),\n                    cancelStartSessionBtn: container.querySelector('.ml_ac_cancel-start-session-btn'),\n                    autocreateresponseCheckbox: container.querySelector('.ml_ac_autoresponse-checkbox'),\n                    resultscontainer: container.querySelector('.ml_ac_results_container'),\n                    resultscontent: container.querySelector('.ml_ac_results_content'),\n                    autocreateresponseToggle: container.querySelector('.ml_ac_autoresponse-toggle'),\n\n                    clicktosendlabel: container.querySelector('.ml_ac_clicktosend'),\n                    mainWrapper: container.querySelector('.minilesson_audiochat_box .ml_unique_mainwrapper'),\n                    sessionControls: container.querySelector('.ml_unique_sessioncontrols'),\n                    itemtextAfterchatactive: container.querySelector('.itemtext_afterchatactive'),\n                    micColumn: container.querySelector('.ml_ac_mic-column'),\n                };\n                self.canvasCtx = !self.controls.micWaveformCanvas ? null :\n                    self.controls.micWaveformCanvas.getContext(\"2d\");\n\n                // Initial render\n                await self.populateMicList();\n\n            },\n\n            scrollToBottom: function () {\n                var self = this;\n                self.controls.conversationSection.firstElementChild.scrollIntoViewIfNeeded();\n                self.controls.conversationSection.firstElementChild.scrollTop = self.controls.conversationSection.firstElementChild.scrollHeight;\n            },\n\n            scrollMicButtonIntoView: function () {\n                var self = this;\n                if (self.controls.micButtonContainer) {\n                    self.controls.micButtonContainer.scrollIntoView({behavior: \"smooth\", block: \"center\"});\n                }\n            },\n\n            renderUI: function () {\n                var self = this;\n                // Session Controls\n                self.controls.startSessionBtn.classList.toggle(\"hidden\", self.isSessionActive || self.isLoading || self.isSessionStarted || self.cantChat);\n                self.controls.cantChatWarning.classList.toggle(\"hidden\", !self.cantChat);\n                self.controls.loadingIndicator.classList.toggle(\"hidden\", !self.isLoading);\n                self.controls.stopSessionBtn.classList.toggle(\"hidden\", !self.isSessionActive);\n                self.controls.micButtonContainer.classList.toggle(\"hidden\", !self.isSessionActive);\n                var endScreen = self.isSessionStarted && self.isSessionStopped;\n                self.controls.resultscontainer.classList.toggle(\"hidden\", !endScreen && self.quizhelper.showitemreview);\n                self.controls.finishMessage.classList.toggle(\"hidden\", !endScreen);\n                self.controls.retrySessionBtn.classList.toggle(\"hidden\", !endScreen && self.itemdata.allowretry);\n                // We no longer show the cancel button. It does not work after changes we made to icegathering.\n                // If we set abortcontroller.signal to work with it will work, but it is complex\n                //self.controls.cancelStartSessionBtn.classList.toggle('hidden', !(self.isLoading && !self.isSessionActive));\n                self.controls.autocreateresponseToggle.classList.toggle(\"hidden\", !self.isSessionActive);\n                if (self.controls.micSelect) {\n                    //how many options are in micselect\n                    var mics = self.controls.micSelect.querySelectorAll('option');\n                    var noshowmics = mics.length < 2;\n                    self.controls.micSelect.parentElement.classList.toggle(\n                        'hidden',\n                        noshowmics || self.isSessionStarted || self.isLoading || self.controls.micSelect.disabled\n                    );\n                }\n\n                var orderedItems = [];\n                var idMap = new Map();\n                var previousMap = new Map();\n                var currentItem;\n                Object.values(self.items).forEach(item => {\n                    idMap.set(item.id, item);\n                    previousMap.set(item.previous_item_id, item);\n                    if (item.previous_item_id === null) {\n                        currentItem = item;\n                    }\n                });\n                while (currentItem) {\n                    orderedItems.push(currentItem);\n                    currentItem = previousMap.get(currentItem.id);\n                }\n\n                // The cute dog avatar\n                self.controls.aiAvatarSection.classList.toggle(\"hidden\", self.isSessionStarted || self.isSessionActive || self.isSessionStopped);\n                // The conversation area\n                self.controls.conversationSection.classList.toggle(\"hidden\", !(self.isSessionActive || self.isSessionStopped));\n\n                self.controls.sessionControls.classList.toggle('hidden', self.isSessionStarted || self.isSessionActive || self.isSessionStopped);\n                if (self.controls.itemtextAfterchatactive) {\n                    self.controls.itemtextAfterchatactive.classList.toggle('hidden', !(self.isSessionActive || self.isSessionStopped));\n                }\n                self.controls.micColumn.classList.toggle('hidden', !self.isSessionActive);\n\n                // Render messages\n                self.controls.messagesContainer.innerHTML = \"\"; // Clear existing messages\n\n                orderedItems.forEach((message) => {\n                    if (!message.content) {\n                        return;\n                    }\n                    var messageDiv = document.createElement(\"div\");\n                    messageDiv.className = `ml_unique_ordered_message_${message.usertype === \"user\" ? \"user\" : \"assistant\"}`;\n\n                    var contentDiv = document.createElement(\"div\");\n                    contentDiv.className = `rounded-lg ${\n                            message.usertype === \"user\" ? \"bg-blue-500 text-white\" : \"bg-gray-200 text-gray-800\"\n                    } ml_unique_content_${\n                        message.usertype === \"user\" ? \"user\" : \"assistant\"\n                    }`;\n\n                    var headerDiv = document.createElement(\"div\");\n                    headerDiv.className = \"mb-1 ml_unique_headerdiv\";\n                    if (message.usertype === \"assistant\") {\n                        var pictureDiv = document.createElement('div');\n                        pictureDiv.innerHTML = `\n                            <img src=\"${self.itemdata.avatarimage}?themerev=${M.cfg.themerev}\"\n                            alt=\"AI Assistant\" class=\"mr-2 rounded-circle shadow-lg ml_unique_assistant_img\">\n                            `;\n                        headerDiv.appendChild(pictureDiv);\n                    }\n                    headerDiv.innerHTML += message.usertype === \"user\" ? \"Student\" : \"AI Assistant\";\n                    contentDiv.appendChild(headerDiv);\n\n                    var textDiv = document.createElement(\"div\");\n                    textDiv.className = \"ml_unique_textsmall\";\n                    textDiv.textContent = message.content;\n                    contentDiv.appendChild(textDiv);\n\n                    if (self.loadingMessages.has(message.id)) {\n                        var loaderDiv = document.createElement(\"div\");\n                        loaderDiv.className = \"py-1 message-loader ml_unique_loadingmessage\";\n                        loaderDiv.innerHTML = `\n                            <div class=\"ml_unique_loader\">\n                                <div class=\"ml_unique_loader_dot\"></div>\n                                <div class=\"ml_unique_loader_dot\"></div>\n                                <div class=\"ml_unique_loader_dot\"></div>\n                            </div>\n                            <span class=\"ml_unique_loader_text\">AI is thinking...</span>\n                        `;\n                        contentDiv.appendChild(loaderDiv);\n                    }\n\n                    messageDiv.appendChild(contentDiv);\n                    self.controls.messagesContainer.appendChild(messageDiv);\n                });\n\n                self.scrollToBottom();\n               // self.scrollMicButtonIntoView();\n\n                // Update mic button container and canvas visibility\n                if (self.controls.micButtonContainer) {\n                    self.controls.micButtonContainer.classList.toggle(\"active\", self.isMicActive);\n                    self.controls.micButtonContainer.classList.toggle(\"bg-blue-500\", self.isMicActive); // Active background color\n                    self.controls.micButtonContainer.classList.toggle(\"text-white\", self.isMicActive); // Active icon color\n                    self.controls.micButtonContainer.classList.toggle(\"bg-gray-200\", !self.isMicActive); // Inactive background color\n                    self.controls.micButtonContainer.classList.toggle(\"text-gray-800\", !self.isMicActive); // Inactive icon color\n                }\n\n\n                if (self.controls.micWaveformCanvas) {\n                    self.controls.micWaveformCanvas.classList.toggle(\"active\", self.isMicActive);\n                }\n\n                if (self.controls.toggleMicBtn) {\n                    // Set icon based on mic state\n                    self.controls.toggleMicBtn.innerHTML = self.isMicActive\n                    ? `<svg id=\"mic-icon\" class=\"mic-icon mic-icon-svg ml_unique_micsvg\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n  <rect id=\"primary\" x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"2\" style=\"fill: rgb(0, 0, 0);\"/>\n</svg>\n` // Mic On icon\n                    : `<svg width=\"48\" height=\"48\" viewBox=\"0 0 59 59\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n  <g filter=\"url(#filter0_d_2299_874)\">\n    <circle cx=\"29.2834\" cy=\"27.2834\" r=\"23.2834\" fill=\"#5067FF\"/>\n  </g>\n  <rect x=\"25.641\" y=\"16.3383\" width=\"7.28658\" height=\"13.0053\" rx=\"3.64329\" stroke=\"white\" stroke-width=\"1.7\"/>\n  <path d=\"M37.0438 25.7002C37.0438 29.9866 33.569 33.4613 29.2826 33.4613C24.9963 33.4613 21.5215 29.9866 21.5215 25.7002\" stroke=\"white\" stroke-width=\"1.7\" stroke-linecap=\"round\"/>\n  <path d=\"M29.2832 37.138V33.8701\" stroke=\"white\" stroke-width=\"1.7\"/>\n  <path d=\"M25.6074 37.5459H32.9601\" stroke=\"white\" stroke-width=\"1.7\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n  <defs>\n    <filter id=\"filter0_d_2299_874\" x=\"0\" y=\"0\" width=\"58.5664\" height=\"58.5664\" filterUnits=\"userSpaceOnUse\" color-interpolation-filters=\"sRGB\">\n      <feFlood flood-opacity=\"0\" result=\"BackgroundImageFix\"/>\n      <feColorMatrix in=\"SourceAlpha\" type=\"matrix\" values=\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0\" result=\"hardAlpha\"/>\n      <feOffset dy=\"2\"/>\n      <feGaussianBlur stdDeviation=\"3\"/>\n      <feComposite in2=\"hardAlpha\" operator=\"out\"/>\n      <feColorMatrix type=\"matrix\" values=\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.22 0\"/>\n      <feBlend mode=\"normal\" in2=\"BackgroundImageFix\" result=\"effect1_dropShadow_2299_874\"/>\n      <feBlend mode=\"normal\" in=\"SourceGraphic\" in2=\"effect1_dropShadow_2299_874\" result=\"shape\"/>\n    </filter>\n  </defs>\n</svg>\n`; // Mic Off icon\n                }\n\n                //show or not show clicktosendlabel\n                if (self.isMicActive && !self.autocreateresponse) {\n                    self.controls.clicktosendlabel.classList.remove(\"hidden\");\n                } else {\n                    self.controls.clicktosendlabel.classList.add(\"hidden\");\n                }\n\n            },\n\n            //setter for datainputbuffer\n            setDataInputBuffer: function (value, source) {\n                var self=this;\n                self.datainputbuffer = value;\n                log.debug(\"Data in input buffer set to:\", value);\n                log.debug(\"Data input buffer set source:\", source);\n            },\n\n            resetSession: function () {\n                log.debug(\"reset  session\");\n                var self = this;\n                self.isLoading = false;\n                self.isSessionActive = false;\n                self.isSessionStopped = false;\n                self.isSessionStarted = false;\n                self.renderUI();\n            },\n\n            startSession: async function () {\n                var self = this;\n                var twoletterlang = self.itemdata.language.substr(0, 2);\n                var hiddenaudio = self.controls.hiddenaudio;\n                log.debug(\"Session starting\");\n                self.isLoading = true;\n                self.items = [];\n                self.renderUI();\n                // Open the RTC PeerConnection via Stun and ICE servers\n                log.debug(\"Opening peer connection...\");\n                self.pc = new RTCPeerConnection({\n                    iceServers: [{\n                        urls: \"stun:stun.l.google.com:19302\"\n                    }]\n                });\n\n                // Create a DataChannel for sending events (text and audio)\n                log.debug(\"creating data channel...\");\n                self.dc = self.pc.createDataChannel(\"oai-events\");\n\n                // Handle incoming messages on the DataChannel\n                self.dc.onmessage = (e) => {\n                    self.eventlogs.push(e.data);\n                    //log.debug(\"DataChannel message:\", e.data);\n                    try {\n                        var lines = e.data.split(\"\\n\").filter(Boolean);\n                        for (var line of lines) {\n                            self.handleRTCEvent.call(self, JSON.parse(line));\n                        }\n                    } catch (err) {\n                        log.debug(\"Failed to parse\");\n                        log.debug(err);\n                    }\n                };\n                self.dc.onopen = () => {\n                    log.debug(\"DataChannel open\");\n\n                    //Turn detection - semantic is good for native speakers, but awful for language learners\n                    // time based we give 1.5s of silence detection before posting\n                    // var semantic_vad = {\n                    //     type: \"semantic_vad\",\n                    //     eagerness: \"low\",\n                    // };\n\n                    // Set the auto turn detection, or manual submit flag\n                    self.timebased_vad.create_response = self.autocreateresponse;\n\n                    log.debug(self.itemdata.audiochatinstructions);\n                    var updateinstructions = self.itemdata.audiochatinstructions;\n                    Fragment.loadFragment(\n                        'mod_minilesson',\n                        'audiochat_fetchstudentsubmission',\n                        M.cfg.contextid,\n                        {\n                            itemid: self.itemdata.id\n                        }\n                    ).done(function (studentsubmission) {\n                        log.debug(\"Loaded audio chat studentsubmission:\", studentsubmission);\n                        if (studentsubmission) {\n                            // Replace \"{student submission}\" placeholder with actual submission\n                            updateinstructions = updateinstructions.replace('{student submission}', studentsubmission);\n\n                            // Replace student submission in grade instructions too\n                            self.itemdata.audiochatgradeinstructions = self.itemdata.audiochatgradeinstructions.replace('{student submission}', studentsubmission);\n\n                            // Save student submission in itemdata for later use\n                            self.itemdata.studentsubmission = studentsubmission;\n                        }\n\n                        self.sendEvent({\n                            type: \"session.update\",\n                            session: {\n                                type: 'realtime',\n                                instructions: updateinstructions,\n                                audio: {\n                                    input: {\n                                        transcription: {\n                                            language: twoletterlang,\n                                            model: \"whisper-1\" // \"gpt-4o-mini-transcribe\"  // Use a transcription model\n                                        },\n                                        turn_detection: self.timebased_vad,\n                                    },\n                                    output: {\n                                        speed: 0.9,\n                                        voice: self.audiochat_voice,\n                                    }\n                                },\n                                output_modalities: [\"audio\"],\n                            }\n                        });\n\n                        // Send the first message to tell AI to say something\n                        // the response create function overrides the session instructions, so we need to double up here\n                        var firstmessageinstructions =  \"Please introduce yourself to the student and explain todays topic.\";\n                        self.sendEvent({\n                            type: \"response.create\",\n                            response: {\n                                output_modalities: [\"audio\"],\n                                instructions:  updateinstructions + \" \" + firstmessageinstructions,\n                                audio: {\n                                    output: {\n                                        voice: self.audiochat_voice,\n                                    },\n                                },\n                            }\n                        });\n                    });\n                };\n\n                // Set up the audio element to play incoming audio.\n                self.pc.ontrack = (event) => {\n                    hiddenaudio.srcObject = event.streams[0];\n                };\n\n                // Set up the Mic stream.\n                self.mediaStream = await navigator.mediaDevices.getUserMedia({audio: true});\n                self.mediaStream.getTracks().forEach((track) => {\n                    track.enabled = false;\n                    self.pc.addTrack(track, self.mediaStream);\n                });\n\n                // Set up the RTC Connection by bouncing our request off the Moodle server\n                var offer = await self.pc.createOffer({\n                    offerToReceiveAudio: true\n                });\n                await self.pc.setLocalDescription(offer);\n                // Search for server candidates for relaying messages, may take 15s\n                await self.waitForIceGathering(self.pc);\n\n                try {\n                    var sdpResponse = await fetch(M.cfg.wwwroot + \"/mod/minilesson/openairtc.php\", {\n                        method: \"POST\",\n                        headers: {\n                            \"Content-Type\": \"application/sdp\"\n                        },\n                        body: self.pc.localDescription.sdp,\n                        signal: self.abortcontroller.signal\n                    });\n                    if (!sdpResponse.ok) {\n                        log.debug(\"Failed /rtc:\", await sdpResponse.text());\n                        return;\n                    }\n                    log.debug(\"Received SDP answer from server\");\n                    var answer = await sdpResponse.text();\n                    log.debug(answer);\n                    await self.pc.setRemoteDescription({\n                        type: \"answer\",\n                        sdp: answer\n                    });\n                    log.debug(\"Session started\");\n                } catch (e) {\n                    log.debug(e, 'connect error');\n                    if (e.name === 'AbortError') {\n                        log.debug(\"Session start aborted by user.\");\n                        // Reset UI and state as needed\n                        self.isLoading = false;\n                        self.renderUI();\n                        return;\n                    }\n\n                    // Close data channel if open\n                    if (self.dc) {\n                        self.dc.close();\n                    }\n                    // Close peer connection if open\n                    if (self.pc) {\n                        self.pc.close();\n                    }\n                    if (self.mediaStream) {\n                        self.mediaStream.getTracks().forEach((track) => track.stop());\n                    }\n                    self.isLoading = false;\n                    self.renderUI();\n                    return;\n                }\n\n                self.isLoading = false;\n                self.isSessionActive = true;\n                self.isSessionStarted = true;\n                self.isSessionStopped = false;\n                self.renderUI();\n            },\n\n            sendGradingRequest: function () {\n                var self = this;\n                // Send a final message to tell AI to grade the session and give feedback\n                var gradingInstructions = \"Please provide a percentage score for the session, an explanation of the score (for teachers), and feedback (for the student). \" +\n                     self.itemdata.audiochatgradeinstructions +\n                    \"Return the response as JSON in the format: {\\\"score\\\": \\\"the score  ( 0-100 ) \\\", \\\"gradeexplanation\\\": \\\"the explanation\\\", \\\"feedback\\\": \\\"the feedback\\\"}.\";\n\n                var responsedata = {\n                    // The response is out of band and not be added to the default conversation\n                    conversation: \"none\",\n                    output_modalities: [\"text\"],\n                    instructions: gradingInstructions,\n                    // Add the gradingrequest tag to make handltertc life easier\n                    metadata: { tag: self.gradingrequesttag},\n                    max_output_tokens: 500, // Keeps it tight\n                    // temperature: 0.6, // Optional: makes grading more deterministic\n                };\n\n                //If we wanted to reutrn an audio response (but lets not)\n                //responsedata.voice = self.audiochat_voice;\n\n                self.sendEvent({\n                    type: \"response.create\",\n                    response: responsedata,\n                });\n            },\n\n            stopSession: function () {\n                var self = this;\n\n                log.debug(\"Session stopping...\");\n                self.isSessionActive = false;\n                self.isSessionStopped = true;\n                self.loadingMessages.clear();\n\n                // Release mic resources when session ends\n                self.releaseMicResources();\n                self.renderUI();\n\n                // request grading information\n                // after that response, we will close the data channel and peer connection\n                //but shut it down after 2s just in case there is an error or something\n                if (self.itemdata.audiochatgradeinstructions && self.itemdata.audiochatgradeinstructions !== \"\") {\n                    self.sendGradingRequest();\n\n                    //add a spinner to the results content\n                    //if we are not showing item review we do not need this, but in that case it is hidden anyway\n                    self.controls.resultscontent.innerHTML = `<i class=\"fa fa-spinner fa-spin fa-2x\"></i>`;\n\n                    setTimeout(() => {\n                        //now show the results content if that is what we are doing\n                        if (self.quizhelper.showitemreview) {\n                            self.showResults();\n                        }\n                        log.debug(\"Closing session resources...\");\n                        self.closeDataChannel();\n                    }, 7000);\n                } else {\n                    log.debug(\"Closing session resources...\");\n                    self.closeDataChannel();\n                }\n                log.debug(\"Session stopped\");\n            },\n\n            closeDataChannel: function () {\n                var self = this;\n                // Tidy up the data channel and peer connection\n                if (typeof self.dc !== 'undefined' && self.dc) {\n                    self.dc.close();\n                    self.dc = null;\n                }\n                if (typeof self.pc !== 'undefined' && self.pc) {\n                    self.pc.close();\n                    self.pc = null;\n                }\n            },\n\n            showResults: function () {\n                var self = this;\n                var tdata = {};\n                tdata.resultsdata = {'items': Object.values(self.items)};\n                // Add grade and other results data\n                tdata = self.grade_activity(tdata);\n\n                //calculate stars from grade\n                const stars = [];\n                const maxStars = 5;\n                // if tdata grade is NAn or undefined, set it to 0\n                if (typeof tdata.grade === 'undefined' || isNaN(tdata.grade) || tdata.grade === null || tdata.grade === \"\") {\n                    tdata.grade = 0;\n                }\n\n                const filledStars = Math.round((tdata.grade / 100) * maxStars);\n                for (let i = 0; i < maxStars; i++) {\n                    stars.push({ filled: i < filledStars });\n                }\n                tdata.stars = stars;\n                tdata.yellow_starImgurl = Url.imageUrl('yellow_star', 'mod_minilesson');\n                tdata.gray_starImgurl = Url.imageUrl('gray_star', 'mod_minilesson');\n\n                templates.render('mod_minilesson/audiochatimmediatefeedback', tdata).then(\n                    function (html, js) {\n                        self.controls.resultscontent.innerHTML = html;\n                        templates.runTemplateJS(js);\n                    }\n                );\n            },\n\n            waitForIceGathering: function (pc, timeout = 15000) {\n                return new Promise((resolve) => {\n                    let timer;\n\n                    function checkState()\n                    {\n                        if (pc.iceGatheringState === \"complete\") {\n                            clearTimeout(timer);\n                            pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                            resolve();\n                        }\n                    }\n\n                    pc.addEventListener(\"icegatheringstatechange\", checkState);\n\n                    // Timeout to resolve with current state\n                    timer = setTimeout(() => {\n                        pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                        resolve(); // Resolve with as many candidates as gathered so far\n                    }, timeout);\n                });\n            },\n\n            sendEvent: function (obj) {\n                var self = this;\n                if (self.dc && self.dc.readyState === \"open\") {\n                    self.dc.send(JSON.stringify(obj));\n                }\n            },\n\n            handleRTCEvent: function (msg) {\n                var self = this;\n                log.debug(\"Received event:\");\n                log.debug(msg);\n\n                // Check if its the final grading message, which we don't want to enter \"items\"\n                if (msg.type === \"response.done\" &&\n                    msg.response.metadata?.tag === self.gradingrequesttag) {\n                    // Check if the response corresponds to the grading event\n                    log.debug(\"It is a grading event:\");\n                    try {\n                        var jsonresponse = msg.response.output[0].content[0].text;\n                        const jsonextractregex = /\\{[\\s\\S]*?\\}/;\n                        if (!jsonresponse || jsonresponse === \"\" || !jsonresponse.match(jsonextractregex)) {\n                            log.debug(\"No valid grading data received .. msg is ..\");\n                            log.debug(msg);\n                            self.closeDataChannel();\n                            return;\n                        }\n\n                        self.gradingData = JSON.parse(jsonresponse.match(jsonextractregex)[0]);\n                        log.debug(\"Grading and Feedback:\", self.gradingData);\n                    } catch (err) {\n                        self.gradingData = false;\n                        log.debug(\"Failed to parse grading feedback:\", err);\n                        log.debug(jsonresponse);\n                    }\n                        return;\n                }\n\n                // log.debug(msg);\n                var msgresponse_id = msg.response ? msg.response.id : msg.response_id;\n                var msgitem_id = msg.item ? msg.item.id : msg.item_id;\n                if (msgresponse_id) {\n                    self.responses[msgresponse_id] = self.responses[msgresponse_id] || {\n                        id: msgresponse_id,\n                        itemid: msgitem_id,\n                        stack: []\n                    };\n                }\n                if (msgitem_id) {\n                    if (typeof self.items[msgitem_id] === 'undefined') {\n                        self.scrollToBottom();\n                    }\n                    self.items[msgitem_id] = self.items[msgitem_id] || {\n                        id: msgitem_id,\n                        events: [],\n                        responses: null,\n                        content: ''\n                    };\n                    if (msgresponse_id) {\n                        self.items[msgitem_id].responses = self.responses[msgresponse_id];\n                    }\n                }\n\n                msg.time = Date.now().toString();\n\n                switch (msg.type) {\n                    case \"response.created\": {\n        /*```\n    {\n    \"type\": \"response.created\",\n    \"event_id\": \"event_Bzbmm1vOdUpYK5LcKMPAU\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"in_progress\",\n        \"status_details\": null,\n        \"output\": [],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": null,\n        \"metadata\": null\n    }\n    }\n        ```*/\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_item.added\": {\n        /*```\n    {\n    \"type\": \"response.output_item.added\",\n    \"event_id\": \"event_BzbmnNUVJeqok4KqSLSVl\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.added\":\n                    case \"conversation.item.created\": {\n        /*```\n    {\n    \"type\": \"conversation.item.created\",\n    \"event_id\": \"event_BzbmnttqDhvU3h2he1tK7\",\n    \"previous_item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n    }\n        ```*/\n                        self.items[msg.item.id].previous_item_id = msg.previous_item_id;\n                        self.items[msg.item.id].usertype = msg.item.role;\n                        self.items[msg.item.id].events.push(msg);\n                        if (msg.item.role === 'assistant') {\n                            self.loadingMessages.add(msgitem_id);\n                        }\n                        break;\n                    }\n                    case \"response.content_part.added\": {\n        /*```\n    {\n    \"type\": \"response.content_part.added\",\n    \"event_id\": \"event_Bzbmn7lA1i7fOfFq8ju3F\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"\"\n    }\n    }\n        ```*/\n                        self.enableMic();// Let's enable mic\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_audio_transcript.delta\":\n                    case \"response.audio_transcript.delta\": {\n        /*```\n    {\n    \"type\": \"response.audio_transcript.delta\",\n    \"event_id\": \"event_BzbmnpxUmLA0zAnR5mRy3\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"delta\": \"Hi\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.items[msg.item_id].content += msg.delta;\n                        break;\n                    }\n\n                    case \"output_audio_buffer.cleared\": {\n        /*```\n    {\n    \"type\": \"output_audio_buffer.cleared\",\n    \"event_id\": \"event_f7273193069b4938\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_audio.done\":\n                    case \"response.audio.done\": {\n        /*```\n    {\n    \"type\": \"response.audio.done\",\n    \"event_id\": \"event_Bzbmn7aEtTnprkzqE9i6X\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_audio_transcript.done\":\n                    case \"response.audio_transcript.done\": {\n        /*```\n    {\n    \"type\": \"response.audio_transcript.done\",\n    \"event_id\": \"event_BzbmnNGRs7797nz1Qh7em\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.items[msg.item_id].content = msg.transcript;\n                        break;\n                    }\n                    case \"response.content_part.done\": {\n        /*```\n    {\n    \"type\": \"response.content_part.done\",\n    \"event_id\": \"event_BzbmnYdAvAKMU7ti311Vj\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_item.done\": {\n        /*```\n    {\n    \"type\": \"response.output_item.done\",\n    \"event_id\": \"event_BzbmnhD5RdLxAOnko94Z1\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"incomplete\",\n        \"role\": \"assistant\",\n        \"content\": [\n            {\n                \"type\": \"audio\",\n                \"transcript\": \"Hi! How are you today? What did you do today?\"\n            }\n        ]\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.loadingMessages.delete(msg.item.id);\n                        break;\n                    }\n                    case \"response.done\": {\n        /*```\n    {\n    \"type\": \"response.done\",\n    \"event_id\": \"event_Bzbmn8bIaGB59d6qG7LQS\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"cancelled\",\n        \"status_details\": {\n            \"type\": \"cancelled\",\n            \"reason\": \"turn_detected\"\n        },\n        \"output\": [\n            {\n                \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n                \"object\": \"realtime.item\",\n                \"type\": \"message\",\n                \"status\": \"incomplete\",\n                \"role\": \"assistant\",\n                \"content\": [\n                    {\n                        \"type\": \"audio\",\n                        \"transcript\": \"Hi! How are you today? What did you do today?\"\n                    }\n                ]\n            }\n        ],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": {\n            \"total_tokens\": 170,\n            \"input_tokens\": 94,\n            \"output_tokens\": 76,\n            \"input_token_details\": {\n                \"text_tokens\": 87,\n                \"audio_tokens\": 7,\n                \"cached_tokens\": 0,\n                \"cached_tokens_details\": {\n                    \"text_tokens\": 0,\n                    \"audio_tokens\": 0\n                }\n            },\n            \"output_token_details\": {\n                \"text_tokens\": 23,\n                \"audio_tokens\": 53\n            }\n        },\n        \"metadata\": null\n    }\n    }\n        ```*/\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"output_audio_buffer.stopped\": {\n        /*```\n    {\n    \"type\":\"output_audio_buffer.stopped\",\n    \"event_id\":\"event_0ebd8495b5a945e5\",\n    \"response_id\":\"resp_C17PJbWxcyg7tgQBVTAaL\"\n    }\n        ```*/\n                        if (!self.isMicActive) {\n                            self.toggleMute();\n                        }\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.truncated\": {\n        /*```\n    {\n    \"type\": \"conversation.item.truncated\",\n    \"event_id\": \"event_BzbmnGqfHdq1hy2Wr2fnA\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"content_index\": 0,\n    \"audio_end_ms\": 261\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    // User events.\n                    case \"input_audio_buffer.speech_started\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.speech_started\",\n    \"event_id\": \"event_Bzbmm9FJ5oCTmCpng9tem\",\n    \"audio_start_ms\": 820,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/\n                        log.debug(\"Input audio buffer speech started\");\n                        self.setDataInputBuffer(true, 'audiobufferstarted');\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"input_audio_buffer.speech_stopped\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.speech_stopped\",\n    \"event_id\": \"event_BzbmmUgLX2JKgJr1eMx0l\",\n    \"audio_end_ms\": 1568,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/\n                        if (self.isMicActive) {\n                            // Only auto-toggle mic if autocreateresponse is true\n                            if (self.autocreateresponse) {\n                                self.toggleMute();\n                                self.disableMic();\n                            }\n                        }\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"input_audio_buffer.committed\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.committed\",\n    \"event_id\": \"event_BzbmmOICFLRU8vnGEJ6vM\",\n    \"previous_item_id\": null,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/               log.debug(\"Input audio buffer committed\");\n                        self.setDataInputBuffer(false, 'audiobuffercommitted');\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.input_audio_transcription.delta\": {\n        /*```\n    {\n    \"type\": \"conversation.item.input_audio_transcription.delta\",\n    \"event_id\": \"event_BzbmonQuYXZ7QxUCOLlZd\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"delta\": \"Hey.\"\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        self.items[msg.item_id].content += msg.delta;\n                        break;\n                    }\n                    case \"conversation.item.input_audio_transcription.completed\": {\n        /*```\n    {\n    \"type\": \"conversation.item.input_audio_transcription.completed\",\n    \"event_id\": \"event_BzbmotVIjHphgHjViNkZk\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"transcript\": \"Hey.\",\n    \"usage\": {\n        \"type\": \"duration\",\n        \"seconds\": 1\n    }\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        self.items[msg.item_id].content = msg.transcript;\n                        self.loadingMessages.delete(msg.item_id);\n                        break;\n                    }\n                }\n                self.renderUI();\n            },\n\n            enableMic: function () {\n                var self = this;\n                if (self.controls.toggleMicBtn) {\n                    log.debug('Enabling mic');\n                    self.controls.toggleMicBtn.parentElement.classList.remove('disabled');\n                }\n            },\n\n            disableMic: function () {\n                var self = this;\n                if (self.controls.toggleMicBtn) {\n                    log.debug('Disabling mic');\n                    self.controls.toggleMicBtn.parentElement.classList.add('disabled');\n                }\n            },\n\n            initializeMicStream: async function () {\n                var self = this;\n                try {\n                    self.audioContext = new(window.AudioContext || window.webkitAudioContext)();\n                    self.analyser = self.audioContext.createAnalyser();\n                    self.analyser.fftSize = 2048;\n                    const bufferLength = self.analyser.frequencyBinCount;\n                    self.dataArray = new Uint8Array(bufferLength);\n\n                    self.sourceNode = self.audioContext.createMediaStreamSource(self.mediaStream);\n                    // Source is connected/disconnected in toggleMute\n                    self.isMicInitialized = true;\n                    return true;\n                } catch (err) {\n                    log.debug(\"Error accessing microphone:\", err);\n                    self.isMicInitialized = false;\n                    log.debug(\"Could not access microphone. Please ensure it's connected and permissions are granted.\");\n                    return false;\n                }\n            },\n\n            // Toggles mute/unmute state of the mic\n            toggleMute: async function () {\n                var self = this;\n                if (!self.isMicInitialized) {\n                    const success = await self.initializeMicStream();\n                    if (!success) {\n                        return;\n                    } // If initialization failed, stop here\n                }\n\n                if (self.isMicActive) {\n                    // Mute mic: Disconnect source from analyser\n                    if (self.sourceNode && self.analyser) {\n                        self.sourceNode.disconnect(self.analyser);\n                    }\n                    if (self.animationFrameId) {\n                        cancelAnimationFrame(self.animationFrameId);\n                        self.animationFrameId = null;\n                    }\n                    if (self.pc) {\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = false;\n                        });\n                    }\n                    if (self.canvasCtx) {\n                        self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                    }\n                    self.isMicActive = false;\n\n                    // Send response event when mic is disabled and autocreateresponse is false\n                    if (!self.autocreateresponse) {\n                        if (!self.datainputbuffer) {\n                            log.debug(\" sending response.create\");\n                            self.sendEvent({\n                                type: \"response.create\",\n                                response: {\n                                    output_modalities: [\"audio\"],\n                                    instructions: self.itemdata.audiochatinstructions,\n                                    audio: {\n                                        output: {\n                                            voice: self.audiochat_voice,\n                                        },\n                                    },\n                                }\n                            });\n                        } else {\n                            //set a recurring 500ms timeout that will send the response.create event if self.datainputbuffer is false\n                            log.debug(\"Waiting for input audio buffer to commit before sending response.create\");\n                            let attempts = 0;\n                            if (self.inputBufferInterval) {\n                                clearInterval(self.inputBufferInterval);\n                                self.inputBufferInterval = null;\n                            }\n                            const maxAttempts = 3;\n                            self.inputBufferInterval = setInterval(() => {\n                                log.debug(\"Checking input buffer status, attempt:\", attempts);\n                                if (!self.datainputbuffer || attempts >= maxAttempts) {\n                                    clearInterval(self.inputBufferInterval);\n                                    self.setDataInputBuffer(false, 'setInterval:' + attempts);\n                                    log.debug(\" sending response.create\");\n                                    self.sendEvent({\n                                        type: \"response.create\",\n                                        response: {\n                                            output_modalities: [\"audio\"],\n                                            instructions: self.itemdata.audiochatinstructions,\n                                            audio: {\n                                                output: {\n                                                    voice: self.audiochat_voice,\n                                                },\n                                            },\n                                        }\n                                    });\n                                }\n                                attempts++;\n                            }, 1500);\n                        }\n                    }\n                } else {\n                    // Unmute mic: Connect source to analyser\n                    if (self.sourceNode && self.analyser) {\n                        self.sourceNode.connect(self.analyser);\n                    }\n\n                    if (self.pc) {\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = true;\n                        });\n                    }\n                    self.isMicActive = true;\n                    self.drawWave(); // Start drawing waveform\n                }\n                self.renderUI(); // Update UI\n            },\n\n            releaseMicResources: function () {\n                var self = this;\n                if (self.animationFrameId) {\n                    cancelAnimationFrame(self.animationFrameId);\n                    self.animationFrameId = null;\n                }\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach((track) => {\n                        if (typeof self.pc !== 'undefined' && self.pc) {\n                            // Find the RTCRtpSender associated with the track\n                            const sender = self.pc.getSenders().find(s => s.track === track);\n                            // Remove the sender if it exists\n                            if (sender) {\n                                self.pc.removeTrack(sender);\n                            }\n                        }\n                        track.stop();\n                    });\n                    self.mediaStream = null;\n                }\n                if (self.sourceNode) {\n                    self.sourceNode.disconnect();\n                    self.sourceNode = null;\n                }\n                if (self.audioContext) {\n                    self.audioContext.close();\n                    self.audioContext = null;\n                }\n                self.isMicActive = false;\n                self.isMicInitialized = false;\n                if (self.canvasCtx) {\n                    self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                }\n                self.renderUI(); // Update UI to show mic inactive\n            },\n\n            drawWave: function () {\n                var self = this;\n                if (!self.canvasCtx || !self.analyser || !self.dataArray || !self.isMicActive) {\n                    self.animationFrameId = null; // Stop animation if conditions are not met\n                    return;\n                }\n\n                const WIDTH = self.controls.micWaveformCanvas.width;\n                const HEIGHT = self.controls.micWaveformCanvas.height;\n\n                self.animationFrameId = requestAnimationFrame(self.drawWave.bind(self));\n\n                self.analyser.getByteTimeDomainData(self.dataArray); // Get waveform data\n\n                self.canvasCtx.clearRect(0, 0, WIDTH, HEIGHT); // Clear previous drawing\n                self.canvasCtx.lineWidth = 2;\n                self.canvasCtx.strokeStyle = \"rgb(255, 255, 255)\"; // White color for wave on blue background\n\n                self.canvasCtx.beginPath();\n\n                const sliceWidth = (WIDTH * 1.0) / self.dataArray.length;\n                let x = 0;\n\n                for (let i = 0; i < self.dataArray.length; i++) {\n                    const v = self.dataArray[i] / 128.0; // Normalize to 0-2\n                    const y = (v * HEIGHT) / 2;\n\n                    if (i === 0) {\n                        self.canvasCtx.moveTo(x, y);\n                    } else {\n                        self.canvasCtx.lineTo(x, y);\n                    }\n\n                    x += sliceWidth;\n                }\n\n                self.canvasCtx.lineTo(WIDTH, HEIGHT / 2);\n                self.canvasCtx.stroke();\n            },\n\n            populateMicList: async function () {\n                var self = this;\n                try {\n                    const devices = await navigator.mediaDevices.enumerateDevices();\n                    const mics = devices.filter(device => device.kind === \"audioinput\");\n                    const select = self.controls.micSelect;\n\n                    select.innerHTML = \"\"; // Clear existing options\n\n                    // Group by groupId to remove duplicates\n                    const uniqueMics = [];\n                    const seenGroups = new Set();\n\n                    for (const mic of mics) {\n                        if (!seenGroups.has(mic.groupId)) {\n                            uniqueMics.push(mic);\n                            seenGroups.add(mic.groupId);\n                        }\n                    }\n\n                    if (uniqueMics.length <= 1) {\n                        select.disabled = true;\n                        return;\n                    }\n                    uniqueMics.forEach((mic, index) => {\n                        const option = document.createElement(\"option\");\n                        option.value = mic.deviceId;\n                        option.text = mic.label || `Microphone ${index + 1}`;\n                        select.appendChild(option);\n                    });\n                    select.parentElement.classList.remove('hidden');\n\n                    // Set change listener\n                    select.addEventListener(\"change\", async(e) => {\n                        const deviceId = e.target.value;\n                        await self.switchMic(deviceId);\n                    });\n                } catch (err) {\n                    log.debug(\"Failed to get microphone list:\", err);\n                }\n            },\n\n            switchMic: async function (deviceId) {\n                var self = this;\n\n                // Stop and release current mic\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach(track => track.stop());\n                }\n\n                try {\n                    // Get new media stream from selected device\n                    self.mediaStream = await navigator.mediaDevices.getUserMedia({\n                        audio: {deviceId: {exact: deviceId}}\n                    });\n\n                    // Replace tracks in PeerConnection\n                    if (self.pc) {\n                        const senders = self.pc.getSenders();\n                        const audioTrack = self.mediaStream.getAudioTracks()[0];\n                        const audioSender = senders.find(sender => sender.track.kind === 'audio');\n                        if (audioSender) {\n                            audioSender.replaceTrack(audioTrack);\n                        }\n                    }\n\n                    // Reinitialize mic stream and waveform\n                    await self.initializeMicStream();\n                    if (self.isMicInitialized) {\n                        self.sourceNode.connect(self.analyser);\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = self.isMicActive;\n                        });\n                        if (self.isMicActive) {\n                            self.drawWave();\n                        }\n                    }\n\n                    log.debug(\"Switched microphone to:\" + deviceId);\n                } catch (err) {\n                    log.debug(\"Failed to switch microphone:\");\n                    log.debug(err);\n                }\n            },\n\n        }; // End of return object.\n    }\n);"],"names":["define","$","log","def","ttrecorder","templates","str","Fragment","Url","debug","autocreateresponse","gradingrequesttag","gradingData","strings","controls","itemdata","index","quizhelper","pc","dc","cantChat","audiochat_voice","isSessionStarted","isSessionStopped","isSessionActive","isLoading","isMicActive","isMicInitialized","loadingMessages","Set","audioContext","analyser","dataArray","sourceNode","mediaStream","animationFrameId","canvasCtx","eventlogs","items","responses","abortcontroller","AbortController","datainputbuffer","inputBufferInterval","semantic_vad","type","eagerness","timebased_vad","silence_duration_ms","create_response","interrupt_response","threshold","clone","extend","this","init","audiochat_autoresponse","canchat","init_strings","init_controls","init_voice","register_events","renderUI","self","get_strings","done","s","i","gradebywordcount","next_question","stepdata","hasgrade","lessonitemid","id","totalitems","totalmarks","resultsdata","Object","values","grade_activity","correctitems","Math","round","grade","do_next","count_words","userTranscript","forEach","item","content","push","join","split","length","toggle_autocreate_response","send","JSON","stringify","session","turn_detection","wordcount","undefined","score","targetwordcount","aifeedback","feedback","gradeexplanation","countwords","min","startSessionBtn","addEventListener","startSession","bind","stopSessionBtn","stopSession","retrySessionBtn","resetSession","autocreateresponseCheckbox","cancelStartSessionBtn","abort","nextbutton","on","container","timelimit","find","show","progressTimer","height","timeLimit","onFinish","trigger","toggleMicBtn","toggleMute","voice","includes","async","document","getElementById","uniqueid","hiddenaudio","querySelector","cantChatWarning","loadingIndicator","aiAvatarSection","chatActiveMessage","conversationSection","messagesContainer","micButtonContainer","micWaveformCanvas","micSelect","finishMessage","resultscontainer","resultscontent","autocreateresponseToggle","clicktosendlabel","mainWrapper","sessionControls","itemtextAfterchatactive","micColumn","getContext","populateMicList","scrollToBottom","firstElementChild","scrollIntoViewIfNeeded","scrollTop","scrollHeight","scrollMicButtonIntoView","scrollIntoView","behavior","block","classList","toggle","endScreen","showitemreview","allowretry","noshowmics","querySelectorAll","parentElement","disabled","currentItem","orderedItems","idMap","Map","previousMap","set","previous_item_id","get","innerHTML","message","messageDiv","createElement","className","usertype","contentDiv","headerDiv","pictureDiv","avatarimage","M","cfg","themerev","appendChild","textDiv","textContent","has","loaderDiv","remove","add","setDataInputBuffer","value","source","twoletterlang","language","substr","RTCPeerConnection","iceServers","urls","createDataChannel","onmessage","e","data","lines","filter","Boolean","line","handleRTCEvent","call","parse","err","onopen","audiochatinstructions","updateinstructions","loadFragment","contextid","itemid","studentsubmission","replace","audiochatgradeinstructions","sendEvent","instructions","audio","input","transcription","model","output","speed","output_modalities","response","ontrack","event","srcObject","streams","navigator","mediaDevices","getUserMedia","getTracks","track","enabled","addTrack","offer","createOffer","offerToReceiveAudio","setLocalDescription","waitForIceGathering","sdpResponse","fetch","wwwroot","method","headers","body","localDescription","sdp","signal","ok","text","answer","setRemoteDescription","name","close","stop","sendGradingRequest","responsedata","conversation","metadata","tag","max_output_tokens","clear","releaseMicResources","setTimeout","showResults","closeDataChannel","tdata","stars","isNaN","filledStars","filled","yellow_starImgurl","imageUrl","gray_starImgurl","render","then","html","js","runTemplateJS","timeout","Promise","resolve","timer","checkState","iceGatheringState","clearTimeout","removeEventListener","obj","readyState","msg","msgresponse_id","response_id","msgitem_id","item_id","stack","events","time","Date","now","toString","role","enableMic","delta","transcript","delete","disableMic","jsonresponse","jsonextractregex","match","initializeMicStream","window","AudioContext","webkitAudioContext","createAnalyser","fftSize","bufferLength","frequencyBinCount","Uint8Array","createMediaStreamSource","disconnect","cancelAnimationFrame","clearRect","width","attempts","clearInterval","maxAttempts","setInterval","connect","drawWave","sender","getSenders","removeTrack","WIDTH","HEIGHT","requestAnimationFrame","getByteTimeDomainData","lineWidth","strokeStyle","beginPath","sliceWidth","x","y","moveTo","lineTo","stroke","mics","enumerateDevices","device","kind","select","uniqueMics","seenGroups","mic","groupId","option","deviceId","label","target","switchMic","exact","senders","audioTrack","getAudioTracks","audioSender","replaceTrack"],"mappings":"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"}