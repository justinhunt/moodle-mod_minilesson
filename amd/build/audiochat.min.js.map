{"version":3,"sources":["../src/audiochat.js"],"names":["define","$","log","def","ttrecorder","templates","str","Fragment","debug","autocreateresponse","gradingrequesttag","gradingData","strings","controls","itemdata","index","quizhelper","pc","dc","cantChat","audiochat_voice","isSessionStarted","isSessionStopped","isSessionActive","isLoading","isMicActive","isMicInitialized","loadingMessages","Set","audioContext","analyser","dataArray","sourceNode","mediaStream","animationFrameId","canvasCtx","eventlogs","items","responses","abortcontroller","AbortController","datainputbuffer","inputBufferInterval","semantic_vad","type","eagerness","timebased_vad","silence_duration_ms","create_response","interrupt_response","threshold","clone","extend","init","audiochat_autoresponse","canchat","init_strings","init_controls","init_voice","register_events","renderUI","self","get_strings","done","s","i","gradebywordcount","next_question","stepdata","hasgrade","lessonitemid","id","totalitems","totalmarks","resultsdata","Object","values","grade_activity","correctitems","Math","round","grade","do_next","count_words","userTranscript","forEach","item","content","push","wordCount","join","split","length","toggle_autocreate_response","send","JSON","stringify","session","turn_detection","wordcount","score","targetwordcount","aifeedback","feedback","gradeexplanation","countwords","min","startSessionBtn","addEventListener","startSession","bind","stopSessionBtn","stopSession","retrySessionBtn","resetSession","autocreateresponseCheckbox","cancelStartSessionBtn","abort","nextbutton","on","container","timelimit","find","show","progressTimer","height","timeLimit","onFinish","trigger","toggleMicBtn","toggleMute","voice","includes","document","getElementById","uniqueid","hiddenaudio","querySelector","cantChatWarning","loadingIndicator","aiAvatarSection","chatActiveMessage","conversationSection","messagesContainer","micButtonContainer","micIcon","micWaveformCanvas","micSelect","finishMessage","resultscontainer","resultscontent","autocreateresponseToggle","clicktosendlabel","mainWrapper","getContext","populateMicList","scrollToBottom","firstElementChild","scrollIntoViewIfNeeded","scrollTop","scrollHeight","scrollMicButtonIntoView","scrollIntoView","behavior","block","classList","toggle","endScreen","showitemreview","allowretry","mics","querySelectorAll","noshowmics","parentElement","disabled","orderedItems","idMap","Map","previousMap","currentItem","set","previous_item_id","get","innerHTML","message","messageDiv","createElement","className","usertype","contentDiv","headerDiv","pictureDiv","avatarimage","M","cfg","themerev","appendChild","textDiv","textContent","has","loaderDiv","remove","add","setDataInputBuffer","value","source","twoletterlang","language","substr","RTCPeerConnection","iceServers","urls","createDataChannel","onmessage","e","data","lines","filter","Boolean","line","handleRTCEvent","call","parse","err","onopen","audiochatinstructions","updateinstructions","loadFragment","contextid","itemid","studentsubmission","replace","audiochatgradeinstructions","sendEvent","instructions","input_audio_format","input_audio_transcription","model","speed","modalities","response","ontrack","event","srcObject","streams","navigator","mediaDevices","getUserMedia","audio","getTracks","track","enabled","addTrack","createOffer","offerToReceiveAudio","offer","setLocalDescription","waitForIceGathering","fetch","wwwroot","method","headers","body","localDescription","sdp","signal","sdpResponse","ok","text","answer","setRemoteDescription","name","close","stop","sendGradingRequest","gradingInstructions","responsedata","conversation","metadata","tag","max_output_tokens","temperature","clear","releaseMicResources","setTimeout","showResults","closeDataChannel","tdata","stars","maxStars","isNaN","filledStars","filled","render","then","html","timeout","Promise","resolve","timer","checkState","iceGatheringState","clearTimeout","removeEventListener","obj","readyState","msg","jsonresponse","output","msgresponse_id","response_id","msgitem_id","item_id","stack","events","time","Date","now","toString","role","enableMic","delta","transcript","delete","disableMic","initializeMicStream","window","AudioContext","webkitAudioContext","createAnalyser","fftSize","bufferLength","frequencyBinCount","Uint8Array","createMediaStreamSource","success","disconnect","cancelAnimationFrame","clearRect","width","attempts","clearInterval","maxAttempts","setInterval","connect","drawWave","sender","getSenders","removeTrack","WIDTH","HEIGHT","requestAnimationFrame","getByteTimeDomainData","lineWidth","strokeStyle","beginPath","sliceWidth","x","v","y","moveTo","lineTo","stroke","enumerateDevices","devices","device","kind","select","uniqueMics","seenGroups","mic","groupId","option","deviceId","label","target","switchMic","exact","senders","audioTrack","getAudioTracks","audioSender","replaceTrack"],"mappings":"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","sourcesContent":["define(\n    ['jquery', 'core/log', 'mod_minilesson/definitions',\n        'mod_minilesson/ttrecorder', 'core/templates', 'core/str', 'core/fragment'],\n    function ($, log, def, ttrecorder, templates, str, Fragment) {\n        \"use strict\"; // jshint ;_;\n\n        /*\n    This file is to manage the free speaking item type\n            */\n\n          log.debug('MiniLesson AudioChat: initialising');\n\n        return {\n            autocreateresponse : false, // If true, the response will be created automatically\n            gradingrequesttag: \"gradingrequest\", // Tag for the grading request\n            gradingData: false, // Data returne by the grading request\n            strings: {},\n            controls: {}, // Controls for the item\n            itemdata: {}, // Item data for the item\n            index: 0, // Index of the item in the quiz\n            quizhelper: {}, // Quiz helper for the item\n            pc: null,\n            dc: null,\n            cantChat: false,\n            audiochat_voice: \"alloy\", // Default voice for the AI\n            isSessionStarted: false,\n            isSessionStopped: false,\n            isSessionActive: false,\n            isLoading: false,\n            isMicActive: false,\n            isMicInitialized: false, // True when getUserMedia has successfully run once\n            loadingMessages: new Set(), // To track messages that are currently loading,\n            audioContext: null,\n            analyser: null,\n            dataArray: null,\n            sourceNode: null,\n            mediaStream: null,\n            animationFrameId: null,\n            canvasCtx: null,\n            eventlogs: [],\n            items: {},\n            responses: {},\n            abortcontroller: new AbortController(),\n            datainputbuffer: false,\n            inputBufferInterval: null,\n            //Turn detection - semantic is good for native speakers, but awful for language learners\n            // time based we give 3.5s of silence detection before posting\n            semantic_vad: {\n                type: \"semantic_vad\",\n                eagerness: \"low\",\n            },\n\n            timebased_vad: {\n                type: \"server_vad\",\n                silence_duration_ms: 3500,\n                create_response: true, // true = it will turn on and off the mic and respond\n                interrupt_response: true, // only in conversation mode\n                threshold: 0.3,\n                //  \"prefix_padding_ms\": 300,\n            },\n\n            // For making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                this.autocreateresponse = itemdata.audiochat_autoresponse || false;\n                log.debug('itemdata', itemdata);\n                this.quizhelper = quizhelper;\n                this.index = index;\n                this.cantChat = !itemdata.canchat;\n                this.init_strings();\n                this.init_controls(quizhelper, itemdata);\n                this.init_voice(itemdata.audiochat_voice);\n                this.register_events(index, itemdata, quizhelper);\n                this.renderUI();\n            },\n\n            init_strings: function () {\n                var self = this;\n                // Set up strings\n                str.get_strings([\n                    { \"key\": \"gradebywordcount\", \"component\": \"mod_minilesson\" },\n                ]).done(function (s) {\n                    var i = 0;\n                    self.strings.gradebywordcount = s[i++];\n                });\n            },\n\n            next_question: function () {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.lessonitemid = self.itemdata.id;\n                stepdata.totalitems = self.itemdata.totalmarks;\n                stepdata.resultsdata = {'items': Object.values(self.items)};\n                // Add grade and other results data\n                stepdata = self.grade_activity(stepdata);\n                stepdata.correctitems = Math.round((self.itemdata.totalmarks * stepdata.grade) / 100);\n                self.quizhelper.do_next(stepdata);\n            },\n\n            count_words: function () {\n                var self = this;\n                var userTranscript = [];\n                Object.values(self.items).forEach(item => {\n                    if (item.content) {\n                        userTranscript.push(item.content);\n                    }\n                });\n                var wordCount = userTranscript.join(' ').split(/\\s+/).length;\n                return wordCount;\n            },\n\n            toggle_autocreate_response: function () {\n                var self = this;\n                self.autocreateresponse = !self.autocreateresponse;\n                self.timebased_vad.create_response = self.autocreateresponse;\n                log.debug(\"Autocreate response toggled:\", self.autocreateresponse);\n                self.dc.send(JSON.stringify({\n                    type: \"session.update\",\n                    session: {\n                        turn_detection: self.timebased_vad,\n                    }\n                }));\n            },\n\n            grade_activity: function (stepdata) {\n                //loop through items and form a complete user transcript\n                var self = this;\n\n                //count words in the transcript\n                var wordcount = self.count_words();\n\n                if (self.gradingData && self.gradingData.score !== undefined) {\n                    log.debug(\"Using grading data from AI:\", self.gradingData);\n                    // If grading data is available, use it\n                    stepdata.grade = self.gradingData.score;\n\n                    //If target word count is greater then 0, we lower the grade if it is lower then that target word count\n                    if (typeof stepdata.grade === 'number' &&\n                        typeof wordcount === 'number' &&\n                        self.itemdata.targetwordcount > 0 &&\n                         wordcount < self.itemdata.targetwordcount) {\n                        stepdata.grade = Math.round(stepdata.grade * (wordcount / self.itemdata.targetwordcount));\n                    }\n\n\n                    stepdata.resultsdata.aifeedback = self.gradingData.feedback || \"\";\n                    stepdata.resultsdata.gradeexplanation = self.gradingData.gradeexplanation || \"\";\n                } else {\n                    //Otherwise we default to counting words\n                    log.debug(\"No grading data from AI: counting words\", self.gradingData);\n                    stepdata.resultsdata.gradeexplanation = self.strings.gradebywordcount;\n                    if (self.itemdata.countwords === false || self.itemdata.targetwordcount === 0) {\n                        stepdata.grade =  100;\n                    }\n\n\n\n                    // Calculate grade based on word count\n                    stepdata.grade = Math.min(wordcount / self.itemdata.targetwordcount, 1) * 100;\n                }\n\n                // return stepdata\n                return stepdata;\n\n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n\n                var self = this;\n\n                // Event Listeners\n                self.controls.startSessionBtn.addEventListener(\"click\", self.startSession.bind(this));\n                self.controls.stopSessionBtn.addEventListener(\"click\", self.stopSession.bind(this));\n                self.controls.retrySessionBtn.addEventListener(\"click\", self.resetSession.bind(this));\n                self.controls.autocreateresponseCheckbox.addEventListener(\"change\", self.toggle_autocreate_response.bind(self));\n                self.controls.cancelStartSessionBtn.addEventListener(\"click\", () => {\n                    log.debug(\"Cancelling session start\");\n                    self.abortcontroller.abort();\n                    self.abortcontroller = new AbortController();\n                });\n\n                $(self.controls.nextbutton).on('click', function () {\n                    self.next_question();\n                });\n\n                var container = $(self.controls.container);\n                container.on('showElement', () => {\n                    if (itemdata.timelimit > 0) {\n                        container.find(\".progress-container\").show();\n                        container.find(\".progress-container i\").show();\n                        container.find(\".progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                nextbutton.trigger('click');\n                            }\n                        });\n                    }\n                });\n\n\n                if (self.controls.toggleMicBtn) {\n                    self.controls.toggleMicBtn.addEventListener(\"click\", self.toggleMute.bind(self))\n                }\n            },\n\n            init_voice: function (voice) {\n                var self = this;\n                var voices = ['alloy', 'ash', 'ballad', 'coral', 'echo', 'sage', 'shimmer', 'verse', 'marin', 'cedar'];\n                if (voice && voices.includes(voice)) {\n                    self.audiochat_voice = voice;\n                } else {\n                    self.audiochat_voice = 'alloy'; // Default voice\n                }\n                log.debug(\"AudioChat voice set to:\", this.audiochat_voice);\n            },\n\n            init_controls: async function () {\n                var self = this;\n                var container = document.getElementById(self.itemdata.uniqueid + \"_container\");\n                self.controls = {\n                    hiddenaudio: container.querySelector('.ml_ac_hiddenaudio'),\n                    nextbutton: container.querySelector('.minilesson_nextbutton'),\n                    cantChatWarning: container.querySelector(\".ml_ac_cantchat\"),\n                    startSessionBtn: container.querySelector(\".ml_ac_start-session-btn\"),\n                    stopSessionBtn: container.querySelector(\".ml_ac_stop-session-btn\"),\n                    loadingIndicator: container.querySelector(\".ml_ac_loading-indicator\"),\n                    aiAvatarSection: container.querySelector(\".ml_ac_ai-avatar-section\"),\n                    chatActiveMessage: container.querySelector(\".ml_ac_chat-active-message\"),\n                    conversationSection: container.querySelector(\".ml_ac_conversation-section\"),\n                    messagesContainer: container.querySelector(\".ml_ac_messages-container\"),\n                    micButtonContainer: container.querySelector(\".mic-button-container\"),\n                    toggleMicBtn: container.querySelector(\".toggle-mic-btn\"),\n                    micIcon: container.querySelector(\".mic-icon\"),\n                    micWaveformCanvas: container.querySelector(\".mic-waveform-canvas\"),\n                    micSelect: container.querySelector('.ml_ac_micselect'),\n                    finishMessage: container.querySelector('.ml_ac_finished-message'),\n                    retrySessionBtn: container.querySelector('.ml_ac_retrybtn'),\n                    cancelStartSessionBtn: container.querySelector('.ml_ac_cancel-start-session-btn'),\n                    autocreateresponseCheckbox: container.querySelector('.ml_ac_autoresponse-checkbox'),\n                    resultscontainer: container.querySelector('.ml_ac_results_container'),\n                    resultscontent: container.querySelector('.ml_ac_results_content'),\n                    autocreateresponseToggle: container.querySelector('.ml_ac_autoresponse-toggle'),\n\n                    clicktosendlabel: container.querySelector('.ml_ac_clicktosend'),\n                    mainWrapper: container.querySelector('.minilesson_audiochat_box .ml_unique_mainwrapper'),\n                };\n                self.canvasCtx = !self.controls.micWaveformCanvas ? null :\n                    self.controls.micWaveformCanvas.getContext(\"2d\");\n\n                // Initial render\n                await self.populateMicList();\n\n            },\n\n            scrollToBottom: function () {\n                var self = this;\n                self.controls.conversationSection.firstElementChild.scrollIntoViewIfNeeded();\n                self.controls.conversationSection.firstElementChild.scrollTop = self.controls.conversationSection.firstElementChild.scrollHeight;\n            },\n\n            scrollMicButtonIntoView: function () {\n                var self = this;\n                if (self.controls.micButtonContainer) {\n                    self.controls.micButtonContainer.scrollIntoView({behavior: \"smooth\", block: \"center\"});\n                }\n            },\n\n            renderUI: function () {\n                var self = this;\n                // Session Controls\n                self.controls.startSessionBtn.classList.toggle(\"hidden\", self.isSessionActive || self.isLoading || self.isSessionStarted || self.cantChat);\n                self.controls.cantChatWarning.classList.toggle(\"hidden\", !self.cantChat);\n                self.controls.loadingIndicator.classList.toggle(\"hidden\", !self.isLoading);\n                self.controls.stopSessionBtn.classList.toggle(\"hidden\", !self.isSessionActive);\n                self.controls.micButtonContainer.classList.toggle(\"hidden\", !self.isSessionActive);\n                var endScreen = self.isSessionStarted && self.isSessionStopped;\n                self.controls.resultscontainer.classList.toggle(\"hidden\", !endScreen && self.quizhelper.showitemreview);\n                self.controls.finishMessage.classList.toggle(\"hidden\", !endScreen);\n                self.controls.retrySessionBtn.classList.toggle(\"hidden\", !endScreen && self.itemdata.allowretry);\n                // We no longer show the cancel button. It does not work after changes we made to icegathering.\n                // If we set abortcontroller.signal to work with it will work, but it is complex\n                //self.controls.cancelStartSessionBtn.classList.toggle('hidden', !(self.isLoading && !self.isSessionActive));\n                self.controls.autocreateresponseToggle.classList.toggle(\"hidden\", !self.isSessionActive);\n                if (self.controls.micSelect) {\n                    //how many options are in micselect\n                    var mics = self.controls.micSelect.querySelectorAll('option');\n                    var noshowmics = mics.length < 2;\n                    self.controls.micSelect.parentElement.classList.toggle(\n                        'hidden',\n                        noshowmics || self.isSessionStarted || self.isLoading || self.controls.micSelect.disabled\n                    );\n                }\n\n                var orderedItems = [];\n                var idMap = new Map();\n                var previousMap = new Map();\n                var currentItem;\n                Object.values(self.items).forEach(item => {\n                    idMap.set(item.id, item);\n                    previousMap.set(item.previous_item_id, item);\n                    if (item.previous_item_id === null) {\n                        currentItem = item;\n                    }\n                });\n                while (currentItem) {\n                    orderedItems.push(currentItem);\n                    currentItem = previousMap.get(currentItem.id);\n                }\n\n                // The cute dog avatar\n                self.controls.aiAvatarSection.classList.toggle(\"hidden\", self.isSessionStarted || self.isSessionActive || self.isSessionStopped);\n                //The chat session is active message\n                self.controls.chatActiveMessage.classList.toggle(\"hidden\", !self.isSessionActive);\n                // The conversation area\n                self.controls.conversationSection.classList.toggle(\"hidden\", !(self.isSessionActive || self.isSessionStopped));\n\n                // Render messages\n                self.controls.messagesContainer.innerHTML = \"\"; // Clear existing messages\n\n                orderedItems.forEach((message) => {\n                    if (!message.content) {\n                        return;\n                    }\n                    var messageDiv = document.createElement(\"div\");\n                    messageDiv.className = `flex ${message.usertype === \"user\" ? \"justify-end\" : \"justify-start\"} ml_unique_ordered_message_${message.usertype === \"user\" ? \"user\" : \"assistant\"}`;\n\n                    var contentDiv = document.createElement(\"div\");\n                    contentDiv.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${\n                            message.usertype === \"user\" ? \"bg-blue-500 text-white\" : \"bg-gray-200 text-gray-800\"\n                    } ml_unique_content_${\n                        message.usertype === \"user\" ? \"user\" : \"assistant\"\n                    }`;\n\n                    var headerDiv = document.createElement(\"div\");\n                    headerDiv.className = \"flex items-center text-xs font-medium mb-1 ml_unique_headerdiv\";\n                    if (message.usertype === \"assistant\") {\n                        var pictureDiv = document.createElement('div');\n                        pictureDiv.innerHTML = `\n                            <img src=\"${self.itemdata.avatarimage}?themerev=${M.cfg.themerev}\"\n                            alt=\"AI Assistant\" class=\"mr-2 rounded-circle shadow-lg ml_unique_assistant_img\">\n                            `;\n                        headerDiv.appendChild(pictureDiv);\n                    }\n                    headerDiv.innerHTML += message.usertype === \"user\" ? \"Student\" : \"AI Assistant\";\n                    contentDiv.appendChild(headerDiv);\n\n                    var textDiv = document.createElement(\"div\");\n                    textDiv.className = \"text-sm ml_unique_textsmall\";\n                    textDiv.textContent = message.content;\n                    contentDiv.appendChild(textDiv);\n\n                    if (self.loadingMessages.has(message.id)) {\n                        var loaderDiv = document.createElement(\"div\");\n                        loaderDiv.className = \"flex items-center space-x-1 py-1 message-loader ml_unique_loadingmessage\";\n                        loaderDiv.innerHTML = `\n                            <div class=\"flex space-x-1 ml_unique_loader\">\n                                <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                                <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                                <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                            </div>\n                            <span class=\"text-xs opacity-70 ml_unique_loader_text\">AI is thinking...</span>\n                        `;\n                        contentDiv.appendChild(loaderDiv);\n                    }\n\n                    messageDiv.appendChild(contentDiv);\n                    self.controls.messagesContainer.appendChild(messageDiv);\n                });\n\n                self.scrollToBottom();\n               // self.scrollMicButtonIntoView();\n\n                // Update mic button container and canvas visibility\n                if (self.controls.micButtonContainer) {\n                    self.controls.micButtonContainer.classList.toggle(\"active\", self.isMicActive);\n                    self.controls.micButtonContainer.classList.toggle(\"bg-blue-500\", self.isMicActive); // Active background color\n                    self.controls.micButtonContainer.classList.toggle(\"text-white\", self.isMicActive); // Active icon color\n                    self.controls.micButtonContainer.classList.toggle(\"bg-gray-200\", !self.isMicActive); // Inactive background color\n                    self.controls.micButtonContainer.classList.toggle(\"text-gray-800\", !self.isMicActive); // Inactive icon color\n                }\n\n\n                if (self.controls.micWaveformCanvas) {\n                    self.controls.micWaveformCanvas.classList.toggle(\"active\", self.isMicActive);\n                }\n\n                if (self.controls.micIcon) {\n                    // Set icon based on mic state\n                    self.controls.micIcon.innerHTML = self.isMicActive\n                    ? `<rect id=\"primary\" x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"2\" style=\"fill: rgb(0, 0, 0);\"></rect>` // Mic On icon\n                    : `<path id=\"secondary\" d=\"M12,15h0a4,4,0,0,1-4-4V7a4,4,0,0,1,4-4h0a4,4,0,0,1,4,4v4A4,4,0,0,1,12,15Z\" style=\"fill: rgb(44, 169, 188); stroke-width: 2;\"></path><path id=\"primary\" d=\"M18.24,16A8,8,0,0,1,5.76,16\" style=\"fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;\"></path><path id=\"primary-2\" data-name=\"primary\" d=\"M12,19v2m4-10V7a4,4,0,0,0-4-4h0A4,4,0,0,0,8,7v4a4,4,0,0,0,4,4h0A4,4,0,0,0,16,11Z\" style=\"fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;\"></path>`; // Mic Off icon\n                }\n\n                //show or not show clicktosendlabel\n                if (self.isMicActive && !self.autocreateresponse) {\n                    self.controls.clicktosendlabel.classList.remove(\"hidden\");\n                } else {\n                    self.controls.clicktosendlabel.classList.add(\"hidden\");\n                }\n\n            },\n\n            //setter for datainputbuffer\n            setDataInputBuffer: function (value, source) {\n                var self = this;\n                self.datainputbuffer = value;\n                log.debug(\"Data in input buffer set to:\", value);\n                log.debug(\"Data input buffer set source:\", source);\n            },\n\n            resetSession: function () {\n                log.debug(\"reset  session\");\n                var self = this;\n                self.isLoading = false;\n                self.isSessionActive = false;\n                self.isSessionStopped = false;\n                self.isSessionStarted = false;\n                self.renderUI();\n            },\n\n            startSession: async function () {\n                var self = this;\n                var twoletterlang = self.itemdata.language.substr(0, 2);\n                var hiddenaudio = self.controls.hiddenaudio;\n                log.debug(\"Session starting\");\n                self.isLoading = true;\n                self.items = [];\n                self.renderUI();\n                // Open the RTC PeerConnection via Stun and ICE servers\n                log.debug(\"Opening peer connection...\");\n                self.pc = new RTCPeerConnection({\n                    iceServers: [{\n                        urls: \"stun:stun.l.google.com:19302\"\n                    }]\n                });\n\n                // Create a DataChannel for sending events (text and audio)\n                log.debug(\"creating data channel...\");\n                self.dc = self.pc.createDataChannel(\"oai-events\");\n\n                // Handle incoming messages on the DataChannel\n                self.dc.onmessage = (e) => {\n                    self.eventlogs.push(e.data);\n                    //log.debug(\"DataChannel message:\", e.data);\n                    try {\n                        var lines = e.data.split(\"\\n\").filter(Boolean);\n                        for (var line of lines) {\n                            self.handleRTCEvent.call(self, JSON.parse(line));\n                        }\n                    } catch (err) {\n                        log.debug(\"Failed to parse\", err);\n                    }\n                };\n                self.dc.onopen = () => {\n                    log.debug(\"DataChannel open\");\n\n                    //Turn detection - semantic is good for native speakers, but awful for language learners\n                    // time based we give 1.5s of silence detection before posting\n                    var semantic_vad = {\n                        type: \"semantic_vad\",\n                        eagerness: \"low\",\n                    };\n\n                    // Set the auto turn detection, or manual submit flag\n                    self.timebased_vad.create_response = self.autocreateresponse;\n\n                    log.debug(self.itemdata.audiochatinstructions);\n                    var updateinstructions = self.itemdata.audiochatinstructions;\n                    Fragment.loadFragment(\n                        'mod_minilesson',\n                        'audiochat_fetchstudentsubmission',\n                        M.cfg.contextid,\n                        {\n                            itemid: self.itemdata.id\n                        }\n                    ).done(function (studentsubmission) {\n                        log.debug(\"Loaded audio chat studentsubmission:\", studentsubmission);\n                        if (studentsubmission) {\n                            // Replace \"{student submission}\" placeholder with actual submission\n                            updateinstructions = updateinstructions.replace('{student submission}', studentsubmission);\n\n                            // Replace student submission in grade instructions too\n                            self.itemdata.audiochatgradeinstructions = self.itemdata.audiochatgradeinstructions.replace('{student submission}', studentsubmission);\n\n                            // Save student submission in itemdata for later use\n                            self.itemdata.studentsubmission = studentsubmission;\n                        }\n\n                        self.sendEvent({\n                            type: \"session.update\",\n                            session: {\n                                instructions: updateinstructions,\n                                input_audio_format: \"pcm16\", // Ensure correct audio encoding\n                                input_audio_transcription: {\n                                    language: twoletterlang,\n                                    model: \"whisper-1\" // \"gpt-4o-mini-transcribe\"  // Use a transcription model\n                                },\n                                turn_detection: self.timebased_vad,\n                                speed: 0.9,\n                                voice: self.audiochat_voice,\n                                modalities: [\"text\", \"audio\"],\n                            }\n                        });\n\n                        // Send the first message to tell AI to say something\n                        // the response create function overrides the session instructions, so we need to double up here\n                        var firstmessageinstructions =  \"Please introduce yourself to the student and explain todays topic.\";\n                            self.sendEvent({\n                                type: \"response.create\",\n                                response: {\n                                    modalities: [\"audio\", \"text\"],\n                                    instructions:  updateinstructions + \" \" + firstmessageinstructions,\n                                    voice: self.audiochat_voice\n                                }\n                            });\n                    });\n                };\n\n                // Set up the audio element to play incoming audio.\n                self.pc.ontrack = (event) => {\n                    hiddenaudio.srcObject = event.streams[0];\n                };\n\n                // Set up the Mic stream.\n                self.mediaStream = await navigator.mediaDevices.getUserMedia({audio: true});\n                self.mediaStream.getTracks().forEach((track) => {\n                    track.enabled = false;\n                    self.pc.addTrack(track, self.mediaStream);\n                });\n\n                // Set up the RTC Connection by bouncing our request off the Moodle server\n                var offer = await self.pc.createOffer({\n                    offerToReceiveAudio: true\n                });\n                await self.pc.setLocalDescription(offer);\n                // Search for server candidates for relaying messages, may take 15s\n                await self.waitForIceGathering(self.pc);\n\n                try {\n                    var sdpResponse = await fetch(M.cfg.wwwroot + \"/mod/minilesson/openairtc.php\", {\n                        method: \"POST\",\n                        headers: {\n                            \"Content-Type\": \"application/sdp\"\n                        },\n                        body: self.pc.localDescription.sdp,\n                        signal: self.abortcontroller.signal\n                    });\n                    if (!sdpResponse.ok) {\n                        log.debug(\"Failed /rtc:\", await sdpResponse.text());\n                        return;\n                    }\n                    log.debug(\"Received SDP answer from server\");\n                    var answer = await sdpResponse.text();\n                    log.debug(answer);\n                    await self.pc.setRemoteDescription({\n                        type: \"answer\",\n                        sdp: answer\n                    });\n                    log.debug(\"Session started\");\n                } catch (e) {\n                    if (e.name === 'AbortError') {\n                        log.debug(\"Session start aborted by user.\");\n                        // Reset UI and state as needed\n                        self.isLoading = false;\n                        self.renderUI();\n                        return;\n                    }\n\n                    // Close data channel if open\n                    if (self.dc) {\n                        self.dc.close();\n                    }\n                    // Close peer connection if open\n                    if (self.pc) {\n                        self.pc.close();\n                    }\n                    if (self.mediaStream) {\n                        self.mediaStream.getTracks().forEach((track) => track.stop());\n                    }\n                    self.isLoading = false;\n                    self.renderUI();\n                    return;\n                }\n\n                self.isLoading = false;\n                self.isSessionActive = true;\n                self.isSessionStarted = true;\n                self.isSessionStopped = false;\n                self.renderUI();\n            },\n\n            sendGradingRequest: function () {\n                var self = this;\n                // Send a final message to tell AI to grade the session and give feedback\n                var gradingInstructions = \"Please provide a percentage score for the session, an explanation of the score (for teachers), and feedback (for the student). \" +\n                     self.itemdata.audiochatgradeinstructions +\n                    \"Return the response as JSON in the format: {\\\"score\\\": \\\"the score  ( 0-100 ) \\\", \\\"gradeexplanation\\\": \\\"the explanation\\\", \\\"feedback\\\": \\\"the feedback\\\"}.\";\n\n                var responsedata = {\n                    // The response is out of band and not be added to the default conversation\n                    conversation: \"none\",\n                    modalities: [\"text\"],\n                    instructions: gradingInstructions,\n                    // Add the gradingrequest tag to make handltertc life easier\n                    metadata: { tag: self.gradingrequesttag},\n                    max_output_tokens: 500, // Keeps it tight\n                    temperature: 0.6, // Optional: makes grading more deterministic\n                };\n\n                //If we wanted to reutrn an audio response (but lets not)\n                //responsedata.voice = self.audiochat_voice;\n\n                self.sendEvent({\n                    type: \"response.create\",\n                    response: responsedata,\n                });\n            },\n\n            stopSession: function () {\n                var self = this;\n\n                log.debug(\"Session stopping...\");\n                self.isSessionActive = false;\n                self.isSessionStopped = true;\n                self.loadingMessages.clear();\n\n                // Release mic resources when session ends\n                self.releaseMicResources();\n                self.renderUI();\n\n                // request grading information\n                // after that response, we will close the data channel and peer connection\n                //but shut it down after 2s just in case there is an error or something\n                if (self.itemdata.audiochatgradeinstructions && self.itemdata.audiochatgradeinstructions !== \"\") {\n                    self.sendGradingRequest();\n\n                    //add a spinner to the results content\n                    //if we are not showing item review we do not need this, but in that case it is hidden anyway\n                    self.controls.resultscontent.innerHTML = `<i class =\"fa fa-spinner fa-spin fa-2x\"></i>`;\n\n                    setTimeout(() => {\n                        //now show the results content if that is what we are doing\n                        if (self.quizhelper.showitemreview) {\n                            self.showResults();\n                        }\n                        log.debug(\"Closing session resources...\");\n                        self.closeDataChannel();\n                    }, 7000);\n                } else {\n                    log.debug(\"Closing session resources...\");\n                    self.closeDataChannel();\n                }\n                log.debug(\"Session stopped\");\n            },\n\n            closeDataChannel: function () {\n                var self = this;\n                // Tidy up the data channel and peer connection\n                if (typeof self.dc !== 'undefined' && self.dc) {\n                    self.dc.close();\n                    self.dc = null;\n                }\n                if (typeof self.pc !== 'undefined' && self.pc) {\n                    self.pc.close();\n                    self.pc = null;\n                }\n            },\n\n            showResults: function () {\n                var self = this;\n                var tdata = {};\n                tdata.resultsdata = {'items': Object.values(self.items)};\n                // Add grade and other results data\n                tdata = self.grade_activity(tdata);\n\n                //calculate stars from grade\n                const stars = [];\n                const maxStars = 5;\n                // if tdata grade is NAn or undefined, set it to 0\n                if (typeof tdata.grade === 'undefined' || isNaN(tdata.grade) || tdata.grade === null || tdata.grade === \"\") {\n                    tdata.grade = 0;\n                }\n\n                const filledStars = Math.round((tdata.grade / 100) * maxStars);\n                for (let i = 0; i < maxStars; i++) {\n                    stars.push({ filled: i < filledStars });\n                }\n                tdata.stars = stars;\n\n                templates.render('mod_minilesson/audiochatimmediatefeedback', tdata).then(\n                    function (html, js) {\n                        self.controls.resultscontent.innerHTML = html;\n                    }\n                );\n            },\n\n            waitForIceGathering: function (pc, timeout = 15000) {\n                return new Promise((resolve) => {\n                    let timer;\n\n                    function checkState()\n                    {\n                        if (pc.iceGatheringState === \"complete\") {\n                            clearTimeout(timer);\n                            pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                            resolve();\n                        }\n                    }\n\n                    pc.addEventListener(\"icegatheringstatechange\", checkState);\n\n                    // Timeout to resolve with current state\n                    timer = setTimeout(() => {\n                        pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                        resolve(); // Resolve with as many candidates as gathered so far\n                    }, timeout);\n                });\n            },\n\n            sendEvent: function (obj) {\n                var self = this;\n                if (self.dc && self.dc.readyState === \"open\") {\n                    self.dc.send(JSON.stringify(obj));\n                }\n            },\n\n            handleRTCEvent: function (msg) {\n                var self = this;\n                log.debug(\"Received event:\");\n\n                // Check if its the final grading message, which we don't want to enter \"items\"\n                if (msg.type === \"response.done\" &&\n                    msg.response.metadata?.tag === self.gradingrequesttag) {\n                    // Check if the response corresponds to the grading event\n                    log.debug(\"It is a grading event:\");\n                    try {\n                        var jsonresponse = msg.response.output[0].content[0].text;\n                        if (!jsonresponse || jsonresponse === \"\") {\n                            log.debug(\"No valid grading data received .. msg is ..\");\n                            log.debug(msg);\n                            self.closeDataChannel();\n                            return;\n                        }\n\n                        self.gradingData = JSON.parse(jsonresponse);\n                        log.debug(\"Grading and Feedback:\", self.gradingData);\n                    } catch (err) {\n                        self.gradingData = false;\n                        log.debug(\"Failed to parse grading feedback:\", err);\n                        log.debug(jsonresponse);\n                    }\n                        return;\n                }\n\n                // log.debug(msg);\n                var msgresponse_id = msg.response ? msg.response.id : msg.response_id;\n                var msgitem_id = msg.item ? msg.item.id : msg.item_id;\n                if (msgresponse_id) {\n                    self.responses[msgresponse_id] = self.responses[msgresponse_id] || {\n                        id: msgresponse_id,\n                        itemid: msgitem_id,\n                        stack: []\n                    };\n                }\n                if (msgitem_id) {\n                    if (typeof self.items[msgitem_id] === 'undefined') {\n                        self.scrollToBottom();\n                    }\n                    self.items[msgitem_id] = self.items[msgitem_id] || {\n                        id: msgitem_id,\n                        events: [],\n                        responses: null,\n                        content: ''\n                    };\n                    if (msgresponse_id) {\n                        self.items[msgitem_id].responses = self.responses[msgresponse_id];\n                    }\n                }\n\n                msg.time = Date.now().toString();\n\n                switch (msg.type) {\n                    case \"response.created\": {\n        /*```\n    {\n    \"type\": \"response.created\",\n    \"event_id\": \"event_Bzbmm1vOdUpYK5LcKMPAU\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"in_progress\",\n        \"status_details\": null,\n        \"output\": [],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": null,\n        \"metadata\": null\n    }\n    }\n        ```*/\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_item.added\": {\n        /*```\n    {\n    \"type\": \"response.output_item.added\",\n    \"event_id\": \"event_BzbmnNUVJeqok4KqSLSVl\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.created\": {\n        /*```\n    {\n    \"type\": \"conversation.item.created\",\n    \"event_id\": \"event_BzbmnttqDhvU3h2he1tK7\",\n    \"previous_item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n    }\n        ```*/\n                        self.items[msg.item.id].previous_item_id = msg.previous_item_id;\n                        self.items[msg.item.id].usertype = msg.item.role;\n                        self.items[msg.item.id].events.push(msg);\n                        if (msg.item.role === 'assistant') {\n                            self.loadingMessages.add(msgitem_id);\n                        }\n                        break;\n                    }\n                    case \"response.content_part.added\": {\n        /*```\n    {\n    \"type\": \"response.content_part.added\",\n    \"event_id\": \"event_Bzbmn7lA1i7fOfFq8ju3F\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"\"\n    }\n    }\n        ```*/\n                        self.enableMic();// Let's enable mic\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.audio_transcript.delta\": {\n        /*```\n    {\n    \"type\": \"response.audio_transcript.delta\",\n    \"event_id\": \"event_BzbmnpxUmLA0zAnR5mRy3\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"delta\": \"Hi\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.items[msg.item_id].content += msg.delta;\n                        break;\n                    }\n\n                    case \"output_audio_buffer.cleared\": {\n        /*```\n    {\n    \"type\": \"output_audio_buffer.cleared\",\n    \"event_id\": \"event_f7273193069b4938\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.audio.done\": {\n        /*```\n    {\n    \"type\": \"response.audio.done\",\n    \"event_id\": \"event_Bzbmn7aEtTnprkzqE9i6X\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.audio_transcript.done\": {\n        /*```\n    {\n    \"type\": \"response.audio_transcript.done\",\n    \"event_id\": \"event_BzbmnNGRs7797nz1Qh7em\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.items[msg.item_id].content = msg.transcript;\n                        break;\n                    }\n                    case \"response.content_part.done\": {\n        /*```\n    {\n    \"type\": \"response.content_part.done\",\n    \"event_id\": \"event_BzbmnYdAvAKMU7ti311Vj\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_item.done\": {\n        /*```\n    {\n    \"type\": \"response.output_item.done\",\n    \"event_id\": \"event_BzbmnhD5RdLxAOnko94Z1\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"incomplete\",\n        \"role\": \"assistant\",\n        \"content\": [\n            {\n                \"type\": \"audio\",\n                \"transcript\": \"Hi! How are you today? What did you do today?\"\n            }\n        ]\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.loadingMessages.delete(msg.item.id);\n                        break;\n                    }\n                    case \"response.done\": {\n        /*```\n    {\n    \"type\": \"response.done\",\n    \"event_id\": \"event_Bzbmn8bIaGB59d6qG7LQS\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"cancelled\",\n        \"status_details\": {\n            \"type\": \"cancelled\",\n            \"reason\": \"turn_detected\"\n        },\n        \"output\": [\n            {\n                \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n                \"object\": \"realtime.item\",\n                \"type\": \"message\",\n                \"status\": \"incomplete\",\n                \"role\": \"assistant\",\n                \"content\": [\n                    {\n                        \"type\": \"audio\",\n                        \"transcript\": \"Hi! How are you today? What did you do today?\"\n                    }\n                ]\n            }\n        ],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": {\n            \"total_tokens\": 170,\n            \"input_tokens\": 94,\n            \"output_tokens\": 76,\n            \"input_token_details\": {\n                \"text_tokens\": 87,\n                \"audio_tokens\": 7,\n                \"cached_tokens\": 0,\n                \"cached_tokens_details\": {\n                    \"text_tokens\": 0,\n                    \"audio_tokens\": 0\n                }\n            },\n            \"output_token_details\": {\n                \"text_tokens\": 23,\n                \"audio_tokens\": 53\n            }\n        },\n        \"metadata\": null\n    }\n    }\n        ```*/\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"output_audio_buffer.stopped\": {\n        /*```\n    {\n    \"type\":\"output_audio_buffer.stopped\",\n    \"event_id\":\"event_0ebd8495b5a945e5\",\n    \"response_id\":\"resp_C17PJbWxcyg7tgQBVTAaL\"\n    }\n        ```*/\n                        if (!self.isMicActive) {\n                            self.toggleMute();\n                        }\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.truncated\": {\n        /*```\n    {\n    \"type\": \"conversation.item.truncated\",\n    \"event_id\": \"event_BzbmnGqfHdq1hy2Wr2fnA\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"content_index\": 0,\n    \"audio_end_ms\": 261\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    // User events.\n                    case \"input_audio_buffer.speech_started\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.speech_started\",\n    \"event_id\": \"event_Bzbmm9FJ5oCTmCpng9tem\",\n    \"audio_start_ms\": 820,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/\n                        log.debug(\"Input audio buffer speech started\");\n                        self.setDataInputBuffer(true, 'audiobufferstarted');\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"input_audio_buffer.speech_stopped\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.speech_stopped\",\n    \"event_id\": \"event_BzbmmUgLX2JKgJr1eMx0l\",\n    \"audio_end_ms\": 1568,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/\n                        if (self.isMicActive) {\n                            // Only auto-toggle mic if autocreateresponse is true\n                            if (self.autocreateresponse) {\n                                self.toggleMute();\n                                self.disableMic();\n                            }\n                        }\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"input_audio_buffer.committed\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.committed\",\n    \"event_id\": \"event_BzbmmOICFLRU8vnGEJ6vM\",\n    \"previous_item_id\": null,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/               log.debug(\"Input audio buffer committed\");\n                        self.setDataInputBuffer(false, 'audiobuffercommitted');\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.created\": {\n        /*```\n    {\n    \"type\": \"conversation.item.created\",\n    \"event_id\": \"event_BzbmmiskBBbCkRSHvUVrL\",\n    \"previous_item_id\": null,\n    \"item\": {\n        \"id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"completed\",\n        \"role\": \"user\",\n        \"content\": [\n            {\n                \"type\": \"input_audio\",\n                \"transcript\": null\n            }\n        ]\n    }\n    }\n        ```*/\n                        self.items[msg.item.id].events.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.input_audio_transcription.delta\": {\n        /*```\n    {\n    \"type\": \"conversation.item.input_audio_transcription.delta\",\n    \"event_id\": \"event_BzbmonQuYXZ7QxUCOLlZd\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"delta\": \"Hey.\"\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        self.items[msg.item_id].content += msg.delta;\n                        break;\n                    }\n                    case \"conversation.item.input_audio_transcription.completed\": {\n        /*```\n    {\n    \"type\": \"conversation.item.input_audio_transcription.completed\",\n    \"event_id\": \"event_BzbmotVIjHphgHjViNkZk\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"transcript\": \"Hey.\",\n    \"usage\": {\n        \"type\": \"duration\",\n        \"seconds\": 1\n    }\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        self.items[msg.item_id].content = msg.transcript;\n                        self.loadingMessages.delete(msg.item_id);\n                        break;\n                    }\n                }\n                self.renderUI();\n            },\n\n            enableMic: function () {\n                var self = this;\n                if (self.controls.toggleMicBtn) {\n                    log.debug('Enabling mic');\n                    self.controls.toggleMicBtn.parentElement.classList.remove('disabled');\n                }\n            },\n\n            disableMic: function () {\n                var self = this;\n                if (self.controls.toggleMicBtn) {\n                    log.debug('Disabling mic');\n                    self.controls.toggleMicBtn.parentElement.classList.add('disabled');\n                }\n            },\n\n            initializeMicStream: async function () {\n                var self = this;\n                try {\n                    self.audioContext = new(window.AudioContext || window.webkitAudioContext)();\n                    self.analyser = self.audioContext.createAnalyser();\n                    self.analyser.fftSize = 2048;\n                    const bufferLength = self.analyser.frequencyBinCount;\n                    self.dataArray = new Uint8Array(bufferLength);\n\n                    self.sourceNode = self.audioContext.createMediaStreamSource(self.mediaStream);\n                    // Source is connected/disconnected in toggleMute\n                    self.isMicInitialized = true;\n                    return true;\n                } catch (err) {\n                    log.debug(\"Error accessing microphone:\", err);\n                    self.isMicInitialized = false;\n                    log.debug(\"Could not access microphone. Please ensure it's connected and permissions are granted.\");\n                    return false;\n                }\n            },\n\n            // Toggles mute/unmute state of the mic\n            toggleMute: async function () {\n                var self = this;\n                if (!self.isMicInitialized) {\n                    const success = await self.initializeMicStream();\n                    if (!success) {\n                        return;\n                    } // If initialization failed, stop here\n                }\n\n                if (self.isMicActive) {\n                    // Mute mic: Disconnect source from analyser\n                    if (self.sourceNode && self.analyser) {\n                        self.sourceNode.disconnect(self.analyser);\n                    }\n                    if (self.animationFrameId) {\n                        cancelAnimationFrame(self.animationFrameId);\n                        self.animationFrameId = null;\n                    }\n                    if (self.pc) {\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = false;\n                        });\n                    }\n                    if (self.canvasCtx) {\n                        self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                    }\n                    self.isMicActive = false;\n\n                    // Send response event when mic is disabled and autocreateresponse is false\n                    if (!self.autocreateresponse) {\n                        if (!self.datainputbuffer) {\n                            log.debug(\" sending response.create\");\n                            self.sendEvent({\n                                type: \"response.create\",\n                                response: {\n                                    modalities: [\"audio\", \"text\"],\n                                    instructions: self.itemdata.audiochatinstructions,\n                                    voice: self.audiochat_voice\n                                }\n                            });\n                        } else {\n                            //set a recurring 500ms timeout that will send the response.create event if self.datainputbuffer is false\n                            log.debug(\"Waiting for input audio buffer to commit before sending response.create\");\n                            let attempts = 0;\n                            if (self.inputBufferInterval) {\n                                clearInterval(self.inputBufferInterval);\n                                self.inputBufferInterval = null;\n                            }\n                            const maxAttempts = 3;\n                            self.inputBufferInterval = setInterval(() => {\n                                log.debug(\"Checking input buffer status, attempt:\", attempts);\n                                if (!self.datainputbuffer || attempts >= maxAttempts) {\n                                    clearInterval(self.inputBufferInterval);\n                                    self.setDataInputBuffer(false, 'setInterval:' + attempts);\n                                    log.debug(\" sending response.create\");\n                                    self.sendEvent({\n                                        type: \"response.create\",\n                                        response: {\n                                            modalities: [\"audio\", \"text\"],\n                                            instructions: self.itemdata.audiochatinstructions,\n                                            voice: self.audiochat_voice\n                                        }\n                                    });\n                                }\n                                attempts++;\n                            }, 1500);\n                        }\n                    }\n                } else {\n                    // Unmute mic: Connect source to analyser\n                    if (self.sourceNode && self.analyser) {\n                        self.sourceNode.connect(self.analyser);\n                    }\n\n                    if (self.pc) {\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = true;\n                        });\n                    }\n                    self.isMicActive = true;\n                    self.drawWave(); // Start drawing waveform\n                }\n                self.renderUI(); // Update UI\n            },\n\n            releaseMicResources: function () {\n                var self = this;\n                if (self.animationFrameId) {\n                    cancelAnimationFrame(self.animationFrameId);\n                    self.animationFrameId = null;\n                }\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach((track) => {\n                        if (typeof self.pc !== 'undefined' && self.pc) {\n                            // Find the RTCRtpSender associated with the track\n                            const sender = self.pc.getSenders().find(s => s.track === track);\n                            // Remove the sender if it exists\n                            if (sender) {\n                                self.pc.removeTrack(sender);\n                            }\n                        }\n                        track.stop();\n                    });\n                    self.mediaStream = null;\n                }\n                if (self.sourceNode) {\n                    self.sourceNode.disconnect();\n                    self.sourceNode = null;\n                }\n                if (self.audioContext) {\n                    self.audioContext.close();\n                    self.audioContext = null;\n                }\n                self.isMicActive = false;\n                self.isMicInitialized = false;\n                if (self.canvasCtx) {\n                    self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                }\n                self.renderUI(); // Update UI to show mic inactive\n            },\n\n            drawWave: function () {\n                var self = this;\n                if (!self.canvasCtx || !self.analyser || !self.dataArray || !self.isMicActive) {\n                    self.animationFrameId = null; // Stop animation if conditions are not met\n                    return;\n                }\n\n                const WIDTH = self.controls.micWaveformCanvas.width;\n                const HEIGHT = self.controls.micWaveformCanvas.height;\n\n                self.animationFrameId = requestAnimationFrame(self.drawWave.bind(self));\n\n                self.analyser.getByteTimeDomainData(self.dataArray); // Get waveform data\n\n                self.canvasCtx.clearRect(0, 0, WIDTH, HEIGHT); // Clear previous drawing\n                self.canvasCtx.lineWidth = 2;\n                self.canvasCtx.strokeStyle = \"rgb(255, 255, 255)\"; // White color for wave on blue background\n\n                self.canvasCtx.beginPath();\n\n                const sliceWidth = (WIDTH * 1.0) / self.dataArray.length;\n                let x = 0;\n\n                for (let i = 0; i < self.dataArray.length; i++) {\n                    const v = self.dataArray[i] / 128.0; // Normalize to 0-2\n                    const y = (v * HEIGHT) / 2;\n\n                    if (i === 0) {\n                        self.canvasCtx.moveTo(x, y);\n                    } else {\n                        self.canvasCtx.lineTo(x, y);\n                    }\n\n                    x += sliceWidth;\n                }\n\n                self.canvasCtx.lineTo(WIDTH, HEIGHT / 2);\n                self.canvasCtx.stroke();\n            },\n\n            populateMicList: async function () {\n                var self = this;\n                try {\n                    const devices = await navigator.mediaDevices.enumerateDevices();\n                    const mics = devices.filter(device => device.kind === \"audioinput\");\n                    const select = self.controls.micSelect;\n\n                    select.innerHTML = \"\"; // Clear existing options\n\n                    // Group by groupId to remove duplicates\n                    const uniqueMics = [];\n                    const seenGroups = new Set();\n\n                    for (const mic of mics) {\n                        if (!seenGroups.has(mic.groupId)) {\n                            uniqueMics.push(mic);\n                            seenGroups.add(mic.groupId);\n                        }\n                    }\n\n                    if (uniqueMics.length <= 1) {\n                        select.disabled = true;\n                        return;\n                    }\n                    uniqueMics.forEach((mic, index) => {\n                        const option = document.createElement(\"option\");\n                        option.value = mic.deviceId;\n                        option.text = mic.label || `Microphone ${index + 1}`;\n                        select.appendChild(option);\n                    });\n                    select.parentElement.classList.remove('hidden');\n\n                    // Set change listener\n                    select.addEventListener(\"change\", async(e) => {\n                        const deviceId = e.target.value;\n                        await self.switchMic(deviceId);\n                    });\n                } catch (err) {\n                    log.debug(\"Failed to get microphone list:\", err);\n                }\n            },\n\n            switchMic: async function (deviceId) {\n                var self = this;\n\n                // Stop and release current mic\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach(track => track.stop());\n                }\n\n                try {\n                    // Get new media stream from selected device\n                    self.mediaStream = await navigator.mediaDevices.getUserMedia({\n                        audio: {deviceId: {exact: deviceId}}\n                    });\n\n                    // Replace tracks in PeerConnection\n                    if (self.pc) {\n                        const senders = self.pc.getSenders();\n                        const audioTrack = self.mediaStream.getAudioTracks()[0];\n                        const audioSender = senders.find(sender => sender.track.kind === 'audio');\n                        if (audioSender) {\n                            audioSender.replaceTrack(audioTrack);\n                        }\n                    }\n\n                    // Reinitialize mic stream and waveform\n                    await self.initializeMicStream();\n                    if (self.isMicInitialized) {\n                        self.sourceNode.connect(self.analyser);\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = self.isMicActive;\n                        });\n                        if (self.isMicActive) {\n                            self.drawWave();\n                        }\n                    }\n\n                    log.debug(\"Switched microphone to:\" + deviceId);\n                } catch (err) {\n                    log.debug(\"Failed to switch microphone:\");\n                    log.debug(err);\n                }\n            },\n\n        }; // End of return object.\n    }\n);"],"file":"audiochat.min.js"}