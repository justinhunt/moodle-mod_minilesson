{"version":3,"file":"audiochat.min.js","sources":["../src/audiochat.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions',\n        'mod_minilesson/ttrecorder', 'core/templates', 'core/str'],\nfunction($, log, def, ttrecorder, templates, str) {\n    \"use strict\"; // jshint ;_;\n\n    /*\n    This file is to manage the free speaking item type\n        */\n\n      log.debug('MiniLesson AudioChat: initialising');\n\n    return {\n        autocreateresponse : false, // If true, the response will be created automatically\n        gradingrequesttag: \"gradingrequest\", // Tag for the grading request\n        gradingData: false, // Data returne by the grading request\n        strings: {},\n        controls: {}, // Controls for the item\n        itemdata: {}, // Item data for the item\n        index: 0, // Index of the item in the quiz\n        quizhelper: {}, // Quiz helper for the item\n        pc: null,\n        dc: null,\n        cantChat: false,\n        audiochat_voice: \"alloy\", // Default voice for the AI\n        isSessionStarted: false,\n        isSessionStopped: false,\n        isSessionActive: false,\n        isLoading: false,\n        isMicActive: false,\n        isMicInitialized: false, // True when getUserMedia has successfully run once\n        loadingMessages: new Set(), // To track messages that are currently loading,\n        audioContext: null,\n        analyser: null,\n        dataArray: null,\n        sourceNode: null,\n        mediaStream: null,\n        animationFrameId: null,\n        canvasCtx: null,\n        eventlogs: [],\n        items: {},\n        responses: {},\n        abortcontroller: new AbortController(),\n        datainputbuffer: false,\n        inputBufferInterval: null,\n        //Turn detection - semantic is good for native speakers, but awful for language learners\n        // time based we give 3.5s of silence detection before posting\n        semantic_vad: {\n            type: \"semantic_vad\",\n            eagerness: \"low\",\n        },\n\n        timebased_vad: {\n            type: \"server_vad\",\n            silence_duration_ms: 3500,\n            create_response: true, // true = it will turn on and off the mic and respond\n            interrupt_response: true, // only in conversation mode\n            threshold: 0.3,\n            //  \"prefix_padding_ms\": 300,\n        },\n\n        // For making multiple instances\n        clone: function() {\n            return $.extend(true, {}, this);\n        },\n\n        init: function(index, itemdata, quizhelper) {\n            this.itemdata = itemdata;\n            this.autocreateresponse = itemdata.audiochat_autoresponse || false;\n            log.debug('itemdata', itemdata);\n            this.quizhelper = quizhelper;\n            this.index = index;\n            this.cantChat = !itemdata.canchat;\n            this.init_strings();\n            this.init_controls(quizhelper, itemdata);\n            this.init_voice(itemdata.audiochat_voice);\n            this.register_events(index, itemdata, quizhelper);\n            this.renderUI();\n        },\n\n        init_strings: function() {\n            var self = this;\n            // Set up strings\n            str.get_strings([\n                { \"key\": \"gradebywordcount\", \"component\": \"mod_minilesson\" },\n            ]).done(function (s) {\n                var i = 0;\n                self.strings.gradebywordcount = s[i++];\n            });\n        },\n\n        next_question: function() {\n            var self = this;\n            var stepdata = {};\n            stepdata.index = self.index;\n            stepdata.hasgrade = true;\n            stepdata.totalitems = self.itemdata.totalmarks;\n            stepdata.resultsdata = {'items': Object.values(self.items)};\n            // Add grade and other results data\n            stepdata= self.grade_activity(stepdata);\n            stepdata.correctitems = Math.round((self.itemdata.totalmarks * stepdata.grade) / 100);\n            self.quizhelper.do_next(stepdata);\n        },\n\n        count_words: function() {\n            var self = this;\n            var userTranscript = [];\n            Object.values(self.items).forEach(item => {\n                if (item.content) {\n                    userTranscript.push(item.content);\n                }\n            });\n            var wordCount = userTranscript.join(' ').split(/\\s+/).length;\n            return wordCount;\n        },\n\n        toggle_autocreate_response: function() {\n            var self = this;\n            self.autocreateresponse = !self.autocreateresponse;\n            self.timebased_vad.create_response = self.autocreateresponse;\n            log.debug(\"Autocreate response toggled:\", self.autocreateresponse);\n            self.dc.send(JSON.stringify({\n                type: \"session.update\",\n                session: {\n                    turn_detection: self.timebased_vad,\n                }\n            }));\n        },\n\n        grade_activity: function(stepdata) {\n            //loop through items and form a complete user transcript\n            var self = this;\n\n            //count words in the transcript\n            var wordcount = self.count_words();\n\n            if(self.gradingData && self.gradingData.score !== undefined) {\n                log.debug(\"Using grading data from AI:\", self.gradingData);\n                // If grading data is available, use it\n                stepdata.grade = self.gradingData.score;\n\n                //If target word count is greater then 0, we lower the grade if it is lower then that target word count\n                if(typeof stepdata.grade === 'number' && \n                    typeof wordcount === 'number' &&\n                    self.itemdata.targetwordcount > 0 &&\n                     wordcount < self.itemdata.targetwordcount) {\n                    stepdata.grade = Math.round(stepdata.grade * (wordcount / self.itemdata.targetwordcount));\n                }\n\n\n                stepdata.resultsdata.aifeedback = self.gradingData.feedback || \"\";\n                stepdata.resultsdata.gradeexplanation = self.gradingData.gradeexplanation || \"\";\n\n            } else {\n                //Otherwise we default to counting words\n                stepdata.resultsdata.gradeexplanation = self.strings.gradebywordcount;\n                if(self.itemdata.countwords === false || self.itemdata.targetwordcount === 0){\n                    stepdata.grade =  100;\n                }\n\n                \n\n                // Calculate grade based on word count\n                stepdata.grade = Math.min(wordcount / self.itemdata.targetwordcount, 1) * 100;\n\n            }\n\n            // return stepdata\n            return stepdata;\n\n        },\n\n        register_events: function(index, itemdata, quizhelper) {\n\n            var self = this;\n\n            // Event Listeners\n            self.controls.startSessionBtn.addEventListener(\"click\", self.startSession.bind(this));\n            self.controls.stopSessionBtn.addEventListener(\"click\", self.stopSession.bind(this));\n            self.controls.retrySessionBtn.addEventListener(\"click\", self.resetSession.bind(this));\n            self.controls.autocreateresponseCheckbox.addEventListener(\"change\", self.toggle_autocreate_response.bind(self));\n            self.controls.cancelStartSessionBtn.addEventListener(\"click\", () => {\n                log.debug(\"Cancelling session start\");\n                self.abortcontroller.abort();\n                self.abortcontroller = new AbortController();\n            });\n\n            $(self.controls.nextbutton).on('click', function() {\n                self.next_question();\n            });\n\n            var container = $(self.controls.container);\n            container.on('showElement', () => {\n                if (itemdata.timelimit > 0) {\n                    container.find(\".progress-container\").show();\n                    container.find(\".progress-container i\").show();\n                    container.find(\".progress-container #progresstimer\").progressTimer({\n                        height: '5px',\n                        timeLimit: itemdata.timelimit,\n                        onFinish: function() {\n                            nextbutton.trigger('click');\n                        }\n                    });\n                }\n            });\n\n\n            if (self.controls.toggleMicBtn) {\n                self.controls.toggleMicBtn.addEventListener(\"click\", self.toggleMute.bind(self))\n            }\n        },\n\n        init_voice: function(voice) {\n            var self = this;\n            var voices = ['alloy', 'ash', 'ballad', 'coral', 'echo', 'sage', 'shimmer', 'verse'];\n            if (voice && voices.includes(voice)) {\n                self.audiochat_voice = voice;\n            } else {\n                self.audiochat_voice = 'alloy'; // Default voice\n            }\n            log.debug(\"AudioChat voice set to:\", this.audiochat_voice);\n        },\n\n        init_controls: async function() {\n            var self = this;\n            var container = document.getElementById(self.itemdata.uniqueid + \"_container\");\n            self.controls = {\n                hiddenaudio: container.querySelector('.ml_ac_hiddenaudio'),\n                nextbutton: container.querySelector('.minilesson_nextbutton'),\n                cantChatWarning: container.querySelector(\".ml_ac_cantchat\"),\n                startSessionBtn: container.querySelector(\".ml_ac_start-session-btn\"),\n                stopSessionBtn: container.querySelector(\".ml_ac_stop-session-btn\"),\n                loadingIndicator: container.querySelector(\".ml_ac_loading-indicator\"),\n                aiAvatarSection: container.querySelector(\".ml_ac_ai-avatar-section\"),\n                chatActiveMessage: container.querySelector(\".ml_ac_chat-active-message\"),\n                conversationSection: container.querySelector(\".ml_ac_conversation-section\"),\n                messagesContainer: container.querySelector(\".ml_ac_messages-container\"),\n                micButtonContainer: container.querySelector(\".mic-button-container\"),\n                toggleMicBtn: container.querySelector(\".toggle-mic-btn\"),\n                micIcon: container.querySelector(\".mic-icon\"),\n                micWaveformCanvas: container.querySelector(\".mic-waveform-canvas\"),\n                micSelect: container.querySelector('.ml_ac_micselect'),\n                finishMessage: container.querySelector('.ml_ac_finished-message'),\n                retrySessionBtn: container.querySelector('.ml_ac_retrybtn'),\n                cancelStartSessionBtn: container.querySelector('.ml_ac_cancel-start-session-btn'),\n                autocreateresponseCheckbox: container.querySelector('.ml_ac_autoresponse-checkbox'),\n                resultscontainer: container.querySelector('.ml_ac_results_container'),\n                resultscontent: container.querySelector('.ml_ac_results_content'),\n                autocreateresponseToggle: container.querySelector('.ml_ac_autoresponse-toggle'),\n\n                clicktosendlabel: container.querySelector('.ml_ac_clicktosend'),\n                mainWrapper: container.querySelector('.minilesson_audiochat_box .ml_unique_mainwrapper'),\n            };\n            self.canvasCtx = !self.controls.micWaveformCanvas ? null :\n                self.controls.micWaveformCanvas.getContext(\"2d\");\n\n            // Initial render\n            await self.populateMicList();\n\n        },\n\n        scrollToBottom: function() {\n            var self = this;\n            self.controls.conversationSection.firstElementChild.scrollIntoViewIfNeeded();\n            self.controls.conversationSection.firstElementChild.scrollTop = self.controls.conversationSection.firstElementChild.scrollHeight;\n        },\n\n        scrollMicButtonIntoView: function() {\n            var self = this;\n            if (self.controls.micButtonContainer) {\n                self.controls.micButtonContainer.scrollIntoView({behavior: \"smooth\", block: \"center\"});\n            }\n        },\n\n        renderUI: function() {\n            var self = this;\n            // Session Controls\n            self.controls.startSessionBtn.classList.toggle(\"hidden\", self.isSessionActive || self.isLoading || self.isSessionStarted || self.cantChat);\n            self.controls.cantChatWarning.classList.toggle(\"hidden\", !self.cantChat);\n            self.controls.loadingIndicator.classList.toggle(\"hidden\", !self.isLoading);\n            self.controls.stopSessionBtn.classList.toggle(\"hidden\", !self.isSessionActive);\n            self.controls.micButtonContainer.classList.toggle(\"hidden\", !self.isSessionActive);\n            var endScreen = self.isSessionStarted && self.isSessionStopped;\n            self.controls.resultscontainer.classList.toggle(\"hidden\", !endScreen && self.quizhelper.showitemreview);\n            self.controls.finishMessage.classList.toggle(\"hidden\", !endScreen);\n            self.controls.retrySessionBtn.classList.toggle(\"hidden\", !endScreen && self.itemdata.allowretry);\n            // We no longer show the cancel button. It does not work after changes we made to icegathering.\n            // If we set abortcontroller.signal to work with it will work, but it is complex\n            //self.controls.cancelStartSessionBtn.classList.toggle('hidden', !(self.isLoading && !self.isSessionActive));\n            self.controls.autocreateresponseToggle.classList.toggle(\"hidden\", !self.isSessionActive);\n            if (self.controls.micSelect) {\n                //how many options are in micselect\n                var mics = self.controls.micSelect.querySelectorAll('option');\n                var noshowmics = mics.length < 2;\n                self.controls.micSelect.parentElement.classList.toggle(\n                    'hidden',\n                    noshowmics || self.isSessionStarted || self.isLoading || self.controls.micSelect.disabled\n                );\n            }\n\n            var orderedItems = [];\n            var idMap = new Map();\n            var previousMap = new Map();\n            var currentItem;\n            Object.values(self.items).forEach(item => {\n                idMap.set(item.id, item);\n                previousMap.set(item.previous_item_id, item);\n                if (item.previous_item_id === null) {\n                    currentItem = item;\n                }\n            });\n            while (currentItem) {\n                orderedItems.push(currentItem);\n                currentItem = previousMap.get(currentItem.id);\n            }\n\n            // The cute dog avatar\n            self.controls.aiAvatarSection.classList.toggle(\"hidden\", self.isSessionStarted || self.isSessionActive || self.isSessionStopped);\n            //The chat session is active message\n            self.controls.chatActiveMessage.classList.toggle(\"hidden\", !self.isSessionActive);\n            // The conversation area\n            self.controls.conversationSection.classList.toggle(\"hidden\", !(self.isSessionActive || self.isSessionStopped));\n\n            // Render messages\n            self.controls.messagesContainer.innerHTML = \"\"; // Clear existing messages\n            \n            orderedItems.forEach((message) => {\n                if (!message.content) {\n                    return;\n                }\n                var messageDiv = document.createElement(\"div\");\n                messageDiv.className = `flex ${message.usertype === \"user\" ? \"justify-end\" : \"justify-start\"} ml_unique_ordered_message_${message.usertype === \"user\" ? \"user\" : \"assistant\"}`;\n\n                var contentDiv = document.createElement(\"div\");\n                contentDiv.className = `max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${\n                        message.usertype === \"user\" ? \"bg-blue-500 text-white\" : \"bg-gray-200 text-gray-800\"\n                    } ml_unique_content_${\n                        message.usertype === \"user\" ? \"user\" : \"assistant\"\n                    }`;\n\n                var headerDiv = document.createElement(\"div\");\n                headerDiv.className = \"flex items-center text-xs font-medium mb-1 ml_unique_headerdiv\";\n                if (message.usertype === \"assistant\") {\n                    var pictureDiv = document.createElement('div');\n                    pictureDiv.innerHTML = `\n                        <img src=\"${M.cfg.wwwroot}/mod/minilesson/pix/cutepoodll_small.png\" \n                        alt=\"AI Assistant\" class=\"mr-2 rounded-circle shadow-lg ml_unique_assistant_img\">\n                        `;\n                    headerDiv.appendChild(pictureDiv);\n                }\n                headerDiv.innerHTML += message.usertype === \"user\" ? \"Student\" : \"AI Assistant\";\n                contentDiv.appendChild(headerDiv);\n\n                var textDiv = document.createElement(\"div\");\n                textDiv.className = \"text-sm ml_unique_textsmall\";\n                textDiv.textContent = message.content;\n                contentDiv.appendChild(textDiv);\n\n                if (self.loadingMessages.has(message.id)) {\n                    var loaderDiv = document.createElement(\"div\");\n                    loaderDiv.className = \"flex items-center space-x-1 py-1 message-loader ml_unique_loadingmessage\";\n                    loaderDiv.innerHTML = `\n                        <div class=\"flex space-x-1 ml_unique_loader\">\n                            <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                            <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                            <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                        </div>\n                        <span class=\"text-xs opacity-70 ml_unique_loader_text\">AI is thinking...</span>\n                    `;\n                    contentDiv.appendChild(loaderDiv);\n                }\n\n                messageDiv.appendChild(contentDiv);\n                self.controls.messagesContainer.appendChild(messageDiv);\n            });\n\n            self.scrollToBottom();\n           // self.scrollMicButtonIntoView();\n\n            // Update mic button container and canvas visibility\n            if (self.controls.micButtonContainer) {\n                self.controls.micButtonContainer.classList.toggle(\"active\", self.isMicActive);\n                self.controls.micButtonContainer.classList.toggle(\"bg-blue-500\", self.isMicActive); // Active background color\n                self.controls.micButtonContainer.classList.toggle(\"text-white\", self.isMicActive); // Active icon color\n                self.controls.micButtonContainer.classList.toggle(\"bg-gray-200\", !self.isMicActive); // Inactive background color\n                self.controls.micButtonContainer.classList.toggle(\"text-gray-800\", !self.isMicActive); // Inactive icon color\n            }\n\n\n            if (self.controls.micWaveformCanvas) {\n                self.controls.micWaveformCanvas.classList.toggle(\"active\", self.isMicActive);\n            }\n\n            if (self.controls.micIcon) {\n                // Set icon based on mic state\n                self.controls.micIcon.innerHTML = self.isMicActive\n                    ? `<rect id=\"primary\" x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"2\" style=\"fill: rgb(0, 0, 0);\"></rect>` // Mic On icon\n                    : `<path id=\"secondary\" d=\"M12,15h0a4,4,0,0,1-4-4V7a4,4,0,0,1,4-4h0a4,4,0,0,1,4,4v4A4,4,0,0,1,12,15Z\" style=\"fill: rgb(44, 169, 188); stroke-width: 2;\"></path><path id=\"primary\" d=\"M18.24,16A8,8,0,0,1,5.76,16\" style=\"fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;\"></path><path id=\"primary-2\" data-name=\"primary\" d=\"M12,19v2m4-10V7a4,4,0,0,0-4-4h0A4,4,0,0,0,8,7v4a4,4,0,0,0,4,4h0A4,4,0,0,0,16,11Z\" style=\"fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;\"></path>`; // Mic Off icon\n            }\n\n            //show or not show clicktosendlabel\n            if (self.isMicActive && !self.autocreateresponse) {\n                self.controls.clicktosendlabel.classList.remove(\"hidden\");\n            } else {\n                self.controls.clicktosendlabel.classList.add(\"hidden\");\n            }\n\n        },\n\n        //setter for datainputbuffer\n        setDataInputBuffer: function(value, source) {\n            var self = this;\n            self.datainputbuffer = value;\n            log.debug(\"Data in input buffer set to:\", value);\n            log.debug(\"Data input buffer set source:\", source);\n        },\n\n        resetSession: function() {\n            log.debug(\"reset  session\");\n            var self = this;\n            self.isLoading = false;\n            self.isSessionActive = false;\n            self.isSessionStopped = false;\n            self.isSessionStarted = false;\n            self.renderUI();\n        },\n\n        startSession: async function() {\n            var self = this;\n            var twoletterlang = self.itemdata.language.substr(0, 2);\n            var hiddenaudio = self.controls.hiddenaudio;\n            log.debug(\"Session starting\");\n            self.isLoading = true;\n            self.items = [];\n            self.renderUI();\n            // Open the RTC PeerConnection via Stun and ICE servers\n            log.debug(\"Opening peer connection...\");\n            self.pc = new RTCPeerConnection({\n                iceServers: [{\n                    urls: \"stun:stun.l.google.com:19302\"\n                }]\n            });\n\n            // Create a DataChannel for sending events (text and audio)\n            log.debug(\"creating data channel...\");\n            self.dc = self.pc.createDataChannel(\"oai-events\");\n\n            // Handle incoming messages on the DataChannel\n            self.dc.onmessage = (e) => {\n                self.eventlogs.push(e.data);\n                //log.debug(\"DataChannel message:\", e.data);\n                try {\n                    var lines = e.data.split(\"\\n\").filter(Boolean);\n                    for (var line of lines) {\n                        self.handleRTCEvent.call(self, JSON.parse(line));\n                    }\n                } catch (err) {\n                    log.debug(\"Failed to parse\", err);\n                }\n            };\n            self.dc.onopen = () => {\n                log.debug(\"DataChannel open\");\n\n                //Turn detection - semantic is good for native speakers, but awful for language learners\n                // time based we give 1.5s of silence detection before posting\n                var semantic_vad ={\n                    type: \"semantic_vad\",\n                    eagerness: \"low\",\n                };\n\n                // Set the auto turn detection, or manual submit flag\n                self.timebased_vad.create_response = self.autocreateresponse;\n\n                // Set session-wide instructions\n                self.sendEvent({\n                    type: \"session.update\",\n                    session: {\n                        instructions: self.itemdata.audiochatinstructions,\n                        input_audio_format: \"pcm16\", // Ensure correct audio encoding\n                        input_audio_transcription: {\n                            language: twoletterlang,\n                            model: \"whisper-1\" // \"gpt-4o-mini-transcribe\"  // Use a transcription model\n                        },\n                        turn_detection: self.timebased_vad,\n                        speed: 0.9,\n                        voice: self.audiochat_voice,\n                        modalities: [\"text\", \"audio\"],\n                    }\n                });\n\n                // Send the first message to tell AI to say something\n                // the response create function overrides the session instructions, so we need to double up here\n                var firstmessageinstructions =  \"Please introduce yourself to the student and explain todays topic.\";\n                self.sendEvent({\n                    type: \"response.create\",\n                    response: {\n                        modalities: [\"audio\", \"text\"],\n                        instructions:  self.itemdata.audiochatinstructions + \" \" + firstmessageinstructions,\n                        voice: self.audiochat_voice\n                    }\n                });\n\n            };\n\n            // Set up the audio element to play incoming audio.\n            self.pc.ontrack = (event) => {\n                hiddenaudio.srcObject = event.streams[0];\n            };\n\n            // Set up the Mic stream.\n            self.mediaStream = await navigator.mediaDevices.getUserMedia({audio: true});\n            self.mediaStream.getTracks().forEach((track) => {\n                track.enabled = false;\n                self.pc.addTrack(track, self.mediaStream);\n            });\n\n            // Set up the RTC Connection by bouncing our request off the Moodle server\n            var offer = await self.pc.createOffer({\n                offerToReceiveAudio: true\n            });\n            await self.pc.setLocalDescription(offer);\n            // Search for server candidates for relaying messages, may take 15s\n            await self.waitForIceGathering(self.pc);\n\n            try {\n                var sdpResponse = await fetch(M.cfg.wwwroot + \"/mod/minilesson/openairtc.php\", {\n                    method: \"POST\",\n                    headers: {\n                        \"Content-Type\": \"application/sdp\"\n                    },\n                    body: self.pc.localDescription.sdp,\n                    signal: self.abortcontroller.signal\n                });\n                if (!sdpResponse.ok) {\n                    log.debug(\"Failed /rtc:\", await sdpResponse.text());\n                    return;\n                }\n                log.debug(\"Received SDP answer from server\");\n                var answer = await sdpResponse.text();\n                log.debug(answer);\n                await self.pc.setRemoteDescription({\n                    type: \"answer\",\n                    sdp: answer\n                });\n                log.debug(\"Session started\");\n            } catch(e) {\n                \n                if (e.name === 'AbortError') {\n                    log.debug(\"Session start aborted by user.\");\n                    // Reset UI and state as needed\n                    self.isLoading = false;\n                    self.renderUI();\n                    return;\n                }\n\n                // Close data channel if open\n                if (self.dc) {\n                    self.dc.close();\n                }\n                // Close peer connection if open\n                if (self.pc) {\n                    self.pc.close();\n                }\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach((track) => track.stop());\n                }\n                self.isLoading = false;\n                self.renderUI();\n                return;\n            }\n\n            self.isLoading = false;\n            self.isSessionActive = true;\n            self.isSessionStarted = true;\n            self.isSessionStopped = false;\n            self.renderUI();\n        },\n\n        sendGradingRequest: function() {\n            var self = this;\n            // Send a final message to tell AI to grade the session and give feedback\n            var gradingInstructions = \"Please provide a percentage score for the session, an explanation of the score (for teachers), and feedback (for the student). \" +\n                 self.itemdata.audiochatgradeinstructions +\n                \"Return the response as JSON in the format: {\\\"score\\\": \\\"the score  ( 0-100 ) \\\", \\\"gradeexplanation\\\": \\\"the explanation\\\", \\\"feedback\\\": \\\"the feedback\\\"}.\";\n\n            var responsedata = {\n                // The response is out of band and not be added to the default conversation\n                conversation: \"none\",\n                modalities: [\"text\"],\n                instructions: gradingInstructions,\n                // Add the gradingrequest tag to make handltertc life easier\n                metadata: { tag: self.gradingrequesttag},\n                max_output_tokens: 500, // Keeps it tight\n                temperature: 0.6, // Optional: makes grading more deterministic\n            };\n\n            //If we wanted to reutrn an audio response (but lets not)\n            //responsedata.voice = self.audiochat_voice;\n\n            self.sendEvent({\n                type: \"response.create\",\n                response: responsedata,\n            });\n        },\n\n        stopSession: function() {\n            var self = this;\n\n            log.debug(\"Session stopping...\");\n            self.isSessionActive = false;\n            self.isSessionStopped = true;\n            self.loadingMessages.clear();\n\n            // Release mic resources when session ends\n            self.releaseMicResources();\n            self.renderUI();\n\n            // request grading information\n            // after that response, we will close the data channel and peer connection\n            //but shut it down after 2s just in case there is an error or something\n            if(self.itemdata.audiochatgradeinstructions && self.itemdata.audiochatgradeinstructions !== \"\") {\n                self.sendGradingRequest();\n\n                //add a spinner to the results content\n                //if we are not showing item review we do not need this, but in that case it is hidden anyway\n                self.controls.resultscontent.innerHTML = `<i class=\"fa fa-spinner fa-spin fa-2x\"></i>`;\n\n                setTimeout(() => {\n                    //now show the results content if that is what we are doing\n                    if(self.quizhelper.showitemreview) {\n                        self.showResults();\n                    }\n                    log.debug(\"Closing session resources...\");\n                    self.closeDataChannel();\n                }, 2000);\n            }else{\n                log.debug(\"Closing session resources...\");\n                self.closeDataChannel();\n            }\n            log.debug(\"Session stopped\");\n        },\n\n        closeDataChannel: function() {\n            var self = this;\n            // Tidy up the data channel and peer connection\n            if (typeof self.dc !== 'undefined' && self.dc) {\n                self.dc.close();\n                self.dc = null;\n            }\n            if (typeof self.pc !== 'undefined' && self.pc) {\n                self.pc.close();\n                self.pc = null;\n            }\n        },\n\n        showResults: function(){\n            var self = this;\n            var tdata = {};\n            tdata.resultsdata = {'items': Object.values(self.items)};\n            // Add grade and other results data\n            tdata = self.grade_activity(tdata);\n\n            //calculate stars from grade\n            const stars = [];\n            const maxStars = 5;\n            // if tdata grade is NAn or undefined, set it to 0\n            if (typeof tdata.grade === 'undefined' || isNaN(tdata.grade) || tdata.grade === null || tdata.grade === \"\") {\n                tdata.grade = 0;\n            }\n           \n            const filledStars = Math.round((tdata.grade / 100) * maxStars);\n            for (let i = 0; i < maxStars; i++) {\n                stars.push({ filled: i < filledStars });\n            }\n            tdata.stars = stars;\n\n            templates.render('mod_minilesson/audiochatimmediatefeedback', tdata).then(\n                function(html, js) {\n                    self.controls.resultscontent.innerHTML = html;\n                }\n            );\n        },\n\n        waitForIceGathering: function(pc, timeout = 15000) {\n            return new Promise((resolve) => {\n                let timer;\n\n                function checkState() {\n                    if (pc.iceGatheringState === \"complete\") {\n                        clearTimeout(timer);\n                        pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                        resolve();\n                    }\n                }\n\n                pc.addEventListener(\"icegatheringstatechange\", checkState);\n\n                // Timeout to resolve with current state\n                timer = setTimeout(() => {\n                    pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                    resolve(); // Resolve with as many candidates as gathered so far\n                }, timeout);\n            });\n        },\n\n        sendEvent: function(obj) {\n            var self = this;\n            if (self.dc && self.dc.readyState === \"open\") {\n                self.dc.send(JSON.stringify(obj));\n            }\n        },\n\n        handleRTCEvent: function(msg) {\n            var self = this;\n            log.debug(\"Received event:\");\n\n            // Check if its the final grading message, which we don't want to enter \"items\"\n            if (msg.type === \"response.done\" &&\n                msg.response.metadata?.tag === self.gradingrequesttag) {\n                // Check if the response corresponds to the grading event\n                    try {\n                        var jsonresponse = msg.response.output[0].content[0].text;\n                        if(!jsonresponse || jsonresponse === \"\") {\n                            log.debug(\"No valid grading data received\");\n                            self.closeDataChannel();\n                            return;\n                        }\n\n                        self.gradingData = JSON.parse(jsonresponse);\n                        log.debug(\"Grading and Feedback:\", self.gradingData);\n\n                    } catch (err) {\n                        log.debug(\"Failed to parse grading feedback:\", err);\n                    }\n                    return;\n\n            }\n\n            // log.debug(msg);\n            var msgresponse_id = msg.response ? msg.response.id : msg.response_id;\n            var msgitem_id = msg.item ? msg.item.id : msg.item_id;\n            if (msgresponse_id) {\n                self.responses[msgresponse_id] = self.responses[msgresponse_id] || {\n                    id: msgresponse_id,\n                    itemid: msgitem_id,\n                    stack: []\n                };\n            }\n            if (msgitem_id) {\n                if (typeof self.items[msgitem_id] === 'undefined') {\n                    self.scrollToBottom();\n                }\n                self.items[msgitem_id] = self.items[msgitem_id] || {\n                    id: msgitem_id,\n                    events: [],\n                    responses: null,\n                    content: ''\n                };\n                if (msgresponse_id) {\n                    self.items[msgitem_id].responses = self.responses[msgresponse_id];\n                }\n            }\n\n            msg.time = Date.now().toString();\n\n            switch (msg.type) {\n                case \"response.created\": {\n/*```\n{\n    \"type\": \"response.created\",\n    \"event_id\": \"event_Bzbmm1vOdUpYK5LcKMPAU\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"in_progress\",\n        \"status_details\": null,\n        \"output\": [],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": null,\n        \"metadata\": null\n    }\n}\n```*/\n                    self.responses[msg.response.id].stack.push(msg);\n                    break;\n                }\n                case \"response.output_item.added\": {\n/*```\n{\n    \"type\": \"response.output_item.added\",\n    \"event_id\": \"event_BzbmnNUVJeqok4KqSLSVl\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    break;\n                }\n                case \"conversation.item.created\": {\n/*```\n{\n    \"type\": \"conversation.item.created\",\n    \"event_id\": \"event_BzbmnttqDhvU3h2he1tK7\",\n    \"previous_item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n}\n```*/\n                    self.items[msg.item.id].previous_item_id = msg.previous_item_id;\n                    self.items[msg.item.id].usertype = msg.item.role;\n                    self.items[msg.item.id].events.push(msg);\n                    if (msg.item.role === 'assistant') {\n                        self.loadingMessages.add(msgitem_id);\n                    }\n                    break;\n                }\n                case \"response.content_part.added\": {\n/*```\n{\n    \"type\": \"response.content_part.added\",\n    \"event_id\": \"event_Bzbmn7lA1i7fOfFq8ju3F\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"\"\n    }\n}\n```*/\n                    self.enableMic();// Let's enable mic\n                    self.responses[msg.response_id].stack.push(msg);\n                    break;\n                }\n                case \"response.audio_transcript.delta\": {\n/*```\n{\n    \"type\": \"response.audio_transcript.delta\",\n    \"event_id\": \"event_BzbmnpxUmLA0zAnR5mRy3\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"delta\": \"Hi\"\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    self.items[msg.item_id].content += msg.delta;\n                    break;\n                }\n\n                case \"output_audio_buffer.cleared\": {\n/*```\n{\n    \"type\": \"output_audio_buffer.cleared\",\n    \"event_id\": \"event_f7273193069b4938\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\"\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    break;\n                }\n                case \"response.audio.done\": {\n/*```\n{\n    \"type\": \"response.audio.done\",\n    \"event_id\": \"event_Bzbmn7aEtTnprkzqE9i6X\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    break;\n                }\n                case \"response.audio_transcript.done\": {\n/*```\n{\n    \"type\": \"response.audio_transcript.done\",\n    \"event_id\": \"event_BzbmnNGRs7797nz1Qh7em\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"transcript\": \"Hi! How are you today? What did you do today?\"\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    self.items[msg.item_id].content = msg.transcript;\n                    break;\n                }\n                case \"response.content_part.done\": {\n/*```\n{\n    \"type\": \"response.content_part.done\",\n    \"event_id\": \"event_BzbmnYdAvAKMU7ti311Vj\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    break;\n                }\n                case \"response.output_item.done\": {\n/*```\n{\n    \"type\": \"response.output_item.done\",\n    \"event_id\": \"event_BzbmnhD5RdLxAOnko94Z1\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"incomplete\",\n        \"role\": \"assistant\",\n        \"content\": [\n            {\n                \"type\": \"audio\",\n                \"transcript\": \"Hi! How are you today? What did you do today?\"\n            }\n        ]\n    }\n}\n```*/\n                    self.responses[msg.response_id].stack.push(msg);\n                    self.loadingMessages.delete(msg.item.id);\n                    break;\n                }\n                case \"response.done\": {\n/*```\n{\n    \"type\": \"response.done\",\n    \"event_id\": \"event_Bzbmn8bIaGB59d6qG7LQS\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"cancelled\",\n        \"status_details\": {\n            \"type\": \"cancelled\",\n            \"reason\": \"turn_detected\"\n        },\n        \"output\": [\n            {\n                \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n                \"object\": \"realtime.item\",\n                \"type\": \"message\",\n                \"status\": \"incomplete\",\n                \"role\": \"assistant\",\n                \"content\": [\n                    {\n                        \"type\": \"audio\",\n                        \"transcript\": \"Hi! How are you today? What did you do today?\"\n                    }\n                ]\n            }\n        ],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": {\n            \"total_tokens\": 170,\n            \"input_tokens\": 94,\n            \"output_tokens\": 76,\n            \"input_token_details\": {\n                \"text_tokens\": 87,\n                \"audio_tokens\": 7,\n                \"cached_tokens\": 0,\n                \"cached_tokens_details\": {\n                    \"text_tokens\": 0,\n                    \"audio_tokens\": 0\n                }\n            },\n            \"output_token_details\": {\n                \"text_tokens\": 23,\n                \"audio_tokens\": 53\n            }\n        },\n        \"metadata\": null\n    }\n}\n```*/\n                    self.responses[msg.response.id].stack.push(msg);\n                    break;\n                }\n                case \"output_audio_buffer.stopped\": {\n/*```\n{\n    \"type\":\"output_audio_buffer.stopped\",\n    \"event_id\":\"event_0ebd8495b5a945e5\",\n    \"response_id\":\"resp_C17PJbWxcyg7tgQBVTAaL\"\n}\n```*/\n                    if (!self.isMicActive) {\n                        self.toggleMute();\n                    }\n                    self.responses[msg.response.id].stack.push(msg);\n                    break;\n                }\n                case \"conversation.item.truncated\": {\n/*```\n{\n    \"type\": \"conversation.item.truncated\",\n    \"event_id\": \"event_BzbmnGqfHdq1hy2Wr2fnA\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"content_index\": 0,\n    \"audio_end_ms\": 261\n}\n```*/\n                    self.items[msg.item_id].events.push(msg);\n                    break;\n                }\n                // User events.\n                case \"input_audio_buffer.speech_started\": {\n/*```\n{\n    \"type\": \"input_audio_buffer.speech_started\",\n    \"event_id\": \"event_Bzbmm9FJ5oCTmCpng9tem\",\n    \"audio_start_ms\": 820,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n}\n```*/\n                    log.debug(\"Input audio buffer speech started\");\n                    self.setDataInputBuffer(true, 'audiobufferstarted');\n                    self.items[msg.item_id].events.push(msg);\n                    break;\n                }\n                case \"input_audio_buffer.speech_stopped\": {\n/*```\n{\n    \"type\": \"input_audio_buffer.speech_stopped\",\n    \"event_id\": \"event_BzbmmUgLX2JKgJr1eMx0l\",\n    \"audio_end_ms\": 1568,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n}\n```*/\n                    if (self.isMicActive) {\n                        // Only auto-toggle mic if autocreateresponse is true\n                        if (self.autocreateresponse) {\n                            self.toggleMute();\n                            self.disableMic();\n                        }\n                    }\n                    self.items[msg.item_id].events.push(msg);\n                    break;\n                }\n                case \"input_audio_buffer.committed\": {\n/*```\n{\n    \"type\": \"input_audio_buffer.committed\",\n    \"event_id\": \"event_BzbmmOICFLRU8vnGEJ6vM\",\n    \"previous_item_id\": null,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n}\n```*/               log.debug(\"Input audio buffer committed\");\n                    self.setDataInputBuffer(false, 'audiobuffercommitted');\n                    self.items[msg.item_id].events.push(msg);\n                    break;\n                }\n                case \"conversation.item.created\": {\n/*```\n{\n    \"type\": \"conversation.item.created\",\n    \"event_id\": \"event_BzbmmiskBBbCkRSHvUVrL\",\n    \"previous_item_id\": null,\n    \"item\": {\n        \"id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"completed\",\n        \"role\": \"user\",\n        \"content\": [\n            {\n                \"type\": \"input_audio\",\n                \"transcript\": null\n            }\n        ]\n    }\n}\n```*/\n                    self.items[msg.item.id].events.push(msg);\n                    break;\n                }\n                case \"conversation.item.input_audio_transcription.delta\": {\n/*```\n{\n    \"type\": \"conversation.item.input_audio_transcription.delta\",\n    \"event_id\": \"event_BzbmonQuYXZ7QxUCOLlZd\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"delta\": \"Hey.\"\n}\n```*/\n                    self.items[msg.item_id].events.push(msg);\n                    self.items[msg.item_id].content += msg.delta;\n                    break;\n                }\n                case \"conversation.item.input_audio_transcription.completed\": {\n/*```\n{\n    \"type\": \"conversation.item.input_audio_transcription.completed\",\n    \"event_id\": \"event_BzbmotVIjHphgHjViNkZk\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"transcript\": \"Hey.\",\n    \"usage\": {\n        \"type\": \"duration\",\n        \"seconds\": 1\n    }\n}\n```*/\n                    self.items[msg.item_id].events.push(msg);\n                    self.items[msg.item_id].content = msg.transcript;\n                    self.loadingMessages.delete(msg.item_id);\n                    break;\n                }\n            }\n            self.renderUI();\n        },\n\n        enableMic: function() {\n            var self = this;\n            if (self.controls.toggleMicBtn) {\n                log.debug('Enabling mic');\n                self.controls.toggleMicBtn.parentElement.classList.remove('disabled');\n            }\n        },\n\n        disableMic: function() {\n            var self = this;\n            if (self.controls.toggleMicBtn) {\n                log.debug('Disabling mic');\n                self.controls.toggleMicBtn.parentElement.classList.add('disabled');\n            }\n        },\n\n        initializeMicStream: async function() {\n            var self = this;\n            try {\n                self.audioContext = new (window.AudioContext || window.webkitAudioContext)();\n                self.analyser = self.audioContext.createAnalyser();\n                self.analyser.fftSize = 2048;\n                const bufferLength = self.analyser.frequencyBinCount;\n                self.dataArray = new Uint8Array(bufferLength);\n\n                self.sourceNode = self.audioContext.createMediaStreamSource(self.mediaStream);\n                // Source is connected/disconnected in toggleMute\n                self.isMicInitialized = true;\n                return true;\n            } catch (err) {\n                log.debug(\"Error accessing microphone:\", err);\n                self.isMicInitialized = false;\n                log.debug(\"Could not access microphone. Please ensure it's connected and permissions are granted.\");\n                return false;\n            }\n        },\n\n        // Toggles mute/unmute state of the mic\n        toggleMute: async function() {\n            var self = this;\n            if (!self.isMicInitialized) {\n                const success = await self.initializeMicStream();\n                if (!success) {\n                    return;\n                } // If initialization failed, stop here\n            }\n\n            if (self.isMicActive) {\n                // Mute mic: Disconnect source from analyser\n                if (self.sourceNode && self.analyser) {\n                    self.sourceNode.disconnect(self.analyser);\n                }\n                if (self.animationFrameId) {\n                    cancelAnimationFrame(self.animationFrameId);\n                    self.animationFrameId = null;\n                }\n                if (self.pc) {\n                    self.mediaStream.getTracks().forEach((track) => {\n                        track.enabled = false;\n                    });\n                }\n                if (self.canvasCtx) {\n                    self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                }\n                self.isMicActive = false;\n\n                // Send response event when mic is disabled and autocreateresponse is false\n                if (!self.autocreateresponse) {\n                    if(!self.datainputbuffer){\n                        log.debug(\" sending response.create\");\n                        self.sendEvent({\n                            type: \"response.create\",\n                            response: {\n                                modalities: [\"audio\", \"text\"],\n                                instructions: self.itemdata.audiochatinstructions,\n                                voice: self.audiochat_voice\n                            }\n                        });\n                    } else {\n                        //set a recurring 500ms timeout that will send the response.create event if self.datainputbuffer is false\n                        log.debug(\"Waiting for input audio buffer to commit before sending response.create\");\n                        let attempts = 0;\n                        if (self.inputBufferInterval) {\n                            clearInterval(self.inputBufferInterval);\n                            self.inputBufferInterval = null;\n                        }\n                        const maxAttempts = 3;\n                        self.inputBufferInterval = setInterval(() => {\n                            log.debug(\"Checking input buffer status, attempt:\", attempts);\n                            if (!self.datainputbuffer || attempts >= maxAttempts) {\n                                clearInterval(self.inputBufferInterval);\n                                self.setDataInputBuffer(false, 'setInterval:' + attempts);\n                                log.debug(\" sending response.create\");\n                                self.sendEvent({\n                                    type: \"response.create\",\n                                    response: {\n                                        modalities: [\"audio\", \"text\"],\n                                        instructions: self.itemdata.audiochatinstructions,\n                                        voice: self.audiochat_voice\n                                    }\n                                });\n                            }\n                            attempts++;\n                        }, 1500);\n                    }\n                }\n            } else {\n                // Unmute mic: Connect source to analyser\n                if (self.sourceNode && self.analyser) {\n                    self.sourceNode.connect(self.analyser);\n                }\n\n                if (self.pc) {\n                    self.mediaStream.getTracks().forEach((track) => {\n                        track.enabled = true;\n                    });\n                }\n                self.isMicActive = true;\n                self.drawWave(); // Start drawing waveform\n            }\n            self.renderUI(); // Update UI\n        },\n\n        releaseMicResources: function() {\n            var self = this;\n            if (self.animationFrameId) {\n                cancelAnimationFrame(self.animationFrameId);\n                self.animationFrameId = null;\n            }\n            if (self.mediaStream) {\n                self.mediaStream.getTracks().forEach((track) => {\n                    if (typeof self.pc !== 'undefined' && self.pc) {\n                        // Find the RTCRtpSender associated with the track\n                        const sender = self.pc.getSenders().find(s => s.track === track);\n                        // Remove the sender if it exists\n                        if (sender) {\n                            self.pc.removeTrack(sender);\n                        }\n                    }\n                    track.stop();\n                });\n                self.mediaStream = null;\n            }\n            if (self.sourceNode) {\n                self.sourceNode.disconnect();\n                self.sourceNode = null;\n            }\n            if (self.audioContext) {\n                self.audioContext.close();\n                self.audioContext = null;\n            }\n            self.isMicActive = false;\n            self.isMicInitialized = false;\n            if (self.canvasCtx) {\n                self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n            }\n            self.renderUI(); // Update UI to show mic inactive\n        },\n\n        drawWave: function() {\n            var self = this;\n            if (!self.canvasCtx || !self.analyser || !self.dataArray || !self.isMicActive) {\n                self.animationFrameId = null; // Stop animation if conditions are not met\n                return;\n            }\n\n            const WIDTH = self.controls.micWaveformCanvas.width;\n            const HEIGHT = self.controls.micWaveformCanvas.height;\n\n            self.animationFrameId = requestAnimationFrame(self.drawWave.bind(self));\n\n            self.analyser.getByteTimeDomainData(self.dataArray); // Get waveform data\n\n            self.canvasCtx.clearRect(0, 0, WIDTH, HEIGHT); // Clear previous drawing\n            self.canvasCtx.lineWidth = 2;\n            self.canvasCtx.strokeStyle = \"rgb(255, 255, 255)\"; // White color for wave on blue background\n\n            self.canvasCtx.beginPath();\n\n            const sliceWidth = (WIDTH * 1.0) / self.dataArray.length;\n            let x = 0;\n\n            for (let i = 0; i < self.dataArray.length; i++) {\n                const v = self.dataArray[i] / 128.0; // Normalize to 0-2\n                const y = (v * HEIGHT) / 2;\n\n                if (i === 0) {\n                    self.canvasCtx.moveTo(x, y);\n                } else {\n                    self.canvasCtx.lineTo(x, y);\n                }\n\n                x += sliceWidth;\n            }\n\n            self.canvasCtx.lineTo(WIDTH, HEIGHT / 2);\n            self.canvasCtx.stroke();\n        },\n\n        populateMicList: async function() {\n            var self = this;\n            try {\n                const devices = await navigator.mediaDevices.enumerateDevices();\n                const mics = devices.filter(device => device.kind === \"audioinput\");\n                const select = self.controls.micSelect;\n\n                select.innerHTML = \"\"; // Clear existing options\n\n                // Group by groupId to remove duplicates\n                const uniqueMics = [];\n                const seenGroups = new Set();\n\n                for (const mic of mics) {\n                    if (!seenGroups.has(mic.groupId)) {\n                        uniqueMics.push(mic);\n                        seenGroups.add(mic.groupId);\n                    }\n                }\n\n                if (uniqueMics.length <= 1) {\n                    select.disabled = true;\n                    return;\n                }\n                uniqueMics.forEach((mic, index) => {\n                    const option = document.createElement(\"option\");\n                    option.value = mic.deviceId;\n                    option.text = mic.label || `Microphone ${index + 1}`;\n                    select.appendChild(option);\n                });\n                select.parentElement.classList.remove('hidden');\n\n                // Set change listener\n                select.addEventListener(\"change\", async(e) => {\n                    const deviceId = e.target.value;\n                    await self.switchMic(deviceId);\n                });\n            } catch (err) {\n                log.debug(\"Failed to get microphone list:\", err);\n            }\n        },\n\n        switchMic: async function(deviceId) {\n            var self = this;\n\n            // Stop and release current mic\n            if (self.mediaStream) {\n                self.mediaStream.getTracks().forEach(track => track.stop());\n            }\n\n            try {\n                // Get new media stream from selected device\n                self.mediaStream = await navigator.mediaDevices.getUserMedia({\n                    audio: {deviceId: {exact: deviceId}}\n                });\n\n                // Replace tracks in PeerConnection\n                if (self.pc) {\n                    const senders = self.pc.getSenders();\n                    const audioTrack = self.mediaStream.getAudioTracks()[0];\n                    const audioSender = senders.find(sender => sender.track.kind === 'audio');\n                    if (audioSender) {\n                        audioSender.replaceTrack(audioTrack);\n                    }\n                }\n\n                // Reinitialize mic stream and waveform\n                await self.initializeMicStream();\n                if (self.isMicInitialized) {\n                    self.sourceNode.connect(self.analyser);\n                    self.mediaStream.getTracks().forEach((track) => {\n                        track.enabled = self.isMicActive;\n                    });\n                    if (self.isMicActive) {\n                        self.drawWave();\n                    }\n                }\n\n                log.debug(\"Switched microphone to:\" + deviceId);\n            } catch (err) {\n                log.debug(\"Failed to switch microphone:\");\n                log.debug(err);\n            }\n        },\n\n    }; // End of return object.\n});"],"names":["define","$","log","def","ttrecorder","templates","str","debug","autocreateresponse","gradingrequesttag","gradingData","strings","controls","itemdata","index","quizhelper","pc","dc","cantChat","audiochat_voice","isSessionStarted","isSessionStopped","isSessionActive","isLoading","isMicActive","isMicInitialized","loadingMessages","Set","audioContext","analyser","dataArray","sourceNode","mediaStream","animationFrameId","canvasCtx","eventlogs","items","responses","abortcontroller","AbortController","datainputbuffer","inputBufferInterval","semantic_vad","type","eagerness","timebased_vad","silence_duration_ms","create_response","interrupt_response","threshold","clone","extend","this","init","audiochat_autoresponse","canchat","init_strings","init_controls","init_voice","register_events","renderUI","self","get_strings","done","s","i","gradebywordcount","next_question","stepdata","hasgrade","totalitems","totalmarks","resultsdata","Object","values","grade_activity","correctitems","Math","round","grade","do_next","count_words","userTranscript","forEach","item","content","push","join","split","length","toggle_autocreate_response","send","JSON","stringify","session","turn_detection","wordcount","undefined","score","targetwordcount","aifeedback","feedback","gradeexplanation","countwords","min","startSessionBtn","addEventListener","startSession","bind","stopSessionBtn","stopSession","retrySessionBtn","resetSession","autocreateresponseCheckbox","cancelStartSessionBtn","abort","nextbutton","on","container","timelimit","find","show","progressTimer","height","timeLimit","onFinish","trigger","toggleMicBtn","toggleMute","voice","includes","async","document","getElementById","uniqueid","hiddenaudio","querySelector","cantChatWarning","loadingIndicator","aiAvatarSection","chatActiveMessage","conversationSection","messagesContainer","micButtonContainer","micIcon","micWaveformCanvas","micSelect","finishMessage","resultscontainer","resultscontent","autocreateresponseToggle","clicktosendlabel","mainWrapper","getContext","populateMicList","scrollToBottom","firstElementChild","scrollIntoViewIfNeeded","scrollTop","scrollHeight","scrollMicButtonIntoView","scrollIntoView","behavior","block","classList","toggle","endScreen","showitemreview","allowretry","noshowmics","querySelectorAll","parentElement","disabled","currentItem","orderedItems","idMap","Map","previousMap","set","id","previous_item_id","get","innerHTML","message","messageDiv","createElement","className","usertype","contentDiv","headerDiv","pictureDiv","M","cfg","wwwroot","appendChild","textDiv","textContent","has","loaderDiv","remove","add","setDataInputBuffer","value","source","twoletterlang","language","substr","RTCPeerConnection","iceServers","urls","createDataChannel","onmessage","e","data","lines","filter","Boolean","line","handleRTCEvent","call","parse","err","onopen","sendEvent","instructions","audiochatinstructions","input_audio_format","input_audio_transcription","model","speed","modalities","response","ontrack","event","srcObject","streams","navigator","mediaDevices","getUserMedia","audio","getTracks","track","enabled","addTrack","offer","createOffer","offerToReceiveAudio","setLocalDescription","waitForIceGathering","sdpResponse","fetch","method","headers","body","localDescription","sdp","signal","ok","text","answer","setRemoteDescription","name","close","stop","sendGradingRequest","responsedata","conversation","audiochatgradeinstructions","metadata","tag","max_output_tokens","temperature","clear","releaseMicResources","setTimeout","showResults","closeDataChannel","tdata","stars","isNaN","filledStars","filled","render","then","html","js","timeout","Promise","resolve","timer","checkState","iceGatheringState","clearTimeout","removeEventListener","obj","readyState","msg","msgresponse_id","response_id","msgitem_id","item_id","itemid","stack","events","time","Date","now","toString","role","enableMic","delta","transcript","delete","disableMic","jsonresponse","output","initializeMicStream","window","AudioContext","webkitAudioContext","createAnalyser","fftSize","bufferLength","frequencyBinCount","Uint8Array","createMediaStreamSource","disconnect","cancelAnimationFrame","clearRect","width","attempts","clearInterval","maxAttempts","setInterval","connect","drawWave","sender","getSenders","removeTrack","WIDTH","HEIGHT","requestAnimationFrame","getByteTimeDomainData","lineWidth","strokeStyle","beginPath","sliceWidth","x","y","moveTo","lineTo","stroke","mics","enumerateDevices","device","kind","select","uniqueMics","seenGroups","mic","groupId","option","deviceId","label","target","switchMic","exact","senders","audioTrack","getAudioTracks","audioSender","replaceTrack"],"mappings":"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"}