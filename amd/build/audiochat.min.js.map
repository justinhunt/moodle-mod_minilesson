{"version":3,"file":"audiochat.min.js","sources":["../src/audiochat.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions',\n    'mod_minilesson/ttrecorder',  'core/templates'],\n    function($, log, def, ttrecorder, templates) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the free speaking item type\n   */\n\n  log.debug('MiniLesson AudioChat: initialising');\n\n  return {\n\n    controls: {}, //controls for the item\n    itemdata: {}, //item data for the item\n    index: 0, //index of the item in the quiz\n    quizhelper: {}, //quiz helper for the item\n    pc: null,\n    dc: null,\n    micStream: null,\n    audiochat_voice: \"alloy\", //default voice for the AI\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n      this.itemdata = itemdata;\n      log.debug('itemdata',itemdata);\n      this.quizhelper = quizhelper;\n      this.index = index;\n      this.init_controls(quizhelper,itemdata);\n      this.init_voice(itemdata.audiochat_voice);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n\n    next_question: function() {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = self.itemdata.totalmarks;\n      stepdata.correctitems = self.itemdata.totalmarks;\n      stepdata.grade = 1;\n      stepdata.resultsdata = {};\n      self.quizhelper.do_next(stepdata);\n    },\n\n    register_events: function(index, itemdata, quizhelper) {\n      \n      var self = this;\n\n      self.controls.startbutton.on(\"click\", function(e) {\n        self.startSession();\n      });\n\n      self.controls.stopbutton.on(\"click\", function(e) {\n        self.stopSession();\n      });\n\n      // Push to talk button - currently hidden because we dont need it yet\n      self.controls.talkbutton.on(\"click\", function(e) {\n        self.pushToTalk();\n      });\n\n      self.controls.nextbutton.on('click', function(e) {\n        self.next_question();\n      });\n\n      $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n        if (itemdata.timelimit > 0) {\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                height: '5px',\n                timeLimit: itemdata.timelimit,\n                onFinish: function() {\n                    nextbutton.trigger('click');\n                }\n            });\n        }\n      });\n\n    },\n\n    init_voice: function(voice) {\n      var self = this;\n      var voices = ['alloy' , 'ash', 'ballad', 'coral', 'echo', 'sage', 'shimmer', 'verse'];\n      if (voice && voices.includes(voice)) {\n        self.audiochat_voice = voice;\n      } else {\n        self.audiochat_voice = 'alloy'; //default voice\n      }\n      log.debug(\"AudioChat voice set to:\", this.audiochat_voice);\n    },\n\n    init_controls: function() {\n        var self = this;\n        self.controls = {\n          //ml_audiochat_sessionpending_box\n          'sessionpending': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_audiochat_sessionpending_box\"),\n          'sessionactive': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_audiochat_sessionactive_box\"),\n          'startbutton': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_ac_start\"),\n          'stopbutton': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_ac_stop\"),\n          'talkbutton': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_ac_talk\"),\n          'studenttranscript': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_ac_studenttranscript\"),\n          'aitranscript': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_ac_aitranscript\"),\n          'hiddenaudio': $(\"#\" + self.itemdata.uniqueid + \"_container .ml_ac_hiddenaudio\"),\n          'nextbutton': $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\"),\n      };\n   },\n\n   waitForIceGathering: function(pc) {\n    return new Promise((resolve) => {\n      if (pc.iceGatheringState === \"complete\") resolve();\n      else {\n        function checkState() {\n          if (pc.iceGatheringState === \"complete\") {\n            pc.removeEventListener(\"icegatheringstatechange\", checkState);\n            resolve();\n          }\n        }\n        pc.addEventListener(\"icegatheringstatechange\", checkState);\n      }\n    });\n  },\n\n  sendEvent: function(obj) {\n    var self = this;\n    if (self.dc && self.dc.readyState === \"open\") {\n      self.dc.send(JSON.stringify(obj));\n    }\n  },\n\n  handleRTCEvent: function(msg) {\n    var self = this;\n    var aitranscript = self.controls.aitranscript[0];\n    var studenttranscript = self.controls.studenttranscript[0];\n    log.debug(\"Received event:\", msg);\n\n    switch (msg.type) {\n      case \"response.done\":\n        if(msg.response) {\n          if (msg.response.output && msg.response.output[0].content) {\n            const content = msg.response.output[0].content[0];\n            if (content.transcript) {\n              aitranscript.textContent += content.transcript + \"\\n\";\n            }\n          }\n        }\n        break;\n      case \"response.output_text.delta\":\n        aitranscript.textContent += msg.delta;\n        break;\n      case \"response.output_text.completed\":\n        aitranscript.textContent += \"\\n\";\n        break;\n      case \"conversation.item.input_audio_transcription.completed\":\n      case \"input_audio_buffer.speech_recognized\":\n        if (msg.transcript) studenttranscript.textContent += msg.transcript + \"\\n\";\n        break;\n    }\n  },\n\n  stopSession: function() {\n    var self = this;\n    log.debug(\"Session stopping...\");\n    var startBtn = self.controls.startbutton[0];\n    var stopBtn = self.controls.stopbutton[0];\n      // Close data channel if open\n      if (typeof self.dc !== 'undefined' && self.dc) {\n          self.dc.close();\n          self.dc = null;\n      }\n      // Close peer connection if open\n      if (typeof self.pc !== 'undefined' && self.pc) {\n          self.pc.close();\n          self.pc = null;\n      }\n      // Stop microphone stream if open\n      if (typeof self.micStream !== 'undefined' && self.micStream) {\n          self.micStream.getTracks().forEach(track => track.stop());\n          self.micStream = null;\n      }\n      startBtn.disabled = false;\n      stopBtn.disabled = true;\n      self.controls.sessionpending.hide();\n      self.controls.sessionactive.hide();\n      log.debug(\"Session stopped\");\n  },\n\n  startSession: async function() {\n    var self = this;\n    log.debug(\"Session starting\");\n    var startBtn = self.controls.startbutton[0];\n    var stopBtn = self.controls.stopbutton[0];\n    var talkBtn = self.controls.talkbutton[0];\n    var twoletterlang = self.itemdata.language.substr(0, 2);\n    var twoletternativelang = self.itemdata.audiochatnativelanguage.substr(0, 2);\n    var hiddenaudio = self.controls.hiddenaudio[0];\n    startBtn.disabled = true;\n\n    // Show the session pending box and hide the session active box\n    self.controls.sessionpending.show();\n    self.controls.sessionactive.hide();\n\n    //Open the RTC PeerConnection via Stun and ICE servers\n    log.debug(\"Opening peer connection...\");\n    self.pc = new RTCPeerConnection({ iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }] });\n\n    //Create a DataChannel for sending events (text and audio)\n    log.debug(\"creating data channel...\");\n    self.dc = self.pc.createDataChannel(\"oai-events\");\n    self.dc.onopen = () => {\n        log.debug(\"DataChannel open\");\n        // Set session-wide instructions\n        self.sendEvent({\n          type: \"session.update\",\n          session: {\n            instructions: self.itemdata.audiochatinstructions,\n            input_audio_format: \"pcm16\",  // Ensure correct audio encoding\n            input_audio_transcription: {\n              language: twoletterlang,\n              model: \"whisper-1\"//\"gpt-4o-mini-transcribe\"  // Use a transcription model\n            },\n            speed: 0.9,\n            voice: self.audiochat_voice,\n          }\n        });\n\n        //Send the first message to tell AI to say something\n        self.sendEvent({\n          type: \"response.create\",\n          response: {\n            modalities: [\"audio\", \"text\"],\n            instructions: \"Please introduce yourself to the student and explain todays topic.\",\n            audio: { voice: self.audiochat_voice }\n          }\n        });\n\n      };\n\n      // Handle incoming messages on the DataChannel\n      self.dc.onmessage = (e) => {\n        log.debug(\"DataChannel message:\", e.data);\n        try {\n          const lines = e.data.split(\"\\n\").filter(Boolean);\n          for (const line of lines) self.handleRTCEvent(JSON.parse(line));\n        } catch (err) { log.debug(\"Failed to parse\", err); }\n      };\n\n      // Set up the audio element to play incoming audio.\n      self.pc.ontrack = (event) => hiddenaudio.srcObject = event.streams[0];\n\n      // Set up the Mic stream.\n      self.micStream = await navigator.mediaDevices.getUserMedia({ audio: true });\n      self.micStream.getTracks().forEach((track) => self.pc.addTrack(track, self.micStream));\n\n      // Set up the RTC Connection by bouncing our request off the Moodle server\n      const offer = await self.pc.createOffer({ offerToReceiveAudio: true });\n      await self.pc.setLocalDescription(offer);\n      await self.waitForIceGathering(self.pc);\n\n      const sdpResponse = await fetch(M.cfg.wwwroot + \"/mod/minilesson/openairtc.php\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/sdp\" },\n        body: self.pc.localDescription.sdp\n      });\n      if (!sdpResponse.ok) {\n        log.debug(\"Failed /rtc:\", await sdpResponse.text());\n        return;\n      }\n      log.debug(\"Received SDP answer from server\");\n      log.debug(sdpResponse);\n      const answer = await sdpResponse.text();\n      log.debug(answer);\n      await self.pc.setRemoteDescription({ type: \"answer\", sdp: answer });\n\n      // Hide the session pending box and show the session active box\n      self.controls.sessionpending.hide();\n      self.controls.sessionactive.show();\n\n      // Enable the talk and buttons now that the session is ready\n      talkBtn.disabled = false;\n      stopBtn.disabled = false;\n\n      log.debug(\"Session started\");\n     \n    },\n\n // We dont really need this, the mic stream is active and sending audio\n  pushToTalk: function() {\n    var self = this;\n    if (self.dc && self.dc.readyState === \"open\") {\n      self.sendEvent({\n        type: \"response.create\",\n        response: {\n          modalities: [\"audio\", \"text\"],\n          audio: { voice: self.audiochat_voice }\n        }\n      });\n    }\n  }\n\n  }; // End of return object.\n});"],"names":["define","$","log","def","ttrecorder","templates","debug","controls","itemdata","index","quizhelper","pc","dc","micStream","audiochat_voice","clone","extend","this","init","init_controls","init_voice","register_events","next_question","stepdata","hasgrade","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","self","startbutton","on","e","startSession","stopbutton","stopSession","talkbutton","pushToTalk","nextbutton","uniqueid","timelimit","show","progressTimer","height","timeLimit","onFinish","trigger","voice","includes","waitForIceGathering","Promise","resolve","iceGatheringState","checkState","removeEventListener","addEventListener","sendEvent","obj","readyState","send","JSON","stringify","handleRTCEvent","msg","aitranscript","studenttranscript","type","response","output","content","transcript","textContent","delta","startBtn","stopBtn","close","getTracks","forEach","track","stop","disabled","sessionpending","hide","sessionactive","async","talkBtn","twoletterlang","language","substr","hiddenaudio","audiochatnativelanguage","RTCPeerConnection","iceServers","urls","createDataChannel","onopen","session","instructions","audiochatinstructions","input_audio_format","input_audio_transcription","model","speed","modalities","audio","onmessage","data","lines","split","filter","Boolean","line","parse","err","ontrack","event","srcObject","streams","navigator","mediaDevices","getUserMedia","addTrack","offer","createOffer","offerToReceiveAudio","setLocalDescription","sdpResponse","fetch","M","cfg","wwwroot","method","headers","body","localDescription","sdp","ok","text","answer","setRemoteDescription"],"mappings":"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"}