{"version":3,"sources":["../src/audiochat.js"],"names":["define","$","log","def","ttrecorder","templates","str","Fragment","Url","debug","autocreateresponse","gradingrequesttag","gradingData","strings","controls","itemdata","index","quizhelper","pc","dc","cantChat","audiochat_voice","isSessionStarted","isSessionStopped","isSessionActive","isLoading","isMicActive","isMicInitialized","loadingMessages","Set","audioContext","analyser","dataArray","sourceNode","mediaStream","animationFrameId","canvasCtx","eventlogs","items","responses","abortcontroller","AbortController","datainputbuffer","inputBufferInterval","semantic_vad","type","eagerness","timebased_vad","silence_duration_ms","create_response","interrupt_response","threshold","clone","extend","init","audiochat_autoresponse","canchat","init_strings","init_controls","init_voice","register_events","renderUI","self","get_strings","done","s","i","gradebywordcount","next_question","stepdata","hasgrade","lessonitemid","id","totalitems","totalmarks","resultsdata","Object","values","grade_activity","correctitems","Math","round","grade","do_next","count_words","userTranscript","forEach","item","content","push","wordCount","join","split","length","toggle_autocreate_response","send","JSON","stringify","session","turn_detection","wordcount","score","targetwordcount","aifeedback","feedback","gradeexplanation","countwords","min","startSessionBtn","addEventListener","startSession","bind","stopSessionBtn","stopSession","retrySessionBtn","resetSession","autocreateresponseCheckbox","cancelStartSessionBtn","abort","nextbutton","on","container","timelimit","find","show","progressTimer","height","timeLimit","onFinish","trigger","toggleMicBtn","toggleMute","voice","includes","document","getElementById","uniqueid","hiddenaudio","querySelector","cantChatWarning","loadingIndicator","aiAvatarSection","chatActiveMessage","conversationSection","messagesContainer","micButtonContainer","micWaveformCanvas","micSelect","finishMessage","resultscontainer","resultscontent","autocreateresponseToggle","clicktosendlabel","mainWrapper","sessionControls","itemtextAfterchatactive","micColumn","getContext","populateMicList","scrollToBottom","firstElementChild","scrollIntoViewIfNeeded","scrollTop","scrollHeight","scrollMicButtonIntoView","scrollIntoView","behavior","block","classList","toggle","endScreen","showitemreview","allowretry","mics","querySelectorAll","noshowmics","parentElement","disabled","orderedItems","idMap","Map","previousMap","currentItem","set","previous_item_id","get","innerHTML","message","messageDiv","createElement","className","usertype","contentDiv","headerDiv","pictureDiv","avatarimage","M","cfg","themerev","appendChild","textDiv","textContent","has","loaderDiv","remove","add","setDataInputBuffer","value","source","twoletterlang","language","substr","RTCPeerConnection","iceServers","urls","createDataChannel","onmessage","e","data","lines","filter","Boolean","line","handleRTCEvent","call","parse","err","onopen","audiochatinstructions","updateinstructions","loadFragment","contextid","itemid","studentsubmission","replace","audiochatgradeinstructions","sendEvent","instructions","audio","input","transcription","model","output","speed","output_modalities","response","ontrack","event","srcObject","streams","navigator","mediaDevices","getUserMedia","getTracks","track","enabled","addTrack","createOffer","offerToReceiveAudio","offer","setLocalDescription","waitForIceGathering","fetch","wwwroot","method","headers","body","localDescription","sdp","signal","sdpResponse","ok","text","answer","setRemoteDescription","name","close","stop","sendGradingRequest","gradingInstructions","responsedata","conversation","metadata","tag","max_output_tokens","clear","releaseMicResources","setTimeout","showResults","closeDataChannel","tdata","stars","maxStars","isNaN","filledStars","filled","yellow_starImgurl","imageUrl","gray_starImgurl","render","then","html","js","runTemplateJS","timeout","Promise","resolve","timer","checkState","iceGatheringState","clearTimeout","removeEventListener","obj","readyState","msg","jsonresponse","jsonextractregex","match","msgresponse_id","response_id","msgitem_id","item_id","stack","events","time","Date","now","toString","role","enableMic","delta","transcript","delete","disableMic","initializeMicStream","window","AudioContext","webkitAudioContext","createAnalyser","fftSize","bufferLength","frequencyBinCount","Uint8Array","createMediaStreamSource","success","disconnect","cancelAnimationFrame","clearRect","width","attempts","clearInterval","maxAttempts","setInterval","connect","drawWave","sender","getSenders","removeTrack","WIDTH","HEIGHT","requestAnimationFrame","getByteTimeDomainData","lineWidth","strokeStyle","beginPath","sliceWidth","x","v","y","moveTo","lineTo","stroke","enumerateDevices","devices","device","kind","select","uniqueMics","seenGroups","mic","groupId","option","deviceId","label","target","switchMic","exact","senders","audioTrack","getAudioTracks","audioSender","replaceTrack"],"mappings":"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","sourcesContent":["define(\n    ['jquery', 'core/log', 'mod_minilesson/definitions',\n        'mod_minilesson/ttrecorder', 'core/templates', 'core/str', 'core/fragment', 'core/url'],\n    function ($, log, def, ttrecorder, templates, str, Fragment, Url) {\n        \"use strict\"; // jshint ;_;\n\n        /*\n    This file is to manage the free speaking item type\n            */\n\n          log.debug('MiniLesson AudioChat: initialising');\n\n        return {\n            autocreateresponse : false, // If true, the response will be created automatically\n            gradingrequesttag: \"gradingrequest\", // Tag for the grading request\n            gradingData: false, // Data returne by the grading request\n            strings: {},\n            controls: {}, // Controls for the item\n            itemdata: {}, // Item data for the item\n            index: 0, // Index of the item in the quiz\n            quizhelper: {}, // Quiz helper for the item\n            pc: null,\n            dc: null,\n            cantChat: false,\n            audiochat_voice: \"alloy\", // Default voice for the AI\n            isSessionStarted: false,\n            isSessionStopped: false,\n            isSessionActive: false,\n            isLoading: false,\n            isMicActive: false,\n            isMicInitialized: false, // True when getUserMedia has successfully run once\n            loadingMessages: new Set(), // To track messages that are currently loading,\n            audioContext: null,\n            analyser: null,\n            dataArray: null,\n            sourceNode: null,\n            mediaStream: null,\n            animationFrameId: null,\n            canvasCtx: null,\n            eventlogs: [],\n            items: {},\n            responses: {},\n            abortcontroller: new AbortController(),\n            datainputbuffer: false,\n            inputBufferInterval: null,\n            //Turn detection - semantic is good for native speakers, but awful for language learners\n            // time based we give 3.5s of silence detection before posting\n            semantic_vad: {\n                type: \"semantic_vad\",\n                eagerness: \"low\",\n            },\n\n            timebased_vad: {\n                type: \"server_vad\",\n                silence_duration_ms: 3500,\n                create_response: true, // true = it will turn on and off the mic and respond\n                interrupt_response: true, // only in conversation mode\n                threshold: 0.3,\n                //  \"prefix_padding_ms\": 300,\n            },\n\n            // For making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                this.autocreateresponse = itemdata.audiochat_autoresponse || false;\n                log.debug('itemdata', itemdata);\n                this.quizhelper = quizhelper;\n                this.index = index;\n                this.cantChat = !itemdata.canchat;\n                this.init_strings();\n                this.init_controls(quizhelper, itemdata);\n                this.init_voice(itemdata.audiochat_voice);\n                this.register_events(index, itemdata, quizhelper);\n                this.renderUI();\n            },\n\n            init_strings: function () {\n                var self = this;\n                // Set up strings\n                str.get_strings([\n                    { \"key\": \"gradebywordcount\", \"component\": \"mod_minilesson\" },\n                ]).done(function (s) {\n                    var i = 0;\n                    self.strings.gradebywordcount = s[i++];\n                });\n            },\n\n            next_question: function () {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.lessonitemid = self.itemdata.id;\n                stepdata.totalitems = self.itemdata.totalmarks;\n                stepdata.resultsdata = {'items': Object.values(self.items)};\n                // Add grade and other results data\n                stepdata = self.grade_activity(stepdata);\n                stepdata.correctitems = Math.round((self.itemdata.totalmarks * stepdata.grade) / 100);\n                self.quizhelper.do_next(stepdata);\n            },\n\n            count_words: function () {\n                var self = this;\n                var userTranscript = [];\n                Object.values(self.items).forEach(item => {\n                    if (item.content) {\n                        userTranscript.push(item.content);\n                    }\n                });\n                var wordCount = userTranscript.join(' ').split(/\\s+/).length;\n                return wordCount;\n            },\n\n            toggle_autocreate_response: function () {\n                var self = this;\n                self.autocreateresponse = !self.autocreateresponse;\n                self.timebased_vad.create_response = self.autocreateresponse;\n                log.debug(\"Autocreate response toggled:\", self.autocreateresponse);\n                self.dc.send(JSON.stringify({\n                    type: \"session.update\",\n                    session: {\n                        turn_detection: self.timebased_vad,\n                    }\n                }));\n            },\n\n            grade_activity: function (stepdata) {\n                //loop through items and form a complete user transcript\n                var self = this;\n\n                //count words in the transcript\n                var wordcount = self.count_words();\n\n                if (self.gradingData && self.gradingData.score !== undefined) {\n                    log.debug(\"Using grading data from AI:\", self.gradingData);\n                    // If grading data is available, use it\n                    stepdata.grade = self.gradingData.score;\n\n                    //If target word count is greater then 0, we lower the grade if it is lower then that target word count\n                    if (typeof stepdata.grade === 'number' &&\n                        typeof wordcount === 'number' &&\n                        self.itemdata.targetwordcount > 0 &&\n                         wordcount < self.itemdata.targetwordcount) {\n                        stepdata.grade = Math.round(stepdata.grade * (wordcount / self.itemdata.targetwordcount));\n                    }\n\n\n                    stepdata.resultsdata.aifeedback = self.gradingData.feedback || \"\";\n                    stepdata.resultsdata.gradeexplanation = self.gradingData.gradeexplanation || \"\";\n                } else {\n                    //Otherwise we default to counting words\n                    log.debug(\"No grading data from AI: counting words\", self.gradingData);\n                    stepdata.resultsdata.gradeexplanation = self.strings.gradebywordcount;\n                    if (self.itemdata.countwords === false || self.itemdata.targetwordcount === 0) {\n                        stepdata.grade =  100;\n                    }\n\n\n\n                    // Calculate grade based on word count\n                    stepdata.grade = Math.min(wordcount / self.itemdata.targetwordcount, 1) * 100;\n                }\n\n                // return stepdata\n                return stepdata;\n\n            },\n\n            register_events: function (index, itemdata) {\n\n                var self = this;\n\n                // Event Listeners\n                self.controls.startSessionBtn.addEventListener(\"click\", self.startSession.bind(this));\n                self.controls.stopSessionBtn.addEventListener(\"click\", self.stopSession.bind(this));\n                self.controls.retrySessionBtn.addEventListener(\"click\", self.resetSession.bind(this));\n                self.controls.autocreateresponseCheckbox.addEventListener(\"change\", self.toggle_autocreate_response.bind(self));\n                self.controls.cancelStartSessionBtn.addEventListener(\"click\", () => {\n                    log.debug(\"Cancelling session start\");\n                    self.abortcontroller.abort();\n                    self.abortcontroller = new AbortController();\n                });\n\n                $(self.controls.nextbutton).on('click', function () {\n                    self.next_question();\n                });\n\n                var container = $(self.controls.container);\n                container.on('showElement', () => {\n                    if (itemdata.timelimit > 0) {\n                        container.find(\".progress-container\").show();\n                        container.find(\".progress-container i\").show();\n                        container.find(\".progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                self.controls.nextbutton.trigger('click');\n                            }\n                        });\n                    }\n                });\n\n\n                if (self.controls.toggleMicBtn) {\n                    self.controls.toggleMicBtn.addEventListener(\"click\", self.toggleMute.bind(self));\n                }\n            },\n\n            init_voice: function (voice) {\n                var self = this;\n                var voices = ['alloy', 'ash', 'ballad', 'coral', 'echo', 'sage', 'shimmer', 'verse', 'marin', 'cedar'];\n                if (voice && voices.includes(voice)) {\n                    self.audiochat_voice = voice;\n                } else {\n                    self.audiochat_voice = 'alloy'; // Default voice\n                }\n                log.debug(\"AudioChat voice set to:\", this.audiochat_voice);\n            },\n\n            init_controls: async function () {\n                var self = this;\n                var container = document.getElementById(self.itemdata.uniqueid + \"_container\");\n                self.controls = {\n                    hiddenaudio: container.querySelector('.ml_ac_hiddenaudio'),\n                    nextbutton: container.querySelector('.minilesson_nextbutton'),\n                    cantChatWarning: container.querySelector(\".ml_ac_cantchat\"),\n                    startSessionBtn: container.querySelector(\".ml_ac_start-session-btn\"),\n                    stopSessionBtn: container.querySelector(\".ml_ac_stop-session-btn\"),\n                    loadingIndicator: container.querySelector(\".ml_ac_loading-indicator\"),\n                    aiAvatarSection: container.querySelector(\".ml_ac_ai-avatar-section\"),\n                    chatActiveMessage: container.querySelector(\".ml_ac_chat-active-message\"),\n                    conversationSection: container.querySelector(\".ml_ac_conversation-section\"),\n                    messagesContainer: container.querySelector(\".ml_ac_messages-container\"),\n                    micButtonContainer: container.querySelector(\".mic-button-container\"),\n                    toggleMicBtn: container.querySelector(\".toggle-mic-btn\"),\n                    micWaveformCanvas: container.querySelector(\".mic-waveform-canvas\"),\n                    micSelect: container.querySelector('.ml_ac_micselect'),\n                    finishMessage: container.querySelector('.ml_ac_finished-message'),\n                    retrySessionBtn: container.querySelector('.ml_ac_retrybtn'),\n                    cancelStartSessionBtn: container.querySelector('.ml_ac_cancel-start-session-btn'),\n                    autocreateresponseCheckbox: container.querySelector('.ml_ac_autoresponse-checkbox'),\n                    resultscontainer: container.querySelector('.ml_ac_results_container'),\n                    resultscontent: container.querySelector('.ml_ac_results_content'),\n                    autocreateresponseToggle: container.querySelector('.ml_ac_autoresponse-toggle'),\n\n                    clicktosendlabel: container.querySelector('.ml_ac_clicktosend'),\n                    mainWrapper: container.querySelector('.minilesson_audiochat_box .ml_unique_mainwrapper'),\n                    sessionControls: container.querySelector('.ml_unique_sessioncontrols'),\n                    itemtextAfterchatactive: container.querySelector('.itemtext_afterchatactive'),\n                    micColumn: container.querySelector('.ml_ac_mic-column'),\n                };\n                self.canvasCtx = !self.controls.micWaveformCanvas ? null :\n                    self.controls.micWaveformCanvas.getContext(\"2d\");\n\n                // Initial render\n                await self.populateMicList();\n\n            },\n\n            scrollToBottom: function () {\n                var self = this;\n                self.controls.conversationSection.firstElementChild.scrollIntoViewIfNeeded();\n                self.controls.conversationSection.firstElementChild.scrollTop = self.controls.conversationSection.firstElementChild.scrollHeight;\n            },\n\n            scrollMicButtonIntoView: function () {\n                var self = this;\n                if (self.controls.micButtonContainer) {\n                    self.controls.micButtonContainer.scrollIntoView({behavior: \"smooth\", block: \"center\"});\n                }\n            },\n\n            renderUI: function () {\n                var self = this;\n                // Session Controls\n                self.controls.startSessionBtn.classList.toggle(\"hidden\", self.isSessionActive || self.isLoading || self.isSessionStarted || self.cantChat);\n                self.controls.cantChatWarning.classList.toggle(\"hidden\", !self.cantChat);\n                self.controls.loadingIndicator.classList.toggle(\"hidden\", !self.isLoading);\n                self.controls.stopSessionBtn.classList.toggle(\"hidden\", !self.isSessionActive);\n                self.controls.micButtonContainer.classList.toggle(\"hidden\", !self.isSessionActive);\n                var endScreen = self.isSessionStarted && self.isSessionStopped;\n                self.controls.resultscontainer.classList.toggle(\"hidden\", !endScreen && self.quizhelper.showitemreview);\n                self.controls.finishMessage.classList.toggle(\"hidden\", !endScreen);\n                self.controls.retrySessionBtn.classList.toggle(\"hidden\", !endScreen && self.itemdata.allowretry);\n                // We no longer show the cancel button. It does not work after changes we made to icegathering.\n                // If we set abortcontroller.signal to work with it will work, but it is complex\n                //self.controls.cancelStartSessionBtn.classList.toggle('hidden', !(self.isLoading && !self.isSessionActive));\n                self.controls.autocreateresponseToggle.classList.toggle(\"hidden\", !self.isSessionActive);\n                if (self.controls.micSelect) {\n                    //how many options are in micselect\n                    var mics = self.controls.micSelect.querySelectorAll('option');\n                    var noshowmics = mics.length < 2;\n                    self.controls.micSelect.parentElement.classList.toggle(\n                        'hidden',\n                        noshowmics || self.isSessionStarted || self.isLoading || self.controls.micSelect.disabled\n                    );\n                }\n\n                var orderedItems = [];\n                var idMap = new Map();\n                var previousMap = new Map();\n                var currentItem;\n                Object.values(self.items).forEach(item => {\n                    idMap.set(item.id, item);\n                    previousMap.set(item.previous_item_id, item);\n                    if (item.previous_item_id === null) {\n                        currentItem = item;\n                    }\n                });\n                while (currentItem) {\n                    orderedItems.push(currentItem);\n                    currentItem = previousMap.get(currentItem.id);\n                }\n\n                // The cute dog avatar\n                self.controls.aiAvatarSection.classList.toggle(\"hidden\", self.isSessionStarted || self.isSessionActive || self.isSessionStopped);\n                // The conversation area\n                self.controls.conversationSection.classList.toggle(\"hidden\", !(self.isSessionActive || self.isSessionStopped));\n\n                self.controls.sessionControls.classList.toggle('hidden', self.isSessionStarted || self.isSessionActive || self.isSessionStopped);\n                if (self.controls.itemtextAfterchatactive) {\n                    self.controls.itemtextAfterchatactive.classList.toggle('hidden', !(self.isSessionActive || self.isSessionStopped));\n                }\n                self.controls.micColumn.classList.toggle('hidden', !self.isSessionActive);\n\n                // Render messages\n                self.controls.messagesContainer.innerHTML = \"\"; // Clear existing messages\n\n                orderedItems.forEach((message) => {\n                    if (!message.content) {\n                        return;\n                    }\n                    var messageDiv = document.createElement(\"div\");\n                    messageDiv.className = `ml_unique_ordered_message_${message.usertype === \"user\" ? \"user\" : \"assistant\"}`;\n\n                    var contentDiv = document.createElement(\"div\");\n                    contentDiv.className = `rounded-lg ${\n                            message.usertype === \"user\" ? \"bg-blue-500 text-white\" : \"bg-gray-200 text-gray-800\"\n                    } ml_unique_content_${\n                        message.usertype === \"user\" ? \"user\" : \"assistant\"\n                    }`;\n\n                    var headerDiv = document.createElement(\"div\");\n                    headerDiv.className = \"mb-1 ml_unique_headerdiv\";\n                    if (message.usertype === \"assistant\") {\n                        var pictureDiv = document.createElement('div');\n                        pictureDiv.innerHTML = `\n                            <img src=\"${self.itemdata.avatarimage}?themerev=${M.cfg.themerev}\"\n                            alt=\"AI Assistant\" class=\"mr-2 rounded-circle shadow-lg ml_unique_assistant_img\">\n                            `;\n                        headerDiv.appendChild(pictureDiv);\n                    }\n                    headerDiv.innerHTML += message.usertype === \"user\" ? \"Student\" : \"AI Assistant\";\n                    contentDiv.appendChild(headerDiv);\n\n                    var textDiv = document.createElement(\"div\");\n                    textDiv.className = \"ml_unique_textsmall\";\n                    textDiv.textContent = message.content;\n                    contentDiv.appendChild(textDiv);\n\n                    if (self.loadingMessages.has(message.id)) {\n                        var loaderDiv = document.createElement(\"div\");\n                        loaderDiv.className = \"py-1 message-loader ml_unique_loadingmessage\";\n                        loaderDiv.innerHTML = `\n                            <div class=\"ml_unique_loader\">\n                                <div class=\"ml_unique_loader_dot\"></div>\n                                <div class=\"ml_unique_loader_dot\"></div>\n                                <div class=\"ml_unique_loader_dot\"></div>\n                            </div>\n                            <span class=\"ml_unique_loader_text\">AI is thinking...</span>\n                        `;\n                        contentDiv.appendChild(loaderDiv);\n                    }\n\n                    messageDiv.appendChild(contentDiv);\n                    self.controls.messagesContainer.appendChild(messageDiv);\n                });\n\n                self.scrollToBottom();\n               // self.scrollMicButtonIntoView();\n\n                // Update mic button container and canvas visibility\n                if (self.controls.micButtonContainer) {\n                    self.controls.micButtonContainer.classList.toggle(\"active\", self.isMicActive);\n                    self.controls.micButtonContainer.classList.toggle(\"bg-blue-500\", self.isMicActive); // Active background color\n                    self.controls.micButtonContainer.classList.toggle(\"text-white\", self.isMicActive); // Active icon color\n                    self.controls.micButtonContainer.classList.toggle(\"bg-gray-200\", !self.isMicActive); // Inactive background color\n                    self.controls.micButtonContainer.classList.toggle(\"text-gray-800\", !self.isMicActive); // Inactive icon color\n                }\n\n\n                if (self.controls.micWaveformCanvas) {\n                    self.controls.micWaveformCanvas.classList.toggle(\"active\", self.isMicActive);\n                }\n\n                if (self.controls.toggleMicBtn) {\n                    // Set icon based on mic state\n                    self.controls.toggleMicBtn.innerHTML = self.isMicActive\n                    ? `<svg id=\"mic-icon\" class=\"mic-icon mic-icon-svg ml_unique_micsvg\" xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\">\n  <rect id=\"primary\" x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"2\" style=\"fill: rgb(0, 0, 0);\"/>\n</svg>\n` // Mic On icon\n                    : `<svg width=\"48\" height=\"48\" viewBox=\"0 0 59 59\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\">\n  <g filter=\"url(#filter0_d_2299_874)\">\n    <circle cx=\"29.2834\" cy=\"27.2834\" r=\"23.2834\" fill=\"#5067FF\"/>\n  </g>\n  <rect x=\"25.641\" y=\"16.3383\" width=\"7.28658\" height=\"13.0053\" rx=\"3.64329\" stroke=\"white\" stroke-width=\"1.7\"/>\n  <path d=\"M37.0438 25.7002C37.0438 29.9866 33.569 33.4613 29.2826 33.4613C24.9963 33.4613 21.5215 29.9866 21.5215 25.7002\" stroke=\"white\" stroke-width=\"1.7\" stroke-linecap=\"round\"/>\n  <path d=\"M29.2832 37.138V33.8701\" stroke=\"white\" stroke-width=\"1.7\"/>\n  <path d=\"M25.6074 37.5459H32.9601\" stroke=\"white\" stroke-width=\"1.7\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>\n  <defs>\n    <filter id=\"filter0_d_2299_874\" x=\"0\" y=\"0\" width=\"58.5664\" height=\"58.5664\" filterUnits=\"userSpaceOnUse\" color-interpolation-filters=\"sRGB\">\n      <feFlood flood-opacity=\"0\" result=\"BackgroundImageFix\"/>\n      <feColorMatrix in=\"SourceAlpha\" type=\"matrix\" values=\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0\" result=\"hardAlpha\"/>\n      <feOffset dy=\"2\"/>\n      <feGaussianBlur stdDeviation=\"3\"/>\n      <feComposite in2=\"hardAlpha\" operator=\"out\"/>\n      <feColorMatrix type=\"matrix\" values=\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.22 0\"/>\n      <feBlend mode=\"normal\" in2=\"BackgroundImageFix\" result=\"effect1_dropShadow_2299_874\"/>\n      <feBlend mode=\"normal\" in=\"SourceGraphic\" in2=\"effect1_dropShadow_2299_874\" result=\"shape\"/>\n    </filter>\n  </defs>\n</svg>\n`; // Mic Off icon\n                }\n\n                //show or not show clicktosendlabel\n                if (self.isMicActive && !self.autocreateresponse) {\n                    self.controls.clicktosendlabel.classList.remove(\"hidden\");\n                } else {\n                    self.controls.clicktosendlabel.classList.add(\"hidden\");\n                }\n\n            },\n\n            //setter for datainputbuffer\n            setDataInputBuffer: function (value, source) {\n                var self=this;\n                self.datainputbuffer = value;\n                log.debug(\"Data in input buffer set to:\", value);\n                log.debug(\"Data input buffer set source:\", source);\n            },\n\n            resetSession: function () {\n                log.debug(\"reset  session\");\n                var self = this;\n                self.isLoading = false;\n                self.isSessionActive = false;\n                self.isSessionStopped = false;\n                self.isSessionStarted = false;\n                self.renderUI();\n            },\n\n            startSession: async function () {\n                var self = this;\n                var twoletterlang = self.itemdata.language.substr(0, 2);\n                var hiddenaudio = self.controls.hiddenaudio;\n                log.debug(\"Session starting\");\n                self.isLoading = true;\n                self.items = [];\n                self.renderUI();\n                // Open the RTC PeerConnection via Stun and ICE servers\n                log.debug(\"Opening peer connection...\");\n                self.pc = new RTCPeerConnection({\n                    iceServers: [{\n                        urls: \"stun:stun.l.google.com:19302\"\n                    }]\n                });\n\n                // Create a DataChannel for sending events (text and audio)\n                log.debug(\"creating data channel...\");\n                self.dc = self.pc.createDataChannel(\"oai-events\");\n\n                // Handle incoming messages on the DataChannel\n                self.dc.onmessage = (e) => {\n                    self.eventlogs.push(e.data);\n                    //log.debug(\"DataChannel message:\", e.data);\n                    try {\n                        var lines = e.data.split(\"\\n\").filter(Boolean);\n                        for (var line of lines) {\n                            self.handleRTCEvent.call(self, JSON.parse(line));\n                        }\n                    } catch (err) {\n                        log.debug(\"Failed to parse\");\n                        log.debug(err);\n                    }\n                };\n                self.dc.onopen = () => {\n                    log.debug(\"DataChannel open\");\n\n                    //Turn detection - semantic is good for native speakers, but awful for language learners\n                    // time based we give 1.5s of silence detection before posting\n                    // var semantic_vad = {\n                    //     type: \"semantic_vad\",\n                    //     eagerness: \"low\",\n                    // };\n\n                    // Set the auto turn detection, or manual submit flag\n                    self.timebased_vad.create_response = self.autocreateresponse;\n\n                    log.debug(self.itemdata.audiochatinstructions);\n                    var updateinstructions = self.itemdata.audiochatinstructions;\n                    Fragment.loadFragment(\n                        'mod_minilesson',\n                        'audiochat_fetchstudentsubmission',\n                        M.cfg.contextid,\n                        {\n                            itemid: self.itemdata.id\n                        }\n                    ).done(function (studentsubmission) {\n                        log.debug(\"Loaded audio chat studentsubmission:\", studentsubmission);\n                        if (studentsubmission) {\n                            // Replace \"{student submission}\" placeholder with actual submission\n                            updateinstructions = updateinstructions.replace('{student submission}', studentsubmission);\n\n                            // Replace student submission in grade instructions too\n                            self.itemdata.audiochatgradeinstructions = self.itemdata.audiochatgradeinstructions.replace('{student submission}', studentsubmission);\n\n                            // Save student submission in itemdata for later use\n                            self.itemdata.studentsubmission = studentsubmission;\n                        }\n\n                        self.sendEvent({\n                            type: \"session.update\",\n                            session: {\n                                type: 'realtime',\n                                instructions: updateinstructions,\n                                audio: {\n                                    input: {\n                                        transcription: {\n                                            language: twoletterlang,\n                                            model: \"whisper-1\" // \"gpt-4o-mini-transcribe\"  // Use a transcription model\n                                        },\n                                        turn_detection: self.timebased_vad,\n                                    },\n                                    output: {\n                                        speed: 0.9,\n                                        voice: self.audiochat_voice,\n                                    }\n                                },\n                                output_modalities: [\"audio\"],\n                            }\n                        });\n\n                        // Send the first message to tell AI to say something\n                        // the response create function overrides the session instructions, so we need to double up here\n                        var firstmessageinstructions =  \"Please introduce yourself to the student and explain todays topic.\";\n                        self.sendEvent({\n                            type: \"response.create\",\n                            response: {\n                                output_modalities: [\"audio\"],\n                                instructions:  updateinstructions + \" \" + firstmessageinstructions,\n                                audio: {\n                                    output: {\n                                        voice: self.audiochat_voice,\n                                    },\n                                },\n                            }\n                        });\n                    });\n                };\n\n                // Set up the audio element to play incoming audio.\n                self.pc.ontrack = (event) => {\n                    hiddenaudio.srcObject = event.streams[0];\n                };\n\n                // Set up the Mic stream.\n                self.mediaStream = await navigator.mediaDevices.getUserMedia({audio: true});\n                self.mediaStream.getTracks().forEach((track) => {\n                    track.enabled = false;\n                    self.pc.addTrack(track, self.mediaStream);\n                });\n\n                // Set up the RTC Connection by bouncing our request off the Moodle server\n                var offer = await self.pc.createOffer({\n                    offerToReceiveAudio: true\n                });\n                await self.pc.setLocalDescription(offer);\n                // Search for server candidates for relaying messages, may take 15s\n                await self.waitForIceGathering(self.pc);\n\n                try {\n                    var sdpResponse = await fetch(M.cfg.wwwroot + \"/mod/minilesson/openairtc.php\", {\n                        method: \"POST\",\n                        headers: {\n                            \"Content-Type\": \"application/sdp\"\n                        },\n                        body: self.pc.localDescription.sdp,\n                        signal: self.abortcontroller.signal\n                    });\n                    if (!sdpResponse.ok) {\n                        log.debug(\"Failed /rtc:\", await sdpResponse.text());\n                        return;\n                    }\n                    log.debug(\"Received SDP answer from server\");\n                    var answer = await sdpResponse.text();\n                    log.debug(answer);\n                    await self.pc.setRemoteDescription({\n                        type: \"answer\",\n                        sdp: answer\n                    });\n                    log.debug(\"Session started\");\n                } catch (e) {\n                    log.debug(e, 'connect error');\n                    if (e.name === 'AbortError') {\n                        log.debug(\"Session start aborted by user.\");\n                        // Reset UI and state as needed\n                        self.isLoading = false;\n                        self.renderUI();\n                        return;\n                    }\n\n                    // Close data channel if open\n                    if (self.dc) {\n                        self.dc.close();\n                    }\n                    // Close peer connection if open\n                    if (self.pc) {\n                        self.pc.close();\n                    }\n                    if (self.mediaStream) {\n                        self.mediaStream.getTracks().forEach((track) => track.stop());\n                    }\n                    self.isLoading = false;\n                    self.renderUI();\n                    return;\n                }\n\n                self.isLoading = false;\n                self.isSessionActive = true;\n                self.isSessionStarted = true;\n                self.isSessionStopped = false;\n                self.renderUI();\n            },\n\n            sendGradingRequest: function () {\n                var self = this;\n                // Send a final message to tell AI to grade the session and give feedback\n                var gradingInstructions = \"Please provide a percentage score for the session, an explanation of the score (for teachers), and feedback (for the student). \" +\n                     self.itemdata.audiochatgradeinstructions +\n                    \"Return the response as JSON in the format: {\\\"score\\\": \\\"the score  ( 0-100 ) \\\", \\\"gradeexplanation\\\": \\\"the explanation\\\", \\\"feedback\\\": \\\"the feedback\\\"}.\";\n\n                var responsedata = {\n                    // The response is out of band and not be added to the default conversation\n                    conversation: \"none\",\n                    output_modalities: [\"text\"],\n                    instructions: gradingInstructions,\n                    // Add the gradingrequest tag to make handltertc life easier\n                    metadata: { tag: self.gradingrequesttag},\n                    max_output_tokens: 500, // Keeps it tight\n                    // temperature: 0.6, // Optional: makes grading more deterministic\n                };\n\n                //If we wanted to reutrn an audio response (but lets not)\n                //responsedata.voice = self.audiochat_voice;\n\n                self.sendEvent({\n                    type: \"response.create\",\n                    response: responsedata,\n                });\n            },\n\n            stopSession: function () {\n                var self = this;\n\n                log.debug(\"Session stopping...\");\n                self.isSessionActive = false;\n                self.isSessionStopped = true;\n                self.loadingMessages.clear();\n\n                // Release mic resources when session ends\n                self.releaseMicResources();\n                self.renderUI();\n\n                // request grading information\n                // after that response, we will close the data channel and peer connection\n                //but shut it down after 2s just in case there is an error or something\n                if (self.itemdata.audiochatgradeinstructions && self.itemdata.audiochatgradeinstructions !== \"\") {\n                    self.sendGradingRequest();\n\n                    //add a spinner to the results content\n                    //if we are not showing item review we do not need this, but in that case it is hidden anyway\n                    self.controls.resultscontent.innerHTML = `<i class=\"fa fa-spinner fa-spin fa-2x\"></i>`;\n\n                    setTimeout(() => {\n                        //now show the results content if that is what we are doing\n                        if (self.quizhelper.showitemreview) {\n                            self.showResults();\n                        }\n                        log.debug(\"Closing session resources...\");\n                        self.closeDataChannel();\n                    }, 7000);\n                } else {\n                    log.debug(\"Closing session resources...\");\n                    self.closeDataChannel();\n                }\n                log.debug(\"Session stopped\");\n            },\n\n            closeDataChannel: function () {\n                var self = this;\n                // Tidy up the data channel and peer connection\n                if (typeof self.dc !== 'undefined' && self.dc) {\n                    self.dc.close();\n                    self.dc = null;\n                }\n                if (typeof self.pc !== 'undefined' && self.pc) {\n                    self.pc.close();\n                    self.pc = null;\n                }\n            },\n\n            showResults: function () {\n                var self = this;\n                var tdata = {};\n                tdata.resultsdata = {'items': Object.values(self.items)};\n                // Add grade and other results data\n                tdata = self.grade_activity(tdata);\n\n                //calculate stars from grade\n                const stars = [];\n                const maxStars = 5;\n                // if tdata grade is NAn or undefined, set it to 0\n                if (typeof tdata.grade === 'undefined' || isNaN(tdata.grade) || tdata.grade === null || tdata.grade === \"\") {\n                    tdata.grade = 0;\n                }\n\n                const filledStars = Math.round((tdata.grade / 100) * maxStars);\n                for (let i = 0; i < maxStars; i++) {\n                    stars.push({ filled: i < filledStars });\n                }\n                tdata.stars = stars;\n                tdata.yellow_starImgurl = Url.imageUrl('yellow_star', 'mod_minilesson');\n                tdata.gray_starImgurl = Url.imageUrl('gray_star', 'mod_minilesson');\n\n                templates.render('mod_minilesson/audiochatimmediatefeedback', tdata).then(\n                    function (html, js) {\n                        self.controls.resultscontent.innerHTML = html;\n                        templates.runTemplateJS(js);\n                    }\n                );\n            },\n\n            waitForIceGathering: function (pc, timeout = 15000) {\n                return new Promise((resolve) => {\n                    let timer;\n\n                    function checkState()\n                    {\n                        if (pc.iceGatheringState === \"complete\") {\n                            clearTimeout(timer);\n                            pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                            resolve();\n                        }\n                    }\n\n                    pc.addEventListener(\"icegatheringstatechange\", checkState);\n\n                    // Timeout to resolve with current state\n                    timer = setTimeout(() => {\n                        pc.removeEventListener(\"icegatheringstatechange\", checkState);\n                        resolve(); // Resolve with as many candidates as gathered so far\n                    }, timeout);\n                });\n            },\n\n            sendEvent: function (obj) {\n                var self = this;\n                if (self.dc && self.dc.readyState === \"open\") {\n                    self.dc.send(JSON.stringify(obj));\n                }\n            },\n\n            handleRTCEvent: function (msg) {\n                var self = this;\n                log.debug(\"Received event:\");\n                log.debug(msg);\n\n                // Check if its the final grading message, which we don't want to enter \"items\"\n                if (msg.type === \"response.done\" &&\n                    msg.response.metadata?.tag === self.gradingrequesttag) {\n                    // Check if the response corresponds to the grading event\n                    log.debug(\"It is a grading event:\");\n                    try {\n                        var jsonresponse = msg.response.output[0].content[0].text;\n                        const jsonextractregex = /\\{[\\s\\S]*?\\}/;\n                        if (!jsonresponse || jsonresponse === \"\" || !jsonresponse.match(jsonextractregex)) {\n                            log.debug(\"No valid grading data received .. msg is ..\");\n                            log.debug(msg);\n                            self.closeDataChannel();\n                            return;\n                        }\n\n                        self.gradingData = JSON.parse(jsonresponse.match(jsonextractregex)[0]);\n                        log.debug(\"Grading and Feedback:\", self.gradingData);\n                    } catch (err) {\n                        self.gradingData = false;\n                        log.debug(\"Failed to parse grading feedback:\", err);\n                        log.debug(jsonresponse);\n                    }\n                        return;\n                }\n\n                // log.debug(msg);\n                var msgresponse_id = msg.response ? msg.response.id : msg.response_id;\n                var msgitem_id = msg.item ? msg.item.id : msg.item_id;\n                if (msgresponse_id) {\n                    self.responses[msgresponse_id] = self.responses[msgresponse_id] || {\n                        id: msgresponse_id,\n                        itemid: msgitem_id,\n                        stack: []\n                    };\n                }\n                if (msgitem_id) {\n                    if (typeof self.items[msgitem_id] === 'undefined') {\n                        self.scrollToBottom();\n                    }\n                    self.items[msgitem_id] = self.items[msgitem_id] || {\n                        id: msgitem_id,\n                        events: [],\n                        responses: null,\n                        content: ''\n                    };\n                    if (msgresponse_id) {\n                        self.items[msgitem_id].responses = self.responses[msgresponse_id];\n                    }\n                }\n\n                msg.time = Date.now().toString();\n\n                switch (msg.type) {\n                    case \"response.created\": {\n        /*```\n    {\n    \"type\": \"response.created\",\n    \"event_id\": \"event_Bzbmm1vOdUpYK5LcKMPAU\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"in_progress\",\n        \"status_details\": null,\n        \"output\": [],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": null,\n        \"metadata\": null\n    }\n    }\n        ```*/\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_item.added\": {\n        /*```\n    {\n    \"type\": \"response.output_item.added\",\n    \"event_id\": \"event_BzbmnNUVJeqok4KqSLSVl\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.added\":\n                    case \"conversation.item.created\": {\n        /*```\n    {\n    \"type\": \"conversation.item.created\",\n    \"event_id\": \"event_BzbmnttqDhvU3h2he1tK7\",\n    \"previous_item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"in_progress\",\n        \"role\": \"assistant\",\n        \"content\": []\n    }\n    }\n        ```*/\n                        self.items[msg.item.id].previous_item_id = msg.previous_item_id;\n                        self.items[msg.item.id].usertype = msg.item.role;\n                        self.items[msg.item.id].events.push(msg);\n                        if (msg.item.role === 'assistant') {\n                            self.loadingMessages.add(msgitem_id);\n                        }\n                        break;\n                    }\n                    case \"response.content_part.added\": {\n        /*```\n    {\n    \"type\": \"response.content_part.added\",\n    \"event_id\": \"event_Bzbmn7lA1i7fOfFq8ju3F\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"\"\n    }\n    }\n        ```*/\n                        self.enableMic();// Let's enable mic\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_audio_transcript.delta\":\n                    case \"response.audio_transcript.delta\": {\n        /*```\n    {\n    \"type\": \"response.audio_transcript.delta\",\n    \"event_id\": \"event_BzbmnpxUmLA0zAnR5mRy3\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"delta\": \"Hi\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.items[msg.item_id].content += msg.delta;\n                        break;\n                    }\n\n                    case \"output_audio_buffer.cleared\": {\n        /*```\n    {\n    \"type\": \"output_audio_buffer.cleared\",\n    \"event_id\": \"event_f7273193069b4938\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_audio.done\":\n                    case \"response.audio.done\": {\n        /*```\n    {\n    \"type\": \"response.audio.done\",\n    \"event_id\": \"event_Bzbmn7aEtTnprkzqE9i6X\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_audio_transcript.done\":\n                    case \"response.audio_transcript.done\": {\n        /*```\n    {\n    \"type\": \"response.audio_transcript.done\",\n    \"event_id\": \"event_BzbmnNGRs7797nz1Qh7em\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.items[msg.item_id].content = msg.transcript;\n                        break;\n                    }\n                    case \"response.content_part.done\": {\n        /*```\n    {\n    \"type\": \"response.content_part.done\",\n    \"event_id\": \"event_BzbmnYdAvAKMU7ti311Vj\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"output_index\": 0,\n    \"content_index\": 0,\n    \"part\": {\n        \"type\": \"audio\",\n        \"transcript\": \"Hi! How are you today? What did you do today?\"\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"response.output_item.done\": {\n        /*```\n    {\n    \"type\": \"response.output_item.done\",\n    \"event_id\": \"event_BzbmnhD5RdLxAOnko94Z1\",\n    \"response_id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n    \"output_index\": 0,\n    \"item\": {\n        \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n        \"object\": \"realtime.item\",\n        \"type\": \"message\",\n        \"status\": \"incomplete\",\n        \"role\": \"assistant\",\n        \"content\": [\n            {\n                \"type\": \"audio\",\n                \"transcript\": \"Hi! How are you today? What did you do today?\"\n            }\n        ]\n    }\n    }\n        ```*/\n                        self.responses[msg.response_id].stack.push(msg);\n                        self.loadingMessages.delete(msg.item.id);\n                        break;\n                    }\n                    case \"response.done\": {\n        /*```\n    {\n    \"type\": \"response.done\",\n    \"event_id\": \"event_Bzbmn8bIaGB59d6qG7LQS\",\n    \"response\": {\n        \"object\": \"realtime.response\",\n        \"id\": \"resp_BzbmmfvbvyUuYz2hvigPm\",\n        \"status\": \"cancelled\",\n        \"status_details\": {\n            \"type\": \"cancelled\",\n            \"reason\": \"turn_detected\"\n        },\n        \"output\": [\n            {\n                \"id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n                \"object\": \"realtime.item\",\n                \"type\": \"message\",\n                \"status\": \"incomplete\",\n                \"role\": \"assistant\",\n                \"content\": [\n                    {\n                        \"type\": \"audio\",\n                        \"transcript\": \"Hi! How are you today? What did you do today?\"\n                    }\n                ]\n            }\n        ],\n        \"conversation_id\": \"conv_BzbmjU4iAZBReV6QpTbKH\",\n        \"modalities\": [\n            \"audio\",\n            \"text\"\n        ],\n        \"voice\": \"alloy\",\n        \"output_audio_format\": \"pcm16\",\n        \"temperature\": 0.8,\n        \"max_output_tokens\": \"inf\",\n        \"usage\": {\n            \"total_tokens\": 170,\n            \"input_tokens\": 94,\n            \"output_tokens\": 76,\n            \"input_token_details\": {\n                \"text_tokens\": 87,\n                \"audio_tokens\": 7,\n                \"cached_tokens\": 0,\n                \"cached_tokens_details\": {\n                    \"text_tokens\": 0,\n                    \"audio_tokens\": 0\n                }\n            },\n            \"output_token_details\": {\n                \"text_tokens\": 23,\n                \"audio_tokens\": 53\n            }\n        },\n        \"metadata\": null\n    }\n    }\n        ```*/\n                        self.responses[msg.response.id].stack.push(msg);\n                        break;\n                    }\n                    case \"output_audio_buffer.stopped\": {\n        /*```\n    {\n    \"type\":\"output_audio_buffer.stopped\",\n    \"event_id\":\"event_0ebd8495b5a945e5\",\n    \"response_id\":\"resp_C17PJbWxcyg7tgQBVTAaL\"\n    }\n        ```*/\n                        if (!self.isMicActive) {\n                            self.toggleMute();\n                        }\n                        self.responses[msg.response_id].stack.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.truncated\": {\n        /*```\n    {\n    \"type\": \"conversation.item.truncated\",\n    \"event_id\": \"event_BzbmnGqfHdq1hy2Wr2fnA\",\n    \"item_id\": \"item_BzbmmIsy7p3YZXC9HroUp\",\n    \"content_index\": 0,\n    \"audio_end_ms\": 261\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    // User events.\n                    case \"input_audio_buffer.speech_started\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.speech_started\",\n    \"event_id\": \"event_Bzbmm9FJ5oCTmCpng9tem\",\n    \"audio_start_ms\": 820,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/\n                        log.debug(\"Input audio buffer speech started\");\n                        self.setDataInputBuffer(true, 'audiobufferstarted');\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"input_audio_buffer.speech_stopped\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.speech_stopped\",\n    \"event_id\": \"event_BzbmmUgLX2JKgJr1eMx0l\",\n    \"audio_end_ms\": 1568,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/\n                        if (self.isMicActive) {\n                            // Only auto-toggle mic if autocreateresponse is true\n                            if (self.autocreateresponse) {\n                                self.toggleMute();\n                                self.disableMic();\n                            }\n                        }\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"input_audio_buffer.committed\": {\n        /*```\n    {\n    \"type\": \"input_audio_buffer.committed\",\n    \"event_id\": \"event_BzbmmOICFLRU8vnGEJ6vM\",\n    \"previous_item_id\": null,\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\"\n    }\n        ```*/               log.debug(\"Input audio buffer committed\");\n                        self.setDataInputBuffer(false, 'audiobuffercommitted');\n                        self.items[msg.item_id].events.push(msg);\n                        break;\n                    }\n                    case \"conversation.item.input_audio_transcription.delta\": {\n        /*```\n    {\n    \"type\": \"conversation.item.input_audio_transcription.delta\",\n    \"event_id\": \"event_BzbmonQuYXZ7QxUCOLlZd\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"delta\": \"Hey.\"\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        self.items[msg.item_id].content += msg.delta;\n                        break;\n                    }\n                    case \"conversation.item.input_audio_transcription.completed\": {\n        /*```\n    {\n    \"type\": \"conversation.item.input_audio_transcription.completed\",\n    \"event_id\": \"event_BzbmotVIjHphgHjViNkZk\",\n    \"item_id\": \"item_BzbmmcBxU60HVn8xvCWA2\",\n    \"content_index\": 0,\n    \"transcript\": \"Hey.\",\n    \"usage\": {\n        \"type\": \"duration\",\n        \"seconds\": 1\n    }\n    }\n        ```*/\n                        self.items[msg.item_id].events.push(msg);\n                        self.items[msg.item_id].content = msg.transcript;\n                        self.loadingMessages.delete(msg.item_id);\n                        break;\n                    }\n                }\n                self.renderUI();\n            },\n\n            enableMic: function () {\n                var self = this;\n                if (self.controls.toggleMicBtn) {\n                    log.debug('Enabling mic');\n                    self.controls.toggleMicBtn.parentElement.classList.remove('disabled');\n                }\n            },\n\n            disableMic: function () {\n                var self = this;\n                if (self.controls.toggleMicBtn) {\n                    log.debug('Disabling mic');\n                    self.controls.toggleMicBtn.parentElement.classList.add('disabled');\n                }\n            },\n\n            initializeMicStream: async function () {\n                var self = this;\n                try {\n                    self.audioContext = new(window.AudioContext || window.webkitAudioContext)();\n                    self.analyser = self.audioContext.createAnalyser();\n                    self.analyser.fftSize = 2048;\n                    const bufferLength = self.analyser.frequencyBinCount;\n                    self.dataArray = new Uint8Array(bufferLength);\n\n                    self.sourceNode = self.audioContext.createMediaStreamSource(self.mediaStream);\n                    // Source is connected/disconnected in toggleMute\n                    self.isMicInitialized = true;\n                    return true;\n                } catch (err) {\n                    log.debug(\"Error accessing microphone:\", err);\n                    self.isMicInitialized = false;\n                    log.debug(\"Could not access microphone. Please ensure it's connected and permissions are granted.\");\n                    return false;\n                }\n            },\n\n            // Toggles mute/unmute state of the mic\n            toggleMute: async function () {\n                var self = this;\n                if (!self.isMicInitialized) {\n                    const success = await self.initializeMicStream();\n                    if (!success) {\n                        return;\n                    } // If initialization failed, stop here\n                }\n\n                if (self.isMicActive) {\n                    // Mute mic: Disconnect source from analyser\n                    if (self.sourceNode && self.analyser) {\n                        self.sourceNode.disconnect(self.analyser);\n                    }\n                    if (self.animationFrameId) {\n                        cancelAnimationFrame(self.animationFrameId);\n                        self.animationFrameId = null;\n                    }\n                    if (self.pc) {\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = false;\n                        });\n                    }\n                    if (self.canvasCtx) {\n                        self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                    }\n                    self.isMicActive = false;\n\n                    // Send response event when mic is disabled and autocreateresponse is false\n                    if (!self.autocreateresponse) {\n                        if (!self.datainputbuffer) {\n                            log.debug(\" sending response.create\");\n                            self.sendEvent({\n                                type: \"response.create\",\n                                response: {\n                                    output_modalities: [\"audio\"],\n                                    instructions: self.itemdata.audiochatinstructions,\n                                    audio: {\n                                        output: {\n                                            voice: self.audiochat_voice,\n                                        },\n                                    },\n                                }\n                            });\n                        } else {\n                            //set a recurring 500ms timeout that will send the response.create event if self.datainputbuffer is false\n                            log.debug(\"Waiting for input audio buffer to commit before sending response.create\");\n                            let attempts = 0;\n                            if (self.inputBufferInterval) {\n                                clearInterval(self.inputBufferInterval);\n                                self.inputBufferInterval = null;\n                            }\n                            const maxAttempts = 3;\n                            self.inputBufferInterval = setInterval(() => {\n                                log.debug(\"Checking input buffer status, attempt:\", attempts);\n                                if (!self.datainputbuffer || attempts >= maxAttempts) {\n                                    clearInterval(self.inputBufferInterval);\n                                    self.setDataInputBuffer(false, 'setInterval:' + attempts);\n                                    log.debug(\" sending response.create\");\n                                    self.sendEvent({\n                                        type: \"response.create\",\n                                        response: {\n                                            output_modalities: [\"audio\"],\n                                            instructions: self.itemdata.audiochatinstructions,\n                                            audio: {\n                                                output: {\n                                                    voice: self.audiochat_voice,\n                                                },\n                                            },\n                                        }\n                                    });\n                                }\n                                attempts++;\n                            }, 1500);\n                        }\n                    }\n                } else {\n                    // Unmute mic: Connect source to analyser\n                    if (self.sourceNode && self.analyser) {\n                        self.sourceNode.connect(self.analyser);\n                    }\n\n                    if (self.pc) {\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = true;\n                        });\n                    }\n                    self.isMicActive = true;\n                    self.drawWave(); // Start drawing waveform\n                }\n                self.renderUI(); // Update UI\n            },\n\n            releaseMicResources: function () {\n                var self = this;\n                if (self.animationFrameId) {\n                    cancelAnimationFrame(self.animationFrameId);\n                    self.animationFrameId = null;\n                }\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach((track) => {\n                        if (typeof self.pc !== 'undefined' && self.pc) {\n                            // Find the RTCRtpSender associated with the track\n                            const sender = self.pc.getSenders().find(s => s.track === track);\n                            // Remove the sender if it exists\n                            if (sender) {\n                                self.pc.removeTrack(sender);\n                            }\n                        }\n                        track.stop();\n                    });\n                    self.mediaStream = null;\n                }\n                if (self.sourceNode) {\n                    self.sourceNode.disconnect();\n                    self.sourceNode = null;\n                }\n                if (self.audioContext) {\n                    self.audioContext.close();\n                    self.audioContext = null;\n                }\n                self.isMicActive = false;\n                self.isMicInitialized = false;\n                if (self.canvasCtx) {\n                    self.canvasCtx.clearRect(0, 0, self.controls.micWaveformCanvas.width, self.controls.micWaveformCanvas.height); // Clear canvas\n                }\n                self.renderUI(); // Update UI to show mic inactive\n            },\n\n            drawWave: function () {\n                var self = this;\n                if (!self.canvasCtx || !self.analyser || !self.dataArray || !self.isMicActive) {\n                    self.animationFrameId = null; // Stop animation if conditions are not met\n                    return;\n                }\n\n                const WIDTH = self.controls.micWaveformCanvas.width;\n                const HEIGHT = self.controls.micWaveformCanvas.height;\n\n                self.animationFrameId = requestAnimationFrame(self.drawWave.bind(self));\n\n                self.analyser.getByteTimeDomainData(self.dataArray); // Get waveform data\n\n                self.canvasCtx.clearRect(0, 0, WIDTH, HEIGHT); // Clear previous drawing\n                self.canvasCtx.lineWidth = 2;\n                self.canvasCtx.strokeStyle = \"rgb(255, 255, 255)\"; // White color for wave on blue background\n\n                self.canvasCtx.beginPath();\n\n                const sliceWidth = (WIDTH * 1.0) / self.dataArray.length;\n                let x = 0;\n\n                for (let i = 0; i < self.dataArray.length; i++) {\n                    const v = self.dataArray[i] / 128.0; // Normalize to 0-2\n                    const y = (v * HEIGHT) / 2;\n\n                    if (i === 0) {\n                        self.canvasCtx.moveTo(x, y);\n                    } else {\n                        self.canvasCtx.lineTo(x, y);\n                    }\n\n                    x += sliceWidth;\n                }\n\n                self.canvasCtx.lineTo(WIDTH, HEIGHT / 2);\n                self.canvasCtx.stroke();\n            },\n\n            populateMicList: async function () {\n                var self = this;\n                try {\n                    const devices = await navigator.mediaDevices.enumerateDevices();\n                    const mics = devices.filter(device => device.kind === \"audioinput\");\n                    const select = self.controls.micSelect;\n\n                    select.innerHTML = \"\"; // Clear existing options\n\n                    // Group by groupId to remove duplicates\n                    const uniqueMics = [];\n                    const seenGroups = new Set();\n\n                    for (const mic of mics) {\n                        if (!seenGroups.has(mic.groupId)) {\n                            uniqueMics.push(mic);\n                            seenGroups.add(mic.groupId);\n                        }\n                    }\n\n                    if (uniqueMics.length <= 1) {\n                        select.disabled = true;\n                        return;\n                    }\n                    uniqueMics.forEach((mic, index) => {\n                        const option = document.createElement(\"option\");\n                        option.value = mic.deviceId;\n                        option.text = mic.label || `Microphone ${index + 1}`;\n                        select.appendChild(option);\n                    });\n                    select.parentElement.classList.remove('hidden');\n\n                    // Set change listener\n                    select.addEventListener(\"change\", async(e) => {\n                        const deviceId = e.target.value;\n                        await self.switchMic(deviceId);\n                    });\n                } catch (err) {\n                    log.debug(\"Failed to get microphone list:\", err);\n                }\n            },\n\n            switchMic: async function (deviceId) {\n                var self = this;\n\n                // Stop and release current mic\n                if (self.mediaStream) {\n                    self.mediaStream.getTracks().forEach(track => track.stop());\n                }\n\n                try {\n                    // Get new media stream from selected device\n                    self.mediaStream = await navigator.mediaDevices.getUserMedia({\n                        audio: {deviceId: {exact: deviceId}}\n                    });\n\n                    // Replace tracks in PeerConnection\n                    if (self.pc) {\n                        const senders = self.pc.getSenders();\n                        const audioTrack = self.mediaStream.getAudioTracks()[0];\n                        const audioSender = senders.find(sender => sender.track.kind === 'audio');\n                        if (audioSender) {\n                            audioSender.replaceTrack(audioTrack);\n                        }\n                    }\n\n                    // Reinitialize mic stream and waveform\n                    await self.initializeMicStream();\n                    if (self.isMicInitialized) {\n                        self.sourceNode.connect(self.analyser);\n                        self.mediaStream.getTracks().forEach((track) => {\n                            track.enabled = self.isMicActive;\n                        });\n                        if (self.isMicActive) {\n                            self.drawWave();\n                        }\n                    }\n\n                    log.debug(\"Switched microphone to:\" + deviceId);\n                } catch (err) {\n                    log.debug(\"Failed to switch microphone:\");\n                    log.debug(err);\n                }\n            },\n\n        }; // End of return object.\n    }\n);"],"file":"audiochat.min.js"}