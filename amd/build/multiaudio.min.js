define ("mod_minilesson/multiaudio",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],function(a,b,c,d,e,f){"use strict";b.debug("MiniLesson Multiaudio: initialising");return{ttrec:null,passmark:90,playing:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){var d={useanimatecss:c.useanimatecss};f.init(d);this.prepare_audio(b);this.register_events(a,b,c);this.init_components(a,b,c)},next_question:function next_question(a){var b=this,c={};c.index=b.index;c.hasgrade=!0;c.totalitems=1;c.correctitems=0<a?1:0;c.grade=a;b.quizhelper.do_next(c)},register_events:function register_events(b,c,d){var e=this,f=a("#"+c.uniqueid+"_player");e.index=b;e.quizhelper=d;a("#"+c.uniqueid+"_container .minilesson_nextbutton").on("click",function(){e.next_question(0)});a("#"+c.uniqueid+"_container .mcplayrow").on("click",function(){if(a("#"+c.uniqueid+"_container .mcplayrow").hasClass("minilesson_mc_disabled")){return}if(!e.playing){var b=this;e.playing=!0;f.attr("src",a(this).attr("data-src"));f[0].play();f[0].onended=function(){a(b).find(".minilesson_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play");e.playing=!1};a(b).find(".minilesson_mc_playstate").removeClass("fa-play").addClass("fa-spin fa-spinner")}else{f[0].pause();f[0].currentTime=0;a("#"+c.uniqueid+"_container .minilesson_mc_playstate").removeClass("fa-spin fa-spinner").addClass("fa-play");e.playing=!1}});a("#"+c.uniqueid+"_container").on("showElement",function(){if(0<c.timelimit){a("#"+c.uniqueid+"_container .progress-container").show();a("#"+c.uniqueid+"_container .progress-container i").show();a("#"+c.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:c.timelimit,onFinish:function onFinish(){a("#"+c.uniqueid+"_container .minilesson_nextbutton").trigger("click")}})}})},prepare_audio:function prepare_audio(b){a.each(b.sentences,function(c,e){d.fetch_polly_url(e.sentence,b.voiceoption,b.usevoice).then(function(d){a("#"+b.uniqueid+"_option"+(c+1)).attr("data-src",d)})})},process_accepted_response:function process_accepted_response(b,c){var d=this;a("#"+b.uniqueid+"_container .mcplayrow").addClass("minilesson_mc_disabled");if(d.quizhelper.showitemreview){if(0==parseInt(b.show_text)){for(var e=0;e<b.sentences.length;e++){a("#"+b.uniqueid+"_option"+(e+1));a("#"+b.uniqueid+"_option"+(e+1)+" .minilesson_sentence").text(b.sentences[e].sentence)}}a("#"+b.uniqueid+"_container .minilesson_mc_wrong").show();a("#"+b.uniqueid+"_option"+b.correctanswer+" .minilesson_mc_wrong").hide();a("#"+b.uniqueid+"_option"+b.correctanswer+" .minilesson_mc_right").show()}a("#"+b.uniqueid+"_option"+c+" .minilesson_mc_response").addClass("minilesson_mc_selected");var f=c==b.correctanswer?100:0;return f},init_components:function init_components(c,d,g){var h=this,j=d.sentences[d.correctanswer-1].sentence,k=d.sentences[d.correctanswer-1].phonetic,l=[];b.debug("initcomponents_multiaudio");b.debug(d.sentences);for(var m=0;m<d.sentences.length;m++){if(m+1==d.correctanswer){l[m]=""}else{l[m]=g.cleanText(d.sentences[m].sentence)}}var n=g.cleanText(j),o={};o.uniqueid=d.uniqueid;b.debug("ma uniqueid:"+d.uniqueid);o.callback=function theCallback(c){switch(c.type){case"recording":break;case"speech":b.debug("speech at multiaudio");var e=c.capturedspeech,i=g.cleanText(e),j=i;b.debug("speechtext:",e);b.debug("spoken:",j);b.debug("correct:",n);var m=g.similarity(j,n);b.debug("JS similarity: "+j+":"+n+":"+m);if(m>=h.passmark||h.wordsDoMatch(g,i,n)){b.debug("local correct match::"+j+":"+n);var o=h.process_accepted_response(d,d.correctanswer);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(o)},2e3);return}else{for(var p=0;p<l.length;p++){if(""===l[p]){continue}var q=g.similarity(j,l[p]);b.debug("JS similarity: "+j+":"+l[p]+":"+q);if(q>=h.passmark||h.wordsDoMatch(g,i,l[p])){var o=h.process_accepted_response(d,p+1);a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(o)},2e3);return}}}g.checkByPhonetic(n,j,k,d.language).then(function(c){if(!1===c){return a.Deferred().reject()}else{b.debug("PHP similarity: "+j+":"+n+":"+c);if(c>=h.passmark){var e=h.process_accepted_response(d,d.correctanswer);a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);h.next_question(e)},2e3)}}var g=a("#ttrec_container_"+d.uniqueid);f.do_animate(g,"shakeX animate__faster").then(function(){})});}};o.stt_guided=g.is_stt_guided();h.ttrec=e.clone();h.ttrec.init(o);for(var p="",m=0;m<d.sentences.length;m++){p+=g.cleanText(d.sentences[m].sentence)+" "}h.ttrec.currentPrompt=p},wordsDoMatch:function wordsDoMatch(a,b,c){b=a.cleanText(b);c=a.cleanText(c);if(b==c){return!0}return!1}}});
//# sourceMappingURL=multiaudio.min.js.map
