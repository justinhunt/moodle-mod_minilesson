{"version":3,"file":"ttiflytek.min.js","sources":["../src/ttiflytek.js"],"sourcesContent":["define(['jquery', 'core/log'], function ($, log) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file is the streamer to iflytek\n     */\n\n    log.debug('TT iFlyTek Streamer initialising');\n\n    return {\n\n        speechtoken: null,\n        socket: null,\n        audiohelper: null,\n        earlyaudio: [],\n        partials: [],\n        finals: [],\n        ready: false,\n        finaltext: '',\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        init: function (speechtoken, theaudiohelper) {\n            this.speechtoken = speechtoken;\n            this.audiohelper = theaudiohelper;\n            this.preparesocket();\n        },\n\n        preparesocket: async function () {\n            var that = this;\n\n            // establish wss with iFlyTek at 16000 sample rate\n\n            var socketurl = this.speechtoken;\n\n            var streamconfig = {\n                common: {\n                    app_id: \"ga63dbb0\"\n                },\n                business: {\n                    language: \"en_us\", // For English recognition\n                    domain: \"ist\",     // iST = iFlytek Realtime Transcription\n                    accent: \"english\",\n                    vad_eos: 2000,     // Silence duration before ending session (ms)\n                    dwa: \"wpgs\"        // Enables dynamic result returns (streaming feel)\n                },\n                data: {\n                    status: 0,         // 0: first frame, 1: middle, 2: last\n                    format: \"audio/L16;rate=16000\",\n                    encoding: \"raw\"\n                }\n            };\n\n            this.socket = await new WebSocket(socketurl);\n\n            log.debug('TT iFlyTek Streamer socket prepared');\n\n\n            // handle incoming messages which contain the transcription\n            this.socket.onmessage = function (message) {\n                let msg = \"\";\n                const res = JSON.parse(message.data);\n\n                if (res.code !== 0) {\n                    log.debug('iFlyTek error: ' + res.message);\n                    return;\n                }\n\n\n                switch (res.status) { // AssemblyAI field\n                    case 1:\n                        var words = res.ws;\n                        // Join all words with space\n                        var thetext = words.map(word => word.w).join(' ');\n                        that.partials[res.audio_start] = thetext;\n                        var keys = Object.keys(that.partials);\n                        keys.sort((a, b) => a - b);\n                        for (const key of keys) {\n                            if (that.partials[key]) {\n                                msg += ` ${that.partials[key]}`;\n                            }\n                        }\n                        that.audiohelper.oninterimspeechcapture(that.finaltext + ' ' + msg);\n                        break;\n\n                    case 2:\n                        //clear partials if we have a final\n                        that.partials = [];\n                        //process finals Join all words with space\n                        var words = res.ws;\n                        var thetext = words.map(word => word.w).join(' ');\n                        that.finals[res.audio_start] = thetext;\n                        var keys = Object.keys(that.finals);\n                        keys.sort((a, b) => a - b);\n                        for (const key of keys) {\n                            if (that.finals[key]) {\n                                msg += ` ${that.finals[key]}`;\n                            }\n                        }\n                        that.finaltext = msg;\n                        that.audiohelper.oninterimspeechcapture(msg);\n                        log.debug('interim (final) transcript: ' + msg);\n                        break;\n                    default:\n                        break;\n                }\n                log.debug(msg);\n            };\n\n            this.socket.onopen = (event) => {\n                log.debug('TT iFlyTek Streamer socket opened');\n                that.partials = [];\n                that.finals = [];\n                // Frame 1: Send Configuration\n                that.socket.send(JSON.stringify(streamconfig));\n                that.audiohelper.onSocketReady('fromsocketopen');\n            };\n\n            this.socket.onerror = (event) => {\n                log.debug(event);\n                that.socket.close();\n            };\n\n            this.socket.onclose = (event) => {\n                log.debug(event);\n                that.socket = null;\n            };\n        },\n\n        updatetoken: function (newtoken) {\n            var that = this;\n            if (that.socket) {\n                that.socket.close();\n            }\n            that.speechtoken = newtoken;\n            that.preparesocket();\n        },\n\n        audioprocess: function (stereodata) {\n            var that = this;\n            const base64data = this.binarytobase64(stereodata[0]);\n\n            //this would be an event that occurs after recorder has stopped or before we are ready\n            //session opening can be slower than socket opening, so store audio data until session is open\n            if (this.ready === undefined || !this.ready) {\n                log.debug('TT iFlyTek Streamer storing base64 audio');\n                this.earlyaudio.push(base64data);\n\n                //session opened after we collected audio data, send earlyaudio first\n            } else if (this.earlyaudio.length > 0) {\n                for (var i = 0; i < this.earlyaudio.length; i++) {\n                    this.sendaudio(this.earlyaudio[i]);\n                }\n                //clear earlyaudio and send the audio we just got\n                this.earlyaudio = [];\n                this.sendaudio(base64data);\n\n            } else {\n                //just send the audio we got\n                log.debug('TT iFlyTek Streamer sending current audiodata');\n                this.sendaudio(base64data);\n            }\n        },\n\n        binarytobase64: function (monoaudiodata) {\n            var that = this;\n\n            //convert to 16 bit pcm\n            var tempbuffer = []\n            for (let i = 0; i < monoaudiodata.length; i++) {\n                const sample = Math.max(-1, Math.min(1, monoaudiodata[i]))\n                const intSample = sample < 0 ? sample * 0x8000 : sample * 0x7fff\n                tempbuffer.push(intSample & 0xff)\n                tempbuffer.push((intSample >> 8) & 0xff)\n            }\n            var sendbuffer = new Uint8Array(tempbuffer)\n\n            // Encode binary string to base64\n            var binary = '';\n            for (var i = 0; i < sendbuffer.length; i++) {\n                binary += String.fromCharCode(sendbuffer[i]);\n            }\n            var base64 = btoa(binary);\n            return base64;\n        },\n\n        sendaudio: function (base64) {\n            var that = this;\n            //Send it off !!\n            if (that.socket) {\n                that.socket.send(\n                    JSON.stringify({\n                        data: { status: 1, audio: base64, encoding: \"raw\" }\n                    }),\n                );\n            }\n        },\n\n        finish: function (mimeType) {\n            var that = this;\n\n            //this would be an event that occurs after recorder has stopped lets just ignore it\n            if (this.ready === undefined || !this.ready) {\n                return;\n            }\n            log.debug('forcing end utterance');\n            //get any remanining transcription\n            if (that.socket) {\n                that.socket.send(\n                    JSON.stringify({\n                        data: { status: 2, audio: \"\", encoding: \"raw\" }\n                    }),\n                );\n            }\n            log.debug('timing out');\n            setTimeout(function () {\n                var msg = \"\";\n                var sets = [that.finals, that.partials];\n                for (const set of sets) {\n                    var keys = Object.keys(set);\n                    keys.sort((a, b) => a - b);\n                    for (const key of keys) {\n                        if (set[key]) {\n                            msg += ` ${set[key]}`;\n                        }\n                    }\n                }\n                log.debug('sending final speech capture event');\n                that.audiohelper.onfinalspeechcapture(msg);\n                that.cleanup();\n            }, 1000);\n        },\n\n        cancel: function () {\n            this.ready = false;\n            this.earlyaudio = [];\n            this.partials = [];\n            this.finals = [];\n            this.finaltext = '';\n            if (this.socket) {\n                this.socket.close();\n            }\n        },\n\n        cleanup: function () {\n            this.cancel();\n        }\n\n    };//end of return value\n\n});\n"],"names":["define","$","log","debug","speechtoken","socket","audiohelper","earlyaudio","partials","finals","ready","finaltext","clone","extend","this","init","theaudiohelper","preparesocket","async","that","socketurl","streamconfig","common","app_id","business","language","domain","accent","vad_eos","dwa","data","status","format","encoding","WebSocket","onmessage","message","msg","res","JSON","parse","code","thetext","ws","map","word","w","join","audio_start","keys","Object","sort","a","b","key","oninterimspeechcapture","onopen","event","send","stringify","onSocketReady","onerror","close","onclose","updatetoken","newtoken","audioprocess","stereodata","base64data","binarytobase64","undefined","length","i","sendaudio","push","monoaudiodata","tempbuffer","sample","Math","max","min","intSample","sendbuffer","Uint8Array","binary","String","fromCharCode","btoa","base64","audio","finish","mimeType","setTimeout","sets","set","onfinalspeechcapture","cleanup","cancel"],"mappings":"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"}