{"version":3,"file":"freespeaking.min.js","sources":["../src/freespeaking.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions','mod_minilesson/cloudpoodllloader',\n    'mod_minilesson/ttrecorder', 'core/templates'],\n    function($, log, def, cloudpoodll, ttrecorder, templates) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the free speaking item type\n   */\n\n  log.debug('MiniLesson FreeSpeaking: initialising');\n\n  return {\n\n     transcript_evaluation: null,\n     rawscore: 0,\n     percentscore: 0,\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n      this.itemdata = itemdata;\n      log.debug('itemdata',itemdata);\n      this.quizhelper = quizhelper;\n      this.init_components(quizhelper,itemdata);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n\n    next_question: function() {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = self.itemdata.totalmarks;\n      stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\n      stepdata.grade = self.percentscore;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    calculate_score: function(transcript_evaluation) {\n      var self = this;\n\n      if(transcript_evaluation === null){\n        return 0;\n      }\n\n      //words ratio\n      var wordsratio = 1;\n      if(self.itemdata.countwords) {\n        wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\n        if(wordsratio > 1){wordsratio = 1;}\n      }\n\n      //relevance\n      var relevanceratio = 1;\n      if(self.itemdata.relevance > 0){\n        relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\n        if(relevanceratio > 1){relevanceratio = 1;}\n      }\n      //calculate score based on AI grade * relevance * wordcount\n      var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\n      return score;\n    },\n\n    register_events: function(index, itemdata, quizhelper) {\n      \n      var self = this;\n      self.index = index;\n      self.quizhelper = quizhelper;\n      var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n      \n      nextbutton.on('click', function(e) {\n        self.next_question();\n      });\n\n    },\n\n    init_components: function(quizhelper,itemdata){\n      var self=this;\n      self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n      self.thebutton = \"thettrbutton\"; // To Do impl. this\n      self.resultbox = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_freespeaking_resultbox\");\n      self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n      self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_actionbox\");\n      self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_pendingbox\");\n      self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_resultsbox\");\n      self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_timerdisplay\");\n\n    // Callback: Recorder updates.\n    var recorderCallback = function(message) {\n\n        switch (message.type) {\n          case 'recording':\n            break;\n\n          case 'interimspeech':\n            var wordcount = self.quizhelper.count_words(message.capturedspeech);\n            self.wordcount.text(wordcount);\n            break;\n\n          case 'speech':\n            log.debug(\"speech at speechcards\");\n            var speechtext = message.capturedspeech;\n\n            //update the wordcount\n            var wordcount = self.quizhelper.count_words(speechtext);\n            self.wordcount.text(wordcount);\n\n            self.do_evaluation(speechtext);    \n        } //end of switch message type\n      };\n\n      if(quizhelper.use_ttrecorder()) {\n          //init tt recorder\n          var opts = {};\n          opts.uniqueid = itemdata.uniqueid;\n          opts.callback = recorderCallback;\n          opts.stt_guided=false;\n          self.ttrec = ttrecorder.clone();\n          self.ttrec.init(opts);\n\n      }else{\n          //init cloudpoodll push recorder\n          cloudpoodll.init('minilesson-recorder-passagereading-' + itemdata.id, recorderCallback);\n      }\n    }, //end of init components\n\n    do_evaluation: function(speechtext) {\n      var self = this;\n\n      //show a spinner while we do the AI stuff\n      self.resultsbox.hide();\n      self.actionbox.hide();\n      self.pendingbox.show();\n      \n      //do evaluation\n      this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then(function(ajaxresult) {\n        var transcript_evaluation = JSON.parse(ajaxresult);\n        if (transcript_evaluation) {\n          //calculate raw score and percent score\n          transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\n          self.rawscore = self.calculate_score(transcript_evaluation);\n          if(self.itemdata.totalmarks > 0){\n            self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\n          }\n          //add raw and percent score to trancript_evaluation for mustache\n          transcript_evaluation.rawscore = self.rawscore;\n          transcript_evaluation.percentscore = self.percentscore;\n          transcript_evaluation.rawspeech = speechtext;\n          transcript_evaluation.maxscore = self.itemdata.totalmarks;\n          self.transcript_evaluation = transcript_evaluation;\n\n          log.debug(transcript_evaluation);\n          //display results\n          templates.render('mod_minilesson/freespeakingresults',transcript_evaluation).then(\n            function(html,js){\n                self.resultsbox.html(html);\n                self.resultsbox.show();\n                self.pendingbox.hide();\n                self.actionbox.hide();\n                templates.runTemplateJS(js);\n                //reset timer and wordcount on this page, in case reattempt\n                self.wordcount.text('0');\n                self.ttrec.timer.reset();\n                var displaytime = self.ttrec.timer.fetch_display_time();\n                self.timerdisplay.html(displaytime);\n            }\n          );// End of templates\n        } else {\n          log.debug('transcript_evaluation: oh no it failed');\n          self.resultsbox.hide();\n          self.pendingbox.hide();\n          self.actionbox.show();\n        }\n      }); \n    },\n  };\n});"],"names":["define","$","log","def","cloudpoodll","ttrecorder","templates","debug","transcript_evaluation","rawscore","percentscore","clone","extend","this","init","index","itemdata","quizhelper","init_components","register_events","next_question","stepdata","hasgrade","totalitems","totalmarks","correctitems","grade","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","Math","round","marks","self","uniqueid","on","e","allwords","thebutton","resultbox","wordcount","actionbox","pendingbox","resultsbox","timerdisplay","recorderCallback","message","type","count_words","capturedspeech","text","speechtext","do_evaluation","use_ttrecorder","opts","callback","stt_guided","ttrec","id","hide","show","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","rawspeech","maxscore","render","html","js","runTemplateJS","timer","reset","displaytime","fetch_display_time"],"mappings":"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"}