{"version":3,"sources":["../src/freespeaking.js"],"names":["define","$","log","def","ttrecorder","correctionsmarkup","templates","debug","transcript_evaluation","rawscore","percentscore","clone","extend","init","index","itemdata","quizhelper","init_components","register_events","next_question","self","stepdata","hasgrade","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","score","Math","round","marks","nextbutton","uniqueid","on","timelimit","show","progressTimer","height","timeLimit","onFinish","trigger","allwords","thebutton","wordcount","actionbox","pendingbox","resultsbox","timerdisplay","opts","callback","recorderCallback","message","type","count_words","capturedspeech","text","speechtext","do_evaluation","stt_guided","ttrec","do_corrections_markup","grammarerrors","grammarmatches","insertioncount","correctionscontainer","find","hide","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","rawspeech","maxscore","showitemreview","render","html","js","hasOwnProperty","runTemplateJS","timer","reset","displaytime","fetch_display_time"],"mappings":"AAAAA,OAAM,+BAAC,CAAC,QAAD,CAAW,UAAX,CAAuB,4BAAvB,CACH,2BADG,CAC0B,kCAD1B,CAC8D,gBAD9D,CAAD,CAEF,SAASC,CAAT,CAAYC,CAAZ,CAAiBC,CAAjB,CAAsBC,CAAtB,CAAkCC,CAAlC,CAAqDC,CAArD,CAAgE,CAClE,aAMAJ,CAAG,CAACK,KAAJ,CAAU,uCAAV,EAEA,MAAO,CAEJC,qBAAqB,CAAE,IAFnB,CAGJC,QAAQ,CAAE,CAHN,CAIJC,YAAY,CAAE,CAJV,CAOHC,KAAK,CAAE,gBAAY,CACf,MAAOV,CAAAA,CAAC,CAACW,MAAF,IAAe,EAAf,CAAmB,IAAnB,CACX,CATG,CAWLC,IAAI,CAAE,cAASC,CAAT,CAAgBC,CAAhB,CAA0BC,CAA1B,CAAsC,CAC1C,KAAKD,QAAL,CAAgBA,CAAhB,CACAb,CAAG,CAACK,KAAJ,CAAU,UAAV,CAAqBQ,CAArB,EACA,KAAKC,UAAL,CAAkBA,CAAlB,CACA,KAAKC,eAAL,CAAqBD,CAArB,CAAgCD,CAAhC,EACA,KAAKG,eAAL,CAAqBJ,CAArB,CAA4BC,CAA5B,CAAsCC,CAAtC,CAED,CAlBI,CAoBLG,aAAa,CAAE,wBAAW,IACpBC,CAAAA,CAAI,CAAG,IADa,CAEpBC,CAAQ,CAAG,EAFS,CAGxBA,CAAQ,CAACP,KAAT,CAAiBM,CAAI,CAACN,KAAtB,CACAO,CAAQ,CAACC,QAAT,IACAD,CAAQ,CAACE,UAAT,CAAsBH,CAAI,CAACL,QAAL,CAAcS,UAApC,CACAH,CAAQ,CAACI,YAAT,CAAwC,CAAhB,CAAAL,CAAI,CAACX,QAAL,CAAoBW,CAAI,CAACX,QAAzB,CAAoC,CAA5D,CACAY,CAAQ,CAACK,KAAT,CAAiBN,CAAI,CAACV,YAAtB,CACAW,CAAQ,CAACM,WAAT,CAAuBP,CAAI,CAACZ,qBAA5B,CACAY,CAAI,CAACJ,UAAL,CAAgBY,OAAhB,CAAwBP,CAAxB,CACD,CA9BI,CAgCLQ,eAAe,CAAE,yBAASrB,CAAT,CAAgC,CAC/C,GAAIY,CAAAA,CAAI,CAAG,IAAX,CAEA,GAA6B,IAA1B,GAAAZ,CAAH,CAAkC,CAChC,MAAO,EACR,CAGD,GAAIsB,CAAAA,CAAU,CAAG,CAAjB,CACA,GAAGV,CAAI,CAACL,QAAL,CAAcgB,UAAjB,CAA6B,CAC3BD,CAAU,CAAGtB,CAAqB,CAACwB,KAAtB,CAA4BC,KAA5B,CAAoCb,CAAI,CAACL,QAAL,CAAcmB,eAA/D,CACA,GAAgB,CAAb,CAAAJ,CAAH,CAAkB,CAACA,CAAU,CAAG,CAAG,CACpC,CAGD,GAAIK,CAAAA,CAAc,CAAG,CAArB,CACA,GAA6B,CAA1B,CAAAf,CAAI,CAACL,QAAL,CAAcqB,SAAjB,CAA+B,CAC7BD,CAAc,CAAG,CAAC3B,CAAqB,CAACwB,KAAtB,CAA4BI,SAA5B,CAAwC,EAAzC,EAA+C,GAAhE,CACA,GAAoB,CAAjB,CAAAD,CAAH,CAAsB,CAACA,CAAc,CAAG,CAAG,CAC5C,CAED,GAAIE,CAAAA,CAAK,CAAGC,IAAI,CAACC,KAAL,CAAW/B,CAAqB,CAACgC,KAAtB,CAA8BL,CAA9B,CAA+CL,CAA1D,CAAZ,CACA,MAAOO,CAAAA,CACR,CAvDI,CAyDLnB,eAAe,CAAE,yBAASJ,CAAT,CAAgBC,CAAhB,CAA0BC,CAA1B,CAAsC,CAErD,GAAII,CAAAA,CAAI,CAAG,IAAX,CACAA,CAAI,CAACN,KAAL,CAAaA,CAAb,CACAM,CAAI,CAACJ,UAAL,CAAkBA,CAAlB,CACA,GAAIyB,CAAAA,CAAU,CAAGxC,CAAC,CAAC,IAAMc,CAAQ,CAAC2B,QAAf,CAA0B,mCAA3B,CAAlB,CAEAD,CAAU,CAACE,EAAX,CAAc,OAAd,CAAuB,UAAY,CACjCvB,CAAI,CAACD,aAAL,EACD,CAFD,EAIAlB,CAAC,CAAC,IAAMc,CAAQ,CAAC2B,QAAf,CAA0B,YAA3B,CAAD,CAA0CC,EAA1C,CAA6C,aAA7C,CAA4D,UAAM,CAChE,GAAyB,CAArB,CAAA5B,CAAQ,CAAC6B,SAAb,CAA4B,CACxB3C,CAAC,CAAC,IAAMc,CAAQ,CAAC2B,QAAf,CAA0B,gCAA3B,CAAD,CAA8DG,IAA9D,GACA5C,CAAC,CAAC,IAAMc,CAAQ,CAAC2B,QAAf,CAA0B,kCAA3B,CAAD,CAAgEG,IAAhE,GACA5C,CAAC,CAAC,IAAMc,CAAQ,CAAC2B,QAAf,CAA0B,+CAA3B,CAAD,CAA6EI,aAA7E,CAA2F,CACvFC,MAAM,CAAE,KAD+E,CAEvFC,SAAS,CAAEjC,CAAQ,CAAC6B,SAFmE,CAGvFK,QAAQ,CAAE,mBAAW,CACjBR,CAAU,CAACS,OAAX,CAAmB,OAAnB,CACH,CALsF,CAA3F,CAOH,CACF,CAZD,CAcD,CAlFI,CAoFLjC,eAAe,CAAE,yBAASD,CAAT,CAAoBD,CAApB,CAA6B,CAC5C,GAAIK,CAAAA,CAAI,CAAC,IAAT,CACAA,CAAI,CAAC+B,QAAL,CAAgBlD,CAAC,CAAC,IAAMmB,CAAI,CAACL,QAAL,CAAc2B,QAApB,CAA+B,2CAAhC,CAAjB,CACAtB,CAAI,CAACgC,SAAL,CAAiB,cAAjB,CACAhC,CAAI,CAACiC,SAAL,CAAiBpD,CAAC,CAAC,IAAMmB,CAAI,CAACL,QAAL,CAAc2B,QAApB,CAA+B,8BAAhC,CAAlB,CACAtB,CAAI,CAACkC,SAAL,CAAiBrD,CAAC,CAAC,IAAMmB,CAAI,CAACL,QAAL,CAAc2B,QAApB,CAA+B,0CAAhC,CAAlB,CACAtB,CAAI,CAACmC,UAAL,CAAkBtD,CAAC,CAAC,IAAMmB,CAAI,CAACL,QAAL,CAAc2B,QAApB,CAA+B,2CAAhC,CAAnB,CACAtB,CAAI,CAACoC,UAAL,CAAkBvD,CAAC,CAAC,IAAMmB,CAAI,CAACL,QAAL,CAAc2B,QAApB,CAA+B,2CAAhC,CAAnB,CACAtB,CAAI,CAACqC,YAAL,CAAoBxD,CAAC,CAAC,IAAMmB,CAAI,CAACL,QAAL,CAAc2B,QAApB,CAA+B,6CAAhC,CAArB,CAR4C,GAkCxCgB,CAAAA,CAAI,CAAG,EAlCiC,CAmC5CA,CAAI,CAAChB,QAAL,CAAgB3B,CAAQ,CAAC2B,QAAzB,CACAgB,CAAI,CAACC,QAAL,CAzBuB,QAAnBC,CAAAA,gBAAmB,CAASC,CAAT,CAAkB,CAEvC,OAAQA,CAAO,CAACC,IAAhB,EACE,IAAK,WAAL,CACE,MAEF,IAAK,eAAL,CACE,GAAIT,CAAAA,CAAS,CAAGjC,CAAI,CAACJ,UAAL,CAAgB+C,WAAhB,CAA4BF,CAAO,CAACG,cAApC,CAAhB,CACA5C,CAAI,CAACiC,SAAL,CAAeY,IAAf,CAAoBZ,CAApB,EACA,MAEF,IAAK,QAAL,IACMa,CAAAA,CAAU,CAAGL,CAAO,CAACG,cAD3B,CAIMX,CAAS,CAAGjC,CAAI,CAACJ,UAAL,CAAgB+C,WAAhB,CAA4BG,CAA5B,CAJlB,CAKE9C,CAAI,CAACiC,SAAL,CAAeY,IAAf,CAAoBZ,CAApB,EAEAjC,CAAI,CAAC+C,aAAL,CAAmBD,CAAnB,EAhBJ,CAkBD,CAKD,CACAR,CAAI,CAACU,UAAL,IACAhD,CAAI,CAACiD,KAAL,CAAajE,CAAU,CAACO,KAAX,EAAb,CACAS,CAAI,CAACiD,KAAL,CAAWxD,IAAX,CAAgB6C,CAAhB,CAED,CA7HI,CA+HLY,qBAAqB,CAAE,+BAASC,CAAT,CAAuBC,CAAvB,CAAsCC,CAAtC,CAAsD,IACvErD,CAAAA,CAAI,CAAG,IADgE,CAItEsD,CAAoB,CAAGtD,CAAI,CAACoC,UAAL,CAAgBmB,IAAhB,CAAqB,sBAArB,CAJ+C,CAK1EtE,CAAiB,CAACQ,IAAlB,CAAuB,CAAE,qBAAwB6D,CAA1B,CAClB,cAAiBH,CADC,CAElB,eAAkBC,CAFA,CAGlB,eAAkBC,CAHA,CAAvB,CAIF,CAxII,CA0ILN,aAAa,CAAE,uBAASD,CAAT,CAAqB,CAClC,GAAI9C,CAAAA,CAAI,CAAG,IAAX,CAGAA,CAAI,CAACoC,UAAL,CAAgBoB,IAAhB,GACAxD,CAAI,CAACkC,SAAL,CAAesB,IAAf,GACAxD,CAAI,CAACmC,UAAL,CAAgBV,IAAhB,GAGA,KAAK7B,UAAL,CAAgB6D,kBAAhB,CAAmCX,CAAnC,CAA8C,KAAKnD,QAAL,CAAc+D,MAA5D,EAAoEC,IAApE,CAAyE,SAASC,CAAT,CAAqB,CAC5F,GAAIxE,CAAAA,CAAqB,CAAGyE,IAAI,CAACC,KAAL,CAAWF,CAAX,CAA5B,CACA,GAAIxE,CAAJ,CAA2B,CAEzBA,CAAqB,CAACC,QAAtB,CAAiCW,CAAI,CAACS,eAAL,CAAqBrB,CAArB,CAAjC,CACAY,CAAI,CAACX,QAAL,CAAgBW,CAAI,CAACS,eAAL,CAAqBrB,CAArB,CAAhB,CACA,GAA8B,CAA3B,CAAAY,CAAI,CAACL,QAAL,CAAcS,UAAjB,CAAgC,CAC9BJ,CAAI,CAACV,YAAL,CAAoB4B,IAAI,CAACC,KAAL,CAAwD,GAA7C,EAACnB,CAAI,CAACX,QAAL,CAAgBW,CAAI,CAACL,QAAL,CAAcS,UAA/B,CAAX,CACrB,CAEDhB,CAAqB,CAACC,QAAtB,CAAiCW,CAAI,CAACX,QAAtC,CACAD,CAAqB,CAACE,YAAtB,CAAqCU,CAAI,CAACV,YAA1C,CACAF,CAAqB,CAAC2E,SAAtB,CAAkCjB,CAAlC,CACA1D,CAAqB,CAAC4E,QAAtB,CAAiChE,CAAI,CAACL,QAAL,CAAcS,UAA/C,CACAJ,CAAI,CAACZ,qBAAL,CAA6BA,CAA7B,CAEAN,CAAG,CAACK,KAAJ,CAAUC,CAAV,EAEA,GAAG,CAACY,CAAI,CAACJ,UAAL,CAAgBqE,cAApB,CAAmC,CACjCjE,CAAI,CAACD,aAAL,EACD,CAFD,IAEK,CAEHb,CAAS,CAACgF,MAAV,CAAiB,oCAAjB,CAAsD9E,CAAtD,EAA6EuE,IAA7E,CACE,SAASQ,CAAT,CAAcC,CAAd,CAAiB,CACbpE,CAAI,CAACoC,UAAL,CAAgB+B,IAAhB,CAAqBA,CAArB,EAEA,GAAG/E,CAAqB,CAACiF,cAAtB,CAAqC,eAArC,CAAH,CAAyD,CACvDrE,CAAI,CAACkD,qBAAL,CAA2B9D,CAAqB,CAAC+D,aAAjD,CACE/D,CAAqB,CAACgE,cADxB,CAEEhE,CAAqB,CAACiE,cAFxB,CAID,CAEDrD,CAAI,CAACoC,UAAL,CAAgBX,IAAhB,GACAzB,CAAI,CAACmC,UAAL,CAAgBqB,IAAhB,GACAxD,CAAI,CAACkC,SAAL,CAAesB,IAAf,GACAtE,CAAS,CAACoF,aAAV,CAAwBF,CAAxB,EAEApE,CAAI,CAACiC,SAAL,CAAeY,IAAf,CAAoB,GAApB,EACA7C,CAAI,CAACiD,KAAL,CAAWsB,KAAX,CAAiBC,KAAjB,GACA,GAAIC,CAAAA,CAAW,CAAGzE,CAAI,CAACiD,KAAL,CAAWsB,KAAX,CAAiBG,kBAAjB,EAAlB,CACA1E,CAAI,CAACqC,YAAL,CAAkB8B,IAAlB,CAAuBM,CAAvB,CACH,CApBH,CAsBD,CACF,CA3CD,IA2CO,CACL3F,CAAG,CAACK,KAAJ,CAAU,wCAAV,EACAa,CAAI,CAACoC,UAAL,CAAgBoB,IAAhB,GACAxD,CAAI,CAACmC,UAAL,CAAgBqB,IAAhB,GACAxD,CAAI,CAACkC,SAAL,CAAeT,IAAf,EACD,CACF,CAnDD,CAoDD,CAvMI,CAyMR,CApNK,CAAN","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions',\n    'mod_minilesson/ttrecorder', 'mod_minilesson/correctionsmarkup', 'core/templates'],\n    function($, log, def, ttrecorder, correctionsmarkup, templates) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the free speaking item type\n   */\n\n  log.debug('MiniLesson FreeSpeaking: initialising');\n\n  return {\n\n     transcript_evaluation: null,\n     rawscore: 0,\n     percentscore: 0,\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n      this.itemdata = itemdata;\n      log.debug('itemdata',itemdata);\n      this.quizhelper = quizhelper;\n      this.init_components(quizhelper,itemdata);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n\n    next_question: function() {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = self.itemdata.totalmarks;\n      stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\n      stepdata.grade = self.percentscore;\n      stepdata.resultsdata = self.transcript_evaluation;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    calculate_score: function(transcript_evaluation) {\n      var self = this;\n\n      if(transcript_evaluation === null){\n        return 0;\n      }\n\n      //words ratio\n      var wordsratio = 1;\n      if(self.itemdata.countwords) {\n        wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\n        if(wordsratio > 1){wordsratio = 1;}\n      }\n\n      //relevance\n      var relevanceratio = 1;\n      if(self.itemdata.relevance > 0){\n        relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\n        if(relevanceratio > 1){relevanceratio = 1;}\n      }\n      //calculate score based on AI grade * relevance * wordcount\n      var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\n      return score;\n    },\n\n    register_events: function(index, itemdata, quizhelper) {\n\n      var self = this;\n      self.index = index;\n      self.quizhelper = quizhelper;\n      var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n\n      nextbutton.on('click', function(e) {\n        self.next_question();\n      });\n\n      $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n        if (itemdata.timelimit > 0) {\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                height: '5px',\n                timeLimit: itemdata.timelimit,\n                onFinish: function() {\n                    nextbutton.trigger('click');\n                }\n            });\n        }\n      });\n\n    },\n\n    init_components: function(quizhelper,itemdata){\n      var self=this;\n      self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n      self.thebutton = \"thettrbutton\"; // To Do impl. this\n      self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n      self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_actionbox\");\n      self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_pendingbox\");\n      self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_resultsbox\");\n      self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_timerdisplay\");\n\n      // Callback: Recorder updates.\n      var recorderCallback = function(message) {\n\n        switch (message.type) {\n          case 'recording':\n            break;\n\n          case 'interimspeech':\n            var wordcount = self.quizhelper.count_words(message.capturedspeech);\n            self.wordcount.text(wordcount);\n            break;\n\n          case 'speech':\n            var speechtext = message.capturedspeech;\n\n            //update the wordcount\n            var wordcount = self.quizhelper.count_words(speechtext);\n            self.wordcount.text(wordcount);\n\n            self.do_evaluation(speechtext);\n        } //end of switch message type\n      };\n\n      //init tt recorder\n      var opts = {};\n      opts.uniqueid = itemdata.uniqueid;\n      opts.callback = recorderCallback;\n      opts.stt_guided=false;\n      self.ttrec = ttrecorder.clone();\n      self.ttrec.init(opts);\n\n    }, //end of init components\n\n    do_corrections_markup: function(grammarerrors,grammarmatches,insertioncount) {\n      var self = this;\n      //corrected text container is created at runtime, so it wont exist at init_components time\n      //thats we find it here\n       var correctionscontainer = self.resultsbox.find('.mlfsr_correctedtext');\n       correctionsmarkup.init({ \"correctionscontainer\": correctionscontainer,\n            \"grammarerrors\": grammarerrors,\n            \"grammarmatches\": grammarmatches,\n            \"insertioncount\": insertioncount});\n    },\n\n    do_evaluation: function(speechtext) {\n      var self = this;\n\n      //show a spinner while we do the AI stuff\n      self.resultsbox.hide();\n      self.actionbox.hide();\n      self.pendingbox.show();\n\n      //do evaluation\n      this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then(function(ajaxresult) {\n        var transcript_evaluation = JSON.parse(ajaxresult);\n        if (transcript_evaluation) {\n          //calculate raw score and percent score\n          transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\n          self.rawscore = self.calculate_score(transcript_evaluation);\n          if(self.itemdata.totalmarks > 0){\n            self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\n          }\n          //add raw and percent score to trancript_evaluation for mustache\n          transcript_evaluation.rawscore = self.rawscore;\n          transcript_evaluation.percentscore = self.percentscore;\n          transcript_evaluation.rawspeech = speechtext;\n          transcript_evaluation.maxscore = self.itemdata.totalmarks;\n          self.transcript_evaluation = transcript_evaluation;\n\n          log.debug(transcript_evaluation);\n          //display results or move next if not show item review\n          if(!self.quizhelper.showitemreview){\n            self.next_question();\n          }else{\n            //display results\n            templates.render('mod_minilesson/freespeakingresults',transcript_evaluation).then(\n              function(html,js){\n                  self.resultsbox.html(html);\n                  //do corrections markup\n                  if(transcript_evaluation.hasOwnProperty('grammarerrors')){\n                    self.do_corrections_markup(transcript_evaluation.grammarerrors,\n                      transcript_evaluation.grammarmatches,\n                      transcript_evaluation.insertioncount\n                    );\n                  }\n                  //show and hide\n                  self.resultsbox.show();\n                  self.pendingbox.hide();\n                  self.actionbox.hide();\n                  templates.runTemplateJS(js);\n                  //reset timer and wordcount on this page, in case reattempt\n                  self.wordcount.text('0');\n                  self.ttrec.timer.reset();\n                  var displaytime = self.ttrec.timer.fetch_display_time();\n                  self.timerdisplay.html(displaytime);\n              }\n            );// End of templates\n          } //end of if show item review\n        } else {\n          log.debug('transcript_evaluation: oh no it failed');\n          self.resultsbox.hide();\n          self.pendingbox.hide();\n          self.actionbox.show();\n        }\n      });\n    },\n  };\n});"],"file":"freespeaking.min.js"}