{"version":3,"sources":["../src/freespeaking.js"],"names":["define","$","log","def","ttrecorder","correctionsmarkup","templates","debug","transcript_evaluation","rawscore","percentscore","autosubmitmode","clone","extend","init","index","itemdata","quizhelper","init_components","register_events","next_question","self","stepdata","hasgrade","lessonitemid","id","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","score","Math","round","marks","nextbutton","uniqueid","on","timelimit","show","progressTimer","height","timeLimit","onFinish","ontimelimitreached","ttrec","audio","isRecording","transcript","usebrowserrec","browserrec","stop","audiohelper","do_evaluation","trigger","allwords","thebutton","wordcount","actionbox","pendingbox","resultsbox","timerdisplay","opts","callback","recorderCallback","message","type","count_words","capturedspeech","text","speechtext","stt_guided","do_corrections_markup","grammarerrors","grammarmatches","insertioncount","correctionscontainer","find","hide","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","reviewsettings","isNaN","rawspeech","maxscore","ystarcnt","gstarcnt","showscorestarrating","yellowstars","Array","fill","M","cfg","graystars","showitemreview","render","html","js","hasOwnProperty","runTemplateJS","timer","reset","displaytime","fetch_display_time","timerelement","timerinterval","attr","clearInterval"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions',\n    'mod_minilesson/ttrecorder', 'mod_minilesson/correctionsmarkup', 'core/templates'],\n    function($, log, def, ttrecorder, correctionsmarkup, templates) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the free speaking item type\n   */\n\n  log.debug('MiniLesson FreeSpeaking: initialising');\n\n  return {\n\n    transcript_evaluation: null,\n    rawscore: 0,\n    percentscore: 0,\n    autosubmitmode: false,\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n      this.itemdata = itemdata;\n      log.debug('itemdata',itemdata);\n      this.quizhelper = quizhelper;\n      this.init_components(quizhelper,itemdata);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n\n    next_question: function() {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.lessonitemid = self.itemdata.id;\n      stepdata.totalitems = self.itemdata.totalmarks;\n      stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\n      stepdata.grade = self.percentscore;\n      stepdata.resultsdata = self.transcript_evaluation;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    calculate_score: function(transcript_evaluation) {\n      var self = this;\n\n      if(transcript_evaluation === null){\n        return 0;\n      }\n\n      //words ratio\n      var wordsratio = 1;\n      if(self.itemdata.countwords) {\n        wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\n        if(wordsratio > 1){wordsratio = 1;}\n      }\n\n      //relevance\n      var relevanceratio = 1;\n      if(self.itemdata.relevance > 0){\n        relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\n        if(relevanceratio > 1){relevanceratio = 1;}\n      }\n      //calculate score based on AI grade * relevance * wordcount\n      var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\n      return score;\n    },\n\n    register_events: function(index, itemdata, quizhelper) {\n\n      var self = this;\n      self.index = index;\n      self.quizhelper = quizhelper;\n      var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n\n      nextbutton.on('click', function(e) {\n        self.next_question();\n      });\n\n      $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n        if (itemdata.timelimit > 0) {\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                height: '5px',\n                timeLimit: itemdata.timelimit,\n                onFinish: function() {\n                  self.ontimelimitreached();\n                }\n            });\n        }\n      });\n\n    },\n\n    ontimelimitreached: function() {\n      var self = this;\n      if (self.ttrec && self.ttrec.audio && (self.ttrec.audio.isRecording || self.ttrec.audio.transcript)) {\n        if (self.ttrec.audio.isRecording) {\n          self.autosubmitmode = true;\n\n          if (self.ttrec.usebrowserrec) {\n            self.ttrec.browserrec.stop();\n          } else {\n            self.ttrec.audiohelper.stop();\n          }\n        } else if (self.ttrec.audio.transcript && !self.transcript_evaluation) {\n          self.autosubmitmode = true;\n          self.do_evaluation(self.ttrec.audio.transcript);\n        }\n      } else if (!self.transcript_evaluation) {\n        var nextbutton = $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n        nextbutton.trigger('click');\n      }\n    },\n\n    init_components: function(quizhelper,itemdata){\n      var self=this;\n      self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n      self.thebutton = \"thettrbutton\"; // To Do impl. this\n      self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n      self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_actionbox\");\n      self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_pendingbox\");\n      self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_resultsbox\");\n      self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_timerdisplay\");\n\n      // Callback: Recorder updates.\n      var recorderCallback = function(message) {\n\n        switch (message.type) {\n          case 'recording':\n            break;\n\n          case 'interimspeech':\n            var wordcount = self.quizhelper.count_words(message.capturedspeech);\n            self.wordcount.text(wordcount);\n            break;\n\n          case 'speech':\n            var speechtext = message.capturedspeech;\n\n            //update the wordcount\n            var wordcount = self.quizhelper.count_words(speechtext);\n            self.wordcount.text(wordcount);\n\n            self.do_evaluation(speechtext);\n        } //end of switch message type\n      };\n\n      //init tt recorder\n      var opts = {};\n      opts.uniqueid = itemdata.uniqueid;\n      opts.callback = recorderCallback;\n      opts.stt_guided=false;\n      self.ttrec = ttrecorder.clone();\n      self.ttrec.init(opts);\n\n    }, //end of init components\n\n    do_corrections_markup: function(grammarerrors,grammarmatches,insertioncount) {\n      var self = this;\n      //corrected text container is created at runtime, so it wont exist at init_components time\n      //thats we find it here\n       var correctionscontainer = self.resultsbox.find('.mlfsr_correctedtext');\n       correctionsmarkup.init({ \"correctionscontainer\": correctionscontainer,\n            \"grammarerrors\": grammarerrors,\n            \"grammarmatches\": grammarmatches,\n            \"insertioncount\": insertioncount});\n    },\n\n    do_evaluation: function(speechtext) {\n      var self = this;\n\n      //show a spinner while we do the AI stuff\n      self.resultsbox.hide();\n      self.actionbox.hide();\n      self.pendingbox.show();\n\n      //do evaluation\n      this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then(function(ajaxresult) {\n        var transcript_evaluation = JSON.parse(ajaxresult);\n        if (transcript_evaluation) {\n          transcript_evaluation.reviewsettings = self.itemdata.reviewsettings;\n          //calculate raw score and percent score\n          transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\n          self.rawscore = self.calculate_score(transcript_evaluation);\n          self.percentscore = 0;\n          if(self.itemdata.totalmarks > 0){\n            self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\n          }\n          if (isNaN(self.percentscore)) {\n            self.percentscore = 0;\n          }\n          //add raw and percent score to trancript_evaluation for mustache\n          transcript_evaluation.rawscore = self.rawscore;\n          transcript_evaluation.percentscore = self.percentscore;\n          transcript_evaluation.rawspeech = speechtext;\n          transcript_evaluation.maxscore = self.itemdata.totalmarks;\n          self.transcript_evaluation = transcript_evaluation;\n\n          var ystarcnt = 0;\n          var gstarcnt;\n          if (transcript_evaluation.reviewsettings.showscorestarrating) {\n              if (self.percentscore == 0) {\n                ystarcnt = 0;\n              } else if (self.percentscore < 19) {\n                ystarcnt = 1;\n              } else if (self.percentscore < 39) {\n                ystarcnt = 2;\n              } else if (self.percentscore < 59) {\n                ystarcnt = 3;\n              } else if (self.percentscore < 79) {\n                ystarcnt = 4;\n              } else {\n                ystarcnt = 5;\n              }\n\n              gstarcnt = 5 - ystarcnt;\n              self.transcript_evaluation.yellowstars = new Array(ystarcnt).fill(M.cfg, 0, ystarcnt);\n              self.transcript_evaluation.graystars = new Array(gstarcnt).fill(M.cfg, 0, gstarcnt);\n          }\n\n          log.debug(transcript_evaluation);\n          //display results or move next if not show item review\n          if(!self.quizhelper.showitemreview && !self.autosubmitmode){\n            self.next_question();\n          }else{\n            //display results\n            templates.render('mod_minilesson/freespeakingresults',transcript_evaluation).then(\n              function(html,js){\n                  self.resultsbox.html(html);\n                  //do corrections markup\n                  if(transcript_evaluation.hasOwnProperty('grammarerrors')){\n                    self.do_corrections_markup(transcript_evaluation.grammarerrors,\n                      transcript_evaluation.grammarmatches,\n                      transcript_evaluation.insertioncount\n                    );\n                  }\n                  //show and hide\n                  self.resultsbox.show();\n                  self.pendingbox.hide();\n                  self.actionbox.hide();\n                  templates.runTemplateJS(js);\n                  //reset timer and wordcount on this page, in case reattempt\n                  self.wordcount.text('0');\n                  self.ttrec.timer.stop();\n                  self.ttrec.timer.reset();\n                  var displaytime = self.ttrec.timer.fetch_display_time();\n                  self.timerdisplay.html(displaytime);\n              }\n            );// End of templates\n            if (self.itemdata.timelimit > 0) {\n              var timerelement = $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container #progresstimer\");\n              var timerinterval = timerelement.attr('timer');\n              if (timerinterval) {\n                clearInterval(timerinterval);\n              }\n            }\n          } //end of if show item review\n        } else {\n          log.debug('transcript_evaluation: oh no it failed');\n          self.resultsbox.hide();\n          self.pendingbox.hide();\n          self.actionbox.show();\n        }\n      });\n    },\n  };\n});"],"file":"freespeaking.min.js"}