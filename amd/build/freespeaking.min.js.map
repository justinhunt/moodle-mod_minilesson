{"version":3,"sources":["../src/freespeaking.js"],"names":["define","$","log","def","ttrecorder","correctionsmarkup","templates","debug","transcript_evaluation","rawscore","percentscore","autosubmitmode","mediaurl","bloburl","clone","extend","init","index","itemdata","quizhelper","init_components","register_events","next_question","self","stepdata","hasgrade","lessonitemid","id","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","score","Math","round","marks","nextbutton","uniqueid","on","timelimit","show","progressTimer","height","timeLimit","onFinish","ontimelimitreached","ttrec","audio","isRecording","transcript","usebrowserrec","browserrec","stop","audiohelper","do_evaluation","trigger","allwords","thebutton","wordcount","actionbox","pendingbox","resultsbox","timerdisplay","iteminstructions","itemtext","finishedmessage","opts","callback","recorderCallback","message","type","count_words","capturedspeech","text","speechtext","stt_guided","do_corrections_markup","grammarerrors","grammarmatches","insertioncount","correctionscontainer","find","hide","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","reviewsettings","isNaN","rawspeech","maxscore","ystarcnt","gstarcnt","showscorestarrating","yellowstars","Array","fill","M","cfg","graystars","showitemreview","render","html","js","hasOwnProperty","runTemplateJS","timer","reset","displaytime","fetch_display_time","timerelementcontainer","timerelement","timerinterval","attr","clearInterval"],"mappings":"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","sourcesContent":["define(\n    ['jquery', 'core/log', 'mod_minilesson/definitions',\n    'mod_minilesson/ttrecorder', 'mod_minilesson/correctionsmarkup', 'core/templates'],\n    function ($, log, def, ttrecorder, correctionsmarkup, templates) {\n        \"use strict\"; // jshint ;_;\n\n      /*\n      This file is to manage the free speaking item type\n       */\n\n        log.debug('MiniLesson FreeSpeaking: initialising');\n\n        return {\n\n            transcript_evaluation: null,\n            rawscore: 0,\n            percentscore: 0,\n            autosubmitmode: false,\n            mediaurl: false,\n            bloburl: false,\n\n          //for making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.itemdata = itemdata;\n                log.debug('itemdata', itemdata);\n                this.quizhelper = quizhelper;\n                this.init_components(quizhelper, itemdata);\n                this.register_events(index, itemdata, quizhelper);\n\n            },\n\n            next_question: function () {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.lessonitemid = self.itemdata.id;\n                stepdata.totalitems = self.itemdata.totalmarks;\n                stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\n                stepdata.grade = self.percentscore;\n              //Add media url to transcript evaluation before we save it\n                if (self.transcript_evaluation && self.mediaurl) {\n                    self.transcript_evaluation.mediaurl = self.mediaurl;\n                }\n                stepdata.resultsdata = self.transcript_evaluation;\n                self.quizhelper.do_next(stepdata);\n            },\n\n            calculate_score: function (transcript_evaluation) {\n                var self = this;\n\n                if (transcript_evaluation === null) {\n                    return 0;\n                }\n\n              //words ratio\n                var wordsratio = 1;\n                if (self.itemdata.countwords) {\n                    wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\n                    if (wordsratio > 1) {\n                        wordsratio = 1; }\n                }\n\n              //relevance\n                var relevanceratio = 1;\n                if (self.itemdata.relevance > 0) {\n                    relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\n                    if (relevanceratio > 1) {\n                        relevanceratio = 1; }\n                }\n              //calculate score based on AI grade * relevance * wordcount\n                var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\n                return score;\n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n\n                var self = this;\n                self.index = index;\n                self.quizhelper = quizhelper;\n                var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n\n                nextbutton.on('click', function (e) {\n                    self.next_question();\n                });\n\n                $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n                    if (itemdata.timelimit > 0) {\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                self.ontimelimitreached();\n                            }\n                          });\n                    }\n                });\n\n            },\n\n            ontimelimitreached: function () {\n                var self = this;\n                if (self.ttrec && self.ttrec.audio && (self.ttrec.audio.isRecording || self.ttrec.audio.transcript)) {\n                    if (self.ttrec.audio.isRecording) {\n                        self.autosubmitmode = true;\n\n                        if (self.ttrec.usebrowserrec) {\n                            self.ttrec.browserrec.stop();\n                        } else {\n                            self.ttrec.audiohelper.stop();\n                        }\n                    } else if (self.ttrec.audio.transcript && !self.transcript_evaluation) {\n                        self.autosubmitmode = true;\n                        self.do_evaluation(self.ttrec.audio.transcript);\n                    }\n                } else if (!self.transcript_evaluation) {\n                    var nextbutton = $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n                    nextbutton.trigger('click');\n                }\n            },\n\n            init_components: function (quizhelper, itemdata) {\n                var self = this;\n                self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n                self.thebutton = \"thettrbutton\"; // To Do impl. this\n                self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n                self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_actionbox\");\n                self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_pendingbox\");\n                self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_resultsbox\");\n                self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_timerdisplay\");\n                self.iteminstructions = $(\"#\" + self.itemdata.uniqueid + \"_container div.mod_minilesson_iteminstructions\");\n                self.itemtext = $(\"#\" + self.itemdata.uniqueid + \"_container div.mod_minilesson_itemtext\");\n                self.finishedmessage = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_finishedmessage\");\n              // Callback: Recorder updates.\n                var recorderCallback = function (message) {\n\n                    switch (message.type) {\n                        case 'recording':\n                        break;\n\n                        case 'interimspeech':\n                            var wordcount = self.quizhelper.count_words(message.capturedspeech);\n                            self.wordcount.text(wordcount);\n                        break;\n\n                        case 'speech':\n                            var speechtext = message.capturedspeech;\n\n                          //update the wordcount\n                            var wordcount = self.quizhelper.count_words(speechtext);\n                            self.wordcount.text(wordcount);\n                            self.do_evaluation(speechtext);\n                        break;\n\n                        case 'mediasaved':\n                            log.debug('Mediaurl saved at passage reading: ' + message.mediaurl);\n                            self.mediaurl = message.mediaurl;\n                            self.bloburl = message.bloburl;\n                        break;\n                    } //end of switch message type\n                };\n\n\n\n              //init tt recorder\n                var opts = {};\n                opts.uniqueid = itemdata.uniqueid;\n                opts.callback = recorderCallback;\n                opts.stt_guided = false\n                self.ttrec = ttrecorder.clone();\n                self.ttrec.init(opts);\n\n            }, //end of init components\n\n            do_corrections_markup: function (grammarerrors, grammarmatches, insertioncount) {\n                var self = this;\n              //corrected text container is created at runtime, so it wont exist at init_components time\n              //thats we find it here\n                var correctionscontainer = self.resultsbox.find('.mlfsr_correctedtext');\n                correctionsmarkup.init({\n                    \"correctionscontainer\": correctionscontainer,\n                    \"grammarerrors\": grammarerrors,\n                    \"grammarmatches\": grammarmatches,\n                    \"insertioncount\": insertioncount\n                });\n            },\n\n            do_evaluation: function (speechtext) {\n                var self = this;\n\n              //show a spinner while we do the AI stuff\n                self.resultsbox.hide();\n                self.actionbox.hide();\n                self.pendingbox.show();\n\n              //do evaluation\n                this.quizhelper.evaluateTranscript(speechtext, this.itemdata.itemid).then(function (ajaxresult) {\n                    var transcript_evaluation = JSON.parse(ajaxresult);\n                    if (transcript_evaluation) {\n                        transcript_evaluation.reviewsettings = self.itemdata.reviewsettings;\n                      //calculate raw score and percent score\n                        transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\n                        self.rawscore = self.calculate_score(transcript_evaluation);\n                        self.percentscore = 0;\n                        if (self.itemdata.totalmarks > 0) {\n                            self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\n                        }\n                        if (isNaN(self.percentscore)) {\n                            self.percentscore = 0;\n                        }\n                      //add raw and percent score to trancript_evaluation for mustache\n                        transcript_evaluation.rawscore = self.rawscore;\n                        transcript_evaluation.percentscore = self.percentscore;\n                        transcript_evaluation.rawspeech = speechtext;\n                        transcript_evaluation.maxscore = self.itemdata.totalmarks;\n\n                      // If we have a media url from our recording lets use it\n                      // We will just use the blob version here (its local and s3/mp3 may not be ready)\n                        if (self.bloburl) {\n                            transcript_evaluation.mediaurl = self.bloburl;\n                        }\n\n                      // And save it upstairs\n                        self.transcript_evaluation = transcript_evaluation;\n\n                        var ystarcnt = 0;\n                        var gstarcnt;\n                        if (transcript_evaluation.reviewsettings.showscorestarrating) {\n                            if (self.percentscore == 0) {\n                                ystarcnt = 0;\n                            } else if (self.percentscore < 19) {\n                                ystarcnt = 1;\n                            } else if (self.percentscore < 39) {\n                                ystarcnt = 2;\n                            } else if (self.percentscore < 59) {\n                                ystarcnt = 3;\n                            } else if (self.percentscore < 79) {\n                                ystarcnt = 4;\n                            } else {\n                                ystarcnt = 5;\n                            }\n\n                            gstarcnt = 5 - ystarcnt;\n                            self.transcript_evaluation.yellowstars = new Array(ystarcnt).fill(M.cfg, 0, ystarcnt);\n                            self.transcript_evaluation.graystars = new Array(gstarcnt).fill(M.cfg, 0, gstarcnt);\n                        }\n\n                        log.debug(transcript_evaluation);\n                      //display results or move next if not show item review\n                        if (!self.quizhelper.showitemreview && !self.autosubmitmode) {\n                            self.next_question();\n                        } else {\n                          //display results\n                            templates.render('mod_minilesson/freespeakingresults', transcript_evaluation).then(\n                                function (html, js) {\n                                    self.resultsbox.html(html);\n                                    //do corrections markup\n                                    if (transcript_evaluation.hasOwnProperty('grammarerrors')) {\n                                        self.do_corrections_markup(\n                                            transcript_evaluation.grammarerrors,\n                                            transcript_evaluation.grammarmatches,\n                                            transcript_evaluation.insertioncount\n                                        );\n                                    }\n                                    //show and hide\n                                    self.iteminstructions.hide();\n                                    self.itemtext.hide();\n                                    self.finishedmessage.hide();\n                                    self.resultsbox.show();\n                                    self.pendingbox.hide();\n                                    self.actionbox.hide();\n                                    templates.runTemplateJS(js);\n                                    //reset timer and wordcount on this page, in case reattempt\n                                    self.wordcount.text('0');\n                                    self.ttrec.timer.stop();\n                                    self.ttrec.timer.reset();\n                                    var displaytime = self.ttrec.timer.fetch_display_time();\n                                    self.timerdisplay.html(displaytime);\n                                }\n                            );// End of templates\n                            if (self.itemdata.timelimit > 0) {\n                                let timerelementcontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container\");\n                                timerelementcontainer.hide();\n                                var timerelement = $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container #progresstimer\");\n                                var timerinterval = timerelement.attr('timer');\n                                if (timerinterval) {\n                                      clearInterval(timerinterval);\n                                }\n                            }\n                        } //end of if show item review\n                    } else {\n                        log.debug('transcript_evaluation: oh no it failed');\n                        self.resultsbox.hide();\n                        self.pendingbox.hide();\n                        self.actionbox.show();\n                    }\n                });\n            },\n        };\n    }\n);"],"file":"freespeaking.min.js"}