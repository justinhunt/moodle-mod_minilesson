{"version":3,"file":"freespeaking.min.js","sources":["../src/freespeaking.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions',\n  'mod_minilesson/ttrecorder', 'mod_minilesson/correctionsmarkup', 'core/templates'],\n  function ($, log, def, ttrecorder, correctionsmarkup, templates) {\n    \"use strict\"; // jshint ;_;\n\n    /*\n    This file is to manage the free speaking item type\n     */\n\n    log.debug('MiniLesson FreeSpeaking: initialising');\n\n    return {\n\n      transcript_evaluation: null,\n      rawscore: 0,\n      percentscore: 0,\n      autosubmitmode: false,\n      mediaurl: false,\n\n      //for making multiple instances\n      clone: function () {\n        return $.extend(true, {}, this);\n      },\n\n      init: function (index, itemdata, quizhelper) {\n        this.itemdata = itemdata;\n        log.debug('itemdata', itemdata);\n        this.quizhelper = quizhelper;\n        this.init_components(quizhelper, itemdata);\n        this.register_events(index, itemdata, quizhelper);\n\n      },\n\n      next_question: function () {\n        var self = this;\n        var stepdata = {};\n        stepdata.index = self.index;\n        stepdata.hasgrade = true;\n        stepdata.lessonitemid = self.itemdata.id;\n        stepdata.totalitems = self.itemdata.totalmarks;\n        stepdata.correctitems = self.rawscore > 0 ? self.rawscore : 0;\n        stepdata.grade = self.percentscore;\n        //Add media url to transcript evaluation before we save it\n        self.transcript_evaluation.mediaurl = self.mediaurl;\n        stepdata.resultsdata = self.transcript_evaluation;\n        self.quizhelper.do_next(stepdata);\n      },\n\n      calculate_score: function (transcript_evaluation) {\n        var self = this;\n\n        if (transcript_evaluation === null) {\n          return 0;\n        }\n\n        //words ratio\n        var wordsratio = 1;\n        if (self.itemdata.countwords) {\n          wordsratio = transcript_evaluation.stats.words / self.itemdata.targetwordcount;\n          if (wordsratio > 1) { wordsratio = 1; }\n        }\n\n        //relevance\n        var relevanceratio = 1;\n        if (self.itemdata.relevance > 0) {\n          relevanceratio = (transcript_evaluation.stats.relevance + 10) / 100;\n          if (relevanceratio > 1) { relevanceratio = 1; }\n        }\n        //calculate score based on AI grade * relevance * wordcount\n        var score = Math.round(transcript_evaluation.marks * relevanceratio * wordsratio);\n        return score;\n      },\n\n      register_events: function (index, itemdata, quizhelper) {\n\n        var self = this;\n        self.index = index;\n        self.quizhelper = quizhelper;\n        var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n\n        nextbutton.on('click', function (e) {\n          self.next_question();\n        });\n\n        $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n          if (itemdata.timelimit > 0) {\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n            $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n              height: '5px',\n              timeLimit: itemdata.timelimit,\n              onFinish: function () {\n                self.ontimelimitreached();\n              }\n            });\n          }\n        });\n\n      },\n\n      ontimelimitreached: function () {\n        var self = this;\n        if (self.ttrec && self.ttrec.audio && (self.ttrec.audio.isRecording || self.ttrec.audio.transcript)) {\n          if (self.ttrec.audio.isRecording) {\n            self.autosubmitmode = true;\n\n            if (self.ttrec.usebrowserrec) {\n              self.ttrec.browserrec.stop();\n            } else {\n              self.ttrec.audiohelper.stop();\n            }\n          } else if (self.ttrec.audio.transcript && !self.transcript_evaluation) {\n            self.autosubmitmode = true;\n            self.do_evaluation(self.ttrec.audio.transcript);\n          }\n        } else if (!self.transcript_evaluation) {\n          var nextbutton = $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n          nextbutton.trigger('click');\n        }\n      },\n\n      init_components: function (quizhelper, itemdata) {\n        var self = this;\n        self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n        self.thebutton = \"thettrbutton\"; // To Do impl. this\n        self.wordcount = $(\"#\" + self.itemdata.uniqueid + \"_container span.ml_wordcount\");\n        self.actionbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_actionbox\");\n        self.pendingbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_pendingbox\");\n        self.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_resultsbox\");\n        self.timerdisplay = $(\"#\" + self.itemdata.uniqueid + \"_container div.ml_freespeaking_timerdisplay\");\n\n        // Callback: Recorder updates.\n        var recorderCallback = function (message) {\n\n          switch (message.type) {\n            case 'recording':\n              break;\n\n            case 'interimspeech':\n              var wordcount = self.quizhelper.count_words(message.capturedspeech);\n              self.wordcount.text(wordcount);\n              break;\n\n            case 'speech':\n              var speechtext = message.capturedspeech;\n\n              //update the wordcount\n              var wordcount = self.quizhelper.count_words(speechtext);\n              self.wordcount.text(wordcount);\n              self.do_evaluation(speechtext);\n              break;\n\n            case 'mediasaved':\n              log.debug('Mediaurl saved at passage reading: ' + message.mediaurl);\n              self.mediaurl = message.mediaurl;\n              break;\n\n          } //end of switch message type\n        };\n\n\n\n        //init tt recorder\n        var opts = {};\n        opts.uniqueid = itemdata.uniqueid;\n        opts.callback = recorderCallback;\n        opts.stt_guided = false\n        self.ttrec = ttrecorder.clone();\n        self.ttrec.init(opts);\n\n      }, //end of init components\n\n      do_corrections_markup: function (grammarerrors, grammarmatches, insertioncount) {\n        var self = this;\n        //corrected text container is created at runtime, so it wont exist at init_components time\n        //thats we find it here\n        var correctionscontainer = self.resultsbox.find('.mlfsr_correctedtext');\n        correctionsmarkup.init({\n          \"correctionscontainer\": correctionscontainer,\n          \"grammarerrors\": grammarerrors,\n          \"grammarmatches\": grammarmatches,\n          \"insertioncount\": insertioncount\n        });\n      },\n\n      do_evaluation: function (speechtext) {\n        var self = this;\n\n        //show a spinner while we do the AI stuff\n        self.resultsbox.hide();\n        self.actionbox.hide();\n        self.pendingbox.show();\n\n        //do evaluation\n        this.quizhelper.evaluateTranscript(speechtext, this.itemdata.itemid).then(function (ajaxresult) {\n          var transcript_evaluation = JSON.parse(ajaxresult);\n          if (transcript_evaluation) {\n            transcript_evaluation.reviewsettings = self.itemdata.reviewsettings;\n            //calculate raw score and percent score\n            transcript_evaluation.rawscore = self.calculate_score(transcript_evaluation);\n            self.rawscore = self.calculate_score(transcript_evaluation);\n            self.percentscore = 0;\n            if (self.itemdata.totalmarks > 0) {\n              self.percentscore = Math.round((self.rawscore / self.itemdata.totalmarks) * 100);\n            }\n            if (isNaN(self.percentscore)) {\n              self.percentscore = 0;\n            }\n            //add raw and percent score to trancript_evaluation for mustache\n            transcript_evaluation.rawscore = self.rawscore;\n            transcript_evaluation.percentscore = self.percentscore;\n            transcript_evaluation.rawspeech = speechtext;\n            transcript_evaluation.maxscore = self.itemdata.totalmarks;\n\n            // If we have a media url from our recording lets use it\n            transcript_evaluation.mediaurl = self.mediaurl;\n\n            // And save it upstairs\n            self.transcript_evaluation = transcript_evaluation;\n\n            var ystarcnt = 0;\n            var gstarcnt;\n            if (transcript_evaluation.reviewsettings.showscorestarrating) {\n              if (self.percentscore == 0) {\n                ystarcnt = 0;\n              } else if (self.percentscore < 19) {\n                ystarcnt = 1;\n              } else if (self.percentscore < 39) {\n                ystarcnt = 2;\n              } else if (self.percentscore < 59) {\n                ystarcnt = 3;\n              } else if (self.percentscore < 79) {\n                ystarcnt = 4;\n              } else {\n                ystarcnt = 5;\n              }\n\n              gstarcnt = 5 - ystarcnt;\n              self.transcript_evaluation.yellowstars = new Array(ystarcnt).fill(M.cfg, 0, ystarcnt);\n              self.transcript_evaluation.graystars = new Array(gstarcnt).fill(M.cfg, 0, gstarcnt);\n            }\n\n            log.debug(transcript_evaluation);\n            //display results or move next if not show item review\n            if (!self.quizhelper.showitemreview && !self.autosubmitmode) {\n              self.next_question();\n            } else {\n              //display results\n              templates.render('mod_minilesson/freespeakingresults', transcript_evaluation).then(\n                function (html, js) {\n                  self.resultsbox.html(html);\n                  //do corrections markup\n                  if (transcript_evaluation.hasOwnProperty('grammarerrors')) {\n                    self.do_corrections_markup(transcript_evaluation.grammarerrors,\n                      transcript_evaluation.grammarmatches,\n                      transcript_evaluation.insertioncount\n                    );\n                  }\n                  //show and hide\n                  self.resultsbox.show();\n                  self.pendingbox.hide();\n                  self.actionbox.hide();\n                  templates.runTemplateJS(js);\n                  //reset timer and wordcount on this page, in case reattempt\n                  self.wordcount.text('0');\n                  self.ttrec.timer.stop();\n                  self.ttrec.timer.reset();\n                  var displaytime = self.ttrec.timer.fetch_display_time();\n                  self.timerdisplay.html(displaytime);\n                }\n              );// End of templates\n              if (self.itemdata.timelimit > 0) {\n                var timerelement = $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container #progresstimer\");\n                var timerinterval = timerelement.attr('timer');\n                if (timerinterval) {\n                  clearInterval(timerinterval);\n                }\n              }\n            } //end of if show item review\n          } else {\n            log.debug('transcript_evaluation: oh no it failed');\n            self.resultsbox.hide();\n            self.pendingbox.hide();\n            self.actionbox.show();\n          }\n        });\n      },\n    };\n  });"],"names":["define","$","log","def","ttrecorder","correctionsmarkup","templates","debug","transcript_evaluation","rawscore","percentscore","autosubmitmode","mediaurl","clone","extend","this","init","index","itemdata","quizhelper","init_components","register_events","next_question","stepdata","hasgrade","lessonitemid","id","totalitems","totalmarks","correctitems","grade","resultsdata","do_next","calculate_score","wordsratio","countwords","stats","words","targetwordcount","relevanceratio","relevance","Math","round","marks","self","uniqueid","on","e","timelimit","show","progressTimer","height","timeLimit","onFinish","ontimelimitreached","ttrec","audio","isRecording","transcript","usebrowserrec","browserrec","stop","audiohelper","do_evaluation","trigger","allwords","thebutton","wordcount","actionbox","pendingbox","resultsbox","timerdisplay","opts","callback","message","type","count_words","capturedspeech","text","speechtext","stt_guided","do_corrections_markup","grammarerrors","grammarmatches","insertioncount","correctionscontainer","find","hide","evaluateTranscript","itemid","then","ajaxresult","JSON","parse","reviewsettings","isNaN","rawspeech","maxscore","gstarcnt","ystarcnt","showscorestarrating","yellowstars","Array","fill","M","cfg","graystars","showitemreview","render","html","js","hasOwnProperty","runTemplateJS","timer","reset","displaytime","fetch_display_time","timerinterval","attr","clearInterval"],"mappings":"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"}