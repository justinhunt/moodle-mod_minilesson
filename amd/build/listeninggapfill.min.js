define("mod_minilesson/listeninggapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates","core/str","core/notification"],(function($,log,ajax,def,polly,anim,progresstimer,templates,str,notification){return log.debug("MiniLesson listening gap fill: initialising"),{clone:function(){return $.extend(!0,{},this)},usevoice:"Amy",init:function(index,itemdata,quizhelper){this.strings={},this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.init_controls(),this.init_strings(),this.register_events(),this.setvoice(),this.getItems()},init_controls:function(){this.controls={container:$("#"+this.itemdata.uniqueid+"_container"),listen_cont:$("#"+this.itemdata.uniqueid+"_container .lgapfill_listen_cont"),nextbutton:$("#"+this.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:$("#"+this.itemdata.uniqueid+"_container .lgapfill_start_btn"),skip_btn:$("#"+this.itemdata.uniqueid+"_container .lgapfill_skip_btn"),ctrl_btn:$("#"+this.itemdata.uniqueid+"_container .lgapfill_ctrl-btn"),check_btn:$("#"+this.itemdata.uniqueid+"_container .lgapfill_check_btn"),game:$("#"+this.itemdata.uniqueid+"_container .lgapfill_game"),controlsbox:$("#"+this.itemdata.uniqueid+"_container .lgapfill_controls"),resultscontainer:$("#"+this.itemdata.uniqueid+"_container .lgapfill_resultscontainer"),mainmenu:$("#"+this.itemdata.uniqueid+"_container .lgapfill_mainmenu"),title:$("#"+this.itemdata.uniqueid+"_container .lgapfill_title"),progress_container:$("#"+this.itemdata.uniqueid+"_container .progress-container"),progress_bar:$("#"+this.itemdata.uniqueid+"_container .progress-container .progress-bar"),question:$("#"+this.itemdata.uniqueid+"_container .question"),listen_btn:$("#"+this.itemdata.uniqueid+"_container .lgapfill_listen_btn")}},init_strings:function(){var self=this;str.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(s){var i=0;self.strings.nextlessonitem=s[i++],self.strings.confirm_desc=s[i++],self.strings.yes=s[i++],self.strings.no=s[i++]}))},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.stop_audio(),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var listencont=this.controls.listen_cont,qbox=this.controls.question,gamebox=this.controls.game,controlsbox=this.controls.controlsbox,resultsbox=this.controls.resultscontainer;templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),listencont.hide(),qbox.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;self.controls.nextbutton.on("click",(function(e){self.items.some((item=>!item.answered))?notification.confirm(self.strings.nextlessonitem,self.strings.confirm_desc,self.strings.yes,self.strings.no,(function(){self.next_question()})):self.next_question()})),self.controls.start_btn.on("click",(function(){self.start()}));var audioplayerbtn=self.controls.listen_btn;audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-stop"),$(audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),self.controls.container.on("keydown",".single-character",(function(e){32==e.which&&(e.preventDefault(),audioplayerbtn.trigger("click"))})),self.controls.skip_btn.on("click",(function(){self.controls.ctrl_btn.prop("disabled",!0),self.controls.container.find(".lgapfill_speech.lgapfill_teacher_left").text(self.items[self.game.pointer].prompt+""),self.controls.container.find(".lgapfill_targetWord").each((function(){var realidx=$(this).data("realidx"),lgapfill_targetWord=self.items[self.game.pointer].lgapfill_targetWords[realidx];$(this).val(lgapfill_targetWord)})),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?(self.controls.skip_btn.prop("disabled",!0),self.controls.skip_btn.children(".fa").removeClass("fa-arrow-right"),self.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin"),setTimeout((function(){self.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin"),self.controls.skip_btn.children(".fa").addClass("fa-arrow-right"),self.controls.skip_btn.prop("disabled",!1),self.controls.container.find(".lgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),1500)):self.end()})),self.controls.check_btn.on("click",(function(){self.check_answer()})),self.controls.container.on("keydown",".single-character",(function(e){13==e.which&&self.check_answer()})),self.controls.container.on("keyup",".lgapfill_targetWord",(function(e){var target=e.srcElement||e.target,maxLength=parseInt(target.attributes.maxlength.value,10),myLength=target.value.length,key=e.which;if(myLength>=maxLength){var nextIdx=$(this).data("idx")+1,next=self.controls.container.find('input.lgapfill_targetWord[data-idx="'+nextIdx+'"');1===next.length&&next.focus()}else if((8==key||46==key)&&0===myLength){var previousIdx=$(this).data("idx")-1,previous=self.controls.container.find('input.lgapfill_targetWord[data-idx="'+previousIdx+'"');1===previous.length&&previous.focus()}}))},game:{pointer:0},check_answer:function(){var self=this,passage=self.items[self.game.pointer].parsedstring,characterunputs=self.controls.container.find(".lgapfill_reply_"+self.game.pointer+" input.single-character"),transcript=[];characterunputs.each((function(){var index=$(this).data("index"),value=$(this).val();transcript.push={index:index,value:value}})),self.getComparison(passage,transcript,(function(comparison){self.gotComparison(comparison)}))},setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var text_items=this.itemdata.sentences;this.items=text_items.map((function(target){return{target:target.sentence,prompt:target.prompt,parsedstring:target.parsedstring,definition:target.definition,typed:"",timer:[],answered:!1,correct:!1,audio:null,audiourl:target.audiourl?target.audiourl:"",imageurl:target.imageurl}})).filter((function(e){return""!==e.target})),$.each(this.items,(function(index,item){item.audio=new Audio,item.audio.src=item.audiourl})),this.appReady()},appReady:function(){this.controls.container.find(".lgapfill_not_loaded").hide(),this.controls.container.find(".lgapfill_loaded").show(),this.itemdata.hidestartpage?this.start():this.controls.start_btn.prop("disabled",!1)},gotComparison:function(comparison){var self=this;log.debug("gotComparison",comparison);var timelimit_progressbar=self.controls.progress_bar;if(self.controls.container.find(".lgapfill_reply_"+self.game.pointer+" input").removeClass("ml_gapfill_char_correct"),comparison.allcorrect)self.controls.container.find(".lgapfill_reply_"+self.game.pointer+' .lgapfill_feedback[data-idx="'+self.game.pointer+'"]').addClass("fa fa-check"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=!1,log.debug("correct!!"),self.controls.container.find(".lgapfill_reply_"+self.game.pointer+" input").addClass("ml_gapfill_char_correct");else{if(self.itemdata.allowretry&&!timelimit_progressbar.hasClass("progress-bar-complete")){comparison.charscorrect.forEach((function(iscorrect,index){iscorrect&&self.controls.container.find(".lgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]').addClass("ml_gapfill_char_correct")}));var thereply=self.controls.container.find(".lgapfill_reply_"+self.game.pointer);return void anim.do_animate(thereply,"shakeX animate__faster").then((function(){self.controls.ctrl_btn.prop("disabled",!1)}))}self.controls.container.find(".lgapfill_reply_"+self.game.pointer+' .lgapfill_feedback[data-idx="'+self.game.pointer+'"]').addClass("fa fa-times"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.items[self.game.pointer].typed=!1}self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1?setTimeout((function(){self.controls.container.find(".lgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()},getWords:function(thetext){for(var chunks=thetext.split(this.quizhelper.spliton_regexp).filter((function(e){return""!==e})),words=[],i=0;i<chunks.length;i++)chunks[i].match(this.quizhelper.spliton_regexp)||words.push(chunks[i]);return words},getComparison:function(passage,transcript,callback){var self=this;self.controls.ctrl_btn.prop("disabled",!0);var correctanswer=!0,charscorrect=[];passage.forEach((function(data,index){var char="";"input"===data.type&&(""==(char=self.controls.container.find(".lgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]').val())||char!=data.character?(correctanswer=!1,charscorrect[index]=!1):charscorrect[index]=!0)})),callback({allcorrect:correctanswer,charscorrect:charscorrect})},end:function(){var self=this;self.controls.nextbutton.prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){self.controls.nextbutton.prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2e3)},start:function(){this.controls.ctrl_btn.prop("disabled",!0),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,this.controls.listen_cont.show(),this.controls.question.show(),this.controls.game.show(),this.controls.start_btn.hide(),this.controls.mainmenu.hide(),this.controls.controlsbox.show(),this.nextPrompt()},nextPrompt:function(){var self=this;self.controls.ctrl_btn.prop("disabled",!1),self.updateProgressDots(),self.nextReply(),null===self.items[self.game.pointer].audio||self.quizhelper.mobile_user()||(self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{setTimeout((function(){self.controls.listen_btn.trigger("click")}),1e3)})):setTimeout((function(){self.controls.listen_btn.trigger("click")}),1e3))},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");self.controls.title.html(progress)},nextReply:function(){var code="<div class='lgapfill_reply lgapfill_reply_"+this.game.pointer+" text-center' style='display:none;'>",brackets={started:!1,ended:!1,index:null};code+="<div class='form-container'>",this.items[this.game.pointer].parsedstring.forEach((function(data,index){brackets.started&&!brackets.ended&&brackets.index!==data.index&&(brackets.started=brackets.ended=!1,code+="</span>"),"input"!==data.type&&"mtext"!==data.type||brackets.started||(code+='<span class="form-input-phrase-online" data-mindex="'+data.index+'">',brackets.started=!0),brackets.index=data.index,"input"===data.type?code+="<input class='single-character' type='text' autocomplete='off' autocapitalize='off' name='filltext"+index+"' maxlength='1' data-index='"+index+"'>":"mtext"===data.type?code+="<input class='single-character-mtext' autocomplete='off' autocapitalize='off' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),brackets.started&&!brackets.ended&&(code+="</span>"),code+=" <i data-idx='"+this.game.pointer+"' class='lgapfill_feedback'></i></div>",this.items[this.game.pointer].imageurl&&(code+="<div class='minilesson_sentence_image'><div class='minilesson_padded_image'><img src='"+this.items[this.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"),this.items[this.game.pointer].definition&&(code+="<div class='definition-container'><div class='definition'>"+this.items[this.game.pointer].definition+"</div>"),code+="</div>",this.controls.question.append(code);var newreply=this.controls.container.find(".lgapfill_reply_"+this.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),this.controls.ctrl_btn.prop("disabled",!1);var inputElements=Array.from(this.controls.container.find(".lgapfill_reply_"+this.game.pointer+" input.single-character"));this.formReady(inputElements),this.controls.container.find(".lgapfill_reply_"+this.game.pointer+" input.single-character:first").focus(),this.startTimer()},startTimer:function(){var self=this;if(self.itemdata.timelimit>0){var doStartTimer=function(){self.controls.progress_container.show(),self.controls.progress_container.find("i").show(),self.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){self.controls.skip_btn.trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))}))};self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{doStartTimer()})):doStartTimer()}},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))},stop_audio:function(){var theaudio=this.items[this.game.pointer].audio;theaudio&&!theaudio.paused&&theaudio.pause()},formReady:function(inputElements){inputElements.forEach((function(ele,index){ele.addEventListener("keydown",(function(e){switch(e.keyCode){case 8:""===e.target.value?inputElements[Math.max(0,index-1)].focus():e.target.classList.remove("ml_gapfill_char_correct");break;case 39:e.preventDefault(),inputElements[Math.min(inputElements.length-1,index+1)].focus();break;case 37:e.preventDefault(),inputElements[Math.max(0,index-1)].focus();break;default:""!==e.target.value&&1===e.key.length&&(e.target.value=e.target.value.replace(e.target.value,e.key),e.target.classList.remove("ml_gapfill_char_correct"),e.target.dispatchEvent(new Event("input")))}})),ele.addEventListener("input",(function(e){const[first,...rest]=e.target.value;e.target.value=null!=first?first:"";const lastInputBox=index===inputElements.length-1;void 0!==first&&!lastInputBox&&(inputElements[index+1].focus(),rest.length>0&&(inputElements[index+1].value=rest.join(""),inputElements[index+1].dispatchEvent(new Event("input"))))}))}))}}}));

//# sourceMappingURL=listeninggapfill.min.js.map