function _toArray(a){return _arrayWithHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithHoles(a){if(Array.isArray(a))return a}define ("mod_minilesson/listeninggapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates","core/str","core/notification"],function(a,b,c,d,e,f,g,h,i,j){"use strict";b.debug("MiniLesson listening gap fill: initialising");return{clone:function clone(){return a.extend(!0,{},this)},usevoice:"Amy",init:function init(a,b,c){var d=this;d.strings={};d.itemdata=b;d.quizhelper=c;d.index=a;var e={useanimatecss:c.useanimatecss};f.init(e);d.init_controls();d.init_strings();d.register_events();d.setvoice();d.getItems()},init_controls:function init_controls(){var b=this;b.controls={container:a("#"+b.itemdata.uniqueid+"_container"),listen_cont:a("#"+b.itemdata.uniqueid+"_container .lgapfill_listen_cont"),nextbutton:a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:a("#"+b.itemdata.uniqueid+"_container .lgapfill_start_btn"),skip_btn:a("#"+b.itemdata.uniqueid+"_container .lgapfill_skip_btn"),ctrl_btn:a("#"+b.itemdata.uniqueid+"_container .lgapfill_ctrl-btn"),check_btn:a("#"+b.itemdata.uniqueid+"_container .lgapfill_check_btn"),game:a("#"+b.itemdata.uniqueid+"_container .lgapfill_game"),controlsbox:a("#"+b.itemdata.uniqueid+"_container .lgapfill_controls"),resultscontainer:a("#"+b.itemdata.uniqueid+"_container .lgapfill_resultscontainer"),mainmenu:a("#"+b.itemdata.uniqueid+"_container .lgapfill_mainmenu"),title:a("#"+b.itemdata.uniqueid+"_container .lgapfill_title"),progress_container:a("#"+b.itemdata.uniqueid+"_container .progress-container"),progress_bar:a("#"+b.itemdata.uniqueid+"_container .progress-container .progress-bar"),question:a("#"+b.itemdata.uniqueid+"_container .question"),listen_btn:a("#"+b.itemdata.uniqueid+"_container .lgapfill_listen_btn"),description:a("#"+b.itemdata.uniqueid+"_container .lgapfill_description"),image:a("#"+b.itemdata.uniqueid+"_container .lgapfill_image_container"),maintitle:a("#"+b.itemdata.uniqueid+"_container .lgapfill_maintitle"),itemquestion:a("#"+b.itemdata.uniqueid+"_container .lgapfill_itemtext")}},init_strings:function init_strings(){var a=this;i.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(b){var c=0;a.strings.nextlessonitem=b[c++];a.strings.confirm_desc=b[c++];a.strings.yes=b[c++];a.strings.no=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.stop_audio();a.quizhelper.do_next(b)},show_item_review:function show_item_review(){var a=this,b={};b.items=a.items;a.items.forEach(function(a){var b=[];a.parsedstring.forEach(function(a){if("input"===a.type||"mtext"===a.type){b.push(a.character)}});var c=b.join(""),d=new RegExp(c,"gi"),e=a.correct?"correctitem":"wrongitem",f=a.target.replace(d,"<span class=\"".concat(e,"\">").concat(c,"</span>"));a.target=f});b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;var c=a.controls.listen_cont,d=a.controls.question,e=a.controls.game,f=a.controls.controlsbox,g=a.controls.resultscontainer;h.render("mod_minilesson/listitemresults",b).then(function(a,b){g.html(a);g.show();e.hide();f.hide();c.hide();d.hide();h.runTemplateJS(b)})},register_events:function register_events(){var b=this;b.controls.nextbutton.on("click",function(){if(b.items.some(function(a){return!a.answered})){j.confirm(b.strings.nextlessonitem,b.strings.confirm_desc,b.strings.yes,b.strings.no,function(){b.next_question()})}else{b.next_question()}});b.controls.start_btn.on("click",function(){b.start()});var c=b.controls.listen_btn;c.on("click",function(){var d=b.items[b.game.pointer].audio;if(!d.paused){d.pause();d.currentTime=0;a(c).removeClass("activeanimation");return}d.addEventListener("ended",function(){a(c).removeClass("activeanimation")});d.addEventListener("play",function(){a(c).addClass("activeanimation")});d.load();d.play()});b.controls.container.on("keydown",".single-character",function(a){if(32==a.which){a.preventDefault();c.trigger("click")}});b.controls.skip_btn.on("click",function(){b.controls.ctrl_btn.prop("disabled",!0);b.controls.container.find(".lgapfill_speech.lgapfill_teacher_left").text(b.items[b.game.pointer].prompt+"");b.controls.container.find(".lgapfill_targetWord").each(function(){var c=a(this).data("realidx"),d=b.items[b.game.pointer].lgapfill_targetWords[c];a(this).val(d)});b.stopTimer(b.items[b.game.pointer].timer);b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;if(b.game.pointer<b.items.length-1){b.controls.skip_btn.prop("disabled",!0);b.controls.skip_btn.children(".fa").removeClass("fa-arrow-right");b.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin");setTimeout(function(){b.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin");b.controls.skip_btn.children(".fa").addClass("fa-arrow-right");b.controls.skip_btn.prop("disabled",!1);b.controls.container.find(".lgapfill_reply_"+b.game.pointer).hide();b.game.pointer++;b.nextPrompt()},1500)}else{b.end()}});b.controls.check_btn.on("click",function(){b.check_answer()});b.controls.container.on("keydown",".single-character",function(a){if(13==a.which){b.check_answer()}});b.controls.container.on("keyup",".lgapfill_targetWord",function(c){var d=c.srcElement||c.target,e=parseInt(d.attributes.maxlength.value,10),f=d.value.length,g=c.which;if(f>=e){var h=a(this).data("idx")+1,i=b.controls.container.find("input.lgapfill_targetWord[data-idx=\""+h+"\"");if(1===i.length){i.focus()}}else if((8==g||46==g)&&0===f){var j=a(this).data("idx")-1,k=b.controls.container.find("input.lgapfill_targetWord[data-idx=\""+j+"\"");if(1===k.length){k.focus()}}})},game:{pointer:0},check_answer:function check_answer(){var b=this,c=b.items[b.game.pointer].parsedstring,d=b.controls.container.find(".lgapfill_reply_"+b.game.pointer+" input.single-character"),e=[];d.each(function(){var b=a(this).data("index"),c=a(this).val();e.push={index:b,value:c}});b.getComparison(c,e,function(a){b.gotComparison(a)})},setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{target:a.sentence,prompt:a.prompt,parsedstring:a.parsedstring,definition:a.definition,typed:"",timer:[],answered:!1,correct:!1,audio:null,audiourl:a.audiourl?a.audiourl:"",imageurl:a.imageurl}}).filter(function(a){return""!==a.target});a.each(b.items,function(a,b){b.audio=new Audio;b.audio.src=b.audiourl});b.appReady()},appReady:function appReady(){var a=this;a.controls.container.find(".lgapfill_not_loaded").hide();a.controls.container.find(".lgapfill_loaded").show();if(a.itemdata.hidestartpage){a.start()}else{a.controls.start_btn.prop("disabled",!1)}},gotComparison:function gotComparison(a){var c=this;b.debug("gotComparison",a);var d=c.controls.progress_bar;c.controls.container.find(".lgapfill_reply_"+c.game.pointer+" input").removeClass("ml_gapfill_char_correct");if(a.allcorrect){c.controls.container.find(".lgapfill_reply_"+c.game.pointer+" .lgapfill_feedback[data-idx=\""+c.game.pointer+"\"]").addClass("fa fa-check");c.items[c.game.pointer].answered=!0;c.items[c.game.pointer].correct=!0;c.items[c.game.pointer].typed=!1;b.debug("correct!!");c.controls.container.find(".lgapfill_reply_"+c.game.pointer+" input").addClass("ml_gapfill_char_correct")}else if(!c.itemdata.allowretry||d.hasClass("progress-bar-complete")){c.controls.container.find(".lgapfill_reply_"+c.game.pointer+" .lgapfill_feedback[data-idx=\""+c.game.pointer+"\"]").addClass("fa fa-times");c.items[c.game.pointer].answered=!0;c.items[c.game.pointer].correct=!1;c.items[c.game.pointer].typed=!1}else{a.charscorrect.forEach(function(a,b){if(a){c.controls.container.find(".lgapfill_reply_"+c.game.pointer+" input.single-character[data-index=\""+b+"\"]").addClass("ml_gapfill_char_correct")}});var e=c.controls.container.find(".lgapfill_reply_"+c.game.pointer);f.do_animate(e,"shakeX animate__faster").then(function(){c.controls.ctrl_btn.prop("disabled",!1)});return}c.stopTimer(c.items[c.game.pointer].timer);if(c.game.pointer<c.items.length-1){setTimeout(function(){c.controls.container.find(".lgapfill_reply_"+c.game.pointer).hide();c.game.pointer++;c.nextPrompt()},2e3)}else{c.end()}},getWords:function getWords(a){var b=this;if("false"==!1){a=a.toLowerCase()}for(var c=a.split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),d=[],e=0;e<c.length;e++){if(!c[e].match(b.quizhelper.spliton_regexp)){d.push(c[e])}}return d},getComparison:function getComparison(a,b,c){var d=this;d.controls.ctrl_btn.prop("disabled",!0);var e=!0,f=[];a.forEach(function(a,b){var c="";if("input"===a.type){c=d.controls.container.find(".lgapfill_reply_"+d.game.pointer+" input.single-character[data-index=\""+b+"\"]").val();if(""==c){e=!1;f[b]=!1}else if(c!=a.character){e=!1;f[b]=!1}else{f[b]=!0}}});var g={allcorrect:e,charscorrect:f};c(g)},end:function end(){var a=this;a.controls.nextbutton.prop("disabled",!0);a.updateProgressDots();setTimeout(function(){a.controls.nextbutton.prop("disabled",!1);if(a.quizhelper.showitemreview){a.controls.progress_container.removeClass("d-flex");a.controls.progress_container.hide();a.controls.title.hide();a.show_item_review()}else{a.next_question()}},2e3)},start:function start(){var a=this;a.controls.ctrl_btn.prop("disabled",!0);a.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});a.game.pointer=0;a.controls.listen_cont.show();a.controls.question.show();a.controls.game.show();a.controls.start_btn.hide();a.controls.description.hide();a.controls.image.hide();a.controls.maintitle.show();a.controls.itemquestion.show();a.controls.mainmenu.hide();a.controls.controlsbox.show();a.nextPrompt()},nextPrompt:function nextPrompt(){var a=this;a.controls.ctrl_btn.prop("disabled",!1);a.updateProgressDots();a.nextReply();if(null!==a.items[a.game.pointer].audio&&!a.quizhelper.mobile_user()){if(a.itemdata.hidestartpage&&0===a.game.pointer){a.controls.container.on("showElement",function(){setTimeout(function(){a.controls.listen_btn.trigger("click")},1e3)})}else{setTimeout(function(){a.controls.listen_btn.trigger("click")},1e3)}}},updateProgressDots:function updateProgressDots(){var a=this,b,c,d=a.items.map(function(d,e){b="#E6E9FD";c="fa fa-square";if(a.items[e].answered&&a.items[e].correct){b="#74DC72";c="fa fa-check-square"}else if(a.items[e].answered&&!a.items[e].correct){b="#FB6363";c="fa fa-window-close"}return"<i style='color:"+b+"' class='"+c+" pl-1'></i>"}).join(" ");a.controls.title.html(d)},nextReply:function nextReply(){var a=this,b="<div class='lgapfill_reply lgapfill_reply_"+a.game.pointer+" text-center' style='display:none;'>",c={started:!1,ended:!1,index:null};b+="<div class='form-container'>";a.items[a.game.pointer].parsedstring.forEach(function(a,d){if(c.started&&!c.ended&&c.index!==a.index){c.started=c.ended=!1;b+="</span>"}if(("input"===a.type||"mtext"===a.type)&&!c.started){b+="<span class=\"form-input-phrase-online\" data-mindex=\""+a.index+"\">";c.started=!0}c.index=a.index;if("input"===a.type){b+="<input class='single-character' type='text' autocomplete='off' autocapitalize='off' name='filltext"+d+"' maxlength='1' data-index='"+d+"'>"}else if("mtext"===a.type){b+="<input class='single-character-mtext' autocomplete='off' autocapitalize='off' type='text' name='readonly"+d+"' maxlength='1' value='"+a.character+"' readonly>"}else{b+=a.character}});if(c.started&&!c.ended){b+="</span>"}b+=" <i data-idx='"+a.game.pointer+"' class='lgapfill_feedback'></i></div>";if(a.items[a.game.pointer].imageurl){b+="<div class='minilesson_sentence_image'><div class='minilesson_padded_image'><img src='"+a.items[a.game.pointer].imageurl+"' alt='Image for gap fill' /></div></div>"}if(a.items[a.game.pointer].definition){b+="<div class='definition-container'><div class='definition'><div class='hinticon-container'><img class='icon' src='"+M.util.image_url('lightbulb-icon','mod_minilesson')+"' alt='hint'></div><h4 class='hint-title'>Hint</h4>"+a.items[a.game.pointer].definition+"</div>"}b+="</div>";a.controls.question.append(b);var d=a.controls.container.find(".lgapfill_reply_"+a.game.pointer);f.do_animate(d,"zoomIn animate__faster","in").then(function(){});a.controls.ctrl_btn.prop("disabled",!1);var e=Array.from(a.controls.container.find(".lgapfill_reply_"+a.game.pointer+" input.single-character"));a.formReady(e);a.controls.container.find(".lgapfill_reply_"+a.game.pointer+" input.single-character:first").focus();a.startTimer()},startTimer:function startTimer(){var b=this;if(0<b.itemdata.timelimit){var c=function(){b.controls.progress_container.show();b.controls.progress_container.addClass("d-flex align-items-center");b.controls.progress_container.find("i").show();var c=b.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){b.controls.skip_btn.trigger("click")}});c.each(function(){b.items[b.game.pointer].timer.push(a(this).attr("timer"))})};if(b.itemdata.hidestartpage&&0===b.game.pointer){b.controls.container.on("showElement",function(){c()})}else{c()}}},stopTimer:function stopTimer(a){if(a.length){a.forEach(function(a){clearInterval(a)})}},stop_audio:function stop_audio(){var a=this,b=a.items[a.game.pointer].audio;if(b&&!b.paused){b.pause()}},formReady:function formReady(a){a.forEach(function(b,c){b.addEventListener("keydown",function(b){switch(b.keyCode){case 8:if(""===b.target.value){a[Math.max(0,c-1)].focus()}else{b.target.classList.remove("ml_gapfill_char_correct")}break;case 39:b.preventDefault();a[Math.min(a.length-1,c+1)].focus();break;case 37:b.preventDefault();a[Math.max(0,c-1)].focus();break;default:if(""!==b.target.value&&1===b.key.length){b.target.value=b.target.value.replace(b.target.value,b.key);b.target.classList.remove("ml_gapfill_char_correct");b.target.dispatchEvent(new Event("input"))}break;}});b.addEventListener("input",function(b){var d=_toArray(b.target.value),e=d[0],f=d.slice(1);b.target.value=null!==e&&void 0!==e?e:"";var g=c===a.length-1;if(e!==void 0&&!g){a[c+1].focus();if(0<f.length){a[c+1].value=f.join("");a[c+1].dispatchEvent(new Event("input"))}}})})}}});
//# sourceMappingURL=listeninggapfill.min.js.map
