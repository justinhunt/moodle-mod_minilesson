{"version":3,"file":"multiaudio.min.js","sources":["../src/multiaudio.js"],"sourcesContent":["define(['jquery',\n    'core/log',\n    'mod_minilesson/definitions',\n    'mod_minilesson/pollyhelper',\n    'mod_minilesson/ttrecorder',\n    'mod_minilesson/animatecss'\n    ], function($, log, def, polly, ttrecorder,anim) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('MiniLesson Multiaudio: initialising');\n\n  return {\n\n      //a handle on the tt recorder\n      ttrec: null,\n\n      passmark: 90,//lower this if it often doesnt match (was 85)\n      playing: false,\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n\n      //anim\n      var animopts = {};\n        animopts.useanimatecss=quizhelper.useanimatecss;\n      anim.init(animopts);\n\n      this.prepare_audio(itemdata);\n      this.register_events(index, itemdata, quizhelper);\n      this.init_components(index, itemdata, quizhelper);\n    },\n    next_question: function(percent) {\n      var self = this;\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = 1;\n      stepdata.correctitems = percent>0?1:0;\n      stepdata.grade = percent;\n      self.quizhelper.do_next(stepdata);\n    },\n    register_events: function(index, itemdata, quizhelper) {\n      \n      var self = this;\n      var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\n      self.index = index;\n      self.quizhelper = quizhelper;\n      \n      $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function(e) {\n        self.next_question(0);\n      });\n      \n      $(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").on('click', function(e) {\n        //if disabled =>just return (already answered)\n          if($(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").hasClass('minilesson_mc_disabled')){\n            return;\n          }\n\n          //audio play requests\n          if (!self.playing) {\n              var el = this;\n              self.playing = true;\n              theplayer.attr('src', $(this).attr('data-src'));\n              theplayer[0].play();\n              theplayer[0].onended = function() {\n                  $(el).find(\".minilesson_mc_playstate\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n                  self.playing = false;\n              };\n              $(el).find(\".minilesson_mc_playstate\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\n          }else{\n              theplayer[0].pause();\n              theplayer[0].currentTime=0;\n              $(\"#\" + itemdata.uniqueid + \"_container .minilesson_mc_playstate\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n              self.playing = false;\n          }\n\n          //get selected item index\n          //var checked = $(this).data('index');\n\n      });\n      \n    },//end of register events\n\n    prepare_audio: function(itemdata) {\n         // debugger;\n          $.each(itemdata.sentences, function(index, sentence) {\n              polly.fetch_polly_url(sentence.sentence, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\n                  $(\"#\" + itemdata.uniqueid + \"_option\" + (index+1)).attr(\"data-src\", audiourl);\n              });\n          });\n    },\n\n    process_accepted_response: function(itemdata, checked){\n        var self = this;\n        //disable the answers, cos its answered\n        $(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").addClass('minilesson_mc_disabled');\n\n        if(self.quizhelper.showitemreview) {\n            //turn dots into text (if they were dots)\n            if (parseInt(itemdata.show_text) == 0) {\n                for (var i = 0; i < itemdata.sentences.length; i++) {\n                    var theline = $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1));\n                    $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1) + ' .minilesson_sentence').text(itemdata.sentences[i].sentence);\n                }\n            }\n\n            //reveal answers\n            $(\"#\" + itemdata.uniqueid + \"_container .minilesson_mc_wrong\").show();\n            $(\"#\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \" .minilesson_mc_wrong\").hide();\n            $(\"#\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \" .minilesson_mc_right\").show();\n        }\n        //highlight selected answers\n        $(\"#\" + itemdata.uniqueid + \"_option\" + checked + ' .minilesson_mc_response').addClass('minilesson_mc_selected');\n\n\n        var percent = checked == itemdata.correctanswer ? 100 : 0;\n\n        return percent;\n\n    },\n\n    init_components: function(index, itemdata, quizhelper) {\n        var app= this;\n        var correcttext = itemdata.sentences[itemdata.correctanswer-1].sentence;\n        var correctphonetic = itemdata.sentences[itemdata.correctanswer-1].phonetic;\n        var cleanincorrecttexts=[];\n\n        log.debug('initcomponents_multiaudio');\n        log.debug(itemdata.sentences);\n\n        for(var i=0;i<itemdata.sentences.length;i++){\n            if(i+1==itemdata.correctanswer) {\n                //to make life simple for ourselves we add an empty string entry in incorrecttexts at the correct answer index\n                //NB index of item in DOM is 1 based , so we need to mess with +1's\n                cleanincorrecttexts[i]='';\n            }else{\n                cleanincorrecttexts[i]=quizhelper.cleanText(itemdata.sentences[i].sentence);\n            }\n        }\n\n        var cleancorrecttext = quizhelper.cleanText(correcttext);\n\n        var theCallback = function(message) {\n\n            switch (message.type) {\n                case 'recording':\n\n                    break;\n\n                case 'speech':\n                    log.debug(\"speech at multiaudio\");\n                    var speechtext = message.capturedspeech;\n                    var cleanspeechtext = quizhelper.cleanText(speechtext);\n                    var spoken = cleanspeechtext;\n                    log.debug('speechtext:',speechtext);\n                    log.debug('spoken:',spoken);\n                    log.debug('correct:',cleancorrecttext);\n                    //Similarity check by character matching\n                    var similarity = quizhelper.similarity(spoken, cleancorrecttext);\n                    log.debug('JS similarity: ' + spoken + ':' + cleancorrecttext + ':' + similarity);\n\n                    //Similarity check by direct-match/acceptable-mistranscription\n                    if (similarity >= app.passmark ||\n                        app.wordsDoMatch(quizhelper, cleanspeechtext, cleancorrecttext)) {\n                        log.debug('local correct match:' + ':' + spoken + ':' + cleancorrecttext);\n                        var percent = app.process_accepted_response(itemdata, itemdata.correctanswer);\n\n                        //proceed to next question\n                        setTimeout(function() {\n                            $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                            app.next_question(percent);\n                        }, 2000);\n\n                        return;\n                    }else{\n                        for(var x=0;x<cleanincorrecttexts.length;x++){\n                            //if this is the correct answer index, just move on\n                            if(cleanincorrecttexts[x]===''){continue;}\n                            var similar = quizhelper.similarity(spoken, cleanincorrecttexts[x]);\n                            log.debug('JS similarity: ' + spoken + ':' + cleanincorrecttexts[x] + ':' + similar);\n                            if (similar >= app.passmark ||\n                                app.wordsDoMatch(quizhelper, cleanspeechtext, cleanincorrecttexts[x])) {\n\n                              //proceed to next question\n                                var percent = app.process_accepted_response(itemdata, x+1);\n                                $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n\n                                //proceed to next question\n                                setTimeout(function() {\n                                    $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                                    app.next_question(percent);\n                                }, 2000);\n                                return;\n                            }//end of if similarity\n                        }//end of for x\n                    }\n\n                    //Similarity check by phonetics(ajax)\n                    quizhelper.checkByPhonetic(cleancorrecttext,spoken, correctphonetic, itemdata.language).then(function(similarity) {\n                        if (similarity === false) {\n                            return $.Deferred().reject();\n                        } else {\n                            log.debug('PHP similarity: ' + spoken + ':' + cleancorrecttext + ':' + similarity);\n                            if (similarity >= app.passmark) {\n                                var percent = app.process_accepted_response(itemdata, itemdata.correctanswer);\n\n                                //proceed to next question\n                                $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n                                setTimeout(function() {\n                                    $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                                    app.next_question(percent);\n                                }, 2000);\n                            }\n                        } //end of if check_by_phonetic result\n\n                        //whatever was spoken was off, so give a visual indication of that\n                        //shake the screen\n                        var therecorder = $(\"#ttrec_container_\" + itemdata.uniqueid);\n                        anim.do_animate(therecorder,'shakeX animate__faster').then(\n                            function() {}\n                        );\n\n                    }); //end of check by phonetic\n\n            } //end of switch message type\n        };\n\n        //init tt recorder\n        var opts = {};\n        opts.uniqueid = itemdata.uniqueid;\n        log.debug('ma uniqueid:' + itemdata.uniqueid);\n        opts.callback = theCallback;\n        opts.stt_guided=quizhelper.is_stt_guided();\n        app.ttrec = ttrecorder.clone();\n        app.ttrec.init(opts);\n\n        //prompt for TT recorder\n        var allsentences=\"\";\n        for(var i=0;i< itemdata.sentences.length; i++){\n            allsentences += quizhelper.cleanText(itemdata.sentences[i].sentence) + ' ';\n        }\n        app.ttrec.currentPrompt=allsentences;\n\n    }, //end of init components\n\n    wordsDoMatch: function(quizhelper, phraseheard, currentphrase) {\n        //lets lower case everything\n        phraseheard = quizhelper.cleanText(phraseheard);\n        currentphrase = quizhelper.cleanText(currentphrase);\n        if (phraseheard == currentphrase) {\n            return true;\n        }\n        return false;\n    },\n  };\n});"],"names":["define","$","log","def","polly","ttrecorder","anim","debug","ttrec","passmark","playing","clone","extend","this","init","index","itemdata","quizhelper","animopts","useanimatecss","prepare_audio","register_events","init_components","next_question","percent","stepdata","hasgrade","totalitems","correctitems","grade","do_next","self","theplayer","uniqueid","on","e","hasClass","pause","currentTime","removeClass","addClass","el","attr","play","onended","find","each","sentences","sentence","fetch_polly_url","voiceoption","usevoice","then","audiourl","process_accepted_response","checked","showitemreview","parseInt","show_text","i","length","text","show","correctanswer","hide","app","correcttext","correctphonetic","phonetic","cleanincorrecttexts","cleanText","cleancorrecttext","opts","callback","message","type","speechtext","capturedspeech","cleanspeechtext","spoken","similarity","wordsDoMatch","setTimeout","prop","x","similar","checkByPhonetic","language","Deferred","reject","therecorder","do_animate","stt_guided","is_stt_guided","allsentences","currentPrompt","phraseheard","currentphrase"],"mappings":"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"}