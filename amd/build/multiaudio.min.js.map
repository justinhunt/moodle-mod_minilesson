{"version":3,"file":"multiaudio.min.js","sources":["../src/multiaudio.js"],"sourcesContent":["define(['jquery',\n    'core/log',\n    'mod_minilesson/definitions',\n    'mod_minilesson/pollyhelper',\n    'mod_minilesson/ttrecorder',\n    'mod_minilesson/animatecss'\n    ], function ($, log, def, polly, ttrecorder,anim) {\n        \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n        log.debug('MiniLesson Multiaudio: initialising');\n\n        return {\n\n            //a handle on the tt recorder\n            ttrec: null,\n\n            passmark: 90,//lower this if it often doesnt match (was 85)\n            playing: false,\n\n          //for making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n\n    //anim\n                var animopts = {};\n                animopts.useanimatecss = quizhelper.useanimatecss;\n                anim.init(animopts);\n\n                this.prepare_audio(itemdata);\n                this.register_events(index, itemdata, quizhelper);\n                this.init_components(index, itemdata, quizhelper);\n            },\n            next_question: function (percent) {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.totalitems = 1;\n                stepdata.correctitems = percent > 0 ? 1 : 0;\n                stepdata.grade = percent;\n                self.quizhelper.do_next(stepdata);\n            },\n            register_events: function (index, itemdata, quizhelper) {\n\n                var self = this;\n                var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\n                self.index = index;\n                self.quizhelper = quizhelper;\n\n                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function (e) {\n                            self.next_question(0);\n                });\n\n                $(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").on('click', function (e) {\n                            //if disabled =>just return (already answered)\n                    if ($(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").hasClass('minilesson_mc_disabled')) {\n                        return;\n                    }\n\n                  //audio play requests\n                    if (!self.playing) {\n                        var el = this;\n                        self.playing = true;\n                        theplayer.attr('src', $(this).attr('data-src'));\n                        theplayer[0].play();\n                        theplayer[0].onended = function () {\n                              $(el).find(\".minilesson_mc_playstate\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n                              self.playing = false;\n                        };\n                        $(el).find(\".minilesson_mc_playstate\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\n                    } else {\n                        theplayer[0].pause();\n                        theplayer[0].currentTime = 0;\n                        $(\"#\" + itemdata.uniqueid + \"_container .minilesson_mc_playstate\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n                        self.playing = false;\n                    }\n\n        //get selected item index\n        //var checked = $(this).data('index');\n\n                });\n\n                $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n                    if (itemdata.timelimit > 0) {\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").trigger('click');\n                            }\n                        });\n                    }\n                });\n\n            },//end of register events\n\n            prepare_audio: function (itemdata) {\n         // debugger;\n                $.each(itemdata.sentences, function (index, sentence) {\n                        polly.fetch_polly_url(sentence.sentence, itemdata.voiceoption, itemdata.usevoice).then(function (audiourl) {\n                            $(\"#\" + itemdata.uniqueid + \"_option\" + (index + 1)).attr(\"data-src\", audiourl);\n                        });\n                });\n            },\n\n            process_accepted_response: function (itemdata, checked) {\n                var self = this;\n        //disable the answers, cos its answered\n                $(\"#\" + itemdata.uniqueid + \"_container .mcplayrow\").addClass('minilesson_mc_disabled');\n\n                if (self.quizhelper.showitemreview) {\n                          //turn dots into text (if they were dots)\n                    if (parseInt(itemdata.show_text) == 0) {\n                        for (var i = 0; i < itemdata.sentences.length; i++) {\n                                  var theline = $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1));\n                                  $(\"#\" + itemdata.uniqueid + \"_option\" + (i + 1) + ' .minilesson_sentence').text(itemdata.sentences[i].sentence);\n                        }\n                    }\n\n                  //reveal answers\n                    $(\"#\" + itemdata.uniqueid + \"_container .minilesson_mc_wrong\").show();\n                    $(\"#\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \" .minilesson_mc_wrong\").hide();\n                    $(\"#\" + itemdata.uniqueid + \"_option\" + itemdata.correctanswer + \" .minilesson_mc_right\").show();\n                }\n        //highlight selected answers\n                $(\"#\" + itemdata.uniqueid + \"_option\" + checked + ' .minilesson_mc_response').addClass('minilesson_mc_selected');\n\n\n                var percent = checked == itemdata.correctanswer ? 100 : 0;\n\n                return percent;\n\n            },\n\n            init_components: function (index, itemdata, quizhelper) {\n                var app = this;\n                var correcttext = itemdata.sentences[itemdata.correctanswer - 1].sentence;\n                var correctphonetic = itemdata.sentences[itemdata.correctanswer - 1].phonetic;\n                var cleanincorrecttexts = [];\n\n                log.debug('initcomponents_multiaudio');\n                log.debug(itemdata.sentences);\n\n                for (var i = 0; i < itemdata.sentences.length; i++) {\n                    if (i + 1 == itemdata.correctanswer) {\n                //to make life simple for ourselves we add an empty string entry in incorrecttexts at the correct answer index\n                //NB index of item in DOM is 1 based , so we need to mess with +1's\n                        cleanincorrecttexts[i] = '';\n                    } else {\n                        cleanincorrecttexts[i] = quizhelper.cleanText(itemdata.sentences[i].sentence);\n                    }\n                }\n\n                var cleancorrecttext = quizhelper.cleanText(correcttext);\n\n                var theCallback = function (message) {\n\n                    switch (message.type) {\n                        case 'recording':\n\n                        break;\n\n                        case 'speech':\n                            log.debug(\"speech at multiaudio\");\n                            var speechtext = message.capturedspeech;\n                            var cleanspeechtext = quizhelper.cleanText(speechtext);\n                            var spoken = cleanspeechtext;\n                            log.debug('speechtext:',speechtext);\n                            log.debug('spoken:',spoken);\n                            log.debug('correct:',cleancorrecttext);\n                            //Similarity check by character matching\n                            var similarity = quizhelper.similarity(spoken, cleancorrecttext);\n                            log.debug('JS similarity: ' + spoken + ':' + cleancorrecttext + ':' + similarity);\n\n                            //Similarity check by direct-match/acceptable-mistranscription\n                            if (similarity >= app.passmark ||\n                            app.wordsDoMatch(quizhelper, cleanspeechtext, cleancorrecttext)) {\n                                log.debug('local correct match:' + ':' + spoken + ':' + cleancorrecttext);\n                                var percent = app.process_accepted_response(itemdata, itemdata.correctanswer);\n\n                                //proceed to next question\n                                setTimeout(function () {\n                                    $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                                    app.next_question(percent);\n                                }, 2000);\n\n                                return;\n                            } else {\n                                for (var x = 0; x < cleanincorrecttexts.length; x++) {\n                                    //if this is the correct answer index, just move on\n                                    if (cleanincorrecttexts[x] === '') {\n                                        continue;}\n                                    var similar = quizhelper.similarity(spoken, cleanincorrecttexts[x]);\n                                    log.debug('JS similarity: ' + spoken + ':' + cleanincorrecttexts[x] + ':' + similar);\n                                    if (similar >= app.passmark ||\n                                    app.wordsDoMatch(quizhelper, cleanspeechtext, cleanincorrecttexts[x])) {\n                                      //proceed to next question\n                                        var percent = app.process_accepted_response(itemdata, x + 1);\n                                        $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n\n                                        //proceed to next question\n                                        setTimeout(function () {\n                                            $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                                            app.next_question(percent);\n                                        }, 2000);\n                                        return;\n                                    }//end of if similarity\n                                }//end of for x\n                            }\n\n                            //Similarity check by phonetics(ajax)\n                            quizhelper.checkByPhonetic(cleancorrecttext,spoken, correctphonetic, itemdata.language).then(function (similarity) {\n                                if (similarity === false) {\n                                    return $.Deferred().reject();\n                                } else {\n                                    log.debug('PHP similarity: ' + spoken + ':' + cleancorrecttext + ':' + similarity);\n                                    if (similarity >= app.passmark) {\n                                        var percent = app.process_accepted_response(itemdata, itemdata.correctanswer);\n\n                                        //proceed to next question\n                                        $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n                                        setTimeout(function () {\n                                            $(\".minilesson_nextbutton\").prop(\"disabled\", false);\n                                            app.next_question(percent);\n                                        }, 2000);\n                                    }\n                                } //end of if check_by_phonetic result\n\n                                //whatever was spoken was off, so give a visual indication of that\n                                //shake the screen\n                                var therecorder = $(\"#ttrec_container_\" + itemdata.uniqueid);\n                                anim.do_animate(therecorder,'shakeX animate__faster').then(\n                                    function () {}\n                                );\n\n                            }); //end of check by phonetic\n                    } //end of switch message type\n                };\n\n          //init tt recorder\n                var opts = {};\n                opts.uniqueid = itemdata.uniqueid;\n                log.debug('ma uniqueid:' + itemdata.uniqueid);\n                opts.callback = theCallback;\n                opts.stt_guided = quizhelper.is_stt_guided();\n                app.ttrec = ttrecorder.clone();\n                app.ttrec.init(opts);\n\n          //prompt for TT recorder\n                var allsentences = \"\";\n                for (var i = 0; i < itemdata.sentences.length; i++) {\n                        allsentences += quizhelper.cleanText(itemdata.sentences[i].sentence) + ' ';\n                }\n                app.ttrec.currentPrompt = allsentences;\n\n            }, //end of init components\n\n            wordsDoMatch: function (quizhelper, phraseheard, currentphrase) {\n        //lets lower case everything\n                phraseheard = quizhelper.cleanText(phraseheard);\n                currentphrase = quizhelper.cleanText(currentphrase);\n                if (phraseheard == currentphrase) {\n                          return true;\n                }\n                return false;\n            },\n        };\n    });"],"names":["define","$","log","def","polly","ttrecorder","anim","debug","ttrec","passmark","playing","clone","extend","this","init","index","itemdata","quizhelper","animopts","useanimatecss","prepare_audio","register_events","init_components","next_question","percent","stepdata","hasgrade","totalitems","correctitems","grade","do_next","self","theplayer","uniqueid","on","e","hasClass","pause","currentTime","removeClass","addClass","el","attr","play","onended","find","timelimit","show","progressTimer","height","timeLimit","onFinish","trigger","each","sentences","sentence","fetch_polly_url","voiceoption","usevoice","then","audiourl","process_accepted_response","checked","showitemreview","parseInt","show_text","i","length","text","correctanswer","hide","app","correcttext","correctphonetic","phonetic","cleanincorrecttexts","cleanText","cleancorrecttext","opts","callback","message","type","speechtext","capturedspeech","cleanspeechtext","spoken","similarity","wordsDoMatch","setTimeout","prop","x","similar","checkByPhonetic","language","Deferred","reject","therecorder","do_animate","stt_guided","is_stt_guided","allsentences","currentPrompt","phraseheard","currentphrase"],"mappings":"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"}