{"version":3,"file":"searchlesson.min.js","sources":["../src/searchlesson.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module searchlesson\n *\n * @module     mod_minilesson/searchlesson\n * @copyright  2025 Justin Hunt (poodllsupport@gmail.com)\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport * as Notification from 'core/notification';\nimport Templates from 'core/templates';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport * as Str from 'core/str';\nimport Fragment from 'core/fragment';\n\n\nconst component = 'mod_minilesson';\n\nexport const registerFilter = () => {\n    const form = document.querySelector('#lessonbank_filters');\n    const cardsContainer = document.querySelector('[data-region=\"cards-container\"]');\n    const gridlayoutbtn = document.querySelector('.gridlayoutbtn');\n    const listlayoutbtn = document.querySelector('.listlayoutbtn');\n    const countcontainer = document.querySelector('.countcontainer');\n    const pagination = document.querySelector('[name=\"perpageselection\"]');\n\n    gridlayoutbtn?.addEventListener('click', e => {\n        e.preventDefault();\n        cardsContainer.classList.remove('listlayout');\n        gridlayoutbtn.classList.add('active');\n        listlayoutbtn.classList.remove('active');\n        searchFilter(form);\n    });\n\n    listlayoutbtn?.addEventListener('click', e => {\n        e.preventDefault();\n        cardsContainer.classList.add('listlayout');\n        listlayoutbtn.classList.add('active');\n        gridlayoutbtn.classList.remove('active');\n        searchFilter(form);\n    });\n\n    const searchFilter = form => {\n\n        const functionname = 'local_lessonbank_list_minilessons';\n        const params = new URLSearchParams();\n        if (form.elements['searchgroup[language]']) {\n            params.append('language', form.elements['searchgroup[language]'].value);\n        }\n        if (form.elements['searchgroup[keyword]']) {\n            params.append('keywords', form.elements['searchgroup[keyword]'].value);\n        }\n        if (form.elements['level[]']) {\n            const selectedOptions = form.elements['level[]'].selectedOptions;\n            Array.from(selectedOptions).forEach((option, index) => {\n                params.append(`level[${index}]`, option.value);\n            });\n        }\n        if (form.elements.page) {\n            params.append('page', form.elements.page.value);\n        }\n        if (form.elements.perpage) {\n            params.append('perpage', form.elements.perpage.value);\n        }\n        const args = {\n            function : functionname,\n            args: params.toString(),\n        };\n        Ajax.call([{\n            methodname: `${component}_lessonbank`,\n            args: args,\n        }])[0].then(items => {\n            items = JSON.parse(items.data);\n            items.islistlayot = cardsContainer.classList.contains('listlayout') ? true : false;\n            if (countcontainer) {\n                Str.get_string('foundlessons', 'mod_minilesson', items.totalitems).then((langstr) => {\n                    countcontainer.textContent = langstr;\n                });\n            }\n            Templates.render(`${component}/lessonbankitems`, items)\n            .then((html, js) => {\n                return Templates.replaceNodeContents(cardsContainer, html, js);\n            }).then(() => {\n                document.querySelector('#region-main')?.scrollIntoView({\n                    behavior: \"smooth\",\n                    block: \"start\"\n                });\n            });\n            return null;\n        })\n        .catch(Notification.exception);\n    };\n    cardsContainer.addEventListener('click', e => {\n        if (e.target.href) {\n            return;\n        }\n        e.preventDefault();\n        const dirbtn = e.target.closest('[data-action=\"previousbtn\"],[data-action=\"nextbtn\"]');\n        if (dirbtn) {\n            const pageno = dirbtn.getAttribute('data-page');\n            const perpage = dirbtn.getAttribute('data-perpage');\n            const pagevalue = parseInt(pageno, 10) + (dirbtn.dataset.action === 'previousbtn' ? -1 : 1);\n            if (form) {\n                form.elements.page.value = pagevalue;\n                form.elements.perpage.value = perpage;\n                searchFilter(form);\n            }\n        }\n        const downloadbtn = e.target.closest('[data-action=\"download\"]');\n        if (downloadbtn) {\n            if (!downloadbtn.dataset.id) {\n                return;\n            }\n            const id = Number(downloadbtn.dataset.id);\n            const url = new URL(window.location.href);\n            url.searchParams.set('restore', id);\n            url.searchParams.set('sesskey', M.cfg.sesskey);\n            window.location.href = url.toString();\n        }\n        const showtextbtn = e.target.closest('[data-action=\"showtext\"]');\n        if (showtextbtn) {\n            const wrapper = showtextbtn.parentElement;\n            const titlehtml = wrapper.firstElementChild.cloneNode(true).outerHTML;\n            wrapper.innerHTML = titlehtml + wrapper.dataset.text;\n        }\n    });\n    cardsContainer.addEventListener('click', e => {\n        if (e.target.href) {\n            return;\n        }\n        e.preventDefault();\n        const translatebtn = e.target.closest('[data-action=\"translate\"]');\n        if (translatebtn) {\n            const callFragment = data => {\n                return Fragment.loadFragment(component, 'translatetoimport', M.cfg.contextid, {\n                    params: data\n                })\n                .then((response, js) => new Promise(resolve => {\n                    response = JSON.parse(response);\n                    return resolve(\n                        response,\n                        js\n                    );\n                }));\n            };\n            ModalFactory.create({\n                type: ModalFactory.types.DEFAULT,\n                large: false,\n                removeOnClose: true,\n                title: Str.get_string('translatetoimport', component),\n                body: callFragment(\n                    new URLSearchParams([...Object.entries(translatebtn.dataset)]).toString()\n                ).then((response, js) => new Promise(resolve => resolve(\n                    response.html,\n                    js\n                )))\n            }).then(function (modal) {\n                modal.hideFooter();\n                modal.getRoot().on('submit ' + ModalEvents.save, function (e) {\n                    e.preventDefault();\n                    var form = this.querySelector('form');\n                    modal.setBody(\n                        callFragment(new URLSearchParams(new FormData(form)).toString())\n                        .then((response, js) => new Promise(resolve => {\n                            if (response.redirecturl) {\n                                location.href = response.redirecturl;\n                                resolve('', js);\n                                return;\n                            }\n                            resolve(response.html, js);\n                        }))\n                    );\n                });\n                modal.show();\n            });\n        }\n    });\nif (pagination) {\n    pagination.addEventListener('change', e => {\n        const perpagevalue = e.target.value;\n        if (form) {\n            form.elements.page.value = 1;\n            form.elements.perpage.value = perpagevalue;\n            searchFilter(form);\n        }\n        });\n}\n    form?.addEventListener('submit', e => {\n        e.preventDefault();\n        form.querySelector('[name=\"page\"]').value = 1;\n        searchFilter(form);\n    });\nif (form) {\n    searchFilter(form);\n}\n};"],"names":["component","form","document","querySelector","cardsContainer","gridlayoutbtn","listlayoutbtn","countcontainer","pagination","addEventListener","e","preventDefault","classList","remove","add","searchFilter","params","URLSearchParams","elements","append","value","selectedOptions","Array","from","forEach","option","index","page","perpage","args","function","toString","call","methodname","then","items","JSON","parse","data","islistlayot","contains","Str","get_string","totalitems","langstr","textContent","render","html","js","Templates","replaceNodeContents","scrollIntoView","behavior","block","catch","Notification","exception","target","href","dirbtn","closest","pageno","getAttribute","pagevalue","parseInt","dataset","action","downloadbtn","id","Number","url","URL","window","location","searchParams","set","M","cfg","sesskey","showtextbtn","wrapper","parentElement","titlehtml","firstElementChild","cloneNode","outerHTML","innerHTML","text","translatebtn","callFragment","Fragment","loadFragment","contextid","response","Promise","resolve","create","type","ModalFactory","types","DEFAULT","large","removeOnClose","title","body","Object","entries","modal","hideFooter","getRoot","on","ModalEvents","save","this","setBody","FormData","redirecturl","show","perpagevalue"],"mappings":"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"}