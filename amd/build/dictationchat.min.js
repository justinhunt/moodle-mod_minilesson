define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss","core/templates"],(function($,log,ajax,def,polly,anim,templates){return log.debug("MiniLesson dictation chat: initialising"),{clone:function(){return $.extend(!0,{},this)},usevoice:"Amy",init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.register_events(),this.setvoice(),this.getItems()},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.stop_audio(),this.quizhelper.do_next(stepdata)},show_item_review:function(){this.items.forEach((function(item){var itemwordlist=[];item.dictate_targetWords.forEach((function(data){""!==data&&itemwordlist.push(data)}));var wordmatch=itemwordlist.join(""),regex=new RegExp(wordmatch,"gi"),answerclass=item.correct?"correctitem":"wrongitem",result=item.target.replace(regex,'<span class="'.concat(answerclass,'">').concat(wordmatch,"</span>"));item.target=result}));var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var gamebox=$("#"+this.itemdata.uniqueid+"_container .dictate_game"),controlsbox=$("#"+this.itemdata.uniqueid+"_container .dictate_controls"),recorderbox=$("#"+this.itemdata.uniqueid+"_container .dictate_speakbtncontainer"),resultsbox=$("#"+this.itemdata.uniqueid+"_container .dictate_resultscontainer"),title=(resultsbox=$("#"+this.itemdata.uniqueid+"_container .dictate_resultscontainer"),$("#"+this.itemdata.uniqueid+"_container .dictate_title")),listencontroler=$("#"+this.itemdata.uniqueid+"_container .dictate_listen_controler");templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),recorderbox.hide(),title.hide(),listencontroler.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;$("#"+self.itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){self.next_question()})),$("#"+self.itemdata.uniqueid+"_container .dictate_start_btn").on("click",(function(){self.start()}));var audioplayerbtn=$("#"+self.itemdata.uniqueid+"_container .dictate_listen_btn");audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,audioplayerbtn.children(".fa").removeClass("fa-stop"),void audioplayerbtn.children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){audioplayerbtn.children(".fa").removeClass("fa-stop"),audioplayerbtn.children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){audioplayerbtn.children(".fa").removeClass("fa-volume-up"),audioplayerbtn.children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),$("#"+self.itemdata.uniqueid+"_container .dictate_skip_btn").on("click",(function(){$("#"+self.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .dictate_speech.dictate_teacher_left").text(self.items[self.game.pointer].displayprompt+""),$("#"+self.itemdata.uniqueid+"_container .dictate_targetWord").each((function(){var realidx=$(this).data("realidx"),dictate_targetWord=self.items[self.game.pointer].dictate_targetWords[realidx];$(this).val(dictate_targetWord)})),self.game.pointer<self.items.length-1?setTimeout((function(){self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer++,self.nextPrompt()}),3e3):self.end()})),$("#"+self.itemdata.uniqueid+"_container .dictate_check_btn").on("click",(function(){self.check_answer()})),$("#"+self.itemdata.uniqueid+"_container").on("keydown",".dictate_targetWord",(function(e){13==e.which&&self.check_answer()})),$("#"+self.itemdata.uniqueid+"_container").on("keyup",".dictate_targetWord",(function(e){var target=e.srcElement||e.target,maxLength=parseInt(target.attributes.maxlength.value,10),myLength=target.value.length,key=e.which;if(myLength>=maxLength){var nextIdx=$(this).data("idx")+1,next=$("#"+self.itemdata.uniqueid+'_container input.dictate_targetWord[data-idx="'+nextIdx+'"');1===next.length&&next.focus()}else if((8==key||46==key)&&0===myLength){var previousIdx=$(this).data("idx")-1,previous=$("#"+self.itemdata.uniqueid+'_container input.dictate_targetWord[data-idx="'+previousIdx+'"');1===previous.length&&previous.focus()}}))},game:{pointer:0},check_answer:function(){var self=this,passage=self.items[self.game.pointer].target,transcript="";$("#"+self.itemdata.uniqueid+"_container .dictate_targetBit").each((function(){$(this).hasClass("dictate_targetWord")?transcript+=$(this).val():$(this).hasClass("dictate_targetWordPunc")&&(transcript+=$(this).text())})),self.getComparison(passage,transcript,(function(comparison){self.gotComparison(comparison,transcript)}))},setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{dictate_targetWords:target.sentence.trim().split(self.quizhelper.spliton_regexp).filter((function(e){return""!==e})),target:target.sentence,prompt:target.prompt,displayprompt:target.displayprompt,typed:"",answered:!1,correct:!1,audio:null,audiourl:target.audiourl?target.audiourl:"",imageurl:target.imageurl}})).filter((function(e){return""!==e.target})),$.each(self.items,(function(index,item){item.audio=new Audio,item.audio.src=item.audiourl,0==self.items.filter((function(e){return null==e.audio})).length?self.appReady():console.log(self.items)}))},appReady:function(){$("#"+this.itemdata.uniqueid+"_container .dictate_not_loaded").hide(),$("#"+this.itemdata.uniqueid+"_container .dictate_loaded").show(),$("#"+this.itemdata.uniqueid+"_container .dictate_start_btn").prop("disabled",!1)},gotComparison:function(comparison,typed){var self=this;if($("#"+self.itemdata.uniqueid+"_container .dictate_targetWord").removeClass("dictate_correct dictate_incorrect"),$("#"+self.itemdata.uniqueid+"_container .dictate_feedback").removeClass("fa fa-check fa-times"),0==comparison.filter((function(e){return!e.matched})).length)$("#"+self.itemdata.uniqueid+"_container .dictate_targetWord").addClass("dictate_correct").prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .dictate_feedback").addClass("fa fa-check"),$("#"+self.itemdata.uniqueid+"_container .dictate_speech.dictate_teacher_left").text(self.items[self.game.pointer].displayprompt+""),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=typed,$("#"+self.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0),self.game.pointer<self.items.length-1?setTimeout((function(){self.game.pointer++,self.nextPrompt()}),2200):self.end();else{comparison.forEach((function(obj){obj.matched?($("#"+self.itemdata.uniqueid+"_container .dictate_targetWord[data-idx='"+obj.wordnumber+"']").addClass("dictate_correct").prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .dictate_feedback[data-idx='"+obj.wordnumber+"']").addClass("fa fa-check")):($("#"+self.itemdata.uniqueid+"_container .dictate_targetWord[data-idx='"+obj.wordnumber+"']").addClass("dictate_incorrect"),$("#"+self.itemdata.uniqueid+"_container .dictate_feedback[data-idx='"+obj.wordnumber+"']").addClass("fa fa-times"))}));var thereply=$("#"+self.itemdata.uniqueid+"_container .dictate_reply_"+self.game.pointer);anim.do_animate(thereply,"shakeX animate__faster").then((function(){$("#"+self.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!1)}))}$("#"+self.itemdata.uniqueid+"_container .dictate_targetWord.dictate_correct").each((function(){var realidx=$(this).data("realidx"),dictate_targetWord=self.items[self.game.pointer].dictate_targetWords[realidx];$(this).val(dictate_targetWord)}))},getWords:function(thetext){for(var chunks=thetext.split(this.quizhelper.spliton_regexp).filter((function(e){return""!==e})),words=[],i=0;i<chunks.length;i++)chunks[i].match(this.quizhelper.spliton_regexp)||words.push(chunks[i]);return words},getComparison:function(passage,transcript,callback){$(".dictate_ctrl-btn").prop("disabled",!0);this.quizhelper.comparePassageToTranscript(passage,transcript,"",this.itemdata.language).then((function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)}))},end:function(){var self=this;$(".minilesson_nextbutton").prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2200)},start:function(){$("#"+this.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!0),$("#"+this.itemdata.uniqueid+"_container .dictate_title").show(),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,$("#"+this.itemdata.uniqueid+"_container .dictate_game").show(),$("#"+this.itemdata.uniqueid+"_container .dictate_start_btn").hide(),$("#"+this.itemdata.uniqueid+"_container .dictate_mainmenu").hide(),$("#"+this.itemdata.uniqueid+"_container .dictate_controls").show(),$("#"+this.itemdata.uniqueid+"_container .dictate_image_container").hide(),$("#"+this.itemdata.uniqueid+"_container .dictate_description").hide(),$("#"+this.itemdata.uniqueid+"_container .dictate_maintitle").show(),$("#"+this.itemdata.uniqueid+"_container .dictate_itemtext").show(),$("#"+this.itemdata.uniqueid+"_container .dictate_listen_controler").show(),this.nextPrompt()},nextPrompt:function(){this.items[this.game.pointer].target;var prompt=this.items[this.game.pointer].prompt,dots=(this.items[this.game.pointer].displayprompt,prompt.replace(this.quizhelper.nopunc_regexp,"").replace(this.quizhelper.nonspaces_regexp,"â€¢")),code="<div class='dictate_prompt dictate_prompt_"+this.game.pointer+"' style='display:none;'>";code+="<i class='fa fa-graduation-cap dictate_speech-icon-left'></i>",code+="<div style='margin-left:90px;' class='dictate_speech dictate_teacher_left'>",code+=dots,code+="</div>",code+="</div>",$("#"+this.itemdata.uniqueid+"_container .dictate_game").html(code),$(".dictate_ctrl-btn").prop("disabled",!1),this.updateProgressDots();var newprompt=$(".dictate_prompt_"+this.game.pointer);anim.do_animate(newprompt,"zoomIn animate__faster","in").then((function(){})),this.nextReply()},updateProgressDots:function(){var color,icon,self=this,progress=self.items.map((function(item,idx){return color="#E6E9FD",icon="fa fa-square",self.items[idx].answered&&self.items[idx].correct?(color="#74DC72",icon="fa fa-check-square"):self.items[idx].answered&&!self.items[idx].correct&&(color="#FB6363",icon="fa fa-window-close"),"<i style='color:"+color+"' class='"+icon+" pl-1'></i>"})).join(" ");$("#"+self.itemdata.uniqueid+"_container .dictate_title").html(progress)},nextReply:function(){var self=this,code=(self.items[self.game.pointer].target,"<div class='dictate_reply dictate_reply_"+self.game.pointer+"' style='display:none;'>");code+="<i class='fa fa-user dictate_speech-icon-right'></i>";var dictate_targetWordsCode="",idx=1;self.items[self.game.pointer].dictate_targetWords.forEach((function(word,realidx){word.match(self.quizhelper.spliton_regexp)?dictate_targetWordsCode+="<span class='dictate_targetBit dictate_targetWordPunc' data-idx='"+idx+"'>"+word+"</span>":(dictate_targetWordsCode+="<ruby><input type='text' maxlength='"+word.length+"' size='"+(word.length+1)+"' class='dictate_targetBit dictate_targetWord' data-realidx='"+realidx+"' data-idx='"+idx+"'><rt><i data-idx='"+idx+"' class='dictate_feedback'></i></rt></ruby>",idx++)})),code+="<div style='margin-right:90px;' class='dictate_speech dictate_right'>"+dictate_targetWordsCode+"</div>",code+="</div>",$("#"+self.itemdata.uniqueid+"_container .dictate_game").append(code);var newreply=$(".dictate_reply_"+self.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),$("#"+self.itemdata.uniqueid+"_container .dictate_ctrl-btn").prop("disabled",!1),setTimeout((function(){$(".dictate_targetWord").first().focus(),$("#"+self.itemdata.uniqueid+"_container .dictate_listen_btn").trigger("click")}),500)},stop_audio:function(){var theaudio=this.items[this.game.pointer].audio;theaudio&&!theaudio.paused&&theaudio.pause()}}}));

//# sourceMappingURL=dictationchat.min.js.map