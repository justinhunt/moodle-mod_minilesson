define ("mod_minilesson/passagereading",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/ttrecorder","core/notification","core/str","core/templates"],function(a,b,c,d,f,g,h){"use strict";b.debug("MiniLesson Passage Reading: initialising");return{allwords:{},strings:{},totals:{correct:0,incorrect:0,unreached:0,read:0,accuracy:0,score:0,comparison:{}},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.index=a;this.itemdata=b;this.quizhelper=c;this.init_strings();this.init_components(c,b);this.register_events(a,b,c)},init_strings:function init_strings(){var a=this;g.get_strings([{key:"reattempt",component:"mod_minilesson"},{key:"reallyreattempt",component:"mod_minilesson"}]).done(function(b){var c=0;a.strings.reattempt=b[c++];a.strings.reallyreattempt=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=0;b.correctitems=0;var c=0;if(0<a.allwords.length){c=Math.round(100*(a.totals.correct/a.allwords.length));if(0<a.itemdata.totalmarks){b.totalitems=a.itemdata.totalmarks;b.correctitems=Math.round(a.totals.correct/a.allwords.length*a.itemdata.totalmarks)}else{b.totalitems=a.allwords.length;b.correctitems=a.totals.correct}}b.grade=c;b.resultsdata=a.totals;this.quizhelper.do_next(b)},register_events:function register_events(b,c){var d=this;d.nextbutton.on("click",function(a){a.preventDefault();d.next_question()});d.reattemptbutton.on("click",function(a){a.preventDefault();f.confirm(d.strings.reattempt,d.strings.reallyreattempt,d.strings.reattempt,"",function(){d.resultscontainer.hide();d.reattemptcontainer.hide();d.recordercontainer.show();d.allwords.removeClass("pr_correct pr_incorrect pr_unreached");d.allspaces.removeClass("pr_correct pr_incorrect pr_unreached")})});a("#"+c.uniqueid+"_container").on("showElement",function(){if(0<c.timelimit){a("#"+c.uniqueid+"_container .progress-container").show();a("#"+c.uniqueid+"_container .progress-container i").show();a("#"+c.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:c.timelimit,onFinish:function onFinish(){d.nextbutton.trigger("click")}})}})},init_components:function init_components(c,e){var f=this;f.allwords=a("#"+f.itemdata.uniqueid+"_container .mod_minilesson_mu_passage_word");f.allspaces=a("#"+f.itemdata.uniqueid+"_container .mod_minilesson_mu_passage_space");f.recordercontainer=a("#"+f.itemdata.uniqueid+"_container .ml_passagereading_speakbtncontainer");f.reattemptcontainer=a("#"+f.itemdata.uniqueid+"_container .ml_passagereading_reattemptcontainer");f.resultscontainer=a("#"+f.itemdata.uniqueid+"_container .ml_passagereading_resultscontainer");f.reattemptbutton=f.reattemptcontainer.find(".ml_reattemptbutton");f.nextbutton=a("#"+e.uniqueid+"_container .minilesson_nextbutton");var g={};g.uniqueid=e.uniqueid;g.callback=function theCallback(a){switch(a.type){case"recording":break;case"speech":var d=a.capturedspeech,e=c.cleanText(d);b.debug("speechtext:",d);b.debug("spoken:",e);f.getComparison(f.itemdata.passagetext,e,"",function(b){f.gotComparison(b,a)});}};g.stt_guided=c.is_stt_guided();f.ttrec=d.clone();f.ttrec.init(g)},getComparison:function getComparison(b,c,d,e){var f=this;a("#"+f.thebutton).prop("disabled",!0);f.quizhelper.comparePassageToTranscript(b,c,d,f.itemdata.language,f.itemdata.alternates).then(function(a){var b=JSON.parse(a);if(b){e(b)}else{e(!1)}})},gotComparison:function gotComparison(c){var d=this;b.debug("gotComparison");var e=d.itemdata.uniqueid+"_container";d.doComparisonMarkup(c,e);var f=a("#"+e+" .mod_minilesson_mu_passage_word.pr_correct"),g=a("#"+e+" .mod_minilesson_mu_passage_word.pr_incorrect"),i=a("#"+e+" .mod_minilesson_mu_passage_word.pr_unreached");d.totals.correct=f.length;d.totals.incorrect=g.length;d.totals.unreached=i.length;d.totals.read=g.length+f.length;d.totals.accuracy=Math.round(100*(d.totals.correct/d.totals.read));d.totals.score=Math.round(100*(d.totals.correct/d.allwords.length));d.totals.comparison=c;b.debug(("total correct",d.totals.correct));b.debug(("allwords",d.allwords.length));if(!d.quizhelper.showitemreview){d.allwords.removeClass("pr_correct pr_incorrect pr_unreached");d.allspaces.removeClass("pr_correct pr_incorrect pr_unreached");d.next_question()}else{h.render("mod_minilesson/passagereadingresults",d.totals).then(function(a){d.recordercontainer.hide();d.resultscontainer.html(a);d.resultscontainer.show();d.reattemptcontainer.show()})}},doComparisonMarkup:function doComparisonMarkup(c,d){var e=a("#"+d+" .mod_minilesson_mu_passage_word"),f=a("#"+ +d+"  .mod_minilesson_mu_passage_space");e.removeClass("pr_correct pr_incorrect pr_unreached");f.removeClass("pr_correct pr_incorrect pr_unreached");var g=0==c.filter(function(a){return!a.matched}).length;if(g&&c&&0<c.length){b.debug("gotComparison: all correct");e.addClass("pr_correct");f.addClass("pr_correct")}else{b.debug("gotComparison: not all correct");var h=0;c.forEach(function(b){var c=a("#"+d+"  .mod_minilesson_mu_passage_word[data-wordnumber='"+b.wordnumber+"']"),e=a("#"+d+"  .mod_minilesson_mu_passage_space[data-wordnumber='"+b.wordnumber+"']");if(!b.matched){c.addClass("pr_incorrect");e.addClass("pr_incorrect")}else{c.addClass("pr_correct");e.addClass("pr_correct");if(h<b.wordnumber){h=b.wordnumber}}});c.forEach(function(b){var c=a("#"+d+"  .mod_minilesson_mu_passage_word[data-wordnumber='"+b.wordnumber+"']"),e=a("#"+d+"  .mod_minilesson_mu_passage_space[data-wordnumber='"+b.wordnumber+"']"),f=a("#"+d+"  .mod_minilesson_mu_passage_word[data-wordnumber='"+(b.wordnumber+1)+"']");if(h<b.wordnumber&&c.hasClass("pr_incorrect")){c.addClass("pr_unreached");e.addClass("pr_unreached");c.removeClass("pr_incorrect");e.removeClass("pr_incorrect")}if(0<f.length){if(c.hasClass("pr_incorrect")&&f.hasClass("pr_correct")){e.removeClass("pr_incorrect")}else if(c.hasClass("pr_correct")&&f.hasClass("pr_incorrect")){e.removeClass("pr_correct")}}})}}}});
//# sourceMappingURL=passagereading.min.js.map
