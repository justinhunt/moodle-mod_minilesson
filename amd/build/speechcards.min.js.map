{"version":3,"file":"speechcards.min.js","sources":["../src/speechcards.js"],"sourcesContent":["define(['jquery',\n    'core/log',\n    'core/ajax',\n    'mod_minilesson/definitions',\n    'mod_minilesson/pollyhelper',\n    'mod_minilesson/ttrecorder',\n    'mod_minilesson/animatecss',\n    'core/str',\n    'core/notification'\n], function($,  log, Ajax, def, polly, ttrecorder, anim,str,notification) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('MiniLesson Speechcards: initialising');\n\n  return {\n\n    //for making multiple instances\n    clone: function () {\n        return $.extend(true, {}, this);\n    },\n\n    init: function(index, itemdata, quizhelper) {\n\n      this.init_app(index, itemdata, quizhelper);\n    },\n\n    init_app: function(index, itemdata, quizhelper) {\n\n      console.log(itemdata);\n\n      var app = {\n        passmark: 90,\n        pointer: 1,\n        jsondata: null,\n        props: null,\n        dryRun: false,\n        language: 'en-US',\n        terms: [],\n        phonetics: [],\n        displayterms: [],\n        results: [],\n        controls: {},\n        ttrec: null, //a handle on the tt recorder\n        strings: {},\n\n        init: function() {\n\n          //init terms\n          for (var i = 0; i < itemdata.sentences.length; i++) {\n            app.terms[i] = itemdata.sentences[i].sentence;\n            app.phonetics[i] = itemdata.sentences[i].phonetic;\n            app.displayterms[i] = itemdata.sentences[i].prompt;\n          }\n          app.language = itemdata.language;\n\n         //anim\n          var animopts = {};\n          animopts.useanimatecss=quizhelper.useanimatecss;\n          anim.init(animopts);\n\n          this.init_controls();\n          this.init_strings();\n          this.initComponents();\n          this.register_events();\n        },\n\n        init_controls: function() {\n          app.controls = {};\n          app.controls.star_rating = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_star_rating\");\n          app.controls.next_button = $(\"#\" + itemdata.uniqueid + \"_container .minilesson-speechcards_nextbutton\");\n          app.controls.slider = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_speechcards_target_phrase\");\n        },\n        init_strings: function() {\n            var app = this;\n            str.get_strings([\n                { \"key\": \"nextlessonitem\", \"component\": 'mod_minilesson'},\n                { \"key\": \"confirm_desc\", \"component\": 'mod_minilesson'},\n                { \"key\": \"yes\", \"component\": 'moodle'},\n                { \"key\": \"no\", \"component\": 'moodle'},\n            ]).done(function (s) {\n                var i = 0;\n                app.strings.nextlessonitem = s[i++];\n                app.strings.confirm_desc = s[i++];\n                app.strings.yes = s[i++];\n                app.strings.no = s[i++];\n            });\n        },\n        next_question: function() {\n          var stepdata = {};\n          stepdata.index = index;\n          stepdata.hasgrade = true;\n          stepdata.totalitems = app.terms.length;\n          stepdata.correctitems = app.results.filter(function(e){return e.points>0;}).length;\n          stepdata.grade = Math.round((stepdata.correctitems/stepdata.totalitems)*100);\n          quizhelper.do_next(stepdata);\n        },\n        register_events: function() {\n\n          $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function(e) {\n            if (app.results.length <= app.terms.length) {\n              notification.confirm(app.strings.nextlessonitem,\n                  app.strings.confirm_desc,\n                  app.strings.yes,\n                  app.strings.no,\n                  function() {\n                      app.next_question();\n                  }\n              );\n            } else {\n                app.next_question();\n            }\n          });\n\n          app.controls.next_button.click(function() {\n            //user has given up ,update word as failed\n            app.check(false);\n\n            //transition if required\n            if (app.is_end()) {\n              setTimeout(function() {\n                app.do_end();\n              }, 200);\n            } else {\n              app.controls.next_button.prop(\"disabled\", true);\n              app.controls.next_button.children('.fa').removeClass('fa-times');\n              app.controls.next_button.children('.fa').addClass('fa-spinner fa-spin');\n              setTimeout(function() {\n                app.controls.next_button.children('.fa').removeClass('fa-spinner fa-spin');\n                app.controls.next_button.children('.fa').addClass('fa-times');\n                app.controls.next_button.prop(\"disabled\", false);\n                app.do_next();\n              }, 200);\n            }\n\n          });\n        },\n\n        initComponents: function() {\n\n              var theCallback = function(message) {\n\n                switch (message.type) {\n                  case 'recording':\n\n                    break;\n\n                  case 'speech':\n                    log.debug(\"speech at speechcards\");\n                    var speechtext = message.capturedspeech;\n                    var spoken_clean  = quizhelper.cleanText(speechtext);\n                    var correct_clean = quizhelper.cleanText(app.terms[app.pointer - 1]);\n                    var correctphonetic = app.phonetics[app.pointer - 1];\n        log.debug('speechtext:',speechtext);\n        log.debug('spoken:',spoken_clean);\n        log.debug('correct:',correct_clean);\n                    //Similarity check by character matching\n                    var similarity_js = quizhelper.similarity(spoken_clean, correct_clean);\n                    log.debug('JS similarity: ' + spoken_clean + ':' + correct_clean + ':' + similarity_js);\n\n                    //Similarity check by direct-match/acceptable-mistranscription\n                    if (similarity_js >= app.passmark ||\n                      app.wordsDoMatch(spoken_clean, correct_clean)) {\n                      log.debug('local match:' + ':' + spoken_clean + ':' + correct_clean);\n                      app.showStarRating(100);\n                      app.flagCorrectAndTransition();\n                      return;\n                    }\n\n                    //Similarity check by phonetics(ajax)\n                    quizhelper.checkByPhonetic(correct_clean, spoken_clean, correctphonetic, app.language).then(function(similarity_php) {\n                      if (similarity_php === false) {\n                        return $.Deferred().reject();\n                      } else {\n                        log.debug('PHP similarity: ' + spoken_clean + ':' + correct_clean + ':' + similarity_php);\n\n                        if (similarity_php >= app.passmark) {\n                            app.showStarRating(similarity_php);\n                            app.flagCorrectAndTransition();\n                        }else{\n                            //show the greater of the ratings\n                            app.showStarRating(Math.max(similarity_js,similarity_php));\n                        }\n                      } //end of if check_by_phonetic result\n                    }); //end of check by phonetic\n\n                } //end of switch message type\n              };\n\n              //init tt recorder\n              var opts = {};\n              opts.uniqueid = itemdata.uniqueid;\n              opts.callback = theCallback;\n              opts.stt_guided=quizhelper.is_stt_guided();\n              app.ttrec = ttrecorder.clone();\n              app.ttrec.init(opts);\n              //init prompt for first card\n              //in some cases ttrecorder wants to know the target\n              app.ttrec.currentPrompt=app.displayterms[app.pointer - 1];\n\n              //init progress dots\n              app.progress_dots(app.results, app.terms);\n\n              app.initSlider();\n\n\n        },\n\n        initSlider: function() {\n          app.controls.slider.text(app.displayterms[app.pointer - 1]);\n          app.controls.slider.show();\n        },\n\n        writeCurrentTerm: function() {\n            /*\n            app.controls.slider.toggle(\"slide\",{direction:\"left\"});\n            app.controls.slider.text(app.displayterms[app.pointer - 1]);\n            app.controls.slider.toggle(\"slide\",{direction:\"right\"})\n             */\n            anim.do_animate(app.controls.slider,'zoomOut animate__faster','out').then(\n                function(){\n                    app.controls.slider.text(app.displayterms[app.pointer - 1]);\n                    anim.do_animate(app.controls.slider,'zoomIn animate__faster','in');\n                }\n            );\n        },\n\n        flagCorrectAndTransition: function() {\n\n          //update students word log if matched\n          app.check(true);\n\n          //transition if required\n          if (app.is_end()) {\n            setTimeout(function() {\n              app.do_end();\n            }, 700);\n          } else {\n            setTimeout(function() {\n              app.do_next();\n            }, 700);\n          }\n\n        },\n\n        wordsDoMatch: function(phraseheard, currentphrase) {\n          //lets lower case everything\n          phraseheard = quizhelper.cleanText(phraseheard);\n          currentphrase = quizhelper.cleanText(currentphrase);\n          if (phraseheard == currentphrase) {\n            return true;\n          }\n          return false;\n        },\n\n\n        showStarRating: function(similarity) {\n          //how many stars code\n          var stars = [true, true, true];\n          if (similarity < app.passmark) {\n            stars = [true, true, false];\n          }\n          if (similarity < .75) {\n            stars = [true, false, false];\n          }\n          if (similarity < 0.5) {\n            stars = [false, false, false];\n          }\n\n          //prepare stars html\n          var code = \"\";\n          stars.forEach(function(star) {\n            if (star === true) {\n              code += '<i class=\"fa fa-star\"></i>';\n            } else {\n              code += '<i class=\"fa fa-star-o\"></i>';\n            }\n          });\n\n          app.controls.star_rating.html(code);\n        },\n\n        check: function(correct) {\n          var points = 1;\n          if (correct == true) {\n            points = 1;\n          } else {\n            points = 0;\n          }\n          var result = {\n            points: points\n          };\n          app.results.push(result);\n        },\n\n        do_next: function() {\n          app.pointer++;\n          app.progress_dots(app.results, app.terms);\n          app.clearStarRating();\n          if (!app.is_end()) {\n            app.writeCurrentTerm();\n            //in some cases ttrecorder wants to know the target\n            if(quizhelper.use_ttrecorder()) {\n                app.ttrec.currentPrompt=app.displayterms[app.pointer - 1];\n            }\n\n          } else {\n            app.do_end();\n          }\n        },\n\n        clearStarRating: function() {\n          app.controls.star_rating.html('· · ·');\n        },\n\n        do_end: function() {\n          app.next_question();\n        },\n\n        is_end: function() {\n          //pointer is 1 based but array is, of course, 0 based\n          if (app.pointer <= app.terms.length) {\n            return false;\n          } else {\n            return true;\n          }\n        },\n\n        progress_dots: function(results, terms) {\n\n          var code = \"\";\n          var color = \"\";\n          terms.forEach(function(o, i) {\n            color = \"darkgray\";\n            if (results[i] !== undefined) {\n              if (results[i].points) {\n                color = \"green\";\n              } else {\n                color = \"red\";\n              }\n            }\n            code += '<i style=\"color:' + color + ';\" class=\"fa fa-circle\"></i>';\n          });\n\n          $(\"#\" + itemdata.uniqueid + \"_container .minilesson_progress_dots\").html(code);\n\n        },\n      }; //end of app definition\n      app.init();\n\n    } //end of init_App\n\n\n  }; //end of return value\n});"],"names":["define","$","log","Ajax","def","polly","ttrecorder","anim","str","notification","debug","clone","extend","this","init","index","itemdata","quizhelper","init_app","console","app","passmark","pointer","jsondata","props","dryRun","language","terms","phonetics","displayterms","results","controls","ttrec","strings","i","sentences","length","sentence","phonetic","prompt","animopts","useanimatecss","init_controls","init_strings","initComponents","register_events","star_rating","uniqueid","next_button","slider","get_strings","done","s","nextlessonitem","confirm_desc","yes","no","next_question","stepdata","hasgrade","totalitems","correctitems","filter","e","points","grade","Math","round","do_next","on","confirm","click","check","is_end","setTimeout","do_end","prop","children","removeClass","addClass","opts","callback","message","type","speechtext","capturedspeech","spoken_clean","cleanText","correct_clean","correctphonetic","similarity_js","similarity","wordsDoMatch","showStarRating","flagCorrectAndTransition","checkByPhonetic","then","similarity_php","Deferred","reject","max","stt_guided","is_stt_guided","currentPrompt","progress_dots","initSlider","text","show","writeCurrentTerm","do_animate","phraseheard","currentphrase","stars","code","forEach","star","html","correct","result","push","clearStarRating","use_ttrecorder","color","o","undefined"],"mappings":"AAAAA,oCAAO,CAAC,SACJ,WACA,YACA,6BACA,6BACA,4BACA,4BACA,WACA,sBACD,SAASC,EAAIC,IAAKC,KAAMC,IAAKC,MAAOC,WAAYC,KAAKC,IAAIC,qBAO1DP,IAAIQ,MAAM,wCAEH,CAGLC,MAAO,kBACIV,EAAEW,QAAO,EAAM,GAAIC,OAG9BC,KAAM,SAASC,MAAOC,SAAUC,iBAEzBC,SAASH,MAAOC,SAAUC,aAGjCC,SAAU,SAASH,MAAOC,SAAUC,YAElCE,QAAQjB,IAAIc,cAERI,IAAM,CACRC,SAAU,GACVC,QAAS,EACTC,SAAU,KACVC,MAAO,KACPC,QAAQ,EACRC,SAAU,QACVC,MAAO,GACPC,UAAW,GACXC,aAAc,GACdC,QAAS,GACTC,SAAU,GACVC,MAAO,KACPC,QAAS,GAETnB,KAAM,eAGC,IAAIoB,EAAI,EAAGA,EAAIlB,SAASmB,UAAUC,OAAQF,IAC7Cd,IAAIO,MAAMO,GAAKlB,SAASmB,UAAUD,GAAGG,SACrCjB,IAAIQ,UAAUM,GAAKlB,SAASmB,UAAUD,GAAGI,SACzClB,IAAIS,aAAaK,GAAKlB,SAASmB,UAAUD,GAAGK,OAE9CnB,IAAIM,SAAWV,SAASU,aAGpBc,SAAW,GACfA,SAASC,cAAcxB,WAAWwB,cAClClC,KAAKO,KAAK0B,eAELE,qBACAC,oBACAC,sBACAC,mBAGPH,cAAe,WACbtB,IAAIW,SAAW,GACfX,IAAIW,SAASe,YAAc7C,EAAE,IAAMe,SAAS+B,SAAW,sCACvD3B,IAAIW,SAASiB,YAAc/C,EAAE,IAAMe,SAAS+B,SAAW,iDACvD3B,IAAIW,SAASkB,OAAShD,EAAE,IAAMe,SAAS+B,SAAW,qDAEpDJ,aAAc,eACNvB,IAAMP,KACVL,IAAI0C,YAAY,CACZ,KAAS,2BAA+B,kBACxC,KAAS,yBAA6B,kBACtC,KAAS,gBAAoB,UAC7B,KAAS,eAAmB,YAC7BC,MAAK,SAAUC,OACVlB,EAAI,EACRd,IAAIa,QAAQoB,eAAiBD,EAAElB,KAC/Bd,IAAIa,QAAQqB,aAAeF,EAAElB,KAC7Bd,IAAIa,QAAQsB,IAAMH,EAAElB,KACpBd,IAAIa,QAAQuB,GAAKJ,EAAElB,SAG3BuB,cAAe,eACTC,SAAW,GACfA,SAAS3C,MAAQA,MACjB2C,SAASC,UAAW,EACpBD,SAASE,WAAaxC,IAAIO,MAAMS,OAChCsB,SAASG,aAAezC,IAAIU,QAAQgC,QAAO,SAASC,UAAUA,EAAEC,OAAO,KAAK5B,OAC5EsB,SAASO,MAAQC,KAAKC,MAAOT,SAASG,aAAaH,SAASE,WAAY,KACxE3C,WAAWmD,QAAQV,WAErBb,gBAAiB,WAEf5C,EAAE,IAAMe,SAAS+B,SAAW,qCAAqCsB,GAAG,SAAS,SAASN,GAChF3C,IAAIU,QAAQM,QAAUhB,IAAIO,MAAMS,OAClC3B,aAAa6D,QAAQlD,IAAIa,QAAQoB,eAC7BjC,IAAIa,QAAQqB,aACZlC,IAAIa,QAAQsB,IACZnC,IAAIa,QAAQuB,IACZ,WACIpC,IAAIqC,mBAIVrC,IAAIqC,mBAIVrC,IAAIW,SAASiB,YAAYuB,OAAM,WAE7BnD,IAAIoD,OAAM,GAGNpD,IAAIqD,SACNC,YAAW,WACTtD,IAAIuD,WACH,MAEHvD,IAAIW,SAASiB,YAAY4B,KAAK,YAAY,GAC1CxD,IAAIW,SAASiB,YAAY6B,SAAS,OAAOC,YAAY,YACrD1D,IAAIW,SAASiB,YAAY6B,SAAS,OAAOE,SAAS,sBAClDL,YAAW,WACTtD,IAAIW,SAASiB,YAAY6B,SAAS,OAAOC,YAAY,sBACrD1D,IAAIW,SAASiB,YAAY6B,SAAS,OAAOE,SAAS,YAClD3D,IAAIW,SAASiB,YAAY4B,KAAK,YAAY,GAC1CxD,IAAIgD,YACH,UAMTxB,eAAgB,eAoDNoC,KAAO,GACXA,KAAKjC,SAAW/B,SAAS+B,SACzBiC,KAAKC,SApDa,SAASC,gBAEjBA,QAAQC,UACT,sBAIA,SACHjF,IAAIQ,MAAM,6BACN0E,WAAaF,QAAQG,eACrBC,aAAgBrE,WAAWsE,UAAUH,YACrCI,cAAgBvE,WAAWsE,UAAUnE,IAAIO,MAAMP,IAAIE,QAAU,IAC7DmE,gBAAkBrE,IAAIQ,UAAUR,IAAIE,QAAU,GAC9DpB,IAAIQ,MAAM,cAAc0E,YACxBlF,IAAIQ,MAAM,UAAU4E,cACpBpF,IAAIQ,MAAM,WAAW8E,mBAELE,cAAgBzE,WAAW0E,WAAWL,aAAcE,kBACxDtF,IAAIQ,MAAM,kBAAoB4E,aAAe,IAAME,cAAgB,IAAME,eAGrEA,eAAiBtE,IAAIC,UACvBD,IAAIwE,aAAaN,aAAcE,sBAC/BtF,IAAIQ,MAAM,gBAAuB4E,aAAe,IAAME,eACtDpE,IAAIyE,eAAe,UACnBzE,IAAI0E,2BAKN7E,WAAW8E,gBAAgBP,cAAeF,aAAcG,gBAAiBrE,IAAIM,UAAUsE,MAAK,SAASC,oBAC5E,IAAnBA,sBACKhG,EAAEiG,WAAWC,SAEpBjG,IAAIQ,MAAM,mBAAqB4E,aAAe,IAAME,cAAgB,IAAMS,gBAEtEA,gBAAkB7E,IAAIC,UACtBD,IAAIyE,eAAeI,gBACnB7E,IAAI0E,4BAGJ1E,IAAIyE,eAAe3B,KAAKkC,IAAIV,cAAcO,sBAYxDjB,KAAKqB,WAAWpF,WAAWqF,gBAC3BlF,IAAIY,MAAQ1B,WAAWK,QACvBS,IAAIY,MAAMlB,KAAKkE,MAGf5D,IAAIY,MAAMuE,cAAcnF,IAAIS,aAAaT,IAAIE,QAAU,GAGvDF,IAAIoF,cAAcpF,IAAIU,QAASV,IAAIO,OAEnCP,IAAIqF,cAKVA,WAAY,WACVrF,IAAIW,SAASkB,OAAOyD,KAAKtF,IAAIS,aAAaT,IAAIE,QAAU,IACxDF,IAAIW,SAASkB,OAAO0D,QAGtBC,iBAAkB,WAMdrG,KAAKsG,WAAWzF,IAAIW,SAASkB,OAAO,0BAA0B,OAAO+C,MACjE,WACI5E,IAAIW,SAASkB,OAAOyD,KAAKtF,IAAIS,aAAaT,IAAIE,QAAU,IACxDf,KAAKsG,WAAWzF,IAAIW,SAASkB,OAAO,yBAAyB,UAKzE6C,yBAA0B,WAGxB1E,IAAIoD,OAAM,GAGNpD,IAAIqD,SACNC,YAAW,WACTtD,IAAIuD,WACH,KAEHD,YAAW,WACTtD,IAAIgD,YACH,MAKPwB,aAAc,SAASkB,YAAaC,sBAElCD,YAAc7F,WAAWsE,UAAUuB,gBACnCC,cAAgB9F,WAAWsE,UAAUwB,iBAQvClB,eAAgB,SAASF,gBAEnBqB,MAAQ,EAAC,GAAM,GAAM,GACrBrB,WAAavE,IAAIC,WACnB2F,MAAQ,EAAC,GAAM,GAAM,IAEnBrB,WAAa,MACfqB,MAAQ,EAAC,GAAM,GAAO,IAEpBrB,WAAa,KACfqB,MAAQ,EAAC,GAAO,GAAO,QAIrBC,KAAO,GACXD,MAAME,SAAQ,SAASC,MAEnBF,OADW,IAATE,KACM,6BAEA,kCAIZ/F,IAAIW,SAASe,YAAYsE,KAAKH,OAGhCzC,MAAO,SAAS6C,aAOVC,OAAS,CACXtD,OANa,GAAXqD,QACO,EAEA,GAKXjG,IAAIU,QAAQyF,KAAKD,SAGnBlD,QAAS,WACPhD,IAAIE,UACJF,IAAIoF,cAAcpF,IAAIU,QAASV,IAAIO,OACnCP,IAAIoG,kBACCpG,IAAIqD,SAQPrD,IAAIuD,UAPJvD,IAAIwF,mBAED3F,WAAWwG,mBACVrG,IAAIY,MAAMuE,cAAcnF,IAAIS,aAAaT,IAAIE,QAAU,MAQ/DkG,gBAAiB,WACfpG,IAAIW,SAASe,YAAYsE,KAAK,UAGhCzC,OAAQ,WACNvD,IAAIqC,iBAGNgB,OAAQ,mBAEFrD,IAAIE,SAAWF,IAAIO,MAAMS,SAO/BoE,cAAe,SAAS1E,QAASH,WAE3BsF,KAAO,GACPS,MAAQ,GACZ/F,MAAMuF,SAAQ,SAASS,EAAGzF,GACxBwF,MAAQ,gBACWE,IAAf9F,QAAQI,KAERwF,MADE5F,QAAQI,GAAG8B,OACL,QAEA,OAGZiD,MAAQ,mBAAqBS,MAAQ,kCAGvCzH,EAAE,IAAMe,SAAS+B,SAAW,wCAAwCqE,KAAKH,QAI7E7F,IAAIN"}