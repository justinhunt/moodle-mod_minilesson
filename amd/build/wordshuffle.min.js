define("mod_minilesson/wordshuffle",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates"],(function($,log,ajax,def,polly,anim,progresstimer,templates){return log.debug("MiniLesson wordshuffle: initialising"),{clone:function(){return $.extend(!0,{},this)},usevoice:"Amy",pointerdiv:null,init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.itemdata.hidestartpage=!0,this.quizhelper=quizhelper,this.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.init_controls(),this.register_events(),this.setvoice(),this.getItems(),this.start()},init_controls:function(){var container=$("#"+this.itemdata.uniqueid+"_container");this.controls={container:container,listen_cont:container.find(".wordshuffle_listen_cont"),nextbutton:container.find(".minilesson_nextbutton"),start_btn:container.find(".wordshuffle_start_btn"),skip_btn:container.find(".wordshuffle_skip_btn"),ctrl_btn:container.find(".wordshuffle_ctrl-btn"),check_btn:container.find(".wordshuffle_check_btn"),game:container.find(".wordshuffle_game"),controlsbox:container.find(".wordshuffle_controls"),resultscontainer:container.find(".wordshuffle_resultscontainer"),mainmenu:container.find(".wordshuffle_mainmenu"),title:container.find(".wordshuffle_title"),progress_container:container.find(".progress-container"),progress_bar:container.find(".progress-container .progress-bar"),question:container.find(".question"),listen_btn:container.find(".wordshuffle_listen_btn"),retry_btn:container.find(".wordshuffle_retry_btn")}},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.stop_audio(),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var listencont=this.controls.listen_cont,qbox=this.controls.question,gamebox=this.controls.game,controlsbox=this.controls.controlsbox,resultsbox=this.controls.resultscontainer;templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),listencont.hide(),qbox.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;self.controls.nextbutton.on("click",(function(e){self.next_question()})),self.controls.start_btn.on("click",(function(){self.start()}));var audioplayerbtn=self.controls.listen_btn;audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-stop"),$(audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),self.controls.skip_btn.on("click",(function(){self.controls.ctrl_btn.prop("disabled",!0),self.controls.container.find(".wordshuffle_speech.wordshuffle_teacher_left").text(self.items[self.game.pointer].prompt+""),self.controls.container.find(".wordshuffle_targetWord").each((function(){var realidx=$(this).data("realidx"),wordshuffle_targetWord=self.items[self.game.pointer].wordshuffle_targetWords[realidx];$(this).val(wordshuffle_targetWord)})),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?setTimeout((function(){self.controls.container.find(".wordshuffle_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()})),self.controls.check_btn.on("click",(function(){self.pointerdiv.find(".drop-slot .word").each((function(){self.placeInBank($(this))})),self.clearPerSlotFeedback(),self.controls.retry_btn.hide(),self.items[self.game.pointer].answered=!1,self.items[self.game.pointer].correct=!1})),self.controls.retry_btn.on("click",(function(){self.pointerdiv.find(".drop-slot .word").each((function(){self.placeInBank($(this))})),self.clearPerSlotFeedback(),self.controls.retry_btn.hide(),self.controls.check_btn.show(),self.items[self.game.pointer].answered=!1,self.items[self.game.pointer].correct=!1}))},game:{pointer:0},check_answer:function(){var self=this;self.itemdata.allowretry&&!self.items[self.game.pointer].correct?(self.controls.retry_btn.show(),self.controls.check_btn.hide()):setTimeout((()=>self.gotComparison(!0)),2e3)},setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var text_items=this.itemdata.sentences;this.items=text_items.map((function(target){return{target:target.sentenceclean,timer:[],answered:!1,correct:!1,audio:null,audiourl:target.audiourl?target.audiourl:"",imageurl:target.imageurl}})).filter((function(e){return""!==e.target})),this.itemdata.audiocontent?($.each(this.items,(function(index,item){item.audio=new Audio,item.audio.src=item.audiourl})),this.appReady()):this.appReady()},appReady:function(){this.controls.container.find(".wordshuffle_not_loaded").hide(),this.controls.container.find(".wordshuffle_loaded").show(),this.itemdata.hidestartpage?this.start():this.controls.start_btn.prop("disabled",!1)},gotComparison:function(comparison){var self=this;log.debug("gotComparison",comparison);var timelimit_progressbar=self.controls.progress_bar;if(comparison)log.debug("correct!!");else{if(self.itemdata.allowretry&&!timelimit_progressbar.hasClass("progress-bar-complete"))return void log.debug("incorrect!! retry");log.debug("incorrect")}self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1?setTimeout((function(){self.controls.container.find(".wordshuffle_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()},end:function(){var self=this;self.controls.nextbutton.prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){self.controls.nextbutton.prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2e3)},start:function(){this.controls.ctrl_btn.prop("disabled",!0),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,this.controls.listen_cont.show(),this.controls.question.show(),this.controls.game.show(),this.controls.start_btn.hide(),this.controls.mainmenu.hide(),this.controls.controlsbox.show(),this.nextPrompt()},nextPrompt:function(){var self=this;self.pointerdiv=self.controls.question.find('.wordshuffle_wordset_container[data-index="'.concat(self.game.pointer,'"]')),self.controls.retry_btn.hide(),self.controls.check_btn.show(),self.controls.ctrl_btn.prop("disabled",!1),self.updateProgressDots(),self.showNextWordSet(),null===self.items[self.game.pointer].audio||self.quizhelper.mobile_user()||(self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{setTimeout((function(){self.controls.listen_btn.trigger("click")}),1e3)})):setTimeout((function(){self.controls.listen_btn.trigger("click")}),1e3))},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");self.controls.title.html(progress)},showNextWordSet:function(){this.controls.container.find(".wordshuffle_wordset_container").hide();var newwordset=this.controls.container.find(".wordshuffle_wordset_"+this.game.pointer);anim.do_animate(newwordset,"zoomIn animate__faster","in").then((function(){})),this.controls.ctrl_btn.prop("disabled",!1),this.startTimer(),this.makeDragZones()},getSlotWords:function(){return this.pointerdiv.find(".drop-slot").map((function(){return $(this).find(".word").first().text().trim()||""})).get()},allFilled:function(){return this.getSlotWords().every(Boolean)},clearPerSlotFeedback:function(){this.pointerdiv.find(".drop-slot").removeClass("border-success border-danger").addClass("border-secondary-subtle"),this.pointerdiv.find("[id^='fb-']").each((function(){$(this).removeClass("text-success text-danger").addClass("text-muted").html("&nbsp;")}))},setPerSlotFeedback:function(){var self=this;const words=self.getSlotWords(),expectedAnswers=self.expectedAnswers(),fullExpected=[...self.fixedWords(),...expectedAnswers];words.forEach(((w,i)=>{const ok=w===expectedAnswers[i],$slot=self.pointerdiv.find(".drop-slot[data-index='"+i+"']"),$fb=self.pointerdiv.find("#fb-"+i);$slot.removeClass("border-secondary-subtle border-success border-danger").addClass(ok?"border-success":"border-danger"),$fb.removeClass("text-muted text-success text-danger").addClass(ok?"text-success":"text-danger").text(ok?"Correct":"Wrong")}));const attempt=[...self.fixedWords(),...self.getSlotWords()];self.items[self.game.pointer].answered=words.some(Boolean),self.items[self.game.pointer].correct=attempt.join(" ")===fullExpected.join(" ")},evaluateIfComplete:function(){this.allFilled()?(this.controls.check_btn.hide(),this.setPerSlotFeedback(),this.check_answer()):(this.controls.check_btn.show(),this.clearPerSlotFeedback())},moveToSlot:function($word,$slot){$word.detach().css({top:0,left:0,position:"relative"}).appendTo($slot),this.evaluateIfComplete()},placeInBank:function($word){$word.detach().css({top:0,left:0,position:"relative"}).appendTo(this.pointerdiv.find(".word-bank")),this.evaluateIfComplete()},gapWords:function(){return this.itemdata.sentences[this.game.pointer].gapwords},fixedWords:function(){return this.gapWords().filter((w=>!1===w.isgap)).map((w=>w.word))},expectedAnswers:function(){return this.gapWords().filter((w=>!0===w.isgap)).map((w=>w.word))},selectedWord:null,makeDragZones:function(){var self=this;self.pointerdiv.attr("data-initialized")||(self.pointerdiv.on("click",(e=>{const $target=$(e.target);$target.is(".word")?self.selectedWord&&self.selectedWord.is($target)?self.selectedWord=null:self.selectedWord=$target:$target.is(".word-bank")?self.selectedWord&&(self.selectedWord.parent(".drop-slot")&&self.placeInBank(self.selectedWord),self.selectedWord=null):$target.is(".drop-slot")&&self.selectedWord&&(self.moveToSlot(self.selectedWord,$target),self.selectedWord=null),self.highlightDropZones()})),self.pointerdiv.on("keydown",(function(e){if(" "===e.key||"Spacebar"===e.key){const $focused=$(document.activeElement);$focused.is(".word")?self.selectedWord&&self.selectedWord.is($focused)?self.selectedWord=null:self.selectedWord=$focused:$focused.is(".word-bank")?self.selectedWord&&(self.selectedWord.parent(".drop-slot")&&self.placeInBank(self.selectedWord),self.selectedWord=null):$focused.is(".drop-slot")&&self.selectedWord&&(self.moveToSlot(self.selectedWord,$focused),self.selectedWord=null),self.highlightDropZones(),e.preventDefault()}})),self.pointerdiv.attr("data-initialized",1))},highlightDropZones:function(){var dropZones=this.pointerdiv.find(".drop-slot").removeClass("ml_ws_highlight").removeAttr("tabindex");this.pointerdiv.find(".word").removeClass("ml_ws_highlight"),this.pointerdiv.find(".word-bank").removeClass("ml_ws_highlight").removeAttr("tabindex"),this.selectedWord&&(this.selectedWord.parent(".word-bank").length||this.pointerdiv.find(".word-bank").addClass("ml_ws_highlight").attr("tabindex",0),dropZones.filter((function(_,slot){return!slot.querySelector(".word")&&($(slot).addClass("ml_ws_highlight"),$(slot).attr("tabindex",0),!0)})),this.selectedWord.addClass("ml_ws_highlight"))},startTimer:function(){var self=this;if(self.itemdata.timelimit>0){var doStartTimer=function(){self.controls.progress_container.show(),self.controls.progress_container.find("i").show(),self.controls.progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){self.controls.skip_btn.trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))}))};self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{doStartTimer()})):doStartTimer()}},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))},stop_audio:function(){var theaudio=this.items[this.game.pointer].audio;theaudio&&!theaudio.paused&&theaudio.pause()}}}));

//# sourceMappingURL=wordshuffle.min.js.map