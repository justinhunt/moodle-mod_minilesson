{"version":3,"sources":["../src/ttrecorder.js"],"names":["define","$","log","notification","ajax","audioHelper","browserRec","str","timer","msspeech","debug","waveHeight","audio","stream","blob","dataURI","start","end","isRecording","isRecognizing","isWaiting","transcript","submitting","owner","controls","uniqueid","audio_updated","maxtime","passagehash","region","asrurl","lang","browserrec","usebrowserrec","currentTime","stt_guided","currentPrompt","speechtoken","speechtokenvalidseconds","speechtokentype","forcestreaming","is_streaming","using_msspeech","msspeech_instance","strings","clone","extend","init","opts","that","callback","init_strings","prepare_html","recordercontainer","show","register_events","can_msspeech","referencetext","handle_timer_update","displaytime","fetch_display_time","timerstatus","html","seconds","initseconds","update_audio","stop","audiohelper","on_error","error","name","alert","allowmicaccess","nomicdetected","on_stopped","newaudio","URL","createObjectURL","Date","length","Math","round","do_msspeech","response","gotMSResults","upload_transcribe","data","result","gotRecognition","trim","speechnotrecognized","on_gotstream","will_work_ok","onerror","onend","onstart","onfinalspeechcapture","speechtext","oninterimspeechcapture","gotInterimRecognition","can_stream","onError","onStop","onStream","init_token_refresh","update_currentprompt","targettext","set_reference_text","blobToArrayBuffer","Promise","resolve","reject","reader","FileReader","onload","event","target","readAsArrayBuffer","get_strings","done","s","i","recorderbutton","waveform","validsecs","refreshInterval","setTimeout","call","methodname","args","async","then","ajaxresult","newtoken","JSON","parse","token","validseconds","helper","streamer","updatetoken","silence_detected","toggleRecording","newprops","val","theprop","click","show_recorder_pointer","removeClass","addClass","recordBtnContent","css","startedRecording","type","results","capturedspeech","cleanWord","word","replace","toLowerCase","reset","bodyFormData","FormData","blobname","floor","random","append","M","cfg","wwwroot","oReq","XMLHttpRequest","open","onUploadProgress","status","send","err","recognize"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log','core/notification', 'core/ajax', 'mod_minilesson/ttaudiohelper','mod_minilesson/ttbrowserrec',\n    'core/str','mod_minilesson/timer','mod_minilesson/ttmsspeech'],\n    function ($, log, notification, ajax, audioHelper, browserRec, str, timer, msspeech) {\n    \"use strict\"; // jshint ;_;\n    /*\n    *  The TT recorder\n     */\n\n    log.debug('TT Recorder: initialising');\n\n    return {\n        waveHeight: 75,\n        audio: {\n            stream: null,\n            blob: null,\n            dataURI: null,\n            start: null,\n            end: null,\n            isRecording: false,\n            isRecognizing: false,\n            isWaiting: false,\n            transcript: null\n        },\n        submitting: false,\n        owner: '',\n        controls: {},\n        uniqueid: null,\n        audio_updated: null,\n        maxtime: 0,\n        passagehash: null,\n        region: null,\n        asrurl: null,\n        lang: null,\n        browserrec: null,\n        usebrowserrec: false,\n        currentTime: 0,\n        stt_guided: false,\n        currentPrompt: false,\n        speechtoken: '',\n        speechtokenvalidseconds: '',\n        speechtokentype: '',\n        forcestreaming: false,\n        is_streaming: false,\n        using_msspeech: false,\n        msspeech_instance: null,\n        strings: {},\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        init: function(opts){\n\n            var that = this;\n            this.uniqueid=opts['uniqueid'];\n            this.callback=opts['callback'];\n            this.stt_guided = opts['stt_guided'] ? opts['stt_guided'] : false;\n            this.init_strings();\n            this.prepare_html();\n            this.controls.recordercontainer.show();\n            this.register_events();\n\n            //token check\n            this.using_msspeech = this.can_msspeech();\n            if(this.using_msspeech){\n                var referencetext = opts['referencetext'];\n                this.msspeech_instance = msspeech.clone();\n                this.msspeech_instance.init(this.speechtoken, this.region, this.lang, referencetext);\n            }\n\n            // Callback: Timer updates.\n            var handle_timer_update = function(){\n                var displaytime = that.timer.fetch_display_time();\n                that.controls.timerstatus.html(displaytime);\n                log.debug('timer_seconds: ' + that.timer.seconds);\n                log.debug('displaytime: ' + displaytime);\n                if (that.timer.seconds == 0 && that.timer.initseconds > 0) {\n                    that.update_audio('isRecognizing', true);\n                    if(that.usebrowserrec){\n                        that.browserrec.stop();\n                    }else{\n                        that.audiohelper.stop();\n                    }\n                }\n            };\n\n            // Callback: Recorder device errors.\n            var on_error = function(error) {\n                switch (error.name) {\n                    case 'PermissionDeniedError':\n                    case 'NotAllowedError':\n                        notification.alert(\"Error\",that.strings.allowmicaccess, \"OK\");\n                        break;\n                    case 'DevicesNotFoundError':\n                    case 'NotFoundError':\n                        notification.alert(\"Error\",that.strings.nomicdetected, \"OK\");\n                        break;\n                    default:\n                        //other errors, like from Edge can fire repeatedly so a notification is not a good idea\n                        //notification.alert(\"Error\", error.name, \"OK\");\n                        log.debug(\"Error\", error.name);\n                }\n            };\n\n            // Callback: Recording stopped.\n            var on_stopped = function(blob) {\n                that.timer.stop()\n\n                //if the blob is undefined then the user is super clicking or something\n                if(blob===undefined){\n                    return;\n                }\n\n                //Update our current audio object\n                var newaudio = {\n                    blob: blob,\n                    dataURI: URL.createObjectURL(blob),\n                    end: new Date(),\n                    isRecording: false,\n                    length: Math.round((that.audio.end - that.audio.start) / 1000),\n                };\n                that.update_audio(newaudio);\n\n                //if we are not streaming then upload_transcribe (ie send to poodll servers)\n                if(!that.is_streaming){\n                    if(that.using_msspeech){\n                        that.do_msspeech(that.audio.blob, function(response){\n                            that.gotMSResults(response);\n                            that.update_audio('isRecognizing',false);\n                        });\n                    }else{\n                        that.upload_transcribe(that.audio.blob, function(response){\n                            log.debug(response);\n                            if(response.data.result===\"success\" && response.data.transcript){\n                                that.gotRecognition(response.data.transcript.trim());\n                            } else {\n                                notification.alert(\"Information\",that.strings.speechnotrecognized, \"OK\");\n                            }\n                            that.update_audio('isRecognizing',false);\n                        });\n                    }\n                }\n\n            };\n\n            // Callback: Recorder device got stream - start recording\n            var on_gotstream=  function(stream) {\n                var newaudio={stream: stream, isRecording: true, isWaiting: false};\n                that.update_audio(newaudio);\n            };\n\n            //If browser rec (Chrome Speech Rec)\n            if(browserRec.will_work_ok() && ! this.stt_guided && !this.forcestreaming && !this.using_msspeech){\n                //Init browserrec\n                log.debug(\"using browser rec\");\n                this.browserrec = browserRec.clone();\n                this.browserrec.init(this.lang,this.waveHeight,this.uniqueid);\n                this.usebrowserrec=true;\n\n                //set up events\n                that.browserrec.onerror = on_error;\n                that.browserrec.onend = function(){\n                        //do something here\n                };\n                that.browserrec.onstart = function(){\n                    //do something here\n                };\n                that.browserrec.onfinalspeechcapture=function(speechtext){\n                    that.gotRecognition(speechtext);\n                    that.update_audio('isRecording',false);\n                    that.update_audio('isRecognizing',false);\n                };\n\n                that.browserrec.oninterimspeechcapture=function(speechtext){\n                    that.gotInterimRecognition(speechtext);\n                };\n\n            //If we have a streaming token\n            }else if( this.can_stream() && !this.stt_guided ) {\n                this.is_streaming = true;\n                //Init streaming audio helper\n                log.debug(\"using audio helper and streaming rec\");\n                this.audiohelper =  audioHelper.clone();\n                this.audiohelper.init(this.waveHeight,this.uniqueid, this);\n\n                that.audiohelper.onError = on_error;\n                that.audiohelper.onStop = on_stopped;\n                that.audiohelper.onStream = on_gotstream;\n                that.audiohelper.onfinalspeechcapture = function(speechtext){\n                    that.gotRecognition(speechtext);\n                    that.update_audio('isRecording',false);\n                    that.update_audio('isRecognizing',false);\n                };\n                that.audiohelper.oninterimspeechcapture = function(speechtext){\n                    that.gotInterimRecognition(speechtext);\n                };\n\n            //If upload_transcriber\n            } else {\n                //set up upload_transcriber\n                log.debug(\"using upload_transcriber\");\n                this.audiohelper =  audioHelper.clone();\n                this.audiohelper.init(this.waveHeight,this.uniqueid,this);\n\n                that.audiohelper.onError = on_error;\n                that.audiohelper.onStop = on_stopped;\n                that.audiohelper.onStream = on_gotstream;\n\n            }//end of setting up recorders\n\n            // Set up token refresh\n            log.debug('original speechtoken - ' + this.speechtoken);\n            log.debug('speechtokentype - ' + this.speechtokentype);\n            log.debug('speechtokenvalidseconds - ' + this.speechtokenvalidseconds);\n            this.init_token_refresh();\n\n            // Setting up timer.\n            this.timer = timer.clone();\n            this.timer.init(this.maxtime, handle_timer_update);\n            // Init the timer readout\n            handle_timer_update();\n        },\n\n        can_stream: function( ){\n            return (this.speechtoken && this.speechtoken !== 'false'&& this.speechtokentype === 'assemblyai' && !this.stt_guided);\n        },\n\n        can_msspeech: function( ){\n            return (this.speechtoken && this.speechtoken !== 'false' && this.speechtokentype === 'msspeech');\n        },\n\n        update_currentprompt: function(targettext){\n            this.currentPrompt = targettext;\n            if(this.using_msspeech){\n                this.msspeech_instance.set_reference_text(targettext);\n            }\n        },\n\n        blobToArrayBuffer: function (blob) {\n            return new Promise((resolve, reject) => {\n                const reader = new FileReader();\n                reader.onload = function(event) {\n                    resolve(event.target.result);\n                };\n                reader.onerror = function(error) {\n                    reject(error);\n                };\n                reader.readAsArrayBuffer(blob);\n            });\n        },\n\n        init_strings: function(){\n            var that=this;\n            str.get_strings([\n                { \"key\": \"allowmicaccess\", \"component\": 'mod_minilesson'},\n                { \"key\": \"nomicdetected\", \"component\": 'mod_minilesson'},\n                { \"key\": \"speechnotrecognized\", \"component\": 'mod_minilesson'},\n\n            ]).done(function (s) {\n                var i = 0;\n                that.strings.allowmicaccess = s[i++];\n                that.strings.nomicdetected = s[i++];\n                that.strings.speechnotrecognized = s[i++];\n            });\n        },\n\n        prepare_html: function(){\n            this.controls.recordercontainer =$('#ttrec_container_' + this.uniqueid);\n            this.controls.recorderbutton = $('#' + this.uniqueid + '_recorderdiv');\n            this.controls.waveform = $('#' + this.uniqueid + '_waveform');\n            this.controls.timerstatus = $('.timerstatus_' + this.uniqueid);\n            this.passagehash = this.controls.recorderbutton.data('passagehash');\n            this.region=this.controls.recorderbutton.data('region');\n            this.lang=this.controls.recorderbutton.data('lang');\n            this.asrurl=this.controls.recorderbutton.data('asrurl');\n            this.speechtoken=this.controls.recorderbutton.data('speechtoken');\n            this.speechtokenvalidseconds=this.controls.recorderbutton.data('speechtokenvalidseconds');\n            this.speechtokentype=this.controls.recorderbutton.data('speechtokentype');\n            this.forcestreaming=this.controls.recorderbutton.data('forcestreaming');\n            this.maxtime=this.controls.recorderbutton.data('maxtime');\n            this.waveHeight=this.controls.recorderbutton.data('waveheight');\n        },\n\n        init_token_refresh: function() {\n            var that = this;\n            var validsecs = Number(that.speechtokenvalidseconds) || 0;\n            // If we have a token, then we can set up a timer to refresh it\n            if (that.speechtoken && validsecs > 0) {\n                //(valid until seconds - now seconds) => milliseconds\n                var refreshInterval = validsecs * 1000;\n                log.debug('Refreshing ' + that.speechtokentype +' token after ' + refreshInterval + ' milliseconds');\n                if (refreshInterval > 0) {\n                    setTimeout(function() {\n                        // Refresh the token\n                        log.debug('Refreshing streaming token...');\n                        var ajaxresult =  ajax.call([{\n                            methodname: 'mod_minilesson_refresh_token',\n                            args: {\n                                'type': that.speechtokentype,\n                                'region': that.region\n                            },\n                            async: false\n                        }])[0].then(ajaxresult => {\n                            log.debug('New token ajaxresult:', ajaxresult);\n                            var newtoken = JSON.parse(ajaxresult);\n                            log.debug('New token received:', newtoken);\n                            // Update our internal token\n                            if(newtoken && newtoken.token) {\n                                that.speechtoken = newtoken.token;\n                                that.speechtokenvalidseconds = newtoken.validseconds;\n                                switch (that.speechtokentype) {\n                                    case 'assemblyai':\n                                        that.helper.streamer.updatetoken(newtoken.token);\n                                        break;\n                                    case 'msspeech':\n                                        that.msspeech_instance.updatetoken(newtoken.token);\n                                        break;\n                                }\n                                log.debug('Streaming token refreshed successfully.');\n                                // Start the countdown all over again\n                                that.init_token_refresh();\n                            } else {\n                                log.debug('New token was not a token.');\n                            }\n                        });\n\n                    }, refreshInterval);\n\n                } else {\n                    log.debug('Refresh interval is 0. Not refreshing token.');\n                }\n            } else {\n                log.debug('No valid streaming token available, skipping refresh setup.');\n            }\n        },\n\n        silence_detected: function(){\n            if(this.audio.isRecording){\n                this.toggleRecording();\n            }\n        },\n\n        update_audio: function(newprops,val){\n            if (typeof newprops === 'string') {\n                log.debug('update_audio:' + newprops + ':' + val);\n                if (this.audio[newprops] !== val) {\n                    this.audio[newprops] = val;\n                    this.audio_updated();\n                }\n            }else{\n                for (var theprop in newprops) {\n                    this.audio[theprop] = newprops[theprop];\n                    log.debug('update_audio:' + theprop + ':' + newprops[theprop]);\n                }\n                this.audio_updated();\n            }\n        },\n\n        register_events: function(){\n            var that = this;\n            this.controls.recordercontainer.click(function(){\n                that.toggleRecording();\n            });\n\n            this.audio_updated=function() {\n                //pointer\n                if (that.audio.isRecognizing || that.audio.isWaiting ) {\n                    that.show_recorder_pointer('none');\n                } else {\n                    that.show_recorder_pointer('auto');\n                }\n                //the color\n                //we no longer swap out colors for waiting .. its too fast and a bit jarring\n                if(that.audio.isRecognizing || that.audio.isWaiting){\n                    this.controls.recorderbutton.removeClass('ttrec_ready');\n                    this.controls.recorderbutton.removeClass('ttrec_waiting');\n                    this.controls.waveform.removeClass('ttrec_waiting');\n                    this.controls.recorderbutton.removeClass('ttrec_isrecording');\n                    this.controls.recorderbutton.addClass('ttrec_engaged');\n                } else if (that.audio.isRecording) {\n                    this.controls.recorderbutton.removeClass('ttrec_ready');\n                    this.controls.waveform.removeClass('ttrec_waiting');\n                    this.controls.recorderbutton.removeClass('ttrec_waiting');\n                    this.controls.recorderbutton.removeClass('ttrec_engaged');\n                    this.controls.recorderbutton.addClass('ttrec_isrecording');\n                } else if (that.audio.isWaiting && false) {\n                    this.controls.recorderbutton.removeClass('ttrec_engaged');\n                    this.controls.recorderbutton.removeClass('ttrec_ready');\n                    this.controls.recorderbutton.removeClass('ttrec_isrecording');\n                    this.controls.recorderbutton.addClass('ttrec_waiting');\n                    this.controls.waveform.addClass('ttrec_waiting');\n                }else{\n                    this.controls.recorderbutton.removeClass('ttrec_engaged');\n                    this.controls.recorderbutton.removeClass('ttrec_waiting');\n                    this.controls.recorderbutton.removeClass('ttrec_isrecording');\n                    this.controls.waveform.removeClass('ttrec_waiting');\n                    this.controls.recorderbutton.addClass('ttrec_ready');\n                }\n\n                //the font awesome spinner/mic/square\n                that.controls.recorderbutton.html(that.recordBtnContent());\n            };\n\n        },\n\n        show_recorder_pointer: function(show){\n            if(show) {\n                this.controls.recorderbutton.css('pointer-events', 'none');\n            }else{\n                this.controls.recorderbutton.css('pointer-events', 'auto');\n            }\n\n        },\n\n        startedRecording:function(){\n\n            var message={};\n            message.type='recording';\n            message.results = '';\n            this.callback(message);\n        },\n\n        gotMSResults:function(results){\n            log.debug(results);\n            var message={};\n            message.type='pronunciation_results';\n            message.results = results;\n            this.callback(message);\n        },\n\n        gotRecognition:function(transcript){\n            log.debug('transcript:' + transcript);\n            if(transcript.trim()==''){return;}\n            var message={};\n            message.type='speech';\n            message.capturedspeech = transcript;\n            this.callback(message);\n        },\n\n        gotInterimRecognition:function(transcript){\n            var message={};\n            message.type='interimspeech';\n            message.capturedspeech = transcript;\n           //POINT\n            this.callback(message);\n        },\n\n        cleanWord: function(word) {\n            return word.replace(/['!\"#$%&\\\\'()\\*+,\\-\\.\\/:;<=>?@\\[\\\\\\]\\^_`{|}~']/g,\"\").toLowerCase();\n        },\n\n        recordBtnContent: function() {\n\n            if(!this.audio.isRecognizing){\n\n                if (this.audio.isRecording) {\n                    return '<i class=\"fa fa-stop\">';\n\n                } else if(this.audio.isWaiting) {\n                    return '<i class=\"fa fa-solid fa-cog fa-spin\">';\n\n                } else {\n                    return '<i class=\"fa fa-microphone\">';\n                }\n            } else {\n                return '<i class=\"fa fa-spinner fa-spin\">';\n            }\n        },\n        toggleRecording: function() {\n            var that =this;\n\n            //If we are recognizing, then we want to discourage super click'ers\n            if (this.audio.isRecognizing || this.audio.isWaiting) {\n                return;\n            }\n\n            //If we are currently recording\n            if (this.audio.isRecording) {\n                that.timer.stop();\n\n                //If using Browser Rec (chrome speech)\n                if(this.usebrowserrec){\n                    that.update_audio('isRecording',false);\n                    that.update_audio('isRecognizing',true);\n                    this.browserrec.stop();\n                //If using upload_transcriber or streaming\n                }else{\n                    this.update_audio('isRecognizing',true);\n                    this.audiohelper.stop();\n                }\n\n             //If we are NOT currently recording\n            } else {\n                // Run the timer\n                that.currentTime = 0;\n                that.timer.reset();\n                that.timer.start();\n\n\n                //If using Browser Rec (chrome speech)\n                if(this.usebrowserrec){\n                    this.update_audio('isRecording',true);\n                    this.browserrec.start();\n\n                //If using Audio helper for upload_transcriber or streaming\n                }else {\n                    var newaudio = {\n                        stream: null,\n                        blob: null,\n                        dataURI: null,\n                        start: new Date(),\n                        end: null,\n                        isRecording: false,\n                        isRecognizing: false,\n                        isWaiting: true,\n                        transcript: null\n                    };\n                    this.update_audio(newaudio);\n                    this.audiohelper.start();\n                }\n                this.startedRecording();\n            }\n        },\n\n        upload_transcribe: function(blob, callback) {\n            var bodyFormData = new FormData();\n            var blobname = this.uniqueid + Math.floor(Math.random() * 100) +  '.wav';\n            bodyFormData.append('audioFile', blob, blobname);\n            bodyFormData.append('scorer', this.passagehash);\n            if(this.stt_guided) {\n                bodyFormData.append('strictmode', 'false');\n            }else{\n                bodyFormData.append('strictmode', 'true');\n            }\n            //prompt is used by whisper and other transcibers down the line\n            if(this.currentPrompt!==false){\n                bodyFormData.append('prompt', this.currentPrompt);\n            }\n            bodyFormData.append('lang', this.lang);\n            bodyFormData.append('wwwroot', M.cfg.wwwroot);\n\n            var oReq = new XMLHttpRequest();\n            oReq.open(\"POST\", this.asrurl, true);\n            oReq.onUploadProgress= function(progressEvent) {};\n            oReq.onload = function(oEvent) {\n                if (oReq.status === 200) {\n                    callback(JSON.parse(oReq.response));\n                } else {\n                    callback({data: {result: \"error\"}});\n                    log.debug(oReq.error);\n                }\n            };\n            try {\n                oReq.send(bodyFormData);\n            }catch(err){\n                callback({data: {result: \"error\"}});\n                log.debug(err);\n            }\n        },\n\n        do_msspeech: function(blob, callback) {\n            this.msspeech_instance.recognize(blob,callback)\n        },\n\n    };//end of return value\n\n});"],"file":"ttrecorder.min.js"}