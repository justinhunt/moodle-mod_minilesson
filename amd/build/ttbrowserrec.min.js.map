{"version":3,"sources":["../src/ttbrowserrec.js"],"names":["define","$","log","debug","recognition","recognizing","final_transcript","interim_transcript","start_timestamp","lang","interval","browsertype","clone","extend","will_work_ok","window","self","top","is_mobileapp","navigator","userAgent","indexOf","brave","edge","toLowerCase","has_chrome","has_safari","is_ios","is_android","hasspeechrec","init","waveheight","uniqueid","SpeechRecognition","webkitSpeechRecognition","continuous","interimResults","waveHeight","prepare_html","register_events","canvas","canvasCtx","getContext","set_grammar","grammar","SpeechGrammarList","webkitSpeechGrammarList","speechRecognitionList","addFromString","grammars","start","that","Date","now","onstart","setInterval","drawWave","stop","clearInterval","clearRect","width","setTimeout","onfinalspeechcapture","onend","onerror","event","error","timeStamp","name","onresult","i","resultIndex","results","length","isFinal","transcript","provisional_transcript","oninterimspeechcapture","bufferLength","fillStyle","fillRect","lineWidth","strokeStyle","beginPath","x","v","Math","random","y","lineTo","stroke","speechtext"],"mappings":"AACAA,OAAM,+BAAC,CAAC,QAAD,CAAW,UAAX,CAAD,CAAyB,SAAUC,CAAV,CAAaC,CAAb,CAAkB,CAE7C,aAEAA,CAAG,CAACC,KAAJ,CAAU,iDAAV,EAEA,MAAO,CAEHC,WAAW,CAAE,IAFV,CAGHC,WAAW,GAHR,CAIHC,gBAAgB,CAAE,EAJf,CAKHC,kBAAkB,CAAE,EALjB,CAMHC,eAAe,CAAE,CANd,CAOHC,IAAI,CAAE,OAPH,CAQHC,QAAQ,CAAE,CARP,CASHC,WAAW,CAAE,EATV,CAaHC,KAAK,CAAE,gBAAY,CACf,MAAOX,CAAAA,CAAC,CAACY,MAAF,IAAe,EAAf,CAAmB,IAAnB,CACV,CAfE,CAiBHC,YAAY,CAAE,uBAAc,CAGxB,GAAIC,MAAM,CAACC,IAAP,GAAgBD,MAAM,CAACE,GAA3B,CAAgC,CAE/B,CAGD,GAAIC,CAAAA,CAAY,GAAhB,CACA,GAAkD,CAAC,CAA/C,CAAAC,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,cAA5B,CAAJ,CAAsD,CAClDH,CAAY,GACf,CAGD,GAAII,CAAAA,CAAK,CAA8B,WAA3B,QAAOH,CAAAA,SAAS,CAACG,KAA7B,CACA,GAAGA,CAAH,CAAS,CACL,KAAKX,WAAL,CAAmB,OACtB,CAGD,GAAIY,CAAAA,CAAI,CAAuD,CAAC,CAArD,CAAAJ,SAAS,CAACC,SAAV,CAAoBI,WAApB,GAAkCH,OAAlC,CAA0C,MAA1C,CAAX,CACD,GAAGE,CAAI,EAAyB,EAArB,QAAKZ,WAAhB,CAAmC,CAC/B,KAAKA,WAAL,CAAmB,MACtB,CAvBwB,GA0BpBc,CAAAA,CAAU,CAA2C,CAAC,CAAzC,CAAAN,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,QAA5B,CA1BO,CA2BpBK,CAAU,CAA2C,CAAC,CAAzC,CAAAP,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,QAA5B,CA3BO,CA4BpBM,CAAM,CAA4C,CAAC,CAAzC,CAAAR,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,QAA5B,GAC4B,CAAC,CAAvC,CAAAF,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,MAA5B,CA7BoB,CA+BxB,GADaK,CAAU,EAAI,CAACD,CACzB,EAA+B,EAArB,QAAKd,WAAlB,CAAqC,CACjC,KAAKA,WAAL,CAAmB,QACtB,CAjCuB,GAoCpBiB,CAAAA,CAAU,CAA4C,CAAC,CAA1C,CAAAT,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,SAA5B,CApCO,CAqCpBQ,CAAY,CAAI,2BAA6Bd,CAAAA,MAA7B,EAAuC,qBAAuBA,CAAAA,MArC1D,CAsCxB,GAAGc,CAAY,EAAyB,EAArB,QAAKlB,WAArB,EAA2Cc,CAA9C,CAAyD,CACrD,KAAKd,WAAL,CAAmB,QACtB,CAKD,GAAGO,CAAY,EAAIS,CAAnB,CAA2B,CACvB,QACH,CAFD,IAEO,IAAwB,OAArB,QAAKhB,WAAR,CAAgC,CACnC,QACH,CAFM,IAEA,CACH,MAAOkB,CAAAA,CACV,CACJ,CArEE,CAuEHC,IAAI,CAAE,cAAUrB,CAAV,CAAesB,CAAf,CAA0BC,CAA1B,CAAoC,IAClCC,CAAAA,CAAiB,CAAGA,CAAiB,EAAIC,uBADP,CAElCN,CAAU,CAA4C,CAAC,CAA1C,CAAAT,SAAS,CAACC,SAAV,CAAoBC,OAApB,CAA4B,SAA5B,CAFqB,CAGtC,KAAKjB,WAAL,CAAmB,GAAI6B,CAAAA,CAAvB,CACA,KAAK7B,WAAL,CAAiB+B,UAAjB,IAEA,KAAK/B,WAAL,CAAiBgC,cAAjB,CAAkC,CAACR,CAAnC,CACA,KAAKnB,IAAL,CAAYA,CAAZ,CACA,KAAK4B,UAAL,CAAkBN,CAAlB,CACA,KAAKC,QAAL,CAAgBA,CAAhB,CACA,KAAKM,YAAL,GACA,KAAKC,eAAL,EACH,CAnFE,CAqFHD,YAAY,CAAE,uBAAU,CACpB,KAAKE,MAAL,CAAavC,CAAC,CAAC,IAAM,KAAK+B,QAAX,CAAsB,WAAvB,CAAd,CACA,KAAKS,SAAL,CAAiB,KAAKD,MAAL,CAAY,CAAZ,EAAeE,UAAf,CAA0B,IAA1B,CACpB,CAxFE,CA0FHC,WAAW,CAAE,qBAAUC,CAAV,CAAmB,CAC5B,GAAIC,CAAAA,CAAiB,CAAGA,CAAiB,EAAIC,uBAA7C,CACA,GAAID,CAAJ,CAAuB,CACnB,GAAIE,CAAAA,CAAqB,CAAG,GAAIF,CAAAA,CAAhC,CACAE,CAAqB,CAACC,aAAtB,CAAoCJ,CAApC,CAA6C,CAA7C,EACA,KAAKxC,WAAL,CAAiB6C,QAAjB,CAA4BF,CAC/B,CACJ,CAjGE,CAmGHG,KAAK,CAAE,gBAAY,CACf,GAAIC,CAAAA,CAAI,CAAE,IAAV,CAGA,GAAI,KAAK9C,WAAT,CAAsB,CAClB,MACH,CACD,KAAKA,WAAL,IACA,KAAKC,gBAAL,CAAwB,EAAxB,CACA,KAAKC,kBAAL,CAA0B,EAA1B,CACA,KAAKH,WAAL,CAAiBK,IAAjB,CAAwB,KAAKA,IAA7B,CACA,KAAKL,WAAL,CAAiB8C,KAAjB,GACA,KAAK1C,eAAL,CAAuB4C,IAAI,CAACC,GAAL,EAAvB,CACAF,CAAI,CAACG,OAAL,GAIAH,CAAI,CAACzC,QAAL,CAAgB6C,WAAW,CAAC,UAAW,CACnCJ,CAAI,CAACK,QAAL,EACH,CAF0B,CAExB,GAFwB,CAG9B,CAvHE,CAyHHC,IAAI,CAAE,eAAY,CACd,GAAIN,CAAAA,CAAI,CAAC,IAAT,CACA,KAAK9C,WAAL,IACA,KAAKD,WAAL,CAAiBqD,IAAjB,GACAC,aAAa,CAAC,KAAKhD,QAAN,CAAb,CACA,KAAK+B,SAAL,CAAekB,SAAf,CAAyB,CAAzB,CAA4B,CAA5B,CAAmD,CAApB,MAAKnB,MAAL,CAAYoB,KAAZ,EAA/B,CAAwE,CAAlB,MAAKvB,UAA3D,EACAwB,UAAU,CAAC,UAAW,CAClBV,CAAI,CAACW,oBAAL,CAA0BX,CAAI,CAAC7C,gBAA/B,CACH,CAFS,CAEP,GAFO,CAAV,CAGA,KAAKyD,KAAL,EACH,CAnIE,CAqIHxB,eAAe,CAAE,0BAAY,IAErBnC,CAAAA,CAAW,CAAG,KAAKA,WAFE,CAGrB+C,CAAI,CAAG,IAHc,CAKzB/C,CAAW,CAAC4D,OAAZ,CAAsB,SAAUC,CAAV,CAAiB,CACnC,GAAmB,WAAf,EAAAA,CAAK,CAACC,KAAV,CAAgC,CAC5BhE,CAAG,CAACC,KAAJ,CAAU,gBAAV,CACH,CACD,GAAmB,eAAf,EAAA8D,CAAK,CAACC,KAAV,CAAoC,CAChChE,CAAG,CAACC,KAAJ,CAAU,oBAAV,CACH,CACD,GAAmB,aAAf,EAAA8D,CAAK,CAACC,KAAV,CAAkC,CAC9B,GAA6C,GAAzC,CAAAD,CAAK,CAACE,SAAN,CAAkBhB,CAAI,CAAC3C,eAA3B,CAAkD,CAC9CN,CAAG,CAACC,KAAJ,CAAU,cAAV,CACH,CAFD,IAEO,CACHD,CAAG,CAACC,KAAJ,CAAU,aAAV,CACH,CACJ,CACDgD,CAAI,CAACa,OAAL,CAAa,CAACE,KAAK,CAAE,CAACE,IAAI,CAAEH,CAAK,CAACC,KAAb,CAAR,CAAb,CACH,CAfD,CAiBA9D,CAAW,CAAC2D,KAAZ,CAAoB,UAAY,CAC5B,GAAGZ,CAAI,CAAC9C,WAAR,CAAoB,CAChB8C,CAAI,CAAC/C,WAAL,CAAiB8C,KAAjB,EACH,CAEJ,CALD,CAOA9C,CAAW,CAACiE,QAAZ,CAAuB,SAAUJ,CAAV,CAAiB,CACpC,IAAK,GAAIK,CAAAA,CAAC,CAAGL,CAAK,CAACM,WAAnB,CAAgCD,CAAC,CAAGL,CAAK,CAACO,OAAN,CAAcC,MAAlD,CAA0D,EAAEH,CAA5D,CAA+D,CAE3D,GAAIL,CAAK,CAACO,OAAN,CAAcF,CAAd,EAAiBI,OAArB,CAA8B,CAC1BvB,CAAI,CAAC7C,gBAAL,EAAyB2D,CAAK,CAACO,OAAN,CAAcF,CAAd,EAAiB,CAAjB,EAAoBK,UAApB,CAAiC,GAC7D,CAFD,IAEO,CACH,GAAIC,CAAAA,CAAsB,CAAGzB,CAAI,CAAC7C,gBAAL,CAAwB2D,CAAK,CAACO,OAAN,CAAcF,CAAd,EAAiB,CAAjB,EAAoBK,UAAzE,CAGA,GAAGC,CAAsB,CAACH,MAAvB,CAAgCtB,CAAI,CAAC5C,kBAAL,CAAwBkE,MAA3D,CAAkE,CAC9D,MACH,CAFD,IAEK,CACDtB,CAAI,CAAC5C,kBAAL,CAA0BqE,CAC7B,CACDzB,CAAI,CAAC0B,sBAAL,CAA4B1B,CAAI,CAAC5C,kBAAjC,CACH,CACJ,CAEJ,CACJ,CArLE,CAuLHiD,QAAQ,CAAE,mBAAW,IAEbI,CAAAA,CAAK,CAAyB,CAAtB,MAAKpB,MAAL,CAAYoB,KAAZ,EAFK,CAGbkB,CAAY,CAAC,IAHA,CAKjB,KAAKrC,SAAL,CAAesC,SAAf,CAA2B,SAA3B,CACA,KAAKtC,SAAL,CAAeuC,QAAf,CAAwB,CAAxB,CAA2B,CAA3B,CAA8BpB,CAA9B,CAAqD,CAAhB,MAAKvB,UAA1C,EAEA,KAAKI,SAAL,CAAewC,SAAf,CAA2B,CAA3B,CACA,KAAKxC,SAAL,CAAeyC,WAAf,CAA6B,MAA7B,CACA,KAAKzC,SAAL,CAAe0C,SAAf,GAKA,OAFIC,CAAAA,CAAC,CAAG,CAER,CAASd,CAAC,CAAG,CAAb,CAAgBA,CAAC,CAAGQ,CAApB,CAAkCR,CAAC,EAAnC,CAAuC,IAE/Be,CAAAA,CAAC,CAAG,CAAkB,EAAhB,CAAAC,IAAI,CAACC,MAAL,EAAD,CAAuB,EAAxB,EAA8B,GAFH,CAG/BC,CAAC,CAAGH,CAAC,CAAG,KAAKhD,UAHkB,CAKnC,KAAU,CAAN,EAAAiC,CAAJ,EAEO,CACH,KAAK7B,SAAL,CAAegD,MAAf,CAAsBL,CAAtB,CAAyBI,CAAzB,CACH,CACDJ,CAAC,EAbgBxB,CAAK,CAAGkB,CAc5B,CAED,KAAKrC,SAAL,CAAegD,MAAf,CAAsB7B,CAAtB,CAA6B,KAAKvB,UAAlC,EACA,KAAKI,SAAL,CAAeiD,MAAf,EAEH,CAtNE,CAwNHpC,OAAO,CAAE,kBAAY,CACjBpD,CAAG,CAACC,KAAJ,CAAU,SAAV,CACH,CA1NE,CA2NH6D,OAAO,CAAE,kBAAY,CACjB9D,CAAG,CAACC,KAAJ,CAAU,OAAV,CACH,CA7NE,CA8NH4D,KAAK,CAAE,gBAAY,CACf7D,CAAG,CAACC,KAAJ,CAAU,KAAV,CACH,CAhOE,CAiOH2D,oBAAoB,CAAE,8BAAU6B,CAAV,CAAsB,CACxCzF,CAAG,CAACC,KAAJ,CAAUwF,CAAV,CACH,CAnOE,CAoOHd,sBAAsB,CAAE,iCAAsB,CAE7C,CAtOE,CAyOV,CA/OK,CAAN","sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('mod_minilesson browser speech rec: initialising');\n\n    return {\n\n        recognition: null,\n        recognizing: false,\n        final_transcript: '',\n        interim_transcript: '',\n        start_timestamp: 0,\n        lang: 'en-US',\n        interval: 0,\n        browsertype: '',\n\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        will_work_ok: function(opts){\n            //let's check if we are in an iframe\n            var is_iframe = false;\n            if (window.self !== window.top) {\n                is_iframe = true;\n            }\n\n            //is mobileapp ?\n            var is_mobileapp = false;\n            if (navigator.userAgent.indexOf(\"MoodleMobile\") > -1) {\n                is_mobileapp = true;\n            }\n\n            //Brave looks like it does speech rec, but it doesn't\n            var brave = typeof navigator.brave !== 'undefined';\n            if(brave){\n                this.browsertype = 'brave';\n            }\n\n            //Edge may or may not work, but its hard to tell from the browser agent\n            var edge = navigator.userAgent.toLowerCase().indexOf(\"edg/\") > -1;\n           if(edge && this.browsertype === ''){\n               this.browsertype = 'edge';\n           }\n\n            //Safari may or may not work, but its hard to tell from the browser agent\n            var has_chrome = navigator.userAgent.indexOf('Chrome') > -1;\n            var has_safari = navigator.userAgent.indexOf(\"Safari\") > -1;\n            var is_ios = (navigator.userAgent.indexOf(\"iPhone\") > -1 ||\n                navigator.userAgent.indexOf(\"iPad\") > -1);\n            var safari = has_safari && !has_chrome;\n            if(safari && this.browsertype === ''){\n                this.browsertype = 'safari';\n            }\n\n            //This is feature detection, and for chrome it can be trusted.\n            var is_android = navigator.userAgent.indexOf(\"Android\") > -1;\n            var hasspeechrec = ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window);\n            if(hasspeechrec && this.browsertype === '' && has_chrome){\n                this.browsertype = 'chrome';\n            }\n\n            //This is feature detection, and for chrome it can be trusted.\n            // The others might say they do speech rec, but that does not mean it works\n            // we know safari in webapp does not so we nix that here\n            if(is_mobileapp && is_ios) {\n                return false;\n            } else if(this.browsertype === 'brave'){\n                return false;\n            } else {\n                return hasspeechrec;\n            }\n        },\n\n        init: function (lang,waveheight,uniqueid) {\n            var SpeechRecognition = SpeechRecognition || webkitSpeechRecognition;\n            var is_android = navigator.userAgent.indexOf(\"Android\") > -1;\n            this.recognition = new SpeechRecognition();\n            this.recognition.continuous = true;\n            //a bug in android chrome means it reverses isfinal true and false, so we cant use interim results\n            this.recognition.interimResults = !is_android;\n            this.lang = lang;\n            this.waveHeight = waveheight;\n            this.uniqueid = uniqueid;\n            this.prepare_html();\n            this.register_events();\n        },\n\n        prepare_html: function(){\n            this.canvas =$('#' + this.uniqueid + \"_waveform\");\n            this.canvasCtx = this.canvas[0].getContext(\"2d\");\n        },\n\n        set_grammar: function (grammar) {\n            var SpeechGrammarList = SpeechGrammarList || webkitSpeechGrammarList;\n            if (SpeechGrammarList) {\n                var speechRecognitionList = new SpeechGrammarList();\n                speechRecognitionList.addFromString(grammar, 1);\n                this.recognition.grammars = speechRecognitionList;\n            }\n        },\n\n        start: function () {\n            var that =this;\n\n            //If we already started ignore this\n            if (this.recognizing) {\n                return;\n            }\n            this.recognizing = true;\n            this.final_transcript = '';\n            this.interim_transcript = '';\n            this.recognition.lang = this.lang;//select_dialect.value;\n            this.recognition.start();\n            this.start_timestamp = Date.now();//event.timeStamp;\n            that.onstart();\n\n\n            //kick off animation\n            that.interval = setInterval(function() {\n                that.drawWave();\n            }, 100);\n        },\n\n        stop: function () {\n            var that=this;\n            this.recognizing = false;\n            this.recognition.stop();\n            clearInterval(this.interval);\n            this.canvasCtx.clearRect(0, 0, this.canvas.width()*2, this.waveHeight * 2);\n            setTimeout(function() {\n                that.onfinalspeechcapture(that.final_transcript);\n            }, 1000);\n            this.onend();\n        },\n\n        register_events: function () {\n\n            var recognition = this.recognition;\n            var that = this;\n\n            recognition.onerror = function (event) {\n                if (event.error == 'no-speech') {\n                    log.debug('info_no_speech');\n                }\n                if (event.error == 'audio-capture') {\n                    log.debug('info_no_microphone');\n                }\n                if (event.error == 'not-allowed') {\n                    if (event.timeStamp - that.start_timestamp < 100) {\n                        log.debug('info_blocked');\n                    } else {\n                        log.debug('info_denied');\n                    }\n                }\n                that.onerror({error: {name: event.error}});\n            };\n\n            recognition.onend = function () {\n                if(that.recognizing){\n                    that.recognition.start();\n                }\n\n            };\n\n            recognition.onresult = function (event) {\n                for (var i = event.resultIndex; i < event.results.length; ++i) {\n                    // a bug on android chrome means it reverses isfinal true and false, so we cant use interim results\n                    if (event.results[i].isFinal) {\n                        that.final_transcript += event.results[i][0].transcript + ' ';\n                    } else {\n                        var provisional_transcript = that.final_transcript + event.results[i][0].transcript;\n                        //the interim and final events do not arrive in sequence, we dont want the length going down, its weird\n                        //so just dont respond when the sequence is wonky\n                        if(provisional_transcript.length < that.interim_transcript.length){\n                            return;\n                        }else{\n                            that.interim_transcript = provisional_transcript;\n                        }\n                        that.oninterimspeechcapture(that.interim_transcript);\n                    }\n                }\n\n            };\n        },//end of register events\n\n        drawWave: function() {\n\n            var width = this.canvas.width() * 2;\n            var bufferLength=4096;\n\n            this.canvasCtx.fillStyle = '#F5F5FE';\n            this.canvasCtx.fillRect(0, 0, width, this.waveHeight*2);\n\n            this.canvasCtx.lineWidth = 5;\n            this.canvasCtx.strokeStyle = 'gray';\n            this.canvasCtx.beginPath();\n\n            var slicewaveWidth = width / bufferLength;\n            var x = 0;\n\n            for (var i = 0; i < bufferLength; i++) {\n\n                var v = ((Math.random() * 64) + 96) / 128.0;\n                var y = v * this.waveHeight;\n\n                if (i === 0) {\n                    // this.canvasCtx.moveTo(x, y);\n                } else {\n                    this.canvasCtx.lineTo(x, y);\n                }\n                x += slicewaveWidth;\n            }\n\n            this.canvasCtx.lineTo(width, this.waveHeight);\n            this.canvasCtx.stroke();\n\n        },\n\n        onstart: function () {\n            log.debug('started');\n        },\n        onerror: function () {\n            log.debug('error');\n        },\n        onend: function () {\n            log.debug('end');\n        },\n        onfinalspeechcapture: function (speechtext) {\n            log.debug(speechtext);\n        },\n        oninterimspeechcapture: function (speechtext) {\n            // log.debug(speechtext);\n        }\n\n    };//end of returned object\n});//total end\n"],"file":"ttbrowserrec.min.js"}