define ("mod_minilesson/freespeaking",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/ttrecorder","mod_minilesson/correctionsmarkup","core/templates"],function(a,b,c,d,e,f){"use strict";b.debug("MiniLesson FreeSpeaking: initialising");return{transcript_evaluation:null,rawscore:0,percentscore:0,autosubmitmode:!1,mediaurl:!1,bloburl:!1,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){this.itemdata=c;b.debug("itemdata",c);this.quizhelper=d;this.init_components(d,c);this.register_events(a,c,d)},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.lessonitemid=a.itemdata.id;b.totalitems=a.itemdata.totalmarks;b.correctitems=0<a.rawscore?a.rawscore:0;b.grade=a.percentscore;if(a.transcript_evaluation&&a.mediaurl){a.transcript_evaluation.mediaurl=a.mediaurl}b.resultsdata=a.transcript_evaluation;a.quizhelper.do_next(b)},calculate_score:function calculate_score(a){var b=this;if(null===a){return 0}var c=1;if(b.itemdata.countwords){c=a.stats.words/b.itemdata.targetwordcount;if(1<c){c=1}}var d=1;if(0<b.itemdata.relevance){d=(a.stats.relevance+10)/100;if(1<d){d=1}}var e=Math.round(a.marks*d*c);return e},register_events:function register_events(b,c,d){var e=this;e.index=b;e.quizhelper=d;var f=a("#"+c.uniqueid+"_container .minilesson_nextbutton");f.on("click",function(){e.next_question()});a("#"+c.uniqueid+"_container").on("showElement",function(){if(0<c.timelimit){a("#"+c.uniqueid+"_container .progress-container").show();a("#"+c.uniqueid+"_container .progress-container i").show();a("#"+c.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:c.timelimit,onFinish:function onFinish(){e.ontimelimitreached()}})}})},ontimelimitreached:function ontimelimitreached(){var b=this;if(b.ttrec&&b.ttrec.audio&&(b.ttrec.audio.isRecording||b.ttrec.audio.transcript)){if(b.ttrec.audio.isRecording){b.autosubmitmode=!0;if(b.ttrec.usebrowserrec){b.ttrec.browserrec.stop()}else{b.ttrec.audiohelper.stop()}}else if(b.ttrec.audio.transcript&&!b.transcript_evaluation){b.autosubmitmode=!0;b.do_evaluation(b.ttrec.audio.transcript)}}else if(!b.transcript_evaluation){var c=a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton");c.trigger("click")}},init_components:function init_components(c,e){var f=this;f.allwords=a("#"+f.itemdata.uniqueid+"_container.mod_minilesson_mu_passage_word");f.thebutton="thettrbutton";f.wordcount=a("#"+f.itemdata.uniqueid+"_container span.ml_wordcount");f.actionbox=a("#"+f.itemdata.uniqueid+"_container div.ml_freespeaking_actionbox");f.pendingbox=a("#"+f.itemdata.uniqueid+"_container div.ml_freespeaking_pendingbox");f.resultsbox=a("#"+f.itemdata.uniqueid+"_container div.ml_freespeaking_resultsbox");f.timerdisplay=a("#"+f.itemdata.uniqueid+"_container div.ml_freespeaking_timerdisplay");var g={};g.uniqueid=e.uniqueid;g.callback=function recorderCallback(a){switch(a.type){case"recording":break;case"interimspeech":var c=f.quizhelper.count_words(a.capturedspeech);f.wordcount.text(c);break;case"speech":var d=a.capturedspeech,c=f.quizhelper.count_words(d);f.wordcount.text(c);f.do_evaluation(d);break;case"mediasaved":b.debug("Mediaurl saved at passage reading: "+a.mediaurl);f.mediaurl=a.mediaurl;f.bloburl=a.bloburl;break;}};g.stt_guided=!1;f.ttrec=d.clone();f.ttrec.init(g)},do_corrections_markup:function do_corrections_markup(a,b,c){var d=this,f=d.resultsbox.find(".mlfsr_correctedtext");e.init({correctionscontainer:f,grammarerrors:a,grammarmatches:b,insertioncount:c})},do_evaluation:function do_evaluation(c){var d=this;d.resultsbox.hide();d.actionbox.hide();d.pendingbox.show();this.quizhelper.evaluateTranscript(c,this.itemdata.itemid).then(function(e){var g=JSON.parse(e);if(g){g.reviewsettings=d.itemdata.reviewsettings;g.rawscore=d.calculate_score(g);d.rawscore=d.calculate_score(g);d.percentscore=0;if(0<d.itemdata.totalmarks){d.percentscore=Math.round(100*(d.rawscore/d.itemdata.totalmarks))}if(isNaN(d.percentscore)){d.percentscore=0}g.rawscore=d.rawscore;g.percentscore=d.percentscore;g.rawspeech=c;g.maxscore=d.itemdata.totalmarks;if(d.bloburl){g.mediaurl=d.bloburl}d.transcript_evaluation=g;var h=0,i,j=Object.assign({},g);if(g.reviewsettings.showscorestarrating){if(0==d.percentscore){h=0}else if(19>d.percentscore){h=1}else if(39>d.percentscore){h=2}else if(59>d.percentscore){h=3}else if(79>d.percentscore){h=4}else{h=5}i=5-h;j.yellowstars=Array(h).fill(M.cfg,0,h);j.graystars=Array(i).fill(M.cfg,0,i)}b.debug(j);if(!d.quizhelper.showitemreview&&!d.autosubmitmode){d.next_question()}else{f.render("mod_minilesson/freespeakingresults",j).then(function(a,b){d.resultsbox.html(a);if(g.hasOwnProperty("grammarerrors")){d.do_corrections_markup(g.grammarerrors,g.grammarmatches,g.insertioncount)}d.resultsbox.show();d.pendingbox.hide();d.actionbox.hide();f.runTemplateJS(b);d.wordcount.text("0");d.ttrec.timer.stop();d.ttrec.timer.reset();var c=d.ttrec.timer.fetch_display_time();d.timerdisplay.html(c)});if(0<d.itemdata.timelimit){var k=a("#"+d.itemdata.uniqueid+"_container .progress-container #progresstimer"),l=k.attr("timer");if(l){clearInterval(l)}}}}else{b.debug("transcript_evaluation: oh no it failed");d.resultsbox.hide();d.pendingbox.hide();d.actionbox.show()}})}}});
//# sourceMappingURL=freespeaking.min.js.map
