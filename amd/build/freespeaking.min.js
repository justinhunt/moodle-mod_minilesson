define(["jquery","core/log","mod_minilesson/definitions","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/correctionsmarkup","core/templates"],(function($,log,def,cloudpoodll,ttrecorder,correctionsmarkup,templates){return log.debug("MiniLesson FreeSpeaking: initialising"),{transcript_evaluation:null,rawscore:0,percentscore:0,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.itemdata=itemdata,log.debug("itemdata",itemdata),this.quizhelper=quizhelper,this.init_components(quizhelper,itemdata),this.register_events(index,itemdata,quizhelper)},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.itemdata.totalmarks,stepdata.correctitems=this.rawscore>0?this.rawscore:0,stepdata.grade=this.percentscore,stepdata.resultsdata=this.transcript_evaluation,this.quizhelper.do_next(stepdata)},calculate_score:function(transcript_evaluation){if(null===transcript_evaluation)return 0;var wordsratio=1;this.itemdata.countwords&&(wordsratio=transcript_evaluation.stats.words/this.itemdata.targetwordcount)>1&&(wordsratio=1);var relevanceratio=1;return this.itemdata.relevance>0&&(relevanceratio=(transcript_evaluation.stats.relevance+10)/100)>1&&(relevanceratio=1),Math.round(transcript_evaluation.marks*relevanceratio*wordsratio)},register_events:function(index,itemdata,quizhelper){var self=this;self.index=index,self.quizhelper=quizhelper,$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){self.next_question()}))},init_components:function(quizhelper,itemdata){var self=this;self.allwords=$("#"+self.itemdata.uniqueid+"_container.mod_minilesson_mu_passage_word"),self.thebutton="thettrbutton",self.wordcount=$("#"+self.itemdata.uniqueid+"_container span.ml_wordcount"),self.actionbox=$("#"+self.itemdata.uniqueid+"_container div.ml_freespeaking_actionbox"),self.pendingbox=$("#"+self.itemdata.uniqueid+"_container div.ml_freespeaking_pendingbox"),self.resultsbox=$("#"+self.itemdata.uniqueid+"_container div.ml_freespeaking_resultsbox"),self.timerdisplay=$("#"+self.itemdata.uniqueid+"_container div.ml_freespeaking_timerdisplay");var recorderCallback=function(message){switch(message.type){case"recording":break;case"interimspeech":var wordcount=self.quizhelper.count_words(message.capturedspeech);self.wordcount.text(wordcount);break;case"speech":var speechtext=message.capturedspeech;wordcount=self.quizhelper.count_words(speechtext);self.wordcount.text(wordcount),self.do_evaluation(speechtext)}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=recorderCallback,opts.stt_guided=!1,self.ttrec=ttrecorder.clone(),self.ttrec.init(opts)}else cloudpoodll.init("minilesson-recorder-passagereading-"+itemdata.id,recorderCallback)},do_corrections_markup:function(grammarerrors,grammarmatches,insertioncount){var correctionscontainer=this.resultsbox.find(".mlfsr_correctedtext");correctionsmarkup.init({correctionscontainer:correctionscontainer,grammarerrors:grammarerrors,grammarmatches:grammarmatches,insertioncount:insertioncount})},do_evaluation:function(speechtext){var self=this;self.resultsbox.hide(),self.actionbox.hide(),self.pendingbox.show(),this.quizhelper.evaluateTranscript(speechtext,this.itemdata.itemid).then((function(ajaxresult){var transcript_evaluation=JSON.parse(ajaxresult);transcript_evaluation?(transcript_evaluation.rawscore=self.calculate_score(transcript_evaluation),self.rawscore=self.calculate_score(transcript_evaluation),self.itemdata.totalmarks>0&&(self.percentscore=Math.round(self.rawscore/self.itemdata.totalmarks*100)),transcript_evaluation.rawscore=self.rawscore,transcript_evaluation.percentscore=self.percentscore,transcript_evaluation.rawspeech=speechtext,transcript_evaluation.maxscore=self.itemdata.totalmarks,self.transcript_evaluation=transcript_evaluation,log.debug(transcript_evaluation),self.quizhelper.showitemreview?templates.render("mod_minilesson/freespeakingresults",transcript_evaluation).then((function(html,js){self.resultsbox.html(html),transcript_evaluation.hasOwnProperty("grammarerrors")&&self.do_corrections_markup(transcript_evaluation.grammarerrors,transcript_evaluation.grammarmatches,transcript_evaluation.insertioncount),self.resultsbox.show(),self.pendingbox.hide(),self.actionbox.hide(),templates.runTemplateJS(js),self.wordcount.text("0"),self.ttrec.timer.reset();var displaytime=self.ttrec.timer.fetch_display_time();self.timerdisplay.html(displaytime)})):self.next_question()):(log.debug("transcript_evaluation: oh no it failed"),self.resultsbox.hide(),self.pendingbox.hide(),self.actionbox.show())}))}}}));

//# sourceMappingURL=freespeaking.min.js.map