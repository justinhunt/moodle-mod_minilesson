define ("mod_minilesson/freespeaking",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/ttrecorder","mod_minilesson/correctionsmarkup","core/templates"],function(a,b,c,d,e,f){"use strict";b.debug("MiniLesson FreeSpeaking: initialising");return{transcript_evaluation:null,rawscore:0,percentscore:0,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){this.itemdata=c;b.debug("itemdata",c);this.quizhelper=d;this.init_components(d,c);this.register_events(a,c,d)},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.itemdata.totalmarks;b.correctitems=0<a.rawscore?a.rawscore:0;b.grade=a.percentscore;b.resultsdata=a.transcript_evaluation;a.quizhelper.do_next(b)},calculate_score:function calculate_score(a){var b=this;if(null===a){return 0}var c=1;if(b.itemdata.countwords){c=a.stats.words/b.itemdata.targetwordcount;if(1<c){c=1}}var d=1;if(0<b.itemdata.relevance){d=(a.stats.relevance+10)/100;if(1<d){d=1}}var e=Math.round(a.marks*d*c);return e},register_events:function register_events(b,c,d){var e=this;e.index=b;e.quizhelper=d;var f=a("#"+c.uniqueid+"_container .minilesson_nextbutton");f.on("click",function(){e.next_question()});a("#"+c.uniqueid+"_container").on("showElement",function(){if(0<c.timelimit){a("#"+c.uniqueid+"_container .progress-container").show();a("#"+c.uniqueid+"_container .progress-container i").show();a("#"+c.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:c.timelimit,onFinish:function onFinish(){f.trigger("click")}})}})},init_components:function init_components(b,c){var e=this;e.allwords=a("#"+e.itemdata.uniqueid+"_container.mod_minilesson_mu_passage_word");e.thebutton="thettrbutton";e.wordcount=a("#"+e.itemdata.uniqueid+"_container span.ml_wordcount");e.actionbox=a("#"+e.itemdata.uniqueid+"_container div.ml_freespeaking_actionbox");e.pendingbox=a("#"+e.itemdata.uniqueid+"_container div.ml_freespeaking_pendingbox");e.resultsbox=a("#"+e.itemdata.uniqueid+"_container div.ml_freespeaking_resultsbox");e.timerdisplay=a("#"+e.itemdata.uniqueid+"_container div.ml_freespeaking_timerdisplay");var f={};f.uniqueid=c.uniqueid;f.callback=function recorderCallback(a){switch(a.type){case"recording":break;case"interimspeech":var b=e.quizhelper.count_words(a.capturedspeech);e.wordcount.text(b);break;case"speech":var c=a.capturedspeech,b=e.quizhelper.count_words(c);e.wordcount.text(b);e.do_evaluation(c);}};f.stt_guided=!1;e.ttrec=d.clone();e.ttrec.init(f)},do_corrections_markup:function do_corrections_markup(a,b,c){var d=this,f=d.resultsbox.find(".mlfsr_correctedtext");e.init({correctionscontainer:f,grammarerrors:a,grammarmatches:b,insertioncount:c})},do_evaluation:function do_evaluation(a){var c=this;c.resultsbox.hide();c.actionbox.hide();c.pendingbox.show();this.quizhelper.evaluateTranscript(a,this.itemdata.itemid).then(function(d){var e=JSON.parse(d);if(e){e.reviewsettings=c.itemdata.reviewsettings;e.rawscore=c.calculate_score(e);c.rawscore=c.calculate_score(e);c.percentscore=0;if(0<c.itemdata.totalmarks){c.percentscore=Math.round(100*(c.rawscore/c.itemdata.totalmarks))}if(isNaN(c.percentscore)){c.percentscore=0}e.rawscore=c.rawscore;e.percentscore=c.percentscore;e.rawspeech=a;e.maxscore=c.itemdata.totalmarks;c.transcript_evaluation=e;var g=0,h;if(e.reviewsettings.showscorestarrating){if(0==c.percentscore){g=0}else if(19>c.percentscore){g=1}else if(39>c.percentscore){g=2}else if(59>c.percentscore){g=3}else if(79>c.percentscore){g=4}else{g=5}h=5-g;c.transcript_evaluation.yellowstars=Array(g).fill(M.cfg,0,g);c.transcript_evaluation.graystars=Array(h).fill(M.cfg,0,h)}b.debug(e);if(!c.quizhelper.showitemreview){c.next_question()}else{f.render("mod_minilesson/freespeakingresults",e).then(function(a,b){c.resultsbox.html(a);if(e.hasOwnProperty("grammarerrors")){c.do_corrections_markup(e.grammarerrors,e.grammarmatches,e.insertioncount)}c.resultsbox.show();c.pendingbox.hide();c.actionbox.hide();f.runTemplateJS(b);c.wordcount.text("0");c.ttrec.timer.reset();var d=c.ttrec.timer.fetch_display_time();c.timerdisplay.html(d)})}}else{b.debug("transcript_evaluation: oh no it failed");c.resultsbox.hide();c.pendingbox.hide();c.actionbox.show()}})}}});
//# sourceMappingURL=freespeaking.min.js.map
