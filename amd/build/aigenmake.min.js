define ("mod_minilesson/aigenmake",["jquery","core/log","core/templates","core/fragment","core/modal_factory","core/str","core/config","core/modal_events","core_table/dynamic","core/ajax"],function(a,b,c,d,f,g,h,i,j,k){"use strict";b.debug("MiniLesson AiGen Config Maker: initialising");return{controls:{},init:function init(a){var b=this;b.init_controls(a);b.register_events(a);b.set_data()},init_controls:function init_controls(b){var c=this;c.controls.selectgenerate=a("#"+b+" select[name=\"generatemethod\"]");c.controls.aigenmakebtn=a("#"+b+"_aigen_make_btn");c.controls.fieldmappings=a("#"+b+" #id_fieldmappings");c.controls.aigenmake_textarea=a("#"+b+"_aigen_make_textarea")},register_events:function register_events(d){var f=this;f.controls.aigenmakebtn.on("click",function(){var c=[],e=a(".ml_aigen_item"),g=a("#"+d+"_ml_aigen_lesson_title input").val(),h=a("#"+d+"_ml_aigen_lesson_description textarea").val();e.each(function(b,d){var e={itemnumber:+a(d).data("itemnumber")},f=a(d).find("textarea[name=\"aigenprompt\"]");e.prompt=f.val();var g=a(d).find("select[name=\"generatemethod\"]");e.generatemethod=g.val();var h=a(d).find(".aigen_fields-to-generate input[type=\"checkbox\"]"),i=[];h.each(function(){var b={name:a(this).attr("name"),generate:a(this).is(":checked")?1:0};if("reuse"==e.generatemethod&&b.generate){b.mapping=a(d).find("select[name=\""+b.name+"_mapping\"]").val()}else{b.mapping=""}i.push(b)});e.generatefields=i;var j=a(d).find(".aigen_fileareas-to-generate input[type=\"checkbox\"]"),k=[];j.each(function(){var b={name:a(this).attr("name"),generate:a(this).is(":checked")?1:0};if(b.generate){b.mapping=a(d).find("select[name=\""+b.name+"_mapping\"]").val()}k.push(b)});e.generatefileareas=k;var l=a(d).find("select[name=\"overall_image_context\"]").val();e.overallimagecontext=l;var m=[],n=a(d).find(".aigen_promptfield-mappings select");n.each(function(){var b={name:a(this).data("name"),mapping:a(this).val()};m.push(b)});e.promptfields=m;c.push(e)});var i={lessonTitle:g,lessonDescription:h,items:c};if(f.controls.fieldmappings.length){i[f.controls.fieldmappings.attr("name")]=JSON.parse(f.controls.fieldmappings.val())}f.controls.aigenmake_textarea.val(JSON.stringify(i,null,2));b.debug("AiGen make button clicked, items: "+JSON.stringify(i,null,2))});a(document).on("click",".aigen-reload-button",function(b){b.preventDefault();var d=a(this).closest(".ml_aigen_item").find("textarea[name=\"aigenprompt\"]"),e=d.val(),g=a(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");g.data("promptfields",f.extractFieldsFromString(e).join(","));var h={availablecontext:g.data("availablecontext").split(",").filter(function(a){return""!==a.trim()}),aigenpromptfields:g.data("promptfields").split(",").filter(function(a){return""!==a.trim()})},i=a(this).closest(".ml_aigen_item").find(".aigen_promptfield-mappings");c.render("mod_minilesson/aigenpromptfieldmappings",h).then(function(a){i.html(a)})});f.controls.selectgenerate.on("change",function(){var d=a(this).val();b.debug("Selected generate method: "+d);var e=a(this).closest(".ml_aigen_item").find("textarea[name=\"aigenprompt\"]"),g=e.data(d+"prompt");e.val(g);if("reuse"===d){e.attr("readonly",!0)}else{e.removeAttr("readonly")}var h=a(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");h.data("promptfields",f.extractFieldsFromString(g).join(","));var i={methodreuse:"reuse"==d,aigenplaceholders:h.data("aigenplaceholders").split(",").filter(function(a){return""!==a.trim()}),availablecontext:h.data("availablecontext").split(",").filter(function(a){return""!==a.trim()}),aigenpromptfields:h.data("promptfields").split(",").filter(function(a){return""!==a.trim()})};c.render("mod_minilesson/aigenmappings",i).then(function(a){b.debug("redoing mappingsdiv: ");h.html(a)});var j=a(this).closest(".ml_aigen_item").find(".ml_aigen_filearea_mappings"),k={methodreuse:"reuse"==d,aigenplaceholders:f.splitDataField(j.data("aigenplaceholders")),contextfileareas:f.splitDataField(j.data("contextfileareas")),aigenfileareas:f.splitDataField(j.data("aigenfileareas")),availablecontext:f.splitDataField(j.data("availablecontext"))};c.render("mod_minilesson/aigenfilemappings",k).then(function(a){b.debug("redoing fileareadata: ");j.html(a)})})},set_data:function set_data(){var c=this;try{var d=c.controls.aigenmake_textarea.val(),e=JSON.parse(d);e.items.forEach(function(c,d){var e=a(".ml_aigen_item[data-itemnumber=\""+d+"\"]"),f=a(e).find("textarea[name=\"aigenprompt\"]");f.val(c.prompt);var g=function(){c.generatefields.forEach(function(b){var d=a(e).find(".aigen_fields-to-generate input[type=\"checkbox\"][name=\""+b.name+"\"]");d.prop("checked",b.generate);if(b.generate){if("reuse"==c.generatemethod){var f=a(e).find("select[name=\""+b.name+"_mapping\"]");f.val(b.mapping)}}});c.generatefileareas.forEach(function(b){var c=a(e).find(".aigen_fileareas-to-generate input[type=\"checkbox\"][name=\""+b.name+"\"]");c.prop("checked",b.generate);if(b.generate){var d=a(e).find("select[name=\""+b.name+"_mapping\"]");d.val(b.mapping)}});var b=a(e).find("select[name=\"overall_image_context\"]");b.val(c.overallimagecontext);c.promptfields.forEach(function(b){var c=a(e).find(".aigen_promptfield-mappings select[data-name=\""+b.name+"\"]");c.val(b.mapping)})},h=a(e).find("select[name=\"generatemethod\"]");h.val(c.generatemethod);f.data(c.generatemethod+"prompt",c.prompt);b.debug("Setting generate method to: "+c.generatemethod);b.debug("triggering");h.trigger("change");setTimeout(function(){b.debug("updating after triggering");g()},1e3)})}catch(a){b.debug("Invalid JSON");b.debug(a)}},splitDataField:function splitDataField(a){if(!a||""===a.trim()){return[]}else{return a.split(",").filter(function(a){return""!==a.trim()})}},extractFieldsFromString:function extractFieldsFromString(a){return Array.from(a.matchAll(/\{(\w+)\}/g)).reduce(function(b,a){if(-1===b.indexOf(a[1])){b.push(a[1])}return b},[])},registerAiGenerateAction:function registerAiGenerateAction(a){var b=this,c=document.querySelector(a);if(c){c.addEventListener("submit",function(a){if(a.target.elements.hasOwnProperty("templateid")){a.preventDefault();f.create({type:f.types.SAVE_CANCEL,title:g.get_string("aigenmodaltitle","mod_minilesson"),body:b.callAiGenerateContextFormApi(a.target),large:!0,removeOnClose:!0}).then(function(a){a.getRoot().on("submit "+i.save,function(d){d.preventDefault();var e=this.querySelector("form");a.setBody(b.callAiGenerateContextFormApi(e).then(function(d,e){if("submitted"===d){var f;a.destroy();b.refreshTable(c.dataset.tableuniqueid);null===(f=document.querySelector("#page"))||void 0===f?void 0:f.scrollTo({top:0,behavior:"smooth"});return["",""]}return[d,e]}))});a.show()})}});b.checkProgressBar(c.dataset.tableuniqueid)}},callAiGenerateContextFormApi:function callAiGenerateContextFormApi(a){return d.loadFragment("mod_minilesson","aigen_contextform",h.contextid,{url:a.getAttribute("action"),params:new URLSearchParams(new FormData(a)).toString()})},refreshTable:function refreshTable(a){var c=this;try{var d=j.getTableFromId(a);j.refreshTableContent(d).then(function(){c.checkProgressBar(a)})}catch(a){b.debug(a)}},checkProgressBar:function checkProgressBar(a){var c=1<arguments.length&&arguments[1]!==void 0?arguments[1]:1,d=this;try{var e=j.getTableFromId(a)}catch(a){b.debug(a)}var f=e.querySelector("table");if(!f){return}var g=parseInt(f.getAttribute("data-updateinterval"));if(0<g){c=g}if(e){var i={};e.querySelectorAll("[data-region=\"progressbar\"]").forEach(function(a){var b=parseInt(a.getAttribute("data-id"));if(0<b){i[b]=a}});var l=Object.keys(i).map(parseInt);if(0<Object.keys(l).length){k.call([{methodname:"mod_minilesson_update_progressbars",args:{contextid:h.contextid,ids:l}}])[0].then(function(b){b.forEach(function(a){if(-1<l.indexOf(a.id)){var b=i[a.id].closest("tr");a.columns.forEach(function(a,c){if(a.update){var d=b.querySelector("td.c"+c);if(d){d.innerHTML=a.data;d.dataset.column=a.column}}})}});setTimeout(function(){d.checkProgressBar(a)},1e3*c)})}}}}});
//# sourceMappingURL=aigenmake.min.js.map
