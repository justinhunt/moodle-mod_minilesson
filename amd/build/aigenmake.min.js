define ("mod_minilesson/aigenmake",["jquery","core/log","core/templates","core/fragment","core/modal_factory","core/str","core/config","core/modal_events"],function(a,b,c,d,f,g,h,i){"use strict";b.debug("MiniLesson AiGen Config Maker: initialising");return{controls:{},init:function init(a){var b=this;b.init_controls(a);b.register_events(a)},init_controls:function init_controls(c){var d=this;d.controls.selectgenerate=a("#"+c+" select[name=\"generatemethod\"]");d.controls.aigenmakebtn=a("#"+c+"_aigen_make_btn");d.controls.fieldmappings=a("#"+c+" #id_fieldmappings");d.controls.aigenmake_textarea=a("#"+c+"_aigen_make_textarea");try{var e=d.controls.aigenmake_textarea.val(),f=JSON.parse(e);f.items.forEach(function(b,c){var d=a(".ml_aigen_item[data-itemnumber=\""+c+"\"]"),e=a(d).find("textarea[name=\"aigenprompt\"]");e.val(b.prompt);var f=a(d).find("select[name=\"generatemethod\"]");f.val(b.generatemethod);b.generatefields.forEach(function(c){var e=a(d).find(".aigen_fields-to-generate input[type=\"checkbox\"][name=\""+c.name+"\"]");e.prop("checked",c.generate);if(c.generate){if("reuse"==b.generatemethod){var f=a(d).find("select[name=\""+c.name+"_mapping\"]");f.val(c.mapping)}}});b.generatefileareas.forEach(function(b){var c=a(d).find(".aigen_fileareas-to-generate input[type=\"checkbox\"][name=\""+b.name+"\"]");c.prop("checked",b.generate);if(b.generate){var e=a(d).find("select[name=\""+b.name+"_mapping\"]");e.val(b.mapping)}});b.promptfields.forEach(function(b){var c=a(d).find(".aigen_promptfield-mappings select[data-name=\""+b.name+"\"]");c.val(b.mapping)})})}catch(a){b.debug("Invalid JSON");b.debug(a)}},register_events:function register_events(d){var f=this;f.controls.aigenmakebtn.on("click",function(){var c=[],e=a(".ml_aigen_item"),g=a("#"+d+"_ml_aigen_lesson_title input").val(),h=a("#"+d+"_ml_aigen_lesson_description textarea").val();e.each(function(b,d){var e={itemnumber:+a(d).data("itemnumber")},f=a(d).find("textarea[name=\"aigenprompt\"]");e.prompt=f.val();var g=a(d).find("select[name=\"generatemethod\"]");e.generatemethod=g.val();var h=a(d).find(".aigen_fields-to-generate input[type=\"checkbox\"]"),i=[];h.each(function(){var b={name:a(this).attr("name"),generate:a(this).is(":checked")?1:0};if("reuse"==e.generatemethod&&b.generate){b.mapping=a(d).find("select[name=\""+b.name+"_mapping\"]").val()}else{b.mapping=""}i.push(b)});e.generatefields=i;var j=a(d).find(".aigen_fileareas-to-generate input[type=\"checkbox\"]"),k=[];j.each(function(){var b={name:a(this).attr("name"),generate:a(this).is(":checked")?1:0};if(b.generate){b.mapping=a(d).find("select[name=\""+b.name+"_mapping\"]").val()}k.push(b)});e.generatefileareas=k;var l=[],m=a(d).find(".aigen_promptfield-mappings select");m.each(function(){var b={name:a(this).data("name"),mapping:a(this).val()};l.push(b)});e.promptfields=l;c.push(e)});var i={lessonTitle:g,lessonDescription:h,items:c};if(f.controls.fieldmappings.length){i[f.controls.fieldmappings.attr("name")]=JSON.parse(f.controls.fieldmappings.val())}f.controls.aigenmake_textarea.val(JSON.stringify(i,null,2));b.debug("AiGen make button clicked, items: "+JSON.stringify(i,null,2))});a(document).on("click",".aigen-reload-button",function(b){b.preventDefault();var d=a(this).closest(".ml_aigen_item").find("textarea[name=\"aigenprompt\"]"),e=d.val(),g=a(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");g.data("promptfields",f.extractFieldsFromString(e).join(","));var h={availablecontext:g.data("availablecontext").split(",").filter(function(a){return""!==a.trim()}),aigenpromptfields:g.data("promptfields").split(",").filter(function(a){return""!==a.trim()})},i=a(this).closest(".ml_aigen_item").find(".aigen_promptfield-mappings");c.render("mod_minilesson/aigenpromptfieldmappings",h).then(function(a){i.html(a)})});f.controls.selectgenerate.on("change",function(){var d=a(this).val();b.debug("Selected generate method: "+d);var e=a(this).closest(".ml_aigen_item").find("textarea[name=\"aigenprompt\"]"),g=e.data(d+"prompt");e.val(g);if("reuse"===d){e.attr("readonly",!0)}else{e.removeAttr("readonly")}var h=a(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");h.data("promptfields",f.extractFieldsFromString(g).join(","));var i={methodreuse:"reuse"==d,aigenplaceholders:h.data("aigenplaceholders").split(",").filter(function(a){return""!==a.trim()}),availablecontext:h.data("availablecontext").split(",").filter(function(a){return""!==a.trim()}),aigenpromptfields:h.data("promptfields").split(",").filter(function(a){return""!==a.trim()})};c.render("mod_minilesson/aigenmappings",i).then(function(a){b.debug("redoing mappingsdiv: ");h.html(a)});var j=a(this).closest(".ml_aigen_item").find(".ml_aigen_filearea_mappings"),k={methodreuse:"reuse"==d,aigenplaceholders:f.splitDataField(j.data("aigenplaceholders")),contextfileareas:f.splitDataField(j.data("contextfileareas")),aigenfileareas:f.splitDataField(j.data("aigenfileareas"))};c.render("mod_minilesson/aigenfilemappings",k).then(function(a){b.debug("redoing fileareadata: ");j.html(a)})})},splitDataField:function splitDataField(a){if(!a||""===a.trim()){return[]}else{return a.split(",").filter(function(a){return""!==a.trim()})}},extractFieldsFromString:function extractFieldsFromString(a){return Array.from(a.matchAll(/\{(\w+)\}/g)).reduce(function(b,a){if(-1===b.indexOf(a[1])){b.push(a[1])}return b},[])},registerAiGenerateAction:function registerAiGenerateAction(a){var b=this,c=document.querySelector(a);if(c){c.addEventListener("submit",function(a){if(a.target.elements.hasOwnProperty("keyname")){a.preventDefault();f.create({type:f.types.SAVE_CANCEL,title:g.get_string("aigenmodaltitle","mod_minilesson"),body:b.callAiGenerateContextFormApi(a.target),large:!0,removeOnClose:!0}).then(function(a){a.getRoot().on("submit "+i.save,function(c){var d=this.querySelector("form");if(d.getAttribute("data-submitted")){return}c.preventDefault();a.setBody(b.callAiGenerateContextFormApi(d).then(function(a,b){if("submitted"===a){d.setAttribute("data-submitted",1);b="<script>document.getElementById(\""+d.getAttribute("id")+"\").submit()</script>"}return[d,b]}))});a.show()})}})}},callAiGenerateContextFormApi:function callAiGenerateContextFormApi(a){return d.loadFragment("mod_minilesson","aigen_contextform",h.contextid,{url:a.getAttribute("action"),params:new URLSearchParams(new FormData(a)).toString()})}}});
//# sourceMappingURL=aigenmake.min.js.map
