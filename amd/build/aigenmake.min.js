define(["jquery","core/log","core/templates","core/fragment","core/modal_factory","core/str","core/config","core/modal_events","core_table/dynamic","core/ajax"],(function($,log,templates,Fragment,Modalfactory,Str,Config,ModalEvents,DyanamicTable,Ajax){return log.debug("MiniLesson AiGen Config Maker: initialising"),{controls:{},init:function(uniqid){this.init_controls(uniqid),this.register_events(uniqid),this.set_data()},init_controls:function(uniqid){this.controls.selectgenerate=$("#"+uniqid+' select[name="generatemethod"]'),this.controls.aigenmakebtn=$("#"+uniqid+"_aigen_make_btn"),this.controls.fieldmappings=$("#"+uniqid+" #id_fieldmappings"),this.controls.aigenmake_textarea=$("#"+uniqid+"_aigen_make_textarea")},register_events:function(uniqid){var self=this;self.controls.aigenmakebtn.on("click",(function(e){var items=[],itemcontrols=$(".ml_aigen_item"),lessonTitle=$("#"+uniqid+"_ml_aigen_lesson_title input").val(),lessonDescription=$("#"+uniqid+"_ml_aigen_lesson_description textarea").val();itemcontrols.each((function(index,itemcontrol){var itemdata={};itemdata.itemnumber=Number($(itemcontrol).data("itemnumber"));var promptTextArea=$(itemcontrol).find('textarea[name="aigenprompt"]');itemdata.prompt=promptTextArea.val();var generateMethodSelect=$(itemcontrol).find('select[name="generatemethod"]');itemdata.generatemethod=generateMethodSelect.val();var generateFieldsCheckboxes=$(itemcontrol).find('.aigen_fields-to-generate input[type="checkbox"]'),generateFields=[];generateFieldsCheckboxes.each((function(){var generateField={};generateField.name=$(this).attr("name"),generateField.generate=$(this).is(":checked")?1:0,"reuse"==itemdata.generatemethod&&generateField.generate?generateField.mapping=$(itemcontrol).find('select[name="'+generateField.name+'_mapping"]').val():generateField.mapping="",generateFields.push(generateField)})),itemdata.generatefields=generateFields;var generateFileareasCheckboxes=$(itemcontrol).find('.aigen_fileareas-to-generate input[type="checkbox"]'),generateFileareas=[];generateFileareasCheckboxes.each((function(){var generateFilearea={};generateFilearea.name=$(this).attr("name"),generateFilearea.generate=$(this).is(":checked")?1:0,generateFilearea.generate&&(generateFilearea.mapping=$(itemcontrol).find('select[name="'+generateFilearea.name+'_mapping"]').val()),generateFileareas.push(generateFilearea)})),itemdata.generatefileareas=generateFileareas;var overallimagecontext=$(itemcontrol).find('select[name="overall_image_context"]').val();itemdata.overallimagecontext=overallimagecontext;var promptFields=[];$(itemcontrol).find(".aigen_promptfield-mappings select").each((function(){var promptField={};promptField.name=$(this).data("name"),promptField.mapping=$(this).val(),promptFields.push(promptField)})),itemdata.promptfields=promptFields,items.push(itemdata)}));var alldata={};alldata.lessonTitle=lessonTitle,alldata.lessonDescription=lessonDescription,alldata.items=items,self.controls.fieldmappings.length&&(alldata[self.controls.fieldmappings.attr("name")]=JSON.parse(self.controls.fieldmappings.val())),self.controls.aigenmake_textarea.val(JSON.stringify(alldata,null,2)),log.debug("AiGen make button clicked, items: "+JSON.stringify(alldata,null,2))})),$(document).on("click",".aigen-reload-button",(function(e,data){e.preventDefault();var newprompt=$(this).closest(".ml_aigen_item").find('textarea[name="aigenprompt"]').val(),mappingsDiv=$(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");mappingsDiv.data("promptfields",self.extractFieldsFromString(newprompt).join(","));var mappingsdata={availablecontext:mappingsDiv.data("availablecontext").split(",").filter((element=>""!==element.trim())),aigenpromptfields:mappingsDiv.data("promptfields").split(",").filter((element=>""!==element.trim()))},promptfieldmappingsDiv=$(this).closest(".ml_aigen_item").find(".aigen_promptfield-mappings");templates.render("mod_minilesson/aigenpromptfieldmappings",mappingsdata).then((function(html,js){promptfieldmappingsDiv.html(html)}))})),self.controls.selectgenerate.on("change",(function(){var selectedValue=$(this).val();log.debug("Selected generate method: "+selectedValue);var promptTextArea=$(this).closest(".ml_aigen_item").find('textarea[name="aigenprompt"]'),newprompt=promptTextArea.data(selectedValue+"prompt");promptTextArea.val(newprompt),"reuse"===selectedValue?promptTextArea.attr("readonly",!0):promptTextArea.removeAttr("readonly");var mappingsDiv=$(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");mappingsDiv.data("promptfields",self.extractFieldsFromString(newprompt).join(","));var mappingsdata={methodreuse:"reuse"==selectedValue,aigenplaceholders:mappingsDiv.data("aigenplaceholders").split(",").filter((element=>""!==element.trim())),availablecontext:mappingsDiv.data("availablecontext").split(",").filter((element=>""!==element.trim())),aigenpromptfields:mappingsDiv.data("promptfields").split(",").filter((element=>""!==element.trim()))};templates.render("mod_minilesson/aigenmappings",mappingsdata).then((function(html,js){log.debug("redoing mappingsdiv: "),mappingsDiv.html(html)}));var fileareasDiv=$(this).closest(".ml_aigen_item").find(".ml_aigen_filearea_mappings"),fileareasData={methodreuse:"reuse"==selectedValue,aigenplaceholders:self.splitDataField(fileareasDiv.data("aigenplaceholders")),contextfileareas:self.splitDataField(fileareasDiv.data("contextfileareas")),aigenfileareas:self.splitDataField(fileareasDiv.data("aigenfileareas")),availablecontext:self.splitDataField(fileareasDiv.data("availablecontext"))};templates.render("mod_minilesson/aigenfilemappings",fileareasData).then((function(html,js){log.debug("redoing fileareadata: "),fileareasDiv.html(html)}))}))},set_data:function(){try{var textareavalue=this.controls.aigenmake_textarea.val();JSON.parse(textareavalue).items.forEach((function(itemdata,index){var itemcontrol=$('.ml_aigen_item[data-itemnumber="'+index+'"]'),promptTextArea=$(itemcontrol).find('textarea[name="aigenprompt"]');promptTextArea.val(itemdata.prompt);var generateMethodSelect=$(itemcontrol).find('select[name="generatemethod"]');generateMethodSelect.val(itemdata.generatemethod),promptTextArea.data(itemdata.generatemethod+"prompt",itemdata.prompt),log.debug("Setting generate method to: "+itemdata.generatemethod),log.debug("triggering"),generateMethodSelect.trigger("change"),setTimeout((function(){log.debug("updating after triggering"),itemdata.generatefields.forEach((function(generateField){$(itemcontrol).find('.aigen_fields-to-generate input[type="checkbox"][name="'+generateField.name+'"]').prop("checked",generateField.generate),generateField.generate&&"reuse"==itemdata.generatemethod&&$(itemcontrol).find('select[name="'+generateField.name+'_mapping"]').val(generateField.mapping)})),itemdata.generatefileareas.forEach((function(generateFilearea){$(itemcontrol).find('.aigen_fileareas-to-generate input[type="checkbox"][name="'+generateFilearea.name+'"]').prop("checked",generateFilearea.generate),generateFilearea.generate&&$(itemcontrol).find('select[name="'+generateFilearea.name+'_mapping"]').val(generateFilearea.mapping)})),$(itemcontrol).find('select[name="overall_image_context"]').val(itemdata.overallimagecontext),itemdata.promptfields.forEach((function(promptField){$(itemcontrol).find('.aigen_promptfield-mappings select[data-name="'+promptField.name+'"]').val(promptField.mapping)}))}),1e3)}))}catch(error){log.debug("Invalid JSON"),log.debug(error)}},splitDataField:function(datafield){return datafield&&""!==datafield.trim()?datafield.split(",").filter((element=>""!==element.trim())):[]},extractFieldsFromString:function(input){const regex=new RegExp("\\{(\\w+)\\}","g");return Array.from(input.matchAll(regex)).reduce((function(a,i){return-1===a.indexOf(i[1])&&a.push(i[1]),a}),[])},registerAiGenerateAction:function(wrapperselector){var self=this,wrapper=document.querySelector(wrapperselector);wrapper&&(wrapper.addEventListener("submit",(function(e){e.target.elements.hasOwnProperty("templateid")&&(e.preventDefault(),Modalfactory.create({type:Modalfactory.types.SAVE_CANCEL,title:Str.get_string("aigenmodaltitle","mod_minilesson"),body:self.callAiGenerateContextFormApi(e.target),large:!0,removeOnClose:!0}).then((function(modal){modal.getRoot().on("submit "+ModalEvents.save,(function(e){e.preventDefault();var form=this.querySelector("form");modal.setBody(self.callAiGenerateContextFormApi(form).then((function(html,js){var _document$querySelect;return"submitted"===html?(modal.destroy(),self.refreshTable(wrapper.dataset.tableuniqueid),null===(_document$querySelect=document.querySelector("#page"))||void 0===_document$querySelect||_document$querySelect.scrollTo({top:0,behavior:"smooth"}),["",""]):[html,js]})))})),modal.show()})))})),self.checkProgressBar(wrapper.dataset.tableuniqueid))},callAiGenerateContextFormApi:function(form){return Fragment.loadFragment("mod_minilesson","aigen_contextform",Config.contextid,{url:form.getAttribute("action"),params:new URLSearchParams(new FormData(form)).toString()})},refreshTable:function(tableuniqueid){var self=this;try{var tableRoot=DyanamicTable.getTableFromId(tableuniqueid);DyanamicTable.refreshTableContent(tableRoot).then((function(){self.checkProgressBar(tableuniqueid)}))}catch(e){log.debug(e)}},checkProgressBar:function(tableuniqueid){let pinginterval=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;var self=this;try{var tableRoot=DyanamicTable.getTableFromId(tableuniqueid)}catch(e){log.debug(e)}var table=tableRoot.querySelector("table");if(table){var updateinterval=parseInt(table.getAttribute("data-updateinterval"));if(updateinterval>0&&(pinginterval=updateinterval),tableRoot){var idmap={};tableRoot.querySelectorAll('[data-region="progressbar"]').forEach((function(progressbar){var id=parseInt(progressbar.getAttribute("data-id"));id>0&&(idmap[id]=progressbar)}));var ids=Object.keys(idmap).map(parseInt);Object.keys(ids).length>0&&Ajax.call([{methodname:"mod_minilesson_update_progressbars",args:{contextid:Config.contextid,ids:ids}}])[0].then((function(response){response.forEach((function(line){if(ids.indexOf(line.id)>-1){var progressbarrow=idmap[line.id].closest("tr");line.columns.forEach((function(coldata,index){if(coldata.update){var columntd=progressbarrow.querySelector("td.c"+index);columntd&&(columntd.innerHTML=coldata.data,columntd.dataset.column=coldata.column)}}))}})),setTimeout((function(){self.checkProgressBar(tableuniqueid)}),1e3*pinginterval)}))}}}}}));

//# sourceMappingURL=aigenmake.min.js.map