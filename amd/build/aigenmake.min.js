function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}define ("mod_minilesson/aigenmake",["jquery","core/log","core/templates","core/fragment","core/modal_factory","core/str","core/config","core/modal_events"],function(a,b,c,d,f,g,h,i){"use strict";b.debug("MiniLesson AiGen Config Maker: initialising");return{controls:{},init:function init(a){var b=this;b.init_controls(a);b.register_events(a)},init_controls:function init_controls(b){var c=this;c.controls.selectgenerate=a("#"+b+" select[name=\"generatemethod\"]");c.controls.aigenmakebtn=a("#"+b+"_aigen_make_btn");c.controls.fieldmappings=a("#"+b+" #id_fieldmappings")},register_events:function register_events(d){var f=this;f.controls.aigenmakebtn.on("click",function(c){c.preventDefault();var e=[],g=a(".ml_aigen_item"),h=a("#"+d+"_aigen_make_textarea"),i=a("#"+d+"_ml_aigen_lesson_title input").val(),j=a("#"+d+"_ml_aigen_lesson_description textarea").val();g.each(function(b,c){var d={itemnumber:+a(c).data("itemnumber")},f=a(c).find("textarea[name=\"aigenprompt\"]");d.prompt=f.val();var g=a(c).find("select[name=\"generatemethod\"]");d.generatemethod=g.val();var h=a(c).find(".aigen_fields-to-generate input[type=\"checkbox\"]"),i=[];h.each(function(){var b={name:a(this).attr("name"),generate:a(this).is(":checked")?1:0};if("reuse"==d.generatemethod&&b.generate){b.mapping=a(c).find("select[name=\""+b.name+"_mapping\"]").val()}else{b.mapping=""}i.push(b)});d.generatefields=i;var j=a(c).find(".aigen_fileareas-to-generate input[type=\"checkbox\"]"),k=[];j.each(function(){var b={name:a(this).attr("name"),generate:a(this).is(":checked")?1:0};if(b.generate){b.mapping=a(c).find("select[name=\""+b.name+"_mapping\"]").val()}k.push(b)});d.generatefileareas=k;var l=[],m=a(c).find(".aigen_promptfield-mappings select");m.each(function(){var b={name:a(this).data("name"),mapping:a(this).val()};l.push(b)});d.promptfields=l;e.push(d)});var k={lessonTitle:i,lessonDescription:j,items:e};if(f.controls.fieldmappings.length){k[f.controls.fieldmappings.attr("name")]=JSON.parse(f.controls.fieldmappings.val())}h.val(JSON.stringify(k,null,2));b.debug("AiGen make button clicked, items: "+JSON.stringify(k,null,2))});a(document).on("click",".aigen-reload-button",function(b){b.preventDefault();var d=a(this).closest(".ml_aigen_item").find("textarea[name=\"aigenprompt\"]"),e=d.val(),g=a(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");g.data("promptfields",f.extractFieldsFromString(e).join(","));var h={availablecontext:g.data("availablecontext").split(",").filter(function(a){return""!==a.trim()}),aigenpromptfields:g.data("promptfields").split(",").filter(function(a){return""!==a.trim()})},i=a(this).closest(".ml_aigen_item").find(".aigen_promptfield-mappings");c.render("mod_minilesson/aigenpromptfieldmappings",h).then(function(a){i.html(a)})});f.controls.selectgenerate.on("change",function(){var d=a(this).val();b.debug("Selected generate method: "+d);var e=a(this).closest(".ml_aigen_item").find("textarea[name=\"aigenprompt\"]"),g=e.data(d+"prompt");e.val(g);if("reuse"===d){e.attr("readonly",!0)}else{e.removeAttr("readonly")}var h=a(this).closest(".ml_aigen_item").find(".ml_aigen_mappings");h.data("promptfields",f.extractFieldsFromString(g).join(","));var i={methodreuse:"reuse"==d,aigenplaceholders:h.data("aigenplaceholders").split(",").filter(function(a){return""!==a.trim()}),availablecontext:h.data("availablecontext").split(",").filter(function(a){return""!==a.trim()}),aigenpromptfields:h.data("promptfields").split(",").filter(function(a){return""!==a.trim()})};c.render("mod_minilesson/aigenmappings",i).then(function(a){b.debug("redoing mappingsdiv: ");h.html(a)});var j=a(this).closest(".ml_aigen_item").find(".ml_aigen_filearea_mappings"),k={methodreuse:"reuse"==d,aigenplaceholders:f.splitDataField(j.data("aigenplaceholders")),contextfileareas:f.splitDataField(j.data("contextfileareas")),aigenfileareas:f.splitDataField(j.data("aigenfileareas"))};c.render("mod_minilesson/aigenfilemappings",k).then(function(a){b.debug("redoing fileareadata: ");j.html(a)})})},splitDataField:function splitDataField(a){if(!a||""===a.trim()){return[]}else{return a.split(",").filter(function(a){return""!==a.trim()})}},extractFieldsFromString:function extractFieldsFromString(a){var b=[],c;while(null!==(c=/\{(\w+)\}/g.exec(a))){b.push(c[1])}return _toConsumableArray(new Set(b))},registerAiGenerateAction:function registerAiGenerateAction(a){var b=this,c=document.querySelector(a);if(c){c.addEventListener("submit",function(a){if(a.target.elements.hasOwnProperty("keyname")){a.preventDefault();f.create({type:f.types.SAVE_CANCEL,title:g.get_string("aigenmodaltitle","mod_minilesson"),body:b.callAiGenerateContextFormApi(a.target),large:!0,removeOnClose:!0}).then(function(a){a.getRoot().on("submit "+i.save,function(c){var d=this.querySelector("form");if(d.getAttribute("data-submitted")){return}c.preventDefault();a.setBody(b.callAiGenerateContextFormApi(d).then(function(a,b){if("submitted"===a){d.setAttribute("data-submitted",1);b="<script>document.getElementById(\""+d.getAttribute("id")+"\").submit()</script>"}return[d,b]}))});a.show()})}})}},callAiGenerateContextFormApi:function callAiGenerateContextFormApi(a){return d.loadFragment("mod_minilesson","aigen_contextform",h.contextid,{url:a.getAttribute("action"),params:new URLSearchParams(new FormData(a)).toString()})}}});
//# sourceMappingURL=aigenmake.min.js.map
