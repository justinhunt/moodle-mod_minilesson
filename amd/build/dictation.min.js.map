{"version":3,"file":"dictation.min.js","sources":["../src/dictation.js"],"sourcesContent":["define(['jquery',\n   'core/log',\n   'mod_minilesson/definitions',\n   'core/templates'\n  ], function ($, log, def, templates) {\n    \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n    log.debug('MiniLesson dictation: initialising');\n\n    return {\n\n        playing: false,\n\n      //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        init: function (index, itemdata, quizhelper, polly) {\n            var self = this;\n            self.itemdata = itemdata;\n            self.quizhelper = quizhelper;\n            self.index = index;\n\n            self.prepare_audio(itemdata);\n            self.register_events(index, itemdata, quizhelper);\n            self.getItems();\n        },\n\n        getItems: function () {\n            var self = this;\n            var text_items = self.itemdata.sentences;\n\n            self.items = text_items.map(function (target) {\n                return {\n                    landr_targetWords: target.sentence.trim().split(self.quizhelper.spliton_regexp).filter(function (e) {\n                        return e !== \"\";\n                    }),\n                target: target.sentence,\n                audio: {},\n                audiourl: target.audiourl ? target.audiourl : \"\",\n                imageurl: target.imageurl,\n                correct: false,\n                };\n            }).filter(function (e) {\n                return e.target !== \"\";\n            });\n        },\n\n        prepare_html: function (itemdata) {\n          //do something\n        },\n\n        prepare_audio: function (itemdata) {\n            $.each(itemdata.sentences, function (index, sentence) {\n                $(\"#\" + itemdata.uniqueid + \"_container .dictationplayer_\" + index + \" .dictationtrigger\").attr(\"data-src\", sentence.audiourl);\n            });\n        },\n\n        show_item_review:function () {\n            var self = this;\n          //build review data\n            var review_data = {};\n            review_data.correctitems = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback.fa-check').length;\n            review_data.totalitems = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback').length;\n            var rows = $('#' + self.itemdata.uniqueid + '_container .dictationrow');\n            rows.each(function (index) {\n                self.items[index].audio.src = $(this).find('.dictationtrigger').attr('data-src');\n                self.items[index].correct = $(this).find('.dictate-feedback').hasClass('fa-check');\n            });\n            review_data.items = self.items;\n\n\n          //display results\n            var gamebox = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_dictation_rows\");\n            var resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_dictation_resultscontainer\");\n            templates.render('mod_minilesson/listitemresults',review_data).then(\n                function (html,js) {\n                    resultsbox.html(html);\n                    //show and hide\n                    resultsbox.show();\n                    gamebox.hide();\n                    // Run js for audio player events\n                    templates.runTemplateJS(js);\n                }\n            );// End of templates\n        },\n\n        next_question:function () {\n            var self = this;\n            var stepdata = {};\n            var correct = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback.fa-check').length;\n            var total = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback').length;\n            var grade = Math.round(correct / total, 2) * 100;\n            stepdata.index = self.index;\n            stepdata.hasgrade = true;\n            stepdata.grade = grade;\n            stepdata.totalitems = total;\n            stepdata.correctitems = correct;\n            stepdata.grade = grade;\n            self.quizhelper.do_next(stepdata);\n        },\n\n        register_events: function (qindex, itemdata, quizhelper) {\n\n            var self = this;\n\n            var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\n\n          //key events in text box\n            $(\"#\" + itemdata.uniqueid + \"_container .poodlldictationinput input\").on(\"input\", function (e) {\n\n                var index = $(this).data(\"index\");\n                var correct = itemdata.sentences[index].sentence.trim().toLowerCase();\n                var typed = $(this).val().trim().toLowerCase();\n\n              //update char count\n                $(\"#\" + itemdata.uniqueid + \"_container .dictationplayer_\" + index + \"_chars\").html(typed.length);\n              //trim punctuation before comparing, if ignore punctuation is set\n                if (itemdata.ignorepunctuation) {\n                    correct = quizhelper.cleanText(correct);\n                    typed = quizhelper.cleanText(typed);\n                }\n\n                if (correct == typed) {\n                    $(\"#\" + itemdata.uniqueid + \"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-times\").addClass(\"fa-check\").css(\"color\",\"green\").show();\n                } else {\n                    $(\"#\" + itemdata.uniqueid + \"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-check\").addClass(\"fa-times\").css(\"color\",\"red\").show();\n                }\n\n            });\n\n          //audio play requests\n            $(\"#\" + itemdata.uniqueid + \"_container .dictationtrigger\").on('click', function (e) {\n                if (!self.playing) {\n                    var el = this;\n                    self.playing = true;\n                    theplayer.attr('src', $(this).attr('data-src'));\n                    theplayer[0].play();\n                    theplayer[0].onended = function () {\n                        $(el).find(\".fa\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n                        self.playing = false;\n                    };\n                    $(el).find(\".fa\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\n                }\n            });\n\n          //When click next button , report and leave it up to parent to eal with it.\n            $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function (e) {\n                var dictationcontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_dictation_rows\");\n                if (self.quizhelper.showitemreview && dictationcontainer.is(':visible')) {\n                    self.show_item_review();\n                } else {\n                    self.next_question();\n                }\n            });\n        }\n        }; //end of return value\n  });"],"names":["define","$","log","def","templates","debug","playing","clone","extend","this","init","index","itemdata","quizhelper","polly","prepare_audio","register_events","getItems","self","text_items","sentences","items","map","target","landr_targetWords","sentence","trim","split","spliton_regexp","filter","e","audio","audiourl","imageurl","correct","prepare_html","each","uniqueid","attr","show_item_review","review_data","correctitems","length","totalitems","src","find","hasClass","gamebox","resultsbox","render","then","html","js","show","hide","runTemplateJS","next_question","stepdata","total","grade","Math","round","hasgrade","do_next","qindex","theplayer","on","data","toLowerCase","typed","val","ignorepunctuation","cleanText","removeClass","addClass","css","el","play","onended","dictationcontainer","showitemreview","is"],"mappings":"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"}