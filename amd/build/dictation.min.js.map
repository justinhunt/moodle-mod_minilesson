{"version":3,"file":"dictation.min.js","sources":["../src/dictation.js"],"sourcesContent":["define(['jquery',\n   'core/log',\n   'mod_minilesson/definitions',\n   'mod_minilesson/pollyhelper',\n   'core/templates'\n  ], function($, log, def, polly, templates) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the quiz stage\n   */\n\n  log.debug('MiniLesson dictation: initialising');\n\n  return {\n\n    playing: false,\n\n    //for making multiple instances\n    clone: function () {\n        return $.extend(true, {}, this);\n    },\n\n    init: function(index, itemdata, quizhelper, polly) {\n      var self = this;\n      self.itemdata = itemdata;\n      self.quizhelper = quizhelper;\n      self.index = index;\n\n      self.prepare_audio(itemdata, polly);\n      self.register_events(index, itemdata, quizhelper);\n      self.getItems();\n    },\n\n    getItems: function() {\n      var self = this;\n      var text_items = self.itemdata.sentences;\n\n      self.items = text_items.map(function(target) {\n        return {\n          landr_targetWords: target.sentence.trim().split(self.quizhelper.spliton_regexp).filter(function(e) {\n            return e !== \"\";\n          }),\n          target: target.sentence,\n          audio: {},\n          correct: false,\n        };\n      }).filter(function(e) {\n        return e.target !== \"\";\n      });\n    },\n\n    prepare_html: function(itemdata) {\n      //do something\n    },\n\n    prepare_audio: function(itemdata) {\n      $.each(itemdata.sentences, function(index, sentence) {\n        polly.fetch_polly_url(sentence.prompt, itemdata.voiceoption, itemdata.usevoice).then(function(audiourl) {\n          $(\"#\" + itemdata.uniqueid + \"_container .dictationplayer_\" + index + \" .dictationtrigger\").attr(\"data-src\", audiourl);\n        });\n      });\n    },\n\n    show_item_review:function(){\n      var self=this;\n      //build review data\n      var review_data = {};\n      review_data.correctitems = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback.fa-check').length;\n      review_data.totalitems = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback').length;\n      var rows = $('#' + self.itemdata.uniqueid + '_container .dictationrow');\n      rows.each(function(index){\n        self.items[index].audio.src = $(this).find('.dictationtrigger').attr('data-src');\n        self.items[index].correct = $(this).find('.dictate-feedback').hasClass('fa-check');\n      });\n      review_data.items = self.items;\n\n\n      //display results\n      var gamebox= $(\"#\" + self.itemdata.uniqueid + \"_container .ml_dictation_rows\");\n      var resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_dictation_resultscontainer\");\n      templates.render('mod_minilesson/listitemresults',review_data).then(\n        function(html,js){\n            resultsbox.html(html);\n            //show and hide\n            resultsbox.show();\n            gamebox.hide();\n            // Run js for audio player events\n            templates.runTemplateJS(js);\n        }\n      );// End of templates\n    },\n\n    next_question:function(){\n      var self=this;\n      var stepdata = {};\n      var correct = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback.fa-check').length;\n      var total = $('#' + self.itemdata.uniqueid + '_container .dictate-feedback').length;\n      var grade = Math.round(correct / total, 2) * 100;\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.grade = grade;\n      stepdata.totalitems=total;\n      stepdata.correctitems=correct;\n      stepdata.grade = grade;\n      self.quizhelper.do_next(stepdata);\n    },\n\n    register_events: function(qindex, itemdata, quizhelper) {\n\n      var self = this;\n\n      var theplayer = $(\"#\" + itemdata.uniqueid + \"_player\");\n\n      //key events in text box\n      $(\"#\" + itemdata.uniqueid + \"_container .poodlldictationinput input\").on(\"input\", function(e) {\n\n        var index = $(this).data(\"index\");\n        var correct = itemdata.sentences[index].sentence.trim().toLowerCase();\n        var typed = $(this).val().trim().toLowerCase();\n\n        //update char count\n        $(\"#\"+itemdata.uniqueid+\"_container .dictationplayer_\"+index+\"_chars\").html(typed.length);\n        //trim punctuation before comparing, if ignore punctuation is set\n        if(itemdata.ignorepunctuation){\n            correct = quizhelper.cleanText(correct);\n            typed = quizhelper.cleanText(typed);\n        }\n\n        if (correct == typed) {\n          $(\"#\"+itemdata.uniqueid+\"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-times\").addClass(\"fa-check\").css(\"color\",\"green\").show();\n        } else {\n          $(\"#\"+itemdata.uniqueid+\"_container .dictate-feedback[data-index='\" + index + \"']\").removeClass(\"fa-check\").addClass(\"fa-times\").css(\"color\",\"red\").show();\n        }\n\n      });\n\n      //audio play requests\n      $(\"#\" + itemdata.uniqueid + \"_container .dictationtrigger\").on('click', function(e) {\n        if (!self.playing) {\n          var el = this;\n          self.playing = true;\n          theplayer.attr('src', $(this).attr('data-src'));\n          theplayer[0].play();\n          theplayer[0].onended = function() {\n            $(el).find(\".fa\").removeClass(\"fa-spin fa-spinner\").addClass(\"fa-play\");\n            self.playing = false;\n          };\n          $(el).find(\".fa\").removeClass(\"fa-play\").addClass(\"fa-spin fa-spinner\");\n        }\n      });\n\n      //When click next button , report and leave it up to parent to eal with it.\n      $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\").on('click', function(e) {\n        var dictationcontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_dictation_rows\");\n        if(self.quizhelper.showitemreview && dictationcontainer.is(':visible')){\n          self.show_item_review();\n        }else{\n          self.next_question();\n        }\n      });\n    }\n  }; //end of return value\n});"],"names":["define","$","log","def","polly","templates","debug","playing","clone","extend","this","init","index","itemdata","quizhelper","prepare_audio","register_events","getItems","self","text_items","sentences","items","map","target","landr_targetWords","sentence","trim","split","spliton_regexp","filter","e","audio","correct","prepare_html","each","fetch_polly_url","prompt","voiceoption","usevoice","then","audiourl","uniqueid","attr","show_item_review","review_data","correctitems","length","totalitems","src","find","hasClass","gamebox","resultsbox","render","html","js","show","hide","runTemplateJS","next_question","stepdata","total","grade","Math","round","hasgrade","do_next","qindex","theplayer","on","data","toLowerCase","typed","val","ignorepunctuation","cleanText","removeClass","addClass","css","el","play","onended","dictationcontainer","showitemreview","is"],"mappings":"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"}