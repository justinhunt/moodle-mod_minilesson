define ("mod_minilesson/passagegapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates"],function(a,b,c,d,e,f,g,h){"use strict";b.debug("MiniLesson passage gap fill: initialising");return{clone:function clone(){return a.extend(!0,{hintsused:0},this)},controls:{},gapitems:[],items:[],hintsused:0,init:function init(a,b,c){var d=this;d.itemdata=b;d.quizhelper=c;d.index=a;var e={useanimatecss:c.useanimatecss};f.init(e);d.register_controls();d.register_events();d.getGapItems()},register_controls:function register_controls(){var b=this;b.controls.rootelement=document.querySelector("#".concat(b.itemdata.uniqueid,"_container"));b.controls.audioplayer=a("#"+b.itemdata.uniqueid+"_container .pgapfill_audio_player");b.controls.resultsbox=a("#"+b.itemdata.uniqueid+"_container .passage_gapfill_results_actions");b.controls.finishbtn=a("#"+b.itemdata.uniqueid+"_container .ml_finishbutton");b.controls.hintbtn=a("#"+b.itemdata.uniqueid+"_container .ml_hintbutton");b.controls.nextbtn=a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton")},prepare_audio:function prepare_audio(){var a=this;e.fetch_polly_url(a.itemdata.passagedata.plaintext,a.itemdata.voiceoption,a.itemdata.usevoice).then(function(b){a.controls.audioplayer.attr("src",b)})},next_question:function next_question(){var a=this,b=a.get_stepdata();a.quizhelper.do_next(b)},submit_grade:function submit_grade(){var a=this,b=a.get_stepdata();a.quizhelper.report_step_grade(b)},get_stepdata:function get_stepdata(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));b.penalty=30*a.hintsused;b.grade=Math.max(0,b.grade-b.penalty);return b},show_item_review:function show_item_review(){var a=this,b=a.get_stepdata(),c=a.controls.resultsbox;b.items=a.items;h.render("mod_minilesson/passagegapfillresults",b).then(function(a,b){c.html(a);h.runTemplateJS(b)})},register_events:function register_events(){var a=this;a.controls.nextbtn.on("click",function(){a.next_question()});a.controls.hintbtn.on("click",function(b){b.preventDefault();a.give_hint()});a.controls.finishbtn.on("click",function(b){b.preventDefault();a.check_answer([],!0,!0);a.show_item_review()});a.controls.rootelement.addEventListener("input",function(b){var c=b.target;a.items.forEach(function(b){if(b.inputelement===c){a.check_answer(b,!1)}})})},check_answer:function check_answer(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null,b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:!0,c=2<arguments.length&&arguments[2]!==void 0?arguments[2]:!1,d=this;a=[].concat(a);if(0===a.length){a=d.items}d.items.map(function(a){if(!a.inputelement){return}var e=a.inputelement.parentElement;e.classList.remove("psg_gapfill_wrong","psg_gapfill_correct");a.correct=a.inputelement.value===a.text;if(a.correct){e.classList.add("psg_gapfill_correct")}else if(b){e.classList.add("psg_gapfill_wrong")}if(c){if(d.quizhelper.showitemreview){a.inputelement.value=a.text;e.classList.add("pgapfill_gap_reviewing")}a.inputelement.setAttribute("readonly","readonly")}return a})},give_hint:function give_hint(){var a=this,b=!1;a.items.forEach(function(c){var d=c.inputelement;if(!d){return}if(d.value!==c.text){var e=d.placeholder,f=1===a.hintsused?1:c.placeholder.length-1;d.placeholder=e.slice(0,f)+c.text[f]+e.slice(f+1);d.setAttribute("placeholder",d.placeholder);d.value="";b=!0}d.setAttribute("data-hints",1+a.hintsused)});if(b){a.hintsused++}if(a.hintsused>=parseInt(a.itemdata.hints)){a.controls.hintbtn.remove()}else if(1===a.hintsused&&a.hintsused<parseInt(a.itemdata.hints)){a.controls.hintbtn.text(a.controls.hintbtn.data("alttext"))}},getGapItems:function getGapItems(){b.debug("getting gap items");var a=this,c=a.itemdata.passagedata;a.gapitems=c.words.map(function(a){return{wordindex:a.wordindex,text:a.text,placeholder:a.placeholder,isgap:a.isgap,correct:!1}});a.items=a.gapitems.filter(function(a){return a.isgap}).map(function(b){b.inputelement=a.controls.rootelement.querySelector(".pgapfill_gap_input[data-wordindex=\"".concat(b.wordindex,"\"]"));return b})},appReady:function appReady(){var a=this;a.start()},end:function end(){var b=this;a(".minilesson_nextbutton").prop("disabled",!0);setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);if(b.quizhelper.showitemreview){b.show_item_review()}else{b.next_question()}},2e3)},start:function start(){var a=this;a.controls.question.show()},stopTimer:function stopTimer(a){if(a){clearInterval(a)}}}});
//# sourceMappingURL=passagegapfill.min.js.map
