define("mod_minilesson/passagegapfill",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/animatecss","mod_minilesson/progresstimer","core/templates"],(function($,log,ajax,def,polly,anim,progresstimer,templates){return log.debug("MiniLesson passage gap fill: initialising"),{clone:function(){return $.extend(!0,{hintsused:0},this)},controls:{},gapitems:[],items:[],hintsused:0,init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.register_controls(),this.register_events(),this.getGapItems()},register_controls:function(){this.controls.rootelement=document.querySelector("#".concat(this.itemdata.uniqueid,"_container")),this.controls.audioplayer=$("#"+this.itemdata.uniqueid+"_container .pgapfill_audio_player"),this.controls.resultsbox=$("#"+this.itemdata.uniqueid+"_container .passage_gapfill_results_actions"),this.controls.finishbtn=$("#"+this.itemdata.uniqueid+"_container .ml_finishbutton"),this.controls.hintbtn=$("#"+this.itemdata.uniqueid+"_container .ml_hintbutton"),this.controls.nextbtn=$("#"+this.itemdata.uniqueid+"_container .minilesson_nextbutton")},prepare_audio:function(){var self=this;polly.fetch_polly_url(self.itemdata.passagedata.plaintext,self.itemdata.voiceoption,self.itemdata.usevoice).then((function(audiourl){self.controls.audioplayer.attr("src",audiourl)}))},next_question:function(){var stepdata=this.get_stepdata();this.quizhelper.do_next(stepdata)},submit_grade:function(){var stepdata=this.get_stepdata();this.quizhelper.report_step_grade(stepdata)},get_stepdata:function(){var stepdata={};return stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((e=>e.correct)).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),stepdata.penalty=30*this.hintsused,stepdata.grade=Math.max(0,stepdata.grade-stepdata.penalty),stepdata},show_item_review:function(){var review_data=this.get_stepdata(),resultsbox=this.controls.resultsbox;review_data.items=this.items,templates.render("mod_minilesson/passagegapfillresults",review_data).then((function(html,js){resultsbox.html(html),templates.runTemplateJS(js)}))},register_events:function(){var self=this;self.controls.nextbtn.on("click",(function(){self.next_question()})),self.controls.hintbtn.on("click",(function(e){e.preventDefault(),self.give_hint()})),self.controls.finishbtn.on("click",(function(e){e.preventDefault(),self.check_answer([],!0,!0),self.show_item_review()})),self.controls.rootelement.addEventListener("input",(e=>{const inputelement=e.target;self.items.forEach((item=>{item.inputelement===inputelement&&self.check_answer(item,!1)}))}))},check_answer:function(){let items=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,displaywrong=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],readonly=arguments.length>2&&void 0!==arguments[2]&&arguments[2];var self=this;items=[].concat(items),0===items.length&&(items=self.items),self.items.map((gapitem=>{if(!gapitem.inputelement)return;const gapelement=gapitem.inputelement.parentElement;return gapelement.classList.remove("psg_gapfill_wrong","psg_gapfill_correct"),gapitem.correct=gapitem.inputelement.value===gapitem.text,gapitem.correct?gapelement.classList.add("psg_gapfill_correct"):displaywrong&&gapelement.classList.add("psg_gapfill_wrong"),readonly&&(self.quizhelper.showitemreview&&(gapitem.inputelement.value=gapitem.text,gapelement.classList.add("pgapfill_gap_reviewing")),gapitem.inputelement.setAttribute("readonly","readonly")),gapitem}))},give_hint:function(){var self=this,anyhintdisplayed=!1;self.items.forEach((element=>{const inputelement=element.inputelement;if(inputelement){if(inputelement.value!==element.text){const placeholder=inputelement.placeholder,replaceposition=1===self.hintsused?1:element.placeholder.length-1;inputelement.placeholder=placeholder.slice(0,replaceposition)+element.text[replaceposition]+placeholder.slice(replaceposition+1),inputelement.setAttribute("placeholder",inputelement.placeholder),inputelement.value="",anyhintdisplayed=!0}inputelement.setAttribute("data-hints",1+self.hintsused)}})),anyhintdisplayed&&self.hintsused++,self.hintsused>=parseInt(self.itemdata.hints)?self.controls.hintbtn.remove():1===self.hintsused&&self.hintsused<parseInt(self.itemdata.hints)&&self.controls.hintbtn.text(self.controls.hintbtn.data("alttext"))},getGapItems:function(){log.debug("getting gap items");var self=this,passagedata=self.itemdata.passagedata;self.gapitems=passagedata.chunks.map((target=>({wordindex:target.wordindex,text:target.text,placeholder:target.placeholder,isgap:target.isgap,correct:!1}))),self.items=self.gapitems.filter((gapitem=>gapitem.isgap)).map((item=>(item.inputelement=self.controls.rootelement.querySelector('.pgapfill_gap_input[data-wordindex="'.concat(item.wordindex,'"]')),item)))},appReady:function(){this.start()},end:function(){var self=this;$(".minilesson_nextbutton").prop("disabled",!0),setTimeout((function(){$(".minilesson_nextbutton").prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2e3)},start:function(){this.controls.question.show()},stopTimer:function(timer){timer&&clearInterval(timer)}}}));

//# sourceMappingURL=passagegapfill.min.js.map