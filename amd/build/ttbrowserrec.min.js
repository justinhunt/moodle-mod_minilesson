define(["jquery","core/log","mod_minilesson/ttwavencoder"],(function($,log,wavencoder){return log.debug("mod_minilesson browser speech rec: initialising"),{recognition:null,recognizing:!1,final_transcript:"",interim_transcript:"",start_timestamp:0,lang:"en-US",interval:0,browsertype:"",audioContext:null,processor:null,microphone:null,encoder:null,listener:null,wavconfig:{bufferLen:4096,numChannels:2,desiredSampleRate:48e3,mimeType:"audio/wav"},clone:function(){return $.extend(!0,{},this)},will_work_ok:function(opts){window.self,window.top;var is_mobileapp=!1;navigator.userAgent.indexOf("MoodleMobile")>-1&&(is_mobileapp=!0),void 0!==navigator.brave&&(this.browsertype="brave"),navigator.userAgent.toLowerCase().indexOf("edg/")>-1&&""===this.browsertype&&(this.browsertype="edge");var has_chrome=navigator.userAgent.indexOf("Chrome")>-1,has_safari=navigator.userAgent.indexOf("Safari")>-1,is_ios=navigator.userAgent.indexOf("iPhone")>-1||navigator.userAgent.indexOf("iPad")>-1;has_safari&&!has_chrome&&""===this.browsertype&&(this.browsertype="safari");navigator.userAgent.indexOf("Android");var hasspeechrec="webkitSpeechRecognition"in window||"SpeechRecognition"in window;return hasspeechrec&&""===this.browsertype&&has_chrome&&(this.browsertype="chrome"),(!is_mobileapp||!is_ios)&&("brave"!==this.browsertype&&hasspeechrec)},init:function(lang,waveheight,uniqueid){var SpeechRecognition=SpeechRecognition||webkitSpeechRecognition,is_android=navigator.userAgent.indexOf("Android")>-1;this.recognition=new SpeechRecognition,this.recognition.continuous=!0,this.recognition.interimResults=!is_android,this.lang=lang,this.waveHeight=waveheight,this.uniqueid=uniqueid,this.prepare_html(),this.register_events(),window.AudioContext=window.AudioContext||window.webkitAudioContext},onStop:function(){},prepare_html:function(){this.canvas=$("#"+this.uniqueid+"_waveform"),this.canvasCtx=this.canvas[0].getContext("2d")},set_grammar:function(grammar){var SpeechGrammarList=SpeechGrammarList||webkitSpeechGrammarList;if(SpeechGrammarList){var speechRecognitionList=new SpeechGrammarList;speechRecognitionList.addFromString(grammar,1),this.recognition.grammars=speechRecognitionList}},start:function(){var that=this;if(!this.recognizing){this.recognizing=!0,this.final_transcript="",this.interim_transcript="",this.recognition.lang=this.lang,this.recognition.start(),this.start_timestamp=Date.now(),that.onstart(),this.audioContext=new AudioContext({sampleRate:this.wavconfig.desiredSampleRate}),this.processor=this.audioContext.createScriptProcessor(this.wavconfig.bufferLen,this.wavconfig.numChannels,this.wavconfig.numChannels),this.processor.connect(this.audioContext.destination);navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(stream){that.recognizing?("suspended"===that.audioContext.state&&that.audioContext.resume(),that.tracks=stream.getTracks(),that.microphone=that.audioContext.createMediaStreamSource(stream),that.microphone.connect(that.processor),that.encoder=wavencoder.clone(),that.encoder.init(that.audioContext.sampleRate,that.wavconfig.numChannels),that.processor.onaudioprocess=function(event){var thebuffers=that.getBuffers(event);that.encoder.audioprocess(thebuffers)},that.listener=that.audioContext.createAnalyser(),that.microphone.connect(that.listener),that.listener.fftSize=256,that.bufferLength=that.listener.frequencyBinCount,that.analyserData=new Uint8Array(that.bufferLength),that.interval=setInterval((function(){that.drawWave()}),100)):stream.getTracks().forEach((track=>track.stop()))})).catch((function(error){log.debug(error),that.onerror(error)}))}},stop:function(){var that=this;this.recognizing=!1,this.recognition.stop(),clearInterval(this.interval),null!==this.audioContext&&"closed"!==this.audioContext.state&&this.audioContext.close(),this.processor.disconnect(),this.tracks&&this.tracks.forEach((track=>track.stop())),this.encoder&&this.onStop(this.encoder.finish()),this.canvasCtx.clearRect(0,0,2*this.canvas.width(),2*this.waveHeight),setTimeout((function(){that.onfinalspeechcapture(that.final_transcript)}),1e3),this.onend()},register_events:function(){var recognition=this.recognition,that=this;recognition.onerror=function(event){"no-speech"==event.error&&log.debug("info_no_speech"),"audio-capture"==event.error&&log.debug("info_no_microphone"),"not-allowed"==event.error&&(event.timeStamp-that.start_timestamp<100?log.debug("info_blocked"):log.debug("info_denied")),that.onerror({error:{name:event.error}})},recognition.onend=function(){that.recognizing&&that.recognition.start()},recognition.onresult=function(event){for(var i=event.resultIndex;i<event.results.length;++i)if(event.results[i].isFinal)that.final_transcript+=event.results[i][0].transcript+" ";else{var provisional_transcript=that.final_transcript+event.results[i][0].transcript;if(provisional_transcript.length<that.interim_transcript.length)return;that.interim_transcript=provisional_transcript,that.oninterimspeechcapture(that.interim_transcript)}}},getBuffers:function(event){for(var buffers=[],ch=0;ch<this.wavconfig.numChannels;++ch)buffers[ch]=event.inputBuffer.getChannelData(ch);return buffers},drawWave:function(){var width=2*this.canvas.width();this.listener.getByteTimeDomainData(this.analyserData),this.canvasCtx.fillStyle="#F5F5FE",this.canvasCtx.fillRect(0,0,width,2*this.waveHeight),this.canvasCtx.lineWidth=5,this.canvasCtx.strokeStyle="gray",this.canvasCtx.beginPath();for(var slicewaveWidth=width/this.bufferLength,x=0,i=0;i<this.bufferLength;i++){var y=this.analyserData[i]/128*this.waveHeight;0===i?this.canvasCtx.moveTo(x,y):this.canvasCtx.lineTo(x,y),x+=slicewaveWidth}this.canvasCtx.lineTo(width,this.waveHeight),this.canvasCtx.stroke()},onstart:function(){log.debug("started")},onerror:function(){log.debug("error")},onend:function(){log.debug("end")},onfinalspeechcapture:function(speechtext){log.debug(speechtext)},oninterimspeechcapture:function(speechtext){}}}));

//# sourceMappingURL=ttbrowserrec.min.js.map