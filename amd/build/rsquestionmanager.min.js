define ("mod_minilesson/rsquestionmanager",["jquery","core/log","core/templates","mod_minilesson/definitions","mod_minilesson/modalformhelper","mod_minilesson/modaldeletehelper","mod_minilesson/moveitemhelper","mod_minilesson/modalpreviewhelper","mod_minilesson/duplicateitemhelper","mod_minilesson/datatables","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g,h,i,j,k,l){"use strict";b.debug("RSQuestion manager: initialising");return{cmid:null,controls:null,rowIds:[],init:function init(b){var c=this;c.contextid=b.contextid;c.tableid=b.tableid;c.modaleditform=b.modaleditform;c.cmid=b.cmid;c.wwwroot=b.wwwroot;var d=a("#"+b.lessonitems);c.lessonitems=JSON.parse(d.val());d.remove();c.modalshow();c.register_events();c.process_html();c.collate_rowids();c.hide_useless_arrows()},process_html:function process_html(){this.controls=[];this.controls.questionstable=j.getDataTable(this.tableid);this.controls.questionscontainer=a("#"+d.itemscontainer);this.controls.noquestionscontainer=a("#"+d.noitemscontainer);this.controls.movearrows=a("#"+d.movearrow)},collate_rowids:function collate_rowids(){var a=this;a.rowIds=[];a.controls.questionstable.rows().every(function(b){var c=a.controls.questionstable.cell({row:b,column:1}).data();a.rowIds[c]=b})},hide_useless_arrows:function hide_useless_arrows(){a(".mod_minilesson_item_move").attr("style","");var b=this.controls.questionstable.data().length;if(!b||1>b){return}var c=this.rowIds[b],d=this.controls.questionstable.row(c).node();a(d).find(".mod_minilesson_item_move[data-direction=\"down\"]").attr("style","visibility: hidden;");var e=this.rowIds[1],f=this.controls.questionstable.row(e).node();a(f).find(".mod_minilesson_item_move[data-direction=\"up\"]").attr("style","visibility: hidden;")},renumber_rows:function renumber_rows(a){for(var b=this.controls.questionstable,c=b.data().length,d=a,e;d<c;d++){e=this.rowIds[d+1];b.cell({row:e,column:1}).data(d)}},move_row:function move_row(a,b){var c=this.controls.questionstable,e="#"+d.itemrow+"_"+a,f=c.row(e),g=f.index(),h=parseInt(c.cell({row:g,column:1}).data()),i;if("up"==b){i=h-1}else if("down"==b){i=h+1}if(1>i){return}var j=c.data().length;if(i>j){return}var k=this.rowIds[i],l=c.cell({row:g,column:1}).data(),m=c.cell({row:k,column:1}).data();c.cell({row:g,column:1}).data(m);c.cell({row:k,column:1}).data(l);c.draw(!1);this.collate_rowids()},register_events:function register_events(){var j=this,k=function(b,c){var e="#"+d.itemrow+"_"+c;j.controls.questionstable.cell(a(e+" .c1")).data(decodeURIComponent(b.name))},l=function(b,d){b.id=d;b.name=decodeURIComponent(b.name);b.index=j.controls.questionstable.data().length+1;b.up={key:"t/up",component:"moodle",title:"up"};b.down={key:"t/down",component:"moodle",title:"down"};c.render("mod_minilesson/itemlistitem",b).then(function(b){j.controls.questionstable.row.add(a(b)[0]).page("last").draw(!1);j.collate_rowids();j.hide_useless_arrows()});j.controls.noquestionscontainer.hide();j.controls.questionscontainer.show()};if(j.modaleditform){e.init("."+d.component+"_addlink",j.contextid,l);e.init("."+d.itemrow+"_editlink",j.contextid,k)}else{a(".mod_minilesson_qpanel").on("click","."+d.itemrow+"_editlink",function(){var c=j.wwwroot+"/mod/minilesson/rsquestion/managersquestions.php?id="+j.cmid+"&itemid="+a(this).data("id");b.debug("editurl "+c);window.location.href=c;return!1})}f.init("."+d.itemrow+"_deletelink",j.contextid,"deleteitem",function after_questiondelete(a){b.debug("after question delete");var c=j.controls.questionstable.row("#"+d.itemrow+"_"+a),e=parseInt(c.data()[0]);j.renumber_rows(e);c.remove().draw(!1);j.collate_rowids();j.hide_useless_arrows();var f=j.controls.questionstable.rows().count();if(!f){j.controls.noquestionscontainer.show();j.controls.questionscontainer.hide()}});g.init("."+d.movearrow,j.contextid,function after_questionmove(a,b){j.move_row(a,b);j.hide_useless_arrows()});h.init("."+d.itemrow+"_previewlink",j.contextid,function after_questionpreview(){b.debug("after preview");a("#mod_minilesson_quiz_cont").remove()});i.init("."+d.itemrow+"_duplicatelink",j.contextid,function after_questionduplicate(b){var d=JSON.parse(b),e={};e.id=d.newitemid;e.name=decodeURIComponent(d.newitemname);e.type=d.type;e.icon=d.icon;e.typelabel=decodeURIComponent(d.typelabel);e.index=j.controls.questionstable.data().length+1;e.up={key:"t/up",component:"moodle",title:"up"};e.down={key:"t/down",component:"moodle",title:"down"};c.render("mod_minilesson/itemlistitem",e).then(function(b){j.controls.questionstable.row.add(a(b)[0]).page("last").draw(!1);j.collate_rowids();j.hide_useless_arrows()});j.controls.noquestionscontainer.hide();j.controls.questionscontainer.show()})},modalshow:function modalshow(){var d=this,e={lessonitems:d.lessonitems};a("#additembtn").on("click",function(){k.create({type:k.types.CANCEL,body:c.render("mod_minilesson/lessonitem",e)}).then(function(c){d.modal=c;d.modal.setLarge();d.modal.show();d.modal.getRoot().find(".modal-header, .modal-footer").hide();d.modal.getRoot().addClass("lessonitem-modal");d.modal.getRoot().on(l.shown,function(){c.getRoot().find(".modal-dialog").addClass("modal-dialog-centered")});var f=d.modal.getRoot();f.on("click","a.lessonitem-link",function(a){a.preventDefault();a.stopPropagation();if(a.stopImmediatePropagation){a.stopImmediatePropagation()}var c=this.getAttribute("data-toggletarget"),d=f.find(".lessonitem-description"),e=f.find(".lessonitem-link");if(!c){b.debug("No toggle target specified");return}var g=f.find(c);if(!g){b.debug("No target found for selector "+c);return}if(g.hasClass("show")){b.debug("already visible do nothing ")}else{b.debug("not visible, showing now");d.removeClass("show").trigger("lessonitem:hidden");g.addClass("show").trigger("lessonitem:shown");e.attr("aria-expanded","false");this.setAttribute("aria-expanded","true")}});f.on("click","a.addbtn",function(){var b=a(this);if(b.hasClass("ml_loading")){return}b.addClass("ml_loading");b.html("<i class='icon fa fa-spinner fa-pulse fa-fw ' aria-hidden='true'></i> ")});d.videocontroller(d.modal.getRoot());d.modal.getRoot().on(l.hidden,function(){a(this).find("video").each(function(){this.pause();this.currentTime=0;d.modal.destroy()})});return d.modal})})},videocontroller:function videocontroller(b){a(b).on("shown.bs.collapse lessonitem:shown",".lessonitem-description",function(){var b=a(this).find("video").get(0);if(b){var c=a(b).find("source");if(c.length&&c.attr("data-src")&&!c.attr("src")){c.attr("src",c.attr("data-src"));b.load()}b.play()}});a(b).on("hide.bs.collapse lessonitem:hidden",".lessonitem-description",function(){var b=a(this).find("video").get(0);if(b){b.pause();b.currentTime=0}})}}});
//# sourceMappingURL=rsquestionmanager.min.js.map
