{"version":3,"file":"pollyhelper.min.js","sources":["../src/pollyhelper.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions'], function ($, log, def) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file helps you get Polly URLs at runtime\n     */\n\n    log.debug('Polly helper: initialising');\n\n    return {\n        token:  '',\n        region: '',\n        owner: '',\n        cloudpoodllurl: '',\n\n        init: function (token, region, owner, cloudpoodllurl) {\n            this.token = token;\n            this.region = region;\n            this.owner = owner;\n            this.cloudpoodllurl = cloudpoodllurl;\n        },\n\n        clean_ssml_chars: function (speaktext) {\n            //deal with SSML reserved characters\n            speaktext =  speaktext.replace(/&/g,'&amp;');\n            speaktext = speaktext.replace(/'/g,'&apos;');\n            speaktext = speaktext.replace(/\"/g,'&quot;');\n            speaktext = speaktext.replace(/</g,'&lt;');\n            speaktext =  speaktext.replace(/>/g,'&gt;');\n            return speaktext;\n        },\n\n        can_speak_neural: function (voice,region) {\n            switch (region) {\n                case \"useast1\":\n                case \"tokyo\":\n                case \"sydney\":\n                case \"dublin\":\n                case \"ottawa\":\n                case \"frankfurt\":\n                case \"london\":\n                case \"singapore\":\n                case \"capetown\":\n                    //ok\n                    break;\n                default:\n                    return false;\n            }\n\n            //check if the voice is supported\n            if (def.neural_voices.indexOf(voice) !== -1) {\n                return true;\n            } else {\n                return false;\n            }\n\n        },\n\n        fetch_polly_url: function (speaktext,voiceoption, voice) {\n            var that = this;\n            return new Promise(function (resolve,reject) {\n                //The REST API we are calling\n                var functionname = 'local_cpapi_fetch_polly_url';\n\n                //fetch the Posturl. We need this.\n                //set up our ajax request\n                var xhr = new XMLHttpRequest();\n\n                //set up our handler for the response\n                xhr.onreadystatechange = function (e) {\n                    if (this.readyState === 4) {\n                        if (xhr.status == 200) {\n                            //get a yes or forgetit or tryagain\n                            var payload = xhr.responseText;\n                            var payloadobject = JSON.parse(payload);\n                            if (payloadobject) {\n                                //returnCode > 0  indicates an error\n                                if (payloadobject.returnCode > 0) {\n                                    reject(payloadobject.returnMessage);\n                                    log.debug(payloadobject.returnMessage);\n                                    return false;\n                                    //if all good, then lets do the embed\n                                } else if (payloadobject.returnCode === 0) {\n                                    var pollyurl = payloadobject.returnMessage;\n                                    resolve(pollyurl);\n                                } else {\n                                    reject('Polly Signed URL Request failed:');\n                                    log.debug('Polly Signed URL Request failed:');\n                                    log.debug(payloadobject);\n                                }\n                            } else {\n                                reject('Polly Signed URL Request something bad happened');\n                                log.debug('Polly Signed URL Request something bad happened');\n                            }\n                        } else {\n                            reject('Polly Signed URL Request Not 200 response:' + xhr.status);\n                            log.debug('Polly Signed URL Request Not 200 response:' + xhr.status);\n                        }\n                    }\n                };\n                var texttype = 'ssml';\n\n                switch (parseInt(voiceoption)) {\n                    //slow\n                    case 1:\n                        //fetch slightly slower version of speech\n                        //rate = 'slow' or 'x-slow' or 'medium'\n                        speaktext = that.clean_ssml_chars(speaktext);\n                        speaktext = '<speak><break time=\"1000ms\"></break><prosody rate=\"slow\">' + speaktext + '</prosody></speak>';\n                        break;\n                    //veryslow\n                    case 2:\n                        //fetch slightly slower version of speech\n                        //rate = 'slow' or 'x-slow' or 'medium'\n                        speaktext = that.clean_ssml_chars(speaktext);\n                        speaktext = '<speak><break time=\"1000ms\"></break><prosody rate=\"x-slow\">' + speaktext + '</prosody></speak>';\n                        break;\n                    //ssml\n                    case 3:\n                        speaktext = '<speak>' + speaktext + '</speak>';\n                        break;\n\n                    //normal\n                    case 0:\n                    default:\n                        //fetch slightly slower version of speech\n                        //rate = 'slow' or 'x-slow' or 'medium'\n                        speaktext = that.clean_ssml_chars(speaktext);\n                        speaktext = '<speak><break time=\"1000ms\"></break>' + speaktext + '</speak>';\n                        break;\n                }\n\n                //to use the neural or standard synthesis engine\n                var engine = that.can_speak_neural(voice,that.region) ? 'neural' : 'standard';\n\n                //log.debug(params);\n                var xhrparams = \"wstoken=\" + that.token\n                + \"&wsfunction=\" + functionname\n                + \"&moodlewsrestformat=\" + 'json'\n                + \"&text=\" + encodeURIComponent(speaktext)\n                + '&texttype=' + texttype\n                + '&voice=' + voice\n                + '&appid=' + def.component\n                + '&owner=' + that.owner\n                + '&region=' + that.region\n                + '&engine=' + engine;\n\n                var serverurl = that.cloudpoodllurl + \"/webservice/rest/server.php\";\n                xhr.open(\"POST\", serverurl, true);\n                xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n                xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n                xhr.send(xhrparams);\n            });\n        }\n\n    };//end of return value\n});\n"],"names":["define","$","log","def","debug","token","region","owner","cloudpoodllurl","init","clean_ssml_chars","speaktext","replace","can_speak_neural","voice","neural_voices","indexOf","fetch_polly_url","voiceoption","that","this","Promise","resolve","reject","xhr","XMLHttpRequest","onreadystatechange","e","readyState","status","payload","responseText","payloadobject","JSON","parse","returnCode","returnMessage","pollyurl","parseInt","engine","xhrparams","encodeURIComponent","component","serverurl","open","setRequestHeader","send"],"mappings":"AAAAA,oCAAO,CAAC,SAAU,WAAY,+BAA+B,SAAUC,EAAGC,IAAKC,YAM3ED,IAAIE,MAAM,8BAEH,CACHC,MAAQ,GACRC,OAAQ,GACRC,MAAO,GACPC,eAAgB,GAEhBC,KAAM,SAAUJ,MAAOC,OAAQC,MAAOC,qBAC7BH,MAAQA,WACRC,OAASA,YACTC,MAAQA,WACRC,eAAiBA,gBAG1BE,iBAAkB,SAAUC,kBAMxBA,WADAA,WADAA,WADAA,WADAA,UAAaA,UAAUC,QAAQ,KAAK,UACdA,QAAQ,KAAK,WACbA,QAAQ,KAAK,WACbA,QAAQ,KAAK,SACZA,QAAQ,KAAK,SAIxCC,iBAAkB,SAAUC,MAAMR,eACtBA,YACC,cACA,YACA,aACA,aACA,aACA,gBACA,aACA,gBACA,gCAIM,SAI2B,IAAtCH,IAAIY,cAAcC,QAAQF,QAQlCG,gBAAiB,SAAUN,UAAUO,YAAaJ,WAC1CK,KAAOC,YACJ,IAAIC,SAAQ,SAAUC,QAAQC,YAM7BC,IAAM,IAAIC,eAGdD,IAAIE,mBAAqB,SAAUC,MACP,IAApBP,KAAKQ,cACa,KAAdJ,IAAIK,OAAe,KAEfC,QAAUN,IAAIO,aACdC,cAAgBC,KAAKC,MAAMJ,YAC3BE,cAAe,IAEXA,cAAcG,WAAa,SAC3BZ,OAAOS,cAAcI,eACrBlC,IAAIE,MAAM4B,cAAcI,gBACjB,EAEJ,GAAiC,IAA7BJ,cAAcG,WAAkB,KACnCE,SAAWL,cAAcI,cAC7Bd,QAAQe,eAERd,OAAO,oCACPrB,IAAIE,MAAM,oCACVF,IAAIE,MAAM4B,oBAGdT,OAAO,mDACPrB,IAAIE,MAAM,wDAGdmB,OAAO,6CAA+CC,IAAIK,QAC1D3B,IAAIE,MAAM,6CAA+CoB,IAAIK,gBAMjES,SAASpB,mBAER,EAIDP,UAAY,6DADZA,UAAYQ,KAAKT,iBAAiBC,YACoD,gCAGrF,EAIDA,UAAY,+DADZA,UAAYQ,KAAKT,iBAAiBC,YACsD,gCAGvF,EACDA,UAAY,UAAYA,UAAY,yBASpCA,UAAY,wCADZA,UAAYQ,KAAKT,iBAAiBC,YAC+B,eAKrE4B,OAASpB,KAAKN,iBAAiBC,MAAMK,KAAKb,QAAU,SAAW,WAG/DkC,UAAY,WAAarB,KAAKd,MAAlB,wEAGHoC,mBAAmB9B,WAHhB,wBAKFG,MACZ,UAAYX,IAAIuC,UAChB,UAAYvB,KAAKZ,MACjB,WAAaY,KAAKb,OAClB,WAAaiC,OAEXI,UAAYxB,KAAKX,eAAiB,8BACtCgB,IAAIoB,KAAK,OAAQD,WAAW,GAC5BnB,IAAIqB,iBAAiB,gBAAiB,YACtCrB,IAAIqB,iBAAiB,eAAgB,qCACrCrB,IAAIsB,KAAKN"}