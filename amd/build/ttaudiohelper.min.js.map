{"version":3,"sources":["../src/ttaudiohelper.js"],"names":["define","$","log","wavencoder","audiostreamer","debug","encodingconfig","streamer","encoder","microphone","isRecording","audioContext","processor","uniqueid","alreadyhadsound","silencecount","silenceintervals","silencelevel","enablesilencedetection","wavconfig","bufferLen","numChannels","desiredSampleRate","mimeType","streamingconfig","clone","extend","init","waveHeight","therecorder","region","is_streaming","prepare_html","window","AudioContext","webkitAudioContext","onStop","onStream","onSocketReady","onError","onfinalspeechcapture","oninterimspeechcapture","canvas","canvasCtx","getContext","start","that","sampleRate","createScriptProcessor","connect","destination","navigator","audioSession","type","console","mediaDevices","getUserMedia","audio","video","then","gotStreamMethod","stream","tracks","getTracks","i","track","length","kind","settings","getSettings","noiseSuppression","echoCancellation","createMediaStreamSource","speechtoken","onaudioprocess","event","thebuffers","getBuffers","audioprocess","listener","createAnalyser","fftSize","bufferLength","frequencyBinCount","analyserData","Uint8Array","volumeData","clearRect","width","interval","setInterval","drawWave","detectSilence","catch","stop","clearInterval","update_audio","setTimeout","state","close","disconnect","forEach","finish","buffers","ch","inputBuffer","getChannelData","getByteFrequencyData","sum","vindex","volume","Math","sqrt","silence_detected","getByteTimeDomainData","fillStyle","fillRect","lineWidth","strokeStyle","beginPath","slicewaveWidth","x","v","y","lineTo","stroke"],"mappings":"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","sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/ttwavencoder', 'mod_minilesson/ttstreamer'],\n    function ($, log, wavencoder, audiostreamer) {\n    \"use strict\"; // jshint ;_;\n    /*\n    This file is the engine that drives audio rec and canvas drawing. TT Recorder is the just the glory kid\n     */\n\n    log.debug('TT Audio Helper initialising');\n\n    return {\n        encodingconfig: null,\n        streamer: null,\n        encoder: null,\n        microphone: null,\n        isRecording: false,\n        audioContext: null,\n        processor: null,\n        uniqueid: null,\n        alreadyhadsound: false, //only start silence detection after we got a sound. Silence detection is end of speech.\n        silencecount: 0, //how many intervals of consecutive silence so far\n        silenceintervals: 15, //how many consecutive silence intervals (100ms) = silence detected\n        silencelevel: 25, //below this volume level = silence\n        enablesilencedetection: true,\n\n        // wav config for encoding to wav\n        wavconfig: {\n            bufferLen: 4096,\n            numChannels: 2,\n            desiredSampleRate: 48000,\n            mimeType: 'audio/wav'\n        },\n        //streaming config for encoding to pcm and later base64\n        // TO DO: wav config might work just as well. test.\n        streamingconfig: {\n            bufferLen: 4096,\n            numChannels: 1,\n            desiredSampleRate: 16000,\n            mimeType: 'audio/wav'\n        },\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n\n        init: function(waveHeight, uniqueid, therecorder) {\n\n            this.waveHeight = waveHeight;\n            this.uniqueid=uniqueid;\n            this.therecorder= therecorder;\n            this.region = therecorder.region;\n            if(this.therecorder.is_streaming){\n                this.encodingconfig = this.streamingconfig;\n            } else {\n                this.encodingconfig = this.wavconfig;\n            }\n            this.prepare_html();\n            window.AudioContext = window.AudioContext || window.webkitAudioContext;\n        },\n\n        onStop: function() {},\n        onStream: function() {},\n        onSocketReady: function() {},\n        onError: function() {},\n        onfinalspeechcapture: function (speechtext) {},\n        oninterimspeechcapture: function (speechtext) {},\n\n\n        prepare_html: function(){\n            this.canvas =$('#' + this.uniqueid + \"_waveform\");\n            this.canvasCtx = this.canvas[0].getContext(\"2d\");\n        },\n\n        start: function() {\n\n            var that =this;\n\n            // Audio context\n            this.audioContext = new AudioContext(\n                {\n                    sampleRate: this.encodingconfig.desiredSampleRate\n                });\n\n            this.processor = this.audioContext.createScriptProcessor(\n                this.encodingconfig.bufferLen,\n                this.encodingconfig.numChannels,\n                this.encodingconfig.numChannels);\n\n            this.processor.connect(this.audioContext.destination);\n\n\n            var gotStreamMethod= function(stream) {\n\n                that.isRecording = true;\n                that.tracks = stream.getTracks();\n\n                //lets check the noise suppression and echo reduction on these\n                for(var i=0; i<that.tracks.length; i++){\n                    var track = that.tracks[i];\n                    if(track.kind == \"audio\"){\n                        var settings = track.getSettings();\n                        if(settings.noiseSuppression){\n                            log.debug(\"Noise Suppression is on\");\n                        }else{\n                            log.debug(\"Noise Suppression is off\");\n                        }\n                        if(settings.echoCancellation){\n                            log.debug(\"Echo Cancellation is on\");\n                        }else{\n                            log.debug(\"Echo Cancellation is off\");\n                        }\n                    }\n                }\n\n                // Create a MediaStreamAudioSourceNode for the microphone\n                that.microphone = that.audioContext.createMediaStreamSource(stream);\n\n                // Connect the AudioBufferSourceNode to the gainNode\n                that.microphone.connect(that.processor);\n\n                //if we have a streaming transcriber we need to initialize it\n                if(that.therecorder.is_streaming){\n                    that.streamer = audiostreamer.clone();\n                    that.streamer.init(that.therecorder.speechtoken, that);\n                    that.enablesilencedetection = false;\n                }\n                //Alert TT recorder that we are ready to go (it will do visuals and manage state of recorder)\n                that.onStream(stream);\n\n                // Init WAV encoder\n                that.encoder = wavencoder.clone();\n                that.encoder.init(that.audioContext.sampleRate, that.encodingconfig.numChannels);\n\n                // Give the node a function to process audio events\n                that.processor.onaudioprocess = function(event) {\n                    var thebuffers = that.getBuffers(event);\n                    that.encoder.audioprocess(thebuffers);\n                    if(that.streamer){\n                        that.streamer.audioprocess(thebuffers);\n                    }\n                };\n\n                that.listener = that.audioContext.createAnalyser();\n                that.microphone.connect(that.listener);\n                that.listener.fftSize = 2048; // 256\n\n                that.bufferLength = that.listener.frequencyBinCount;\n                that.analyserData = new Uint8Array(that.bufferLength);\n                that.volumeData = new Uint8Array(that.bufferLength);\n\n                //reset canvas and silence detection\n                that.canvasCtx.clearRect(0, 0, that.canvas.width()*2, that.waveHeight*2);\n                that.alreadyhadsound= false;\n                that.silencecount= 0;\n\n                that.interval = setInterval(function() {\n                    that.drawWave();\n                    that.detectSilence();\n                }, 100);\n\n            };\n\n            //for ios we need to do this to keep playback volume high\n            if (\"audioSession\" in navigator) {\n                navigator.audioSession.type = 'play-and-record';\n                console.log(\"AudioSession API is supported\");\n            }\n\n            // Mic permission\n            navigator.mediaDevices.getUserMedia({\n                audio: true,\n                video: false\n            }).then(gotStreamMethod).catch(this.onError);\n        },\n\n        stop: function() {\n            var that = this;\n            clearInterval(this.interval);\n            this.canvasCtx.clearRect(0, 0, this.canvas.width()*2, this.waveHeight * 2);\n            this.isRecording = false;\n            this.silencecount=0;\n            this.alreadyhadsound=false;\n            this.therecorder.update_audio('isRecording',false);\n            //we set a timeout to allow the audiocontext buffer to fill up since we can't flush it\n            //if we don't we may miss 1s of audio at the end\n            setTimeout(function() {\n                //we check audiocontext is not in an odd state before closing\n                //superclickers can get it in an odd state\n                if (that.audioContext!==null && that.audioContext.state !== \"closed\") {\n                    that.audioContext.close();\n                }\n                that.processor.disconnect();\n                that.tracks.forEach(track => track.stop());\n                that.onStop(that.encoder.finish());\n                if(that.streamer){\n                    that.streamer.finish();\n                }\n            },1000);\n\n        },\n\n        getBuffers: function(event) {\n            var buffers = [];\n            for (var ch = 0; ch < this.encodingconfig.numChannels; ++ch) {\n                buffers[ch] = event.inputBuffer.getChannelData(ch);\n            }\n            return buffers;\n        },\n\n        detectSilence: function () {\n\n            if(!this.enablesilencedetection){return;}\n\n            this.listener.getByteFrequencyData(this.volumeData);\n\n            let sum = 0;\n            for (var vindex =0; vindex <this.volumeData.length;vindex++) {\n                sum += this.volumeData[vindex] * this.volumeData[vindex];\n            }\n\n            var volume = Math.sqrt(sum / this.volumeData.length);\n           // log.debug(\"volume: \" + volume + ', hadsound: ' + this.alreadyhadsound);\n            //if we already had a sound, we are looking for end of speech\n            if(volume < this.silencelevel && this.alreadyhadsound){\n                this.silencecount++;\n                if(this.silencecount>=this.silenceintervals){\n                    this.therecorder.silence_detected();\n                }\n            //if we have a sound, reset silence count to zero, and flag that we have started\n            }else if(volume > this.silencelevel){\n                this.alreadyhadsound = true;\n                this.silencecount=0;\n            }\n        },\n\n        drawWave: function() {\n\n            var width = this.canvas.width() * 2;\n            this.listener.getByteTimeDomainData(this.analyserData);\n\n            this.canvasCtx.fillStyle = '#F5F5FE';\n            this.canvasCtx.fillRect(0, 0, width, this.waveHeight*2);\n\n            this.canvasCtx.lineWidth = 5;\n            this.canvasCtx.strokeStyle = 'gray';\n            this.canvasCtx.beginPath();\n\n            var slicewaveWidth = width / this.bufferLength;\n            var x = 0;\n\n            for (var i = 0; i < this.bufferLength; i++) {\n\n                var v = this.analyserData[i] / 128.0;\n                var y = v * this.waveHeight;\n\n                if (i === 0) {\n                    // this.canvasCtx.moveTo(x, y);\n                } else {\n                    this.canvasCtx.lineTo(x, y);\n                }\n\n                x += slicewaveWidth;\n            }\n\n            this.canvasCtx.lineTo(width, this.waveHeight);\n            this.canvasCtx.stroke();\n\n        }\n    }; //end of this declaration\n\n\n});"],"file":"ttaudiohelper.min.js"}