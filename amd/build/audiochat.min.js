function _createForOfIteratorHelper(a){if("undefined"==typeof Symbol||null==a[Symbol.iterator]){if(Array.isArray(a)||(a=_unsupportedIterableToArray(a))){var b=0,c=function(){};return{s:c,n:function n(){if(b>=a.length)return{done:!0};return{done:!1,value:a[b++]}},e:function e(a){throw a},f:c}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var d,e=!0,f=!1,g;return{s:function s(){d=a[Symbol.iterator]()},n:function n(){var a=d.next();e=a.done;return a},e:function e(a){f=!0;g=a},f:function f(){try{if(!e&&null!=d.return)d.return()}finally{if(f)throw g}}}}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("mod_minilesson/audiochat",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/ttrecorder","core/templates","core/str","core/fragment"],function(a,b,c,d,e,f,g){"use strict";b.debug("MiniLesson AudioChat: initialising");return{autocreateresponse:!1,gradingrequesttag:"gradingrequest",gradingData:!1,strings:{},controls:{},itemdata:{},index:0,quizhelper:{},pc:null,dc:null,cantChat:!1,audiochat_voice:"alloy",isSessionStarted:!1,isSessionStopped:!1,isSessionActive:!1,isLoading:!1,isMicActive:!1,isMicInitialized:!1,loadingMessages:new Set,audioContext:null,analyser:null,dataArray:null,sourceNode:null,mediaStream:null,animationFrameId:null,canvasCtx:null,eventlogs:[],items:{},responses:{},abortcontroller:new AbortController,datainputbuffer:!1,inputBufferInterval:null,semantic_vad:{type:"semantic_vad",eagerness:"low"},timebased_vad:{type:"server_vad",silence_duration_ms:3500,create_response:!0,interrupt_response:!0,threshold:.3},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){this.itemdata=c;this.autocreateresponse=c.audiochat_autoresponse||!1;b.debug("itemdata",c);this.quizhelper=d;this.index=a;this.cantChat=!c.canchat;this.init_strings();this.init_controls(d,c);this.init_voice(c.audiochat_voice);this.register_events(a,c,d);this.renderUI()},init_strings:function init_strings(){var a=this;f.get_strings([{key:"gradebywordcount",component:"mod_minilesson"}]).done(function(b){var c=0;a.strings.gradebywordcount=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.lessonitemid=a.itemdata.id;b.totalitems=a.itemdata.totalmarks;b.resultsdata={items:Object.values(a.items)};b=a.grade_activity(b);b.correctitems=Math.round(a.itemdata.totalmarks*b.grade/100);a.quizhelper.do_next(b)},count_words:function count_words(){var a=this,b=[];Object.values(a.items).forEach(function(a){if(a.content){b.push(a.content)}});var c=b.join(" ").split(/\s+/).length;return c},toggle_autocreate_response:function toggle_autocreate_response(){var a=this;a.autocreateresponse=!a.autocreateresponse;a.timebased_vad.create_response=a.autocreateresponse;b.debug("Autocreate response toggled:",a.autocreateresponse);a.dc.send(JSON.stringify({type:"session.update",session:{turn_detection:a.timebased_vad}}))},grade_activity:function grade_activity(a){var c=this,d=c.count_words();if(c.gradingData&&c.gradingData.score!==void 0){b.debug("Using grading data from AI:",c.gradingData);a.grade=c.gradingData.score;if("number"==typeof a.grade&&"number"==typeof d&&0<c.itemdata.targetwordcount&&d<c.itemdata.targetwordcount){a.grade=Math.round(a.grade*(d/c.itemdata.targetwordcount))}a.resultsdata.aifeedback=c.gradingData.feedback||"";a.resultsdata.gradeexplanation=c.gradingData.gradeexplanation||""}else{b.debug("No grading data from AI: counting words",c.gradingData);a.resultsdata.gradeexplanation=c.strings.gradebywordcount;if(!1===c.itemdata.countwords||0===c.itemdata.targetwordcount){a.grade=100}a.grade=100*Math.min(d/c.itemdata.targetwordcount,1)}return a},register_events:function register_events(c,d){var e=this;e.controls.startSessionBtn.addEventListener("click",e.startSession.bind(this));e.controls.stopSessionBtn.addEventListener("click",e.stopSession.bind(this));e.controls.retrySessionBtn.addEventListener("click",e.resetSession.bind(this));e.controls.autocreateresponseCheckbox.addEventListener("change",e.toggle_autocreate_response.bind(e));e.controls.cancelStartSessionBtn.addEventListener("click",function(){b.debug("Cancelling session start");e.abortcontroller.abort();e.abortcontroller=new AbortController});a(e.controls.nextbutton).on("click",function(){e.next_question()});var f=a(e.controls.container);f.on("showElement",function(){if(0<d.timelimit){f.find(".progress-container").show();f.find(".progress-container i").show();f.find(".progress-container #progresstimer").progressTimer({height:"5px",timeLimit:d.timelimit,onFinish:function onFinish(){e.controls.nextbutton.trigger("click")}})}});if(e.controls.toggleMicBtn){e.controls.toggleMicBtn.addEventListener("click",e.toggleMute.bind(e))}},init_voice:function init_voice(a){var c=this;if(a&&["alloy","ash","ballad","coral","echo","sage","shimmer","verse","marin","cedar"].includes(a)){c.audiochat_voice=a}else{c.audiochat_voice="alloy"}b.debug("AudioChat voice set to:",this.audiochat_voice)},init_controls:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b=this;c=document.getElementById(b.itemdata.uniqueid+"_container");b.controls={hiddenaudio:c.querySelector(".ml_ac_hiddenaudio"),nextbutton:c.querySelector(".minilesson_nextbutton"),cantChatWarning:c.querySelector(".ml_ac_cantchat"),startSessionBtn:c.querySelector(".ml_ac_start-session-btn"),stopSessionBtn:c.querySelector(".ml_ac_stop-session-btn"),loadingIndicator:c.querySelector(".ml_ac_loading-indicator"),aiAvatarSection:c.querySelector(".ml_ac_ai-avatar-section"),chatActiveMessage:c.querySelector(".ml_ac_chat-active-message"),conversationSection:c.querySelector(".ml_ac_conversation-section"),messagesContainer:c.querySelector(".ml_ac_messages-container"),micButtonContainer:c.querySelector(".mic-button-container"),toggleMicBtn:c.querySelector(".toggle-mic-btn"),micIcon:c.querySelector(".mic-icon"),micWaveformCanvas:c.querySelector(".mic-waveform-canvas"),micSelect:c.querySelector(".ml_ac_micselect"),finishMessage:c.querySelector(".ml_ac_finished-message"),retrySessionBtn:c.querySelector(".ml_ac_retrybtn"),cancelStartSessionBtn:c.querySelector(".ml_ac_cancel-start-session-btn"),autocreateresponseCheckbox:c.querySelector(".ml_ac_autoresponse-checkbox"),resultscontainer:c.querySelector(".ml_ac_results_container"),resultscontent:c.querySelector(".ml_ac_results_content"),autocreateresponseToggle:c.querySelector(".ml_ac_autoresponse-toggle"),clicktosendlabel:c.querySelector(".ml_ac_clicktosend"),mainWrapper:c.querySelector(".minilesson_audiochat_box .ml_unique_mainwrapper")};b.canvasCtx=!b.controls.micWaveformCanvas?null:b.controls.micWaveformCanvas.getContext("2d");a.next=6;return b.populateMicList();case 6:case"end":return a.stop();}}},a,this)}));return function init_controls(){return a.apply(this,arguments)}}(),scrollToBottom:function scrollToBottom(){var a=this;a.controls.conversationSection.firstElementChild.scrollIntoViewIfNeeded();a.controls.conversationSection.firstElementChild.scrollTop=a.controls.conversationSection.firstElementChild.scrollHeight},scrollMicButtonIntoView:function scrollMicButtonIntoView(){var a=this;if(a.controls.micButtonContainer){a.controls.micButtonContainer.scrollIntoView({behavior:"smooth",block:"center"})}},renderUI:function renderUI(){var a=this;a.controls.startSessionBtn.classList.toggle("hidden",a.isSessionActive||a.isLoading||a.isSessionStarted||a.cantChat);a.controls.cantChatWarning.classList.toggle("hidden",!a.cantChat);a.controls.loadingIndicator.classList.toggle("hidden",!a.isLoading);a.controls.stopSessionBtn.classList.toggle("hidden",!a.isSessionActive);a.controls.micButtonContainer.classList.toggle("hidden",!a.isSessionActive);var b=a.isSessionStarted&&a.isSessionStopped;a.controls.resultscontainer.classList.toggle("hidden",!b&&a.quizhelper.showitemreview);a.controls.finishMessage.classList.toggle("hidden",!b);a.controls.retrySessionBtn.classList.toggle("hidden",!b&&a.itemdata.allowretry);a.controls.autocreateresponseToggle.classList.toggle("hidden",!a.isSessionActive);if(a.controls.micSelect){var c=a.controls.micSelect.querySelectorAll("option"),d=2>c.length;a.controls.micSelect.parentElement.classList.toggle("hidden",d||a.isSessionStarted||a.isLoading||a.controls.micSelect.disabled)}var e=[],f=new Map,g=new Map,h;Object.values(a.items).forEach(function(a){f.set(a.id,a);g.set(a.previous_item_id,a);if(null===a.previous_item_id){h=a}});while(h){e.push(h);h=g.get(h.id)}a.controls.aiAvatarSection.classList.toggle("hidden",a.isSessionStarted||a.isSessionActive||a.isSessionStopped);a.controls.chatActiveMessage.classList.toggle("hidden",!a.isSessionActive);a.controls.conversationSection.classList.toggle("hidden",!(a.isSessionActive||a.isSessionStopped));a.controls.messagesContainer.innerHTML="";e.forEach(function(b){if(!b.content){return}var c=document.createElement("div");c.className="flex ".concat("user"===b.usertype?"justify-end":"justify-start"," ml_unique_ordered_message_").concat("user"===b.usertype?"user":"assistant");var d=document.createElement("div");d.className="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ".concat("user"===b.usertype?"bg-blue-500 text-white":"bg-gray-200 text-gray-800"," ml_unique_content_").concat("user"===b.usertype?"user":"assistant");var e=document.createElement("div");e.className="flex items-center text-xs font-medium mb-1 ml_unique_headerdiv";if("assistant"===b.usertype){var f=document.createElement("div");f.innerHTML="\n                            <img src=\"".concat(a.itemdata.avatarimage,"?themerev=").concat(M.cfg.themerev,"\"\n                            alt=\"AI Assistant\" class=\"mr-2 rounded-circle shadow-lg ml_unique_assistant_img\">\n                            ");e.appendChild(f)}e.innerHTML+="user"===b.usertype?"Student":"AI Assistant";d.appendChild(e);var g=document.createElement("div");g.className="text-sm ml_unique_textsmall";g.textContent=b.content;d.appendChild(g);if(a.loadingMessages.has(b.id)){var h=document.createElement("div");h.className="flex items-center space-x-1 py-1 message-loader ml_unique_loadingmessage";h.innerHTML="\n                            <div class=\"flex space-x-1 ml_unique_loader\">\n                                <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                                <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                                <div class=\"w-2 h-2 bg-current rounded-full ml_unique_loader_dot\"></div>\n                            </div>\n                            <span class=\"text-xs opacity-70 ml_unique_loader_text\">AI is thinking...</span>\n                        ";d.appendChild(h)}c.appendChild(d);a.controls.messagesContainer.appendChild(c)});a.scrollToBottom();if(a.controls.micButtonContainer){a.controls.micButtonContainer.classList.toggle("active",a.isMicActive);a.controls.micButtonContainer.classList.toggle("bg-blue-500",a.isMicActive);a.controls.micButtonContainer.classList.toggle("text-white",a.isMicActive);a.controls.micButtonContainer.classList.toggle("bg-gray-200",!a.isMicActive);a.controls.micButtonContainer.classList.toggle("text-gray-800",!a.isMicActive)}if(a.controls.micWaveformCanvas){a.controls.micWaveformCanvas.classList.toggle("active",a.isMicActive)}if(a.controls.micIcon){a.controls.micIcon.innerHTML=a.isMicActive?"<rect id=\"primary\" x=\"2\" y=\"2\" width=\"20\" height=\"20\" rx=\"2\" style=\"fill: rgb(0, 0, 0);\"></rect>":"<path id=\"secondary\" d=\"M12,15h0a4,4,0,0,1-4-4V7a4,4,0,0,1,4-4h0a4,4,0,0,1,4,4v4A4,4,0,0,1,12,15Z\" style=\"fill: rgb(44, 169, 188); stroke-width: 2;\"></path><path id=\"primary\" d=\"M18.24,16A8,8,0,0,1,5.76,16\" style=\"fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;\"></path><path id=\"primary-2\" data-name=\"primary\" d=\"M12,19v2m4-10V7a4,4,0,0,0-4-4h0A4,4,0,0,0,8,7v4a4,4,0,0,0,4,4h0A4,4,0,0,0,16,11Z\" style=\"fill: none; stroke: rgb(0, 0, 0); stroke-linecap: round; stroke-linejoin: round; stroke-width: 2;\"></path>"}if(a.isMicActive&&!a.autocreateresponse){a.controls.clicktosendlabel.classList.remove("hidden")}else{a.controls.clicktosendlabel.classList.add("hidden")}},setDataInputBuffer:function setDataInputBuffer(a,c){var d=this;d.datainputbuffer=a;b.debug("Data in input buffer set to:",a);b.debug("Data input buffer set source:",c)},resetSession:function resetSession(){b.debug("reset  session");var a=this;a.isLoading=!1;a.isSessionActive=!1;a.isSessionStopped=!1;a.isSessionStarted=!1;a.renderUI()},startSession:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var c,d,e,f,h,i;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=this;d=c.itemdata.language.substr(0,2);e=c.controls.hiddenaudio;b.debug("Session starting");c.isLoading=!0;c.items=[];c.renderUI();b.debug("Opening peer connection...");c.pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});b.debug("creating data channel...");c.dc=c.pc.createDataChannel("oai-events");c.dc.onmessage=function(a){c.eventlogs.push(a.data);try{var d=a.data.split("\n").filter(Boolean),e=_createForOfIteratorHelper(d),f;try{for(e.s();!(f=e.n()).done;){var g=f.value;c.handleRTCEvent.call(c,JSON.parse(g))}}catch(a){e.e(a)}finally{e.f()}}catch(a){b.debug("Failed to parse");b.debug(a)}};c.dc.onopen=function(){b.debug("DataChannel open");c.timebased_vad.create_response=c.autocreateresponse;b.debug(c.itemdata.audiochatinstructions);var a=c.itemdata.audiochatinstructions;g.loadFragment("mod_minilesson","audiochat_fetchstudentsubmission",M.cfg.contextid,{itemid:c.itemdata.id}).done(function(e){b.debug("Loaded audio chat studentsubmission:",e);if(e){a=a.replace("{student submission}",e);c.itemdata.audiochatgradeinstructions=c.itemdata.audiochatgradeinstructions.replace("{student submission}",e);c.itemdata.studentsubmission=e}c.sendEvent({type:"session.update",session:{type:"realtime",instructions:a,audio:{input:{transcription:{language:d,model:"whisper-1"},turn_detection:c.timebased_vad},output:{speed:.9,voice:c.audiochat_voice}},output_modalities:["audio"]}});c.sendEvent({type:"response.create",response:{output_modalities:["audio"],instructions:a+" "+"Please introduce yourself to the student and explain todays topic.",audio:{output:{voice:c.audiochat_voice}}}})})};c.pc.ontrack=function(a){e.srcObject=a.streams[0]};a.next=16;return navigator.mediaDevices.getUserMedia({audio:!0});case 16:c.mediaStream=a.sent;c.mediaStream.getTracks().forEach(function(a){a.enabled=!1;c.pc.addTrack(a,c.mediaStream)});a.next=20;return c.pc.createOffer({offerToReceiveAudio:!0});case 20:f=a.sent;a.next=23;return c.pc.setLocalDescription(f);case 23:a.next=25;return c.waitForIceGathering(c.pc);case 25:a.prev=25;a.next=28;return fetch(M.cfg.wwwroot+"/mod/minilesson/openairtc.php",{method:"POST",headers:{"Content-Type":"application/sdp"},body:c.pc.localDescription.sdp,signal:c.abortcontroller.signal});case 28:h=a.sent;if(h.ok){a.next=36;break}a.t0=b;a.next=33;return h.text();case 33:a.t1=a.sent;a.t0.debug.call(a.t0,"Failed /rtc:",a.t1);return a.abrupt("return");case 36:b.debug("Received SDP answer from server");a.next=39;return h.text();case 39:i=a.sent;b.debug(i);a.next=43;return c.pc.setRemoteDescription({type:"answer",sdp:i});case 43:b.debug("Session started");a.next=60;break;case 46:a.prev=46;a.t2=a["catch"](25);b.debug(a.t2,"connect error");if(!("AbortError"===a.t2.name)){a.next=54;break}b.debug("Session start aborted by user.");c.isLoading=!1;c.renderUI();return a.abrupt("return");case 54:if(c.dc){c.dc.close()}if(c.pc){c.pc.close()}if(c.mediaStream){c.mediaStream.getTracks().forEach(function(a){return a.stop()})}c.isLoading=!1;c.renderUI();return a.abrupt("return");case 60:c.isLoading=!1;c.isSessionActive=!0;c.isSessionStarted=!0;c.isSessionStopped=!1;c.renderUI();case 65:case"end":return a.stop();}}},a,this,[[25,46]])}));return function startSession(){return a.apply(this,arguments)}}(),sendGradingRequest:function sendGradingRequest(){var a=this,b="Please provide a percentage score for the session, an explanation of the score (for teachers), and feedback (for the student). "+a.itemdata.audiochatgradeinstructions+"Return the response as JSON in the format: {\"score\": \"the score  ( 0-100 ) \", \"gradeexplanation\": \"the explanation\", \"feedback\": \"the feedback\"}.",c={conversation:"none",output_modalities:["text"],instructions:b,metadata:{tag:a.gradingrequesttag},max_output_tokens:500};a.sendEvent({type:"response.create",response:c})},stopSession:function stopSession(){var a=this;b.debug("Session stopping...");a.isSessionActive=!1;a.isSessionStopped=!0;a.loadingMessages.clear();a.releaseMicResources();a.renderUI();if(a.itemdata.audiochatgradeinstructions&&""!==a.itemdata.audiochatgradeinstructions){a.sendGradingRequest();a.controls.resultscontent.innerHTML="<i class=\"fa fa-spinner fa-spin fa-2x\"></i>";setTimeout(function(){if(a.quizhelper.showitemreview){a.showResults()}b.debug("Closing session resources...");a.closeDataChannel()},7e3)}else{b.debug("Closing session resources...");a.closeDataChannel()}b.debug("Session stopped")},closeDataChannel:function closeDataChannel(){var a=this;if("undefined"!=typeof a.dc&&a.dc){a.dc.close();a.dc=null}if("undefined"!=typeof a.pc&&a.pc){a.pc.close();a.pc=null}},showResults:function showResults(){var a=this,b={};b.resultsdata={items:Object.values(a.items)};b=a.grade_activity(b);var c=[],d=5;if("undefined"==typeof b.grade||isNaN(b.grade)||null===b.grade||""===b.grade){b.grade=0}for(var f=Math.round(b.grade/100*d),g=0;g<d;g++){c.push({filled:g<f})}b.stars=c;e.render("mod_minilesson/audiochatimmediatefeedback",b).then(function(b,c){a.controls.resultscontent.innerHTML=b;e.runTemplateJS(c)})},waitForIceGathering:function waitForIceGathering(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:15e3;return new Promise(function(c){var e;function d(){if("complete"===a.iceGatheringState){clearTimeout(e);a.removeEventListener("icegatheringstatechange",d);c()}}a.addEventListener("icegatheringstatechange",d);e=setTimeout(function(){a.removeEventListener("icegatheringstatechange",d);c()},b)})},sendEvent:function sendEvent(a){var b=this;if(b.dc&&"open"===b.dc.readyState){b.dc.send(JSON.stringify(a))}},handleRTCEvent:function handleRTCEvent(a){var c,d=this;b.debug("Received event:");b.debug(a);if("response.done"===a.type&&(null===(c=a.response.metadata)||void 0===c?void 0:c.tag)===d.gradingrequesttag){b.debug("It is a grading event:");try{var e=a.response.output[0].content[0].text,f=/\{[\s\S]*?\}/;if(!e||""===e||!e.match(f)){b.debug("No valid grading data received .. msg is ..");b.debug(a);d.closeDataChannel();return}d.gradingData=JSON.parse(e.match(f)[0]);b.debug("Grading and Feedback:",d.gradingData)}catch(a){d.gradingData=!1;b.debug("Failed to parse grading feedback:",a);b.debug(e)}return}var g=a.response?a.response.id:a.response_id,h=a.item?a.item.id:a.item_id;if(g){d.responses[g]=d.responses[g]||{id:g,itemid:h,stack:[]}}if(h){if("undefined"==typeof d.items[h]){d.scrollToBottom()}d.items[h]=d.items[h]||{id:h,events:[],responses:null,content:""};if(g){d.items[h].responses=d.responses[g]}}a.time=Date.now().toString();switch(a.type){case"response.created":{d.responses[a.response.id].stack.push(a);break}case"response.output_item.added":{d.responses[a.response_id].stack.push(a);break}case"conversation.item.added":case"conversation.item.created":{d.items[a.item.id].previous_item_id=a.previous_item_id;d.items[a.item.id].usertype=a.item.role;d.items[a.item.id].events.push(a);if("assistant"===a.item.role){d.loadingMessages.add(h)}break}case"response.content_part.added":{d.enableMic();d.responses[a.response_id].stack.push(a);break}case"response.output_audio_transcript.delta":case"response.audio_transcript.delta":{d.responses[a.response_id].stack.push(a);d.items[a.item_id].content+=a.delta;break}case"output_audio_buffer.cleared":{d.responses[a.response_id].stack.push(a);break}case"response.output_audio.done":case"response.audio.done":{d.responses[a.response_id].stack.push(a);break}case"response.output_audio_transcript.done":case"response.audio_transcript.done":{d.responses[a.response_id].stack.push(a);d.items[a.item_id].content=a.transcript;break}case"response.content_part.done":{d.responses[a.response_id].stack.push(a);break}case"response.output_item.done":{d.responses[a.response_id].stack.push(a);d.loadingMessages.delete(a.item.id);break}case"response.done":{d.responses[a.response.id].stack.push(a);break}case"output_audio_buffer.stopped":{if(!d.isMicActive){d.toggleMute()}d.responses[a.response_id].stack.push(a);break}case"conversation.item.truncated":{d.items[a.item_id].events.push(a);break}case"input_audio_buffer.speech_started":{b.debug("Input audio buffer speech started");d.setDataInputBuffer(!0,"audiobufferstarted");d.items[a.item_id].events.push(a);break}case"input_audio_buffer.speech_stopped":{if(d.isMicActive){if(d.autocreateresponse){d.toggleMute();d.disableMic()}}d.items[a.item_id].events.push(a);break}case"input_audio_buffer.committed":{b.debug("Input audio buffer committed");d.setDataInputBuffer(!1,"audiobuffercommitted");d.items[a.item_id].events.push(a);break}case"conversation.item.input_audio_transcription.delta":{d.items[a.item_id].events.push(a);d.items[a.item_id].content+=a.delta;break}case"conversation.item.input_audio_transcription.completed":{d.items[a.item_id].events.push(a);d.items[a.item_id].content=a.transcript;d.loadingMessages.delete(a.item_id);break}}d.renderUI()},enableMic:function enableMic(){var a=this;if(a.controls.toggleMicBtn){b.debug("Enabling mic");a.controls.toggleMicBtn.parentElement.classList.remove("disabled")}},disableMic:function disableMic(){var a=this;if(a.controls.toggleMicBtn){b.debug("Disabling mic");a.controls.toggleMicBtn.parentElement.classList.add("disabled")}},initializeMicStream:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var c,d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=this;a.prev=1;c.audioContext=new(window.AudioContext||window.webkitAudioContext);c.analyser=c.audioContext.createAnalyser();c.analyser.fftSize=2048;d=c.analyser.frequencyBinCount;c.dataArray=new Uint8Array(d);c.sourceNode=c.audioContext.createMediaStreamSource(c.mediaStream);c.isMicInitialized=!0;return a.abrupt("return",!0);case 12:a.prev=12;a.t0=a["catch"](1);b.debug("Error accessing microphone:",a.t0);c.isMicInitialized=!1;b.debug("Could not access microphone. Please ensure it's connected and permissions are granted.");return a.abrupt("return",!1);case 18:case"end":return a.stop();}}},a,this,[[1,12]])}));return function initializeMicStream(){return a.apply(this,arguments)}}(),toggleMute:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var c,d,e,f;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=this;if(c.isMicInitialized){a.next=7;break}a.next=4;return c.initializeMicStream();case 4:d=a.sent;if(d){a.next=7;break}return a.abrupt("return");case 7:if(c.isMicActive){if(c.sourceNode&&c.analyser){c.sourceNode.disconnect(c.analyser)}if(c.animationFrameId){cancelAnimationFrame(c.animationFrameId);c.animationFrameId=null}if(c.pc){c.mediaStream.getTracks().forEach(function(a){a.enabled=!1})}if(c.canvasCtx){c.canvasCtx.clearRect(0,0,c.controls.micWaveformCanvas.width,c.controls.micWaveformCanvas.height)}c.isMicActive=!1;if(!c.autocreateresponse){if(!c.datainputbuffer){b.debug(" sending response.create");c.sendEvent({type:"response.create",response:{output_modalities:["audio"],instructions:c.itemdata.audiochatinstructions,audio:{output:{voice:c.audiochat_voice}}}})}else{b.debug("Waiting for input audio buffer to commit before sending response.create");e=0;if(c.inputBufferInterval){clearInterval(c.inputBufferInterval);c.inputBufferInterval=null}f=3;c.inputBufferInterval=setInterval(function(){b.debug("Checking input buffer status, attempt:",e);if(!c.datainputbuffer||e>=f){clearInterval(c.inputBufferInterval);c.setDataInputBuffer(!1,"setInterval:"+e);b.debug(" sending response.create");c.sendEvent({type:"response.create",response:{output_modalities:["audio"],instructions:c.itemdata.audiochatinstructions,audio:{output:{voice:c.audiochat_voice}}}})}e++},1500)}}}else{if(c.sourceNode&&c.analyser){c.sourceNode.connect(c.analyser)}if(c.pc){c.mediaStream.getTracks().forEach(function(a){a.enabled=!0})}c.isMicActive=!0;c.drawWave()}c.renderUI();case 9:case"end":return a.stop();}}},a,this)}));return function toggleMute(){return a.apply(this,arguments)}}(),releaseMicResources:function releaseMicResources(){var a=this;if(a.animationFrameId){cancelAnimationFrame(a.animationFrameId);a.animationFrameId=null}if(a.mediaStream){a.mediaStream.getTracks().forEach(function(b){if("undefined"!=typeof a.pc&&a.pc){var c=a.pc.getSenders().find(function(a){return a.track===b});if(c){a.pc.removeTrack(c)}}b.stop()});a.mediaStream=null}if(a.sourceNode){a.sourceNode.disconnect();a.sourceNode=null}if(a.audioContext){a.audioContext.close();a.audioContext=null}a.isMicActive=!1;a.isMicInitialized=!1;if(a.canvasCtx){a.canvasCtx.clearRect(0,0,a.controls.micWaveformCanvas.width,a.controls.micWaveformCanvas.height)}a.renderUI()},drawWave:function drawWave(){var a=this;if(!a.canvasCtx||!a.analyser||!a.dataArray||!a.isMicActive){a.animationFrameId=null;return}var b=a.controls.micWaveformCanvas.width,c=a.controls.micWaveformCanvas.height;a.animationFrameId=requestAnimationFrame(a.drawWave.bind(a));a.analyser.getByteTimeDomainData(a.dataArray);a.canvasCtx.clearRect(0,0,b,c);a.canvasCtx.lineWidth=2;a.canvasCtx.strokeStyle="rgb(255, 255, 255)";a.canvasCtx.beginPath();for(var d=1*b/a.dataArray.length,e=0,f=0;f<a.dataArray.length;f++){var g=a.dataArray[f]/128,h=g*c/2;if(0==f){a.canvasCtx.moveTo(e,h)}else{a.canvasCtx.lineTo(e,h)}e+=d}a.canvasCtx.lineTo(b,c/2);a.canvasCtx.stroke()},populateMicList:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var c,d,e,f,g,h,i,j,k;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=this;a.prev=1;a.next=4;return navigator.mediaDevices.enumerateDevices();case 4:d=a.sent;e=d.filter(function(a){return"audioinput"===a.kind});f=c.controls.micSelect;f.innerHTML="";g=[];h=new Set;i=_createForOfIteratorHelper(e);try{for(i.s();!(j=i.n()).done;){k=j.value;if(!h.has(k.groupId)){g.push(k);h.add(k.groupId)}}}catch(a){i.e(a)}finally{i.f()}if(!(1>=g.length)){a.next=15;break}f.disabled=!0;return a.abrupt("return");case 15:g.forEach(function(a,b){var c=document.createElement("option");c.value=a.deviceId;c.text=a.label||"Microphone ".concat(b+1);f.appendChild(c)});f.parentElement.classList.remove("hidden");f.addEventListener("change",function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=b.target.value;a.next=3;return c.switchMic(d);case 3:case"end":return a.stop();}}},a)}));return function(){return a.apply(this,arguments)}}());a.next=23;break;case 20:a.prev=20;a.t0=a["catch"](1);b.debug("Failed to get microphone list:",a.t0);case 23:case"end":return a.stop();}}},a,this,[[1,20]])}));return function populateMicList(){return a.apply(this,arguments)}}(),switchMic:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(c){var d,e,f,g;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d=this;if(d.mediaStream){d.mediaStream.getTracks().forEach(function(a){return a.stop()})}a.prev=2;a.next=5;return navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:c}}});case 5:d.mediaStream=a.sent;if(d.pc){e=d.pc.getSenders();f=d.mediaStream.getAudioTracks()[0];g=e.find(function(a){return"audio"===a.track.kind});if(g){g.replaceTrack(f)}}a.next=9;return d.initializeMicStream();case 9:if(d.isMicInitialized){d.sourceNode.connect(d.analyser);d.mediaStream.getTracks().forEach(function(a){a.enabled=d.isMicActive});if(d.isMicActive){d.drawWave()}}b.debug("Switched microphone to:"+c);a.next=17;break;case 13:a.prev=13;a.t0=a["catch"](2);b.debug("Failed to switch microphone:");b.debug(a.t0);case 17:case"end":return a.stop();}}},a,this,[[2,13]])}));return function switchMic(){return a.apply(this,arguments)}}()}});
//# sourceMappingURL=audiochat.min.js.map
