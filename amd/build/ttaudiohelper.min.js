define ("mod_minilesson/ttaudiohelper",["jquery","core/log","mod_minilesson/ttwavencoder","mod_minilesson/ttstreamer"],function(a,b,c,d){"use strict";b.debug("TT Audio Helper initialising");return{encodingconfig:null,streamer:null,encoder:null,microphone:null,isRecording:!1,audioContext:null,processor:null,uniqueid:null,alreadyhadsound:!1,silencecount:0,silenceintervals:15,silencelevel:25,enablesilencedetection:!0,wavconfig:{bufferLen:4096,numChannels:2,desiredSampleRate:48e3,mimeType:"audio/wav"},streamingconfig:{bufferLen:4096,numChannels:1,desiredSampleRate:16e3,mimeType:"audio/wav"},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.waveHeight=a;this.uniqueid=b;this.therecorder=c;this.region=c.region;if(this.therecorder.is_streaming){this.encodingconfig=this.streamingconfig}else{this.encodingconfig=this.wavconfig}this.prepare_html();window.AudioContext=window.AudioContext||window.webkitAudioContext},onStop:function onStop(){},onStream:function onStream(){},onSocketReady:function onSocketReady(){},onError:function onError(){},onfinalspeechcapture:function onfinalspeechcapture(){},oninterimspeechcapture:function oninterimspeechcapture(){},prepare_html:function prepare_html(){this.canvas=a("#"+this.uniqueid+"_waveform");this.canvasCtx=this.canvas[0].getContext("2d")},start:function start(){var a=this;this.audioContext=new AudioContext({sampleRate:this.encodingconfig.desiredSampleRate});this.processor=this.audioContext.createScriptProcessor(this.encodingconfig.bufferLen,this.encodingconfig.numChannels,this.encodingconfig.numChannels);this.processor.connect(this.audioContext.destination);if("audioSession"in navigator){navigator.audioSession.type="play-and-record";console.log("AudioSession API is supported")}navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(function gotStreamMethod(e){a.isRecording=!0;a.tracks=e.getTracks();for(var f=0,g;f<a.tracks.length;f++){g=a.tracks[f];if("audio"==g.kind){var h=g.getSettings();if(h.noiseSuppression){b.debug("Noise Suppression is on")}else{b.debug("Noise Suppression is off")}if(h.echoCancellation){b.debug("Echo Cancellation is on")}else{b.debug("Echo Cancellation is off")}}}a.microphone=a.audioContext.createMediaStreamSource(e);a.microphone.connect(a.processor);if(a.therecorder.is_streaming){a.streamer=d.clone();a.streamer.init(a.therecorder.speechtoken,a);a.enablesilencedetection=!1}a.onStream(e);a.encoder=c.clone();a.encoder.init(a.audioContext.sampleRate,a.encodingconfig.numChannels);a.processor.onaudioprocess=function(b){var c=a.getBuffers(b);a.encoder.audioprocess(c);if(a.streamer){a.streamer.audioprocess(c)}};a.listener=a.audioContext.createAnalyser();a.microphone.connect(a.listener);a.listener.fftSize=2048;a.bufferLength=a.listener.frequencyBinCount;a.analyserData=new Uint8Array(a.bufferLength);a.volumeData=new Uint8Array(a.bufferLength);a.canvasCtx.clearRect(0,0,2*a.canvas.width(),2*a.waveHeight);a.alreadyhadsound=!1;a.silencecount=0;a.interval=setInterval(function(){a.drawWave();a.detectSilence()},100)}).catch(this.onError)},stop:function stop(){var a=this;clearInterval(this.interval);this.canvasCtx.clearRect(0,0,2*this.canvas.width(),2*this.waveHeight);this.isRecording=!1;this.silencecount=0;this.alreadyhadsound=!1;this.therecorder.update_audio("isRecording",!1);setTimeout(function(){if(null!==a.audioContext&&"closed"!==a.audioContext.state){a.audioContext.close()}a.processor.disconnect();a.tracks.forEach(function(a){return a.stop()});a.onStop(a.encoder.finish());if(a.streamer){a.streamer.finish()}},1e3)},getBuffers:function getBuffers(a){for(var b=[],c=0;c<this.encodingconfig.numChannels;++c){b[c]=a.inputBuffer.getChannelData(c)}return b},detectSilence:function detectSilence(){if(!this.enablesilencedetection){return}this.listener.getByteFrequencyData(this.volumeData);for(var a=0,b=0;b<this.volumeData.length;b++){a+=this.volumeData[b]*this.volumeData[b]}var c=Math.sqrt(a/this.volumeData.length);if(c<this.silencelevel&&this.alreadyhadsound){this.silencecount++;if(this.silencecount>=this.silenceintervals){this.therecorder.silence_detected()}}else if(c>this.silencelevel){this.alreadyhadsound=!0;this.silencecount=0}},drawWave:function drawWave(){var a=2*this.canvas.width();this.listener.getByteTimeDomainData(this.analyserData);this.canvasCtx.fillStyle="#F5F5FE";this.canvasCtx.fillRect(0,0,a,2*this.waveHeight);this.canvasCtx.lineWidth=5;this.canvasCtx.strokeStyle="gray";this.canvasCtx.beginPath();for(var b=a/this.bufferLength,c=0,d=0;d<this.bufferLength;d++){var e=this.analyserData[d]/128,f=e*this.waveHeight;if(!(0==d)){this.canvasCtx.lineTo(c,f)}c+=b}this.canvasCtx.lineTo(a,this.waveHeight);this.canvasCtx.stroke()}}});
//# sourceMappingURL=ttaudiohelper.min.js.map
