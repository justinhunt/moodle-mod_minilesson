define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder","mod_minilesson/animatecss"],(function($,log,Ajax,def,polly,cloudpoodll,ttrecorder,anim){log.debug("MiniLesson ST Helper: initialising");var app={passmark:90,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],phonetics:[],displayterms:[],results:[],controls:{},ttrec:null,init:function(props){var theid="#amdopts_"+props.widgetid,configcontrol=$(theid).get(0);configcontrol?(this.activitydata=JSON.parse(configcontrol.value),$(theid).remove(),this.init_polly(),this.init_controls(),this.register_events()):log.debug("MiniLesson ST helper: No config found on page. Giving up.")},init_polly:function(){var pollytoken=this.activitydata.token,pollyregion=this.activitydata.region;polly.init(pollytoken,pollyregion,"poodll"),log.debug("polly initialised")},init_controls:function(){log.debug("sthelper init controls"),app.controls={},app.controls.pollybutton=$("#speechtester_pollybutton"),app.controls.pollyvoice=$("#speechtester_voice"),app.controls.pollylanguage=$("#speechtester_language"),app.controls.pollytext=$("#speechtester_text"),app.controls.audioplayer=$("#speechtester_audioplayer"),app.controls.transcribebutton=$("#speechtester_transcribebutton"),app.controls.transcription=$("#speechtester_transcription"),app.controls.transcriptioncoverage=$("#speechtester_transcription_coverage"),app.controls.opentranscription=$("#speechtester_open")},register_events:function(){log.debug("sthelper register events"),app.controls.pollybutton.on("click",(function(){log.debug("pollybutton clicked"),log.debug(app.controls.pollytext.val()),log.debug(app.controls.pollyvoice.val()),polly.fetch_polly_url(app.controls.pollytext.val(),"text",app.controls.pollyvoice.val()).then((function(audiourl){app.controls.audioplayer.attr("src",audiourl),log.debug(audiourl)}))})),app.controls.transcribebutton.on("click",(function(){log.debug("transcribebutton clicked"),log.debug(app.controls.audioplayer.attr("src")),app.downloadAndSubmitMP3(app.controls.audioplayer.attr("src"),app.doTranscribe)}))},downloadAndSubmitMP3:function(url,submitFunction){fetch(url).then((response=>response.blob())).then((blob=>{submitFunction(blob)})).catch((error=>{log.debug("Error downloading MP3:",error)}))},doTranscribe:function(blob){app.controls.transcriptioncoverage.html(""),app.controls.transcription.html("");var bodyFormData=new FormData,blobname=Math.floor(100*Math.random())+".wav",guided=0==app.controls.opentranscription.prop("checked");log.debug("guided is: "+guided);var prompt=app.controls.pollytext.val();bodyFormData.append("audioFile",blob,blobname),bodyFormData.append("scorer",""),guided?bodyFormData.append("strictmode","false"):bodyFormData.append("strictmode","true"),guided&&bodyFormData.append("prompt",app.controls.pollytext.val()),bodyFormData.append("lang",app.controls.pollylanguage.val()),bodyFormData.append("wwwroot",M.cfg.wwwroot);var oReq=new XMLHttpRequest;oReq.open("POST",app.activitydata.asrurl,!0),oReq.onUploadProgress=function(progressEvent){},oReq.onload=function(oEvent){if(200===oReq.status){var respObject=JSON.parse(oReq.response);if(respObject.data.hasOwnProperty("transcript")){var transcript=respObject.data.transcript;app.controls.transcription.text(transcript),app.comparePassageToTranscript(prompt,transcript).then((function(ajaxresult){var comparison=JSON.parse(ajaxresult);if(comparison){var allCorrect=0==comparison.filter((function(e){return!e.matched})).length,coverage=comparison.filter((function(e){return e.matched})).length/comparison.length;coverage*=100,coverage=Math.round(coverage);var tc_report="All correct: "+allCorrect+"<br>";tc_report+="Coverage: "+coverage+"%<br>",coverage<100&&$.each(comparison,(function(index,value){value.matched||(tc_report+="unmatched word: "+value.word+"<br>")})),app.controls.transcriptioncoverage.html(tc_report)}}))}else app.controls.transcription.text("no transcript was in the result")}else app.controls.transcription.text("error"),log.debug(oReq.error)};try{oReq.send(bodyFormData)}catch(err){app.controls.transcription.text("error"),log.debug(err)}},comparePassageToTranscript:function(passage,transcript){return Ajax.call([{methodname:"mod_minilesson_compare_passage_to_transcript",args:{passage:passage,transcript:transcript,alternatives:"",phonetic:"",language:app.controls.pollylanguage.val(),region:app.activitydata.region,cmid:app.activitydata.cmid},async:!1}])[0]},initComponents:function(){var theCallback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("speech at speechcards");var speechtext=message.capturedspeech,spoken_clean=quizhelper.cleanText(speechtext),correct_clean=quizhelper.cleanText(app.terms[app.pointer-1]),correctphonetic=app.phonetics[app.pointer-1];log.debug("speechtext:",speechtext),log.debug("spoken:",spoken_clean),log.debug("correct:",correct_clean);var similarity_js=quizhelper.similarity(spoken_clean,correct_clean);if(log.debug("JS similarity: "+spoken_clean+":"+correct_clean+":"+similarity_js),similarity_js>=app.passmark||app.wordsDoMatch(spoken_clean,correct_clean))return log.debug("local match::"+spoken_clean+":"+correct_clean),app.showStarRating(100),void app.flagCorrectAndTransition();quizhelper.checkByPhonetic(correct_clean,spoken_clean,correctphonetic,app.language).then((function(similarity_php){if(!1===similarity_php)return $.Deferred().reject();log.debug("PHP similarity: "+spoken_clean+":"+correct_clean+":"+similarity_php),similarity_php>=app.passmark?(app.showStarRating(similarity_php),app.flagCorrectAndTransition()):app.showStarRating(Math.max(similarity_js,similarity_php))}))}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),app.ttrec=ttrecorder.clone(),app.ttrec.init(opts),app.ttrec.currentPrompt=app.displayterms[app.pointer-1]}else cloudpoodll.init("minilesson-recorder-speechcards-"+itemdata.id,theCallback);app.progress_dots(app.results,app.terms),app.initSlider()},wordsDoMatch:function(phraseheard,currentphrase){return(phraseheard=quizhelper.cleanText(phraseheard))==(currentphrase=quizhelper.cleanText(currentphrase))},check:function(correct){var result={points:1==correct?1:0};app.results.push(result)}};return app}));

//# sourceMappingURL=sthelper.min.js.map