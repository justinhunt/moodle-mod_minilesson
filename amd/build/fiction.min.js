function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(!a)return;if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return _arrayLikeToArray(a,b)}function _iterableToArray(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function _arrayWithoutHoles(a){if(Array.isArray(a))return _arrayLikeToArray(a)}function _arrayLikeToArray(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}f(void 0)})}}define ("mod_minilesson/fiction",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/yarn-bound","core/str","core/modal_factory","core/fragment","core/templates"],function(a,b,c,d,f,g,h,i){"use strict";b.debug("MiniLesson Fiction: initialising");return{runner:null,controls:{},itemdata:{},mobilechatdata:{},clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,e){this.itemdata=c;this.prepare_html(c);this.register_events(a,c,e);var f={dialogue:c.fictionyarn,combineTextAndOptionsResults:!0,startAt:"Start"};b.debug("MiniLesson Fiction: initializing yarnbound with options");b.debug(f);try{this.runner=new d(f);this.do_render()}catch(a){var g="Yarn Parse Error: "+a.message;this.controls.yarncontainer.html("<div class=\"alert alert-danger\">".concat(g,"</div>"));b.error("Full Yarn Error:");b.error(a)}},prepare_html:function prepare_html(b){this.controls.yarncontainer=a("#"+b.uniqueid+"_container .minilesson_fiction_yarncontainer");this.controls.yarntext=this.controls.yarncontainer.find(".minilesson_fiction_yarntext");this.controls.yarnmedia=this.controls.yarncontainer.find(".minilesson_fiction_yarnmedia");this.controls.yarnoptions=this.controls.yarncontainer.find(".minilesson_fiction_yarnoptions");this.controls.yarncontinuebutton=a("#"+b.uniqueid+"_container .minilesson_fiction_continuebutton");this.controls.chatwrapper=a("#"+b.uniqueid+"_container .mobilechat .chat-wrapper")},do_render:function do_render(){var a=this,c={yarntext:!1,yarnoptions:!1},e=this.runner.currentResult;e=this.add_metadata(e);b.debug("MiniLesson Fiction: doing render of currentResult");b.debug(e);if(e instanceof d.TextResult){c.yarntext=e;if(a.itemdata.presention_mobilechat){var f,g,h,j;a.can_continuebutton(!1);a.mobilechatdata.picturesrc=null===(f=c.yarntext.md)||void 0===f?void 0:null===(g=f.character)||void 0===g?void 0:g.picturesrc;a.mobilechatdata.charactername=null===(h=c.yarntext.md)||void 0===h?void 0:null===(j=h.character)||void 0===j?void 0:j.name;a.mobilechatdata.charactertext=c.yarntext.text;i.render("mod_minilesson/fiction_charactermessage",{charactermedia:"<div class=\"chat-loader\"></div>"}).then(function(b,c){i.appendNodeContents(a.controls.chatwrapper,b,c);a.scrolltobottom();setTimeout(function(){i.render("mod_minilesson/fiction_charactermessage",a.mobilechatdata).then(function(b,c){i.replaceNode(a.controls.chatwrapper.find("> .chat-window").last(),b,c);a.scrolltobottom();var d=a.mobilechatdata.charactermedia;a.reset_mobilechat_data();a.mobilechatdata.charactermedia=d;if(!e.isDialogueEnd){a.can_continuebutton(!0)}})},2e3)});a.controls.yarnoptions.html("")}else{i.render("mod_minilesson/fictionyarntext",c.yarntext).then(function(b,c){a.controls.yarntext.html(b);a.controls.yarnoptions.html("");i.runTemplateJS(c)});this.can_continuebutton(!0)}}else if(e instanceof d.OptionsResult){c.yarnoptions=e;if(a.itemdata.presention_mobilechat){var k={yarnoptions:e,presention_mobilechat:!0};a.controls.yarnoptions.html("")}else{var k=e}i.render("mod_minilesson/fictionyarnoptions",k).then(function(b,c){setTimeout(function(){a.controls.yarnoptions.html(b);i.runTemplateJS(c)},a.itemdata.presention_mobilechat?2e3:1)});if("text"in c.yarnoptions){if(a.itemdata.presention_mobilechat){var l,m,n,o;a.mobilechatdata.picturesrc=null===(l=c.yarnoptions.md)||void 0===l?void 0:null===(m=l.character)||void 0===m?void 0:m.picturesrc;a.mobilechatdata.charactername=null===(n=c.yarnoptions.md)||void 0===n?void 0:null===(o=n.character)||void 0===o?void 0:o.name;a.mobilechatdata.charactertext=c.yarnoptions.text;i.render("mod_minilesson/fiction_charactermessage",{charactermedia:"<div class=\"chat-loader\"></div>"}).then(function(b,c){i.appendNodeContents(a.controls.chatwrapper,b,c);a.scrolltobottom();setTimeout(function(){i.render("mod_minilesson/fiction_charactermessage",a.mobilechatdata).then(function(b,c){i.replaceNode(a.controls.chatwrapper.find("> .chat-window").last(),b,c);a.scrolltobottom();var d=a.mobilechatdata.charactermedia;a.reset_mobilechat_data();a.mobilechatdata.charactermedia=d})},2e3)})}else{i.render("mod_minilesson/fictionyarntext",c.yarnoptions).then(function(b,c){a.controls.yarntext.html(b);i.runTemplateJS(c)})}}else{a.controls.yarntext.html("")}a.can_continuebutton(!1)}else if(e instanceof d.CommandResult){var p=e.command,q=p.split(" "),r=q[0],s=q.slice(1),t=null;switch(r){case"picture":{b.debug("got picture command");var u=s[0];t=i.render("mod_minilesson/fictionyarnimage",{imageurl:u}).then(function(b,c){a.controls.yarnmedia.html(b);if(a.itemdata.presention_mobilechat){a.mobilechatdata.charactermedia=b;a.mobilechatdata.classname="hasmedia"}i.runTemplateJS(c)});break}case"audio":{b.debug("got audio command");var v=s[0];t=i.render("mod_minilesson/fictionyarnaudio",{audiourl:v}).then(function(b,c){if(a.itemdata.presention_mobilechat){a.mobilechatdata.charactermedia=b;a.mobilechatdata.classname="hasmedia"}a.controls.yarnmedia.html(b);i.runTemplateJS(c)});break}case"video":{b.debug("got video command");var w=s[0];t=i.render("mod_minilesson/fictionyarnvideo",{videourl:w}).then(function(b,c){if(a.itemdata.presention_mobilechat){a.mobilechatdata.charactermedia=b;a.mobilechatdata.classname="hasmedia"}a.controls.yarnmedia.html(b);i.runTemplateJS(c)});break}case"clearpicture":{a.controls.yarnmedia.html("");break}case"blahblah":default:}if(!e.isDialogueEnd){if(t){t.then(function(){a.do_runner_advance();a.do_render()})}else{a.do_runner_advance();a.do_render()}return}}else{b.debug("MiniLesson Fiction: unknown yarn result type")}if(e.isDialogueEnd){a.can_continuebutton(!1)}},do_runner_advance:function do_runner_advance(a){try{if(null!==a){this.runner.advance(a)}else{this.runner.advance()}}catch(a){var c="Yarn Parse Error: "+a.message;this.controls.yarncontainer.html("<div class=\"alert alert-danger\">".concat(c,"</div>"));b.error("Full Yarn Error:");b.error(a)}},can_continuebutton:function can_continuebutton(a){this.controls.yarncontinuebutton.prop("disabled",!a);if(a){this.controls.yarncontinuebutton.show()}else{this.controls.yarncontinuebutton.hide()}},register_events:function register_events(c,d,e){var f=this;a("#"+d.uniqueid+"_container .minilesson_nextbutton").on("click",function(){e.do_next({index:c,hasgrade:!1,totalitems:0,correctitems:0,grade:0})});a("#"+d.uniqueid+"_container").on("showElement",_asyncToGenerator(regeneratorRuntime.mark(function b(){return regeneratorRuntime.wrap(function(b){while(1){switch(b.prev=b.next){case 0:if(!f.instance){}if(0<d.timelimit){a("#"+d.uniqueid+"_container .progress-container").show();a("#"+d.uniqueid+"_container .progress-container i").show();a("#"+d.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:d.timelimit,onFinish:function onFinish(){a("#"+d.uniqueid+"_container .minilesson_nextbutton").trigger("click")}})}case 2:case"end":return b.stop();}}},b)})));this.controls.yarncontinuebutton.on("click",function(c){b.debug("MiniLesson Fiction: yarn continue button clicked");c.preventDefault();if(f.itemdata.presention_mobilechat){var d=a(this).siblings(".optiontext").text().trim();i.render("mod_minilesson/fiction_playermessage",{playertext:d}).then(function(a,b){i.appendNodeContents(f.controls.chatwrapper,a,b)})}f.do_runner_advance();f.do_render()});this.controls.yarncontainer.on("click",".minilesson_fiction_optionbutton",function(c){b.debug("MiniLesson Fiction: yarn option button clicked");c.preventDefault();var d=f.controls.yarncontainer.find(".minilesson_fiction_optionbutton"),e=d.index(this);if(f.itemdata.presention_mobilechat){var g=a(this).siblings(".optiontext").text().trim();i.render("mod_minilesson/fiction_playermessage",{playertext:g}).then(function(a,b){i.appendNodeContents(f.controls.chatwrapper,a,b)})}f.do_runner_advance(e);f.do_render()});if(this.itemdata.presention_mobilechat){var g=a("#"+d.uniqueid+"_container .mobilechat #scroll-bottom-btn");this.controls.chatwrapper.on("scroll",function(){var a=f.controls.chatwrapper[0],b=a.scrollHeight-a.scrollTop<=a.clientHeight+5;if(b){g.hide()}else{g.show()}});g.on("click",function(a){a.preventDefault();a.stopPropagation();f.controls.chatwrapper.animate({scrollTop:f.controls.chatwrapper[0].scrollHeight},"smooth")})}},add_metadata:function add_metadata(a){if(a&&"markup"in a&&Array.isArray(a.markup)){var b;a.md={};a.markup.forEach(function(b){if("properties"in b&&"name"in b){a.md[b.name]=b.properties}});if(null===(b=a.md.character)||void 0===b?void 0:b.name){var c,d=a.md.character.name.toLowerCase();a.md.character.picturesrc=(null===(c=this.itemdata.filenamesmap.find(function(a){return a.filekey===d}))||void 0===c?void 0:c.fileurl)||null}}return a},register_previewbutton:function register_previewbutton(a){var b=document.getElementById(a);if(!b){return}b.addEventListener("click",function(a){a.preventDefault();var c=b.form;if(!c){return}g.create({type:g.types.CANCEL,large:!0,removeOnClose:!0,templateContext:{classes:"minilesson-fiction-preview-modal"},title:f.get_string("fiction:previewmodaltitle","mod_minilesson"),body:h.loadFragment("mod_minilesson","preview_fiction",M.cfg.contextid,{formdata:new URLSearchParams(_toConsumableArray(new FormData(c).entries())).toString()})}).then(function(a){a.getFooter().addClass("d-none");a.show()})})},reset_mobilechat_data:function reset_mobilechat_data(){this.mobilechatdata={charactername:null,charactermedia:null,charactertext:null,picturesrc:null,playertext:null}},scrolltobottom:function scrolltobottom(){if(!this.controls.chatwrapper.length){return}this.controls.chatwrapper.scrollTop(this.controls.chatwrapper[0].scrollHeight);this.controls.chatwrapper.animate({scrollTop:this.controls.chatwrapper[0].scrollHeight+5,behavior:"smooth"})}}});
//# sourceMappingURL=fiction.min.js.map
