define("mod_minilesson/fiction",["jquery","core/log","core/str","core/notification","mod_minilesson/definitions","mod_minilesson/external/yarn-bound","core/modal_factory","core/fragment","core/templates"],(function($,log,str,notification,def,YarnBound,ModalFactory,Fragment,Templates){return log.debug("MiniLesson Fiction: initialising"),{runner:null,controls:{},itemdata:{},chatdata:{},storycomplete:!1,storyscore:!1,strings:{},presentationmode:"plain",index:0,quizhelper:null,storydata:null,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.index=index,this.itemdata=itemdata,this.quizhelper=quizhelper,this.init_strings(),this.prepare_html(itemdata),this.register_events(this.index,itemdata,quizhelper),this.presentationmode=itemdata.presention_mobilechat?"mobilechat":"plain",this.flowthroughmode=itemdata.flowthroughmode,this.filenamesmap=itemdata.filenamesmap,this.preload_images(),this.storydata=new Map,this.storydata.set("userfirstname",itemdata.userfirstname),this.storydata.set("userlastname",itemdata.userlastname),this.storydata.set("userfullname",itemdata.userfullname),this.autodeclareVariables(itemdata.fictionyarn,this.storydata);var yarnopts={dialogue:itemdata.fictionyarn,combineTextAndOptionsResults:!0,startAt:"Start",variableStorage:this.storydata};log.debug("MiniLesson Fiction: initializing yarnbound with options"),log.debug(yarnopts);try{this.runner=new YarnBound(yarnopts),this.do_render()}catch(e){var userFriendlyError="Yarn Parse Error: "+e.message;this.controls.yarncontainer.html('<div class="alert alert-danger">'+userFriendlyError+"</div>"),log.error("Full Yarn Error:"),log.error(e)}},init_strings:function(){var self=this;str.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(s){var i=0;self.strings.nextlessonitem=s[i++],self.strings.confirm_desc=s[i++],self.strings.yes=s[i++],self.strings.no=s[i++]}))},prepare_html:function(itemdata){this.controls.yarncontainer=$("#"+itemdata.uniqueid+"_container .minilesson_fiction_yarncontainer"),this.controls.yarntext=this.controls.yarncontainer.find(".minilesson_fiction_yarntext"),this.controls.yarnmedia=this.controls.yarncontainer.find(".minilesson_fiction_yarnmedia"),this.controls.yarnoptions=this.controls.yarncontainer.find(".minilesson_fiction_yarnoptions"),this.controls.yarncontinuebutton=$("#"+itemdata.uniqueid+"_container .minilesson_fiction_continuebutton"),this.controls.chatwrapper=$("#"+itemdata.uniqueid+"_container .chat-wrapper"),Templates.prefetchTemplates(["mod_minilesson/fiction_playermessage"])},do_render:function(currentResult){currentResult=this.runner.currentResult,currentResult=this.add_metadata(currentResult),log.debug("MiniLesson Fiction: doing render of currentResult"),log.debug(currentResult);var _yarncontent$yarntext,_yarncontent$yarntext2,_yarncontent$yarntext3,_yarncontent$yarntext4,that=this,yarncontent={yarntext:!1,yarnoptions:!1};if(currentResult instanceof YarnBound.TextResult)yarncontent.yarntext=currentResult,this.can_continuebutton(!1),this.chatdata.picturesrc=null===(_yarncontent$yarntext=yarncontent.yarntext.md)||void 0===_yarncontent$yarntext||null===(_yarncontent$yarntext2=_yarncontent$yarntext.character)||void 0===_yarncontent$yarntext2?void 0:_yarncontent$yarntext2.picturesrc,this.chatdata.charactername=null===(_yarncontent$yarntext3=yarncontent.yarntext.md)||void 0===_yarncontent$yarntext3||null===(_yarncontent$yarntext4=_yarncontent$yarntext3.character)||void 0===_yarncontent$yarntext4?void 0:_yarncontent$yarntext4.name,this.chatdata.charactertext=yarncontent.yarntext.text,Templates.render("mod_minilesson/fiction_charactermessage",{charactermedia:'<div class="chat-loader"></div>'}).then((function(html,js){Templates.appendNodeContents(that.controls.chatwrapper,html,js),that.scrolltobottom(),setTimeout((()=>{Templates.render("mod_minilesson/fiction_charactermessage",that.chatdata).then((function(html,js){Templates.replaceNode(that.controls.chatwrapper.find("> .chat-window").last(),html,js),that.scrolltobottom(),that.reset_chat_data(),currentResult.isDialogueEnd||(that.flowthroughmode?(that.do_runner_advance(),that.do_render()):that.can_continuebutton(!0))}))}),2e3)})),that.controls.yarnoptions.html("");else if(currentResult instanceof YarnBound.OptionsResult){yarncontent.yarnoptions=currentResult;var _yarncontent$yarnopti,_yarncontent$yarnopti2,_yarncontent$yarnopti3,_yarncontent$yarnopti4,chatdata={yarnoptions:currentResult,presention_mobilechat:that.itemdata.presention_mobilechat,presention_plain:that.itemdata.presention_plain,shownonoptions:that.itemdata.shownonoptions};if(that.controls.yarnoptions.html(""),Templates.render("mod_minilesson/fictionyarnoptions",chatdata).then((function(html,js){setTimeout((()=>{that.controls.yarnoptions.html(html),Templates.runTemplateJS(js)}),2e3)})),"text"in yarncontent.yarnoptions)that.chatdata.picturesrc=null===(_yarncontent$yarnopti=yarncontent.yarnoptions.md)||void 0===_yarncontent$yarnopti||null===(_yarncontent$yarnopti2=_yarncontent$yarnopti.character)||void 0===_yarncontent$yarnopti2?void 0:_yarncontent$yarnopti2.picturesrc,that.chatdata.charactername=null===(_yarncontent$yarnopti3=yarncontent.yarnoptions.md)||void 0===_yarncontent$yarnopti3||null===(_yarncontent$yarnopti4=_yarncontent$yarnopti3.character)||void 0===_yarncontent$yarnopti4?void 0:_yarncontent$yarnopti4.name,that.chatdata.charactertext=yarncontent.yarnoptions.text,Templates.render("mod_minilesson/fiction_charactermessage",{charactermedia:'<div class="chat-loader"></div>'}).then((function(html,js){Templates.appendNodeContents(that.controls.chatwrapper,html,js),that.scrolltobottom(),setTimeout((()=>{Templates.render("mod_minilesson/fiction_charactermessage",that.chatdata).then((function(html,js){Templates.replaceNode(that.controls.chatwrapper.find("> .chat-window").last(),html,js),that.scrolltobottom(),that.reset_chat_data()}))}),2e3)}));else that.controls.yarntext.html("");that.can_continuebutton(!1)}else if(currentResult instanceof YarnBound.CommandResult){var parts=currentResult.command.split(" "),commandName=parts[0],args=parts.slice(1);let promise=null;switch(commandName){case"picture":{log.debug("got picture command");const imageURL=args[0];that.filenamesmap.find((function(file){return file.fileurl===imageURL}))&&(promise=Templates.render("mod_minilesson/fictionyarnimage",{imageurl:imageURL}).then((function(html,js){that.controls.yarnmedia.html(html),that.chatdata.charactermedia=html,that.chatdata.classname="hasmedia",Templates.runTemplateJS(js)})));break}case"audio":{log.debug("got audio command");const audioURL=args[0];that.filenamesmap.find((function(file){return file.fileurl===audioURL}))&&(promise=Templates.render("mod_minilesson/fictionyarnaudio",{audiourl:audioURL}).then((function(html,js){that.chatdata.charactermedia=html,that.chatdata.classname="hasmedia",that.controls.yarnmedia.html(html),Templates.runTemplateJS(js)})));break}case"video":{log.debug("got video command");const videoURL=args[0];that.filenamesmap.find((function(file){return file.fileurl===videoURL}))&&(promise=Templates.render("mod_minilesson/fictionyarnvideo",{videourl:videoURL}).then((function(html,js){that.chatdata.charactermedia=html,that.chatdata.classname="hasmedia",that.controls.yarnmedia.html(html),Templates.runTemplateJS(js)})));break}case"clearpicture":that.controls.yarnmedia.html("")}currentResult.isDialogueEnd||(promise?promise.then((()=>{that.do_runner_advance(),that.do_render()})):(that.do_runner_advance(),that.do_render()))}else log.debug("MiniLesson Fiction: unknown yarn result type");currentResult.isDialogueEnd&&(this.can_continuebutton(!1),this.storycomplete=!0,this.storydata.has("score")&&(this.storyscore=this.storydata.get("score"),isNaN(this.storyscore)?this.storyscore=!1:(this.storyscore=Math.round(this.storyscore),this.storyscore<0?this.storyscore=0:this.storyscore>100&&(this.storyscore=100))))},do_runner_advance:function(steps){try{null!==steps?this.runner.advance(steps):this.runner.advance()}catch(e){var userFriendlyError="Yarn Parse Error: "+e.message;this.controls.yarncontainer.html('<div class="alert alert-danger">'+userFriendlyError+"</div>"),log.error("Full Yarn Error:"),log.error(e)}},can_continuebutton:function(cancontinue){this.controls.yarncontinuebutton.prop("disabled",!cancontinue),cancontinue?this.controls.yarncontinuebutton.show():this.controls.yarncontinuebutton.hide()},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,!1!==this.storyscore?(stepdata.grade=this.storyscore,stepdata.totalitems=100,stepdata.correctitems=this.storyscore):(stepdata.correctitems=1,stepdata.totalitems=1,stepdata.grade=100),this.quizhelper.do_next(stepdata)},preload_images:function(){this.filenamesmap&&this.filenamesmap.length>0&&(log.debug("MiniLesson Fiction: Preloading "+this.filenamesmap.length+" images"),this.filenamesmap.forEach((function(file){file.fileurl&&((new Image).src=file.fileurl)})))},register_events:function(index,itemdata,quizhelper){var self=this;$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(){self.storycomplete?self.next_question():notification.confirm(self.strings.nextlessonitem,self.strings.confirm_desc,self.strings.yes,self.strings.no,(function(){self.next_question()}))})),$("#"+itemdata.uniqueid+"_container").on("showElement",(async()=>{self.instance,itemdata.timelimit>0&&($("#"+itemdata.uniqueid+"_container .progress-container").show(),$("#"+itemdata.uniqueid+"_container .progress-container i").show(),$("#"+itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:itemdata.timelimit,onFinish:function(){$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").trigger("click")}}))})),this.controls.yarncontinuebutton.on("click",(function(e){log.debug("MiniLesson Fiction: yarn continue button clicked"),e.preventDefault(),self.do_runner_advance(),self.do_render()})),this.controls.yarncontainer.on("click",".minilesson_fiction_optionbutton",(function(e){log.debug("MiniLesson Fiction: yarn option button clicked"),e.preventDefault();var optionindex=self.controls.yarncontainer.find(".minilesson_fiction_optionbutton").index(this);const playertext=$(this).text().trim();Templates.render("mod_minilesson/fiction_playermessage",{playertext:playertext}).then((function(html,js){Templates.appendNodeContents(self.controls.chatwrapper,html,js),self.do_runner_advance(optionindex),self.do_render()}))}));let scrollbtn=$("#"+itemdata.uniqueid+"_container #scroll-bottom-btn");this.controls.chatwrapper.on("scroll",(function(){const chatwrapper=self.controls.chatwrapper[0];chatwrapper.scrollHeight-chatwrapper.scrollTop<=chatwrapper.clientHeight+5?scrollbtn.hide():scrollbtn.show()})),scrollbtn.on("click",(function(e){e.preventDefault(),e.stopPropagation(),self.controls.chatwrapper.animate({scrollTop:self.controls.chatwrapper[0].scrollHeight},"smooth")}))},autodeclareVariables:function(yarnText,storageMap){const declareRegex=/<<declare\s+\$([\w\d_]+)\s*=\s*(.*?)>>/g;let match;for(;null!==(match=declareRegex.exec(yarnText));){let finalValue,varName=match[1],rawValue=match[2].trim();finalValue=isNaN(rawValue)?"true"===rawValue||"false"!==rawValue&&rawValue.replace(/^["']|["']$/g,""):Number(rawValue),storageMap.set(varName,finalValue)}},add_metadata:function(currentthing){var _currentthing$md$char;if(currentthing&&"markup"in currentthing&&Array.isArray(currentthing.markup)&&(currentthing.md={},currentthing.markup.forEach((function(entry){"properties"in entry&&"name"in entry&&(currentthing.md[entry.name]=entry.properties)})),null!==(_currentthing$md$char=currentthing.md.character)&&void 0!==_currentthing$md$char&&_currentthing$md$char.name)){var _this$itemdata$filena;const charname=currentthing.md.character.name.toLowerCase();currentthing.md.character.picturesrc=(null===(_this$itemdata$filena=this.itemdata.filenamesmap.find((fileinfo=>fileinfo.filekey===charname)))||void 0===_this$itemdata$filena?void 0:_this$itemdata$filena.fileurl)||null}return currentthing},register_previewbutton:function(buttonid){var previewbtn=document.getElementById(buttonid);previewbtn&&previewbtn.addEventListener("click",(function(e){e.preventDefault();var form=previewbtn.form;form&&ModalFactory.create({type:ModalFactory.types.CANCEL,large:!0,removeOnClose:!0,templateContext:{classes:"minilesson-fiction-preview-modal"},title:str.get_string("fiction:previewmodaltitle","mod_minilesson"),body:Fragment.loadFragment("mod_minilesson","preview_fiction",M.cfg.contextid,{formdata:new URLSearchParams([...new FormData(form).entries()]).toString()})}).then((function(modal){modal.getFooter().addClass("d-none"),modal.show()}))}))},reset_chat_data:function(){this.chatdata={charactername:null,charactermedia:null,charactertext:null,picturesrc:null,playertext:null}},scrolltobottom:function(){this.controls.chatwrapper.length&&(this.controls.chatwrapper.scrollTop(this.controls.chatwrapper[0].scrollHeight),this.controls.chatwrapper.animate({scrollTop:this.controls.chatwrapper[0].scrollHeight+5,behavior:"smooth"}))}}}));

//# sourceMappingURL=fiction.min.js.map