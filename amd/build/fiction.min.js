define("mod_minilesson/fiction",["jquery","core/log","mod_minilesson/definitions","mod_minilesson/yarn-bound","core/str","core/modal_factory","core/fragment","core/templates"],(function($,log,def,YarnBound,Str,ModalFactory,Fragment,Templates){return log.debug("MiniLesson Fiction: initialising"),{runner:null,controls:{},itemdata:{},clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.prepare_html(itemdata),this.register_events(index,itemdata,quizhelper);var yarnopts={dialogue:itemdata.fictionyarn,combineTextAndOptionsResults:!0,startAt:"Start"};log.debug("MiniLesson Fiction: initializing yarnbound with options"),log.debug(yarnopts);try{this.runner=new YarnBound(yarnopts),this.do_render()}catch(e){var userFriendlyError="Yarn Parse Error: "+e.message;this.controls.yarncontainer.html('<div class="alert alert-danger">'.concat(userFriendlyError,"</div>")),log.error("Full Yarn Error:"),log.error(e)}},prepare_html:function(itemdata){this.controls.yarncontainer=$("#"+itemdata.uniqueid+"_container .minilesson_fiction_yarncontainer"),this.controls.yarntext=this.controls.yarncontainer.find(".minilesson_fiction_yarntext"),this.controls.yarnmedia=this.controls.yarncontainer.find(".minilesson_fiction_yarnmedia"),this.controls.yarnoptions=this.controls.yarncontainer.find(".minilesson_fiction_yarnoptions"),this.controls.yarncontinuebutton=$("#"+itemdata.uniqueid+"_container .minilesson_fiction_continuebutton")},do_render:function(){var that=this,yarncontent={yarntext:!1,yarnoptions:!1},currentResult=this.runner.currentResult;if(currentResult=this.add_metadata(currentResult),log.debug("MiniLesson Fiction: doing render of currentResult"),log.debug(currentResult),currentResult instanceof YarnBound.TextResult)yarncontent.yarntext=currentResult,Templates.render("mod_minilesson/fictionyarntext",yarncontent.yarntext).then((function(html,js){that.controls.yarntext.html(html),that.controls.yarnoptions.html("")})),this.can_continuebutton(!0);else if(currentResult instanceof YarnBound.OptionsResult)yarncontent.yarnoptions=currentResult,Templates.render("mod_minilesson/fictionyarnoptions",yarncontent.yarnoptions).then((function(html,js){that.controls.yarnoptions.html(html)})),"text"in yarncontent.yarnoptions?Templates.render("mod_minilesson/fictionyarntext",yarncontent.yarnoptions).then((function(html,js){that.controls.yarntext.html(html)})):that.controls.yarntext.html(""),that.can_continuebutton(!1);else if(currentResult instanceof YarnBound.CommandResult){var parts=currentResult.command.split(" "),commandName=parts[0],args=parts.slice(1);switch(commandName){case"picture":log.debug("got picture command");const imageURL=args[0];Templates.render("mod_minilesson/fictionyarnimage",{imageurl:imageURL}).then((function(html,js){that.controls.yarnmedia.html(html)}));break;case"audio":log.debug("got audio command");const audioURL=args[0];Templates.render("mod_minilesson/fictionyarnaudio",{audiourl:audioURL}).then((function(html,js){that.controls.yarnmedia.html(html)}));break;case"video":log.debug("got video command");const videoURL=args[0];Templates.render("mod_minilesson/fictionyarnvideo",{videourl:videoURL}).then((function(html,js){that.controls.yarnmedia.html(html)}));break;case"clearpicture":that.controls.yarnmedia.html("")}if(!currentResult.isDialogueEnd)return that.do_runner_advance(),void that.do_render()}else log.debug("MiniLesson Fiction: unknown yarn result type");currentResult.isDialogueEnd&&that.can_continuebutton(!1)},do_runner_advance:function(steps){try{null!==steps?this.runner.advance(steps):this.runner.advance()}catch(e){var userFriendlyError="Yarn Parse Error: "+e.message;this.controls.yarncontainer.html('<div class="alert alert-danger">'.concat(userFriendlyError,"</div>")),log.error("Full Yarn Error:"),log.error(e)}},can_continuebutton:function(cancontinue){this.controls.yarncontinuebutton.prop("disabled",!cancontinue),cancontinue?this.controls.yarncontinuebutton.show():this.controls.yarncontinuebutton.hide()},register_events:function(index,itemdata,quizhelper){var self=this;$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){var stepdata={};stepdata.index=index,stepdata.hasgrade=!1,stepdata.totalitems=0,stepdata.correctitems=0,stepdata.grade=0,quizhelper.do_next(stepdata)})),$("#"+itemdata.uniqueid+"_container").on("showElement",(async e=>{self.instance,itemdata.timelimit>0&&($("#"+itemdata.uniqueid+"_container .progress-container").show(),$("#"+itemdata.uniqueid+"_container .progress-container i").show(),$("#"+itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:itemdata.timelimit,onFinish:function(){$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").trigger("click")}}))})),this.controls.yarncontinuebutton.on("click",(function(e){log.debug("MiniLesson Fiction: yarn continue button clicked"),e.preventDefault(),self.do_runner_advance(),self.do_render()})),this.controls.yarncontainer.on("click",".minilesson_fiction_optionbutton",(function(e){log.debug("MiniLesson Fiction: yarn option button clicked"),e.preventDefault();var optionindex=self.controls.yarncontainer.find(".minilesson_fiction_optionbutton").index(this);self.do_runner_advance(optionindex),self.do_render()}))},add_metadata:function(currentthing){return currentthing&&"markup"in currentthing&&Array.isArray(currentthing.markup)&&(currentthing.md={},currentthing.markup.forEach((function(entry){"properties"in entry&&"name"in entry&&(currentthing.md[entry.name]=entry.properties)}))),currentthing},register_previewbutton:function(buttonid){var previewbtn=document.getElementById(buttonid);previewbtn&&previewbtn.addEventListener("click",(function(e){e.preventDefault();var form=previewbtn.form;form&&ModalFactory.create({type:ModalFactory.types.CANCEL,large:!0,removeOnClose:!0,templateContext:{classes:"minilesson-fiction-preview-modal"},title:Str.get_string("fiction:previewmodaltitle","mod_minilesson"),body:Fragment.loadFragment("mod_minilesson","preview_fiction",M.cfg.contextid,{formdata:new URLSearchParams([...new FormData(form).entries()]).toString()})}).then((function(modal){modal.getFooter().addClass("d-none"),modal.show()}))}))}}}));

//# sourceMappingURL=fiction.min.js.map