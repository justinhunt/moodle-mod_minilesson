define ("mod_minilesson/ttrecorder",["jquery","core/log","core/notification","core/ajax","mod_minilesson/ttaudiohelper","mod_minilesson/ttbrowserrec","core/str","mod_minilesson/timer","mod_minilesson/ttmsspeech"],function(a,b,c,d,e,f,g,h,i){"use strict";b.debug("TT Recorder: initialising");return{waveHeight:75,audio:{stream:null,blob:null,dataURI:null,start:null,end:null,isRecording:!1,isRecognizing:!1,isWaiting:!1,transcript:null},submitting:!1,owner:"",controls:{},uniqueid:null,audio_updated:null,maxtime:0,passagehash:null,region:null,asrurl:null,lang:null,browserrec:null,usebrowserrec:!1,currentTime:0,stt_guided:!1,currentPrompt:!1,speechtoken:"",speechtokenvalidseconds:"",speechtokentype:"",forcestreaming:!1,is_streaming:!1,using_msspeech:!1,msspeech_instance:null,strings:{},clone:function clone(){return a.extend(!0,{},this)},init:function init(a){var d=this;this.uniqueid=a.uniqueid;this.callback=a.callback;this.stt_guided=a.stt_guided?a.stt_guided:!1;this.init_strings();this.prepare_html();this.controls.recordercontainer.show();this.register_events();this.using_msspeech=this.can_msspeech();if(this.using_msspeech){var g=a.referencetext;this.msspeech_instance=i.clone();this.msspeech_instance.init(this.speechtoken,this.region,this.lang,g)}var j=function(){var a=d.timer.fetch_display_time();d.controls.timerstatus.html(a);b.debug("timer_seconds: "+d.timer.seconds);b.debug("displaytime: "+a);if(0==d.timer.seconds&&0<d.timer.initseconds){d.update_audio("isRecognizing",!0);if(d.usebrowserrec){d.browserrec.stop()}else{d.audiohelper.stop()}}},k=function(a){switch(a.name){case"PermissionDeniedError":case"NotAllowedError":c.alert("Error",d.strings.allowmicaccess,"OK");break;case"DevicesNotFoundError":case"NotFoundError":c.alert("Error",d.strings.nomicdetected,"OK");break;default:b.debug("Error",a.name);}},l=function(a){d.timer.stop();if(a===void 0){return}var e={blob:a,dataURI:URL.createObjectURL(a),end:new Date,isRecording:!1,length:Math.round((d.audio.end-d.audio.start)/1e3)};d.update_audio(e);if(!d.is_streaming){if(d.using_msspeech){d.do_msspeech(d.audio.blob,function(a){d.gotMSResults(a);d.update_audio("isRecognizing",!1)})}else{d.upload_transcribe(d.audio.blob,function(a){b.debug(a);if("success"===a.data.result&&a.data.transcript){d.gotRecognition(a.data.transcript.trim())}else{c.alert("Information",d.strings.speechnotrecognized,"OK")}d.update_audio("isRecognizing",!1)})}}},m=function(a){d.update_audio({stream:a,isRecording:!0,isWaiting:!1})};if(f.will_work_ok()&&!this.stt_guided&&!this.forcestreaming&&!this.using_msspeech){b.debug("using browser rec");this.browserrec=f.clone();this.browserrec.init(this.lang,this.waveHeight,this.uniqueid);this.usebrowserrec=!0;d.browserrec.onerror=k;d.browserrec.onend=function(){};d.browserrec.onstart=function(){};d.browserrec.onfinalspeechcapture=function(a){d.gotRecognition(a);d.update_audio("isRecording",!1);d.update_audio("isRecognizing",!1)};d.browserrec.oninterimspeechcapture=function(a){d.gotInterimRecognition(a)}}else if(this.can_stream()&&!this.stt_guided){this.is_streaming=!0;b.debug("using audio helper and streaming rec");this.audiohelper=e.clone();this.audiohelper.init(this.waveHeight,this.uniqueid,this);d.audiohelper.onError=k;d.audiohelper.onStop=l;d.audiohelper.onStream=m;d.audiohelper.onfinalspeechcapture=function(a){d.gotRecognition(a);d.update_audio("isRecording",!1);d.update_audio("isRecognizing",!1)};d.audiohelper.oninterimspeechcapture=function(a){d.gotInterimRecognition(a)}}else{b.debug("using upload_transcriber");this.audiohelper=e.clone();this.audiohelper.init(this.waveHeight,this.uniqueid,this);d.audiohelper.onError=k;d.audiohelper.onStop=l;d.audiohelper.onStream=m}b.debug("original speechtoken - "+this.speechtoken);b.debug("speechtokentype - "+this.speechtokentype);b.debug("speechtokenvalidseconds - "+this.speechtokenvalidseconds);this.init_token_refresh();this.timer=h.clone();this.timer.init(this.maxtime,j);j()},can_stream:function can_stream(){return this.speechtoken&&"false"!==this.speechtoken&&"assemblyai"===this.speechtokentype&&!this.stt_guided},can_msspeech:function can_msspeech(){return this.speechtoken&&"false"!==this.speechtoken&&"msspeech"===this.speechtokentype},update_currentprompt:function update_currentprompt(a){this.currentPrompt=a;if(this.using_msspeech){this.msspeech_instance.set_reference_text(a)}},blobToArrayBuffer:function blobToArrayBuffer(a){return new Promise(function(b,c){var d=new FileReader;d.onload=function(a){b(a.target.result)};d.onerror=function(a){c(a)};d.readAsArrayBuffer(a)})},init_strings:function init_strings(){var a=this;g.get_strings([{key:"allowmicaccess",component:"mod_minilesson"},{key:"nomicdetected",component:"mod_minilesson"},{key:"speechnotrecognized",component:"mod_minilesson"}]).done(function(b){var c=0;a.strings.allowmicaccess=b[c++];a.strings.nomicdetected=b[c++];a.strings.speechnotrecognized=b[c++]})},prepare_html:function prepare_html(){this.controls.recordercontainer=a("#ttrec_container_"+this.uniqueid);this.controls.recorderbutton=a("#"+this.uniqueid+"_recorderdiv");this.controls.waveform=a("#"+this.uniqueid+"_waveform");this.controls.timerstatus=a(".timerstatus_"+this.uniqueid);this.passagehash=this.controls.recorderbutton.data("passagehash");this.region=this.controls.recorderbutton.data("region");this.lang=this.controls.recorderbutton.data("lang");this.asrurl=this.controls.recorderbutton.data("asrurl");this.speechtoken=this.controls.recorderbutton.data("speechtoken");this.speechtokenvalidseconds=this.controls.recorderbutton.data("speechtokenvalidseconds");this.speechtokentype=this.controls.recorderbutton.data("speechtokentype");this.forcestreaming=this.controls.recorderbutton.data("forcestreaming");this.maxtime=this.controls.recorderbutton.data("maxtime");this.waveHeight=this.controls.recorderbutton.data("waveheight")},init_token_refresh:function init_token_refresh(){var a=this,c=+a.speechtokenvalidseconds||0;if(a.speechtoken&&0<c){var e=1e3*c;b.debug("Refreshing "+a.speechtokentype+" token after "+e+" milliseconds");if(0<e){setTimeout(function(){b.debug("Refreshing streaming token...");d.call([{methodname:"mod_minilesson_refresh_token",args:{type:a.speechtokentype,region:a.region},async:!1}])[0].then(function(c){b.debug("New token ajaxresult:",c);var d=JSON.parse(c);b.debug("New token received:",d);if(d&&d.token){a.speechtoken=d.token;a.speechtokenvalidseconds=d.validseconds;switch(a.speechtokentype){case"assemblyai":a.helper.streamer.updatetoken(d.token);break;case"msspeech":a.msspeech_instance.updatetoken(d.token);break;}b.debug("Streaming token refreshed successfully.");a.init_token_refresh()}else{b.debug("New token was not a token.")}})},e)}else{b.debug("Refresh interval is 0. Not refreshing token.")}}else{b.debug("No valid streaming token available, skipping refresh setup.")}},silence_detected:function silence_detected(){if(this.audio.isRecording){this.toggleRecording()}},update_audio:function update_audio(a,c){if("string"==typeof a){b.debug("update_audio:"+a+":"+c);if(this.audio[a]!==c){this.audio[a]=c;this.audio_updated()}}else{for(var d in a){this.audio[d]=a[d];b.debug("update_audio:"+d+":"+a[d])}this.audio_updated()}},register_events:function register_events(){var a=this;this.controls.recordercontainer.click(function(){a.toggleRecording()});this.audio_updated=function(){if(a.audio.isRecognizing||a.audio.isWaiting){a.show_recorder_pointer("none")}else{a.show_recorder_pointer("auto")}if(a.audio.isRecognizing||a.audio.isWaiting){this.controls.recorderbutton.removeClass("ttrec_ready");this.controls.recorderbutton.removeClass("ttrec_waiting");this.controls.waveform.removeClass("ttrec_waiting");this.controls.recorderbutton.removeClass("ttrec_isrecording");this.controls.recorderbutton.addClass("ttrec_engaged")}else if(a.audio.isRecording){this.controls.recorderbutton.removeClass("ttrec_ready");this.controls.waveform.removeClass("ttrec_waiting");this.controls.recorderbutton.removeClass("ttrec_waiting");this.controls.recorderbutton.removeClass("ttrec_engaged");this.controls.recorderbutton.addClass("ttrec_isrecording")}else if(a.audio.isWaiting&&!1){this.controls.recorderbutton.removeClass("ttrec_engaged");this.controls.recorderbutton.removeClass("ttrec_ready");this.controls.recorderbutton.removeClass("ttrec_isrecording");this.controls.recorderbutton.addClass("ttrec_waiting");this.controls.waveform.addClass("ttrec_waiting")}else{this.controls.recorderbutton.removeClass("ttrec_engaged");this.controls.recorderbutton.removeClass("ttrec_waiting");this.controls.recorderbutton.removeClass("ttrec_isrecording");this.controls.waveform.removeClass("ttrec_waiting");this.controls.recorderbutton.addClass("ttrec_ready")}a.controls.recorderbutton.html(a.recordBtnContent())}},show_recorder_pointer:function show_recorder_pointer(a){if(a){this.controls.recorderbutton.css("pointer-events","none")}else{this.controls.recorderbutton.css("pointer-events","auto")}},startedRecording:function startedRecording(){this.callback({type:"recording",results:""})},gotMSResults:function gotMSResults(a){b.debug(a);this.callback({type:"pronunciation_results",results:a})},gotRecognition:function gotRecognition(a){b.debug("transcript:"+a);if(""==a.trim()){return}this.callback({type:"speech",capturedspeech:a})},gotInterimRecognition:function gotInterimRecognition(a){this.callback({type:"interimspeech",capturedspeech:a})},cleanWord:function cleanWord(a){return a.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^_`{|}~']/g,"").toLowerCase()},recordBtnContent:function recordBtnContent(){if(!this.audio.isRecognizing){if(this.audio.isRecording){return"<i class=\"fa fa-stop\">"}else if(this.audio.isWaiting){return"<i class=\"fa fa-solid fa-cog fa-spin\">"}else{return"<i class=\"fa fa-microphone\">"}}else{return"<i class=\"fa fa-spinner fa-spin\">"}},toggleRecording:function toggleRecording(){var a=this;if(this.audio.isRecognizing||this.audio.isWaiting){return}if(this.audio.isRecording){a.timer.stop();if(this.usebrowserrec){a.update_audio("isRecording",!1);a.update_audio("isRecognizing",!0);this.browserrec.stop()}else{this.update_audio("isRecognizing",!0);this.audiohelper.stop()}}else{a.currentTime=0;a.timer.reset();a.timer.start();if(this.usebrowserrec){this.update_audio("isRecording",!0);this.browserrec.start()}else{var b={stream:null,blob:null,dataURI:null,start:new Date,end:null,isRecording:!1,isRecognizing:!1,isWaiting:!0,transcript:null};this.update_audio(b);this.audiohelper.start()}this.startedRecording()}},upload_transcribe:function upload_transcribe(a,c){var d=new FormData,e=this.uniqueid+Math.floor(100*Math.random())+".wav";d.append("audioFile",a,e);d.append("scorer",this.passagehash);if(this.stt_guided){d.append("strictmode","false")}else{d.append("strictmode","true")}if(!1!==this.currentPrompt){d.append("prompt",this.currentPrompt)}d.append("lang",this.lang);d.append("wwwroot",M.cfg.wwwroot);var f=new XMLHttpRequest;f.open("POST",this.asrurl,!0);f.onUploadProgress=function(){};f.onload=function(){if(200===f.status){c(JSON.parse(f.response))}else{c({data:{result:"error"}});b.debug(f.error)}};try{f.send(d)}catch(a){c({data:{result:"error"}});b.debug(a)}},do_msspeech:function do_msspeech(a,b){this.msspeech_instance.recognize(a,b)}}});
//# sourceMappingURL=ttrecorder.min.js.map
