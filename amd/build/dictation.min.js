define(["jquery","core/log","mod_minilesson/definitions","mod_minilesson/pollyhelper","core/templates"],(function($,log,def,polly,templates){return log.debug("MiniLesson dictation: initialising"),{playing:!1,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper,polly){this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index,this.prepare_audio(itemdata,polly),this.register_events(index,itemdata,quizhelper),this.getItems()},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{landr_targetWords:target.sentence.trim().split(self.quizhelper.spliton_regexp).filter((function(e){return""!==e})),target:target.sentence,audio:{},correct:!1}})).filter((function(e){return""!==e.target}))},prepare_html:function(itemdata){},prepare_audio:function(itemdata){$.each(itemdata.sentences,(function(index,sentence){polly.fetch_polly_url(sentence.prompt,itemdata.voiceoption,itemdata.usevoice).then((function(audiourl){$("#"+itemdata.uniqueid+"_container .dictationplayer_"+index+" .dictationtrigger").attr("data-src",audiourl)}))}))},show_item_review:function(){var self=this,review_data={};review_data.correctitems=$("#"+self.itemdata.uniqueid+"_container .dictate-feedback.fa-check").length,review_data.totalitems=$("#"+self.itemdata.uniqueid+"_container .dictate-feedback").length,$("#"+self.itemdata.uniqueid+"_container .dictationrow").each((function(index){self.items[index].audio.src=$(this).find(".dictationtrigger").attr("data-src"),self.items[index].correct=$(this).find(".dictate-feedback").hasClass("fa-check")})),review_data.items=self.items;var gamebox=$("#"+self.itemdata.uniqueid+"_container .ml_dictation_rows"),resultsbox=$("#"+self.itemdata.uniqueid+"_container .ml_dictation_resultscontainer");templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),templates.runTemplateJS(js)}))},next_question:function(){var stepdata={},correct=$("#"+this.itemdata.uniqueid+"_container .dictate-feedback.fa-check").length,total=$("#"+this.itemdata.uniqueid+"_container .dictate-feedback").length,grade=100*Math.round(correct/total,2);stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.grade=grade,stepdata.totalitems=total,stepdata.correctitems=correct,stepdata.grade=grade,this.quizhelper.do_next(stepdata)},register_events:function(qindex,itemdata,quizhelper){var self=this,theplayer=$("#"+itemdata.uniqueid+"_player");$("#"+itemdata.uniqueid+"_container .poodlldictationinput input").on("input",(function(e){var index=$(this).data("index"),correct=itemdata.sentences[index].sentence.trim().toLowerCase(),typed=$(this).val().trim().toLowerCase();$("#"+itemdata.uniqueid+"_container .dictationplayer_"+index+"_chars").html(typed.length),itemdata.ignorepunctuation&&(correct=quizhelper.cleanText(correct),typed=quizhelper.cleanText(typed)),correct==typed?$("#"+itemdata.uniqueid+"_container .dictate-feedback[data-index='"+index+"']").removeClass("fa-times").addClass("fa-check").css("color","green").show():$("#"+itemdata.uniqueid+"_container .dictate-feedback[data-index='"+index+"']").removeClass("fa-check").addClass("fa-times").css("color","red").show()})),$("#"+itemdata.uniqueid+"_container .dictationtrigger").on("click",(function(e){if(!self.playing){var el=this;self.playing=!0,theplayer.attr("src",$(this).attr("data-src")),theplayer[0].play(),theplayer[0].onended=function(){$(el).find(".fa").removeClass("fa-spin fa-spinner").addClass("fa-play"),self.playing=!1},$(el).find(".fa").removeClass("fa-play").addClass("fa-spin fa-spinner")}})),$("#"+itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",(function(e){var dictationcontainer=$("#"+self.itemdata.uniqueid+"_container .ml_dictation_rows");self.quizhelper.showitemreview&&dictationcontainer.is(":visible")?self.show_item_review():self.next_question()}))}}}));

//# sourceMappingURL=dictation.min.js.map