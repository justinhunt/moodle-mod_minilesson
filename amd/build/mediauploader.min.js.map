{"version":3,"file":"mediauploader.min.js","sources":["../src/mediauploader.js"],"sourcesContent":["/* jshint ignore:start */\ndefine(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\"; // jshint ;_;\n\n    log.debug('Media Uploader: initialising');\n\n    return {\n\n        config: null,\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        init: function (config) {\n            this.config = config;\n            this.config.sourcemimetype = 'audio/wav';\n            this.registerEvents();\n            this.fetchNewUploadDetails();\n        },\n\n        registerEvents: function () {\n            var that = this;\n            // Events here.\n        },\n\n        fetchNewUploadDetails: function () {\n\n            //The REST API we are calling\n            var functionname = 'local_cpapi_fetch_upload_details';\n\n            //fetch the Posturl. We need this.\n            //set up our ajax request\n            var xhr = new XMLHttpRequest();\n            var that = this;\n\n            //set up our handler for the response\n            xhr.onreadystatechange = function (e) {\n                if (this.readyState === 4) {\n                    if (xhr.status === 200) {\n                        // Get a yes or forget-it or try-again.\n                        var payload = xhr.responseText;\n                        var payloadobject = JSON.parse(payload);\n                        if (payloadobject) {\n                            // returnCode > 0  indicates an error\n                            if (payloadobject.returnCode > 0) {\n                                //We alert the iframe host that something did not go right\n                                var messageObject = {};\n                                messageObject.id = that.config.id;\n                                messageObject.type = \"error\";\n                                messageObject.code = payloadobject.returnCode;\n                                messageObject.message = payloadobject.returnMessage;\n                                that.message(messageObject);\n                                return;\n                                // If all good, then lets do the embed.\n                            } else {\n                                that.config.allowedURL = payloadobject.allowedURL;\n                                that.config.posturl = payloadobject.postURL;\n                                that.config.filename = payloadobject.filename;\n                                that.config.s3filename = payloadobject.s3filename;\n                                that.config.s3root = payloadobject.s3root;\n                                that.config.cloudfilename = payloadobject.shortfilename;\n                                that.config.cloudroot = payloadobject.shortroot;\n                            }\n                        } else {\n                            log.debug('error:' + payloadobject.message);\n                        }\n                    } else {\n                        log.debug('Not 200 response:' + xhr.status);\n                    }\n                }\n            };\n\n            //log.debug(params);\n            var xhrparams = \"wstoken=\" + this.config.wstoken\n                + \"&wsfunction=\" + functionname\n                + \"&moodlewsrestformat=\" + 'json'\n                + \"&mediatype=\" + this.config.mediatype\n                + '&parent=' + this.config.parent\n                + '&appid=' + this.config.appid\n                + '&owner=' + this.config.owner\n                + '&region=' + this.config.region\n                + '&expiredays=' + this.config.expiredays\n                + '&transcode=' + this.config.transcode\n                + '&transcoder=' + this.config.transcoder\n                + '&transcribe=' + this.config.transcribe\n                + '&subtitle=' + this.config.subtitle\n                + '&transcribelanguage=' + this.config.language\n                + '&transcribevocab=' + this.config.transcribevocab\n                + '&notificationurl=' + this.config.notificationurl\n                + '&sourcemimetype=' + this.config.sourcemimetype;\n\n            var serverurl = this.config.cloudpoodllurl + \"/webservice/rest/server.php\";\n            xhr.open(\"POST\", serverurl, true);\n            xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\n            xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\n            xhr.send(xhrparams);\n        },\n\n        uploadBlob: function (blob, sourcemimetype) {\n            this.uploadFile(blob, sourcemimetype);\n        },\n\n        //extract filename from the text returned as response to upload\n        extractFilename: function (returntext) {\n            var searchkey = \"success<filename>\";\n            var start = returntext.indexOf(searchkey);\n            if (start < 1) {\n                return false;\n            }\n            var end = returntext.indexOf(\"</filename>\");\n            var filename = returntext.substring(start + (searchkey.length), end);\n            return filename;\n        },\n\n        //fetch file extension from the filetype\n        fetchFileExtension: function (filetype) {\n            var ext = \"\";\n            //in the case of a string like this:\n            // \"audio/webm;codecs=opus\" we do not the codecs\n            if (filetype.indexOf(';') > 0) {\n                filetype = filetype.split(';')[0];\n            }\n            switch (filetype) {\n                case \"image/jpeg\":\n                    ext = \"jpg\";\n                    break;\n                case \"image/png\":\n                    ext = \"png\";\n                    break;\n                case \"audio/wav\":\n                    ext = \"wav\";\n                    break;\n                case \"audio/ogg\":\n                    ext = \"ogg\";\n                    break;\n                case \"audio/mpeg3\":\n                    ext = \"mp3\";\n                    break;\n                case \"audio/mp3\":\n                    ext = \"mp3\";\n                    break;\n                case \"audio/webm\":\n                    ext = \"webm\";\n                    break;\n                case \"audio/wma\":\n                    ext = \"wma\";\n                    break;\n                case \"audio/x-mpeg-3\":\n                    ext = \"mp3\";\n                    break;\n                case \"audio/mp4\":\n                case \"audio/m4a\":\n                case \"audio/x-m4a\":\n                    ext = \"m4a\";\n                    break;\n                case \"audio/3gpp\":\n                    ext = \"3gpp\";\n                    break;\n                case \"video/mpeg3\":\n                    ext = \"3gpp\";\n                    break;\n                case \"video/m4v\":\n                    ext = \"m4v\";\n                    break;\n                case \"video/mp4\":\n                    ext = \"mp4\";\n                    break;\n                case \"video/mov\":\n                case \"video/quicktime\":\n                    ext = \"mov\";\n                    break;\n                case \"video/x-matroska\":\n                case \"video/webm\":\n                    ext = \"webm\";\n                    break;\n                case \"video/wmv\":\n                    ext = \"wmv\";\n                    break;\n                case \"video/ogg\":\n                    ext = \"ogg\";\n                    break;\n            }\n            //if we get here we have an unknown mime type, just guess based on the mediatype\n            if (ext === \"\") {\n                if (filetype.indexOf('video') > -1) {\n                    ext = \"mp4\";\n                } else {\n                    ext = \"mp3\";\n                }\n            }\n            return ext;\n        },\n\n        doUploadCompleteCallback: function (uploader, filename) {\n\n            filename = uploader.config.s3root + uploader.config.s3filename;\n\n            //For callbackjs and for postmessage we need an array of stuff\n            var callbackObject = [];\n            callbackObject[0] = uploader.config.widgetid;\n            callbackObject[1] = \"filesubmitted\";\n            callbackObject[2] = filename;\n            callbackObject[3] = uploader.config.updatecontrol;\n            callbackObject[4] = uploader.config.s3filename;\n\n            //invoke callbackjs if we have one\n            if (uploader.config.callbackjs && uploader.config.callbackjs !== '') {\n                if (typeof(uploader.config.callbackjs) === 'function') {\n                    uploader.config.callbackjs(callbackObject);\n                }\n            }\n\n        },\n\n        //after an upload handle the filename poke and callback call\n        postProcessUpload: function (e, uploader) {\n            var xhr = e.currentTarget;\n            if (xhr.readyState === 4) {\n                if (xhr.status === 200) {\n                    var filename = uploader.config.filename;\n                    if (!filename) {\n                        filename = uploader.extractFilename(xhr.responseText);\n                    }\n                    if (!filename) {\n                        log.debug('upload failed #1');\n                        log.debug(xhr);\n                        return;\n                    }\n                    //Alert any listeners about the upload complete\n                    this.doUploadCompleteCallback(uploader, filename);\n\n                    //Fetch new upload details for next time\n                    this.fetchNewUploadDetails(); // Prepare for next upload.\n                } else {\n                    log.debug('upload failed #3');\n                    log.debug(xhr);\n                } //end of if status 200\n            }//end of if ready state 4\n        },\n\n        // upload Media file to wherever\n        uploadFile: function (filedata, sourcemimetype) {\n\n            var xhr = new XMLHttpRequest();\n            var config = this.config;\n            var uploader = this;\n\n            //get the file extension from the filetype\n            var sourceext = this.fetchFileExtension(sourcemimetype);\n\n\n            //are we using s3\n            var using_s3 = config.using_s3;\n\n\n            //init sourcemimetype and sourcefilename\n            uploader.config.sourcemimetype = sourcemimetype;\n            uploader.config.sourcefilename = uploader.config.s3filename;\n\n            xhr.onreadystatechange = function (e) {\n                if (using_s3 && this.readyState === 4) {\n                    uploader.update_filenames(uploader, sourceext);\n                }\n                uploader.postProcessUpload(e, uploader);\n\n            };\n\n            xhr.open(\"put\", config.posturl, true);\n            xhr.setRequestHeader(\"Content-Type\", 'application/octet-stream');\n            xhr.send(filedata);\n\n        },\n\n        update_filenames: function (uploader, sourceext) {\n            var config = uploader.config;\n\n            //now its a bit hacky, but\n            // only now do we know the true final file extension (ext) and mimetype of unconv. media\n            // so we want to save that and if the user is NOT transcoding,\n            //we want to change the s3filename from the default mp4/mp3 to whatever the mimetype inidicates, ie sourceext\n\n            switch (config.mediatype) {\n                case 'audio':\n                    //source info\n                    uploader.config.sourcefilename = config.s3filename.replace('.mp3', '.' + sourceext);\n                    if (!config.transcode) {\n                        uploader.config.s3filename = uploader.config.sourcefilename;\n                        //do we need this, I think its old and noone uses it.\n                        uploader.config.cloudfilename = uploader.config.s3filename;\n                    }\n                    break;\n                case 'video':\n                    uploader.config.sourcefilename = config.s3filename.replace('.mp4', '.' + sourceext);\n                    if (!config.transcode) {\n                        uploader.config.s3filename = uploader.config.sourcefilename;\n                    }\n                    break;\n            }\n        },\n\n\n        dataURItoBlob: function (dataURI, mimetype) {\n            var byteString = atob(dataURI.split(',')[1]);\n            var ab = new ArrayBuffer(byteString.length);\n            var ia = new Uint8Array(ab);\n            for (var i = 0; i < byteString.length; i++) {\n                ia[i] = byteString.charCodeAt(i);\n            }\n            return new Blob([ab], {type: mimetype});\n        },//end of dataURItoBlob\n\n        message : function (messageobject) {\n            log.debug('Media Uploader Message: ' + messageobject.code + ' : ' + messageobject.message);\n        }\n\n    };//end of returned object\n});//total end\n"],"names":["define","$","log","debug","config","clone","extend","this","init","sourcemimetype","registerEvents","fetchNewUploadDetails","xhr","XMLHttpRequest","that","onreadystatechange","e","readyState","status","payload","responseText","payloadobject","JSON","parse","returnCode","messageObject","id","type","code","message","returnMessage","allowedURL","posturl","postURL","filename","s3filename","s3root","cloudfilename","shortfilename","cloudroot","shortroot","xhrparams","wstoken","mediatype","parent","appid","owner","region","expiredays","transcode","transcoder","transcribe","subtitle","language","transcribevocab","notificationurl","serverurl","cloudpoodllurl","open","setRequestHeader","send","uploadBlob","blob","uploadFile","extractFilename","returntext","start","indexOf","end","substring","length","fetchFileExtension","filetype","ext","split","doUploadCompleteCallback","uploader","callbackObject","widgetid","updatecontrol","callbackjs","postProcessUpload","currentTarget","filedata","sourceext","using_s3","sourcefilename","update_filenames","replace","dataURItoBlob","dataURI","mimetype","byteString","atob","ab","ArrayBuffer","ia","Uint8Array","i","charCodeAt","Blob","messageobject"],"mappings":"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"}