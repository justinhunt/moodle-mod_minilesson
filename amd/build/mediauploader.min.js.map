{"version":3,"file":"mediauploader.min.js","sources":["../src/mediauploader.js"],"sourcesContent":["/* jshint ignore:start */\r\ndefine(['jquery', 'core/log'], function ($, log) {\r\n\r\n    \"use strict\"; // jshint ;_;\r\n\r\n    log.debug('Media Uploader: initialising');\r\n\r\n    return {\r\n\r\n        config: null,\r\n\r\n        //for making multiple instances\r\n        clone: function () {\r\n            return $.extend(true, {}, this);\r\n        },\r\n\r\n        init: function (config) {\r\n            this.config = config;\r\n            this.config.sourcemimetype = 'audio/wav';\r\n            this.registerEvents();\r\n            this.fetchNewUploadDetails();\r\n        },\r\n\r\n        registerEvents: function () {\r\n            var that = this;\r\n            // Events here.\r\n        },\r\n\r\n        fetchNewUploadDetails: function () {\r\n\r\n            //The REST API we are calling\r\n            var functionname = 'local_cpapi_fetch_upload_details';\r\n\r\n            //fetch the Posturl. We need this.\r\n            //set up our ajax request\r\n            var xhr = new XMLHttpRequest();\r\n            var that = this;\r\n\r\n            //set up our handler for the response\r\n            xhr.onreadystatechange = function (e) {\r\n                if (this.readyState === 4) {\r\n                    if (xhr.status === 200) {\r\n\r\n                        // Get a yes or forget-it or try-again.\r\n                        var payload = xhr.responseText;\r\n                        var payloadobject = JSON.parse(payload);\r\n                        if (payloadobject) {\r\n                            // returnCode > 0  indicates an error\r\n                            if (payloadobject.returnCode > 0) {\r\n                                //We alert the iframe host that something did not go right\r\n                                var messageObject = {};\r\n                                messageObject.id = that.config.id;\r\n                                messageObject.type = \"error\";\r\n                                messageObject.code = payloadobject.returnCode;\r\n                                messageObject.message = payloadobject.returnMessage;\r\n                                that.message(messageObject);\r\n                                return;\r\n                                // If all good, then lets do the embed.\r\n                            } else {\r\n                                that.config.allowedURL = payloadobject.allowedURL;\r\n                                that.config.posturl = payloadobject.postURL;\r\n                                that.config.filename = payloadobject.filename;\r\n                                that.config.s3filename = payloadobject.s3filename;\r\n                                that.config.s3root = payloadobject.s3root;\r\n                                that.config.cloudfilename = payloadobject.shortfilename;\r\n                                that.config.cloudroot = payloadobject.shortroot;\r\n                            }\r\n                        } else {\r\n                            log.debug('error:' + payloadobject.message);\r\n                        }\r\n                    } else {\r\n                        log.debug('Not 200 response:' + xhr.status);\r\n                    }\r\n                }\r\n            };\r\n\r\n            //log.debug(params);\r\n            var xhrparams = \"wstoken=\" + this.config.wstoken\r\n                + \"&wsfunction=\" + functionname\r\n                + \"&moodlewsrestformat=\" + 'json'\r\n                + \"&mediatype=\" + this.config.mediatype\r\n                + '&parent=' + this.config.parent\r\n                + '&appid=' + this.config.appid\r\n                + '&owner=' + this.config.owner\r\n                + '&region=' + this.config.region\r\n                + '&expiredays=' + this.config.expiredays\r\n                + '&transcode=' + this.config.transcode\r\n                + '&transcoder=' + this.config.transcoder\r\n                + '&transcribe=' + this.config.transcribe\r\n                + '&subtitle=' + this.config.subtitle\r\n                + '&transcribelanguage=' + this.config.language\r\n                + '&transcribevocab=' + this.config.transcribevocab\r\n                + '&notificationurl=' + this.config.notificationurl\r\n                + '&sourcemimetype=' + this.config.sourcemimetype;\r\n\r\n            var serverurl = this.config.cloudpoodllurl + \"/webservice/rest/server.php\";\r\n            xhr.open(\"POST\", serverurl, true);\r\n            xhr.setRequestHeader(\"Cache-Control\", \"no-cache\");\r\n            xhr.setRequestHeader(\"Content-Type\", \"application/x-www-form-urlencoded\");\r\n            xhr.send(xhrparams);\r\n        },\r\n\r\n        uploadBlob: function (blob, sourcemimetype) {\r\n            this.uploadFile(blob, sourcemimetype);\r\n        },\r\n\r\n        //extract filename from the text returned as response to upload\r\n        extractFilename: function (returntext) {\r\n            var searchkey = \"success<filename>\";\r\n            var start = returntext.indexOf(searchkey);\r\n            if (start < 1) {\r\n                return false;\r\n            }\r\n            var end = returntext.indexOf(\"</filename>\");\r\n            var filename = returntext.substring(start + (searchkey.length), end);\r\n            return filename;\r\n        },\r\n\r\n        //fetch file extension from the filetype\r\n        fetchFileExtension: function (filetype) {\r\n            var ext = \"\";\r\n            //in the case of a string like this:\r\n            // \"audio/webm;codecs=opus\" we do not the codecs\r\n            if(filetype.indexOf(';')>0){\r\n                filetype = filetype.split(';')[0];\r\n            }\r\n            switch (filetype) {\r\n                case \"image/jpeg\":\r\n                    ext = \"jpg\";\r\n                    break;\r\n                case \"image/png\":\r\n                    ext = \"png\";\r\n                    break;\r\n                case \"audio/wav\":\r\n                    ext = \"wav\";\r\n                    break;\r\n                case \"audio/ogg\":\r\n                    ext = \"ogg\";\r\n                    break;\r\n                case \"audio/mpeg3\":\r\n                    ext = \"mp3\";\r\n                    break;\r\n                case \"audio/mp3\":\r\n                    ext = \"mp3\";\r\n                    break;\r\n                case \"audio/webm\":\r\n                    ext = \"webm\";\r\n                    break;\r\n                case \"audio/wma\":\r\n                    ext = \"wma\";\r\n                    break;\r\n                case \"audio/x-mpeg-3\":\r\n                    ext = \"mp3\";\r\n                    break;\r\n                case \"audio/mp4\":\r\n                case \"audio/m4a\":\r\n                case \"audio/x-m4a\":\r\n                    ext = \"m4a\";\r\n                    break;\r\n                case \"audio/3gpp\":\r\n                    ext = \"3gpp\";\r\n                    break;\r\n                case \"video/mpeg3\":\r\n                    ext = \"3gpp\";\r\n                    break;\r\n                case \"video/m4v\":\r\n                    ext = \"m4v\";\r\n                    break;\r\n                case \"video/mp4\":\r\n                    ext = \"mp4\";\r\n                    break;\r\n                case \"video/mov\":\r\n                case \"video/quicktime\":\r\n                    ext = \"mov\";\r\n                    break;\r\n                case \"video/x-matroska\":\r\n                case \"video/webm\":\r\n                    ext = \"webm\";\r\n                    break;\r\n                case \"video/wmv\":\r\n                    ext = \"wmv\";\r\n                    break;\r\n                case \"video/ogg\":\r\n                    ext = \"ogg\";\r\n                    break;\r\n            }\r\n            //if we get here we have an unknown mime type, just guess based on the mediatype\r\n            if(ext===\"\"){\r\n                if(filetype.indexOf('video')>-1){\r\n                    ext = \"mp4\";\r\n                }else{\r\n                    ext = \"mp3\";\r\n                }\r\n            }\r\n            return ext;\r\n        },\r\n\r\n        doUploadCompleteCallback: function (uploader, filename) {\r\n\r\n            filename = uploader.config.s3root + uploader.config.s3filename;\r\n\r\n            //For callbackjs and for postmessage we need an array of stuff\r\n            var callbackObject = [];\r\n            callbackObject[0] = uploader.config.widgetid;\r\n            callbackObject[1] = \"filesubmitted\";\r\n            callbackObject[2] = filename;\r\n            callbackObject[3] = uploader.config.updatecontrol;\r\n            callbackObject[4] = uploader.config.s3filename;\r\n\r\n            //invoke callbackjs if we have one\r\n            if (uploader.config.callbackjs && uploader.config.callbackjs !== '') {\r\n                if (typeof(uploader.config.callbackjs) === 'function') {\r\n                    uploader.config.callbackjs(callbackObject);\r\n                }\r\n            }\r\n\r\n        },\r\n\r\n        //after an upload handle the filename poke and callback call\r\n        postProcessUpload: function (e, uploader) {\r\n            var xhr = e.currentTarget;\r\n            if (xhr.readyState === 4) {\r\n                if (xhr.status === 200) {\r\n                    var filename = uploader.config.filename;\r\n                    if (!filename) {\r\n                        filename = uploader.extractFilename(xhr.responseText);\r\n                    }\r\n                    if (!filename) {\r\n                        log.debug('upload failed #1');\r\n                        log.debug(xhr);\r\n                        return;\r\n                    }\r\n                    //Alert any listeners about the upload complete\r\n                    this.doUploadCompleteCallback(uploader, filename);\r\n\r\n                    //Fetch new upload details for next time\r\n                    this.fetchNewUploadDetails(); // Prepare for next upload.\r\n\r\n                } else {\r\n                    log.debug('upload failed #3');\r\n                    log.debug(xhr);\r\n                } //end of if status 200\r\n            }//end of if ready state 4\r\n        },\r\n\r\n        // upload Media file to wherever\r\n        uploadFile: function (filedata, sourcemimetype) {\r\n\r\n            var xhr = new XMLHttpRequest();\r\n            var config = this.config;\r\n            var uploader = this;\r\n\r\n            //get the file extension from the filetype\r\n            var sourceext = this.fetchFileExtension(sourcemimetype);\r\n\r\n\r\n            //are we using s3\r\n            var using_s3 = config.using_s3;\r\n\r\n\r\n            //init sourcemimetype and sourcefilename\r\n            uploader.config.sourcemimetype = sourcemimetype;\r\n            uploader.config.sourcefilename = uploader.config.s3filename;\r\n\r\n            xhr.onreadystatechange = function (e) {\r\n                if (using_s3 && this.readyState === 4) {\r\n                   uploader.update_filenames(uploader, sourceext);\r\n                }\r\n                uploader.postProcessUpload(e, uploader);\r\n\r\n            };\r\n\r\n            xhr.open(\"put\", config.posturl, true);\r\n            xhr.setRequestHeader(\"Content-Type\", 'application/octet-stream');\r\n            xhr.send(filedata);\r\n\r\n        },\r\n\r\n        update_filenames: function (uploader, sourceext) {\r\n            var config = uploader.config;\r\n\r\n            //now its a bit hacky, but\r\n            // only now do we know the true final file extension (ext) and mimetype of unconv. media\r\n            // so we want to save that and if the user is NOT transcoding,\r\n            //we want to change the s3filename from the default mp4/mp3 to whatever the mimetype inidicates, ie sourceext\r\n\r\n            switch (config.mediatype) {\r\n                case 'audio':\r\n                    //source info\r\n                    uploader.config.sourcefilename = config.s3filename.replace('.mp3', '.' + sourceext);\r\n                    if (!config.transcode) {\r\n                        uploader.config.s3filename = uploader.config.sourcefilename;\r\n                        //do we need this, I think its old and noone uses it.\r\n                        uploader.config.cloudfilename = uploader.config.s3filename;\r\n                    }\r\n                    break;\r\n                case 'video':\r\n                    uploader.config.sourcefilename = config.s3filename.replace('.mp4', '.' + sourceext);\r\n                    if (!config.transcode) {\r\n                        uploader.config.s3filename = uploader.config.sourcefilename;\r\n                    }\r\n                    break;\r\n            }\r\n        },\r\n\r\n\r\n        dataURItoBlob: function (dataURI, mimetype) {\r\n            var byteString = atob(dataURI.split(',')[1]);\r\n            var ab = new ArrayBuffer(byteString.length);\r\n            var ia = new Uint8Array(ab);\r\n            for (var i = 0; i < byteString.length; i++) {\r\n                ia[i] = byteString.charCodeAt(i);\r\n            }\r\n            return new Blob([ab], {type: mimetype});\r\n        },//end of dataURItoBlob\r\n\r\n        message : function(messageobject){\r\n            log.debug('Media Uploader Message: ' + messageobject.code + ' : ' + messageobject.message);\r\n        }\r\n\r\n    };//end of returned object\r\n});//total end\r\n"],"names":["define","$","log","debug","config","clone","extend","this","init","sourcemimetype","registerEvents","fetchNewUploadDetails","xhr","XMLHttpRequest","that","onreadystatechange","e","readyState","status","payload","responseText","payloadobject","JSON","parse","returnCode","messageObject","id","type","code","message","returnMessage","allowedURL","posturl","postURL","filename","s3filename","s3root","cloudfilename","shortfilename","cloudroot","shortroot","xhrparams","wstoken","mediatype","parent","appid","owner","region","expiredays","transcode","transcoder","transcribe","subtitle","language","transcribevocab","notificationurl","serverurl","cloudpoodllurl","open","setRequestHeader","send","uploadBlob","blob","uploadFile","extractFilename","returntext","start","indexOf","end","substring","length","fetchFileExtension","filetype","ext","split","doUploadCompleteCallback","uploader","callbackObject","widgetid","updatecontrol","callbackjs","postProcessUpload","currentTarget","filedata","sourceext","using_s3","sourcefilename","update_filenames","replace","dataURItoBlob","dataURI","mimetype","byteString","atob","ab","ArrayBuffer","ia","Uint8Array","i","charCodeAt","Blob","messageobject"],"mappings":"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"}