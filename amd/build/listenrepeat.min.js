define(["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss","core/templates","core/str","core/notification"],(function($,log,ajax,def,polly,ttrecorder,anim,templates,str,notification){return log.debug("MiniLesson listen and repeat: initialising"),{ttrec:null,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){var self=this,theCallback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("speech at listen_repeat"),self.getComparison(self.items[self.game.pointer].target,message.capturedspeech,self.items[self.game.pointer].phonetic,(function(comparison){self.gotComparison(comparison,message)}))}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),opts.wwwroot=quizhelper.is_stt_guided(),self.ttrec=ttrecorder.clone(),self.ttrec.init(opts)}else cloudpoodll.init("minilesson-recorder-listenrepeat-"+itemdata.id,theCallback);self.itemdata=itemdata,self.quizhelper=quizhelper,self.index=index,self.strings={};var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),self.init_controls(),self.init_strings(),self.register_events(),self.setvoice(),self.getItems()},init_controls:function(){this.controls={container:$("#"+this.itemdata.uniqueid+"_container"),nextbutton:$("#"+this.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:$("#"+this.itemdata.uniqueid+"_container .landr_start_btn"),skip_btn:$("#"+this.itemdata.uniqueid+"_container .landr_skip_btn"),ctrl_btn:$("#"+this.itemdata.uniqueid+"_container .landr_ctrl-btn"),game:$("#"+this.itemdata.uniqueid+"_container .landr_game"),controlsbox:$("#"+this.itemdata.uniqueid+"_container .landr_controls"),resultscontainer:$("#"+this.itemdata.uniqueid+"_container .landr_resultscontainer"),speakbtncontainer:$("#"+this.itemdata.uniqueid+"_container .landr_speakbtncontainer"),mainmenu:$("#"+this.itemdata.uniqueid+"_container .landr_mainmenu"),title:$("#"+this.itemdata.uniqueid+"_container .landr_title"),question:$("#"+this.itemdata.uniqueid+"_container .landr_question"),speech_container:$("#"+this.itemdata.uniqueid+"_container .landr_speechcontainer"),landr_correctfeedback:$("#"+this.itemdata.uniqueid+"_container .landr_correctfeedback"),landr_incorrectfeedback:$("#"+this.itemdata.uniqueid+"_container .landr_incorrectfeedback"),landr_fbcontainer:$("#"+this.itemdata.uniqueid+"_container .landr_fbcontainer"),landr_feedback:$("#"+this.itemdata.uniqueid+"_container .landr_feedback"),landr_listen_btn:$("#"+this.itemdata.uniqueid+"_container .landr_listen_btn"),progress_container:$("#"+this.itemdata.uniqueid+"_container .progress-container")}},init_strings:function(){var self=this;str.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done((function(s){var i=0;self.strings.nextlessonitem=s[i++],self.strings.confirm_desc=s[i++],self.strings.yes=s[i++],self.strings.no=s[i++]}))},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.stop_audio(),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var gamebox=this.controls.game,controlsbox=this.controls.controlsbox,recorderbox=this.controls.speakbtncontainer,resultsbox=this.controls.resultscontainer,audioplayerbtn=this.controls.landr_listen_btn;templates.render("mod_minilesson/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),recorderbox.hide(),audioplayerbtn.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;self.controls.nextbutton.on("click",(function(e){self.items.some((item=>!item.answered))?notification.confirm(self.strings.nextlessonitem,self.strings.confirm_desc,self.strings.yes,self.strings.no,(function(){self.next_question()})):self.next_question()})),self.controls.start_btn.on("click",(function(){self.start()}));var audioplayerbtn=self.controls.landr_listen_btn;audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-stop"),$(audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),self.controls.skip_btn.on("click",(function(){self.controls.ctrl_btn.prop("disabled",!0),self.controls.container.find(".landr_speech.landr_teacher_left").text(self.items[self.game.pointer].displayprompt+""),self.controls.container.find(".landr_word_input").each((function(){var realidx=$(this).data("realidx"),landr_word_input=self.items[self.game.pointer].landr_targetWords[realidx];$(this).val(landr_word_input)})),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1?(self.controls.skip_btn.prop("disabled",!0),self.controls.skip_btn.children(".fa").removeClass("fa-arrow-right"),self.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin"),setTimeout((function(){self.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin"),self.controls.skip_btn.children(".fa").addClass("fa-arrow-right"),self.controls.skip_btn.prop("disabled",!1),self.game.pointer++,self.nextPrompt()}),2200)):self.end()}))},game:{pointer:0},usevoice:"",setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{landr_targetWords:target.sentence.trim().split(self.quizhelper.spliton_regexp).filter((function(e){return""!==e})),target:target.sentence,prompt:target.prompt,displayprompt:target.displayprompt,phonetic:target.phonetic,typed:"",answered:!1,correct:!1,audio:null,timer:[],audiourl:target.audiourl?target.audiourl:"",imageurl:target.imageurl}})).filter((function(e){return""!==e.target})),$.each(self.items,(function(index,item){item.audio=new Audio,item.audio.src=item.audiourl,0===self.items.filter((function(e){return null===e.audio})).length&&self.appReady()}))},appReady:function(){this.controls.container.find(".landr_not_loaded").hide(),this.controls.container.find(".landr_loaded").show(),this.itemdata.hidestartpage?this.start():this.controls.start_btn.prop("disabled",!1)},gotComparison:function(comparison,typed){var self=this;if(self.controls.container.find(".landr_word_input").removeClass("landr_correct landr_incorrect"),self.controls.container.find(".landr_feedback_icon").removeClass("fa fa-check fa-times"),0==comparison.filter((function(e){return!e.matched})).length&&comparison&&comparison.length>0)self.controls.container.find(".landr_word_input").addClass("landr_correct"),self.controls.container.find(".landr_feedback_icon").addClass("fa fa-check"),self.controls.container.find(".landr_speech.landr_teacher_left").text(self.items[self.game.pointer].displayprompt+""),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=typed,self.stopTimer(self.items[self.game.pointer].timer),self.controls.ctrl_btn.prop("disabled",!0),self.game.pointer<self.items.length-1?setTimeout((function(){self.game.pointer++,self.nextPrompt()}),2200):self.end();else{comparison.forEach((function(obj){obj.matched?(self.controls.container.find('.landr_word_input[data-idx="'+obj.wordnumber+'"]').addClass("landr_correct"),self.controls.container.find('.landr_feedback_icon[data-idx="'+obj.wordnumber+'"]').addClass("fa fa-check")):(self.controls.container.find('.landr_word_input[data-idx="'+obj.wordnumber+'"]').addClass("landr_incorrect"),self.controls.container.find('.landr_feedback_icon[data-idx="'+obj.wordnumber+'"]').addClass("fa fa-times"))}));var thereply=self.controls.container.find(".landr_reply_"+self.game.pointer);anim.do_animate(thereply,"shakeX animate__faster").then((function(){self.controls.ctrl_btn.prop("disabled",!1)}))}self.controls.container.find(".landr_word_input.landr_correct").each((function(){var realidx=$(this).data("realidx"),landr_word_input=self.items[self.game.pointer].landr_targetWords[realidx];$(this).val(landr_word_input)}))},getWords:function(thetext){for(var chunks=thetext.split(this.quizhelper.spliton_regexp).filter((function(e){return""!==e})),words=[],i=0;i<chunks.length;i++)chunks[i].match(this.quizhelper.spliton_regexp)||words.push(chunks[i]);return words},getComparison:function(passage,transcript,phonetic,callback){this.controls.ctrl_btn.prop("disabled",!0),this.quizhelper.comparePassageToTranscript(passage,transcript,phonetic,this.itemdata.language,this.itemdata.alternates).then((function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)}))},end:function(){var self=this;self.controls.nextbutton.prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){self.controls.nextbutton.prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2200)},start:function(){this.controls.ctrl_btn.prop("disabled",!0),this.controls.speakbtncontainer.show(),this.controls.title.show(),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,this.controls.game.show(),this.controls.start_btn.hide(),this.controls.container.find(".landr_listen_cont").show(),this.controls.mainmenu.hide(),this.controls.controlsbox.show(),this.nextPrompt()},nextPrompt:function(){var showText=parseInt(this.itemdata.show_text),self=this,target=self.items[self.game.pointer].target;self.quizhelper.use_ttrecorder()&&(self.ttrec.currentPrompt=target);var displayprompt=self.items[self.game.pointer].displayprompt;if(showText)showprompt=displayprompt;else var showprompt=displayprompt.replace(self.quizhelper.nopunc_regexp,"").replace(self.quizhelper.nonspaces_regexp,"•");templates.render("mod_minilesson/listenrepeat_prompt",{showprompt:showprompt,pointer:self.game.pointer}).then((function(html,js){self.controls.game.html(html),self.controls.ctrl_btn.prop("disabled",!1),self.updateProgressDots();var newprompt=self.controls.container.find(".landr_prompt_"+self.game.pointer);anim.do_animate(newprompt,"zoomIn animate__faster","in").then((function(){})),self.nextReply()}))},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");self.controls.title.html(progress)},nextReply:function(){var self=this,idx=0,words=self.items[self.game.pointer].landr_targetWords.map((function(word,realidx){var theword={};return word.match(self.quizhelper.spliton_regexp)?(theword.isword=!1,theword.text=word):(idx++,theword.isword=!0,theword.idx=idx,theword.length=word.length,theword.lengthplusone=word.length+1,theword.realidx=realidx),theword})),displaytimer=self.itemdata.timelimit>0;templates.render("mod_minilesson/listenrepeat_reply",{words:words,pointer:self.game.pointer,imageurl:self.items[self.game.pointer].imageurl,displaytimer:displaytimer}).then((function(html,js){self.controls.game.append(html);var newreply=self.controls.container.find(".landr_reply_"+self.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),self.controls.ctrl_btn.prop("disabled",!1),self.quizhelper.mobile_user()||(self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{setTimeout((function(){self.controls.landr_listen_btn.trigger("click")}),1e3)})):setTimeout((function(){self.controls.landr_listen_btn.trigger("click")}),1e3)),displaytimer&&self.startTimer()}))},stop_audio:function(){var theaudio=this.items[this.game.pointer].audio;theaudio&&!theaudio.paused&&theaudio.pause()},startTimer:function(){var self=this,progress_container=self.controls.progress_container;if(self.itemdata.timelimit>0){var doStartTimer=function(){progress_container.show(),progress_container.find("i").show(),progress_container.find("#progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){self.controls.skip_btn.trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))}))};self.itemdata.hidestartpage&&0===self.game.pointer?self.controls.container.on("showElement",(()=>{doStartTimer()})):doStartTimer()}},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))}}}));

//# sourceMappingURL=listenrepeat.min.js.map