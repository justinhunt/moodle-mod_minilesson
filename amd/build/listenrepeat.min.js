define ("mod_minilesson/listenrepeat",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss","core/templates"],function(a,b,c,d,e,f,g,h){"use strict";b.debug("MiniLesson listen and repeat: initialising");return{ttrec:null,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){var e=this,h=function(a){switch(a.type){case"recording":break;case"speech":b.debug("speech at listen_repeat");e.getComparison(e.items[e.game.pointer].target,a.capturedspeech,e.items[e.game.pointer].phonetic,function(b){e.gotComparison(b,a)});break;}};if(d.use_ttrecorder()){var i={uniqueid:c.uniqueid,callback:h,stt_guided:d.is_stt_guided(),wwwroot:d.is_stt_guided()};e.ttrec=f.clone();e.ttrec.init(i)}else{cloudpoodll.init("minilesson-recorder-listenrepeat-"+c.id,h)}e.itemdata=c;e.quizhelper=d;e.index=a;var j={useanimatecss:d.useanimatecss};g.init(j);e.register_events();e.setvoice();e.getItems()},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.stop_audio();a.quizhelper.do_next(b)},show_item_review:function show_item_review(){var b=this,c={};c.items=b.items;c.totalitems=b.items.length;c.correctitems=b.items.filter(function(a){return a.correct}).length;var d=a("#"+b.itemdata.uniqueid+"_container .landr_game"),e=a("#"+b.itemdata.uniqueid+"_container .landr_controls"),f=a("#"+b.itemdata.uniqueid+"_container .landr_speakbtncontainer"),g=a("#"+b.itemdata.uniqueid+"_container .landr_resultscontainer");h.render("mod_minilesson/listitemresults",c).then(function(a,b){g.html(a);g.show();d.hide();e.hide();f.hide();h.runTemplateJS(b)})},register_events:function register_events(){var b=this;a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton").on("click",function(){b.next_question()});a("#"+b.itemdata.uniqueid+"_container .landr_start_btn").on("click",function(){b.start()});var c=a("#"+b.itemdata.uniqueid+"_container .landr_listen_btn");c.on("click",function(){var d=b.items[b.game.pointer].audio;if(!d.paused){d.pause();d.currentTime=0;a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up");return}d.addEventListener("ended",function(){a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up")});d.addEventListener("play",function(){a(c).children(".fa").removeClass("fa-volume-up");a(c).children(".fa").addClass("fa-stop")});d.load();d.play()});a("#"+b.itemdata.uniqueid+"_container .landr_skip_btn").on("click",function(){a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0);a("#"+b.itemdata.uniqueid+"_container .landr_speech.landr_teacher_left").text(b.items[b.game.pointer].displayprompt+"");a("#"+b.itemdata.uniqueid+"_container .landr_word_input").each(function(){var c=a(this).data("realidx"),d=b.items[b.game.pointer].landr_targetWords[c];a(this).val(d)});b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;if(b.game.pointer<b.items.length-1){setTimeout(function(){b.game.pointer++;b.nextPrompt()},2200)}else{b.end()}})},game:{pointer:0},usevoice:"",setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{landr_targetWords:a.sentence.trim().split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),target:a.sentence,prompt:a.prompt,displayprompt:a.displayprompt,phonetic:a.phonetic,typed:"",answered:!1,correct:!1,audio:null,audiourl:a.audiourl?a.audiourl:"",imageurl:a.imageurl}}).filter(function(a){return""!==a.target});a.each(b.items,function(a,c){c.audio=new Audio;c.audio.src=c.audiourl;if(0===b.items.filter(function(a){return null===a.audio}).length){b.appReady()}})},appReady:function appReady(){var b=this;a("#"+b.itemdata.uniqueid+"_container .landr_not_loaded").hide();a("#"+b.itemdata.uniqueid+"_container .landr_loaded").show();a("#"+b.itemdata.uniqueid+"_container .landr_start_btn").prop("disabled",!1)},gotComparison:function gotComparison(b,c){var d=this;a("#"+d.itemdata.uniqueid+"_container .landr_word_input").removeClass("landr_correct landr_incorrect");a("#"+d.itemdata.uniqueid+"_container .landr_feedback_icon").removeClass("fa fa-check fa-times");var e=0==b.filter(function(a){return!a.matched}).length;if(e&&b&&0<b.length){a("#"+d.itemdata.uniqueid+"_container .landr_word_input").addClass("landr_correct");a("#"+d.itemdata.uniqueid+"_container .landr_feedback_icon").addClass("fa fa-check");a("#"+d.itemdata.uniqueid+"_container .landr_speech.landr_teacher_left").text(d.items[d.game.pointer].displayprompt+"");d.items[d.game.pointer].answered=!0;d.items[d.game.pointer].correct=!0;d.items[d.game.pointer].typed=c;a("#"+d.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0);if(d.game.pointer<d.items.length-1){setTimeout(function(){d.game.pointer++;d.nextPrompt()},2200)}else{d.end()}}else{b.forEach(function(b){if(!b.matched){a("#"+d.itemdata.uniqueid+"_container .landr_word_input[data-idx='"+b.wordnumber+"']").addClass("landr_incorrect");a("#"+d.itemdata.uniqueid+"_container .landr_feedback_icon[data-idx='"+b.wordnumber+"']").addClass("fa fa-times")}else{a("#"+d.itemdata.uniqueid+"_container .landr_word_input[data-idx='"+b.wordnumber+"']").addClass("landr_correct");a("#"+d.itemdata.uniqueid+"_container .landr_feedback_icon[data-idx='"+b.wordnumber+"']").addClass("fa fa-check")}});var f=a("#"+d.itemdata.uniqueid+"_container .landr_reply_"+d.game.pointer);g.do_animate(f,"shakeX animate__faster").then(function(){a("#"+d.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!1)})}a("#"+d.itemdata.uniqueid+"_container .landr_word_input.landr_correct").each(function(){var b=a(this).data("realidx"),c=d.items[d.game.pointer].landr_targetWords[b];a(this).val(c)})},getWords:function getWords(a){var b=this;if("false"==!1){a=a.toLowerCase()}for(var c=a.split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),d=[],e=0;e<c.length;e++){if(!c[e].match(b.quizhelper.spliton_regexp)){d.push(c[e])}}return d},getComparison:function getComparison(b,c,d,e){var f=this;a(".landr_ctrl-btn").prop("disabled",!0);f.quizhelper.comparePassageToTranscript(b,c,d,f.itemdata.language,f.itemdata.alternates).then(function(a){var b=JSON.parse(a);if(b){e(b)}else{e(!1)}})},end:function end(){var b=this;a(".minilesson_nextbutton").prop("disabled",!0);b.updateProgressDots();setTimeout(function(){a(".minilesson_nextbutton").prop("disabled",!1);if(b.quizhelper.showitemreview){b.show_item_review()}else{b.next_question()}},2200)},start:function start(){var b=this;a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!0);a("#"+b.itemdata.uniqueid+"_container .landr_speakbtncontainer").show();a("#"+b.itemdata.uniqueid+"_container .landr_title").show();b.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});b.game.pointer=0;a("#"+b.itemdata.uniqueid+"_container .landr_game").show();a("#"+b.itemdata.uniqueid+"_container .landr_start_btn").hide();a("#"+b.itemdata.uniqueid+"_container .landr_listen_cont").show();a("#"+b.itemdata.uniqueid+"_container .landr_mainmenu").hide();a("#"+b.itemdata.uniqueid+"_container .landr_controls").show();b.nextPrompt()},nextPrompt:function nextPrompt(){var b=parseInt(this.itemdata.show_text),c=this,d=c.items[c.game.pointer].target;if(c.quizhelper.use_ttrecorder()){c.ttrec.currentPrompt=d}var e=c.items[c.game.pointer].displayprompt;if(!b){var f=e.replace(c.quizhelper.nopunc_regexp,""),i=f.replace(c.quizhelper.nonspaces_regexp,"\u2022"),j=i}else{var j=e}h.render("mod_minilesson/listenrepeat_prompt",{showprompt:j,pointer:c.game.pointer}).then(function(b){a("#"+c.itemdata.uniqueid+"_container .landr_game").html(b);a(".landr_ctrl-btn").prop("disabled",!1);c.updateProgressDots();var d=a(".landr_prompt_"+c.game.pointer);g.do_animate(d,"zoomIn animate__faster","in").then(function(){});c.nextReply()})},updateProgressDots:function updateProgressDots(){var b=this,c,d=b.items.map(function(a,d){c="gray";if(b.items[d].answered&&b.items[d].correct){c="green"}else if(b.items[d].answered&&!b.items[d].correct){c="red"}return"<i style='color:"+c+"' class='fa fa-circle'></i>"}).join(" ");a("#"+b.itemdata.uniqueid+"_container .landr_title").html(d)},nextReply:function nextReply(){var b=this,c=0,d=b.items[b.game.pointer].landr_targetWords.map(function(a,d){var e={};if(!a.match(b.quizhelper.spliton_regexp)){c++;e.isword=!0;e.idx=c;e.length=a.length;e.lengthplusone=a.length+1;e.realidx=d}else{e.isword=!1;e.text=a}return e}),e=0<b.itemdata.timelimit;h.render("mod_minilesson/listenrepeat_reply",{words:d,pointer:b.game.pointer,imageurl:b.items[b.game.pointer].imageurl,displaytimer:e}).then(function(c){a("#"+b.itemdata.uniqueid+"_container .landr_game").append(c);var d=a(".landr_reply_"+b.game.pointer);g.do_animate(d,"zoomIn animate__faster","in").then(function(){});a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn").prop("disabled",!1);if(!b.quizhelper.mobile_user()){setTimeout(function(){a("#"+b.itemdata.uniqueid+"_container .landr_listen_btn").trigger("click")},1e3)}if(e){a("#"+b.itemdata.uniqueid+"_container .landr_game .progress-container").show();a("#"+b.itemdata.uniqueid+"_container .landr_game .progress-container i").show();a("#"+b.itemdata.uniqueid+"_container .landr_game .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){a("#"+b.itemdata.uniqueid+"_container .landr_skip_btn").trigger("click")}})}})},stop_audio:function stop_audio(){var a=this,b=a.items[a.game.pointer].audio;if(b&&!b.paused){b.pause()}}}});
//# sourceMappingURL=listenrepeat.min.js.map
