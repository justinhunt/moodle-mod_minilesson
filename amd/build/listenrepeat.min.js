define ("mod_minilesson/listenrepeat",["jquery","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/ttrecorder","mod_minilesson/animatecss","core/templates","core/str","core/notification"],function(a,b,c,d,e,f,g,h,i,j){"use strict";b.debug("MiniLesson listen and repeat: initialising");return{ttrec:null,clone:function clone(){return a.extend(!0,{},this)},init:function init(a,c,d){var e=this,h=function(a){switch(a.type){case"recording":break;case"speech":b.debug("speech at listen_repeat");e.getComparison(e.items[e.game.pointer].target,a.capturedspeech,e.items[e.game.pointer].phonetic,function(b){e.gotComparison(b,a)});break;}};if(d.use_ttrecorder()){var i={uniqueid:c.uniqueid,callback:h,stt_guided:d.is_stt_guided(),wwwroot:d.is_stt_guided()};e.ttrec=f.clone();e.ttrec.init(i)}else{cloudpoodll.init("minilesson-recorder-listenrepeat-"+c.id,h)}e.itemdata=c;e.quizhelper=d;e.index=a;e.strings={};var j={useanimatecss:d.useanimatecss};g.init(j);e.init_controls();e.init_strings();e.register_events();e.setvoice();e.getItems()},init_controls:function init_controls(){var b=this;b.controls={container:a("#"+b.itemdata.uniqueid+"_container"),nextbutton:a("#"+b.itemdata.uniqueid+"_container .minilesson_nextbutton"),start_btn:a("#"+b.itemdata.uniqueid+"_container .landr_start_btn"),skip_btn:a("#"+b.itemdata.uniqueid+"_container .landr_skip_btn"),ctrl_btn:a("#"+b.itemdata.uniqueid+"_container .landr_ctrl-btn"),game:a("#"+b.itemdata.uniqueid+"_container .landr_game"),controlsbox:a("#"+b.itemdata.uniqueid+"_container .landr_controls"),resultscontainer:a("#"+b.itemdata.uniqueid+"_container .landr_resultscontainer"),speakbtncontainer:a("#"+b.itemdata.uniqueid+"_container .landr_speakbtncontainer"),mainmenu:a("#"+b.itemdata.uniqueid+"_container .landr_mainmenu"),title:a("#"+b.itemdata.uniqueid+"_container .landr_title"),question:a("#"+b.itemdata.uniqueid+"_container .landr_question"),speech_container:a("#"+b.itemdata.uniqueid+"_container .landr_speechcontainer"),landr_correctfeedback:a("#"+b.itemdata.uniqueid+"_container .landr_correctfeedback"),landr_incorrectfeedback:a("#"+b.itemdata.uniqueid+"_container .landr_incorrectfeedback"),landr_fbcontainer:a("#"+b.itemdata.uniqueid+"_container .landr_fbcontainer"),landr_feedback:a("#"+b.itemdata.uniqueid+"_container .landr_feedback"),landr_listen_btn:a("#"+b.itemdata.uniqueid+"_container .landr_listen_btn"),progress_container:a("#"+b.itemdata.uniqueid+"_container .progress-container")}},init_strings:function init_strings(){var a=this;i.get_strings([{key:"nextlessonitem",component:"mod_minilesson"},{key:"confirm_desc",component:"mod_minilesson"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(b){var c=0;a.strings.nextlessonitem=b[c++];a.strings.confirm_desc=b[c++];a.strings.yes=b[c++];a.strings.no=b[c++]})},next_question:function next_question(){var a=this,b={};b.index=a.index;b.hasgrade=!0;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;b.grade=Math.round(100*(b.correctitems/b.totalitems));a.stop_audio();a.quizhelper.do_next(b)},show_item_review:function show_item_review(){var a=this,b={};b.items=a.items;b.totalitems=a.items.length;b.correctitems=a.items.filter(function(a){return a.correct}).length;var c=a.controls.game,d=a.controls.controlsbox,e=a.controls.speakbtncontainer,f=a.controls.resultscontainer,g=a.controls.landr_listen_btn;h.render("mod_minilesson/listitemresults",b).then(function(a,b){f.html(a);f.show();c.hide();d.hide();e.hide();g.hide();h.runTemplateJS(b)})},register_events:function register_events(){var b=this;b.controls.nextbutton.on("click",function(){if(b.items.some(function(a){return!a.answered})){j.confirm(b.strings.nextlessonitem,b.strings.confirm_desc,b.strings.yes,b.strings.no,function(){b.next_question()})}else{b.next_question()}});b.controls.start_btn.on("click",function(){b.start()});var c=b.controls.landr_listen_btn;c.on("click",function(){var d=b.items[b.game.pointer].audio;if(!d.paused){d.pause();d.currentTime=0;a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up");return}d.addEventListener("ended",function(){a(c).children(".fa").removeClass("fa-stop");a(c).children(".fa").addClass("fa-volume-up")});d.addEventListener("play",function(){a(c).children(".fa").removeClass("fa-volume-up");a(c).children(".fa").addClass("fa-stop")});d.load();d.play()});b.controls.skip_btn.on("click",function(){b.controls.ctrl_btn.prop("disabled",!0);b.controls.container.find(".landr_speech.landr_teacher_left").text(b.items[b.game.pointer].displayprompt+"");b.controls.container.find(".landr_word_input").each(function(){var c=a(this).data("realidx"),d=b.items[b.game.pointer].landr_targetWords[c];a(this).val(d)});b.items[b.game.pointer].answered=!0;b.items[b.game.pointer].correct=!1;b.stopTimer(b.items[b.game.pointer].timer);if(b.game.pointer<b.items.length-1){b.controls.skip_btn.prop("disabled",!0);b.controls.skip_btn.children(".fa").removeClass("fa-arrow-right");b.controls.skip_btn.children(".fa").addClass("fa-spinner fa-spin");setTimeout(function(){b.controls.skip_btn.children(".fa").removeClass("fa-spinner fa-spin");b.controls.skip_btn.children(".fa").addClass("fa-arrow-right");b.controls.skip_btn.prop("disabled",!1);b.game.pointer++;b.nextPrompt()},2200)}else{b.end()}})},game:{pointer:0},usevoice:"",setvoice:function setvoice(){var a=this;a.usevoice=a.itemdata.usevoice;a.voiceoption=a.itemdata.voiceoption},getItems:function getItems(){var b=this,c=b.itemdata.sentences;b.items=c.map(function(a){return{landr_targetWords:a.sentence.trim().split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),target:a.sentence,prompt:a.prompt,displayprompt:a.displayprompt,phonetic:a.phonetic,typed:"",answered:!1,correct:!1,audio:null,timer:[],audiourl:a.audiourl?a.audiourl:"",imageurl:a.imageurl}}).filter(function(a){return""!==a.target});a.each(b.items,function(a,c){c.audio=new Audio;c.audio.src=c.audiourl;if(0===b.items.filter(function(a){return null===a.audio}).length){b.appReady()}})},appReady:function appReady(){var a=this;a.controls.container.find(".landr_not_loaded").hide();a.controls.container.find(".landr_loaded").show();if(a.itemdata.hidestartpage){a.start()}else{a.controls.start_btn.prop("disabled",!1)}},gotComparison:function gotComparison(b,c){var d=this;d.controls.container.find(".landr_word_input").removeClass("landr_correct landr_incorrect");d.controls.container.find(".landr_feedback_icon").removeClass("fa fa-check fa-times");var e=0==b.filter(function(a){return!a.matched}).length;if(e&&b&&0<b.length){d.controls.container.find(".landr_word_input").addClass("landr_correct");d.controls.container.find(".landr_feedback_icon").addClass("fa fa-check");d.controls.container.find(".landr_speech.landr_teacher_left").text(d.items[d.game.pointer].displayprompt+"");d.items[d.game.pointer].answered=!0;d.items[d.game.pointer].correct=!0;d.items[d.game.pointer].typed=c;d.stopTimer(d.items[d.game.pointer].timer);d.controls.ctrl_btn.prop("disabled",!0);if(d.game.pointer<d.items.length-1){setTimeout(function(){d.game.pointer++;d.nextPrompt()},2200)}else{d.end()}}else{b.forEach(function(a){if(!a.matched){d.controls.container.find(".landr_word_input[data-idx=\""+a.wordnumber+"\"]").addClass("landr_incorrect");d.controls.container.find(".landr_feedback_icon[data-idx=\""+a.wordnumber+"\"]").addClass("fa fa-times")}else{d.controls.container.find(".landr_word_input[data-idx=\""+a.wordnumber+"\"]").addClass("landr_correct");d.controls.container.find(".landr_feedback_icon[data-idx=\""+a.wordnumber+"\"]").addClass("fa fa-check")}});var f=d.controls.container.find(".landr_reply_"+d.game.pointer);g.do_animate(f,"shakeX animate__faster").then(function(){d.controls.ctrl_btn.prop("disabled",!1)})}d.controls.container.find(".landr_word_input.landr_correct").each(function(){var b=a(this).data("realidx"),c=d.items[d.game.pointer].landr_targetWords[b];a(this).val(c)})},getWords:function getWords(a){var b=this;if("false"==!1){a=a.toLowerCase()}for(var c=a.split(b.quizhelper.spliton_regexp).filter(function(a){return""!==a}),d=[],e=0;e<c.length;e++){if(!c[e].match(b.quizhelper.spliton_regexp)){d.push(c[e])}}return d},getComparison:function getComparison(a,b,c,d){var e=this;e.controls.ctrl_btn.prop("disabled",!0);e.quizhelper.comparePassageToTranscript(a,b,c,e.itemdata.language,e.itemdata.alternates).then(function(a){var b=JSON.parse(a);if(b){d(b)}else{d(!1)}})},end:function end(){var a=this;a.controls.nextbutton.prop("disabled",!0);a.updateProgressDots();setTimeout(function(){a.controls.nextbutton.prop("disabled",!1);if(a.quizhelper.showitemreview){a.show_item_review()}else{a.next_question()}},2200)},start:function start(){var a=this;a.controls.ctrl_btn.prop("disabled",!0);a.controls.speakbtncontainer.show();a.controls.title.show();a.items.forEach(function(a){a.spoken="";a.answered=!1;a.correct=!1});a.game.pointer=0;a.controls.game.show();a.controls.start_btn.hide();a.controls.container.find(".landr_listen_cont").show();a.controls.mainmenu.hide();a.controls.controlsbox.show();a.nextPrompt()},nextPrompt:function nextPrompt(){var a=parseInt(this.itemdata.show_text),b=this,c=b.items[b.game.pointer].target;if(b.quizhelper.use_ttrecorder()){b.ttrec.currentPrompt=c}var d=b.items[b.game.pointer].displayprompt;if(!a){var e=d.replace(b.quizhelper.nopunc_regexp,""),f=e.replace(b.quizhelper.nonspaces_regexp,"\u2022"),i=f}else{var i=d}h.render("mod_minilesson/listenrepeat_prompt",{showprompt:i,pointer:b.game.pointer}).then(function(a){b.controls.game.html(a);b.controls.ctrl_btn.prop("disabled",!1);b.updateProgressDots();var c=b.controls.container.find(".landr_prompt_"+b.game.pointer);g.do_animate(c,"zoomIn animate__faster","in").then(function(){});b.nextReply()})},updateProgressDots:function updateProgressDots(){var a=this,b,c=a.items.map(function(c,d){b="gray";if(a.items[d].answered&&a.items[d].correct){b="green"}else if(a.items[d].answered&&!a.items[d].correct){b="red"}return"<i style='color:"+b+"' class='fa fa-circle'></i>"}).join(" ");a.controls.title.html(c)},nextReply:function nextReply(){var a=this,b=0,c=a.items[a.game.pointer].landr_targetWords.map(function(c,d){var e={};if(!c.match(a.quizhelper.spliton_regexp)){b++;e.isword=!0;e.idx=b;e.length=c.length;e.lengthplusone=c.length+1;e.realidx=d}else{e.isword=!1;e.text=c}return e}),d=0<a.itemdata.timelimit;h.render("mod_minilesson/listenrepeat_reply",{words:c,pointer:a.game.pointer,imageurl:a.items[a.game.pointer].imageurl,displaytimer:d}).then(function(b){a.controls.game.append(b);var c=a.controls.container.find(".landr_reply_"+a.game.pointer);g.do_animate(c,"zoomIn animate__faster","in").then(function(){});a.controls.ctrl_btn.prop("disabled",!1);if(!a.quizhelper.mobile_user()){if(a.itemdata.hidestartpage&&0===a.game.pointer){a.controls.container.on("showElement",function(){setTimeout(function(){a.controls.landr_listen_btn.trigger("click")},1e3)})}else{setTimeout(function(){a.controls.landr_listen_btn.trigger("click")},1e3)}}if(d){a.startTimer()}})},stop_audio:function stop_audio(){var a=this,b=a.items[a.game.pointer].audio;if(b&&!b.paused){b.pause()}},startTimer:function startTimer(){var b=this,c=b.controls.progress_container;if(0<b.itemdata.timelimit){var d=function(){c.show();c.find("i").show();var d=c.find("#progresstimer").progressTimer({height:"5px",timeLimit:b.itemdata.timelimit,onFinish:function onFinish(){b.controls.skip_btn.trigger("click")}});d.each(function(){b.items[b.game.pointer].timer.push(a(this).attr("timer"))})};if(b.itemdata.hidestartpage&&0===b.game.pointer){b.controls.container.on("showElement",function(){d()})}else{d()}}},stopTimer:function stopTimer(a){if(a.length){a.forEach(function(a){clearInterval(a)})}}}});
//# sourceMappingURL=listenrepeat.min.js.map
