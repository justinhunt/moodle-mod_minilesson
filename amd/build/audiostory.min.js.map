{"version":3,"file":"audiostory.min.js","sources":["../src/audiostory.js"],"sourcesContent":["define(['jquery','core/log'], function ($,log) {\n    \"use strict\"; // jshint ;_;\n\n\n    log.debug('MiniLesson Audio Story: initialising');\n\n    var audiostoryapp = {\n        animateFrameId: null,\n        currentIndex: -1,\n        secondsPerImage:  20, //this is the animation length, before it reverses\n        pp: 5,//panfactor +, // eg 5\n        pm: -5,//panfactor -, eg -5\n        maxzoom: 1.1, // zoom will go from maxzoom to 1.0 and back again\n        zoomIn: false, // If true, start zoomed out and zoom in. If false, start zoomed in and zoom out\n        zoomAndPan: true,\n        entryTimes: [],\n        controls: {},\n        panOptions: null,\n\n        //for making multiple instances\n        clone: function () {\n            return $.extend(true, {}, this);\n        },\n\n        init: function (uniqid) {\n            var self = this;\n            self.panOptions = [\n                { xStart: this.pm, yStart: 0,   xEnd: this.pp, yEnd: 0   },\n                { xStart: this.pp,  yStart: 0,   xEnd: this.pm, yEnd: 0  },\n                { xStart: 0,   yStart: this.pm, xEnd: 0, yEnd: this.pp   },\n                { xStart: 0,   yStart: this.pp,  xEnd: 0, yEnd: this.pm  },\n                { xStart: this.pm, yStart: this.pm, xEnd: this.pp, yEnd: this.pp  },\n                { xStart: this.pp,  yStart: this.pp,  xEnd: this.pm, yEnd: this.pm }\n            ];\n            self.init_controls(uniqid);\n            self.register_events();\n        },\n\n        init_controls: function (uniqid) {\n            var self = this;\n            self.controls.aplayer = $('#' + uniqid + '_audiostory_audio');\n            self.controls.slideshowcontainer = $('#' + uniqid + '_audiostory_slideshow_container');\n            self.controls.captioncontainer = $('#' + uniqid + '_audiostory_caption');\n            self.controls.images = $('#' + uniqid + '_audiostory_slideshow_container' + ' .audiostory_image_container');\n            self.controls.overlay = self.controls.slideshowcontainer.find('.audiostory_overlay');\n            self.controls.playbutton = self.controls.overlay.find('.audiostory_play_button');\n            self.controls.layers = [];\n            self.controls.entryTimes = [];\n\n            // Set Zoom and Pan scale\n            var zoomandpan  = self.controls.slideshowcontainer.data('zoomandpan');\n            switch (zoomandpan) {\n                case 1:\n                    self.zoomAndPan = true;\n                    self.maxzoom = 1.1;\n                    self.pp = 5; //panfactor +\n                    self.pm = -5; //panfactor -\n                    break;\n                case 2:\n                    self.zoomAndPan = true;\n                    self.maxzoom = 1.2;\n                    self.pp = 7; //panfactor +\n                    self.pm = -7; //panfactor -\n                    break;\n                case 3:\n                    self.zoomAndPan = true;\n                    self.maxzoom = 1.3;\n                    self.pp = 10; //panfactor +\n                    self.pm = -10; //panfactor -\n                    break;\n                case 0:\n                default:\n                    self.zoomAndPan = false;\n            }\n\n            // Set up the layers and entry times\n            self.controls.images.each(function (index, element) {\n                var entrytime = element.dataset.entrytime;\n                if (entrytime == '') {\n                    return;} //\n                const pan = self.panOptions[Math.floor(Math.random() * self.panOptions.length)];\n                self.controls.layers.push({ element: element, pan });\n                self.controls.entryTimes.push(entrytime);\n            });\n\n            //add some more information to layers\n            self.controls.layers.forEach(layer => {\n                layer.animation = {\n                    direction: 1, // 1 = zoom out, -1 = zoom in\n                    progress: 0, // 0 to 1\n                    lastTimestamp: null\n                };\n            });\n            // Show the first image at rest (no pan/zoom)\n            const firstImage = self.controls.layers[0];\n            if (firstImage) {\n                firstImage.element.style.opacity = '1';\n                firstImage.element.style.transform = 'scale(1) translate(0, 0)';\n            }\n\n        },\n\n\n        register_events: function () {\n            var self = this;\n            const audio = self.controls.aplayer[0];\n            const captionDiv = self.controls.captioncontainer[0];\n            const layers = self.controls.layers;\n            var doUpdate = function (timestamp) {\n                const audio = self.controls.aplayer[0];\n                const layers = self.controls.layers;\n                const currentTime = audio.currentTime;\n                const entryTimes = self.controls.entryTimes;\n\n                let newIndex = -1;\n                for (let i = 0; i < entryTimes.length; i++) {\n                    if (currentTime >= entryTimes[i]) {\n                        newIndex = i;\n                    } else {\n                        break;\n                    }\n                }\n\n                if (newIndex !== self.currentIndex) {\n                    self.currentIndex = newIndex;\n                    layers.forEach((l, i) => {\n                        l.element.style.opacity = i === self.currentIndex ? '1' : '0';\n                        l.animation.progress = 0;\n                        l.animation.direction = 1;\n                        l.animation.lastTimestamp = null;\n                    });\n                    //Toggle zoom direction\n                    self.zoomIn = !self.zoomIn;\n                }\n\n                self.animateCurrentImage(timestamp);\n\n                self.animationFrameId = requestAnimationFrame(doUpdate);\n            };\n\n\n\n            self.controls.playbutton.on('click', () => {\n                self.controls.overlay.hide();\n                audio.play(); // this triggers animation\n            });\n\n            audio.addEventListener('play', () => {\n                self.controls.overlay.hide();\n                if (!self.animationFrameId) {\n                    self.animationFrameId = requestAnimationFrame(doUpdate);\n                }\n            });\n\n            audio.addEventListener('pause', () => {\n                if (self.animationFrameId) {\n                    cancelAnimationFrame(self.animationFrameId);\n                    self.animationFrameId = null;\n                }\n            });\n\n            audio.addEventListener('seeked', () => {\n                self.currentIndex = -1;\n                if (!audio.paused) {\n                    doUpdate();\n                }\n            });\n\n            // Caption handling using textTracks\n            const handleLoadedMetadata = () => {\n                log.debug('Audio metadata loaded, setting up captions');\n                const track = audio.textTracks[0];\n                if (!track) {\n                    log.debug('no text tracks not setting up captions');\n                    return;\n                }\n\n                track.mode = 'hidden'; // load cues, but don't show default UI\n\n                track.addEventListener('cuechange', () => {\n                    const cue = track.activeCues[0];\n                    if (cue) {\n                        captionDiv.textContent = cue.text;\n                    } else {\n                        captionDiv.textContent = '';\n                    }\n                });\n            };\n            //depending on state of audio load, do metadata or register an event for it\n            if (audio.readyState >= 1) {\n                handleLoadedMetadata();\n            } else {\n                audio.addEventListener('loadedmetadata', handleLoadedMetadata);\n            }\n\n        },\n\n        animateCurrentImage: function (timestamp) {\n            var self = this;\n            var layers = self.controls.layers;\n            var entryTimes = self.controls.entryTimes;\n            var audio = self.controls.aplayer[0];\n\n            if (self.currentIndex < 0 || self.currentIndex >= layers.length) {\n                return;\n            }\n\n            const imageObj = layers[self.currentIndex];\n            const { element, pan, animation } = imageObj;\n\n            if (!self.zoomAndPan) {\n                // If zoomAndPan is false, reset the transform and skip animation\n                element.style.transform = 'scale(1) translate(0, 0)';\n                return;\n            }\n\n\n            if (animation.lastTimestamp != null) {\n                const delta = timestamp - animation.lastTimestamp;\n                // Set zoom timing\n                const duration = self.secondsPerImage * 1000; // adjust as needed\n                animation.progress += (delta / duration)  * animation.direction;\n\n                if (animation.progress > 1) {\n                    animation.progress = 1;\n                    animation.direction = -1;\n                } else if (animation.progress < 0) {\n                    animation.progress = 0;\n                    animation.direction = 1;\n                }\n            }\n            animation.lastTimestamp = timestamp;\n\n            const easedProgress = 0.5 - 0.5 * Math.cos(Math.PI * animation.progress);\n            // Zoom logic: toggle between zoom in and zoom out based on flag\n            let scale;\n            if (self.zoomIn) {\n                // Start zoomed out, zoom in\n                scale = 1 + (self.maxzoom - 1) * easedProgress;\n            } else {\n                // Start zoomed in, zoom out\n                scale = self.maxzoom - (self.maxzoom - 1) * easedProgress;\n            }\n            // from 0 (zoomed out) to 1 (zoomed in)  -  this means we dont pan when zoomed out\n            const panFactor = easedProgress;\n            const x = (pan.xStart + (pan.xEnd - pan.xStart) * panFactor);\n            const y = (pan.yStart + (pan.yEnd - pan.yStart) * panFactor);\n\n            element.style.transform = `scale(${scale}) translate(${x}px, ${y}px)`;\n        },\n\n    };//end of audiostoryapp def\n    return audiostoryapp;\n});"],"names":["define","$","log","debug","animateFrameId","currentIndex","secondsPerImage","pp","pm","maxzoom","zoomIn","zoomAndPan","entryTimes","controls","panOptions","clone","extend","this","init","uniqid","xStart","yStart","xEnd","yEnd","init_controls","register_events","self","aplayer","slideshowcontainer","captioncontainer","images","overlay","find","playbutton","layers","data","each","index","element","entrytime","dataset","pan","Math","floor","random","length","push","forEach","layer","animation","direction","progress","lastTimestamp","firstImage","style","opacity","transform","audio","captionDiv","doUpdate","timestamp","currentTime","newIndex","i","l","animateCurrentImage","animationFrameId","requestAnimationFrame","on","hide","play","addEventListener","cancelAnimationFrame","paused","handleLoadedMetadata","track","textTracks","mode","cue","activeCues","textContent","text","readyState","imageObj","delta","duration","easedProgress","cos","PI","scale","panFactor","x","y"],"mappings":"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"}