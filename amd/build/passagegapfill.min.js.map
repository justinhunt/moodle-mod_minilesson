{"version":3,"sources":["../src/passagegapfill.js"],"names":["define","$","log","ajax","def","polly","anim","progresstimer","templates","debug","clone","extend","hintsused","controls","gapitems","items","penalizehints","init","index","itemdata","quizhelper","self","animopts","useanimatecss","register_controls","register_events","getGapItems","rootelement","document","querySelector","uniqueid","audioplayer","resultsbox","finishbtn","hintbtn","nextbtn","prepare_audio","fetch_polly_url","passagedata","plaintext","voiceoption","usevoice","then","audiourl","attr","next_question","stepdata","get_stepdata","do_next","submit_grade","report_step_grade","hasgrade","resultsdata","totalitems","length","totalhints","reduce","sum","obj","correctitems","filter","e","correct","hintspenalty","grade","Math","round","show_item_review","review_data","render","html","js","runTemplateJS","on","preventDefault","give_hint","check_answer","hide","addEventListener","inputelement","target","forEach","item","timelimit","show","progressTimer","height","timeLimit","onFinish","trigger","displaywrong","readonly","concat","map","gapitem","gapelement","parentElement","classList","remove","value","text","parseInt","getAttribute","add","showitemreview","setAttribute","element","placeholder","replaceposition","slice","hints","data","chunks","wordindex","isgap","appReady","start","end","prop","setTimeout","question","stopTimer","timer","clearInterval"],"mappings":"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","sourcesContent":["define(['jquery',\n    'core/log',\n    'core/ajax',\n    'mod_minilesson/definitions',\n    'mod_minilesson/pollyhelper',\n    'mod_minilesson/animatecss',\n    'mod_minilesson/progresstimer',\n    'core/templates'\n], function($, log, ajax, def, polly, anim, progresstimer, templates) {\n    \"use strict\"; // jshint ;_;\n\n    log.debug('MiniLesson passage gap fill: initialising');\n\n    return {\n\n        // For making multiple instances\n        clone: function() {\n            return $.extend(true, {hintsused: 0}, this);\n        },\n\n        controls: {},\n        gapitems: [],\n        items: [],\n        hintsused: 0,\n        penalizehints: false,\n\n        init: function(index, itemdata, quizhelper) {\n            var self = this;\n            self.itemdata = itemdata;\n            self.penalizehints = itemdata.penalizehints || false; // Default to penalizing hints\n            self.quizhelper = quizhelper;\n            self.index = index;\n\n            // Animation. - we might use this to shake the incorrect text boxes or something. See how its used in speakinggapfill.js\n            var animopts = {};\n            animopts.useanimatecss = quizhelper.useanimatecss;\n            anim.init(animopts);\n\n            self.register_controls();\n           // self.prepare_audio(); .. we pass the audio url in from PHP now, so no need to prepare it here.\n            self.register_events();\n            self.getGapItems();\n        },\n\n        register_controls: function() {\n            var self = this;\n            self.controls.rootelement = document.querySelector(`#${self.itemdata.uniqueid}_container`);\n            self.controls.audioplayer =$(\"#\" + self.itemdata.uniqueid + \"_container .pgapfill_audio_player\");\n            self.controls.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container .passage_gapfill_results_actions\");\n            self.controls.finishbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .pgapfill_finish_btn\");\n            self.controls.hintbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .pgapfill_hint_btn\");\n            self.controls.nextbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n        },\n\n        prepare_audio: function() {\n            var self = this;\n            polly.fetch_polly_url(self.itemdata.passagedata.plaintext, self.itemdata.voiceoption,\n                self.itemdata.usevoice).then(function(audiourl) {\n                self.controls.audioplayer.attr(\"src\", audiourl);\n            });\n        },\n\n        next_question: function() {\n            var self = this;\n            var stepdata = self.get_stepdata();\n            self.quizhelper.do_next(stepdata);\n        },\n\n        submit_grade: function() {\n            var self = this;\n            var stepdata = self.get_stepdata();\n            self.quizhelper.report_step_grade(stepdata);\n        },\n\n        get_stepdata: function() {\n            var self = this;\n            var stepdata = {};\n            stepdata.index = self.index;\n            stepdata.hasgrade = true;\n            stepdata.resultsdata = {items: self.items};\n            stepdata.totalitems = self.items.length;\n            var totalhints = self.items.reduce((sum, obj) => sum + (obj.totalhints || 0), 0);\n            stepdata.correctitems = self.items.filter(e => e.correct).length;\n            // If the user has used hints, we need to adjust the grade - its a bit yuk\n            var hintspenalty = self.penalizehints ? totalhints / 3 : 0;\n            stepdata.grade = Math.round(((stepdata.correctitems - hintspenalty) / stepdata.totalitems) * 100);\n            if(hintspenalty >0){\n                stepdata.correctitems = Math.round(stepdata.correctitems - hintspenalty);\n            }\n            return stepdata;\n        },\n\n        show_item_review:function(){\n            var self=this;\n            var review_data = self.get_stepdata();\n            var resultsbox = self.controls.resultsbox;\n            review_data.items = self.items;\n\n            //display results\n            templates.render('mod_minilesson/passagegapfillresults',review_data).then(\n              function(html,js){\n                  resultsbox.html(html);\n\n                  // Run js for audio player events\n                  templates.runTemplateJS(js);\n              }\n            );// End of templates\n        },\n\n        register_events: function() {\n\n            var self = this;\n\n            self.controls.nextbtn.on('click', function() {\n                self.next_question();\n            });\n\n\n            self.controls.hintbtn.on(\"click\", function(e) {\n                e.preventDefault();\n                self.give_hint();\n            });\n\n            self.controls.finishbtn.on(\"click\", function(e) {\n                e.preventDefault();\n                self.check_answer([], true, true);\n                // Prevent submit grade when finishing.\n                // self.submit_grade();\n                self.show_item_review();\n                $(this).hide();\n                self.controls.hintbtn.hide();\n            });\n\n            self.controls.rootelement.addEventListener('input', e => {\n                const inputelement = e.target;\n                self.items.forEach(item => {\n                    if (item.inputelement === inputelement) {\n                        self.check_answer(item, false);\n                    }\n                });\n            });\n\n            $(\"#\" + self.itemdata.uniqueid + \"_container\").on(\"showElement\", () => {\n                if (self.itemdata.timelimit > 0) {\n                    $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container\").show();\n                    $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container i\").show();\n                    $(\"#\" + self.itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                        height: '5px',\n                        timeLimit: self.itemdata.timelimit,\n                        onFinish: function() {\n                            self.controls.nextbtn.trigger('click');\n                        }\n                    });\n                }\n            });\n\n\n        },\n\n\n        check_answer: function(items = null, displaywrong = true, readonly = false) {\n            var self = this;\n            items = [].concat(items);\n            if (items.length === 0) {\n                items = self.items;\n            }\n            self.items.map(gapitem => {\n                if (!gapitem.inputelement) {\n                    return;\n                }\n                const gapelement = gapitem.inputelement.parentElement;\n                gapelement.classList.remove('psg_gapfill_wrong', 'psg_gapfill_correct');\n                gapitem.correct = gapitem.inputelement.value === gapitem.text;\n                gapitem.totalhints = parseInt(gapitem.inputelement.getAttribute('data-hints')) || 0;\n                if (gapitem.correct) {\n                    gapelement.classList.add('psg_gapfill_correct');\n                } else if (displaywrong) {\n                    gapelement.classList.add('psg_gapfill_wrong');\n                }\n                if (readonly) {\n                    if (self.quizhelper.showitemreview) {\n                        gapitem.inputelement.value = gapitem.text;\n                        gapelement.classList.add('pgapfill_gap_reviewing');\n                    }\n                    gapitem.inputelement.setAttribute('readonly', 'readonly');\n                }\n                return gapitem;\n            });\n        },\n\n        give_hint: function() {\n            var self = this;\n            var anyhintdisplayed = false;\n            self.items.forEach(element => {\n                const inputelement = element.inputelement;\n                if (!inputelement) {\n                    return;\n                }\n                //update the placeholder text\n                const placeholder = inputelement.placeholder;\n                const replaceposition = self.hintsused === 1 ? 1: element.placeholder.length - 1;\n                inputelement.placeholder = placeholder.slice(0, replaceposition) +\n                    element.text[replaceposition] + placeholder.slice(replaceposition + 1);\n                inputelement.setAttribute('placeholder', inputelement.placeholder);\n\n                // If the user has not entered the correct text, clear the input box, so they see the hint\n                if (inputelement.value !== element.text) {\n                    inputelement.value = '';\n                    inputelement.setAttribute('data-hints', 1 + self.hintsused);\n                    anyhintdisplayed = true;\n                }\n\n            });\n\n           //manage the hint count\n            self.hintsused++;\n            if (self.hintsused >= parseInt(self.itemdata.hints)) {\n                self.controls.hintbtn.remove();\n            } else if (self.hintsused === 1 && self.hintsused < parseInt(self.itemdata.hints)) {\n                self.controls.hintbtn.text(self.controls.hintbtn.data('alttext'));\n            }\n        },\n\n\n\n        getGapItems: function() {\n            //TO DO implement this\n            // This function prepares the gap items from the passage data.\n           log.debug(\"getting gap items\");\n\n            var self = this;\n            var passagedata = self.itemdata.passagedata;\n\n            //Track the inputboxes and assoc data so we can work with it from JS\n            self.gapitems = passagedata.chunks.map(target => ({\n                wordindex: target.wordindex,\n                text: target.text,\n                placeholder: target.placeholder,\n                isgap: target.isgap,\n                correct: false\n            }));\n            self.items = self.gapitems.filter(gapitem => gapitem.isgap).map(item => {\n                item.inputelement = self.controls.rootelement\n                    .querySelector(`.pgapfill_gap_input[data-wordindex=\"${item.wordindex}\"]`);\n                return item;\n            });\n        },\n\n        appReady: function() {\n            var self = this;\n            self.start();\n        },\n\n\n        end: function() {\n            var self = this;\n            $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n\n            //disable the buttons and go to next question or review\n            setTimeout(function() {\n                $(\".minilesson_nextbutton\").prop(\"disabled\",false);\n                if(self.quizhelper.showitemreview){\n                    self.show_item_review();\n                }else{\n                    self.next_question();\n                }\n            }, 2000);\n        },\n\n        start: function() {\n            var self = this;\n            self.controls.question.show();\n\n        },\n\n\n        stopTimer: function(timer) {\n            if (timer) {\n                    clearInterval(timer);\n            }\n        },\n    };\n});"],"file":"passagegapfill.min.js"}