{"version":3,"file":"passagegapfill.min.js","sources":["../src/passagegapfill.js"],"sourcesContent":["define(['jquery',\n    'core/log',\n    'core/ajax',\n    'mod_minilesson/definitions',\n    'mod_minilesson/pollyhelper',\n    'mod_minilesson/animatecss',\n    'mod_minilesson/progresstimer',\n    'core/templates'\n], function($, log, ajax, def, polly, anim, progresstimer, templates) {\n    \"use strict\"; // jshint ;_;\n\n    log.debug('MiniLesson passage gap fill: initialising');\n\n    return {\n\n        // For making multiple instances\n        clone: function() {\n            return $.extend(true, {hintsused: 0}, this);\n        },\n\n        controls: {},\n        gapitems: [],\n        items: [],\n        hintsused: 0,\n\n        init: function(index, itemdata, quizhelper) {\n            var self = this;\n            self.itemdata = itemdata;\n            self.quizhelper = quizhelper;\n            self.index = index;\n\n            // Animation. - we might use this to shake the incorrect text boxes or something. See how its used in speakinggapfill.js\n            var animopts = {};\n            animopts.useanimatecss = quizhelper.useanimatecss;\n            anim.init(animopts);\n\n            self.register_controls();\n           // self.prepare_audio(); .. we pass the audio url in from PHP now, so no need to prepare it here.\n            self.register_events();\n            self.getGapItems();\n        },\n\n        register_controls: function() {\n            var self = this;\n            self.controls.rootelement = document.querySelector(`#${self.itemdata.uniqueid}_container`);\n            self.controls.audioplayer =$(\"#\" + self.itemdata.uniqueid + \"_container .pgapfill_audio_player\");\n            self.controls.resultsbox = $(\"#\" + self.itemdata.uniqueid + \"_container .passage_gapfill_results_actions\");\n            self.controls.finishbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_finishbutton\");\n            self.controls.hintbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_hintbutton\");\n            self.controls.nextbtn = $(\"#\" + self.itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n        },\n\n        prepare_audio: function() {\n            var self = this;\n            polly.fetch_polly_url(self.itemdata.passagedata.plaintext, self.itemdata.voiceoption,\n                self.itemdata.usevoice).then(function(audiourl) {\n                self.controls.audioplayer.attr(\"src\", audiourl);\n            });\n        },\n\n        next_question: function() {\n            var self = this;\n            var stepdata = self.get_stepdata();\n            self.quizhelper.do_next(stepdata);\n        },\n\n        submit_grade: function() {\n            var self = this;\n            var stepdata = self.get_stepdata();\n            self.quizhelper.report_step_grade(stepdata);\n        },\n\n        get_stepdata: function() {\n            var self = this;\n            var stepdata = {};\n            stepdata.index = self.index;\n            stepdata.hasgrade = true;\n            stepdata.totalitems = self.items.length;\n            stepdata.correctitems = self.items.filter(e => e.correct).length;\n            stepdata.grade = Math.round((stepdata.correctitems / stepdata.totalitems) * 100);\n            stepdata.penalty = self.hintsused * 30;\n            stepdata.grade = Math.max(0, stepdata.grade - stepdata.penalty);\n            return stepdata;\n        },\n\n        show_item_review:function(){\n            var self=this;\n            var review_data = self.get_stepdata();\n            var resultsbox = self.controls.resultsbox;\n            review_data.items = self.items;\n\n            //display results\n            templates.render('mod_minilesson/passagegapfillresults',review_data).then(\n              function(html,js){\n                  resultsbox.html(html);\n\n                  // Run js for audio player events\n                  templates.runTemplateJS(js);\n              }\n            );// End of templates\n        },\n\n        register_events: function() {\n\n            var self = this;\n\n            self.controls.nextbtn.on('click', function() {\n                self.next_question();\n            });\n\n\n            self.controls.hintbtn.on(\"click\", function(e) {\n                e.preventDefault();\n                self.give_hint();\n            });\n\n            self.controls.finishbtn.on(\"click\", function(e) {\n                e.preventDefault();\n                self.check_answer([], true, true);\n                // Prevent submit grade when finishing.\n                // self.submit_grade();\n                self.show_item_review();\n            });\n\n            self.controls.rootelement.addEventListener('input', e => {\n                const inputelement = e.target;\n                self.items.forEach(item => {\n                    if (item.inputelement === inputelement) {\n                        self.check_answer(item, false);\n                    }\n                });\n            });\n\n\n        },\n\n\n        check_answer: function(items = null, displaywrong = true, readonly = false) {\n            var self = this;\n            items = [].concat(items);\n            if (items.length === 0) {\n                items = self.items;\n            }\n            self.items.map(gapitem => {\n                if (!gapitem.inputelement) {\n                    return;\n                }\n                const gapelement = gapitem.inputelement.parentElement;\n                gapelement.classList.remove('psg_gapfill_wrong', 'psg_gapfill_correct');\n                gapitem.correct = gapitem.inputelement.value === gapitem.text;\n                if (gapitem.correct) {\n                    gapelement.classList.add('psg_gapfill_correct');\n                } else if (displaywrong) {\n                    gapelement.classList.add('psg_gapfill_wrong');\n                }\n                if (readonly) {\n                    if (self.quizhelper.showitemreview) {\n                        gapitem.inputelement.value = gapitem.text;\n                        gapelement.classList.add('pgapfill_gap_reviewing');\n                    }\n                    gapitem.inputelement.setAttribute('readonly', 'readonly');\n                }\n                return gapitem;\n            });\n        },\n\n        give_hint: function() {\n            var self = this;\n            var anyhintdisplayed = false;\n            self.items.forEach(element => {\n                const inputelement = element.inputelement;\n                if (!inputelement) {\n                    return;\n                }\n                if (inputelement.value !== element.text) {\n                    const placeholder = inputelement.placeholder;\n                    const replaceposition = self.hintsused === 1 ? 1: element.placeholder.length - 1;\n                    inputelement.placeholder = placeholder.slice(0, replaceposition) +\n                        element.text[replaceposition] + placeholder.slice(replaceposition + 1);\n                    inputelement.setAttribute('placeholder', inputelement.placeholder);\n                    inputelement.value = '';\n                    anyhintdisplayed = true;\n                }\n                inputelement.setAttribute('data-hints', 1 + self.hintsused);\n            });\n            if (anyhintdisplayed) {\n                self.hintsused++;\n            }\n            if (self.hintsused >= parseInt(self.itemdata.hints)) {\n                self.controls.hintbtn.remove();\n            } else if (self.hintsused === 1 && self.hintsused < parseInt(self.itemdata.hints)) {\n                self.controls.hintbtn.text(self.controls.hintbtn.data('alttext'));\n            }\n        },\n\n\n\n        getGapItems: function() {\n            //TO DO implement this\n            // This function prepares the gap items from the passage data.\n           log.debug(\"getting gap items\");\n\n            var self = this;\n            var passagedata = self.itemdata.passagedata;\n\n            //We probably want something like this to track the inputboxes and assoc data so we can work with it from JS\n            //Right now it doesnt do anything special\n            //check item_passagegapfill exportfortemplate function to prepare the passagedata to use here\n            //Alternatively any data we need could also be set as attributes on divs in mustache template and picked up here.\n            self.gapitems = passagedata.words.map(target => ({\n                wordindex: target.wordindex,\n                text: target.text,\n                placeholder: target.placeholder,\n                isgap: target.isgap,\n                correct: false\n            }));\n            self.items = self.gapitems.filter(gapitem => gapitem.isgap).map(item => {\n                item.inputelement = self.controls.rootelement\n                    .querySelector(`.pgapfill_gap_input[data-wordindex=\"${item.wordindex}\"]`);\n                return item;\n            });\n        },\n\n        appReady: function() {\n            var self = this;\n            self.start();\n        },\n\n\n        end: function() {\n            var self = this;\n            $(\".minilesson_nextbutton\").prop(\"disabled\", true);\n\n            //disable the buttons and go to next question or review\n            setTimeout(function() {\n                $(\".minilesson_nextbutton\").prop(\"disabled\",false);\n                if(self.quizhelper.showitemreview){\n                    self.show_item_review();\n                }else{\n                    self.next_question();\n                }\n            }, 2000);\n        },\n\n        start: function() {\n            var self = this;\n            self.controls.question.show();\n\n        },\n\n\n        stopTimer: function(timer) {\n            if (timer) {\n                    clearInterval(timer);\n            }\n        },\n\n\n    };\n});"],"names":["define","$","log","ajax","def","polly","anim","progresstimer","templates","debug","clone","extend","hintsused","this","controls","gapitems","items","init","index","itemdata","quizhelper","animopts","useanimatecss","register_controls","register_events","getGapItems","rootelement","document","querySelector","uniqueid","audioplayer","resultsbox","finishbtn","hintbtn","nextbtn","prepare_audio","self","fetch_polly_url","passagedata","plaintext","voiceoption","usevoice","then","audiourl","attr","next_question","stepdata","get_stepdata","do_next","submit_grade","report_step_grade","hasgrade","totalitems","length","correctitems","filter","e","correct","grade","Math","round","penalty","max","show_item_review","review_data","render","html","js","runTemplateJS","on","preventDefault","give_hint","check_answer","addEventListener","inputelement","target","forEach","item","displaywrong","readonly","concat","map","gapitem","gapelement","parentElement","classList","remove","value","text","add","showitemreview","setAttribute","anyhintdisplayed","element","placeholder","replaceposition","slice","parseInt","hints","data","words","wordindex","isgap","appReady","start","end","prop","setTimeout","question","show","stopTimer","timer","clearInterval"],"mappings":"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"}