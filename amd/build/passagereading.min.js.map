{"version":3,"file":"passagereading.min.js","sources":["../src/passagereading.js"],"sourcesContent":["define(\n    ['jquery', 'core/log', 'mod_minilesson/definitions',\n    'mod_minilesson/ttrecorder', 'core/notification', 'core/str', 'core/templates'],\n    function ($, log, def, ttrecorder, notification, str, templates) {\n        \"use strict\"; // jshint ;_;\n\n      /*\n      This file is to manage the Passage Reading item type\n       */\n\n        log.debug('MiniLesson Passage Reading: initialising');\n\n        var app = {\n\n            allwords: {},\n            strings: {},\n            totals: { correct: 0, incorrect: 0, unreached: 0, read: 0, accuracy: 0, score: 0, comparison: {} },\n            mediaurl: false,\n\n          //for making multiple instances\n            clone: function () {\n                return $.extend(true, {}, this);\n            },\n\n            init: function (index, itemdata, quizhelper) {\n                this.index = index;\n                this.itemdata = itemdata;\n                this.quizhelper = quizhelper;\n                this.init_strings();\n                this.init_components(quizhelper, itemdata);\n                this.register_events(index, itemdata, quizhelper);\n\n            },\n\n            init_strings: function () {\n                var self = this;\n                str.get_strings([\n                { \"key\": \"reattempt\", \"component\": 'mod_minilesson' },\n                { \"key\": \"reallyreattempt\", \"component\": 'mod_minilesson' },\n                ]).done(function (s) {\n                    var i = 0;\n                    self.strings.reattempt = s[i++];\n                    self.strings.reallyreattempt = s[i++];\n                });\n            },\n\n            next_question: function () {\n                var self = this;\n                var stepdata = {};\n                stepdata.index = self.index;\n                stepdata.hasgrade = true;\n                stepdata.totalitems = 0;\n                stepdata.correctitems = 0;\n                var percent = 0;\n                if (self.allwords.length > 0) {\n                    percent = Math.round((self.totals.correct / self.allwords.length) * 100);\n                  //If total marks is set, we use percent to calc correct items / total items\n                    if (self.itemdata.totalmarks > 0) {\n                        stepdata.totalitems = self.itemdata.totalmarks;\n                        stepdata.correctitems = Math.round((self.totals.correct / self.allwords.length) * self.itemdata.totalmarks);\n                    } else {\n                        stepdata.totalitems = self.allwords.length;\n                        stepdata.correctitems = self.totals.correct;\n                    }\n                }\n\n                stepdata.grade = percent;\n              //Add media url to \"totals\" before we save it\n                if (self.totals && self.mediaurl) {\n                    self.totals.mediaurl = self.mediaurl;\n                }\n                stepdata.resultsdata = self.totals;\n                this.quizhelper.do_next(stepdata);\n            },\n\n            register_events: function (index, itemdata, quizhelper) {\n                var self = this;\n\n                self.nextbutton.on('click', function (e) {\n                    e.preventDefault();\n                    self.next_question();\n                });\n\n                self.reattemptbutton.on('click', function (e) {\n                    e.preventDefault();\n                    notification.confirm(\n                        self.strings.reattempt,\n                        self.strings.reallyreattempt,\n                        self.strings.reattempt,\n                        '',\n                        function () {\n                            self.resultscontainer.hide();\n                            self.reattemptcontainer.hide();\n                            self.recordercontainer.show();\n                            //Reset all words css\n                            self.allwords.removeClass(\"pr_correct pr_incorrect pr_unreached\");\n                            self.allspaces.removeClass(\"pr_correct pr_incorrect pr_unreached\");\n                        }\n                    );\n                });\n\n\n\n                $(\"#\" + itemdata.uniqueid + \"_container\").on('showElement', () => {\n                    if (itemdata.timelimit > 0) {\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container i\").show();\n                        $(\"#\" + itemdata.uniqueid + \"_container .progress-container #progresstimer\").progressTimer({\n                            height: '5px',\n                            timeLimit: itemdata.timelimit,\n                            onFinish: function () {\n                                self.nextbutton.trigger('click');\n                            }\n                          });\n                    }\n                });\n\n            },\n\n            init_components: function (quizhelper, itemdata) {\n                var self = this;\n                self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container .mod_minilesson_mu_passage_word\");\n                self.allspaces = $(\"#\" + self.itemdata.uniqueid + \"_container .mod_minilesson_mu_passage_space\");\n                self.recordercontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_passagereading_speakbtncontainer\");\n                self.reattemptcontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_passagereading_reattemptcontainer\");\n                self.resultscontainer = $(\"#\" + self.itemdata.uniqueid + \"_container .ml_passagereading_allresultscontainer\");\n                self.reattemptbutton = self.reattemptcontainer.find(\".ml_reattemptbutton\");\n                self.nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n\n                var theCallback = function (message) {\n\n                    switch (message.type) {\n                        case 'recording':\n\n                        break;\n\n                        case 'speech':\n                            var speechtext = message.capturedspeech;\n                            var spoken_clean = quizhelper.cleanText(speechtext);\n                            var phonetic = ''; // TO DO - add phonetic option\n                            log.debug('speechtext:', speechtext);\n                            log.debug('spoken:', spoken_clean);\n                            self.getComparison(\n                                self.itemdata.passagetext,\n                                spoken_clean,\n                                phonetic,\n                                function (comparison) {\n                                    self.gotComparison(comparison, message);\n                                }\n                            );\n                        break;\n                        case 'mediasaved':\n                            log.debug('Mediaurl saved at passage reading: ' + message.mediaurl);\n                            self.mediaurl = message.mediaurl;\n                          // The mediaurl is not ready yet, so we use the bloburl instead\n                            self.totals.mediaurl = message.bloburl;\n                        break;\n                    } //end of switch message type\n                };\n\n              //init tt recorder\n                var opts = {};\n                opts.uniqueid = itemdata.uniqueid;\n                opts.callback = theCallback;\n                opts.stt_guided = quizhelper.is_stt_guided();\n                self.ttrec = ttrecorder.clone();\n                self.ttrec.init(opts);\n              //init prompt for first card\n              //in some cases ttrecorder wants to know the target\n              //app.ttrec.currentPrompt=app.displayterms[app.pointer - 1];\n\n            }, //end of init components\n\n            getComparison: function (passage, transcript, phonetic, callback) {\n                var self = this;\n\n              //TO DO disable the TT Recorder button\n                $(\"#\" + self.thebutton).prop(\"disabled\", true);\n\n                self.quizhelper.comparePassageToTranscript(passage, transcript, phonetic, self.itemdata.language, self.itemdata.alternates).then(function (ajaxresult) {\n                    var payloadobject = JSON.parse(ajaxresult);\n                    if (payloadobject) {\n                        callback(payloadobject);\n                    } else {\n                        callback(false);\n                    }\n                });\n\n            },\n\n            gotComparison: function (comparison, typed) {\n                var self = this;\n                log.debug(\"gotComparison\");\n                var containerid = self.itemdata.uniqueid + \"_container\";\n                self.doComparisonMarkup(comparison, containerid);\n\n              //update our scores\n                var correctwords = $(\"#\" + containerid + \" .mod_minilesson_mu_passage_word.pr_correct\");\n                var incorrectwords = $(\"#\" + containerid + \" .mod_minilesson_mu_passage_word.pr_incorrect\");\n                var unreachedwords = $(\"#\" + containerid + \" .mod_minilesson_mu_passage_word.pr_unreached\");\n                self.totals.correct = correctwords.length;\n                self.totals.incorrect = incorrectwords.length;\n                self.totals.unreached = unreachedwords.length;\n                self.totals.read = incorrectwords.length + correctwords.length;\n                self.totals.accuracy = Math.round((self.totals.correct / self.totals.read) * 100);\n                self.totals.score = Math.round((self.totals.correct / self.allwords.length) * 100);\n                self.totals.comparison = comparison;\n                log.debug((\"total correct\", self.totals.correct));\n                log.debug((\"allwords\", self.allwords.length));\n\n              //display results or move next if not show item review\n                if (!self.quizhelper.showitemreview) {\n                  //clear markup .. though it was briefly shown (so we could calculate the score)\n                    self.allwords.removeClass(\"pr_correct pr_incorrect pr_unreached\");\n                    self.allspaces.removeClass(\"pr_correct pr_incorrect pr_unreached\");\n                    self.next_question();\n                } else {\n                  //display results\n                  //Hide the recorder and show the reattempt button and results\n                    templates.render('mod_minilesson/passagereadingresults', self.totals).then(\n                        function (html, js) {\n                            self.recordercontainer.hide();\n                            self.resultscontainer.html(html);\n                            self.resultscontainer.show();\n                            self.reattemptcontainer.show();\n                        }\n                    );\n                }//end of show item review or transition\n            },\n\n            doComparisonMarkup: function (comparison, containerid) {\n                var allwords = $(\"#\" + containerid + \" .mod_minilesson_mu_passage_word\");\n                var allspaces = $(\"#\" + + containerid + \"  .mod_minilesson_mu_passage_space\");\n\n              //Reset all words css\n                allwords.removeClass(\"pr_correct pr_incorrect pr_unreached\");\n                allspaces.removeClass(\"pr_correct pr_incorrect pr_unreached\");\n\n              //how many correct\n                var allCorrect = comparison.filter(function (e) {\n                    return !e.matched; }).length == 0;\n\n              //mark up the words as correct or not\n                if (allCorrect && comparison && comparison.length > 0) {\n                    log.debug(\"gotComparison: all correct\");\n                    allwords.addClass(\"pr_correct\");\n                    allspaces.addClass(\"pr_correct\");\n                } else {\n                    log.debug(\"gotComparison: not all correct\");\n                    var lastmatched = 0;\n                    comparison.forEach(function (obj) {\n                        var theword = $(\"#\" + containerid + \"  .mod_minilesson_mu_passage_word[data-wordnumber='\" + obj.wordnumber + \"']\");\n                        var thespace = $(\"#\" + containerid + \"  .mod_minilesson_mu_passage_space[data-wordnumber='\" + obj.wordnumber + \"']\");\n\n                        if (!obj.matched) {\n                            theword.addClass(\"pr_incorrect\");\n                            thespace.addClass(\"pr_incorrect\");\n                        } else {\n                            theword.addClass(\"pr_correct\");\n                            thespace.addClass(\"pr_correct\");\n                            if (lastmatched < obj.wordnumber) {\n                                lastmatched = obj.wordnumber;\n                            }\n                        }\n                    });\n\n                  //2nd pass now we know what each word is\n                    comparison.forEach(function (obj) {\n                        var theword = $(\"#\" + containerid + \"  .mod_minilesson_mu_passage_word[data-wordnumber='\" + obj.wordnumber + \"']\");\n                        var thespace = $(\"#\" + containerid + \"  .mod_minilesson_mu_passage_space[data-wordnumber='\" + obj.wordnumber + \"']\");\n                        var nextword = $(\"#\" + containerid + \"  .mod_minilesson_mu_passage_word[data-wordnumber='\" + (obj.wordnumber + 1) + \"']\");\n                      //mark incorrect as unreached if after last match\n                        if (lastmatched < obj.wordnumber && theword.hasClass('pr_incorrect')) {\n                            theword.addClass(\"pr_unreached\");\n                            thespace.addClass(\"pr_unreached\");\n                            theword.removeClass(\"pr_incorrect\");\n                            thespace.removeClass(\"pr_incorrect\");\n                        }\n                      //clear formatting on spaces in between correct/incorrect and incorrect/correct words\n                        if (nextword.length > 0) {\n                            if (theword.hasClass('pr_incorrect') && nextword.hasClass('pr_correct')) {\n                                thespace.removeClass('pr_incorrect');\n                            } else if (theword.hasClass('pr_correct') && nextword.hasClass('pr_incorrect')) {\n                                thespace.removeClass('pr_correct');\n                            }\n                        }\n                    });\n                }\n\n            }\n\n        };//end of return objects\n        return app;\n    }\n);"],"names":["define","$","log","def","ttrecorder","notification","str","templates","debug","allwords","strings","totals","correct","incorrect","unreached","read","accuracy","score","comparison","mediaurl","clone","extend","this","init","index","itemdata","quizhelper","init_strings","init_components","register_events","self","get_strings","done","s","i","reattempt","reallyreattempt","next_question","stepdata","hasgrade","totalitems","correctitems","percent","length","Math","round","totalmarks","grade","resultsdata","do_next","nextbutton","on","e","preventDefault","reattemptbutton","confirm","resultscontainer","hide","reattemptcontainer","recordercontainer","show","removeClass","allspaces","uniqueid","timelimit","progressTimer","height","timeLimit","onFinish","trigger","find","opts","callback","message","type","speechtext","capturedspeech","spoken_clean","cleanText","getComparison","passagetext","gotComparison","bloburl","stt_guided","is_stt_guided","ttrec","passage","transcript","phonetic","thebutton","prop","comparePassageToTranscript","language","alternates","then","ajaxresult","payloadobject","JSON","parse","typed","containerid","doComparisonMarkup","correctwords","incorrectwords","unreachedwords","showitemreview","render","html","js","filter","matched","addClass","lastmatched","forEach","obj","theword","wordnumber","thespace","nextword","hasClass"],"mappings":"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"}