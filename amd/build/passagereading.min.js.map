{"version":3,"file":"passagereading.min.js","sources":["../src/passagereading.js"],"sourcesContent":["define(['jquery', 'core/log', 'mod_minilesson/definitions','mod_minilesson/cloudpoodllloader',\n    'mod_minilesson/ttrecorder',],\n    function($, log, def,cloudpoodll, ttrecorder) {\n  \"use strict\"; // jshint ;_;\n\n  /*\n  This file is to manage the Passage Reading item type\n   */\n\n  log.debug('MiniLesson Passage Reading: initialising');\n\n  var app= {\n\n    //for making multiple instances\n      clone: function () {\n          return $.extend(true, {}, this);\n     },\n\n    init: function(index, itemdata, quizhelper) {\n      this.itemdata = itemdata;\n      this.quizhelper = quizhelper;\n      this.init_components(quizhelper,itemdata);\n      this.register_events(index, itemdata, quizhelper);\n\n    },\n    next_question: function(percent) {\n      var stepdata = {};\n      stepdata.index = self.index;\n      stepdata.hasgrade = true;\n      stepdata.totalitems = 1;\n      stepdata.correctitems = percent>0?1:0;\n      stepdata.grade = percent;\n      this.quizhelper.do_next(stepdata);\n    },\n\n    register_events: function(index, itemdata, quizhelper) {\n      var self = this;\n      var nextbutton = $(\"#\" + itemdata.uniqueid + \"_container .minilesson_nextbutton\");\n      \n      nextbutton.on('click', function(e) {\n        self.next_question(0);\n      });\n\n    },\n\n    init_components: function(quizhelper,itemdata){\n          var self=this;\n          self.allwords = $(\"#\" + self.itemdata.uniqueid + \"_container.mod_minilesson_mu_passage_word\");\n          self.thebutton = \"thettrbutton\"; // To Do impl. this\n          var theCallback = function(message) {\n\n            switch (message.type) {\n              case 'recording':\n\n                break;\n\n              case 'speech':\n                log.debug(\"speech at speechcards\");\n                var speechtext = message.capturedspeech;\n                var spoken_clean  = quizhelper.cleanText(speechtext);\n                var phonetic = ''; // TO DO - add phonetic option\n                log.debug('speechtext:',speechtext);\n                log.debug('spoken:',spoken_clean);\n                self.getComparison(\n                  self.itemdata.passagetext,\n                  spoken_clean,\n                  phonetic,\n                  function(comparison) {\n                      self.gotComparison(comparison, message);\n                  }\n              );\n               \n    \n            } //end of switch message type\n          };\n\n\n\n        if(quizhelper.use_ttrecorder()) {\n            //init tt recorder\n            var opts = {};\n            opts.uniqueid = itemdata.uniqueid;\n            opts.callback = theCallback;\n            opts.stt_guided=quizhelper.is_stt_guided();\n            self.ttrec = ttrecorder.clone();\n            self.ttrec.init(opts);\n            //init prompt for first card\n            //in some cases ttrecorder wants to know the target\n            //app.ttrec.currentPrompt=app.displayterms[app.pointer - 1];\n\n        }else{\n            //init cloudpoodll push recorder\n            cloudpoodll.init('minilesson-recorder-passagereading-' + itemdata.id, theCallback);\n        }\n\n\n    }, //end of init components\n\n    getComparison: function(passage, transcript, phonetic, callback) {\n      var self = this;\n      \n      //TO DO disable the TT Recorder button\n      $(\"#\" + self.thebutton ).prop(\"disabled\", true);\n\n      self.quizhelper.comparePassageToTranscript(passage,transcript,phonetic,self.itemdata.language).then(function(ajaxresult) {\n            var payloadobject = JSON.parse(ajaxresult);\n            if (payloadobject) {\n                callback(payloadobject);\n            } else {\n                callback(false);\n            }\n       });\n\n    },\n\n    gotComparison: function(comparison, typed) {\n      var self = this;\n      log.debug(\"gotComparison\");\n\n      //TO DO mark up the words as correct\n      self.allwords.removeClass(\"pr_correct pr_incorrect\");\n\n      var allCorrect = comparison.filter(function(e){return !e.matched;}).length==0;\n      \n      if (allCorrect && comparison && comparison.length>0) {\n        log.debug(\"gotComparison: all correct\");\n        //TO DO mark up the words as correct\n        $(\"#\" + self.allwords ).addClass(\"pr_correct\");\n\n        // Mark the item as answered and correct.\n        self.items[self.game.pointer].answered = true;\n        self.items[self.game.pointer].correct = true;\n        self.items[self.game.pointer].typed = typed;\n\n        //TO DO disable the TT Recorder button\n        $(\"#\" + self.thebutton ).prop(\"disabled\", true);\n\n        //Move on to the next item\n        if (self.game.pointer < self.items.length - 1) {\n          setTimeout(function() {\n            self.game.pointer++;\n            self.nextPrompt();\n          }, 2200);\n        } else {\n            self.end();\n        }\n\n      } else {\n        log.debug(\"gotComparison: not all correct\");\n\n        //mark up the words as correct or not\n        comparison.forEach(function(obj) {\n          log.debug(\"#\" + self.itemdata.uniqueid + \"_container .mod_minilesson_mu_passage_word[data-wordnumber='\" + obj.wordnumber + \"']\");\n          if(!obj.matched){\n            $(\"#\" + self.itemdata.uniqueid + \"_container .mod_minilesson_mu_passage_word[data-wordnumber='\" + obj.wordnumber + \"']\").addClass(\"pr_incorrect\");\n          } else {\n            $(\"#\" + self.itemdata.uniqueid + \"_container .mod_minilesson_mu_passage_word[data-wordnumber='\" + obj.wordnumber + \"']\").addClass(\"pr_correct\");\n          }\n        });\n        \n\n      }\n\n    },\n\n  };//end of return objects\n  return app;\n});"],"names":["define","$","log","def","cloudpoodll","ttrecorder","debug","clone","extend","this","init","index","itemdata","quizhelper","init_components","register_events","next_question","percent","stepdata","self","hasgrade","totalitems","correctitems","grade","do_next","uniqueid","on","e","allwords","thebutton","theCallback","message","type","speechtext","capturedspeech","spoken_clean","cleanText","getComparison","passagetext","comparison","gotComparison","use_ttrecorder","opts","callback","stt_guided","is_stt_guided","ttrec","id","passage","transcript","phonetic","prop","comparePassageToTranscript","language","then","ajaxresult","payloadobject","JSON","parse","typed","removeClass","filter","matched","length","addClass","items","game","pointer","answered","correct","setTimeout","nextPrompt","end","forEach","obj","wordnumber"],"mappings":"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"}