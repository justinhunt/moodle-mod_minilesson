{"version":3,"sources":["../src/aigenmake.js"],"names":["define","$","log","templates","Fragment","Modalfactory","Str","Config","ModalEvents","debug","controls","init","uniqid","self","init_controls","register_events","selectgenerate","aigenmakebtn","fieldmappings","on","e","preventDefault","items","itemcontrols","aigenmake_textarea","lessonTitle","val","lessonDescription","each","index","itemcontrol","itemdata","itemnumber","data","promptTextArea","find","prompt","generateMethodSelect","generatemethod","generateFieldsCheckboxes","generateFields","generateField","name","attr","generate","is","mapping","push","generatefields","generateFileareasCheckboxes","generateFileareas","generateFilearea","generatefileareas","promptFields","mappingsSelects","promptField","promptfields","alldata","length","JSON","parse","stringify","document","closest","newprompt","mappingsDiv","extractFieldsFromString","join","mappingsdata","availablecontext","split","filter","element","trim","aigenpromptfields","promptfieldmappingsDiv","render","then","html","selectedValue","removeAttr","methodreuse","aigenplaceholders","fileareasDiv","fileareasData","splitDataField","contextfileareas","aigenfileareas","datafield","input","matches","match","exec","Set","registerAiGenerateAction","wrapperselector","wrapper","querySelector","addEventListener","target","elements","hasOwnProperty","create","type","types","SAVE_CANCEL","title","get_string","body","callAiGenerateContextFormApi","large","removeOnClose","modal","getRoot","save","form","getAttribute","setBody","js","setAttribute","show","loadFragment","contextid","url","params","URLSearchParams","FormData","toString"],"mappings":"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","sourcesContent":["define(\n    ['jquery','core/log','core/templates','core/fragment','core/modal_factory','core/str','core/config','core/modal_events'],\n    function($,log,templates,Fragment,Modalfactory,Str,Config,ModalEvents) {\n    \"use strict\"; // jshint ;_;\n\n/*\nThis file contains class and ID definitions.\n */\n\n    log.debug('MiniLesson AiGen Config Maker: initialising');\n\n    return{\n        controls: {},\n        //pass in config, amd set up table\n        init: function(uniqid){\n            //pick up opts from html\n            var self = this;\n            self.init_controls(uniqid);\n            self.register_events(uniqid);\n        },\n\n        init_controls: function(uniqid){\n            //set up the controls\n            var self = this;\n            self.controls.selectgenerate = $('#' + uniqid + ' select[name=\"generatemethod\"]');\n            self.controls.aigenmakebtn = $('#' + uniqid + '_aigen_make_btn');\n            self.controls.fieldmappings = $('#' + uniqid + ' #id_fieldmappings');\n        },\n\n        register_events: function(uniqid){\n            //register events\n            var self = this;\n\n            //On clicking the make aigen button\n             self.controls.aigenmakebtn.on('click', function(e) {\n                e.preventDefault();\n                var items = [];\n                var itemcontrols =$('.ml_aigen_item');\n                var aigenmake_textarea = $('#' + uniqid + '_aigen_make_textarea');\n                // Get the lesson title and description\n                var lessonTitle = $('#' + uniqid + '_ml_aigen_lesson_title input').val();\n                var lessonDescription = $('#' + uniqid + '_ml_aigen_lesson_description textarea').val();\n\n                //loop through each item\n                itemcontrols.each(function(index, itemcontrol) {\n                    var itemdata = {};\n\n                   //set the itemnumber\n                    itemdata.itemnumber = Number($(itemcontrol).data('itemnumber'));\n\n                    //get the prompt\n                    var promptTextArea = $(itemcontrol).find('textarea[name=\"aigenprompt\"]');\n                    itemdata.prompt = promptTextArea.val();\n\n                    //get the generate method\n                    var generateMethodSelect = $(itemcontrol).find('select[name=\"generatemethod\"]');\n                    itemdata.generatemethod = generateMethodSelect.val();\n\n                    //get the generate fields\n                    var generateFieldsCheckboxes = $(itemcontrol).find('.aigen_fields-to-generate input[type=\"checkbox\"]');\n                    var generateFields = [];\n                    generateFieldsCheckboxes.each(function() {\n                        var generateField = {};\n                        generateField.name = $(this).attr('name');\n                        generateField.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(itemdata.generatemethod==\"reuse\" && generateField.generate) {\n                            generateField.mapping = $(itemcontrol).find('select[name=\"' + generateField.name + '_mapping\"]').val();\n                        }else {\n                            generateField.mapping = '';\n                        }\n                        generateFields.push(generateField);\n                    });\n                    itemdata.generatefields = generateFields;\n\n                     //get the file areas\n                    var generateFileareasCheckboxes = $(itemcontrol).find('.aigen_fileareas-to-generate input[type=\"checkbox\"]');\n                    var generateFileareas = [];\n                    generateFileareasCheckboxes.each(function() {\n                        var generateFilearea = {};\n                        generateFilearea.name = $(this).attr('name');\n                        generateFilearea.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(generateFilearea.generate) {\n                            generateFilearea.mapping = $(itemcontrol).find('select[name=\"' + generateFilearea.name + '_mapping\"]').val();\n                        }\n                        generateFileareas.push(generateFilearea);\n                    });\n                    itemdata.generatefileareas = generateFileareas;\n\n                    //get the prompt field mappings div\n                    var promptFields=[];\n                    var mappingsSelects= $(itemcontrol).find('.aigen_promptfield-mappings select');\n                    mappingsSelects.each(function() {\n                        var promptField = {};\n                        promptField.name = $(this).data('name');\n                        promptField.mapping = $(this).val();\n                        promptFields.push(promptField);\n                    });\n                    itemdata.promptfields = promptFields;\n\n                    // Add the current itemdata to the items array\n                    items.push(itemdata);\n\n                });// End of itemcontrols.each\n\n                var alldata = {};\n                alldata.lessonTitle = lessonTitle;\n                alldata.lessonDescription = lessonDescription;\n                alldata.items = items;\n\n                if (self.controls.fieldmappings.length) {\n                    alldata[self.controls.fieldmappings.attr('name')] = JSON.parse(self.controls.fieldmappings.val());\n                }\n\n                aigenmake_textarea.val(JSON.stringify(alldata, null, 2));\n                log.debug('AiGen make button clicked, items: ' + JSON.stringify(alldata, null,2));\n             });\n\n            //On reload of the prompt field to contextdata mapping\n            $(document).on('click','.aigen-reload-button', function(e, data) {\n                e.preventDefault();\n\n                //get the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.val();\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n\n                //update the prompt fields mappings div\n                var mappingsdata = {\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                var promptfieldmappingsDiv = $(this).closest('.ml_aigen_item').find('.aigen_promptfield-mappings');\n                templates.render('mod_minilesson/aigenpromptfieldmappings',mappingsdata).then(\n                    function(html,js){\n                        promptfieldmappingsDiv.html(html);\n                    }\n                );// End of templates\n            });\n\n            //On change of the select, update the config\n            self.controls.selectgenerate.on('change', function() {\n                //get the value of the select\n                var selectedValue = $(this).val();\n                //log the value\n                log.debug('Selected generate method: ' + selectedValue);\n                //the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.data(selectedValue + 'prompt');\n                promptTextArea.val(newprompt);\n                //If this is a reuse generate method the text area should be readonly\n                if (selectedValue === 'reuse') {\n                    promptTextArea.attr('readonly', true);\n                } else {\n                    promptTextArea.removeAttr('readonly');\n                }\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n                var mappingsdata = {\n                    methodreuse: selectedValue=='reuse',\n                    aigenplaceholders: mappingsDiv.data('aigenplaceholders').split(',').filter(element => element.trim() !== \"\"),\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                templates.render('mod_minilesson/aigenmappings',mappingsdata).then(\n                    function(html,js){\n                        log.debug('redoing mappingsdiv: ');\n                        mappingsDiv.html(html);\n                    }\n                );// End of templates\n\n                //Update the files areas div\n                var fileareasDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_filearea_mappings');\n                var fileareasData = {\n                    methodreuse: selectedValue=='reuse',\n                    aigenplaceholders: self.splitDataField(fileareasDiv.data('aigenplaceholders')),\n                    contextfileareas: self.splitDataField(fileareasDiv.data('contextfileareas')),\n                    aigenfileareas: self.splitDataField(fileareasDiv.data('aigenfileareas'))\n                };\n                templates.render('mod_minilesson/aigenfilemappings',fileareasData).then(\n                    function(html,js){\n                        log.debug('redoing fileareadata: ');\n                        fileareasDiv.html(html);\n                    }\n                );// End of templates\n\n\n            });\n\n        },  // end of register_events\n\n        splitDataField: function(datafield) {\n            if(!datafield || datafield.trim() === '') {\n                return [];\n            }else{\n                return datafield.split(',').filter(element => element.trim() !== \"\")\n            }\n        },\n\n        extractFieldsFromString: function(input) {\n            const regex = /\\{(\\w+)\\}/g; // Matches fields inside curly brackets\n            const matches = [];\n            let match;\n\n            while ((match = regex.exec(input)) !== null) {\n                matches.push(match[1]); // Add the captured group to the array\n            }\n\n            // Remove duplicates using a Set\n            return [...new Set(matches)];\n        },\n\n        registerAiGenerateAction: function(wrapperselector) {\n            var self = this;\n            var wrapper = document.querySelector(wrapperselector);\n            if (wrapper) {\n                wrapper.addEventListener('submit', function(e) {\n                    if (e.target.elements.hasOwnProperty('keyname')) {\n                        e.preventDefault();\n                        Modalfactory.create({\n                            type: Modalfactory.types.SAVE_CANCEL,\n                            title: Str.get_string('aigenmodaltitle', 'mod_minilesson'),\n                            body: self.callAiGenerateContextFormApi(e.target),\n                            large: true,\n                            removeOnClose: true\n                        }).then(function(modal) {\n                            modal.getRoot().on('submit ' + ModalEvents.save, function(e) {\n                                var form = this.querySelector('form');\n                                if (form.getAttribute('data-submitted')) {\n                                    return;\n                                }\n                                e.preventDefault();\n                                modal.setBody(self.callAiGenerateContextFormApi(form).then(function(html, js) {\n                                    if (html === 'submitted') {\n                                        form.setAttribute('data-submitted', 1);\n                                        js = '<script>document.getElementById(\"'+form.getAttribute('id')+'\").submit()</script>';\n                                    }\n                                    return [form, js];\n                                }));\n                            });\n                            modal.show();\n                        });\n                    }\n                });\n            }\n        },\n\n        callAiGenerateContextFormApi: function(form) {\n            return Fragment.loadFragment(\n                'mod_minilesson', 'aigen_contextform',\n                Config.contextid, {\n                    url: form.getAttribute('action'),\n                    params: new URLSearchParams(new FormData(form)).toString()\n                }\n            );\n        }\n    };//end of return value\n});"],"file":"aigenmake.min.js"}