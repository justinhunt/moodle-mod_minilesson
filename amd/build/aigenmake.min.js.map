{"version":3,"sources":["../src/aigenmake.js"],"names":["define","$","log","templates","Fragment","Modalfactory","Str","Config","ModalEvents","DyanamicTable","Ajax","debug","controls","itemdatas","itemcontrols","init","uniqid","self","init_controls","register_events","set_data","selectgenerate","aigenmakebtn","fieldmappings","aigenmake_textarea","on","items","lessonTitle","val","lessonDescription","each","index","itemcontrol","itemdata","itemnumber","data","promptTextArea","find","prompt","generateMethodSelect","generatemethod","generateFieldsCheckboxes","generateFields","generateField","name","attr","generate","is","mapping","push","generatefields","generateFileareasCheckboxes","generateFileareas","generateFilearea","generatefileareas","overallimagecontext","promptFields","mappingsSelects","promptField","promptfields","alldata","length","JSON","parse","stringify","document","e","preventDefault","closest","newprompt","mappingsDiv","extractFieldsFromString","join","mappingsdata","availablecontext","split","filter","element","trim","aigenpromptfields","promptfieldmappingsDiv","render","then","html","regenerate_item_form","selectgenerateelement","selectedValue","removeAttr","methodreuse","aigenplaceholders","fileareasDiv","fileareasData","splitDataField","contextfileareas","aigenfileareas","updateTheFields","theitemdata","theitemcontrol","forEach","$generateCheckbox","prop","$mappingSelect","$generateFileareasCheckbox","$mappingsSelect","textareavalue","jsonvalue","error","datafield","input","Array","from","matchAll","reduce","a","i","indexOf","registerAiGenerateAction","wrapperselector","wrapper","querySelector","addEventListener","target","elements","hasOwnProperty","create","type","types","SAVE_CANCEL","title","get_string","body","callAiGenerateContextFormApi","large","removeOnClose","modal","getRoot","save","form","setBody","js","destroy","refreshTable","dataset","tableuniqueid","scrollTo","top","behavior","show","checkProgressBar","loadFragment","contextid","url","getAttribute","params","URLSearchParams","FormData","toString","tableRoot","getTableFromId","refreshTableContent","pinginterval","table","updateinterval","parseInt","idmap","querySelectorAll","progressbar","id","ids","Object","keys","map","call","methodname","args","response","line","progressbarrow","columns","coldata","update","columntd","innerHTML","column","setTimeout","manageFilter","allcheckbox","othercheckbox","allChecks","concat","cb","disabled","checked","includes","filters","value","loadContents","rootelement","M","cfg","replaceNodeContents"],"mappings":"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","sourcesContent":["define(\n    ['jquery','core/log','core/templates','core/fragment','core/modal_factory',\n        'core/str','core/config','core/modal_events', 'core_table/dynamic', 'core/ajax'],\n    function($,log,templates,Fragment,Modalfactory,Str,Config,ModalEvents, DyanamicTable, Ajax) {\n    \"use strict\"; // jshint ;_;\n\n/*\nThis file contains class and ID definitions.\n */\n\n    log.debug('MiniLesson AiGen Config Maker: initialising');\n\n    return{\n        controls: {},\n        itemdatas: [],\n        itemcontrols: [],\n        //pass in config, amd set up table\n        init: function(uniqid){\n            //pick up opts from html\n            var self = this;\n            self.init_controls(uniqid);\n            self.register_events(uniqid);\n            self.set_data();\n        },\n\n        init_controls: function(uniqid){\n            //set up the controls\n            var self = this;\n            self.controls.selectgenerate = $('#' + uniqid + ' select[name=\"generatemethod\"]');\n            self.controls.aigenmakebtn = $('#' + uniqid + '_aigen_make_btn');\n            self.controls.fieldmappings = $('#' + uniqid + ' #id_fieldmappings');\n            self.controls.aigenmake_textarea = $('#' + uniqid + '_aigen_make_textarea');\n        },\n\n        register_events: function(uniqid){\n            //register events\n            var self = this;\n\n            //On clicking the make aigen button\n             self.controls.aigenmakebtn.on('click', function(e) {\n                var items = [];\n                var itemcontrols =$('.ml_aigen_item');\n                // Get the lesson title and description\n                var lessonTitle = $('#' + uniqid + '_ml_aigen_lesson_title input').val();\n                var lessonDescription = $('#' + uniqid + '_ml_aigen_lesson_description textarea').val();\n\n                //loop through each item\n                itemcontrols.each(function(index, itemcontrol) {\n                    var itemdata = {};\n\n                   //set the itemnumber\n                    itemdata.itemnumber = Number($(itemcontrol).data('itemnumber'));\n\n                    //get the prompt\n                    var promptTextArea = $(itemcontrol).find('textarea[name=\"aigenprompt\"]');\n                    itemdata.prompt = promptTextArea.val();\n\n                    //get the generate method\n                    var generateMethodSelect = $(itemcontrol).find('select[name=\"generatemethod\"]');\n                    itemdata.generatemethod = generateMethodSelect.val();\n\n                    //get the generate fields\n                    var generateFieldsCheckboxes = $(itemcontrol).find('.aigen_fields-to-generate input[type=\"checkbox\"]');\n                    var generateFields = [];\n                    generateFieldsCheckboxes.each(function() {\n                        var generateField = {};\n                        generateField.name = $(this).attr('name');\n                        generateField.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(itemdata.generatemethod==\"reuse\" && generateField.generate) {\n                            generateField.mapping = $(itemcontrol).find('select[name=\"' + generateField.name + '_mapping\"]').val();\n                        }else {\n                            generateField.mapping = '';\n                        }\n                        generateFields.push(generateField);\n                    });\n                    itemdata.generatefields = generateFields;\n\n                     //get the file areas\n                    var generateFileareasCheckboxes = $(itemcontrol).find('.aigen_fileareas-to-generate input[type=\"checkbox\"]');\n                    var generateFileareas = [];\n                    generateFileareasCheckboxes.each(function() {\n                        var generateFilearea = {};\n                        generateFilearea.name = $(this).attr('name');\n                        generateFilearea.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(generateFilearea.generate) {\n                            generateFilearea.mapping = $(itemcontrol).find('select[name=\"' + generateFilearea.name + '_mapping\"]').val();\n                        }\n                        generateFileareas.push(generateFilearea);\n                    });\n                    itemdata.generatefileareas = generateFileareas;\n\n                    //Get the overall image context for the item (if any) e.g \"user_topic\" - \"A man and a boy are walking in a park\"\n                    var overallimagecontext = $(itemcontrol).find('select[name=\"overall_image_context\"]').val();\n                    itemdata.overallimagecontext = overallimagecontext;\n\n                    //get the prompt field mappings div\n                    var promptFields=[];\n                    var mappingsSelects= $(itemcontrol).find('.aigen_promptfield-mappings select');\n                    mappingsSelects.each(function() {\n                        var promptField = {};\n                        promptField.name = $(this).data('name');\n                        promptField.mapping = $(this).val();\n                        promptFields.push(promptField);\n                    });\n                    itemdata.promptfields = promptFields;\n\n                    // Add the current itemdata to the items array\n                    items.push(itemdata);\n\n                });// End of itemcontrols.each\n\n                var alldata = {};\n                alldata.lessonTitle = lessonTitle;\n                alldata.lessonDescription = lessonDescription;\n                alldata.items = items;\n\n                if (self.controls.fieldmappings.length) {\n                    alldata[self.controls.fieldmappings.attr('name')] = JSON.parse(self.controls.fieldmappings.val());\n                }\n\n                self.controls.aigenmake_textarea.val(JSON.stringify(alldata, null, 2));\n                log.debug('AiGen make button clicked, items: ' + JSON.stringify(alldata, null,2));\n             });\n\n            //On reload of the prompt field to contextdata mapping\n            $(document).on('click','.aigen-reload-button', function(e, data) {\n                e.preventDefault();\n\n                //get the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.val();\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n\n                //update the prompt fields mappings div\n                var mappingsdata = {\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                var promptfieldmappingsDiv = $(this).closest('.ml_aigen_item').find('.aigen_promptfield-mappings');\n                templates.render('mod_minilesson/aigenpromptfieldmappings',mappingsdata).then(\n                    function(html,js){\n                        promptfieldmappingsDiv.html(html);\n                    }\n                );// End of templates\n            });\n\n            //On change of the select, update the config\n            self.controls.selectgenerate.on('change', function() {\n                self.regenerate_item_form(this);\n            });\n\n        },  // end of register_events\n\n        regenerate_item_form: function(selectgenerateelement, itemdata = null, itemcontrol = null) {\n            var self = this;\n            //get the value of the select\n            var selectedValue = $(selectgenerateelement).val();\n            //log the value\n            log.debug('Selected generate method: ' + selectedValue);\n            //the prompt text area\n            var promptTextArea = $(selectgenerateelement).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n            var newprompt = promptTextArea.data(selectedValue + 'prompt');\n            promptTextArea.val(newprompt);\n            //If this is a reuse generate method the text area should be readonly\n            if (selectedValue === 'reuse') {\n                promptTextArea.attr('readonly', true);\n            } else {\n                promptTextArea.removeAttr('readonly');\n            }\n\n            //prepare the mappings div data\n            var mappingsDiv = $(selectgenerateelement).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n            mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n            var mappingsdata = {\n                methodreuse: selectedValue==='reuse',\n                aigenplaceholders: mappingsDiv.data('aigenplaceholders').split(',').filter(element => element.trim() !== \"\"),\n                availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n            };\n\n            //prepare the files areas div data\n            var fileareasDiv = $(selectgenerateelement).closest('.ml_aigen_item').find('.ml_aigen_filearea_mappings');\n            var fileareasData = {\n                methodreuse: selectedValue==='reuse',\n                aigenplaceholders: self.splitDataField(fileareasDiv.data('aigenplaceholders')),\n                contextfileareas: self.splitDataField(fileareasDiv.data('contextfileareas')),\n                aigenfileareas: self.splitDataField(fileareasDiv.data('aigenfileareas')),\n                availablecontext: self.splitDataField(fileareasDiv.data('availablecontext')),\n            };\n\n            // Render mappings first, then render file areas after mappings has finished.\n            templates.render('mod_minilesson/aigenmappings', mappingsdata)\n                .then(function(html, js) {\n                    log.debug('redoing mappingsdiv: ');\n                    mappingsDiv.html(html);\n                    // Chain the second render so it runs after the first is done\n                    return templates.render('mod_minilesson/aigenfilemappings', fileareasData);\n                })\n                .then(function(html, js) {\n                    log.debug('redoing fileareadata: ');\n                    fileareasDiv.html(html);\n                }).then(function(){\n                    // If we have itemdata, set the fields accordingly\n                    if(itemdata && itemcontrol) {\n                        log.debug('updating after regenerating form');\n                        self.updateTheFields(itemdata, itemcontrol);\n                    }\n                });\n        },\n\n        updateTheFields: function(theitemdata, theitemcontrol) {\n\n            //get the generate fields\n            theitemdata.generatefields.forEach(function(generateField) {\n                var $generateCheckbox = $(theitemcontrol).find('.aigen_fields-to-generate input[type=\"checkbox\"][name=\"'+generateField.name+'\"]');\n                $generateCheckbox.prop('checked', generateField.generate);\n                if (generateField.generate) {\n                    if (theitemdata.generatemethod==\"reuse\") {\n                        var $mappingSelect = $(theitemcontrol).find('select[name=\"' + generateField.name + '_mapping\"]');\n                        $mappingSelect.val(generateField.mapping);\n                    }\n                }\n            });\n\n            //set the file areas\n            theitemdata.generatefileareas.forEach(function(generateFilearea) {\n                var $generateFileareasCheckbox = $(theitemcontrol).find('.aigen_fileareas-to-generate input[type=\"checkbox\"][name=\"'+generateFilearea.name+'\"]');\n                $generateFileareasCheckbox.prop('checked', generateFilearea.generate);\n                if(generateFilearea.generate) {\n                    var $mappingSelect = $(theitemcontrol).find('select[name=\"' + generateFilearea.name + '_mapping\"]');\n                    $mappingSelect.val(generateFilearea.mapping);\n                }\n            });\n\n            //set the overall image context\n            var overallimagecontext = $(theitemcontrol).find('select[name=\"overall_image_context\"]');\n            overallimagecontext.val(theitemdata.overallimagecontext);\n\n            //set the prompt field mappings div\n            theitemdata.promptfields.forEach(function(promptField) {\n                var $mappingsSelect= $(theitemcontrol).find('.aigen_promptfield-mappings select[data-name=\"'+promptField.name+'\"]');\n                $mappingsSelect.val(promptField.mapping);\n            });\n        },\n\n        set_data: function(){\n            //set up the controls\n            var self = this;\n            try {\n                var textareavalue = self.controls.aigenmake_textarea.val();\n                var jsonvalue = JSON.parse(textareavalue);\n                jsonvalue.items.forEach(function(itemdata, index) {\n                    var itemcontrol = $('.ml_aigen_item[data-itemnumber=\"'+index+'\"]');\n\n                    //set the prompt\n                    var promptTextArea = $(itemcontrol).find('textarea[name=\"aigenprompt\"]');\n                    promptTextArea.val(itemdata.prompt);\n\n                    //set the generate method\n                    var generateMethodSelect = $(itemcontrol).find('select[name=\"generatemethod\"]');\n                    generateMethodSelect.val(itemdata.generatemethod);\n                    promptTextArea.data(itemdata.generatemethod + 'prompt', itemdata.prompt);\n                    log.debug('Setting generate method to: ' + itemdata.generatemethod);\n                    // We need to do this to make sure the correct fields are on the page, before we set data to them.\n                    log.debug('triggering');\n                    \n                    // Regenerate the form and, once both renders finish, set the values for this item\n                    self.regenerate_item_form(generateMethodSelect[0], itemdata, itemcontrol);\n\n                });\n            } catch (error) {\n                log.debug('Invalid JSON');\n                log.debug(error);\n            }\n        },\n\n        splitDataField: function(datafield) {\n            if(!datafield || datafield.trim() === '') {\n                return [];\n            }else{\n                return datafield.split(',').filter(element => element.trim() !== \"\")\n            }\n        },\n\n        extractFieldsFromString: function(input) {\n            const regex = new RegExp('\\\\{(\\\\w+)\\\\}', 'g'); // fresh regex every time\n            return Array.from(input.matchAll(regex)).reduce(function(a,i) {\n                if (a.indexOf(i[1]) === -1) {\n                    a.push(i[1]);\n                }\n                return a;\n            }, []);\n        },\n\n        registerAiGenerateAction: function(wrapperselector) {\n            var self = this;\n            var wrapper = document.querySelector(wrapperselector);\n            if (wrapper) {\n                wrapper.addEventListener('submit', function(e) {\n                    if (e.target.elements.hasOwnProperty('templateid')) {\n                        e.preventDefault();\n                        Modalfactory.create({\n                            type: Modalfactory.types.SAVE_CANCEL,\n                            title: Str.get_string('aigenmodaltitle', 'mod_minilesson'),\n                            body: self.callAiGenerateContextFormApi(e.target),\n                            large: true,\n                            removeOnClose: true\n                        }).then(function(modal) {\n                            modal.getRoot().on('submit ' + ModalEvents.save, function(e) {\n                                e.preventDefault();\n                                var form = this.querySelector('form');\n                                modal.setBody(self.callAiGenerateContextFormApi(form).then(function(html, js) {\n                                    if (html === 'submitted') {\n                                        modal.destroy();\n                                        self.refreshTable(wrapper.dataset.tableuniqueid);\n                                        document.querySelector('#page')?.scrollTo({ top: 0, behavior: 'smooth' });\n                                        return ['', ''];\n                                    }\n                                    return [html, js];\n                                }));\n                            });\n                            modal.show();\n                        });\n                    }\n                });\n                self.checkProgressBar(wrapper.dataset.tableuniqueid);\n            }\n        },\n\n        callAiGenerateContextFormApi: function(form) {\n            return Fragment.loadFragment(\n                'mod_minilesson', 'aigen_contextform',\n                Config.contextid, {\n                    url: form.getAttribute('action'),\n                    params: new URLSearchParams(new FormData(form)).toString()\n                }\n            );\n        },\n\n        refreshTable: function(tableuniqueid) {\n            var self = this;\n            try {\n                var tableRoot = DyanamicTable.getTableFromId(tableuniqueid);\n                DyanamicTable.refreshTableContent(tableRoot).then(function() {\n                    self.checkProgressBar(tableuniqueid);\n                });\n            } catch(e) {\n                log.debug(e);\n            }\n        },\n\n        checkProgressBar: function(tableuniqueid, pinginterval = 1) {\n            var self = this;\n            try {\n                var tableRoot = DyanamicTable.getTableFromId(tableuniqueid);\n            } catch(e) {\n                log.debug(e);\n            }\n            var table = tableRoot.querySelector('table');\n            if (!table) {\n                return;\n            }\n            var updateinterval = parseInt(table.getAttribute('data-updateinterval'));\n            if (updateinterval > 0) {\n                pinginterval = updateinterval;\n            }\n            if (tableRoot) {\n                var idmap = {};\n                tableRoot.querySelectorAll('[data-region=\"progressbar\"]')\n                    .forEach(function(progressbar) {\n                        var id = parseInt(progressbar.getAttribute('data-id'));\n                        if (id > 0) {\n                            idmap[id] = progressbar;\n                        }\n                    });\n                var ids = Object.keys(idmap).map(parseInt);\n                if (Object.keys(ids).length > 0) {\n                    Ajax.call([{\n                        methodname: 'mod_minilesson_update_progressbars',\n                        args: {\n                            contextid: Config.contextid,\n                            ids: ids\n                        }\n                    }])[0].then(function(response) {\n                        response.forEach(function(line) {\n                            if (ids.indexOf(line.id) > -1) {\n                                var progressbarrow = idmap[line.id].closest('tr');\n                                line.columns.forEach(function(coldata, index) {\n                                    if (coldata.update) {\n                                        var columntd = progressbarrow.querySelector('td.c' + index);\n                                        if (columntd) {\n                                            columntd.innerHTML = coldata.data;\n                                            columntd.dataset.column = coldata.column;\n                                        }\n                                    }\n                                });\n                            }\n                        });\n                        setTimeout(function() {\n                            self.checkProgressBar(tableuniqueid);\n                        }, pinginterval * 1000);\n                    });\n                }\n            }\n        },\n\n        manageFilter: function() {\n            var self = this;\n            var allcheckbox = document.querySelector('.minilesson_template_tag_all');\n            var othercheckbox = document.querySelectorAll('.minilesson_template_tag_others');\n            var allChecks = [].concat(allcheckbox, Array.from(othercheckbox));\n\n            allcheckbox.addEventListener('change', function() {\n                othercheckbox.forEach(function(cb) {\n                    cb.disabled = allcheckbox.checked;\n                });\n            });\n\n            document.addEventListener('change', e => {\n                if (allChecks.includes(e.target)) {\n                    const filters = allChecks.filter(function(cb) {\n                        return cb.checked && !cb.disabled;\n                    }).map(function(cb) {\n                        return cb.value;\n                    });\n                    self.loadContents(filters);\n                }\n            });\n        },\n\n        loadContents: function(filters) {\n            var rootelement = document.querySelector('[data-region=\"mod_minilesson_aigentemplates\"]');\n            Fragment.loadFragment(\n                'mod_minilesson', 'templates', M.cfg.contextid, {\n                    filters: JSON.stringify(filters),\n                }\n            ).then(function(html, js) {\n                templates.replaceNodeContents(rootelement, html, js);\n            });\n        }\n    };//end of return value\n});"],"file":"aigenmake.min.js"}