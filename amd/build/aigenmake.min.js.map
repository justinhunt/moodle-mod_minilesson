{"version":3,"file":"aigenmake.min.js","sources":["../src/aigenmake.js"],"sourcesContent":["define(['jquery','core/log','core/templates'], function($,log,templates) {\n    \"use strict\"; // jshint ;_;\n\n/*\nThis file contains class and ID definitions.\n */\n\n    log.debug('MiniLesson AiGen Config Maker: initialising');\n\n    return{\n        controls: {},\n        //pass in config, amd set up table\n        init: function(uniqid){\n            //pick up opts from html\n            var self = this;\n            self.init_controls(uniqid);\n            self.register_events(uniqid);\n        },\n\n        init_controls: function(uniqid){\n            //set up the controls\n            var self = this;\n            self.controls.selectgenerate = $('#' + uniqid + ' select[name=\"generatemethod\"]');\n            self.controls.aigenmakebtn = $('#' + uniqid + '_aigen_make_btn');\n        },\n\n        register_events: function(uniqid){\n            //register events\n            var self = this;\n\n            //On clicking the make aigen button\n             self.controls.aigenmakebtn.on('click', function(e) {\n                e.preventDefault();\n                var items = [];\n                var itemcontrols =$('.ml_aigen_item');\n                var aigenmake_textarea = $('#' + uniqid + '_aigen_make_textarea');\n                // Get the lesson title and description\n                var lessonTitle = $('#' + uniqid + '_ml_aigen_lesson_title input').val();\n                var lessonDescription = $('#' + uniqid + '_ml_aigen_lesson_description textarea').val();\n\n                //loop through each item\n                itemcontrols.each(function(index, itemcontrol) {\n                    var itemdata = {};\n\n                   //set the itemnumber\n                    itemdata.itemnumber = Number($(itemcontrol).data('itemnumber'));\n\n                    //get the prompt\n                    var promptTextArea = $(itemcontrol).find('textarea[name=\"aigenprompt\"]');\n                    itemdata.prompt = promptTextArea.val();\n\n                    //get the generate method\n                    var generateMethodSelect = $(itemcontrol).find('select[name=\"generatemethod\"]');\n                    itemdata.generatemethod = generateMethodSelect.val();\n\n                    //get the generate fields\n                    var generateFieldsCheckboxes = $(itemcontrol).find('.aigen_fields-to-generate input[type=\"checkbox\"]');\n                    var generateFields = [];\n                    generateFieldsCheckboxes.each(function() {\n                        var generateField = {};\n                        generateField.name = $(this).attr('name');\n                        generateField.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(itemdata.generatemethod==\"reuse\" && generateField.generate) {\n                            generateField.mapping = $(itemcontrol).find('select[name=\"' + generateField.name + '_mapping\"]').val();\n                        }else {\n                            generateField.mapping = '';\n                        }\n                        generateFields.push(generateField);\n                    });\n                    itemdata.generatefields = generateFields;\n\n                    //get the prompt field mappings div\n                    var promptFields=[];\n                    var mappingsSelects= $(itemcontrol).find('.aigen_promptfield-mappings select');\n                    mappingsSelects.each(function() {\n                        var promptField = {};\n                        promptField.name = $(this).data('name');\n                        promptField.mapping = $(this).val();\n                        promptFields.push(promptField);\n                    });\n                    itemdata.promptfields = promptFields;\n                    // Add the current itemdata to the items array\n                    items.push(itemdata);\n                    \n                });// End of itemcontrols.each\n                \n                var alldata = {};\n                alldata.lessonTitle = lessonTitle;\n                alldata.lessonDescription = lessonDescription;\n                alldata.items = items;\n                aigenmake_textarea.val(JSON.stringify(alldata, null, 2));\n                log.debug('AiGen make button clicked, items: ' + JSON.stringify(alldata, null,2));\n             });\n\n            //On reload of the prompt field to contextdata mapping\n            $(document).on('click','.aigen-reload-button', function(e, data) {\n                e.preventDefault();\n\n                //get the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.val();\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n                \n                //update the prompt fields mappings div\n                var mappingsdata = {\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                var promptfieldmappingsDiv = $(this).closest('.ml_aigen_item').find('.aigen_promptfield-mappings'); \n                templates.render('mod_minilesson/aigenpromptfieldmappings',mappingsdata).then(\n                    function(html,js){\n                        promptfieldmappingsDiv.html(html);\n                    }\n                );// End of templates\n            });\n\n            //On change of the select, update the config\n            self.controls.selectgenerate.on('change', function() {\n                //get the value of the select\n                var selectedValue = $(this).val();\n                //log the value\n                log.debug('Selected generate method: ' + selectedValue);\n                //the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.data(selectedValue + 'prompt');\n                promptTextArea.val(newprompt);\n                //If this is a reuse generate method the text area should be readonly\n                if (selectedValue === 'reuse') {\n                    promptTextArea.attr('readonly', true);\n                } else {\n                    promptTextArea.removeAttr('readonly');\n                }\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n                var mappingsdata = {\n                    methodreuse: selectedValue=='reuse',\n                    aigenplaceholders: mappingsDiv.data('aigenplaceholders').split(',').filter(element => element.trim() !== \"\"),\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                templates.render('mod_minilesson/aigenmappings',mappingsdata).then(\n                    function(html,js){\n                        log.debug('redoing mappingsdiv: ');\n                        mappingsDiv.html(html);\n                    }\n                );// End of templates\n            });\n           \n        },  // end of register_events\n\n        extractFieldsFromString: function(input) {\n            const regex = /\\{(\\w+)\\}/g; // Matches fields inside curly brackets\n            const matches = [];\n            let match;\n\n            while ((match = regex.exec(input)) !== null) {\n                matches.push(match[1]); // Add the captured group to the array\n            }\n\n            // Remove duplicates using a Set\n            return [...new Set(matches)];\n        }\n    };//end of return value\n});"],"names":["define","$","log","templates","debug","controls","init","uniqid","this","init_controls","register_events","selectgenerate","aigenmakebtn","self","on","e","preventDefault","items","itemcontrols","aigenmake_textarea","lessonTitle","val","lessonDescription","each","index","itemcontrol","itemdata","itemnumber","Number","data","promptTextArea","find","prompt","generateMethodSelect","generatemethod","generateFieldsCheckboxes","generateFields","generateField","name","attr","generate","is","mapping","push","generatefields","promptFields","promptField","promptfields","alldata","JSON","stringify","document","newprompt","closest","mappingsDiv","extractFieldsFromString","join","mappingsdata","availablecontext","split","filter","element","trim","aigenpromptfields","promptfieldmappingsDiv","render","then","html","js","selectedValue","removeAttr","methodreuse","aigenplaceholders","input","regex","matches","match","exec","Set"],"mappings":"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"}