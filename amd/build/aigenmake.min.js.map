{"version":3,"file":"aigenmake.min.js","sources":["../src/aigenmake.js"],"sourcesContent":["define(['jquery','core/log','core/templates'], function($,log,templates) {\n    \"use strict\"; // jshint ;_;\n\n/*\nThis file contains class and ID definitions.\n */\n\n    log.debug('MiniLesson AiGen Config Maker: initialising');\n\n    return{\n        controls: {},\n        //pass in config, amd set up table\n        init: function(uniqid){\n            //pick up opts from html\n            var self = this;\n            self.init_controls(uniqid);\n            self.register_events(uniqid);\n        },\n\n        init_controls: function(uniqid){\n            //set up the controls\n            var self = this;\n            self.controls.selectgenerate = $('#' + uniqid + ' select[name=\"generatemethod\"]');\n            self.controls.aigenmakebtn = $('#' + uniqid + '_aigen_make_btn');\n        },\n\n        register_events: function(uniqid){\n            //register events\n            var self = this;\n\n            //On clicking the make aigen button\n             self.controls.aigenmakebtn.on('click', function(e) {\n                e.preventDefault();\n                var items = [];\n                var itemcontrols =$('.ml_aigen_item');\n                var aigenmake_textarea = $('#' + uniqid + '_aigen_make_textarea');\n                // Get the lesson title and description\n                var lessonTitle = $('#' + uniqid + '_ml_aigen_lesson_title input').val();\n                var lessonDescription = $('#' + uniqid + '_ml_aigen_lesson_description textarea').val();\n\n                //loop through each item\n                itemcontrols.each(function(index, itemcontrol) {\n                    var itemdata = {};\n\n                   //set the itemnumber\n                    itemdata.itemnumber = Number($(itemcontrol).data('itemnumber'));\n\n                    //get the prompt\n                    var promptTextArea = $(itemcontrol).find('textarea[name=\"aigenprompt\"]');\n                    itemdata.prompt = promptTextArea.val();\n\n                    //get the generate method\n                    var generateMethodSelect = $(itemcontrol).find('select[name=\"generatemethod\"]');\n                    itemdata.generatemethod = generateMethodSelect.val();\n\n                    //get the generate fields\n                    var generateFieldsCheckboxes = $(itemcontrol).find('.aigen_fields-to-generate input[type=\"checkbox\"]');\n                    var generateFields = [];\n                    generateFieldsCheckboxes.each(function() {\n                        var generateField = {};\n                        generateField.name = $(this).attr('name');\n                        generateField.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(itemdata.generatemethod==\"reuse\" && generateField.generate) {\n                            generateField.mapping = $(itemcontrol).find('select[name=\"' + generateField.name + '_mapping\"]').val();\n                        }else {\n                            generateField.mapping = '';\n                        }\n                        generateFields.push(generateField);\n                    });\n                    itemdata.generatefields = generateFields;\n\n                     //get the file areas\n                    var generateFileareasCheckboxes = $(itemcontrol).find('.aigen_fileareas-to-generate input[type=\"checkbox\"]');\n                    var generateFileareas = [];\n                    generateFileareasCheckboxes.each(function() {\n                        var generateFilearea = {};\n                        generateFilearea.name = $(this).attr('name');\n                        generateFilearea.generate  = $(this).is(':checked') ? 1 : 0;\n                        if(generateFilearea.generate) {\n                            generateFilearea.mapping = $(itemcontrol).find('select[name=\"' + generateFilearea.name + '_mapping\"]').val();\n                        }\n                        generateFileareas.push(generateFilearea);\n                    });\n                    itemdata.generatefileareas = generateFileareas;\n\n                    //get the prompt field mappings div\n                    var promptFields=[];\n                    var mappingsSelects= $(itemcontrol).find('.aigen_promptfield-mappings select');\n                    mappingsSelects.each(function() {\n                        var promptField = {};\n                        promptField.name = $(this).data('name');\n                        promptField.mapping = $(this).val();\n                        promptFields.push(promptField);\n                    });\n                    itemdata.promptfields = promptFields;\n\n                    // Add the current itemdata to the items array\n                    items.push(itemdata);\n                    \n                });// End of itemcontrols.each\n                \n                var alldata = {};\n                alldata.lessonTitle = lessonTitle;\n                alldata.lessonDescription = lessonDescription;\n                alldata.items = items;\n                aigenmake_textarea.val(JSON.stringify(alldata, null, 2));\n                log.debug('AiGen make button clicked, items: ' + JSON.stringify(alldata, null,2));\n             });\n\n            //On reload of the prompt field to contextdata mapping\n            $(document).on('click','.aigen-reload-button', function(e, data) {\n                e.preventDefault();\n\n                //get the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.val();\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n                \n                //update the prompt fields mappings div\n                var mappingsdata = {\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                var promptfieldmappingsDiv = $(this).closest('.ml_aigen_item').find('.aigen_promptfield-mappings'); \n                templates.render('mod_minilesson/aigenpromptfieldmappings',mappingsdata).then(\n                    function(html,js){\n                        promptfieldmappingsDiv.html(html);\n                    }\n                );// End of templates\n            });\n\n            //On change of the select, update the config\n            self.controls.selectgenerate.on('change', function() {\n                //get the value of the select\n                var selectedValue = $(this).val();\n                //log the value\n                log.debug('Selected generate method: ' + selectedValue);\n                //the prompt text area\n                var promptTextArea = $(this).closest('.ml_aigen_item').find('textarea[name=\"aigenprompt\"]');\n                var newprompt = promptTextArea.data(selectedValue + 'prompt');\n                promptTextArea.val(newprompt);\n                //If this is a reuse generate method the text area should be readonly\n                if (selectedValue === 'reuse') {\n                    promptTextArea.attr('readonly', true);\n                } else {\n                    promptTextArea.removeAttr('readonly');\n                }\n\n                //update the mappings div\n                var mappingsDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_mappings');\n                mappingsDiv.data('promptfields',self.extractFieldsFromString(newprompt).join(','));\n                var mappingsdata = {\n                    methodreuse: selectedValue=='reuse',\n                    aigenplaceholders: mappingsDiv.data('aigenplaceholders').split(',').filter(element => element.trim() !== \"\"),\n                    availablecontext: mappingsDiv.data('availablecontext').split(',').filter(element => element.trim() !== \"\"),\n                    aigenpromptfields: mappingsDiv.data('promptfields').split(',').filter(element => element.trim() !== \"\"),\n                };\n                templates.render('mod_minilesson/aigenmappings',mappingsdata).then(\n                    function(html,js){\n                        log.debug('redoing mappingsdiv: ');\n                        mappingsDiv.html(html);\n                    }\n                );// End of templates\n\n                //Update the files areas div\n                var fileareasDiv = $(this).closest('.ml_aigen_item').find('.ml_aigen_filearea_mappings');\n                var fileareasData = {\n                    methodreuse: selectedValue=='reuse',\n                    aigenplaceholders: self.splitDataField(fileareasDiv.data('aigenplaceholders')),\n                    contextfileareas: self.splitDataField(fileareasDiv.data('contextfileareas')),\n                    aigenfileareas: self.splitDataField(fileareasDiv.data('aigenfileareas'))\n                };\n                templates.render('mod_minilesson/aigenfilemappings',fileareasData).then(\n                    function(html,js){\n                        log.debug('redoing fileareadata: ');\n                        fileareasDiv.html(html);\n                    }\n                );// End of templates\n                \n\n            });\n           \n        },  // end of register_events\n\n        splitDataField: function(datafield) {\n            if(!datafield || datafield.trim() === '') {\n                return [];\n            }else{\n                return datafield.split(',').filter(element => element.trim() !== \"\")\n            }\n        },\n\n        extractFieldsFromString: function(input) {\n            const regex = /\\{(\\w+)\\}/g; // Matches fields inside curly brackets\n            const matches = [];\n            let match;\n\n            while ((match = regex.exec(input)) !== null) {\n                matches.push(match[1]); // Add the captured group to the array\n            }\n\n            // Remove duplicates using a Set\n            return [...new Set(matches)];\n        }\n    };//end of return value\n});"],"names":["define","$","log","templates","debug","controls","init","uniqid","this","init_controls","register_events","selectgenerate","aigenmakebtn","self","on","e","preventDefault","items","itemcontrols","aigenmake_textarea","lessonTitle","val","lessonDescription","each","index","itemcontrol","itemdata","itemnumber","Number","data","promptTextArea","find","prompt","generateMethodSelect","generatemethod","generateFieldsCheckboxes","generateFields","generateField","name","attr","generate","is","mapping","push","generatefields","generateFileareasCheckboxes","generateFileareas","generateFilearea","generatefileareas","promptFields","promptField","promptfields","alldata","JSON","stringify","document","newprompt","closest","mappingsDiv","extractFieldsFromString","join","mappingsdata","availablecontext","split","filter","element","trim","aigenpromptfields","promptfieldmappingsDiv","render","then","html","js","selectedValue","removeAttr","methodreuse","aigenplaceholders","fileareasDiv","fileareasData","splitDataField","contextfileareas","aigenfileareas","datafield","input","regex","matches","match","exec","Set"],"mappings":"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"}